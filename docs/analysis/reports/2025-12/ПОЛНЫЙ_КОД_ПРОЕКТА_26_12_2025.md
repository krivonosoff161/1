# üì¶ –ü–û–õ–ù–´–ô –ö–û–î –ü–†–û–ï–ö–¢–ê –¢–û–†–ì–û–í–û–ì–û –ë–û–¢–ê OKX
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 26 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–¶–µ–ª—å:** –°–æ–±—Ä–∞—Ç—å –í–°–ï —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

---

## üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

1. **ExitAnalyzer –æ—à–∏–±–∫–∞** - TypeError: '>' not supported (–ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —Å–æ—Ç–Ω–∏ —Ä–∞–∑)
2. **TCC datetime –æ—à–∏–±–∫–∞** - cannot access local variable 'datetime' (–ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ü–∏–∫–ª)
3. **–ù–∏–∑–∫–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å:** -8.41 USDT, Win Rate 24.14% (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 50%)
4. **–¢–æ–ª—å–∫–æ 6.9% –ø–æ–∑–∏—Ü–∏–π –¥–æ—Å—Ç–∏–≥–∞—é—Ç TP** (—Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π TP)
5. **31% —Å–¥–µ–ª–æ–∫ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ SL** (—Å–ª–∏—à–∫–æ–º —É–∑–∫–∏–π SL)

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞](#1-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#2-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
3. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã](#3-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ-—Ñ–∞–π–ª—ã)
4. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏](#4-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–º–æ–¥—É–ª–∏)
5. [–§–∏–ª—å—Ç—Ä—ã](#5-—Ñ–∏–ª—å—Ç—Ä—ã)
6. [–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã](#6-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)
7. [–ö–ª–∏–µ–Ω—Ç—ã –∏ WebSocket](#7-–∫–ª–∏–µ–Ω—Ç—ã-–∏-websocket)
8. [–£—Ç–∏–ª–∏—Ç—ã](#8-—É—Ç–∏–ª–∏—Ç—ã)
9. [–ì–ª–∞–≤–Ω—ã–µ —Ñ–∞–π–ª—ã](#9-–≥–ª–∞–≤–Ω—ã–µ-—Ñ–∞–π–ª—ã)
10. [–¢–µ—Å—Ç—ã](#10-—Ç–µ—Å—Ç—ã)

---

## 1. –ú–ï–¢–ê–î–ê–ù–ù–´–ï –ü–†–û–ï–ö–¢–ê

### 1.1. –í–µ—Ä—Å–∏—è Python
```
Python 3.11.9
```

### 1.2. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requirements.txt)

```txt
ccxt==4.1.22
okx==2.1.2
pandas==2.0.3
numpy==1.24.3
aiohttp==3.8.6
asyncio-throttle==1.0.2
tenacity==8.2.3
pyyaml==6.0.1
python-dotenv==1.0.0
websockets==11.0.3
pydantic==2.4.2
loguru==0.7.2
backtrader==1.9.78.123
python-telegram-bot==20.6
schedule==1.2.0
fastapi==0.104.1
uvicorn==0.24.0
sqlalchemy==2.0.23
alembic==1.12.1
redis==5.0.1
prometheus-client==0.18.0
psutil==5.9.6
cachetools==6.2.2
```

### 1.3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
simple trading bot okx/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ config_futures.yaml (1915 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ strategies/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scalping/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ futures/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ trading_control_center.py (713 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ data_registry.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ position_registry.py
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ positions/
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ exit_analyzer.py (3505 —Å—Ç—Ä–æ–∫) ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ position_manager.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ position_scaling_manager.py
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ coordinators/
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ signal_coordinator.py (2928 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ order_coordinator.py
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ calculations/
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ pnl_calculator.py (239 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ risk/
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ adaptive_leverage.py (252 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ signals/
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ signal_generator.py
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ adaptivity/
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ regime_manager.py
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ filters/
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ funding_rate_filter.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ liquidity_filter.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ momentum_filter.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ order_flow_filter.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ volatility_regime_filter.py
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ indicators/
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ fast_adx.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ funding_rate_monitor.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ futures_volume_profile.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ liquidity_levels.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ micro_pivot_calculator.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ order_flow_indicator.py
‚îÇ   ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ trailing_stop_loss.py
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ config/
‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ config_manager.py
‚îÇ   ‚îî‚îÄ‚îÄ main_futures.py
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îî‚îÄ‚îÄ futures/
‚îÇ       ‚îî‚îÄ‚îÄ archived/
‚îú‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ requirements.txt
```

---

## 2. –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

### 2.1. –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

#### config/
- `config_futures.yaml` - –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (1915 —Å—Ç—Ä–æ–∫)

#### src/strategies/scalping/futures/
- `core/` - –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
- `positions/` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏
- `coordinators/` - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—ã
- `calculations/` - –†–∞—Å—á–µ—Ç—ã
- `risk/` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏
- `filters/` - –§–∏–ª—å—Ç—Ä—ã —Å–∏–≥–Ω–∞–ª–æ–≤
- `indicators/` - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
- `config/` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- `signals/` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
- `adaptivity/` - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å

---

## 3. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–û–ù–ù–´–ï –§–ê–ô–õ–´

### 3.1. config/config_futures.yaml

**–§–∞–π–ª:** `config/config_futures.yaml`  
**–†–∞–∑–º–µ—Ä:** 1915 —Å—Ç—Ä–æ–∫

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ MD —Ñ–∞–π–ª. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```yaml
# API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
api:
  okx:
    api_key: "${OKX_API_KEY}"
    api_secret: "${OKX_SECRET}"
    passphrase: "${OKX_PASSPHRASE}"
    sandbox: true

# –¢–æ—Ä–≥–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
scalping:
  symbols:
    - "BTC-USDT"
    - "ETH-USDT"
    - "SOL-USDT"
    - "DOGE-USDT"
    - "XRP-USDT"
  
  # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  check_interval: 1.0
  min_signal_strength: 0.7
  min_signal_strength_ranging: 0.7
  min_adx: 20.0
  signal_cooldown_seconds: 30.0
  
  # TP/SL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  tp_percent: 5.0
  sl_percent: 1.0
  
  # –†–µ–∂–∏–º—ã —Ä—ã–Ω–∫–∞
  adaptive_regime:
    trending:
      tp_percent: 6.0
      sl_percent: 1.2
      min_score_threshold: 2.0
      max_trades_per_hour: 20
    ranging:
      tp_percent: 5.0  # ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π –¥–ª—è ranging (–Ω—É–∂–Ω–æ 3-4%)
      sl_percent: 1.0
      min_score_threshold: 1.8
      max_trades_per_hour: 15
    choppy:
      tp_percent: 4.5
      sl_percent: 1.2
      min_score_threshold: 2.0
      max_trades_per_hour: 8
```

**–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥:** –°–º. —Ñ–∞–π–ª `config/config_futures.yaml` (1915 —Å—Ç—Ä–æ–∫)

---

## 4. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ú–û–î–£–õ–ò

### 4.1. TradingControlCenter (TCC)

**–§–∞–π–ª:** `src/strategies/scalping/futures/core/trading_control_center.py`  
**–†–∞–∑–º–µ—Ä:** 713 —Å—Ç—Ä–æ–∫  
**–ü—Ä–æ–±–ª–µ–º–∞:** `cannot access local variable 'datetime' where it is not associated with a value`

**–ò–º–ø–æ—Ä—Ç—ã:**
```python
from datetime import datetime as dt
from datetime import timezone
```

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:**

```python
"""
TradingControlCenter - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Ç–æ—Ä–≥–æ–≤–æ–π –ª–æ–≥–∏–∫–∏.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
- –ì–ª–∞–≤–Ω—ã–π —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

–í—ã–Ω–µ—Å–µ–Ω–æ –∏–∑ orchestrator.py –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:
- orchestrator.py: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª–µ–π
- trading_control_center.py: —Ç–æ—Ä–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
"""

import asyncio
import os
import time
from datetime import datetime as dt
from datetime import timezone
from typing import Any, Dict, Optional

from loguru import logger

# ‚úÖ –ù–û–í–û–ï: –ò–º–ø–æ—Ä—Ç –¥–ª—è memory usage
try:
    import psutil

    PSUTIL_AVAILABLE = True
except ImportError:
    PSUTIL_AVAILABLE = False
    logger.warning("‚ö†Ô∏è psutil –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - memory usage –Ω–µ –±—É–¥–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è")


class TradingControlCenter:
    """
    –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Ç–æ—Ä–≥–æ–≤–æ–π –ª–æ–≥–∏–∫–∏.

    –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç:
    - –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤
    - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏
    - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å –±–∏—Ä–∂–µ–π
    - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    """

    def __init__(
        self,
        client: Any,  # OKXFuturesClient
        signal_generator: Any,  # FuturesSignalGenerator
        signal_coordinator: Any,  # SignalCoordinator
        position_manager: Any,  # FuturesPositionManager
        position_registry: Any,  # PositionRegistry
        data_registry: Any,  # DataRegistry
        order_coordinator: Any,  # OrderCoordinator
        trailing_sl_coordinator: Any,  # TrailingSLCoordinator
        performance_tracker: Any,  # PerformanceTracker
        trading_statistics: Any,  # TradingStatistics
        liquidation_guard: Any,  # LiquidationGuard
        config_manager: Any,  # ConfigManager
        scalping_config: Any,  # ScalpingConfig
        active_positions: Any,  # –ü—Ä–æ–∫—Å–∏ –∫ position_registry
        normalize_symbol: Any,  # –ú–µ—Ç–æ–¥ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–º–≤–æ–ª–∞
        sync_positions_with_exchange: Any,  # –ú–µ—Ç–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–π
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TradingControlCenter.

        Args:
            client: –ö–ª–∏–µ–Ω—Ç –±–∏—Ä–∂–∏
            signal_generator: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤
            signal_coordinator: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤
            position_manager: –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–∑–∏—Ü–∏–π
            position_registry: –†–µ–µ—Å—Ç—Ä –ø–æ–∑–∏—Ü–∏–π
            data_registry: –†–µ–µ—Å—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
            order_coordinator: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –æ—Ä–¥–µ—Ä–æ–≤
            trailing_sl_coordinator: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä Trailing SL
            performance_tracker: –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            trading_statistics: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
            liquidation_guard: –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏
            config_manager: –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            scalping_config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞
            active_positions: –ü—Ä–æ–∫—Å–∏ –∫ –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º
            normalize_symbol: –ú–µ—Ç–æ–¥ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–º–≤–æ–ª–∞
            sync_positions_with_exchange: –ú–µ—Ç–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–π
        """
        self.client = client
        self.signal_generator = signal_generator
        self.signal_coordinator = signal_coordinator
        self.position_manager = position_manager
        self.position_registry = position_registry
        self.data_registry = data_registry
        self.order_coordinator = order_coordinator
        self.trailing_sl_coordinator = trailing_sl_coordinator
        self.performance_tracker = performance_tracker
        self.trading_statistics = trading_statistics
        self.liquidation_guard = liquidation_guard
        self.config_manager = config_manager
        self.scalping_config = scalping_config
        self.active_positions = active_positions
        self._normalize_symbol = normalize_symbol
        self._sync_positions_with_exchange = sync_positions_with_exchange

        self.is_running = False

        # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        self._last_adl_log_time = 0
        self._last_reversal_stats_log_time = 0
        # ‚úÖ –ù–û–í–û–ï: –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è memory usage (—Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç)
        self._last_memory_log_time = 0
        self._memory_log_interval = 600  # 10 –º–∏–Ω—É—Ç

        logger.info("‚úÖ TradingControlCenter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    async def run_main_loop(self) -> None:
        """
        –ì–ª–∞–≤–Ω—ã–π —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª (–±—ã–≤—à–∏–π _main_trading_loop).

        –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤—Å–µ —à–∞–≥–∏ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞:
        1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
        3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
        4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏
        5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ä–¥–µ—Ä–æ–≤
        6. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∏—Ä–∂–µ–π
        7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        8. –ü—Ä–æ–≤–µ—Ä–∫–∞ TSL
        """
        logger.info("üîÑ TCC: –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞")

        self.is_running = True
        loop_start_time = time.time()

        while self.is_running:
            try:
                cycle_start_time = time.perf_counter()

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º is_running –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —à–∞–≥–æ–º
                if not self.is_running:
                    break

                # ‚úÖ –ù–û–í–û–ï: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ memory usage —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç
                current_time = time.time()
                if (
                    current_time - self._last_memory_log_time
                    >= self._memory_log_interval
                ):
                    await self._log_memory_usage()
                    self._last_memory_log_time = current_time

                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                state_start = time.perf_counter()
                await self.update_state()
                state_time = (time.perf_counter() - state_start) * 1000  # –º—Å

                if not self.is_running:
                    break

                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
                signals_start = time.perf_counter()
                signals = await self.signal_generator.generate_signals()
                signals_time = (time.perf_counter() - signals_start) * 1000  # –º—Å

                if len(signals) > 0:
                    logger.info(f"üìä TCC: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(signals)} —Å–∏–≥–Ω–∞–ª–æ–≤")
                else:
                    logger.debug("üìä TCC: –°–∏–≥–Ω–∞–ª–æ–≤ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ")

                if not self.is_running:
                    break

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
                process_start = time.perf_counter()
                await self.signal_coordinator.process_signals(signals)
                process_time = (time.perf_counter() - process_start) * 1000  # –º—Å

                if not self.is_running:
                    break

                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏
                manage_start = time.perf_counter()
                await self.manage_positions()
                manage_time = (time.perf_counter() - manage_start) * 1000  # –º—Å

                if not self.is_running:
                    break

                # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ (—Ç–∞–π–º–∞—É—Ç –∏ –∑–∞–º–µ–Ω–∞ –Ω–∞ —Ä—ã–Ω–æ—á–Ω—ã–µ)
                monitor_start = time.perf_counter()
                await self.order_coordinator.monitor_limit_orders()
                monitor_time = (time.perf_counter() - monitor_start) * 1000  # –º—Å

                if not self.is_running:
                    break

                # ‚úÖ –ü–†–ê–í–ö–ê #17: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ü–∏–∫–ª–∞ TCC
                # ‚úÖ –ì–†–û–ö –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ cycle > 10s (–ø—Ä–æ–±–ª–µ–º–∞) –∏–ª–∏ —Ä–∞–∑ –≤ 10 —Ü–∏–∫–ª–æ–≤
                cycle_time = (time.perf_counter() - cycle_start_time) * 1000  # –º—Å
                if not hasattr(self, "_cycle_count"):
                    self._cycle_count = 0
                self._cycle_count += 1

                # ‚úÖ –ü–†–ê–í–ö–ê #17: –ï—Å–ª–∏ —Ü–∏–∫–ª —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π (>5 —Å–µ–∫), –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                if cycle_time > 5000:
                    logger.warning(
                        f"‚ö†Ô∏è TCC: –ú–µ–¥–ª–µ–Ω–Ω—ã–π —Ü–∏–∫–ª {cycle_time:.1f}ms (–ø–æ—Ä–æ–≥: 5000ms). "
                        f"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞!"
                    )

                if cycle_time > 10000 or self._cycle_count % 10 == 0:
                    logger.info(
                        f"‚è±Ô∏è TCC Performance: cycle={cycle_time:.1f}ms, "
                        f"state={state_time:.1f}ms, signals={signals_time:.1f}ms, "
                        f"process={process_time:.1f}ms, manage={manage_time:.1f}ms, "
                        f"monitor={monitor_time:.1f}ms"
                    )
                else:
                    logger.debug(
                        f"‚è±Ô∏è TCC Performance: cycle={cycle_time:.1f}ms, "
                        f"state={state_time:.1f}ms, signals={signals_time:.1f}ms, "
                        f"process={process_time:.1f}ms, manage={manage_time:.1f}ms, "
                        f"monitor={monitor_time:.1f}ms"
                    )

                # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ä–¥–µ—Ä–æ–≤ –≤ –∫—ç—à–µ
                await self.order_coordinator.update_orders_cache_status(
                    self._normalize_symbol
                )

                if not self.is_running:
                    break

                # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π —Å –±–∏—Ä–∂–µ–π
                await self._sync_positions_with_exchange()

                if not self.is_running:
                    break

                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                await self.update_performance()

                if not self.is_running:
                    break

                # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ TSL –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–∏–∫–µ—Ä–æ–≤
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º TSL –∫–∞–∂–¥—ã–µ 1-2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
                await self.trailing_sl_coordinator.periodic_check()

                if not self.is_running:
                    break

                # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏
                await asyncio.sleep(self.scalping_config.check_interval)

            except asyncio.CancelledError:
                logger.info("üõë TCC: –¢–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª –æ—Ç–º–µ–Ω–µ–Ω")
                break
            except Exception as e:
                # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–ª–Ω—ã–º traceback
                logger.error(
                    f"‚ùå TCC: –û—à–∏–±–∫–∞ –≤ —Ç–æ—Ä–≥–æ–≤–æ–º —Ü–∏–∫–ª–µ: {e}",
                    exc_info=True,  # –ü–æ–ª–Ω—ã–π traceback –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                )
                if self.is_running:
                    await asyncio.sleep(5)  # –ü–∞—É–∑–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                else:
                    break

    async def manage_positions(self) -> None:
        """
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏ (–±—ã–≤—à–∏–π _manage_positions).

        –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ position_manager –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
        - ADL –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (—Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É)
        - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ (—Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç)
        """
        try:
            manage_start = time.perf_counter()

            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ PositionRegistry, –∞ –Ω–µ –∏–∑ –ø—Ä–æ–∫—Å–∏
            all_positions = await self.position_registry.get_all_positions()
            positions_count = len(all_positions)

            if positions_count == 0:
                logger.debug("üìä TCC: –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")
                return

            logger.debug(f"üìä TCC: –ê–Ω–∞–ª–∏–∑ {positions_count} –ø–æ–∑–∏—Ü–∏–π...")

            for symbol, position in all_positions.items():
                pos_start = time.perf_counter()
                await self.position_manager.manage_position(position)
                pos_time = (time.perf_counter() - pos_start) * 1000  # –º—Å
                logger.debug(f"üìä TCC: {symbol} –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ {pos_time:.2f}ms")

            manage_time = (time.perf_counter() - manage_start) * 1000  # –º—Å
            logger.debug(
                f"üìä TCC: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ {manage_time:.2f}ms ({positions_count} –ø–æ–∑–∏—Ü–∏–π)"
            )

            # ‚úÖ –ù–û–í–û–ï: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ADL –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
            # –õ–æ–≥–∏—Ä—É–µ–º ADL –¥–ª—è –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É
            if hasattr(self, "_last_adl_log_time"):
                if time.time() - self._last_adl_log_time < 60:  # –†–∞–∑ –≤ –º–∏–Ω—É—Ç—É
                    return
            else:
                self._last_adl_log_time = 0

            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–π —Å –±–∏—Ä–∂–∏ –¥–ª—è ADL
            try:
                exchange_positions = await self.client.get_positions()
                adl_summary = []
                for pos in exchange_positions or []:
                    pos_size = float(pos.get("pos", "0") or 0)
                    if abs(pos_size) < 1e-8:
                        continue
                    inst_id = pos.get("instId", "")
                    if not inst_id:
                        continue
                    symbol = inst_id.replace("-SWAP", "")
                    adl_rank = pos.get("adlRank") or pos.get("adl")
                    if adl_rank is not None:
                        try:
                            adl_rank = int(adl_rank)
                            upl = float(pos.get("upl", "0") or 0)
                            margin = float(pos.get("margin", "0") or 0)
                            adl_status = (
                                "üî¥ –í–´–°–û–ö–ò–ô"
                                if adl_rank >= 4
                                else "üü° –°–†–ï–î–ù–ò–ô"
                                if adl_rank >= 2
                                else "üü¢ –ù–ò–ó–ö–ò–ô"
                            )
                            adl_summary.append(
                                {
                                    "symbol": symbol,
                                    "adl_rank": adl_rank,
                                    "status": adl_status,
                                    "upl": upl,
                                    "margin": margin,
                                }
                            )
                            # –û–±–Ω–æ–≤–ª—è–µ–º ADL –≤ active_positions
                            if symbol in self.active_positions:
                                self.active_positions[symbol]["adl_rank"] = adl_rank
                        except (ValueError, TypeError):
                            pass

                # –õ–æ–≥–∏—Ä—É–µ–º —Å–≤–æ–¥–∫—É ADL –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
                if adl_summary:
                    adl_info = ", ".join(
                        [
                            f"{item['symbol']}: {item['status']} (rank={item['adl_rank']}, PnL={item['upl']:.2f} USDT)"
                            for item in adl_summary
                        ]
                    )
                    logger.info(f"üìä TCC: ADL –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π: {adl_info}")

                    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º ADL –Ω–∞ –ª—é–±–æ–π –ø–æ–∑–∏—Ü–∏–∏
                    high_adl_positions = [
                        item for item in adl_summary if item["adl_rank"] >= 4
                    ]
                    if high_adl_positions:
                        high_adl_info = ", ".join(
                            [
                                f"{item['symbol']} (rank={item['adl_rank']})"
                                for item in high_adl_positions
                            ]
                        )
                        logger.warning(
                            f"‚ö†Ô∏è TCC: –í–´–°–û–ö–ò–ô ADL –æ–±–Ω–∞—Ä—É–∂–µ–Ω –¥–ª—è –ø–æ–∑–∏—Ü–∏–π: {high_adl_info} "
                            f"(—Ä–∏—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –±–∏—Ä–∂–µ–π)"
                        )

                self._last_adl_log_time = time.time()
            except Exception as e:
                logger.debug(f"‚ö†Ô∏è TCC: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ADL –¥–∞–Ω–Ω—ã–µ: {e}")

            # ‚úÖ –ù–û–í–û–ï: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ (—Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç)
            if hasattr(self, "_last_reversal_stats_log_time"):
                if (
                    time.time() - self._last_reversal_stats_log_time < 300
                ):  # –†–∞–∑ –≤ 5 –º–∏–Ω—É—Ç
                    pass
                else:
                    try:
                        if self.trading_statistics:
                            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Ä–µ–∂–∏–º–æ–≤
                            all_symbols = list(set(self.active_positions.keys()))
                            if all_symbols:
                                reversal_summary = []
                                for symbol in all_symbols:
                                    stats = self.trading_statistics.get_reversal_stats(
                                        symbol=symbol
                                    )
                                    if stats["total_reversals"] > 0:
                                        reversal_summary.append(
                                            f"{symbol}: {stats['total_reversals']} —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ "
                                            f"(‚Üì{stats['v_down_count']}, ‚Üë{stats['v_up_count']}, "
                                            f"avg={stats['avg_price_change']:.2%})"
                                        )

                                if reversal_summary:
                                    reversal_info = ", ".join(reversal_summary)
                                    logger.info(
                                        f"üìä TCC: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤: {reversal_info}"
                                    )

                            # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–∂–∏–º–∞–º
                            for regime in ["trending", "ranging", "choppy"]:
                                stats = self.trading_statistics.get_reversal_stats(
                                    regime=regime
                                )
                                if stats["total_reversals"] > 0:
                                    logger.info(
                                        f"üìä TCC: –†–∞–∑–≤–æ—Ä–æ—Ç—ã –≤ —Ä–µ–∂–∏–º–µ {regime}: "
                                        f"{stats['total_reversals']} —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤ "
                                        f"(‚Üì{stats['v_down_count']}, ‚Üë{stats['v_up_count']})"
                                    )

                        self._last_reversal_stats_log_time = time.time()
                    except Exception as e:
                        logger.debug(
                            f"‚ö†Ô∏è TCC: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤: {e}"
                        )
            else:
                self._last_reversal_stats_log_time = 0

        except Exception as e:
            logger.error(f"‚ùå TCC: –û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏—è–º–∏: {e}")

    async def update_state(self) -> None:
        """
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã (–±—ã–≤—à–∏–π _update_state).

        –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–µ–π –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –º–∞—Ä–∂–∏.
        """
        try:
            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º is_running –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–π
            if not self.is_running:
                return

            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –ø–æ–∑–∏—Ü–∏–π
            positions = await self.client.get_positions()

            if not self.is_running:
                return

            # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —á–µ—Ä–µ–∑ PositionRegistry —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–π
            all_registered = await self.position_registry.get_all_positions()
            all_metadata = await self.position_registry.get_all_metadata()

            # –£–¥–∞–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç –Ω–∞ –±–∏—Ä–∂–µ
            exchange_symbols = set()
            for position in positions:
                symbol = position.get("instId", "").replace("-SWAP", "")
                size = float(position.get("pos", "0"))
                if abs(size) >= 1e-8:
                    exchange_symbols.add(symbol)

            # –£–¥–∞–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –Ω–∞ –±–∏—Ä–∂–µ
            for symbol in list(all_registered.keys()):
                if symbol not in exchange_symbols:
                    await self.position_registry.unregister_position(symbol)

            # –û–±–Ω–æ–≤–ª—è–µ–º/—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            for position in positions:
                symbol = position.get("instId", "").replace("-SWAP", "")
                size = float(position.get("pos", "0"))
                if abs(size) >= 1e-8:
                    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                    existing_metadata = all_metadata.get(symbol)

                    # –ü–æ–ª—É—á–∞–µ–º entry_price –∏–∑ position –¥–∞–Ω–Ω—ã—Ö
                    try:
                        entry_price_from_api = float(position.get("avgPx", 0) or 0)
                    except (TypeError, ValueError):
                        entry_price_from_api = 0.0

                    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ü–æ–ª—É—á–∞–µ–º entry_time –∏–∑ API (cTime/uTime), –µ—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
                    entry_time_from_api = None
                    c_time = position.get("cTime")
                    u_time = position.get("uTime")
                    entry_time_str = c_time or u_time
                    if entry_time_str:
                        try:
                            entry_timestamp_ms = int(entry_time_str)
                            entry_timestamp_sec = entry_timestamp_ms / 1000.0
                            entry_time_from_api = dt.fromtimestamp(entry_timestamp_sec)
                        except (ValueError, TypeError):
                            pass

                    # –ï—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ update_position (–±–µ–∑ –º—É—Ç–∞—Ü–∏–∏)
                    if existing_metadata:
                        # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è metadata (–±–µ–∑ –º—É—Ç–∞—Ü–∏–∏)
                        metadata_updates = {}

                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º entry_time, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –µ—Å—Ç—å –≤ API
                        if (
                            not existing_metadata.entry_time
                            or existing_metadata.entry_time == dt.now(timezone.utc)
                        ):
                            if entry_time_from_api:
                                metadata_updates["entry_time"] = entry_time_from_api

                        # –û–±–Ω–æ–≤–ª—è–µ–º entry_price –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                        if (
                            not existing_metadata.entry_price
                            or existing_metadata.entry_price == 0
                        ):
                            if entry_price_from_api > 0:
                                metadata_updates["entry_price"] = entry_price_from_api

                        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –∏–∑ signal_generator –µ—Å–ª–∏ regime –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                        if not existing_metadata.regime:
                            regime = None
                            if hasattr(
                                self.signal_generator, "regime_managers"
                            ) and symbol in getattr(
                                self.signal_generator, "regime_managers", {}
                            ):
                                manager = self.signal_generator.regime_managers.get(
                                    symbol
                                )
                                if manager:
                                    regime_obj = manager.get_current_regime()
                                    if regime_obj:
                                        regime = (
                                            regime_obj.value.lower()
                                            if hasattr(regime_obj, "value")
                                            else str(regime_obj).lower()
                                        )
                            if not regime:
                                if (
                                    hasattr(self.signal_generator, "regime_manager")
                                    and self.signal_generator.regime_manager
                                ):
                                    regime_obj = (
                                        self.signal_generator.regime_manager.get_current_regime()
                                    )
                                    if regime_obj:
                                        regime = (
                                            regime_obj.value.lower()
                                            if hasattr(regime_obj, "value")
                                            else str(regime_obj).lower()
                                        )
                            if regime:
                                metadata_updates["regime"] = regime

                        # –û–±–Ω–æ–≤–ª—è–µ–º position_side –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                        pos_side_raw = position.get("posSide", "").lower()
                        if (
                            pos_side_raw in ["long", "short"]
                            and not existing_metadata.position_side
                        ):
                            metadata_updates["position_side"] = pos_side_raw

                        # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º update_position –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–±–µ–∑ –º—É—Ç–∞—Ü–∏–∏)
                        if metadata_updates:
                            await self.position_registry.update_position(
                                symbol=symbol,
                                position_updates=position,
                                metadata_updates=metadata_updates,
                            )
                        else:
                            # –ï—Å–ª–∏ –Ω–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π metadata, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ position
                            await self.position_registry.update_position(
                                symbol=symbol,
                                position_updates=position,
                                metadata_updates=None,
                            )
                    else:
                        # –ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è - —Å–æ–∑–¥–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                        from .position_registry import PositionMetadata

                        # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_time –∏–∑ API, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏–Ω–∞—á–µ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                        entry_time_for_metadata = (
                            entry_time_from_api
                            if entry_time_from_api
                            else dt.now(timezone.utc)
                        )

                        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∂–∏–º –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        regime = None
                        if hasattr(
                            self.signal_generator, "regime_managers"
                        ) and symbol in getattr(
                            self.signal_generator, "regime_managers", {}
                        ):
                            manager = self.signal_generator.regime_managers.get(symbol)
                            if manager:
                                regime = manager.get_current_regime()
                        if not regime:
                            if (
                                hasattr(self.signal_generator, "regime_manager")
                                and self.signal_generator.regime_manager
                            ):
                                regime = (
                                    self.signal_generator.regime_manager.get_current_regime()
                                )

                        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º position_side
                        pos_side_raw = position.get("posSide", "").lower()
                        position_side = None
                        if pos_side_raw in ["long", "short"]:
                            position_side = pos_side_raw
                        else:
                            position_side = "long" if size > 0 else "short"

                        # –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        new_metadata = PositionMetadata(
                            entry_time=entry_time_for_metadata,  # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_time –∏–∑ API (cTime/uTime)
                            regime=regime,
                            entry_price=entry_price_from_api
                            if entry_price_from_api > 0
                            else None,
                            position_side=position_side,
                        )

                        await self.position_registry.register_position(
                            symbol=symbol,
                            position=position,
                            metadata=new_metadata,
                        )

            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º is_running –ø–µ—Ä–µ–¥ API –∑–∞–ø—Ä–æ—Å–æ–º
            if not self.is_running:
                return

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –º–∞—Ä–∂–∏
            margin_status = await self.liquidation_guard.get_margin_status(self.client)

            if not self.is_running:
                return

            if margin_status.get("health_status", {}).get("status") == "critical":
                logger.critical("üö® TCC: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ú–ê–†–ñ–ò!")
                # –î–µ–ª–µ–≥–∏—Ä—É–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ orchestrator —á–µ—Ä–µ–∑ callback
                # (—ç—Ç–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ orchestrator._emergency_close_all_positions)

        except asyncio.CancelledError:
            logger.debug("üõë TCC: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ")
            raise  # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ
        except Exception as e:
            # –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
            if self.is_running:
                logger.error(f"‚ùå TCC: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è: {e}")
            else:
                logger.debug(f"üõë TCC: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ: {e}")

    async def update_performance(self) -> None:
        """
        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–±—ã–≤—à–∏–π _update_performance).

        –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ performance_tracker.
        """
        try:
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (update_stats –Ω–µ async, —É–±–∏—Ä–∞–µ–º await)
            self.performance_tracker.update_stats(self.active_positions)
            logger.debug("üìà TCC: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞")

        except Exception as e:
            logger.error(f"‚ùå TCC: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

    async def stop(self) -> None:
        """
        –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞.

        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ is_running = False –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–∏–∫–ª–∞.
        """
        logger.info("üõë TCC: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞")
        self.is_running = False

    async def _log_memory_usage(self) -> None:
        """
        ‚úÖ –ù–û–í–û–ï: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ memory leak.

        –õ–æ–≥–∏—Ä—É–µ—Ç:
        - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (MB)
        - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π –≤ PositionRegistry
        - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ asyncio
        - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        """
        try:
            if not PSUTIL_AVAILABLE:
                return

            # –ü–æ–ª—É—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
            process = psutil.Process(os.getpid())
            memory_info = process.memory_info()
            memory_mb = memory_info.rss / 1024 / 1024  # MB

            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π
            positions = await self.position_registry.get_all_positions()
            positions_count = len(positions) if positions else 0

            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á asyncio
            tasks_count = len(asyncio.all_tasks())

            # –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–π
            metadata_count = 0
            if hasattr(self.position_registry, "_metadata"):
                metadata_count = len(self.position_registry._metadata)

            logger.info(
                f"üíæ Memory Usage: {memory_mb:.1f} MB, "
                f"Positions: {positions_count}, "
                f"Metadata: {metadata_count}, "
                f"Tasks: {tasks_count}"
            )

        except Exception as e:
            logger.debug(f"‚ö†Ô∏è TCC: –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è memory usage: {e}")
```

**–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã datetime:**
- –ò–º–ø–æ—Ä—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: `from datetime import datetime as dt`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `dt.now(timezone.utc)` - –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- **–ü–†–û–ë–õ–ï–ú–ê:** –í–æ–∑–º–æ–∂–Ω–æ, –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `datetime` –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ `dt`
- **–†–ï–®–ï–ù–ò–ï:** –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `datetime` –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `dt`

---

### 4.2. ExitAnalyzer

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/exit_analyzer.py`  
**–†–∞–∑–º–µ—Ä:** 3505 —Å—Ç—Ä–æ–∫  
**–ü—Ä–æ–±–ª–µ–º–∞:** `'>' not supported between instances of 'str' and 'int'`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∏ 2445-2471):**

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: –ü—Ä–∏–≤–æ–¥–∏–º –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –∫ float –ø–µ—Ä–µ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º
# actual_max_holding –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞, minutes_in_position –º–æ–∂–µ—Ç –±—ã—Ç—å None
# ‚úÖ –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï (25.12.2025): –õ–æ–≥–∏—Ä—É–µ–º —Ç–∏–ø—ã –ø–µ—Ä–µ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π
logger.debug(
    f"üîç [RANGING_TYPE_CHECK] {symbol}: actual_max_holding={actual_max_holding} (type={type(actual_max_holding).__name__}), "
    f"max_holding_minutes={max_holding_minutes} (type={type(max_holding_minutes).__name__}), "
    f"minutes_in_position={minutes_in_position} (type={type(minutes_in_position).__name__ if minutes_in_position is not None else 'None'})"
)
try:
    actual_max_holding_float = (
        float(actual_max_holding) if actual_max_holding is not None else 0.0
    )
    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (25.12.2025): –°–æ—Ö—Ä–∞–Ω—è–µ–º float –≤–µ—Ä—Å–∏—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–µ–∑–¥–µ
    actual_max_holding = actual_max_holding_float  # –¢–µ–ø–µ—Ä—å actual_max_holding –≤—Å–µ–≥–¥–∞ float
    logger.debug(
        f"‚úÖ [RANGING_TYPE_CONVERSION] {symbol}: actual_max_holding —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ float: {actual_max_holding:.2f}"
    )
except (TypeError, ValueError) as e:
    logger.warning(
        f"‚ö†Ô∏è ExitAnalyzer: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å actual_max_holding={actual_max_holding} (type={type(actual_max_holding)}) –≤ float: {e}, "
        f"–∏—Å–ø–æ–ª—å–∑—É–µ–º max_holding_minutes={max_holding_minutes}"
    )
    try:
        actual_max_holding_float = float(max_holding_minutes)
        actual_max_holding = actual_max_holding_float
        logger.debug(
            f"‚úÖ [RANGING_TYPE_CONVERSION] {symbol}: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω max_holding_minutes, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ float: {actual_max_holding:.2f}"
        )
    except (TypeError, ValueError) as e2:
        logger.error(
            f"‚ùå ExitAnalyzer: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê - –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å max_holding_minutes={max_holding_minutes} (type={type(max_holding_minutes)}) –≤ float: {e2}, "
            f"–∏—Å–ø–æ–ª—å–∑—É–µ–º fallback 120.0"
        )
        actual_max_holding_float = 120.0
        actual_max_holding = 120.0
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/positions/exit_analyzer.py` (3505 —Å—Ç—Ä–æ–∫)

---

### 4.3. SignalCoordinator

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/signal_coordinator.py`  
**–†–∞–∑–º–µ—Ä:** 2928 —Å—Ç—Ä–æ–∫

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ ADL rank –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏
- –†–∞—Å—á–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ª–µ–≤–µ—Ä–∏–¥–∂–∞

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/coordinators/signal_coordinator.py` (2928 —Å—Ç—Ä–æ–∫)

---

### 4.4. PnLCalculator

**–§–∞–π–ª:** `src/strategies/scalping/futures/calculations/pnl_calculator.py`  
**–†–∞–∑–º–µ—Ä:** 239 —Å—Ç—Ä–æ–∫

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:**

```python
"""
PnLCalculator - –†–∞—Å—á–µ—Ç PnL, –∫–æ–º–∏—Å—Å–∏–π –∏ duration.

–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç:
- Gross PnL
- Net PnL (—Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–π)
- Duration –ø–æ–∑–∏—Ü–∏–∏
- –ö–æ–º–∏—Å—Å–∏–∏ entry –∏ exit
"""

from datetime import datetime, timezone
from typing import Any, Dict, Optional, Tuple

from loguru import logger


class PnLCalculator:
    """
    –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä PnL.

    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–π –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏.
    """

    def __init__(self, client=None, config=None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PnLCalculator.

        Args:
            client: API –∫–ª–∏–µ–Ω—Ç (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ctVal)
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–π)
        """
        self.client = client
        self.config = config

        # ‚úÖ FIX: –ö–æ–º–∏—Å—Å–∏–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (–Ω–µ —Ö–∞—Ä–¥-–∫–æ–¥)
        self.maker_fee_rate = 0.0002  # Fallback
        self.taker_fee_rate = 0.0005  # Fallback

        if config:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–∏—Å—Å–∏–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
            commission_config = getattr(config, "scalping", {})
            if hasattr(commission_config, "commission"):
                commission_config = commission_config.commission
            elif isinstance(commission_config, dict):
                commission_config = commission_config.get("commission", {})
            else:
                commission_config = getattr(config, "commission", {})
            if isinstance(commission_config, dict):
                self.maker_fee_rate = commission_config.get(
                    "maker_fee_rate", self.maker_fee_rate
                )
                self.taker_fee_rate = commission_config.get(
                    "taker_fee_rate", self.taker_fee_rate
                )
            elif hasattr(commission_config, "maker_fee_rate"):
                self.maker_fee_rate = getattr(
                    commission_config, "maker_fee_rate", self.maker_fee_rate
                )
                self.taker_fee_rate = getattr(
                    commission_config, "taker_fee_rate", self.taker_fee_rate
                )

        # ‚úÖ FIX: ADAPT_LOAD –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        logger.info(f"ADAPT_LOAD maker_fee_rate={self.maker_fee_rate:.4%}")
        logger.info(f"ADAPT_LOAD taker_fee_rate={self.taker_fee_rate:.4%}")
        logger.info(
            f"‚úÖ PnLCalculator –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω "
            f"(maker={self.maker_fee_rate:.4%}, taker={self.taker_fee_rate:.4%})"
        )

    async def calculate_pnl(
        self,
        symbol: str,
        side: str,
        entry_price: float,
        exit_price: float,
        size_in_contracts: float,
        entry_time: datetime,
        entry_order_type: str = "market",
        entry_post_only: bool = False,
        exit_order_type: str = "market",
    ) -> Dict[str, Any]:
        """
        –†–∞—Å—Å—á–∏—Ç–∞—Ç—å PnL –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏.

        Args:
            symbol: –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–º–≤–æ–ª
            side: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ("long" –∏–ª–∏ "short")
            entry_price: –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞
            exit_price: –¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞
            size_in_contracts: –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö
            entry_time: –í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
            entry_order_type: –¢–∏–ø entry –æ—Ä–¥–µ—Ä–∞ ("market" –∏–ª–∏ "limit")
            entry_post_only: Post-only –¥–ª—è entry –æ—Ä–¥–µ—Ä–∞
            exit_order_type: –¢–∏–ø exit –æ—Ä–¥–µ—Ä–∞ ("market" –∏–ª–∏ "limit")

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏ PnL
        """
        try:
            # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –º–æ–Ω–µ—Ç—ã
            size_in_coins = await self._convert_contracts_to_coins(
                symbol, size_in_contracts
            )

            # 2. –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π
            entry_commission, exit_commission = self._calculate_commissions(
                symbol=symbol,
                entry_price=entry_price,
                exit_price=exit_price,
                size_in_coins=size_in_coins,
                entry_order_type=entry_order_type,
                entry_post_only=entry_post_only,
                exit_order_type=exit_order_type,
            )

            total_commission = entry_commission + exit_commission

            # 3. –†–∞—Å—á–µ—Ç Gross PnL
            if side.lower() == "long":
                gross_pnl = (exit_price - entry_price) * size_in_coins
            else:  # short
                gross_pnl = (entry_price - exit_price) * size_in_coins

            # 4. –†–∞—Å—á–µ—Ç Net PnL
            net_pnl = gross_pnl - total_commission

            # 5. –†–∞—Å—á–µ—Ç PnL –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
            notional_entry = size_in_coins * entry_price
            pnl_percent_from_price = (net_pnl / notional_entry) * 100

            # 6. –†–∞—Å—á–µ—Ç duration
            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ entry_time –≤ UTC
            if isinstance(entry_time, datetime):
                if entry_time.tzinfo is None:
                    entry_time = entry_time.replace(tzinfo=timezone.utc)
                elif entry_time.tzinfo != timezone.utc:
                    entry_time = entry_time.astimezone(timezone.utc)
            duration_sec = (datetime.now(timezone.utc) - entry_time).total_seconds()
            duration_min = duration_sec / 60.0

            return {
                "gross_pnl": gross_pnl,
                "net_pnl": net_pnl,
                "commission_entry": entry_commission,
                "commission_exit": exit_commission,
                "commission_total": total_commission,
                "pnl_percent_from_price": pnl_percent_from_price,
                "size_in_coins": size_in_coins,
                "size_in_contracts": size_in_contracts,
                "notional_entry": notional_entry,
                "duration_sec": duration_sec,
                "duration_min": duration_min,
            }

        except Exception as e:
            logger.error(
                f"‚ùå PnLCalculator: –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ PnL –¥–ª—è {symbol}: {e}", exc_info=True
            )
            raise

    async def _convert_contracts_to_coins(
        self, symbol: str, size_in_contracts: float
    ) -> float:
        """
        –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –º–æ–Ω–µ—Ç—ã.

        Args:
            symbol: –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–º–≤–æ–ª
            size_in_contracts: –†–∞–∑–º–µ—Ä –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö

        Returns:
            –†–∞–∑–º–µ—Ä –≤ –º–æ–Ω–µ—Ç–∞—Ö
        """
        if not self.client:
            logger.warning(
                f"‚ö†Ô∏è PnLCalculator: –ö–ª–∏–µ–Ω—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback ctVal=0.01 –¥–ª—è {symbol}"
            )
            return abs(size_in_contracts) * 0.01

        try:
            details = await self.client.get_instrument_details(symbol)
            ct_val = float(details.get("ctVal", "0.01"))
            size_in_coins = abs(size_in_contracts) * ct_val

            logger.debug(
                f"‚úÖ PnLCalculator: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è {symbol}: "
                f"{size_in_contracts} –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ * {ct_val} = {size_in_coins:.6f} –º–æ–Ω–µ—Ç"
            )

            return size_in_coins

        except Exception as e:
            logger.warning(
                f"‚ö†Ô∏è PnLCalculator: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ctVal –¥–ª—è {symbol}: {e}, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback"
            )
            return abs(size_in_contracts) * 0.01  # Fallback

    def _calculate_commissions(
        self,
        symbol: str,
        entry_price: float,
        exit_price: float,
        size_in_coins: float,
        entry_order_type: str,
        entry_post_only: bool,
        exit_order_type: str,
    ) -> Tuple[float, float]:
        """
        –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–º–∏—Å—Å–∏–∏ –¥–ª—è entry –∏ exit.

        Args:
            symbol: –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–º–≤–æ–ª
            entry_price: –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞
            exit_price: –¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞
            size_in_coins: –†–∞–∑–º–µ—Ä –≤ –º–æ–Ω–µ—Ç–∞—Ö
            entry_order_type: –¢–∏–ø entry –æ—Ä–¥–µ—Ä–∞
            entry_post_only: Post-only –¥–ª—è entry
            exit_order_type: –¢–∏–ø exit –æ—Ä–¥–µ—Ä–∞

        Returns:
            (entry_commission, exit_commission)
        """
        # Entry –∫–æ–º–∏—Å—Å–∏—è
        notional_entry = size_in_coins * entry_price
        if entry_order_type == "limit" and entry_post_only:
            entry_commission_rate = self.maker_fee_rate
        else:
            entry_commission_rate = self.taker_fee_rate

        entry_commission = notional_entry * entry_commission_rate

        # Exit –∫–æ–º–∏—Å—Å–∏—è (–æ–±—ã—á–Ω–æ taker, —Ç–∞–∫ –∫–∞–∫ MARKET –æ—Ä–¥–µ—Ä)
        notional_exit = size_in_coins * exit_price
        exit_commission_rate = self.taker_fee_rate  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é taker
        exit_commission = notional_exit * exit_commission_rate

        return entry_commission, exit_commission
```

---

### 4.5. AdaptiveLeverage

**–§–∞–π–ª:** `src/strategies/scalping/futures/risk/adaptive_leverage.py`  
**–†–∞–∑–º–µ—Ä:** 252 —Å—Ç—Ä–æ–∫–∏

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:**

```python
"""
Adaptive Leverage - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–∞.

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂ (3, 5, 10, 20, 30) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏–ª—ã —Å–∏–≥–Ω–∞–ª–∞.
"""

from typing import Any, Dict, Optional

from loguru import logger


class AdaptiveLeverage:
    """
    –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–∞.

    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç:
    - –°–∏–ª—ã —Å–∏–≥–Ω–∞–ª–∞ (signal_strength)
    - –†–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞ (trending, ranging, choppy)
    - –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (ATR)
    - –ö–∞—á–µ—Å—Ç–≤–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (RSI, MACD, ADX)
    """

    def __init__(self, config=None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AdaptiveLeverage.

        Args:
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞
        """
        self.config = config

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–µ–≤–µ—Ä–∏–¥–∂–∞ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É —Å–∏–≥–Ω–∞–ª–∞
        self.leverage_map = {
            "very_weak": 3,  # 0.0-0.3
            "weak": 5,  # 0.3-0.5
            "medium": 10,  # 0.5-0.7
            "strong": 20,  # 0.7-0.9
            "very_strong": 30,  # 0.9-1.0
        }

        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂
        self.min_leverage = 3
        self.max_leverage = 30

    async def calculate_leverage(
        self,
        signal: Dict[str, Any],
        regime: Optional[str] = None,
        volatility: Optional[float] = None,
        client: Optional[Any] = None,
        position_size_usd: Optional[float] = None,
    ) -> int:
        """
        –†–∞—Å—á–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ª–µ–≤–µ—Ä–∏–¥–∂–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–∞.

        Args:
            signal: –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
            regime: –†–µ–∂–∏–º —Ä—ã–Ω–∫–∞ (trending, ranging, choppy)
            volatility: –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (ATR –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)
            client: OKXFuturesClient (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è leverage –¥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ)
            position_size_usd: –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ USD (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–ª–µ—á–∞)

        Returns:
            –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂ (3, 5, 10, 20, 30), –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π –¥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞ –±–∏—Ä–∂–µ
        """
        try:
            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º leverage –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –≤ –Ω–∞—á–∞–ª–µ
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–∏–π –ª–µ–≤–µ—Ä–∏–¥–∂ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è —Å–∏–º–≤–æ–ª–∞ –∏–ª–∏ 5)
            leverage = 5  # –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

            # –ü–æ–ª—É—á–∞–µ–º —Å–∏–ª—É —Å–∏–≥–Ω–∞–ª–∞
            signal_strength = signal.get("strength", 0.5)
            if signal_strength < 0:
                signal_strength = 0.0
            elif signal_strength > 1.0:
                signal_strength = 1.0

            # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞
            regime_multiplier = 1.0
            if regime == "trending":
                regime_multiplier = 1.2  # –í —Ç—Ä–µ–Ω–¥–µ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∞
            elif regime == "ranging":
                regime_multiplier = 0.8  # –í –±–æ–∫–æ–≤–∏–∫–µ –º–µ–Ω—å—à–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∞
            elif regime == "choppy":
                regime_multiplier = 0.8  # –í —Ö–∞–æ—Å–µ –º–µ–Ω—å—à–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∞

            # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
            volatility_multiplier = 1.0
            if volatility is not None:
                if volatility > 0.05:  # –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (>5%)
                    volatility_multiplier = 0.7  # –£–º–µ–Ω—å—à–∞–µ–º –ª–µ–≤–µ—Ä–∏–¥–∂
                elif volatility < 0.01:  # –ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (<1%)
                    volatility_multiplier = 1.3  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–µ–≤–µ—Ä–∏–¥–∂

            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
            adjusted_strength = (
                signal_strength * regime_multiplier * volatility_multiplier
            )
            adjusted_strength = max(
                0.0, min(1.0, adjusted_strength)
            )  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 0-1

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–∞
            if adjusted_strength < 0.3:
                category = "very_weak"
            elif adjusted_strength < 0.5:
                category = "weak"
            elif adjusted_strength < 0.7:
                category = "medium"
            elif adjusted_strength < 0.9:
                category = "strong"
            else:
                category = "very_strong"

            leverage = self.leverage_map.get(category, 5)

            # ‚úÖ –ü–†–ê–í–ö–ê #12: –°–Ω–∏–∂–∞–µ–º –ª–µ–≤–µ—Ä–∏–¥–∂ –¥–ª—è ranging (–º–∞–∫—Å–∏–º—É–º 10x) - –ü–ï–†–ï–ú–ï–©–ï–ù–û –ü–û–°–õ–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
            if regime == "ranging":
                leverage = min(leverage, 10)  # –ú–∞–∫—Å–∏–º—É–º 10x –¥–ª—è ranging

            # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (25.12.2025): –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–ª–µ—á–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É –ø–æ–∑–∏—Ü–∏–∏
            # –í–ê–ñ–ù–û: position_size_usd –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ margin, —Ç–∞–∫ –∏ notional
            # –ï—Å–ª–∏ —ç—Ç–æ margin, —Ç–æ notional = margin * leverage (–±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ –≤ signal_coordinator)
            # –ï—Å–ª–∏ —ç—Ç–æ notional, —Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–ø—Ä—è–º—É—é
            # –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ margin, –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
            if position_size_usd is not None and position_size_usd > 0:
                # ‚úÖ –£–õ–£–ß–®–ï–ù–û: –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç ADL
                # –î–ª—è –ø–æ–∑–∏—Ü–∏–π —Å margin > $100 (notional > $1000 –ø—Ä–∏ 10x) —Å–Ω–∏–∂–∞–µ–º –ø–ª–µ—á–æ
                if position_size_usd > 100:
                    leverage = min(leverage, 10)  # –ú–∞–∫—Å–∏–º—É–º 10x –¥–ª—è –ø–æ–∑–∏—Ü–∏–π —Å margin > $100
                    logger.info(
                        f"üîí [LEVERAGE_LIMIT] {signal.get('symbol', 'N/A')}: Margin ${position_size_usd:.2f} > $100, "
                        f"–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–ª–µ—á–∞ –¥–æ 10x (–±—ã–ª–æ {leverage}x) –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç ADL"
                    )
                elif position_size_usd > 50:
                    leverage = min(leverage, 15)  # –ú–∞–∫—Å–∏–º—É–º 15x –¥–ª—è –ø–æ–∑–∏—Ü–∏–π —Å margin > $50
                    logger.info(
                        f"üîí [LEVERAGE_LIMIT] {signal.get('symbol', 'N/A')}: Margin ${position_size_usd:.2f} > $50, "
                        f"–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–ª–µ—á–∞ –¥–æ 15x (–±—ã–ª–æ {leverage}x)"
                    )
                # –ü–æ–∑–∏—Ü–∏–∏ —Å margin <= $50 –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ 20x (—É–∂–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ max_leverage –∏ ranging)

            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
            leverage = max(self.min_leverage, min(self.max_leverage, leverage))

            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º volatility –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã f-string
            volatility_str = f"{volatility:.4f}" if volatility is not None else "N/A"

            symbol = signal.get("symbol", "N/A")

            # üî¥ –ö–†–ò–¢–ò–ß–ù–û: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ leverage (–æ—Ç –ì—Ä–æ–∫–∞)
            logger.info(
                f"üìä [ADAPTIVE_LEVERAGE] {symbol}: –†–∞—Å—á–µ—Ç leverage | "
                f"strength={signal_strength:.2f}, regime={regime}, "
                f"volatility={volatility_str}, "
                f"regime_multiplier={regime_multiplier:.2f}, "
                f"volatility_multiplier={volatility_multiplier:.2f}, "
                f"adjusted_strength={adjusted_strength:.2f}, category={category}, "
                f"requested_leverage={leverage}x (–¥–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è)"
            )

            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –û–∫—Ä—É–≥–ª—è–µ–º leverage –¥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞ –±–∏—Ä–∂–µ
            if client and symbol != "N/A":
                try:
                    original_leverage = leverage

                    # ‚úÖ –ü–†–ê–í–ö–ê #8: –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∏ –∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π
                    leverage_info = await client.get_instrument_leverage_info(symbol)
                    available_leverages = leverage_info.get("available_leverages", [])
                    max_available = leverage_info.get("max_leverage", 20)

                    if available_leverages:
                        logger.info(
                            f"üìä [ADAPTIVE_LEVERAGE] {symbol}: Available leverages: {available_leverages}, max={max_available}x"
                        )
                        # –ù–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –º–∞–∫—Å–∏–º—É–º
                        leverage = min(leverage, max_available)

                    leverage = await client.round_leverage_to_available(
                        symbol, leverage
                    )

                    if leverage != original_leverage:
                        # üî¥ –ö–†–ò–¢–ò–ß–ù–û: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è leverage (–æ—Ç –ì—Ä–æ–∫–∞)
                        logger.warning("=" * 60)
                        logger.warning(
                            f"‚ö†Ô∏è [ADAPTIVE_LEVERAGE] {symbol}: –õ–µ–≤–µ—Ä–∏–¥–∂ –∏–∑–º–µ–Ω–µ–Ω –±–∏—Ä–∂–µ–π!"
                        )
                        logger.warning(f"   –ó–∞—è–≤–ª–µ–Ω–Ω—ã–π: {original_leverage}x")
                        logger.warning(f"   –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π: {leverage}x")
                        logger.warning(
                            f"   –ü—Ä–∏—á–∏–Ω–∞: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞ OKX"
                        )
                        logger.warning("=" * 60)
                    else:
                        logger.info(
                            f"‚úÖ [ADAPTIVE_LEVERAGE] {symbol}: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è | "
                            f"{leverage}x —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –±–∏—Ä–∂–µ"
                        )
                except Exception as e:
                    logger.warning(
                        f"‚ö†Ô∏è [ADAPTIVE_LEVERAGE] {symbol}: –û—à–∏–±–∫–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è leverage: {e}, "
                        f"–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π leverage={leverage}x"
                    )

            # üî¥ –ö–†–ò–¢–ò–ß–ù–û: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ leverage (–æ—Ç –ì—Ä–æ–∫–∞)
            logger.info(
                f"‚úÖ [ADAPTIVE_LEVERAGE] {symbol}: –§–ò–ù–ê–õ–¨–ù–´–ô leverage={leverage}x | "
                f"category={category}, adjusted_strength={adjusted_strength:.2f}"
            )

            return leverage

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ª–µ–≤–µ—Ä–∏–¥–∂–∞: {e}", exc_info=True)
            return 5  # Fallback: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂

    async def get_leverage_for_signal(
        self,
        signal: Dict[str, Any],
        indicators: Optional[Dict[str, Any]] = None,
        client: Optional[Any] = None,
        position_size_usd: Optional[float] = None,
    ) -> int:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∞ –¥–ª—è —Å–∏–≥–Ω–∞–ª–∞ —Å —É—á–µ—Ç–æ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤.

        Args:
            signal: –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
            indicators: –°–ª–æ–≤–∞—Ä—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (RSI, MACD, ADX –∏ —Ç.–¥.)
            client: OKXFuturesClient (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è leverage)
            position_size_usd: –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ USD (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–ª–µ—á–∞)

        Returns:
            –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂
        """
        try:
            regime = signal.get("regime")
            volatility = None

            # –ü–æ–ª—É—á–∞–µ–º –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∏–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            if indicators:
                atr = indicators.get("atr")
                current_price = signal.get("price", 0)
                if atr and current_price > 0:
                    volatility = (atr / current_price) if current_price > 0 else None

            return await self.calculate_leverage(signal, regime, volatility, client, position_size_usd)

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–µ–≤–µ—Ä–∏–¥–∂–∞ –¥–ª—è —Å–∏–≥–Ω–∞–ª–∞: {e}")
            return 5  # Fallback
```

---

### 4.6. DataRegistry

**–§–∞–π–ª:** `src/strategies/scalping/futures/core/data_registry.py`  
**–†–∞–∑–º–µ—Ä:** ~541 —Å—Ç—Ä–æ–∫

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `update_market_data()` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `get_market_data()` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `update_regime()` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞
- `get_regime()` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/core/data_registry.py`

---

### 4.7. PositionRegistry

**–§–∞–π–ª:** `src/strategies/scalping/futures/core/position_registry.py`  
**–†–∞–∑–º–µ—Ä:** ~402 —Å—Ç—Ä–æ–∫–∏

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `register_position()` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏
- `update_position()` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
- `get_position()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
- `get_metadata()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/core/position_registry.py`

---

### 4.8. SignalGenerator

**–§–∞–π–ª:** `src/strategies/scalping/futures/signal_generator.py`  
**–†–∞–∑–º–µ—Ä:** ~5087 —Å—Ç—Ä–æ–∫

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `generate_signals()` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
- `_calculate_signal_strength()` - –†–∞—Å—á–µ—Ç —Å–∏–ª—ã —Å–∏–≥–Ω–∞–ª–∞

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/signal_generator.py`

---

### 4.9. RegimeManager

**–§–∞–π–ª:** `src/strategies/scalping/futures/adaptivity/regime_manager.py`  
**–†–∞–∑–º–µ—Ä:** ~1004 —Å—Ç—Ä–æ–∫–∏

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `get_current_regime()` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
- `detect_regime()` - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/adaptivity/regime_manager.py`

---

### 4.10. ConfigManager

**–§–∞–π–ª:** `src/strategies/scalping/futures/config/config_manager.py`  
**–†–∞–∑–º–µ—Ä:** ~1476 —Å—Ç—Ä–æ–∫

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `get_adaptive_risk_params()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∏—Å–∫–∞
- `get_symbol_profile()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å–∏–º–≤–æ–ª–∞
- `get_balance_profile()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –±–∞–ª–∞–Ω—Å–∞

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/config/config_manager.py`

---

## 5. –§–ò–õ–¨–¢–†–´

### 5.1. –°–ø–∏—Å–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `src/strategies/scalping/futures/filters/`

1. `funding_rate_filter.py` - –§–∏–ª—å—Ç—Ä funding rate
2. `liquidity_filter.py` - –§–∏–ª—å—Ç—Ä –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
3. `momentum_filter.py` - –§–∏–ª—å—Ç—Ä –∏–º–ø—É–ª—å—Å–∞
4. `order_flow_filter.py` - –§–∏–ª—å—Ç—Ä order flow
5. `volatility_regime_filter.py` - –§–∏–ª—å—Ç—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏

**–ü–æ–ª–Ω—ã–µ –∫–æ–¥—ã:** –°–º. —Ñ–∞–π–ª—ã –≤ `src/strategies/scalping/futures/filters/`

---

## 6. –ò–ù–î–ò–ö–ê–¢–û–†–´

### 6.1. –°–ø–∏—Å–æ–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `src/strategies/scalping/futures/indicators/`

1. `fast_adx.py` - –ë—ã—Å—Ç—Ä—ã–π ADX
2. `funding_rate_monitor.py` - –ú–æ–Ω–∏—Ç–æ—Ä funding rate
3. `futures_volume_profile.py` - Volume Profile –¥–ª—è futures
4. `liquidity_levels.py` - –£—Ä–æ–≤–Ω–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
5. `micro_pivot_calculator.py` - –ú–∏–∫—Ä–æ-–ø–∏–≤–æ—Ç—ã
6. `order_flow_indicator.py` - Order Flow –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
7. `trailing_stop_loss.py` - Trailing Stop Loss

**–ü–æ–ª–Ω—ã–µ –∫–æ–¥—ã:** –°–º. —Ñ–∞–π–ª—ã –≤ `src/strategies/scalping/futures/indicators/`

---

## 7. –ö–õ–ò–ï–ù–¢–´ –ò WEBSOCKET

### 7.1. –ö–ª–∏–µ–Ω—Ç—ã

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `src/clients/` –∏–ª–∏ `src/strategies/scalping/futures/clients/`

**–§–∞–π–ª—ã:**
- `futures_client.py` - OKX Futures –∫–ª–∏–µ–Ω—Ç
- `websocket_client.py` - WebSocket –∫–ª–∏–µ–Ω—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–ü–æ–ª–Ω—ã–µ –∫–æ–¥—ã:** –°–º. —Ñ–∞–π–ª—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö

---

### 7.2. WebSocket

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `src/strategies/scalping/futures/websocket/` –∏–ª–∏ `src/strategies/scalping/futures/`

**–§–∞–π–ª—ã:**
- `websocket_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä WebSocket
- `private_websocket_manager.py` - –ü—Ä–∏–≤–∞—Ç–Ω—ã–π WebSocket –º–µ–Ω–µ–¥–∂–µ—Ä

**–ü–æ–ª–Ω—ã–µ –∫–æ–¥—ã:** –°–º. —Ñ–∞–π–ª—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö

---

## 8. –£–¢–ò–õ–ò–¢–´

### 8.1. –°–ø–∏—Å–æ–∫ —É—Ç–∏–ª–∏—Ç

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `src/strategies/scalping/futures/utils/`

**–§–∞–π–ª—ã:**
- `units.py` - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è

**–ü–æ–ª–Ω—ã–µ –∫–æ–¥—ã:** –°–º. —Ñ–∞–π–ª—ã –≤ `src/strategies/scalping/futures/utils/`

---

## 9. –ì–õ–ê–í–ù–´–ï –§–ê–ô–õ–´

### 9.1. src/main_futures.py

**–§–∞–π–ª:** `src/main_futures.py`  
**–†–∞–∑–º–µ—Ä:** 133 —Å—Ç—Ä–æ–∫–∏

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:**

```python
#!/usr/bin/env python3
"""
–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è Futures —Ç–æ—Ä–≥–æ–≤–ª–∏.
–ó–∞–ø—É—Å–∫–∞–µ—Ç Futures –≤–µ—Ä—Å–∏—é —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞.
"""

import asyncio
import os
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
project_root = Path(
    __file__
).parent.parent  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ (–∏–∑ src –≤ –∫–æ—Ä–µ–Ω—å)
sys.path.insert(0, str(project_root))

from loguru import logger

from src.config import BotConfig
from src.strategies.scalping.futures.orchestrator import \
    FuturesScalpingOrchestrator


async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ Futures –±–æ—Ç–∞"""
    orchestrator = None
    try:
        logger.info("üöÄ –ó–∞–ø—É—Å–∫ Futures —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞...")

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config_path = project_root / "config" / "config_futures.yaml"
        if not config_path.exists():
            # –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å (–µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–∑ –∫–æ—Ä–Ω—è)
            alt_path = Path("config/config_futures.yaml")
            if alt_path.exists():
                config_path = alt_path
            else:
                logger.error(f"‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {config_path}")
                logger.error(f"‚ùå –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å —Ç–∞–∫–∂–µ –Ω–µ –Ω–∞–π–¥–µ–Ω: {alt_path}")
                logger.info(
                    "üí° –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª config/config_futures.yaml —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"
                )
                return

        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config = BotConfig.load_from_file(str(config_path))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        if (
            not config.get_okx_config().api_key
            or config.get_okx_config().api_key == "your_api_key_here"
        ):
            logger.error("‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
            logger.info(
                "üí° –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ config/config_futures.yaml –∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ API –∫–ª—é—á–∏"
            )
            return

        # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ä–∏—Å–∫–∞—Ö Futures —Ç–æ—Ä–≥–æ–≤–ª–∏
        logger.warning("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: Futures —Ç–æ—Ä–≥–æ–≤–ª—è —Å–≤—è–∑–∞–Ω–∞ —Å –≤—ã—Å–æ–∫–∏–º–∏ —Ä–∏—Å–∫–∞–º–∏!")
        logger.warning(
            "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞, –ø–æ—Ç–µ—Ä—é –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–µ—Ç–µ —Å–µ–±–µ –ø–æ–∑–≤–æ–ª–∏—Ç—å!"
        )
        logger.warning("‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∞—Ç—å —Å sandbox —Ä–µ–∂–∏–º–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!")

        # –°–æ–∑–¥–∞–µ–º –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
        orchestrator = FuturesScalpingOrchestrator(config)

        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        await orchestrator.start()

    except KeyboardInterrupt:
        logger.info("üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (Ctrl+C)...")
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–∏ KeyboardInterrupt
        if orchestrator:
            try:
                await orchestrator.stop()
            except (asyncio.CancelledError, Exception) as stop_error:
                logger.debug(
                    f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ (–æ–∂–∏–¥–∞–µ–º–æ –ø—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏): {stop_error}"
                )
    except asyncio.CancelledError:
        logger.info("üõë –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞")
        if orchestrator:
            try:
                await orchestrator.stop()
            except Exception as stop_error:
                logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ: {stop_error}")
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if orchestrator:
            try:
                await orchestrator.stop()
            except Exception as stop_error:
                logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ: {stop_error}")
        raise
    finally:
        logger.info("‚úÖ Futures –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


if __name__ == "__main__":
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logger.remove()

    # ‚úÖ –ö–û–ù–°–û–õ–¨: —Ç–æ–ª—å–∫–æ INFO –∏ –≤—ã—à–µ (—á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å —ç–∫—Ä–∞–Ω)
    logger.add(
        sys.stdout,
        level="INFO",
        format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
    )

    # ‚úÖ –§–ê–ô–õ: –í–°–ï –ª–æ–≥–∏ (DEBUG+) —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –ø–æ —Ä–∞–∑–º–µ—Ä—É (5 MB)
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    log_dir = Path("logs/futures")
    log_dir.mkdir(parents=True, exist_ok=True)

    logger.add(
        str(log_dir / "futures_main_{time:YYYY-MM-DD}.log"),  # –ò–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π
        level="DEBUG",  # ‚úÖ –í–°–ï —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
        rotation="5 MB",  # ‚úÖ –†–æ—Ç–∞—Ü–∏—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 5 MB - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ñ–∞–π–ª (futures_main_YYYY-MM-DD_1.log, _2.log –∏ —Ç.–¥.)
        retention="7 days",  # ‚úÖ –•—Ä–∞–Ω–∏–º 7 –¥–Ω–µ–π
        encoding="utf-8",
        backtrace=True,  # –ü–æ–ª–Ω—ã–π backtrace –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        diagnose=True,  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    )

    # –ó–∞–ø—É—Å–∫
    asyncio.run(main())
```

---

## 10. –¢–ï–°–¢–´

### 10.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `tests/`

**–ü–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:**
- `tests/futures/` - –¢–µ—Å—Ç—ã –¥–ª—è futures —Ç–æ—Ä–≥–æ–≤–ª–∏
- `tests/unit/` - Unit —Ç–µ—Å—Ç—ã
- `tests/integration/` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–ü–æ–ª–Ω—ã–µ –∫–æ–¥—ã:** –°–º. —Ñ–∞–π–ª—ã –≤ `tests/`

---

## 11. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### 11.1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É TCC datetime**
   - –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `datetime` –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ `dt`
   - –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `dt` –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ExitAnalyzer**
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ `float`
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å TP/SL –¥–ª—è RANGING**
   - –£–º–µ–Ω—å—à–∏—Ç—å `tp_percent` —Å 5.0% –¥–æ 3-4%
   - –£–≤–µ–ª–∏—á–∏—Ç—å `sl_percent` —Å 1.0% –¥–æ 1.2-1.5%

4. **–£–ª—É—á—à–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–∏–≥–Ω–∞–ª–æ–≤**
   - –°–Ω–∏–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–±—ã—Ç–æ—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
   - –£–ª—É—á—à–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞

### 11.2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ TP/SL**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ TP/SL –¥–ª—è —Ä–µ–∂–∏–º–∞ RANGING
   - –£–≤–µ–ª–∏—á–∏—Ç—å SL –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π

2. **–£–ª—É—á—à–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ RANGING
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–µ–∂–∏–º—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã —Å–∏–≥–Ω–∞–ª–æ–≤
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–ª–∞–±—ã–µ —Å–∏–≥–Ω–∞–ª—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è

---

## 12. –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

### 12.1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏

**–ü–µ—Ä–∏–æ–¥:** 25-26 –¥–µ–∫–∞–±—Ä—è 2025

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫ | 29 |
| –ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö | 7 (24.14%) |
| –£–±—ã—Ç–æ—á–Ω—ã—Ö | 22 (75.86%) |
| –û–±—â–∏–π PnL | **-8.41 USDT** |
| Win Rate | 24.14% |

### 12.2. PnL –ø–æ —Å–∏–º–≤–æ–ª–∞–º

| –°–∏–º–≤–æ–ª | PnL (USDT) | –ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö | –£–±—ã—Ç–æ—á–Ω—ã—Ö |
|--------|------------|------------|-----------|
| ETH-USDT | +6.52 | 5 | 7 |
| SOL-USDT | -4.64 | 0 | 4 |
| DOGE-USDT | -2.26 | 0 | 4 |
| BTC-USDT | -1.16 | 0 | 3 |
| XRP-USDT | -6.87 | 0 | 4 |

### 12.3. –ü—Ä–∏—á–∏–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π

| –ü—Ä–∏—á–∏–Ω–∞ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ü—Ä–æ—Ü–µ–Ω—Ç |
|---------|------------|---------|
| sl_reached | 9 | 31% |
| max_holding_hard_stop_profit | 7 | 24% |
| emergency_loss | 5 | 17% |
| tp_reached | 4 | 14% |
| exchange_side_closure | 4 | 14% |

---

---

## 13. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–û–î–£–õ–ò

### 13.1. PositionScalingManager

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/position_scaling_manager.py`  
**–†–∞–∑–º–µ—Ä:** ~649 —Å—Ç—Ä–æ–∫

**–û–ø–∏—Å–∞–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–µ—Å—Ç–Ω–∏—á–Ω—ã–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∫ –ø–æ–∑–∏—Ü–∏—è–º

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `can_add_to_position()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
- `calculate_next_addition_size()` - –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```python
default_config = {
    "max_additions": 4,  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–Ω–∏–∂–µ–Ω–æ —Å 7 –¥–æ 4
    "min_interval_seconds": 30,
    "max_loss_for_addition": -5.0,  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: -5.0% (–±—ã–ª–æ -3.0%)
    "ladder": [1.0, 0.5, 0.3, 0.2],  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–µ—Å—Ç–Ω–∏—Ü–∞ (—Å—É–º–º–∞ 2.0x –≤–º–µ—Å—Ç–æ 3.45x)
}
```

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/positions/position_scaling_manager.py`

---

### 13.2. OrderCoordinator

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/order_coordinator.py`  
**–†–∞–∑–º–µ—Ä:** ~681 —Å—Ç—Ä–æ–∫–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞–º–∏

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `monitor_limit_orders()` - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
- `update_orders_cache_status()` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ä–¥–µ—Ä–æ–≤ –≤ –∫—ç—à–µ

**–ü–æ–ª–Ω—ã–π –∫–æ–¥:** –°–º. —Ñ–∞–π–ª `src/strategies/scalping/futures/coordinators/order_coordinator.py`

---

### 13.3. PositionSizer

**–§–∞–π–ª:** `src/strategies/scalping/futures/risk/position_sizer.py`  
**–†–∞–∑–º–µ—Ä:** 3 —Å—Ç—Ä–æ–∫–∏ (stub)

**–û–ø–∏—Å–∞–Ω–∏–µ:** Stub –¥–ª—è PositionSizer (TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å)

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

---

## 14. –°–¢–†–£–ö–¢–£–†–ê –ö–õ–ò–ï–ù–¢–û–í –ò WEBSOCKET

### 14.1. –ö–ª–∏–µ–Ω—Ç—ã

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `src/strategies/scalping/futures/clients/` –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è:**
- `src/clients/` - –û–±—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã
- `src/strategies/scalping/futures/` - –ö–ª–∏–µ–Ω—Ç—ã –≤ –∫–æ—Ä–Ω–µ futures

**–§–∞–π–ª—ã:**
- `futures_client.py` - OKX Futures –∫–ª–∏–µ–Ω—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
- `websocket_client.py` - WebSocket –∫–ª–∏–µ–Ω—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)

---

### 14.2. WebSocket

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `src/strategies/scalping/futures/websocket/` –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è:**
- `src/strategies/scalping/futures/websocket_manager.py` - –í –∫–æ—Ä–Ω–µ futures
- `src/strategies/scalping/futures/private_websocket_manager.py` - –ü—Ä–∏–≤–∞—Ç–Ω—ã–π WebSocket

**–§–∞–π–ª—ã:**
- `websocket_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä WebSocket
- `private_websocket_manager.py` - –ü—Ä–∏–≤–∞—Ç–Ω—ã–π WebSocket –º–µ–Ω–µ–¥–∂–µ—Ä

---

## 15. –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –§–ê–ô–õ–û–í –ü–†–û–ï–ö–¢–ê

### 15.1. Python —Ñ–∞–π–ª—ã (73 —Ñ–∞–π–ª–∞)

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏:**
1. `src/main_futures.py` - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
2. `src/strategies/scalping/futures/orchestrator.py` - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
3. `src/strategies/scalping/futures/signal_generator.py` - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤
4. `src/strategies/scalping/futures/order_executor.py` - –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ—Ä–¥–µ—Ä–æ–≤
5. `src/strategies/scalping/futures/position_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–∑–∏—Ü–∏–π
6. `src/strategies/scalping/futures/risk_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–∏—Å–∫–æ–≤
7. `src/strategies/scalping/futures/tsl_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä TSL
8. `src/strategies/scalping/futures/websocket_manager.py` - WebSocket –º–µ–Ω–µ–¥–∂–µ—Ä
9. `src/strategies/scalping/futures/private_websocket_manager.py` - –ü—Ä–∏–≤–∞—Ç–Ω—ã–π WebSocket

**Core –º–æ–¥—É–ª–∏:**
10. `src/strategies/scalping/futures/core/trading_control_center.py` - TCC ‚ö†Ô∏è
11. `src/strategies/scalping/futures/core/data_registry.py` - –†–µ–µ—Å—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
12. `src/strategies/scalping/futures/core/position_registry.py` - –†–µ–µ—Å—Ç—Ä –ø–æ–∑–∏—Ü–∏–π
13. `src/strategies/scalping/futures/core/position_sync.py` - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π
14. `src/strategies/scalping/futures/core/candle_buffer.py` - –ë—É—Ñ–µ—Ä —Å–≤–µ—á–µ–π

**Positions –º–æ–¥—É–ª–∏:**
15. `src/strategies/scalping/futures/positions/exit_analyzer.py` - ExitAnalyzer ‚ö†Ô∏è
16. `src/strategies/scalping/futures/positions/position_scaling_manager.py` - Scaling
17. `src/strategies/scalping/futures/positions/take_profit_manager.py` - TP –º–µ–Ω–µ–¥–∂–µ—Ä
18. `src/strategies/scalping/futures/positions/stop_loss_manager.py` - SL –º–µ–Ω–µ–¥–∂–µ—Ä
19. `src/strategies/scalping/futures/positions/entry_manager.py` - Entry –º–µ–Ω–µ–¥–∂–µ—Ä
20. `src/strategies/scalping/futures/positions/position_monitor.py` - –ú–æ–Ω–∏—Ç–æ—Ä –ø–æ–∑–∏—Ü–∏–π
21. `src/strategies/scalping/futures/positions/peak_profit_tracker.py` - –¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–±—ã–ª–∏
22. `src/strategies/scalping/futures/positions/exit_decision_logger.py` - –õ–æ–≥–≥–µ—Ä —Ä–µ—à–µ–Ω–∏–π

**Coordinators:**
23. `src/strategies/scalping/futures/coordinators/signal_coordinator.py` - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤
24. `src/strategies/scalping/futures/coordinators/order_coordinator.py` - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –æ—Ä–¥–µ—Ä–æ–≤
25. `src/strategies/scalping/futures/coordinators/smart_exit_coordinator.py` - –£–º–Ω—ã–π –≤—ã—Ö–æ–¥
26. `src/strategies/scalping/futures/coordinators/trailing_sl_coordinator.py` - TSL –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
27. `src/strategies/scalping/futures/coordinators/websocket_coordinator.py` - WebSocket –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä

**Calculations:**
28. `src/strategies/scalping/futures/calculations/pnl_calculator.py` - PnL –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
29. `src/strategies/scalping/futures/calculations/margin_calculator.py` - –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞—Ä–∂–∏
30. `src/strategies/scalping/futures/calculations/position_sizer.py` - –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
31. `src/strategies/scalping/futures/calculations/regime_calculator.py` - –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–∂–∏–º–∞
32. `src/strategies/scalping/futures/calculations/balance_calculator.py` - –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–ª–∞–Ω—Å–∞

**Risk –º–æ–¥—É–ª–∏:**
33. `src/strategies/scalping/futures/risk/adaptive_leverage.py` - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ª–µ–≤–µ—Ä–∏–¥–∂
34. `src/strategies/scalping/futures/risk/liquidation_protector.py` - –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏
35. `src/strategies/scalping/futures/risk/margin_monitor.py` - –ú–æ–Ω–∏—Ç–æ—Ä –º–∞—Ä–∂–∏
36. `src/strategies/scalping/futures/risk/max_size_limiter.py` - –û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å —Ä–∞–∑–º–µ—Ä–∞
37. `src/strategies/scalping/futures/risk/position_sizer.py` - –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ (stub)

**Signals:**
38. `src/strategies/scalping/futures/signals/filter_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤
39. `src/strategies/scalping/futures/signals/macd_signal_generator.py` - MACD –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
40. `src/strategies/scalping/futures/signals/rsi_signal_generator.py` - RSI –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

**Adaptivity:**
41. `src/strategies/scalping/futures/adaptivity/regime_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–µ–∂–∏–º–æ–≤
42. `src/strategies/scalping/futures/adaptivity/filter_parameters.py` - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
43. `src/strategies/scalping/futures/adaptivity/parameter_adapter.py` - –ê–¥–∞–ø—Ç–µ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
44. `src/strategies/scalping/futures/adaptivity/balance_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–ª–∞–Ω—Å–∞

**Filters (5 —Ñ–∞–π–ª–æ–≤):**
45. `src/strategies/scalping/futures/filters/funding_rate_filter.py`
46. `src/strategies/scalping/futures/filters/liquidity_filter.py`
47. `src/strategies/scalping/futures/filters/momentum_filter.py`
48. `src/strategies/scalping/futures/filters/order_flow_filter.py`
49. `src/strategies/scalping/futures/filters/volatility_regime_filter.py`

**Indicators (7 —Ñ–∞–π–ª–æ–≤):**
50. `src/strategies/scalping/futures/indicators/fast_adx.py`
51. `src/strategies/scalping/futures/indicators/funding_rate_monitor.py`
52. `src/strategies/scalping/futures/indicators/futures_volume_profile.py`
53. `src/strategies/scalping/futures/indicators/liquidity_levels.py`
54. `src/strategies/scalping/futures/indicators/micro_pivot_calculator.py`
55. `src/strategies/scalping/futures/indicators/order_flow_indicator.py`
56. `src/strategies/scalping/futures/indicators/trailing_stop_loss.py`

**Config:**
57. `src/strategies/scalping/futures/config/config_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**Logging (3 —Ñ–∞–π–ª–∞):**
58. `src/strategies/scalping/futures/logging/logger_factory.py`
59. `src/strategies/scalping/futures/logging/structured_logger.py`
60. `src/strategies/scalping/futures/logging/debug_logger.py`

**Utils:**
61. `src/strategies/scalping/futures/utils/units.py`

**–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:**
62-73. `__init__.py` —Ñ–∞–π–ª—ã –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö

---

## 16. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–û–ù–ù–´–ï –§–ê–ô–õ–´

### 16.1. config/config_futures.yaml

**–†–∞–∑–º–µ—Ä:** 1915 —Å—Ç—Ä–æ–∫

**–û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏:**
- `api` - API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `scalping` - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞
- `adaptive_regime` - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–µ–∂–∏–º—ã
- `symbol_profiles` - –ü—Ä–æ—Ñ–∏–ª–∏ —Å–∏–º–≤–æ–ª–æ–≤
- `risk` - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∏—Å–∫–∞
- `exit_params` - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã—Ö–æ–¥–∞

**–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥:** –°–º. —Ñ–∞–π–ª `config/config_futures.yaml`

---

## 17. –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –ò –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### 17.1. requirements.txt

**–°–º. —Ä–∞–∑–¥–µ–ª 1.2**

---

## 18. –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### 18.1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **TCC datetime –æ—à–∏–±–∫–∞** (–ö–†–ò–¢–ò–ß–ù–û)
   - –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `datetime` –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ `dt`
   - –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `dt` –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 488, 500, 579, 611 –≤ `trading_control_center.py`

2. **ExitAnalyzer TypeError** (–ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ)
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ `float` (—Å—Ç—Ä–æ–∫–∏ 2445-2471)
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è TP/SL –¥–ª—è RANGING** (–í–ê–ñ–ù–û)
   - –£–º–µ–Ω—å—à–∏—Ç—å `tp_percent` —Å 5.0% –¥–æ 3-4%
   - –£–≤–µ–ª–∏—á–∏—Ç—å `sl_percent` —Å 1.0% –¥–æ 1.2-1.5%
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ TP/SL

4. **–£–ª—É—á—à–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤** (–í–ê–ñ–ù–û)
   - –°–Ω–∏–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–±—ã—Ç–æ—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
   - –£–ª—É—á—à–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `min_signal_strength_ranging`

---

**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞**

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ò–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ä–∞, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —á–∞—Å—Ç–∏—á–Ω–æ –∏–ª–∏ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã. –ü–æ–ª–Ω—ã–µ –∫–æ–¥—ã –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ.

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 26 –¥–µ–∫–∞–±—Ä—è 2025

