# üìã –î–ï–¢–ê–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –í–´–Ø–í–õ–ï–ù–ù–´–ú –ü–†–û–ë–õ–ï–ú–ê–ú

## –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

–í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç:
- ‚úÖ **–ö–æ–Ω—Ü–µ–ø—Ü–∏—é –±–æ—Ç–∞:** –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è —Å —É—á–µ—Ç–æ–º —Ä—ã–Ω–æ—á–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
- ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (ARM):** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ —Ä–µ–∂–∏–º–∞–º (trending/ranging/choppy)
- ‚úÖ **–†–∞—Å—á–µ—Ç—ã –ø–æ —Ä–µ–∂–∏–º–∞–º:** Per-regime TP, per-symbol –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ loss_cut
- ‚úÖ **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:** –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê #1: –†–∞–∑–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ `active_positions`

### üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
orchestrator.active_positions (–≥–ª–∞–≤–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å)
    ‚îú‚îÄ‚îÄ signal_coordinator.active_positions_ref ‚Üí reference ‚úÖ
    ‚îú‚îÄ‚îÄ websocket_coordinator.active_positions_ref ‚Üí reference ‚úÖ
    ‚îú‚îÄ‚îÄ trailing_sl_coordinator.active_positions_ref ‚Üí reference ‚úÖ
    ‚îî‚îÄ‚îÄ position_manager.active_positions ‚Üí –û–¢–î–ï–õ–¨–ù–´–ô —Å–ª–æ–≤–∞—Ä—å ‚ùå
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `position_manager` –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π `self.active_positions = {}`
- –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –±–∏—Ä–∂–µ–π (`update_or_create_position`) –æ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ–π —Å–ª–æ–≤–∞—Ä—å
- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∏—â–µ—Ç `entry_time` –≤ —Å–≤–æ–µ–º —Å–ª–æ–≤–∞—Ä–µ, –∞ –Ω–µ –≤ `orchestrator.active_positions`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `entry_time` –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è ‚Üí `duration_sec = 0`

### üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø #1.1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å reference –Ω–∞ `orchestrator.active_positions`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π = `orchestrator.active_positions`
- –í—Å–µ –º–æ–¥—É–ª–∏ —á–∏—Ç–∞—é—Ç/–ø–∏—à—É—Ç –≤ –æ–¥–∏–Ω —Å–ª–æ–≤–∞—Ä—å —á–µ—Ä–µ–∑ reference
- –ò—Å–∫–ª—é—á–∞–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# –í position_manager.__init__():
def __init__(self, config, client, margin_calculator, active_positions_ref=None):
    # ...
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º reference –≤–º–µ—Å—Ç–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è
    if active_positions_ref is not None:
        self.active_positions = active_positions_ref  # Reference –Ω–∞ orchestrator.active_positions
    else:
        self.active_positions = {}  # Fallback –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        logger.warning("‚ö†Ô∏è position_manager —Å–æ–∑–¥–∞–Ω –±–µ–∑ active_positions_ref, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å")
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `orchestrator.py`:**
```python
# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ position_manager:
self.position_manager = FuturesPositionManager(
    config, 
    self.client, 
    self.margin_calculator,
    active_positions_ref=self.active_positions  # ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º reference
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–∏–º —Å–ª–æ–≤–∞—Ä–µ–º
- ‚úÖ –ù–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `entry_time` –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –ª—é–±–æ–≥–æ –º–æ–¥—É–ª—è
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏ (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)

**–†–∏—Å–∫–∏:**
- ‚ö†Ô∏è –ù—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –º–µ—Ç–æ–¥—ã `position_manager` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç —Å reference
- ‚ö†Ô∏è –ú–µ—Ç–æ–¥—ã —Ç–∏–ø–∞ `update_or_create_position` –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ reference, –∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:**
```python
# Assert –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
assert self.position_manager.active_positions is self.active_positions, \
    "position_manager.active_positions –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å reference –Ω–∞ orchestrator.active_positions!"
```

---

### üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø #1.2: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `self.active_positions` –∫–∞–∫ –∫—ç—à –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° **–°–†–ï–î–ù–ò–ô** (–µ—Å–ª–∏ #1.1 –Ω–µ–ø—Ä–∏–º–µ–Ω–∏–º–∞)

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
- –û—Å—Ç–∞–≤–∏—Ç—å `position_manager.active_positions` –∫–∞–∫ –∫—ç—à
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è —á—Ç–µ–Ω–∏—è –∏–∑ `orchestrator.active_positions` —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
def _get_active_position(self, symbol: str) -> Optional[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º:
    1. orchestrator.active_positions (–≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
    2. self.active_positions (–∫—ç—à –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    """
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: orchestrator.active_positions
    if hasattr(self, "orchestrator") and self.orchestrator:
        orchestrator_positions = getattr(self.orchestrator, "active_positions", {})
        if symbol in orchestrator_positions:
            return orchestrator_positions[symbol]
    
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫—ç—à
    if symbol in self.active_positions:
        return self.active_positions[symbol]
    
    return None

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö:
# –ë—ã–ª–æ:
# position = self.active_positions.get(symbol, {})

# –°—Ç–∞–ª–æ:
# position = self._get_active_position(symbol) or {}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –í—Å–µ –µ—â–µ –µ—Å—Ç—å –¥–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö (—Ä–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
- ‚ö†Ô∏è –ë–æ–ª—å—à–µ –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê #2: `critical_loss_cut_2x` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π

### üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ö–æ–¥ –≤ `trailing_stop_loss.py:480-501`:**
```python
# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–±—ã—Ç–æ–∫ (2x loss_cut) –∑–∞–∫—Ä—ã–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û
if profit_pct <= -critical_loss_cut_from_price:
    return (True, "critical_loss_cut_2x")  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–ª—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π (0 —Å–µ–∫—É–Ω–¥) –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π loss_cut —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ä–∞–∑—É
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å:
  1. –ü–ª–æ—Ö–æ–π –≤—Ö–æ–¥ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª)
  2. –†–µ–∑–∫–∏–π —Ä–∞–∑–≤–æ—Ä–æ—Ç —Ä—ã–Ω–∫–∞ (–≥—ç–ø, –Ω–æ–≤–æ—Å—Ç–∏)
  3. –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞—Å—á–µ—Ç–æ–º PnL (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `entry_price` –∏–ª–∏ `current_price`)

### üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø #2.1: –î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π grace period –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† **–í–´–°–û–ö–ò–ô**

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
- –ù–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–ø–µ—Ä–≤—ã–µ N —Å–µ–∫—É–Ω–¥) –∏–º–µ—é—Ç –∑–∞—â–∏—Ç—É –æ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
- Grace period –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–∫—Ä—ã—Ç–∏—è –∏–∑-–∑–∞:
  - –í—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–π –ø—Ä–∏ –≤—Ö–æ–¥–µ
  - –ì—ç–ø–æ–≤ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è
  - –ù–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ —Ä–∞—Å—á–µ—Ç–µ PnL —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# –í trailing_stop_loss.py:480
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–±—ã—Ç–æ–∫ (2x loss_cut) –∑–∞–∫—Ä—ã–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û
# ‚úÖ –ù–û: Grace period –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–ø–µ—Ä–≤—ã–µ 10-30 —Å–µ–∫—É–Ω–¥)
CRITICAL_LOSS_CUT_GRACE_PERIOD_SECONDS = 30.0  # –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –ø–æ —Ä–µ–∂–∏–º–∞–º

if profit_pct <= -critical_loss_cut_from_price:
    seconds_in_position = minutes_in_position * 60.0
    
    # Grace period: –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—é
    if seconds_in_position < CRITICAL_LOSS_CUT_GRACE_PERIOD_SECONDS:
        logger.warning(
            f"‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π loss_cut –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω grace period: {symbol} "
            f"profit={profit_pct:.2%} <= -{critical_loss_cut_from_price:.2%}, "
            f"–Ω–æ –ø–æ–∑–∏—Ü–∏—è —Ç–æ–ª—å–∫–æ {seconds_in_position:.1f} —Å–µ–∫ "
            f"(grace period={CRITICAL_LOSS_CUT_GRACE_PERIOD_SECONDS} —Å–µ–∫)"
        )
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        return (False, None)
    
    # –ï—Å–ª–∏ grace period –ø—Ä–æ—à–µ–ª - –∑–∞–∫—Ä—ã–≤–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
    loss_from_margin = abs(profit_pct) * self.leverage
    logger.warning(
        f"üö® Loss-cut –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (2x) –ù–ï–ú–ï–î–õ–ï–ù–ù–û: –ø—Ä–∏–±—ã–ª—å {profit_pct:.2%} –æ—Ç —Ü–µ–Ω—ã "
        f"({loss_from_margin:.2%} –æ—Ç –º–∞—Ä–∂–∏) <= -{critical_loss_cut_from_price:.2%} –æ—Ç —Ü–µ–Ω—ã "
        f"(-{self.loss_cut_percent * 2.0:.2%} –æ—Ç –º–∞—Ä–∂–∏, leverage={self.leverage}x), "
        f"–ø–æ–∑–∏—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∞ –ù–ï–ú–ï–î–õ–ï–ù–ù–û (time_in_position={minutes_in_position:.2f} –º–∏–Ω, "
        f"grace period –ø—Ä–æ–π–¥–µ–Ω)"
    )
    return (True, "critical_loss_cut_2x")
```

**–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —Ä–µ–∂–∏–º–∞–º:**

```python
# Grace period –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –ø–æ —Ä–µ–∂–∏–º–∞–º
def _get_grace_period(self, market_regime: Optional[str] = None) -> float:
    """–ü–æ–ª—É—á–∞–µ—Ç grace period –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞"""
    if market_regime == "choppy":
        return 45.0  # –ë–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ–º —Ä—ã–Ω–∫–µ
    elif market_regime == "trending":
        return 15.0  # –ú–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ç—Ä–µ–Ω–¥–æ–≤–æ–º —Ä—ã–Ω–∫–µ
    else:  # ranging
        return 30.0  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –∏–∑-–∑–∞ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–π –ø—Ä–∏ –≤—Ö–æ–¥–µ
- ‚úÖ –î–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—é —Ü–µ–Ω—ã –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —Ä–µ–∂–∏–º–∞–º —Ä—ã–Ω–∫–∞ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ARM)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–ª—É—á–∞–µ–≤ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

**–†–∏—Å–∫–∏:**
- ‚ö†Ô∏è –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–ª–æ—Ö–æ–π –≤—Ö–æ–¥, –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ (–Ω–µ —Å—Ä–∞–∑—É)
- ‚ö†Ô∏è –í —Ç–µ—á–µ–Ω–∏–µ grace period —É–±—ã—Ç–æ–∫ –º–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é:**
- **Grace period = 30 —Å–µ–∫—É–Ω–¥** –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤ (–±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- –î–ª—è —Ä–µ–∂–∏–º–∞ `choppy` –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 45 —Å–µ–∫—É–Ω–¥
- –î–ª—è —Ä–µ–∂–∏–º–∞ `trending` –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 15 —Å–µ–∫—É–Ω–¥

---

### üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø #2.2: –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–∞ –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ **–ù–ò–ó–ö–ò–ô** (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
- –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–ª–∞—Å—å –ø–æ —Å–∏–ª—å–Ω–æ–º—É —Å–∏–≥–Ω–∞–ª—É (–≤—ã—Å–æ–∫–∏–π score), –¥–∞—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
- –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –±—ã–ª —Å–ª–∞–±—ã–π (–Ω–∏–∑–∫–∏–π score), –∑–∞–∫—Ä—ã–≤–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# –í signal_coordinator –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º score —Å–∏–≥–Ω–∞–ª–∞:
active_positions_ref[symbol]["signal_score"] = signal.get("score", 0.0)

# –í trailing_stop_loss –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º loss_cut:
signal_score = position.get("signal_score", 0.5)
if signal_score > 0.8:  # –°–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª
    grace_period_multiplier = 2.0  # –£–¥–≤–∞–∏–≤–∞–µ–º grace period
elif signal_score < 0.3:  # –°–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª
    grace_period_multiplier = 0.5  # –£–º–µ–Ω—å—à–∞–µ–º grace period
else:
    grace_period_multiplier = 1.0  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π

effective_grace_period = CRITICAL_LOSS_CUT_GRACE_PERIOD_SECONDS * grace_period_multiplier
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–∞
- ‚úÖ –ó–∞—â–∏—Ç–∞ —Å–∏–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –æ—Ç –ª–æ–∂–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –£—Å–ª–æ–∂–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è score –≤ –ø–æ–∑–∏—Ü–∏–∏

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê #3: –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã –¥–ª—è `entry_time`

### üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è 3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞:**
1. `position.get("entry_time")` - –∏–∑ `active_positions` —Å–ª–æ–≤–∞—Ä—è
2. `tsl.entry_timestamp` - –∏–∑ `TrailingStopLoss` –æ–±—ä–µ–∫—Ç–∞
3. `datetime.now()` - –∫–∞–∫ fallback (–¥–∞–µ—Ç `duration_sec = 0`)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –†–∞–∑–Ω—ã–µ –º–æ–¥—É–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- `tsl.entry_timestamp` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ `initialize()`, –Ω–æ `initialize()` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –ø–æ–∑–∂–µ

### üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø #3.1: `orchestrator.active_positions` –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
- `orchestrator.active_positions[symbol]["entry_time"]` - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- –í—Å–µ –º–æ–¥—É–ª–∏ —á–∏—Ç–∞—é—Ç –∏–∑ –Ω–µ–≥–æ
- `TrailingStopLoss.entry_timestamp` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å `active_positions["entry_time"]`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ (signal_coordinator.py):
entry_time = datetime.now()
active_positions_ref[symbol]["entry_time"] = entry_time

# –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TSL (trailing_stop_loss.py):
def initialize(self, entry_price, side, current_price, position: Optional[Dict] = None):
    # ...
    # ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: entry_time –∏–∑ position (orchestrator.active_positions)
    if position and isinstance(position.get("entry_time"), datetime):
        self.entry_timestamp = position["entry_time"].timestamp()
    elif position and isinstance(position.get("entry_time"), str):
        try:
            entry_time = datetime.fromisoformat(position["entry_time"].replace("Z", "+00:00"))
            self.entry_timestamp = entry_time.timestamp()
        except:
            self.entry_timestamp = time.time()  # Fallback
    else:
        self.entry_timestamp = time.time()  # Fallback

# –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ entry_time (–≤—Å–µ –º–æ–¥—É–ª–∏):
def _get_entry_time(self, symbol: str, position: Dict[str, Any]) -> Optional[datetime]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç entry_time —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º:
    1. orchestrator.active_positions (–≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
    2. position dict (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω)
    3. tsl.entry_timestamp (fallback)
    """
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: orchestrator.active_positions
    if hasattr(self, "orchestrator") and self.orchestrator:
        orchestrator_positions = getattr(self.orchestrator, "active_positions", {})
        if symbol in orchestrator_positions:
            entry_time = orchestrator_positions[symbol].get("entry_time")
            if isinstance(entry_time, datetime):
                return entry_time
            elif isinstance(entry_time, str):
                try:
                    return datetime.fromisoformat(entry_time.replace("Z", "+00:00"))
                except:
                    pass
    
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: position dict
    entry_time = position.get("entry_time")
    if isinstance(entry_time, datetime):
        return entry_time
    elif isinstance(entry_time, str):
        try:
            return datetime.fromisoformat(entry_time.replace("Z", "+00:00"))
        except:
            pass
    
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: tsl.entry_timestamp (fallback)
    if hasattr(self, "orchestrator") and self.orchestrator:
        if hasattr(self.orchestrator, "trailing_sl_by_symbol"):
            tsl = self.orchestrator.trailing_sl_by_symbol.get(symbol)
            if tsl and hasattr(tsl, "entry_timestamp") and tsl.entry_timestamp > 0:
                return datetime.fromtimestamp(tsl.entry_timestamp)
    
    return None  # –ù–µ –Ω–∞–π–¥–µ–Ω
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏
- ‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

---

### üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø #3.2: –£–ª—É—á—à–∏—Ç—å fallback –¥–ª—è `entry_time`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† **–í–´–°–û–ö–ò–ô**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (–ü–†–û–ë–õ–ï–ú–ê):**
```python
if entry_time is None:
    entry_time = datetime.now()  # ‚ùå –≠—Ç–æ –¥–∞–µ—Ç duration_sec = 0!
```

**–£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–¥:**

```python
if entry_time is None:
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ TSL –æ–±—ä–µ–∫—Ç–∞
    if hasattr(self, "orchestrator") and self.orchestrator:
        if hasattr(self.orchestrator, "trailing_sl_by_symbol"):
            tsl = self.orchestrator.trailing_sl_by_symbol.get(symbol)
            if tsl and hasattr(tsl, "entry_timestamp") and tsl.entry_timestamp > 0:
                entry_time = datetime.fromtimestamp(tsl.entry_timestamp)
                logger.warning(
                    f"‚ö†Ô∏è entry_time –¥–ª—è {symbol} –ø–æ–ª—É—á–µ–Ω –∏–∑ TSL: {entry_time.isoformat()}"
                )
    
    # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ None, –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞–∑–∞–¥)
    # –≠—Ç–æ –ª—É—á—à–µ —á–µ–º datetime.now(), –Ω–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ
    if entry_time is None:
        entry_time = datetime.now() - timedelta(seconds=1)
        logger.error(
            f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: entry_time –¥–ª—è {symbol} –Ω–µ –Ω–∞–π–¥–µ–Ω, "
            f"–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback (1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞–∑–∞–¥): {entry_time.isoformat()}. "
            f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é active_positions!"
        )
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ `duration_sec = 1` –≤–º–µ—Å—Ç–æ 0 (–ª—É—á—à–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ TSL –ø–µ—Ä–µ–¥ fallback

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê #4: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ PnL –≤ –ª–æ–≥–∞—Ö

### üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
- CSV –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–±—ã—Ç–∫–∏ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π PnL)
- –ù–æ –±–∞–ª–∞–Ω—Å –Ω–∞ –±–∏—Ä–∂–µ –≤—ã—Ä–æ—Å
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑-–∑–∞:
  1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ PnL (–∫–æ–º–∏—Å—Å–∏–∏, ctVal)
  2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ `duration_sec` (–≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É)
  3. –ù–µ—É—á—Ç–µ–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π

### üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø #4.1: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ PnL

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† **–í–´–°–û–ö–ò–ô**

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
- PnL –¥–æ–ª–∂–µ–Ω —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å —É—á–µ—Ç–æ–º:
  - –ö–æ–º–∏—Å—Å–∏–π (maker/taker)
  - ctVal (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –º–æ–Ω–µ—Ç—ã)
  - –ü—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ `entry_price` –∏ `exit_price`
  - –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ (long/short)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π:**
   ```python
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   entry_commission = size_in_coins * entry_price * commission_rate
   exit_commission = size_in_coins * exit_price * commission_rate
   total_commission = entry_commission + exit_commission
   
   # Gross PnL:
   if side == "long":
       gross_pnl = (exit_price - entry_price) * size_in_coins
   else:  # short
       gross_pnl = (entry_price - exit_price) * size_in_coins
   
   # Net PnL:
   net_pnl = gross_pnl - total_commission
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ctVal:**
   ```python
   # –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
   size_in_coins = abs(size_in_contracts) * ct_val
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å entry_price:**
   ```python
   # –î–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ä–µ–∞–ª—å–Ω—ã–π avgPx —Å –±–∏—Ä–∂–∏, –∞ –Ω–µ —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π price
   entry_price = float(actual_position.get("avgPx", "0"))
   ```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ PnL:

```python
def _verify_pnl_calculation(
    self,
    symbol: str,
    entry_price: float,
    exit_price: float,
    size: float,
    side: str,
    commission: float,
    calculated_pnl: float,
) -> Dict[str, Any]:
    """–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Ä–∞—Å—á–µ—Ç PnL –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª–∏"""
    # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç:
    if side.lower() == "long":
        expected_gross_pnl = (exit_price - entry_price) * size
    else:  # short
        expected_gross_pnl = (entry_price - exit_price) * size
    
    expected_net_pnl = expected_gross_pnl - commission
    
    discrepancy = abs(calculated_pnl - expected_net_pnl)
    is_correct = discrepancy < 0.01  # –î–æ–ø—É—Å–∫–∞–µ–º –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å 0.01 USDT
    
    if not is_correct:
        logger.error(
            f"‚ùå –û–®–ò–ë–ö–ê —Ä–∞—Å—á–µ—Ç–∞ PnL –¥–ª—è {symbol}: "
            f"—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ={calculated_pnl:.4f}, –æ–∂–∏–¥–∞–µ—Ç—Å—è={expected_net_pnl:.4f}, "
            f"—Ä–∞–∑–Ω–∏—Ü–∞={discrepancy:.4f}"
        )
    
    return {
        "is_correct": is_correct,
        "calculated": calculated_pnl,
        "expected": expected_net_pnl,
        "discrepancy": discrepancy,
    }
```

---

## üìä –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):

1. **–†–µ—à–µ–Ω–∏–µ #1.1:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å reference –Ω–∞ `orchestrator.active_positions` –≤ `position_manager`
   - –£—Å—Ç—Ä–∞–Ω—è–µ—Ç –∫–æ—Ä–Ω–µ–≤—É—é –ø—Ä–∏—á–∏–Ω—É `duration_sec = 0`
   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

2. **–†–µ—à–µ–Ω–∏–µ #3.1:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `orchestrator.active_positions` –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è `entry_time`
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏
   - –ò—Å–∫–ª—é—á–∞–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

### üü† –í–´–°–û–ö–ò–ï (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):

3. **–†–µ—à–µ–Ω–∏–µ #2.1:** –î–æ–±–∞–≤–∏—Ç—å grace period –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º loss_cut
   - –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ª–æ–∂–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π
   - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —Ä–µ–∂–∏–º–∞–º

4. **–†–µ—à–µ–Ω–∏–µ #3.2:** –£–ª—É—á—à–∏—Ç—å fallback –¥–ª—è `entry_time`
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ `duration_sec = 1` –≤–º–µ—Å—Ç–æ 0
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

5. **–†–µ—à–µ–Ω–∏–µ #4.1:** –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ PnL
   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–æ–≤
   - –ü–æ–º–æ–≥–∞–µ—Ç –Ω–∞–π—Ç–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è

### üü° –°–†–ï–î–ù–ò–ï (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å):

6. **–†–µ—à–µ–Ω–∏–µ #1.2:** –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –∫—ç—à–µ–º (–µ—Å–ª–∏ #1.1 –Ω–µ–ø—Ä–∏–º–µ–Ω–∏–º–∞)

7. **–†–µ—à–µ–Ω–∏–µ #2.2:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–∞ –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º

---

## üîÑ –ü–õ–ê–ù –í–ù–ï–î–†–ï–ù–ò–Ø

### –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 —á–∞—Å–∞)
1. –ò–∑–º–µ–Ω–∏—Ç—å `position_manager` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è reference –Ω–∞ `orchestrator.active_positions`
2. –ò–∑–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã –ø–æ–ª—É—á–µ–Ω–∏—è `entry_time` –¥–ª—è —á—Ç–µ–Ω–∏—è –∏–∑ `orchestrator.active_positions`
3. –£–ª—É—á—à–∏—Ç—å fallback –¥–ª—è `entry_time`

### –≠—Ç–∞–ø 2: –í—ã—Å–æ–∫–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (2-3 —á–∞—Å–∞)
4. –î–æ–±–∞–≤–∏—Ç—å grace period –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ loss_cut
5. –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é PnL

### –≠—Ç–∞–ø 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 —á–∞—Å–∞)
6. –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –Ω–∞ –Ω–µ–±–æ–ª—å—à–æ–º –±–∞–ª–∞–Ω—Å–µ
7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
8. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ `duration_sec` –∏ PnL

### –≠—Ç–∞–ø 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ)
9. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ missing `entry_time`
10. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –±–∏—Ä–∂–µ —Å —Ä–∞—Å—á–µ—Ç–Ω—ã–º PnL –≤ CSV

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. ‚úÖ **`duration_sec` –≤—Å–µ–≥–¥–∞ > 0** (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
2. ‚úÖ **`entry_time` –≤—Å–µ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω** (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å fallback –Ω–∞ `datetime.now()`)
3. ‚úÖ **–ë–∞–ª–∞–Ω—Å –Ω–∞ –±–∏—Ä–∂–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç PnL –≤ CSV** (—Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–π)
4. ‚úÖ **–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö loss_cut –¥–ª—è –ø–æ–∑–∏—Ü–∏–π –º–ª–∞–¥—à–µ 30 —Å–µ–∫—É–Ω–¥** (grace period —Ä–∞–±–æ—Ç–∞–µ—Ç)
5. ‚úÖ **–í—Å–µ –º–æ–¥—É–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –µ–¥–∏–Ω—ã–º `orchestrator.active_positions`**

---

## üìù –ó–ê–ú–ï–¢–ö–ò

- –í—Å–µ —Ä–µ—à–µ–Ω–∏—è —É—á–∏—Ç—ã–≤–∞—é—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —Ä–µ–∂–∏–º–∞–º (ARM)
- –í—Å–µ —Ä–µ—à–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –í—Å–µ —Ä–µ—à–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –±–æ—Ç–∞
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–Ω–µ–¥—Ä—è—Ç—å –ø–æ—ç—Ç–∞–ø–Ω–æ —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

