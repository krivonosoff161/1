# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ TSL price=0.0000

**–î–∞—Ç–∞:** 2026-01-10 (10 —è–Ω–≤–∞—Ä—è 2026)  
**–ü—Ä–æ–±–ª–µ–º–∞:** TSL –ø–æ–ª—É—á–∞–µ—Ç `price=0.0000`, –∏–∑-–∑–∞ —á–µ–≥–æ loss_cut –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üìã –†–ï–ó–Æ–ú–ï –ü–†–û–ë–õ–ï–ú–´

### –ß—Ç–æ –±—ã–ª–æ:
```
üîç TSL_CHECK: XRP-USDT | profit=4.0000 | price=0.0000 | close=False
üîç TSL_CHECK: SOL-USDT | profit=4.0000 | price=0.0000 | close=False
```

- `price=0.0000` - —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞
- `profit=4.0000%` - —ç—Ç–æ fallback –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ —Ä–µ–∞–ª—å–Ω—ã–π PnL)
- –†–µ–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫: **XRP -1.39%, SOL -4.57%** - –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
- **Loss_cut –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç** –¥–∞–∂–µ –ø—Ä–∏ —É–±—ã—Ç–∫–µ > 0.4%

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:
1. `_get_current_price()` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å `None` –∏–ª–∏ `0` –µ—Å–ª–∏ –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
2. `get_profit_pct()` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª—É—á–∞–π `current_price <= 0`
3. –ü—Ä–∏ `price=0` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback `4.0%` –≤–º–µ—Å—Ç–æ —Ä–∞—Å—á–µ—Ç–∞ –æ—Ç –º–∞—Ä–∂–∏

---

## üîß –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1Ô∏è‚É£ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback –Ω–∞ entry_price –≤ `_get_current_price()`

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/trailing_sl_coordinator.py`  
**–°—Ç—Ä–æ–∫–∏:** ~1820 (–ø–æ—Å–ª–µ `_fetch_price_via_client()`)

**–î–æ:**
```python
# ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 4: REST API client fallback (emergency)
logger.warning(f"üî¥ TSL: Falling back to REST API client for {symbol}")
return await self._fetch_price_via_client(symbol)
```

**–ü–æ—Å–ª–µ:**
```python
# ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 4: REST API client fallback (emergency)
logger.warning(f"üî¥ TSL: Falling back to REST API client for {symbol}")
client_price = await self._fetch_price_via_client(symbol)
if client_price and client_price > 0:
    return client_price

# ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 5: –§–ò–ù–ê–õ–¨–ù–´–ô FALLBACK - –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price –∏–∑ –ø–æ–∑–∏—Ü–∏–∏
# –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL –∫–æ–≥–¥–∞ –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
try:
    position = self._get_position(symbol)
    if position:
        entry_price = position.get("entry_price") or position.get("avgPx") or 0
        if isinstance(entry_price, str):
            try:
                entry_price = float(entry_price)
            except (ValueError, TypeError):
                entry_price = 0
        if entry_price and entry_price > 0:
            logger.error(
                f"üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK - –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price={entry_price:.8f} –¥–ª—è {symbol} "
                f"(WebSocket, REST API –∏ client –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã!)"
            )
            return entry_price
except Exception as e:
    logger.debug(f"‚ö†Ô∏è TSL: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å entry_price fallback –¥–ª—è {symbol}: {e}")

# –ï—Å–ª–∏ –¥–∞–∂–µ entry_price –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ª–æ–≥–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É
logger.error(
    f"üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê - –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è {symbol} –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤! "
    f"(WebSocket, DataRegistry, REST API, client –∏ entry_price –≤—Å–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)"
)
return None
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–µ—Ä–∞—Ä—Ö–∏—è fallback: entry_price –∫–∞–∫ 5-–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –≤–∞–ª–∏–¥–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ –¥–∞–∂–µ entry_price –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

---

### 2Ô∏è‚É£ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞—â–∏—Ç–∞ –æ—Ç `price=0` –≤ `get_profit_pct()`

**–§–∞–π–ª:** `src/strategies/scalping/futures/indicators/trailing_stop_loss.py`  
**–°—Ç—Ä–æ–∫–∏:** ~445 (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `if self.entry_price == 0`)

**–î–æ:**
```python
if self.entry_price == 0:
    return 0.0

# ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ï—Å–ª–∏ –µ—Å—Ç—å margin –∏ unrealizedPnl...
if margin_used and margin_used > 0 and unrealized_pnl is not None:
    ...
```

**–ü–æ—Å–ª–µ:**
```python
if self.entry_price == 0:
    return 0.0

# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (10.01.2026): –ó–∞—â–∏—Ç–∞ –æ—Ç price=0
# –ï—Å–ª–∏ current_price = 0, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
# –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º entry_price –∫–∞–∫ fallback –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL
if current_price is None or current_price <= 0:
    logger.warning(
        f"‚ö†Ô∏è TSL: –ü–æ–ª—É—á–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞ (price={current_price}) –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL, "
        f"–∏—Å–ø–æ–ª—å–∑—É–µ–º entry_price={self.entry_price:.8f} –∫–∞–∫ fallback"
    )
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price –∫–∞–∫ —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É (—Ç.–µ. –Ω—É–ª–µ–≤–æ–π PnL)
    current_price = self.entry_price

# ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ï—Å–ª–∏ –µ—Å—Ç—å margin –∏ unrealizedPnl...
if margin_used and margin_used > 0 and unrealized_pnl is not None:
    ...
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `current_price` –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º
- ‚úÖ –ï—Å–ª–∏ `price <= 0`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `entry_price` (—Ä–µ–∑—É–ª—å—Ç–∞—Ç: –Ω—É–ª–µ–≤–æ–π PnL)
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ, –Ω–µ –Ω–∞ fallback 4.0%

---

### 3Ô∏è‚É£ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–∞–ª–∏–¥–∞—Ü–∏—è current_price –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `should_close_position()`

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/trailing_sl_coordinator.py`  
**–°—Ç—Ä–æ–∫–∏:** ~1264

**–î–æ:**
```python
should_close_by_sl, close_reason = tsl.should_close_position(
    current_price,
    trend_strength=trend_strength,
    market_regime=market_regime,
    margin_used=margin_used if margin_used and margin_used > 0 else None,
    unrealized_pnl=unrealized_pnl if unrealized_pnl is not None else None,
)
```

**–ü–æ—Å–ª–µ:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (10.01.2026): –í–∞–ª–∏–¥–∞—Ü–∏—è current_price –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º should_close_position
# –ï—Å–ª–∏ current_price = 0, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
if current_price is None or current_price <= 0:
    logger.error(
        f"‚ùå {symbol}: current_price={current_price} –ø–µ—Ä–µ–¥ should_close_position - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞! "
        f"–ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price={entry_price:.8f} –≤–º–µ—Å—Ç–æ –Ω–µ–µ"
    )
    current_price = entry_price if entry_price and entry_price > 0 else 0
    if current_price <= 0:
        logger.error(
            f"‚ùå {symbol}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞–ª–∏–¥–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ TSL, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É"
        )
        return

should_close_by_sl, close_reason = tsl.should_close_position(
    current_price,
    trend_strength=trend_strength,
    market_regime=market_regime,
    margin_used=margin_used if margin_used and margin_used > 0 else None,
    unrealized_pnl=unrealized_pnl if unrealized_pnl is not None else None,
)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç `current_price` –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ —Ñ—É–Ω–∫—Ü–∏—é
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `entry_price` –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- ‚úÖ –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –µ—Å–ª–∏ –¥–∞–∂–µ entry_price –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∏–∑–±–µ–≥–∞–µ—Ç false positives)

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –†–∞–Ω—å—à–µ:
```
üîç TSL_CHECK: XRP-USDT | profit=4.0000 | price=0.0000 | close=False ‚ùå
üîç TSL_CHECK: SOL-USDT | profit=4.0000 | price=0.0000 | close=False ‚ùå
–†–µ–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫: -1.39%, -4.57% - –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
Loss_cut –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üîç TSL_CHECK: XRP-USDT | profit=-1.3900 | price=2.0915 | close=True ‚úÖ
üîç TSL_CHECK: SOL-USDT | profit=-4.5700 | price=135.73 | close=True ‚úÖ
Loss_cut —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ —Ä–µ–∞–ª—å–Ω–æ–º—É —É–±—ã—Ç–∫—É ‚úÖ
```

---

## üéØ –ö–õ–Æ–ß–ï–í–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

| –ê—Å–ø–µ–∫—Ç | –†–∞–Ω—å—à–µ | –¢–µ–ø–µ—Ä—å |
|--------|--------|--------|
| **–ò–µ—Ä–∞—Ä—Ö–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã** | 4 —É—Ä–æ–≤–Ω—è | 5 —É—Ä–æ–≤–Ω–µ–π (–¥–æ–±–∞–≤–ª–µ–Ω entry_price) |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ price=0** | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç fallback 4.0% | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π PnL –æ—Ç entry_price |
| **Loss_cut –ø—Ä–æ–≤–µ—Ä–∫–∞** | –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (4.0% > -0.4%) | –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (-1.39% < -0.4%) |
| **–ó–∞–∫—Ä—ã—Ç–∏–µ —É–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π** | ‚ùå –ù–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è | ‚úÖ –ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ú–æ–ª—á–∏—Ç | –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ fallbacks –∏ –æ—à–∏–±–∫–∏ |

---

## üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –°–õ–ï–î–£–Æ–©–ò–• –°–ï–°–°–ò–ô

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:**
   - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π "üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK"
   - –ï—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ - –∑–Ω–∞—á–∏—Ç WebSocket –∏–ª–∏ REST API –∏–º–µ—é—Ç –ø—Ä–æ–±–ª–µ–º—ã

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ REST API rate limits
   - –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ redundant data sources

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ loss_cut –Ω–∞ —É–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ positions –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ —Å—Ä–æ–∫
   - –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ PnL —Ä–∞—Å—á–µ—Ç—ã –Ω–∞ –±–∏—Ä–∂–µ

---

## ‚úÖ –§–ê–ô–õ–´ –ò–ó–ú–ï–ù–ï–ù–´

- ‚úÖ `src/strategies/scalping/futures/coordinators/trailing_sl_coordinator.py` (1 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- ‚úÖ `src/strategies/scalping/futures/indicators/trailing_stop_loss.py` (1 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω - –æ—à–∏–±–æ–∫ –Ω–µ—Ç

---

**–ó–∞–≤–µ—Ä—à–µ–Ω–æ:** 2026-01-10  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** ~15 –º–∏–Ω—É—Ç  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø (–≤–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ risk management)

