# –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ —Ä–µ–∂–∏–º–∞–º

**–î–∞—Ç–∞:** 2025-11-30  
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–∂–∏–º–∞ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –¶–ï–ü–û–ß–ö–ò –ü–ï–†–ï–î–ê–ß–ò –†–ï–ñ–ò–ú–ê

### 1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞** (RegimeManager)

**–§–∞–π–ª:** `src/strategies/scalping/futures/adaptivity/regime_manager.py:618-627`

```python
def get_current_regime(self) -> Optional[str]:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä—ã–Ω–∫–∞ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏."""
    if not hasattr(self, "current_regime") or self.current_regime is None:
        return None
    return self.current_regime.value.lower() if self.current_regime else None
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ: `"trending"`, `"ranging"`, `"choppy"`
- –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å `None` –µ—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

---

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –≤ —Å–∏–≥–Ω–∞–ª** (SignalGenerator)

**–§–∞–π–ª:** `src/strategies/scalping/futures/signal_generator.py:3506-3511`

```python
regime_manager = self.regime_managers.get(symbol) or self.regime_manager
current_regime_name = (
    regime_manager.get_current_regime() if regime_manager else None
)
if current_regime_name:
    signal["regime"] = current_regime_name
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**
- –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–∏–≥–Ω–∞–ª, –µ—Å–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
- –ï—Å–ª–∏ `current_regime_name` = `None` ‚Üí —Ä–µ–∂–∏–º –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–∏–≥–Ω–∞–ª

**‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê:** –ï—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, `signal["regime"]` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!

---

### 3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –≤ OrderExecutor**

**–§–∞–π–ª:** `src/strategies/scalping/futures/order_executor.py:1286-1287`

```python
regime = signal.get("regime", "ranging")
regime_params = self._get_regime_params(regime)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback `"ranging"` –µ—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –≤ —Å–∏–≥–Ω–∞–ª–µ
- –†–µ–∂–∏–º –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `_get_regime_params()`

---

### 4. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–µ–∂–∏–º–∞** (OrderExecutor)

**–§–∞–π–ª:** `src/strategies/scalping/futures/order_executor.py:1459-1500` (–ò–°–ü–†–ê–í–õ–ï–ù–û)

**–ë—ã–ª–æ:**
```python
def _get_regime_params(self, regime: str) -> dict:
    adaptive_regime = self.config.get("adaptive_regime", {})  # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!
    return adaptive_regime.get(regime, {})
```

**–°—Ç–∞–ª–æ:**
```python
def _get_regime_params(self, regime: str) -> dict:
    # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å —á–µ—Ä–µ–∑ scalping_config
    if hasattr(self, "orchestrator") and self.orchestrator:
        return self.orchestrator._get_regime_params(regime)
    
    # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É
    adaptive_regime = self.scalping_config.adaptive_regime
    # ... –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ...
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** - —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

---

## üîç –ü–†–û–í–ï–†–ö–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–û–í

### 1. **TP/SL —Ä–∞—Å—á–µ—Ç** (OrderExecutor)

**–§–∞–π–ª:** `src/strategies/scalping/futures/order_executor.py:1289-1345`

**–õ–æ–≥–∏–∫–∞:**
1. ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç `regime_params` –∏–∑ `_get_regime_params(regime)`
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `tp_atr_multiplier` –∏ `sl_atr_multiplier` –∏–∑ `regime_params`
3. ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç `sl_percent` –∏–∑ `regime_params.get("sl_percent")`
4. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç fallback –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π `sl_percent` –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û** (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è `_get_regime_params`)

---

### 2. **ExitAnalyzer** (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞)

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/exit_analyzer.py:179`

**–õ–æ–≥–∏–∫–∞:**
1. ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∂–∏–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ `signal_generator.regime_managers`
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∂–∏–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
3. ‚úÖ Fallback –Ω–∞ `metadata.regime` –µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**

---

### 3. **PositionManager** (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞)

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py:100-218`

**–õ–æ–≥–∏–∫–∞:**
1. ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∂–∏–º –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ –∏–ª–∏ `signal_generator`
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∂–∏–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö TP/SL
3. ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: per-regime ‚Üí per-symbol ‚Üí global

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**

---

## ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **–†–µ–∂–∏–º –º–æ–∂–µ—Ç –±—ã—Ç—å None –≤ —Å–∏–≥–Ω–∞–ª–µ**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `regime_manager.get_current_regime()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`
- –†–µ–∂–∏–º –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–∏–≥–Ω–∞–ª: `signal["regime"]` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- –í `order_executor` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback `"ranging"`

**–í–ª–∏—è–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è `"ranging"` –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º `"trending"` –∏–ª–∏ `"choppy"`

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –£–∂–µ –µ—Å—Ç—å fallback –Ω–∞ `"ranging"` –≤ `order_executor`
- ‚ö†Ô∏è –ù–æ –ª—É—á—à–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å WARNING, –µ—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

---

### 2. **–†–µ–∂–∏–º –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏**

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ `get_current_regime()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É: `self.current_regime.value.lower()`
- ‚úÖ –í —Å–∏–≥–Ω–∞–ª–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞: `signal["regime"] = current_regime_name`
- ‚úÖ –í `order_executor` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞: `regime = signal.get("regime", "ranging")`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **OK** - —Ä–µ–∂–∏–º –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–∫–∞

---

### 3. **–†–µ–≥–∏—Å—Ç—Ä —Ä–µ–∂–∏–º–∞**

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ `get_current_regime()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `.lower()` - –≤—Å–µ–≥–¥–∞ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
- ‚úÖ –í –∫–æ–Ω—Ñ–∏–≥–µ —Ä–µ–∂–∏–º—ã –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ: `trending`, `ranging`, `choppy`
- ‚úÖ –í `_get_regime_params()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `regime.lower()`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **OK** - —Ä–µ–≥–∏—Å—Ç—Ä –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

---

## üìã –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞ | –°—Ç–∞—Ç—É—Å |
|-----------|------------------|----------------------|--------|
| **RegimeManager** | ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ | ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É | ‚úÖ |
| **SignalGenerator** | ‚úÖ –ò–∑ `regime_manager.get_current_regime()` | ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –≤ —Å–∏–≥–Ω–∞–ª | ‚úÖ |
| **OrderExecutor** | ‚úÖ –ò–∑ `signal.get("regime")` | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è `_get_regime_params()` | ‚úÖ |
| **ExitAnalyzer** | ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ `signal_generator` | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ | ‚úÖ |
| **PositionManager** | ‚úÖ –ò–∑ –ø–æ–∑–∏—Ü–∏–∏ –∏–ª–∏ `signal_generator` | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö TP/SL | ‚úÖ |

---

## üéØ –í–´–í–û–î

### ‚úÖ **–í–°–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ü–ï–†–ï–î–ê–Æ–¢–°–Ø –ü–†–ê–í–ò–õ–¨–ù–û**

1. ‚úÖ –†–µ–∂–∏–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ `RegimeManager`
2. ‚úÖ –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–∏–≥–Ω–∞–ª –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
3. ‚úÖ –†–µ–∂–∏–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
4. ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ —Ä–µ–∂–∏–º–∞–º

### ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê**

**–ü—Ä–æ–±–ª–µ–º–∞:** `_get_regime_params()` –Ω–µ –ø–æ–ª—É—á–∞–ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ú–µ—Ç–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ `scalping_config.adaptive_regime`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- **ranging**: `sl_percent=2.0%`, `tp_atr_multiplier=0.8`, `sl_atr_multiplier=0.5`
- **trending**: `sl_percent=1.5%`, `tp_atr_multiplier=1.0`, `sl_atr_multiplier=0.5`
- **choppy**: `sl_percent=1.0%`, `tp_atr_multiplier=0.6`, `sl_atr_multiplier=0.4`

---

## üìä –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å WARNING –µ—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω**

**–í `signal_generator.py`:**
```python
if current_regime_name:
    signal["regime"] = current_regime_name
else:
    logger.warning(f"‚ö†Ô∏è –†–µ–∂–∏–º –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –¥–ª—è {symbol}, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω fallback 'ranging'")
    signal["regime"] = "ranging"  # –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º fallback
```

### 2. ‚úÖ **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `_get_regime_params()`**

- ‚úÖ –£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ WARNING –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ fallback

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ü–ï–†–ï–î–ê–Æ–¢–°–Ø –ò –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø –ü–†–ê–í–ò–õ–¨–ù–û**

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è `_get_regime_params()` –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**


