# Улучшение адаптивности SL/TP по ATR и символу

## Дата: 2025-12-21

## Проблема
SL слишком строгий для ranging noise (0.8% ловит 70% откатов 0.3-0.6% на SOL/BTC), расчет size/margin conservative (risk 1% → small positions, но lev 20x + comm 0.04-0.08% * lev → любой slip = loss), limit exits скользят против (slip 0.1-0.2%).

## Реализованные улучшения

### 1. ✅ Увеличение SL для ranging

#### Базовый SL: 0.8% → 1.0%
- **Файл**: `config/config_futures.yaml`
  - `sl_percent`: 0.8 → **1.0%** (баланс для ranging noise)

#### ATR Multiplier: 1.2 → 1.5
- **Файл**: `config/config_futures.yaml`
  - `sl_atr_multiplier`: 1.2 → **1.5** (max(0.6%, 1.5*ATR_1m))
  - `sl_max_percent`: **1.2%** (новый параметр, защита от слишком широкого SL)

**Ожидаемый эффект**: SL hits -20% (было 70-81%, станет <60%)

### 2. ✅ Снижение TP для ranging

- **Файл**: `config/config_futures.yaml`
  - `tp_percent`: 2.0 → **1.8%** (агрессивнее для ranging)

**Ожидаемый эффект**: Быстрее фиксируем профит, меньше откатов

### 3. ✅ Per-symbol multipliers для SL/TP

- **Файл**: `src/strategies/scalping/futures/positions/exit_analyzer.py`
  - `_get_sl_percent`: Добавлены per-symbol multipliers:
    - SOL-USDT: 1.1 (более волатильный → шире SL)
    - BTC-USDT: 0.9 (менее волатильный → уже SL)
    - ETH-USDT: 1.0 (стандарт)
    - DOGE-USDT: 1.15 (очень волатильный → шире SL)
    - XRP-USDT: 1.05 (немного волатильный)
  - `_get_tp_percent`: Добавлены per-symbol multipliers:
    - SOL-USDT: 0.95 (более волатильный → tighter TP)
    - BTC-USDT: 1.0 (стандарт)
    - ETH-USDT: 1.0 (стандарт)
    - DOGE-USDT: 0.9 (очень волатильный → tighter TP)
    - XRP-USDT: 0.98 (немного волатильный)

**Ожидаемый эффект**: SL/TP адаптируются под волатильность каждого символа

### 4. ✅ Увеличение risk_per_trade для ranging

- **Файл**: `config/config_futures.yaml`
  - `risk.by_regime.ranging.risk_per_trade_percent`: 1.0 → **1.2%** (looser для better RR)

**Ожидаемый эффект**: Size bigger, RR better

### 5. ✅ Partial TP и PH оптимизация

- **Файл**: `config/config_futures.yaml`
  - `partial_tp.by_regime.ranging.trigger_percent`: **0.65%** (баланс между 0.6-0.7%)
  - `ph_threshold_percent`: **0.9%** (баланс между 0.8-1.0%)

**Ожидаемый эффект**: Partial/PH срабатывают раньше, фиксируем профит быстрее

### 6. ⚠️ Market vs Limit для закрытий (частично реализовано)

- **Файл**: `src/strategies/scalping/futures/position_manager.py`
  - `close_position_manually`: Уже использует `order_type="market"` для всех закрытий
  - **Статус**: Market close уже реализован по умолчанию

**Рекомендация**: Добавить логику выбора market vs limit на основе PnL и времени:
- Market если `pnl < -0.3%` или `time > 20min`
- Limit в остальных случаях (для экономии комиссий)

## Итоговая таблица изменений

| Параметр | Было | Стало | Эффект |
|----------|------|-------|--------|
| SL% ranging (базовый) | 0.8% | **1.0%** | SL hits -20% |
| SL ATR multiplier | 1.2 | **1.5** | Шире SL в волатильности |
| SL max | - | **1.2%** | Защита от слишком широкого SL |
| TP% ranging | 2.0% | **1.8%** | Агрессивнее |
| Partial TP trigger | 0.6% | **0.65%** | Баланс |
| PH threshold | 0.8% | **0.9%** | Баланс |
| Risk per trade | 1.0% | **1.2%** | Size bigger, RR better |
| Per-symbol SL mult | Нет | **Да** | Адаптация под символ |
| Per-symbol TP mult | Нет | **Да** | Адаптация под символ |

## Ожидаемый общий эффект

- **SL hits**: <60% (было 70-81%)
- **Partial/PH**: 30-40% (было редкие)
- **Winrate**: 30%+ (было 15.6%)
- **RR**: 1:2.5+ (было хуже)
- **Net PnL**: +0.1-0.3% per trade (было часто минус из-за проскальзывания)

## Следующие шаги

1. ✅ Тестирование на 30+ trades
2. ⚠️ Если SL всё доминирует, вернуть SL к 0.9% или использовать full ATR dynamic
3. ⚠️ Добавить логику выбора market vs limit для закрытий на основе PnL/времени
4. ⚠️ Добавить ATR bins для risk size (low/med/high volatility multipliers)








