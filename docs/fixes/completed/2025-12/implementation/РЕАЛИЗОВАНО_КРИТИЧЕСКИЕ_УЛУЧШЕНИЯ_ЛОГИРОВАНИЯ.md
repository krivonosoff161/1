# ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø

## üìã –°–¢–ê–¢–£–° –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

**–î–∞—Ç–∞:** 2025-12-21  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** ~1.5 —á–∞—Å–∞

---

## ‚úÖ –ó–ê–î–ê–ß–ê 3: Exchange-side closure detection (–ó–ê–í–ï–†–®–ï–ù–û)

**–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py` (—Å—Ç—Ä–æ–∫–∏ 2085-2160)

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
1. ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ DRIFT_REMOVE (exchange-side closures)
2. ‚úÖ JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `logs/futures/structured/position_closures_YYYY-MM-DD.jsonl`
3. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π –ø–æ–∑–∏—Ü–∏–∏ (side, size, entry_price, entry_time, duration)
4. ‚úÖ –£–∫–∞–∑–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω –∑–∞–∫—Ä—ã—Ç–∏—è (TSL, Liquidation, ADL, Manual)

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
üö® –û–ë–ù–ê–†–£–ñ–ï–ù–û –ó–ê–ö–†–´–¢–ò–ï –ù–ê –ë–ò–†–ñ–ï: SOL-USDT
   ‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ, –Ω–æ –ù–ï —á–µ—Ä–µ–∑ –±–æ—Ç–∞!
   üìä –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è:
      Side: LONG
      Size: 2.32 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
      Entry price: $126.400000
      Entry time: 2025-12-21 13:09:38
      –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 245 —Å–µ–∫ (4.08 –º–∏–Ω)
   üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
      - Trailing Stop Loss –Ω–∞ –±–∏—Ä–∂–µ (TSL)
      - Liquidation (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ)
      - ADL (Auto-Deleveraging)
      - Manual close (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –≤—Ä—É—á–Ω—É—é)
```

**JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```json
{
  "timestamp": "2025-12-21T13:13:43.000Z",
  "event": "exchange_side_closure",
  "symbol": "SOL-USDT",
  "side": "LONG",
  "size": 2.32,
  "entry_price": 126.40,
  "entry_time": "2025-12-21T13:09:38.000Z",
  "duration_sec": 245.0,
  "reason": "exchange_side",
  "possible_causes": ["TSL", "Liquidation", "ADL", "Manual"]
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –≤—Å–µ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ –±–∏—Ä–∂–µ (–≤–∫–ª—é—á–∞—è SOL) –±—É–¥—É—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω—ã! ‚úÖ

---

## ‚úÖ –ó–ê–î–ê–ß–ê 4: Partial TP logging (–ó–ê–í–ï–†–®–ï–ù–û)

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py` (—Å—Ç—Ä–æ–∫–∏ 6459-6526)

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
1. ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ Partial TP
2. ‚úÖ JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `logs/futures/structured/partial_tp_YYYY-MM-DD.jsonl`
3. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ–π –∏ –æ—Å—Ç–∞–≤—à–µ–π—Å—è —á–∞—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏
4. ‚úÖ –†–∞—Å—á–µ—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ PnL, –∫–æ–º–∏—Å—Å–∏–π, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
üìä PARTIAL TP: BTC-USDT LONG
   ‚úÇÔ∏è –ó–∞–∫—Ä—ã—Ç–æ: 0.00120000 –º–æ–Ω–µ—Ç (0.12 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤) = 60.0%
   üì¶ –û—Å—Ç–∞–ª–æ—Å—å: 0.00080000 –º–æ–Ω–µ—Ç (0.08 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤) = 40.0%
   üíµ PnL –∑–∞–∫—Ä—ã—Ç–æ–π —á–∞—Å—Ç–∏: $+2.45 USDT (gross=$+2.50, commission=$0.05)
   üìä Entry price: $50000.000000
   üìä Exit price: $50208.333333
   ‚è±Ô∏è  –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 180 —Å–µ–∫ (3.00 –º–∏–Ω)
```

**JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```json
{
  "timestamp": "2025-12-21T13:15:30.000Z",
  "event": "partial_tp",
  "symbol": "BTC-USDT",
  "side": "LONG",
  "partial_amount_coins": 0.0012,
  "partial_amount_contracts": 0.12,
  "partial_percent": 60.0,
  "remaining_amount_coins": 0.0008,
  "remaining_amount_contracts": 0.08,
  "remaining_percent": 40.0,
  "partial_pnl": 2.50,
  "net_partial_pnl": 2.45,
  "commission": 0.05,
  "entry_price": 50000.0,
  "exit_price": 50208.33,
  "duration_sec": 180.0,
  "reason": "partial_tp"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –≤—Å–µ Partial TP –±—É–¥—É—Ç –¥–µ—Ç–∞–ª—å–Ω–æ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω—ã! ‚úÖ

---

## üìä –û–°–¢–ê–í–®–ò–ï–°–Ø –ó–ê–î–ê–ß–ò

### üî¥ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):
- [ ] –ó–∞–¥–∞—á–∞ 1: JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏–π –ø–æ–∑–∏—Ü–∏–π (30 –º–∏–Ω)
- [ ] –ó–∞–¥–∞—á–∞ 2: –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ orchestrator._close_position (15 –º–∏–Ω)

### üü† –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:
- [ ] –ó–∞–¥–∞—á–∞ 5: –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (1 —á–∞—Å)
- [ ] –ó–∞–¥–∞—á–∞ 6: Emergency fallback –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (30 –º–∏–Ω)
- [ ] –ó–∞–¥–∞—á–∞ 7: Consistency check (30 –º–∏–Ω)
- [ ] –ó–∞–¥–∞—á–∞ 8: Pre-close state logging (15 –º–∏–Ω)

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫—Ä—ã—Ç–∏–π** (–ó–∞–¥–∞—á–∞ 1)
   - –î–æ–±–∞–≤–∏—Ç—å –≤ `close_position_manually` –∑–∞–ø–∏—Å—å –≤ JSONL
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ –∏ –¥–ª—è exchange-side closures

2. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ orchestrator._close_position** (–ó–∞–¥–∞—á–∞ 2)
   - –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º (PnL, margin, regime, leverage)

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ exchange-side closures –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Partial TP –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ 3 –∏ 4 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã!  
**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:** –î–∞, –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏








