# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (29.11.2025)

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
> "–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ—Ç —Ç–∞–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã ??"

### –ê–Ω–∞–ª–∏–∑:

**–ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **market order** (–±—ã—Å—Ç—Ä–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ)
- `exit_price` –±–µ—Ä–µ—Ç—Å—è –∏–∑ `markPx` –ø–æ–∑–∏—Ü–∏–∏ **–î–û** —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞
- `markPx` –º–æ–∂–µ—Ç –±—ã—Ç—å **—É—Å—Ç–∞—Ä–µ–≤—à–∏–º** (–∫–∞–∫ –∏ `best_bid` –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–ª—è **market order** —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (–æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–∏—Ç—Å—è –±—ã—Å—Ç—Ä–æ)
- –ù–æ –¥–ª—è **–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞—Å—á–µ—Ç–∞ PnL** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ—Ç–æ—á–Ω–∞—è —Ü–µ–Ω–∞ `markPx`
- –ï—Å–ª–∏ `markPx` —É—Å—Ç–∞—Ä–µ–ª, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—á–µ—Ç PnL –±—É–¥—É—Ç –Ω–µ—Ç–æ—á–Ω—ã–º–∏

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```python
exit_price = float(
    actual_position.get("markPx", "0")
)  # –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (mark price)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `markPx` –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–≤–∏–∂–µ–Ω–∏—è—Ö —Ä—ã–Ω–∫–∞.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
exit_price = float(actual_position.get("markPx", "0"))  # Fallback –Ω–∞ markPx
try:
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
    price_limits = await self.client.get_price_limits(symbol)
    current_price_from_book = price_limits.get("current_price", 0.0)
    best_bid = price_limits.get("best_bid", 0.0)
    best_ask = price_limits.get("best_ask", 0.0)
    
    # ‚úÖ –î–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
    # –î–ª—è LONG (–∑–∞–∫—Ä—ã–≤–∞–µ–º SELL): –∏—Å–ø–æ–ª—å–∑—É–µ–º best_bid (—Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏)
    # –î–ª—è SHORT (–∑–∞–∫—Ä—ã–≤–∞–µ–º BUY): –∏—Å–ø–æ–ª—å–∑—É–µ–º best_ask (—Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏)
    if side.lower() == "long":
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º LONG ‚Üí SELL ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º best_bid
        if best_bid > 0:
            exit_price = best_bid
        elif current_price_from_book > 0:
            exit_price = current_price_from_book
    else:  # short
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º SHORT ‚Üí BUY ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º best_ask
        if best_ask > 0:
            exit_price = best_ask
        elif current_price_from_book > 0:
            exit_price = current_price_from_book
    
    # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ü–µ–Ω—ã (–∫–∞–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)
    mark_px = float(actual_position.get("markPx", "0"))
    if mark_px > 0 and exit_price > 0:
        spread_pct = abs(exit_price - mark_px) / mark_px
        if spread_pct > 0.01:  # –†–∞–∑–Ω–∏—Ü–∞ > 1%
            logger.warning(
                f"‚ö†Ô∏è –ë–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π ({exit_price:.4f}) –∏ markPx ({mark_px:.4f}) "
                f"–¥–ª—è {symbol}: {spread_pct*100:.2f}%"
            )
except Exception as e:
    logger.debug(
        f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è {symbol} –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º: {e}. "
        f"–ò—Å–ø–æ–ª—å–∑—É–µ–º markPx={exit_price:.4f}"
    )
    exit_price = float(actual_position.get("markPx", "0"))
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–¢–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
2. **–¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç PnL:** PnL —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã
3. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ:** –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** Fallback –Ω–∞ `markPx` –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∑–∞–∫—Ä—ã—Ç–∏—è
- **–†–∞—Å—á–µ—Ç PnL** –±—É–¥–µ—Ç –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º
- **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è** –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è, –µ—Å–ª–∏ `markPx` —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

- **–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ `best_bid`/`best_ask` (–∫–æ–º–º–∏—Ç `c3906d6`)
- **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (—Ç–µ–∫—É—â–µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

## ‚úÖ –°—Ç–∞—Ç—É—Å

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [x] Fallback –Ω–∞ `markPx` —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —á–∏—Å—Ç–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

