# üìã –û–¢–ß–ï–¢: –≠–¢–ê–ü 4 - –°–æ–∑–¥–∞–Ω–∏–µ RiskManager

**–î–∞—Ç–∞:** 21 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## üéØ –¶–µ–ª—å —ç—Ç–∞–ø–∞

–í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ —Ä–∏—Å–∫–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ–∑–∏—Ü–∏–π –∏–∑ `OrderExecutor` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π `RiskManager`, —á—Ç–æ–±—ã:
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å—é –ª–æ–≥–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏
- –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä OrderExecutor
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤
- –£–ª—É—á—à–∏—Ç—å –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å RiskManager

**–§–∞–π–ª:** `src/strategies/scalping/spot/risk_manager.py` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ RiskManager:

```python
class RiskManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–∏—Å–∫–æ–≤ –¥–ª—è Spot —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
    
    –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ —Ä–∏—Å–∫–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ–∑–∏—Ü–∏–π.
    """
    
    def __init__(self, client, config, risk_config, full_config, adaptive_regime=None)
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
    async def calculate_position_size(symbol, price) -> float
    def calculate_exit_levels(entry_price, side, atr) -> Tuple[float, float]
    
    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
    def _extract_usdt_balance(balances_check) -> float
    async def _get_current_regime() -> str
```

#### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:

1. **`calculate_position_size()`** - –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏:
   - –ü–æ–ª—É—á–∞–µ—Ç –±–∞–ª–∞–Ω—Å USDT
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä—ã–Ω–∫–∞ (ARM)
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ `manual_pools` –∫–æ–Ω—Ñ–∏–≥–∞
   - –í—ã–±–∏—Ä–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Ä–µ–∂–∏–º—É (TRENDING/RANGING/CHOPPY)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞–∫—Ç–∏–≤–∞ (ETH/BTC)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä

2. **`calculate_exit_levels()`** - –†–∞—Å—á–µ—Ç TP/SL:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ATR –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∫–∞–∫ fallback
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ (buy/sell)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (take_profit, stop_loss)

3. **`_extract_usdt_balance()`** - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ USDT –±–∞–ª–∞–Ω—Å–∞:
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞ API
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç list, dict, –æ–±—ä–µ–∫—Ç—ã Balance
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–∑–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã (available/free/balance)

4. **`_get_current_regime()`** - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞:
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ARM (Adaptive Regime Manager)
   - Fallback –Ω–∞ "RANGING" –µ—Å–ª–∏ ARM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

---

### 2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ OrderExecutor

**–§–∞–π–ª:** `src/strategies/scalping/spot/order_executor.py`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `__init__`:

**–ë—ã–ª–æ:**
```python
def __init__(self, client, config, risk_config, balance_checker=None, adaptive_regime=None):
    ...
```

**–°—Ç–∞–ª–æ:**
```python
def __init__(self, client, config, risk_config, balance_checker=None, adaptive_regime=None, risk_manager=None):
    ...
    self.risk_manager = risk_manager  # üÜï –ù–û–í–û–ï: RiskManager –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
```

#### –£–ø—Ä–æ—â–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ `_calculate_position_size`:

**–ë—ã–ª–æ:** 180 —Å—Ç—Ä–æ–∫ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏

**–°—Ç–∞–ª–æ:** 13 —Å—Ç—Ä–æ–∫ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```python
async def _calculate_position_size(self, symbol: str, price: float) -> float:
    """
    –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞.
    –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ RiskManager.
    """
    if self.risk_manager:
        return await self.risk_manager.calculate_position_size(symbol, price)
    else:
        logger.error("‚ùå RiskManager not initialized!")
        return 0.0
```

#### –£–ø—Ä–æ—â–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ `_calculate_exit_levels`:

**–ë—ã–ª–æ:** 40 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏

**–°—Ç–∞–ª–æ:** 50 —Å—Ç—Ä–æ–∫ (—Å fallback –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
```python
def _calculate_exit_levels(self, entry_price: float, side: OrderSide, atr: float) -> Tuple[float, float]:
    """
    –†–∞—Å—á–µ—Ç —É—Ä–æ–≤–Ω–µ–π TP/SL –Ω–∞ –æ—Å–Ω–æ–≤–µ ATR.
    –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ RiskManager.
    """
    # –î–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ RiskManager –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
    if self.risk_manager:
        take_profit, stop_loss = self.risk_manager.calculate_exit_levels(
            entry_price, side.value, atr
        )
        return stop_loss, take_profit
    
    # Fallback: ARM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
    ...
```

---

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Orchestrator

**–§–∞–π–ª:** `src/strategies/scalping/spot/orchestrator.py`

#### –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RiskManager:

**–ë—ã–ª–æ:**
```python
self.signal_generator = SignalGenerator(...)

self.order_executor = OrderExecutor(
    client,
    config,
    risk_config,
    balance_checker=self.modules.get("balance"),
    adaptive_regime=self.modules.get("arm"),
)
```

**–°—Ç–∞–ª–æ:**
```python
self.signal_generator = SignalGenerator(...)

# üÜï –ù–û–í–û–ï: RiskManager –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ–∑–∏—Ü–∏–π
from .risk_manager import RiskManager

self.risk_manager = RiskManager(
    client,
    config,
    risk_config,
    full_config,
    adaptive_regime=self.modules.get("arm"),
)

self.order_executor = OrderExecutor(
    client,
    config,
    risk_config,
    balance_checker=self.modules.get("balance"),
    adaptive_regime=self.modules.get("arm"),
    risk_manager=self.risk_manager,  # üÜï –ü–µ—Ä–µ–¥–∞–µ–º RiskManager
)
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ OrderExecutor:
- **–£–¥–∞–ª–µ–Ω–æ:** ~180 —Å—Ç—Ä–æ–∫ –∏–∑ `_calculate_position_size`
- **–£–ø—Ä–æ—â–µ–Ω–æ:** `_calculate_exit_levels` —Ç–µ–ø–µ—Ä—å –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ RiskManager
- **–ò—Ç–æ–≥–æ:** ~200 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ

### –°–æ–∑–¥–∞–Ω–∏–µ RiskManager:
- **–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `risk_manager.py` (~350 —Å—Ç—Ä–æ–∫)
- **–ú–µ—Ç–æ–¥—ã:** 4 –ø—É–±–ª–∏—á–Ω—ã—Ö + 2 –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö

### –£–ª—É—á—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ –õ—É—á—à–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π OrderExecutor
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (fallback –ª–æ–≥–∏–∫–∞)

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å:
```bash
python -m py_compile src/strategies/scalping/spot/risk_manager.py    # ‚úÖ OK
python -m py_compile src/strategies/scalping/spot/order_executor.py  # ‚úÖ OK
python -m py_compile src/strategies/scalping/spot/orchestrator.py    # ‚úÖ OK
```

### –õ–∏–Ω—Ç–µ—Ä:
```bash
# –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞ ‚úÖ
```

---

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –º–æ–¥—É–ª—è–º–∏

### ARM (Adaptive Regime Manager):
- RiskManager –ø–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä—ã–Ω–∫–∞ –∏–∑ ARM
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∂–∏–º –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ `manual_pools`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 3 —Ä–µ–∂–∏–º–∞: TRENDING, RANGING, CHOPPY

### Manual Pools:
- RiskManager —á–∏—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ `full_config.manual_pools`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ETH –∏ BTC –ø—É–ª—ã
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ø–æ–¥ —Ä–µ–∂–∏–º —Ä—ã–Ω–∫–∞

### Balance Checker:
- RiskManager –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã USDT –∏ –∞–∫—Ç–∏–≤–æ–≤
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å–¥–µ–ª–∫–∏ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–π–º—ã

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã

- [x] **–≠–¢–ê–ü 1:** –°–æ–∑–¥–∞—Ç—å ConfigManager –∏ –≤—ã–Ω–µ—Å—Ç–∏ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ñ–∏–≥–æ–º
- [x] **–≠–¢–ê–ü 2:** –†–∞—Å—à–∏—Ä–∏—Ç—å PositionManager - –≤—ã–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏
- [x] **–≠–¢–ê–ü 3:** –ü—Ä–æ–ø—É—â–µ–Ω (TSL –Ω–µ—Ç –≤ spot —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)
- [x] **–≠–¢–ê–ü 4:** –°–æ–∑–¥–∞—Ç—å RiskManager - –≤—ã–Ω–µ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
- [ ] **–≠–¢–ê–ü 5:** –í—ã–Ω–µ—Å—Ç–∏ –º–µ—Ç–æ–¥—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π –∏–∑ orchestrator
- [ ] **–≠–¢–ê–ü 6:** –£–ø—Ä–æ—Å—Ç–∏—Ç—å orchestrator - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
- [ ] **–≠–¢–ê–ü 7:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

## üìù –ó–∞–º–µ—Ç–∫–∏

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** OrderExecutor —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç fallback –ª–æ–≥–∏–∫—É –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è RiskManager

2. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤:** –í—Å—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∏—Å–∫–æ–≤ —Ç–µ–ø–µ—Ä—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ - `RiskManager`

3. **–£–ø—Ä–æ—â–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** RiskManager –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç OrderExecutor

4. **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å:** RiskManager –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å ARM –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ–∑–∏—Ü–∏–π

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠–¢–ê–ü 4 –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û



