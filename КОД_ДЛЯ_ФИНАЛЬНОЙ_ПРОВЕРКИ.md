# üìã –ö–æ–¥ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –±–æ–µ–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º

## üìÇ 1. candle_patterns.py (–ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª)

```python
src/indicators/advanced/candle_patterns.py
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ ATR (`atr_factor` –ø–∞—Ä–∞–º–µ—Ç—Ä)
- ‚úÖ –ü–æ—Ä–æ–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (–±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞)
- ‚úÖ –ú–µ—Ç–æ–¥—ã: `is_hammer()`, `is_engulfing_bearish()`, `is_engulfing_bullish()`

---

## üìÇ 2. liquidity_levels.py (–ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª)

```python
src/strategies/scalping/futures/indicators/liquidity_levels.py
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: `{"below": {...}, "above": {...}}`
- ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (–ø–µ—Ä–≤—ã–µ 10 —É—Ä–æ–≤–Ω–µ–π)

---

## üìÇ 3. exit_analyzer.py (—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏)

### 3.1. –ò–º–ø–æ—Ä—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 8-20)

```python
import numpy as np
from loguru import logger

from ...indicators.advanced.candle_patterns import CandlePatternDetector
from ...indicators.advanced.pivot_calculator import PivotCalculator
from ...indicators.advanced.volume_profile import VolumeProfileCalculator
from ..indicators.liquidity_levels import LiquidityLevelsDetector
```

### 3.2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π (—Å—Ç—Ä–æ–∫–∏ 72-100)

```python
# –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—è–º —á–µ—Ä–µ–∑ orchestrator
self.funding_monitor = None
self.client = None

if orchestrator:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    self.funding_monitor = getattr(orchestrator, "funding_monitor", None)
    self.client = getattr(orchestrator, "client", None)
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

# ‚úÖ –ù–û–í–û–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π –¥–ª—è —É–º–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
self.candle_pattern_detector = CandlePatternDetector()
self.volume_profile_calculator = VolumeProfileCalculator()
self.pivot_calculator = PivotCalculator()
self.liquidity_levels_detector = LiquidityLevelsDetector(client=self.client)
```

### 3.3. –í—Å—Ç–∞–≤–∫–∞ –≤ _generate_exit_for_trending (—Å—Ç—Ä–æ–∫–∏ 1312-1330)

```python
if pnl_percent < 0:
    # ---------- –£–ú–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –£–ë–´–¢–û–ß–ù–û–ô –ü–û–ó–ò–¶–ò–ò ----------
    # –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ pnl_percent < 0 –∏ |—É–±—ã—Ç–æ–∫| >= 1.5 * SL
    if pnl_percent <= -sl_percent * 1.5:
        smart_close = await self._should_force_close_by_smart_analysis(
            symbol, position_side, pnl_percent, sl_percent
        )
        if smart_close:
            logger.warning(
                f"üö® ExitAnalyzer TRENDING: –£–º–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ {symbol} "
                f"(—É–±—ã—Ç–æ–∫ {pnl_percent:.2f}% >= {sl_percent * 1.5:.2f}%, –Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–∫–∞—Ç–∞)"
            )
            return {
                "action": "close",
                "reason": "smart_forced_close_trending",
                "pnl_pct": pnl_percent,
                "note": "–ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–∫–∞—Ç–∞ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥–æ SL",
                "trend_strength": trend_strength,
                "minutes_in_position": minutes_in_position,
            }
    # ---------- –ö–û–ù–ï–¶ –£–ú–ù–û–ì–û –ó–ê–ö–†–´–¢–ò–Ø ----------
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ hold ...
```

### 3.4. –í—Å—Ç–∞–≤–∫–∞ –≤ _generate_exit_for_ranging (—Å—Ç—Ä–æ–∫–∏ 1631-1649)

```python
if pnl_percent < 0:
    # ---------- –£–ú–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –£–ë–´–¢–û–ß–ù–û–ô –ü–û–ó–ò–¶–ò–ò ----------
    # –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ pnl_percent < 0 –∏ |—É–±—ã—Ç–æ–∫| >= 1.5 * SL
    if pnl_percent <= -sl_percent * 1.5:
        smart_close = await self._should_force_close_by_smart_analysis(
            symbol, position_side, pnl_percent, sl_percent
        )
        if smart_close:
            logger.warning(
                f"üö® ExitAnalyzer RANGING: –£–º–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ {symbol} "
                f"(—É–±—ã—Ç–æ–∫ {pnl_percent:.2f}% >= {sl_percent * 1.5:.2f}%, –Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–∫–∞—Ç–∞)"
            )
            return {
                "action": "close",
                "reason": "smart_forced_close_ranging",
                "pnl_pct": pnl_percent,
                "note": "–ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–∫–∞—Ç–∞ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥–æ SL",
                "minutes_in_position": minutes_in_position,
                "max_holding_minutes": actual_max_holding,
            }
    # ---------- –ö–û–ù–ï–¶ –£–ú–ù–û–ì–û –ó–ê–ö–†–´–¢–ò–Ø ----------
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ hold ...
```

### 3.5. –í—Å—Ç–∞–≤–∫–∞ –≤ _generate_exit_for_choppy (—Å—Ç—Ä–æ–∫–∏ 1881-1899)

```python
if pnl_percent < 0:
    # ---------- –£–ú–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –£–ë–´–¢–û–ß–ù–û–ô –ü–û–ó–ò–¶–ò–ò ----------
    # –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ pnl_percent < 0 –∏ |—É–±—ã—Ç–æ–∫| >= 1.5 * SL
    if pnl_percent <= -sl_percent * 1.5:
        smart_close = await self._should_force_close_by_smart_analysis(
            symbol, position_side, pnl_percent, sl_percent
        )
        if smart_close:
            logger.warning(
                f"üö® ExitAnalyzer CHOPPY: –£–º–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ {symbol} "
                f"(—É–±—ã—Ç–æ–∫ {pnl_percent:.2f}% >= {sl_percent * 1.5:.2f}%, –Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–∫–∞—Ç–∞)"
            )
            return {
                "action": "close",
                "reason": "smart_forced_close_choppy",
                "pnl_pct": pnl_percent,
                "note": "–ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–∫–∞—Ç–∞ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥–æ SL",
                "minutes_in_position": minutes_in_position,
                "max_holding_minutes": max_holding_minutes,
            }
    # ---------- –ö–û–ù–ï–¶ –£–ú–ù–û–ì–û –ó–ê–ö–†–´–¢–ò–Ø ----------
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ hold ...
```

### 3.6. –ú–µ—Ç–æ–¥—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–∏ 1961-2060)

```python
# ==================== –£–ú–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: –ú–ï–¢–û–î–´ –ü–û–õ–£–ß–ï–ù–ò–Ø –î–ê–ù–ù–´–• ====================

async def _get_funding_rate(self, symbol: str) -> Optional[float]:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π funding rate —á–µ—Ä–µ–∑ funding_monitor"""
    if self.funding_monitor:
        try:
            return self.funding_monitor.get_current_funding()
        except Exception as e:
            logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è funding rate –¥–ª—è {symbol}: {e}")
    return None

async def _get_correlation(self, symbol: str, basket: list, period: int = 20) -> Optional[float]:
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–æ–º –∏ –∫–æ—Ä–∑–∏–Ω–æ–π"""
    # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ CorrelationManager –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
    # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None (–±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ _check_correlation_bias)
    return None

async def _get_nearest_liquidity(self, symbol: str, current_price: float) -> Optional[Dict[str, Dict]]:
    """–ü–æ–ª—É—á–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ —É—Ä–æ–≤–Ω–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏"""
    if self.liquidity_levels_detector:
        try:
            return await self.liquidity_levels_detector.get_nearest_liquidity(symbol, current_price)
        except Exception as e:
            logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –¥–ª—è {symbol}: {e}")
    return None

async def _get_atr(self, symbol: str, period: int = 14) -> Optional[float]:
    """–ü–æ–ª—É—á–∏—Ç—å ATR –¥–ª—è —Å–∏–º–≤–æ–ª–∞"""
    try:
        candles = await self.data_registry.get_candles(symbol, "1m")
        if not candles or len(candles) < period + 1:
            return None

        # –í—ã—á–∏—Å–ª—è–µ–º ATR
        highs = [float(c.high) for c in candles[-period - 1 :]]
        lows = [float(c.low) for c in candles[-period - 1 :]]
        closes = [float(c.close) for c in candles[-period - 1 :]]

        true_ranges = []
        for i in range(1, len(closes)):
            tr = max(
                highs[i] - lows[i],
                abs(highs[i] - closes[i - 1]),
                abs(lows[i] - closes[i - 1]),
            )
            true_ranges.append(tr)

        if len(true_ranges) >= period:
            atr = np.mean(true_ranges[-period:])
            return atr
    except Exception as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ ATR –¥–ª—è {symbol}: {e}")
    return None

async def _get_volume_profile(self, symbol: str, lookback: int = 48) -> Optional[Any]:
    """–ü–æ–ª—É—á–∏—Ç—å Volume Profile –¥–ª—è —Å–∏–º–≤–æ–ª–∞"""
    try:
        candles = await self.data_registry.get_candles(symbol, "1h")
        if not candles or len(candles) < lookback:
            # Fallback –Ω–∞ –º–µ–Ω—å—à–∏–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
            candles = await self.data_registry.get_candles(symbol, "15m")
            if not candles or len(candles) < lookback * 4:
                return None

        profile = self.volume_profile_calculator.calculate(candles[-lookback:])
        return profile
    except Exception as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è Volume Profile –¥–ª—è {symbol}: {e}")
    return None

async def _get_pivot_levels(self, symbol: str, timeframe: str = "1h") -> Optional[Any]:
    """–ü–æ–ª—É—á–∏—Ç—å Pivot Levels –¥–ª—è —Å–∏–º–≤–æ–ª–∞"""
    try:
        candles = await self.data_registry.get_candles(symbol, timeframe)
        if not candles or len(candles) < 1:
            return None

        pivots = self.pivot_calculator.calculate_pivots(candles)
        return pivots
    except Exception as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è Pivot Levels –¥–ª—è {symbol}: {e}")
    return None
```

### 3.7. –ú–µ—Ç–æ–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 2062-2242)

```python
# ==================== –£–ú–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: –ú–ï–¢–û–î–´ –ü–†–û–í–ï–†–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í ====================

async def _check_reversal_signals_score(self, symbol: str, side: str) -> int:
    """–û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è score (0 –∏–ª–∏ 1) –∏–∑ _check_reversal_signals"""
    result = await self._check_reversal_signals(symbol, side)
    return 1 if result else 0

async def _check_funding_bias(self, symbol: str, side: str) -> int:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ funding bias (z-score > 2.0 ‚Üí –ø–µ—Ä–µ–≥—Ä–µ–≤, –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å = —à–∞–Ω—Å –Ω–∞ –æ—Ç–∫–∞—Ç)"""
    funding = await self._get_funding_rate(symbol)
    if funding is None:
        return 0

    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: –µ—Å–ª–∏ funding –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å –∏ –∑–Ω–∞—á–∏–º—ã–π (> 0.02 –∏–ª–∏ < -0.02)
    if side == "long" and funding < -0.02:
        return 1
    if side == "short" and funding > 0.02:
        return 1
    return 0

async def _check_correlation_bias(self, symbol: str, side: str) -> int:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (rolling 20 —Å–≤–µ—á–µ–π, Pearson r, |r| > 0.85 ‚Üí —Å–∏–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è)"""
    basket = ["BTC-USDT", "ETH-USDT", "BNB-USDT"]
    corr = await self._get_correlation(symbol, basket, period=20)
    if corr is None:
        return 0  # –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö = –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º

    # –ï—Å–ª–∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è < 0.85, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –Ω–µ –≤ –Ω–∞—à—É –ø–æ–ª—å–∑—É
    if abs(corr) < 0.85:
        return 1
    return 0

async def _check_liquidity_sweep(self, symbol: str, side: str) -> int:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω–∏–∂–µ/–≤—ã—à–µ –Ω–∞—Å –µ—â–µ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å ‚Üí —à–∞–Ω—Å –Ω–∞ –æ—Ç—Å–∫–æ–∫)"""
    current_price = await self.data_registry.get_price(symbol)
    if not current_price:
        return 0

    liq = await self._get_nearest_liquidity(symbol, current_price)
    if not liq:
        return 0

    below_data = liq.get("below", {})
    above_data = liq.get("above", {})

    if side == "long":
        below_volume = below_data.get("volume", 0)
        below_depth = below_data.get("depth_usd", 0)
        if below_volume > 0 and below_depth > current_price * 0.001:
            return 1
    else:  # short
        above_volume = above_data.get("volume", 0)
        above_depth = above_data.get("depth_usd", 0)
        if above_volume > 0 and above_depth > current_price * 0.001:
            return 1

    return 0

async def _check_reversal_candles(self, symbol: str, side: str) -> int:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–Ω—ã—Ö —Å–≤–µ—á–µ–π (Hammer, Engulfing)"""
    try:
        candles = await self.data_registry.get_candles(symbol, "1m")
        if not candles or len(candles) < 3:
            return 0

        last_3 = candles[-3:]
        atr = await self._get_atr(symbol)

        if side == "long":
            current_candle = last_3[-1]
            prev_candle = last_3[-2] if len(last_3) >= 2 else None
            if await self.candle_pattern_detector.is_hammer(current_candle, prev_candle, atr):
                return 1

        if side == "short" and len(last_3) >= 2:
            current_candle = last_3[-1]
            prev_candle = last_3[-2]
            if await self.candle_pattern_detector.is_engulfing_bearish(current_candle, prev_candle, atr):
                return 1

    except Exception as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç–Ω—ã—Ö —Å–≤–µ—á–µ–π –¥–ª—è {symbol}: {e}")

    return 0

async def _check_volume_profile_support(self, symbol: str, side: str) -> int:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Volume Profile (—Ü–µ–Ω–∞ –≤ –∑–æ–Ω–µ –≤—ã—Å–æ–∫–æ–≥–æ –æ–±—ä–µ–º–∞ = –ø–æ–¥–¥–µ—Ä–∂–∫–∞)"""
    try:
        current_price = await self.data_registry.get_price(symbol)
        if not current_price:
            return 0

        vp = await self._get_volume_profile(symbol)
        if not vp:
            return 0

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ü–µ–Ω–∞ –≤ Value Area
        if vp.is_in_value_area(current_price):
            return 1

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç POC (–µ—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ POC = –∑–æ–Ω–∞ –≤—ã—Å–æ–∫–æ–≥–æ –æ–±—ä–µ–º–∞)
        distance_pct = vp.get_distance_from_poc(current_price)
        if distance_pct < 0.005:  # –í –ø—Ä–µ–¥–µ–ª–∞—Ö 0.5% –æ—Ç POC
            return 1

    except Exception as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Volume Profile –¥–ª—è {symbol}: {e}")

    return 0

async def _check_pivot_support(self, symbol: str, side: str) -> int:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Pivot Levels (—Ü–µ–Ω–∞ –±–ª–∏–∑–∫–æ –∫ —É—Ä–æ–≤–Ω—é –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è)"""
    try:
        current_price = await self.data_registry.get_price(symbol)
        if not current_price:
            return 0

        pivots = await self._get_pivot_levels(symbol, "1h")
        if not pivots:
            return 0

        atr = await self._get_atr(symbol)
        if not atr:
            return 0

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —É—Ä–æ–≤–Ω–µ–π (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 0.3 * ATR)
        tolerance = atr * 0.3

        if side == "long":
            # –î–ª—è –ª–æ–Ω–≥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É (S1, S2, S3)
            for level_name, level_value in [
                ("S1", pivots.support_1),
                ("S2", pivots.support_2),
                ("S3", pivots.support_3),
            ]:
                if abs(current_price - level_value) < tolerance:
                    return 1
        else:  # short
            # –î–ª—è —à–æ—Ä—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ (R1, R2, R3)
            for level_name, level_value in [
                ("R1", pivots.resistance_1),
                ("R2", pivots.resistance_2),
                ("R3", pivots.resistance_3),
            ]:
                if abs(current_price - level_value) < tolerance:
                    return 1

    except Exception as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Pivot Levels –¥–ª—è {symbol}: {e}")

    return 0
```

### 3.8. –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 2260-2311)

```python
# ==================== –£–ú–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: –û–°–ù–û–í–ù–û–ô –ú–ï–¢–û–î ====================

async def _should_force_close_by_smart_analysis(
    self,
    symbol: str,
    position_side: str,
    pnl_pct: float,
    sl_pct: float,
) -> bool:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —É–±—ã—Ç–æ—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é.

    –£—Å–ª–æ–≤–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è:
    - —É–±—ã—Ç–æ–∫ —É–∂–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π (>= 1.5 * SL)
    - –Ω–∏ –æ–¥–∏–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –Ω–∞—à—É –ø–æ–ª—å–∑—É
    - —Ç—Ä–µ–Ω–¥ —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    tasks = [
        self._check_reversal_signals_score(symbol, position_side),  # Order Flow + MTF
        self._check_funding_bias(symbol, position_side),  # —Ñ–∞–Ω–¥–∏–Ω–≥
        self._check_correlation_bias(symbol, position_side),  # –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è
        self._check_liquidity_sweep(symbol, position_side),  # –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å
        self._check_reversal_candles(symbol, position_side),  # —Å–≤–µ—á–∏
        self._check_volume_profile_support(symbol, position_side),  # VP
        self._check_pivot_support(symbol, position_side),  # –ø–∏–≤–æ—Ç—ã
    ]

    results = await asyncio.gather(*tasks, return_exceptions=True)

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    scores = []
    for i, result in enumerate(results):
        if isinstance(result, Exception):
            logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ {i}: {result}")
            scores.append(0)
        else:
            scores.append(result)

    reversal_score = sum(scores)  # 0-7 (—á–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–∫–∞—Ç–∞)

    # –°–∏–ª–∞ —Ç—Ä–µ–Ω–¥–∞ –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å
    trend_data = await self._analyze_trend_strength(symbol)
    trend_against = 0.0
    if trend_data:
        ts = trend_data.get("trend_strength", 0.0)
        direction = trend_data.get("trend_direction", "neutral")
        if (position_side == "long" and direction == "bearish") or (
            position_side == "short" and direction == "bullish"
        ):
            trend_against = ts

    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ:
    # 1. –Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ (score ‚â§ 2)
    # 2. —Ç—Ä–µ–Ω–¥ –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è (‚â• 0.7)
    should_close = reversal_score <= 2 and trend_against >= 0.7

    logger.info(
        f"üß† Smart Close Analysis {symbol} ({position_side}): "
        f"reversal_score={reversal_score}/7, trend_against={trend_against:.2f}, "
        f"should_close={should_close}, pnl={pnl_pct:.2f}%"
    )

    return should_close
```

---

## ‚úÖ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å:
- ‚úÖ ATR –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ `candle_patterns.py` (—Å—Ç—Ä–æ–∫–∏ 85-91, 172-178)
- ‚úÖ ATR –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è tolerance –≤ `_check_pivot_support` (—Å—Ç—Ä–æ–∫–∞ 2234: `tolerance = atr * 0.3`)
- ‚úÖ –ü–æ—Ä–æ–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏, –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞

### –õ–æ–≥–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è:
- ‚úÖ –£—Å–ª–æ–≤–∏–µ: `pnl_percent <= -sl_percent * 1.5` (—É–±—ã—Ç–æ–∫ >= 1.5 * SL)
- ‚úÖ –£—Å–ª–æ–≤–∏–µ: `reversal_score <= 2` (–Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–∫–∞—Ç–∞)
- ‚úÖ –£—Å–ª–æ–≤–∏–µ: `trend_against >= 0.7` (—Ç—Ä–µ–Ω–¥ –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥ `max_holding_exceeded_but_loss`)
- ‚úÖ –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `return_exceptions=True`
- ‚úÖ Fallback –Ω–∞ `None` –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ `asyncio.gather(*tasks, return_exceptions=True)` - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ü–∏–∫–ª

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –≤ `_should_force_close_by_smart_analysis`
- ‚úÖ Debug –ª–æ–≥–∏ –≤ –∫–∞–∂–¥–æ–º –º–µ—Ç–æ–¥–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### TODO/Fallback:
- ‚úÖ `_get_correlation()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (–Ω–µ —Å–ª–æ–º–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
- ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç `None` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ!** üöÄ



