# üî¨ –ü–û–õ–ù–´–ô –ê–£–î–ò–¢ –ú–ê–¢–ï–ú–ê–¢–ò–ö–ò –ò –†–ê–°–ß–ï–¢–û–í - –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢

**–î–∞—Ç–∞:** 2025-12-07  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω

---

## ‚úÖ –ß–¢–û –ü–†–û–í–ï–†–ï–ù–û

### 1. **PnL –†–∞—Å—á–µ—Ç—ã (LONG/SHORT)** ‚úÖ

#### LONG PnL
**–§–æ—Ä–º—É–ª–∞:** `gross_pnl = (exit_price - entry_price) * size_in_coins`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `pnl_calculator.py:121` - –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ `position_manager.py:3697` - –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ `position_manager.py:4121` - –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ `position_manager.py:4345` - –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ `position_manager.py:4894` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_long_pnl_profit, test_long_pnl_loss, test_long_pnl_with_commission)

#### SHORT PnL
**–§–æ—Ä–º—É–ª–∞:** `gross_pnl = (entry_price - exit_price) * size_in_coins`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `pnl_calculator.py:123` - –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ `position_manager.py:3699` - –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ `position_manager.py:4123` - –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ `position_manager.py:4347` - –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ `position_manager.py:4896` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_short_pnl_profit, test_short_pnl_loss, test_short_pnl_with_commission)

---

### 2. **TP/SL –†–∞—Å—á–µ—Ç—ã (LONG/SHORT)** ‚úÖ

#### LONG TP
**–§–æ—Ä–º—É–ª–∞:** `tp_price = entry_price + tp_distance`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `order_executor.py:1559` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_long_tp)

#### LONG SL
**–§–æ—Ä–º—É–ª–∞:** `sl_price = entry_price - sl_distance`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `order_executor.py:1560` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_long_sl)

#### SHORT TP
**–§–æ—Ä–º—É–ª–∞:** `tp_price = entry_price - tp_distance`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `order_executor.py:1562` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_short_tp)

#### SHORT SL
**–§–æ—Ä–º—É–ª–∞:** `sl_price = entry_price + sl_distance`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `order_executor.py:1563` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_short_sl)

---

### 3. **Trailing Stop Loss** ‚úÖ

#### LONG Trailing Stop
**–§–æ—Ä–º—É–ª–∞:** `stop_loss = highest_price * (1 - trail_percent)`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `trailing_stop_loss.py:359` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_long_trailing_stop)

#### SHORT Trailing Stop
**–§–æ—Ä–º—É–ª–∞:** `stop_loss = lowest_price * (1 + trail_percent)`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `trailing_stop_loss.py:373` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_short_trailing_stop)

---

### 4. **–†–∞—Å—á–µ—Ç—ã –†–∞–∑–º–µ—Ä–∞ –ü–æ–∑–∏—Ü–∏–π** ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `position_sizer.py` - –ü–†–ê–í–ò–õ–¨–ù–û (–Ω–µ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å, –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞)
- ‚úÖ `risk_manager.py` - –ü–†–ê–í–ò–õ–¨–ù–û (–Ω–µ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å, –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞)

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_position_size_calculation, test_position_size_with_leverage)

---

### 5. **–†–∞—Å—á–µ—Ç—ã –ú–∞—Ä–∂–∏** ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `margin_calculator.py` - –ü–†–ê–í–ò–õ–¨–ù–û (–Ω–µ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å)

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_margin_calculation)

---

### 6. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã** ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –†–µ–∂–∏–º—ã: trending, ranging, choppy - –≤—Å–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥–µ
- ‚úÖ –°–∏–º–≤–æ–ª—ã: BTC-USDT, ETH-USDT, SOL-USDT - –≤—Å–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥–µ
- ‚úÖ Balance profiles: micro, small, medium, large - –≤—Å–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥–µ

---

### 7. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è side, position_side, posSide** ‚úÖ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ `exit_analyzer.py:908` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è position_side
- ‚úÖ `orchestrator.py:1349` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è position_side
- ‚úÖ `orchestrator.py:1669` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è position_side
- ‚úÖ `position_manager.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è posSide –≤ 16 –º–µ—Å—Ç–∞—Ö
- ‚úÖ `smart_exit_coordinator.py:126` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è side
- ‚úÖ `funding_rate_monitor.py:87` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è side
- ‚úÖ `micro_pivot_calculator.py:151` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è side

**–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Å—Ç–∞ (–Ω–µ —Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
- ‚úÖ `trailing_stop_loss.py` - side –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ initialize_trailing_stop (—Å—Ç—Ä–æ–∫–∞ 337)

---

### 8. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –ú–æ–Ω–µ—Ç—ã** ‚úÖ

**–§–æ—Ä–º—É–ª–∞:** `size_in_coins = size_in_contracts * ctVal`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `position_manager.py:3677` - –ü–†–ê–í–ò–õ–¨–ù–û

**Unit-—Ç–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ –ø—Ä–æ—à–ª–∏ (test_contracts_to_coins)

---

### 9. **–†–∞—Å—á–µ—Ç –ö–æ–º–∏—Å—Å–∏–π** ‚úÖ

**–§–æ—Ä–º—É–ª–∞:**
- `commission_entry = notional_entry * commission_rate`
- `commission_exit = notional_exit * commission_rate`
- `total_commission = commission_entry + commission_exit`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `position_manager.py:3691-3693` - –ü–†–ê–í–ò–õ–¨–ù–û

---

### 10. **Net PnL —Å —É—á–µ—Ç–æ–º Funding Fee** ‚úÖ

**–§–æ—Ä–º—É–ª–∞:** `net_pnl = gross_pnl - commission - funding_fee`

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:**
- ‚úÖ `position_manager.py:3721` - –ü–†–ê–í–ò–õ–¨–ù–û

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:
- ‚úÖ **20 unit-—Ç–µ—Å—Ç–æ–≤** - –≤—Å–µ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
- ‚úÖ **52 –º–µ—Å—Ç–∞** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LONG PnL —Ñ–æ—Ä–º—É–ª—ã
- ‚úÖ **43 –º–µ—Å—Ç–∞** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SHORT PnL —Ñ–æ—Ä–º—É–ª—ã
- ‚úÖ **16 –º–µ—Å—Ç** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ posSide
- ‚úÖ **7 –º–µ—Å—Ç** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ side/position_side

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- ‚úÖ **23 –º–µ—Å—Ç–∞** —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π side/position_side/posSide
- ‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã** –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ

---

## üéØ –ò–¢–û–ì–û–í–´–ô –í–´–í–û–î

### ‚úÖ –í–°–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ê–°–ß–ï–¢–´ –ü–†–ê–í–ò–õ–¨–ù–´–ï:

1. ‚úÖ **PnL –¥–ª—è LONG –∏ SHORT** - –≤—Å–µ —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã unit-—Ç–µ—Å—Ç–∞–º–∏
2. ‚úÖ **TP/SL –¥–ª—è LONG –∏ SHORT** - –≤—Å–µ —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã unit-—Ç–µ—Å—Ç–∞–º–∏
3. ‚úÖ **Trailing Stop Loss** - –≤—Å–µ —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã unit-—Ç–µ—Å—Ç–∞–º–∏
4. ‚úÖ **–†–∞—Å—á–µ—Ç—ã —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–π** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, –Ω–µ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
5. ‚úÖ **–†–∞—Å—á–µ—Ç—ã –º–∞—Ä–∂–∏** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, –Ω–µ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
6. ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** - –≤—Å–µ —Ä–µ–∂–∏–º—ã –∏ —Å–∏–º–≤–æ–ª—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
7. ‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è side** - –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Å—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
8. ‚úÖ **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
9. ‚úÖ **–†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
10. ‚úÖ **Net PnL —Å funding fee** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

---

## üìÑ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´

1. ‚úÖ `test_math_formulas.py` - 20 unit-—Ç–µ—Å—Ç–æ–≤ (–≤—Å–µ –ø—Ä–æ—à–ª–∏)
2. ‚úÖ `check_side_usage.py` - —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è side
3. ‚úÖ `MATH_AUDIT_SYSTEMATIC.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç —Ñ–æ—Ä–º—É–ª
4. ‚úÖ `MATH_AUDIT_DETAILED.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
5. ‚úÖ `FIXES_SIDE_NORMALIZATION.md` - –æ—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö
6. ‚úÖ `FULL_MATH_AUDIT_REPORT.md` - –ø–æ–ª–Ω—ã–π –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. ‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã** - PnL, TP/SL, Trailing Stop, —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–π, –º–∞—Ä–∂–∞
2. ‚úÖ **–í—Å–µ –∑–Ω–∞–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ** - LONG: (exit - entry), SHORT: (entry - exit)
3. ‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è side –ø—Ä–∏–º–µ–Ω–µ–Ω–∞** - –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Å—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
4. ‚úÖ **Unit-—Ç–µ—Å—Ç—ã —Å–æ–∑–¥–∞–Ω—ã** - –≤—Å–µ —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üéØ –ì–ê–†–ê–ù–¢–ò–ò

‚úÖ **–í—Å–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ**  
‚úÖ **–í—Å–µ –∑–Ω–∞–∫–∏ –≤ —Ñ–æ—Ä–º—É–ª–∞—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ**  
‚úÖ **–í—Å–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç**  
‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Å—Ç–∞ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π side –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**  
‚úÖ **–í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ**

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-07  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

