# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏

**–î–∞—Ç–∞:** 07.01.2026  
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏, race conditions, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### 1. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

```
OKX Exchange (WebSocket)
        ‚Üì
wss://ws.okx.com:8443/ws/v5/public
        ‚Üì
FuturesWebSocketManager (ws_manager)
        ‚Üì
WebSocketCoordinator.handle_ticker_data()
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  1. _update_candle_from_ticker ‚îÇ ‚Üí CandleBuffer (1m/5m/1H/1D)
    ‚îÇ  2. data_registry.update_market_data ‚îÇ ‚Üí Market Data (price, volume)
    ‚îÇ  3. fast_adx.update()          ‚îÇ ‚Üí FastADX (ADX, +DI, -DI)
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
DataRegistry (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
        ‚Üì
SignalGenerator.generate_signals()
        ‚Üì
OrderExecutor._calculate_limit_price()
```

### 2. –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 2.1. WebSocketCoordinator

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/websocket_coordinator.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- `handle_ticker_data()`: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–∫–µ—Ä–æ–≤ –∏–∑ WebSocket
- `_update_candle_from_ticker()`: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–µ—á–µ–π
- `_update_candle_for_timeframe()`: –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤–µ—á–µ–π

**–î—Ä–æ—Å—Å–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
self._ticker_throttle = 5  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–π 5-–π —Ç–∏–∫–µ—Ä
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- `self.signal_generator.is_initialized` - –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- `self.orchestrator.all_modules_ready` - –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π

#### 2.2. DataRegistry

**–§–∞–π–ª:** `src/strategies/scalping/futures/core/data_registry.py`

**–•—Ä–∞–Ω–∏–ª–∏—â–∞:**
- `_market_data: Dict[symbol, Dict]` - —Ü–µ–Ω—ã, –æ–±—ä–µ–º—ã, ticker
- `_indicators: Dict[symbol, Dict]` - ADX, MA, RSI, etc.
- `_regimes: Dict[symbol, Dict]` - —Ä–µ–∂–∏–º (trending/ranging/choppy) + params
- `_candle_buffers: Dict[symbol, Dict[timeframe, CandleBuffer]]` - —Å–≤–µ—á–∏ 1m/5m/1H/1D

**Thread-safety:** `asyncio.Lock` –Ω–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**TTL –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤:** ADX —Å—Ç–∞—Ä—à–µ 1 —Å–µ–∫—É–Ω–¥—ã —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º (`get_indicators(check_freshness=True)`)

#### 2.3. CandleBuffer

**–§–∞–π–ª:** `src/strategies/scalping/futures/core/candle_buffer.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- `add_candle()`: FIFO (max_size=200 —Å–≤–µ—á–µ–π)
- `update_last_candle()`: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∏—Ä—É—é—â–µ–π—Å—è —Å–≤–µ—á–∏ (high/low/close/volume)
- `get_candles()`: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ø–∏–∏ —Å–ø–∏—Å–∫–∞ —Å–≤–µ—á–µ–π

**Thread-safety:** `asyncio.Lock`

#### 2.4. SignalGenerator

**–§–∞–π–ª:** `src/strategies/scalping/futures/signal_generator.py`

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `generate_signals()`: –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- `_get_market_data()`: **–ö–†–ò–¢–ò–ß–ù–û** - Fallback –Ω–∞ REST API –µ—Å–ª–∏ —Å–≤–µ—á–µ–π –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
candles_1m = await self.data_registry.get_candles(symbol, "1m")
if not candles_1m or len(candles_1m) < 50:
    # ‚ö†Ô∏è FALLBACK –Ω–∞ REST API - –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏!
    url = f"https://www.okx.com/api/v5/market/candles?instId={inst_id}&bar=1m&limit=500"
```

## üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #1: Fallback –Ω–∞ REST API –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏

**–ö–æ–¥:** `signal_generator.py:1887`

```python
# –ï—Å–ª–∏ –≤ DataRegistry –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–µ—á–µ–π, –±–æ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ REST API
url = f"https://www.okx.com/api/v5/market/candles?instId={inst_id}&bar=1m&limit=500"
async with aiohttp.ClientSession() as session:
    async with session.get(url) as resp:
        data = await resp.json()
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- REST API –∑–∞–ø—Ä–æ—Å –∑–∞–Ω–∏–º–∞–µ—Ç **100-300ms**
- –ü—Ä–∏ –ø–µ—Ä–≤—ã—Ö 30-50 —Ü–∏–∫–ª–∞—Ö –±–æ—Ç **–í–°–ï–ì–î–ê** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç REST API (–±—É—Ñ–µ—Ä –ø—É—Å—Ç–æ–π)
- –í –ª–æ–≥–∞—Ö `7 Jan 09:28` - –ø–µ—Ä–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 200-300ms

**–†–µ—à–µ–Ω–∏–µ:**
1. **–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞** —Å–≤–µ—á–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (`initialize_candles()`)
2. **–£–≤–µ–ª–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É** –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞ (—Å–µ–π—á–∞—Å –∫–∞–∂–¥—ã–π 5-–π —Ç–∏–∫–µ—Ä)
3. **–£–º–µ–Ω—å—à–∏—Ç—å –º–∏–Ω–∏–º—É–º** —Å–≤–µ—á–µ–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (50 ‚Üí 30)

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #2: –î—Ä–æ—Å—Å–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ä–æ–≤ (1/5)

**–ö–æ–¥:** `websocket_coordinator.py:153`

```python
self._ticker_throttle = 5  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–π 5-–π —Ç–∏–∫–µ—Ä
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ë–æ—Ç –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç **80% —Ç–∏–∫–µ—Ä–æ–≤** (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ 1/5)
- –ü—Ä–∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –Ω–∞ **0.3-0.5%** –º–µ–∂–¥—É –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ —Ç–∏–∫–µ—Ä–∞–º–∏
- SL 1.5% –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–∏—Ç **–î–û** —Ç–æ–≥–æ –∫–∞–∫ –±–æ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∏–∫–µ—Ä

**–ü—Ä–∏–º–µ—Ä:**
```
–¢–∏–∫–µ—Ä #1: $94,500 (–æ–±—Ä–∞–±–æ—Ç–∞–Ω)
–¢–∏–∫–µ—Ä #2: $94,600 (–ø—Ä–æ–ø—É—â–µ–Ω) ‚Üê –¶–ï–ù–ê –†–ê–°–¢–ï–¢
–¢–∏–∫–µ—Ä #3: $94,700 (–ø—Ä–æ–ø—É—â–µ–Ω) ‚Üê –¶–ï–ù–ê –†–ê–°–¢–ï–¢
–¢–∏–∫–µ—Ä #4: $94,800 (–ø—Ä–æ–ø—É—â–µ–Ω) ‚Üê –¶–ï–ù–ê –†–ê–°–¢–ï–¢
–¢–∏–∫–µ—Ä #5: $94,900 (–æ–±—Ä–∞–±–æ—Ç–∞–Ω) ‚Üê –ó–ê–ü–û–ó–î–ê–õ–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ—Ä–æ—Ç–∫–∞—è SHORT –ø–æ–∑–∏—Ü–∏—è (entry $94,500) –ø—Ä–æ–±–∏–≤–∞–µ—Ç SL —Ä–∞–Ω—å—à–µ, —á–µ–º –±–æ—Ç –≤–∏–¥–∏—Ç —Ü–µ–Ω—É $94,700

**–†–µ—à–µ–Ω–∏–µ:**
1. **–°–Ω–∏–∑–∏—Ç—å throttle** –¥–æ `1/2` (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –≤—Ç–æ—Ä–æ–π —Ç–∏–∫–µ—Ä)
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π throttle** –ø–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (–Ω–∏–∑–∫–∞—è ‚Üí 1/5, –≤—ã—Å–æ–∫–∞—è ‚Üí 1/1)
3. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ë–ï–ó throttle (–æ—Ç–∫—Ä—ã—Ç—ã–µ SHORT –≤ UP-trending)

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #3: Race condition –º–µ–∂–¥—É —Å–≤–µ—á–∞–º–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏

**–ö–æ–¥:** `websocket_coordinator.py:275-290`

```python
# 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–µ—á–∏
await self._update_candle_from_ticker(symbol, price, ticker)

# 2. –û–±–Ω–æ–≤–ª—è–µ–º DataRegistry (market_data)
await self.data_registry.update_market_data(symbol, {...})

# 3. –û–±–Ω–æ–≤–ª—è–µ–º FastADX
fast_adx_for_symbol.update(high=price, low=price, close=price)
await self.data_registry.update_indicators(symbol, {"adx": adx_value})
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–µ–∂–¥—É —à–∞–≥–∞–º–∏ 1-2-3 –ø—Ä–æ—Ö–æ–¥–∏—Ç **20-50ms**
- `SignalGenerator.generate_signals()` –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å—Å—è **–ú–ï–ñ–î–£** —à–∞–≥–∞–º–∏
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ **—Å—Ç–∞—Ä—ã—Ö —Å–≤–µ—á–∞—Ö**, —Ü–µ–Ω–∞ –Ω–∞ **–Ω–æ–≤–æ–π**

**–ü—Ä–∏–º–µ—Ä:**
```
T0: –¢–∏–∫–µ—Ä price=94500, —Å–≤–µ—á–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚Üí [94450, 94480, 94500]
T1: ADX –µ—â–µ –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω (—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 25.3)
T2: SignalGenerator –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí –±–µ—Ä–µ—Ç ADX=25.3 (–°–¢–ê–†–´–ô) + price=94500 (–ù–û–í–´–ô)
T3: ADX –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω ‚Üí 27.8 (—É–∂–µ –ø–æ–∑–¥–Ω–æ, —Å–∏–≥–Ω–∞–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω)
```

**–†–µ—à–µ–Ω–∏–µ:**
1. **–ê—Ç–æ–º–∞—Ä–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** –≤—Å–µ—Ö 3 —à–∞–≥–æ–≤ —á–µ—Ä–µ–∑ `asyncio.Lock`
2. **Timestamp validation** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å `updated_at` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
3. **Recalculate on mismatch** - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –µ—Å–ª–∏ timestamp –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #4: MTF –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–≤–µ—á–∏ 5m

**–ö–æ–¥:** `signal_generator.py:1443`

```python
candles_1m = await self.data_registry.get_candles(symbol, "1m")
```

**MTF —Ñ–∏–ª—å—Ç—Ä** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `5m` —Å–≤–µ—á–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –ù–û:
- 5m —Å–≤–µ—á–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **—Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç**
- –¢—Ä–µ–Ω–¥ –Ω–∞ 5m –º–æ–∂–µ—Ç –±—ã—Ç—å **DOWN**, –∞ –Ω–∞ 1m —É–∂–µ **UP**

**–ü—Ä–∏–º–µ—Ä (7 Jan 09:28):**
```
09:28:00 - 5m —Å–≤–µ—á–∞ #1: 91.8k ‚Üí 91.9k (DOWN trend)
09:29:00 - 1m —Å–≤–µ—á–∞: 91.9k ‚Üí 92.1k (UP move, –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç)
09:30:00 - SignalGenerator: MTF –≤–∏–¥–∏—Ç 5m=DOWN ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ—Ç SHORT
09:31:00 - –¶–µ–Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞—Å—Ç–∏ 92.1k ‚Üí 92.3k ‚Üí SL SHORT
```

**–†–µ—à–µ–Ω–∏–µ:**
1. **–£–º–µ–Ω—å—à–∏—Ç—å MTF timeframe** 5m ‚Üí 3m (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 1m —Å –±–æ–ª—å—à–∏–º SMA)
2. **Weighted confirmation** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏ 5m –∏ 1m (–≤–µ—Å 60%/40%)
3. **MTF block_neutral=true** - –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å NEUTRAL —Ç—Ä–µ–Ω–¥ (—É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ)

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #5: Order Executor –∏—Å–ø–æ–ª—å–∑—É–µ—Ç signal_price –≤–º–µ—Å—Ç–æ current_price

**–ö–æ–¥:** `order_executor.py:319` (–ò–°–ü–†–ê–í–õ–ï–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞ (–±—ã–ª–∞ –¥–æ —Ñ–∏–∫—Å–∞):**
```python
# –ë–´–õ–û:
limit_price = signal_price * (1 + offset)

# –°–¢–ê–õ–û:
current_price = await self.data_registry.get_price(symbol)
limit_price = current_price * (1 + offset)
```

**–ù–æ –æ—Å—Ç–∞–ª—Å—è —Ä–∏—Å–∫:**
- `get_price()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `market_data.get("price")`
- –ï—Å–ª–∏ `update_market_data()` –∑–∞–ø–∞–∑–¥—ã–≤–∞–µ—Ç ‚Üí `get_price()` –≤–µ—Ä–Ω–µ—Ç **—Å—Ç–∞—Ä—É—é** —Ü–µ–Ω—É
- Limit order –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ **—É—Å—Ç–∞—Ä–µ–≤—à–µ–π** —Ü–µ–Ω–µ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏:**
```python
market_data = await self.data_registry.get_market_data(symbol, check_freshness=True)
updated_at = market_data.get("updated_at")
if (datetime.now() - updated_at).total_seconds() > 0.5:
    # –¶–ï–ù–ê –°–¢–ê–†–®–ï 500ms - –ö–†–ò–¢–ò–ß–ù–û!
```

**–†–µ—à–µ–Ω–∏–µ:**
1. **TTL –¥–ª—è price** - 500ms –º–∞–∫—Å–∏–º—É–º
2. **Fallback –Ω–∞ API** –µ—Å–ª–∏ —Ü–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è
3. **Reject order** –µ—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–∫—Ä–∏—Ç–∏—á–Ω–æ): Race conditions

```python
# websocket_coordinator.py:_update_candle_from_ticker()

async def _update_candle_from_ticker(self, symbol: str, price: float, ticker: Dict[str, Any]):
    """–ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–µ—á–µ–π + market_data + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤"""
    
    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê - –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω—ã
    async with self._update_lock:  # –ù–æ–≤—ã–π lock –¥–ª—è –≤—Å–µ–≥–æ —Ü–∏–∫–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        # 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–µ—á–∏
        await self._update_candles_internal(symbol, price, ticker)
        
        # 2. –û–±–Ω–æ–≤–ª—è–µ–º market_data
        await self.data_registry.update_market_data(symbol, {...})
        
        # 3. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        await self._update_indicators_internal(symbol, price)
        
        # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º timestamp
        await self.data_registry.set_data_timestamp(symbol, datetime.now())
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –î—Ä–æ—Å—Å–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# websocket_coordinator.py:__init__()

# ‚úÖ –ê–î–ê–ü–¢–ò–í–ù–û–ï –î–†–û–°–°–ï–õ–ò–†–û–í–ê–ù–ò–ï –ø–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
self._ticker_throttle_config = {
    "low_volatility": 5,      # <0.1% –∑–∞ 1m ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 1/5
    "medium_volatility": 2,   # 0.1-0.3% ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 1/2
    "high_volatility": 1,     # >0.3% ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ
}

# ‚úÖ BYPASS –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
async def _should_process_ticker(self, symbol: str) -> bool:
    # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ö–ê–ñ–î–´–ô —Ç–∏–∫–µ—Ä
    if symbol in self.active_positions_ref:
        return True
    
    # –ò–Ω–∞—á–µ - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π throttle
    volatility = await self._calculate_volatility(symbol)
    throttle = self._get_throttle_by_volatility(volatility)
    return self._ticker_counter[symbol] % throttle == 0
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Fallback –Ω–∞ REST API

```python
# signal_generator.py:_get_market_data()

async def _get_market_data(self, symbol: str) -> Optional[MarketData]:
    # ‚úÖ –°–ù–ê–ß–ê–õ–ê DataRegistry
    candles_1m = await self.data_registry.get_candles(symbol, "1m")
    
    # ‚úÖ –°–ù–ò–ñ–ê–ï–ú –ú–ò–ù–ò–ú–£–ú 50 ‚Üí 30 (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞)
    if candles_1m and len(candles_1m) >= 30:  # –ë—ã–ª–æ 50
        return self._build_market_data(candles_1m)
    
    # ‚úÖ FALLBACK –Ω–∞ REST API —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—É—Ñ–µ—Ä –ü–£–°–¢–û–ô
    if not candles_1m or len(candles_1m) < 10:
        logger.warning(f"‚ö†Ô∏è –ë—É—Ñ–µ—Ä –ø—É—Å—Ç –¥–ª—è {symbol}, fallback –Ω–∞ REST API")
        return await self._fetch_candles_from_api(symbol)
    
    # ‚úÖ –ò–ù–ê–ß–ï - –∂–¥–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    logger.debug(f"‚è≥ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–µ—á–µ–π –¥–ª—è {symbol}: {len(candles_1m)}/30, –∂–¥–µ–º...")
    return None
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: Timestamp validation

```python
# order_executor.py:_calculate_limit_price()

async def _calculate_limit_price(self, symbol: str, side: str, ...):
    # ‚úÖ –ü–†–û–í–ï–†–ö–ê –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò –¶–ï–ù–´
    market_data = await self.data_registry.get_market_data(symbol)
    updated_at = market_data.get("updated_at")
    
    if not updated_at or (datetime.now() - updated_at).total_seconds() > 0.5:
        logger.error(f"‚ùå –¶–µ–Ω–∞ –¥–ª—è {symbol} —É—Å—Ç–∞—Ä–µ–ª–∞ (>{500}ms), –æ—Ç–∫–ª–æ–Ω—è–µ–º –æ—Ä–¥–µ—Ä")
        raise ValueError(f"Stale price for {symbol}")
    
    current_price = market_data.get("price")
    # ... —Ä–∞—Å—á–µ—Ç limit_price
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ü—Ä–æ–±–ª–µ–º–∞ | –°–µ–π—á–∞—Å | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –≠—Ñ—Ñ–µ–∫—Ç |
|----------|--------|-------------------|--------|
| REST API fallback | 100-300ms –∑–∞–¥–µ—Ä–∂–∫–∞ | <10ms (—Ç–æ–ª—å–∫–æ DataRegistry) | ‚¨áÔ∏è –õ–∞–≥ –≤ 10-30x |
| –î—Ä–æ—Å—Å–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ 1/5 | –ü—Ä–æ–ø—É—â–µ–Ω–æ 80% —Ç–∏–∫–µ—Ä–æ–≤ | –ê–¥–∞–ø—Ç–∏–≤–Ω–æ (50-100%) | ‚¨ÜÔ∏è –†–µ–∞–∫—Ü–∏—è –≤ 2-4x |
| Race condition | 20-50ms –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ | <1ms (–∞—Ç–æ–º–∞—Ä–Ω–æ) | ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å |
| –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ 5m —Å–≤–µ—á–∏ | 5-–º–∏–Ω—É—Ç–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ MTF | <1s –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å | ‚¨ÜÔ∏è –¢–æ—á–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞ |
| Stale price –≤ orders | –†–∏—Å–∫ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ —Å—Ç–∞—Ä–æ–π —Ü–µ–Ω–µ | TTL 500ms | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å |

---

## üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥

**–ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –í—Å–µ 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (—Å–≤–µ—á–∏, market_data, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã) –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**, –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. 

**SignalGenerator** –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å:
- –°–≤–µ–∂—É—é —Ü–µ–Ω—É (1ms)
- –£—Å—Ç–∞—Ä–µ–≤—à–∏–π ADX (500ms)
- –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–≤–µ—á–∏ 5m (–¥–æ 5 –º–∏–Ω—É—Ç!)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏–≥–Ω–∞–ª –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ **–Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí SL.

**–†–µ—à–µ–Ω–∏–µ:** –ê—Ç–æ–º–∞—Ä–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ–≥–æ —Ü–∏–∫–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è + timestamp validation –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.
