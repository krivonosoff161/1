# üîç –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (2025-12-23)

## üìã –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∞–Ω–∞–ª–∏–∑

---

## 1Ô∏è‚É£ trading_control_center.py (—Å—Ç—Ä–æ–∫–∞ ~258: run_main_loop)

### –ö–æ–¥:
```python
# src/strategies/scalping/futures/core/trading_control_center.py

# –°—Ç—Ä–æ–∫–∏ 15-20: –ò–º–ø–æ—Ä—Ç—ã
import asyncio
import os
import time
from datetime import datetime as dt  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ dt (–Ω–µ datetime)
from datetime import timezone
from typing import Any, Dict, Optional

# –°—Ç—Ä–æ–∫–∏ 250-265: run_main_loop - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
async def run_main_loop(self):
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª"""
    while self.is_running:
        try:
            # ... –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ...
            await asyncio.sleep(self.scalping_config.check_interval)
        
        except asyncio.CancelledError:
            logger.info("üõë TCC: –¢–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª –æ—Ç–º–µ–Ω–µ–Ω")
            break
        except Exception as e:
            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–ª–Ω—ã–º traceback
            logger.error(
                f"‚ùå TCC: –û—à–∏–±–∫–∞ –≤ —Ç–æ—Ä–≥–æ–≤–æ–º —Ü–∏–∫–ª–µ: {e}",
                exc_info=True,  # –ü–æ–ª–Ω—ã–π traceback –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            )
            if self.is_running:
                await asyncio.sleep(5)  # –ü–∞—É–∑–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            else:
                break
```

**‚úÖ –°—Ç–∞—Ç—É—Å:** –í —ç—Ç–æ–º —Ñ–∞–π–ª–µ –ù–ï–¢ –æ—à–∏–±–æ–∫ datetime - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `dt` –≤–º–µ—Å—Ç–æ `datetime`

---

## 2Ô∏è‚É£ position_manager.py (—Å—Ç—Ä–æ–∫–∞ ~5797: close_position_manually)

### –ü—Ä–æ–±–ª–µ–º–∞: "cannot access local variable 'datetime'"

**–ë–´–õ–û (—Å—Ç—Ä–æ–∫–∞ 5795):**
```python
if entry_time:
    from datetime import datetime, timezone  # ‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
    exit_time = datetime.now(timezone.utc)
```

**–°–¢–ê–õ–û (—Å—Ç—Ä–æ–∫–∞ 5798):**
```python
if entry_time:
    # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç datetime, –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–π
    exit_time = datetime.now(timezone.utc)
```

### –ü–æ–ª–Ω—ã–π –∫–æ–¥ –º–µ—Ç–æ–¥–∞:
```python
# src/strategies/scalping/futures/position_manager.py:5761-5808

async def close_position_manually(
    self, symbol: str, reason: str = "manual"
) -> Optional[TradeResult]:
    """‚úÖ –†–£–ß–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –ü–û–ó–ò–¶–ò–ò (–¥–ª—è TrailingSL)"""
    
    async with self._close_lock:
        try:
            # ... –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ...
            
            entry_time = None
            if position:
                if hasattr(position, "entry_time"):
                    entry_time = position.entry_time
                elif isinstance(position, dict):
                    entry_time = position.get("entry_time")
                elif hasattr(position, "metadata"):
                    metadata = position.metadata
                    if hasattr(metadata, "entry_time"):
                        entry_time = metadata.entry_time
            
            if entry_time:
                # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç datetime, –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–π
                exit_time = datetime.now(timezone.utc)
                if isinstance(entry_time, str):
                    entry_time = datetime.fromisoformat(entry_time.replace("Z", "+00:00"))
                if isinstance(entry_time, datetime):
                    if entry_time.tzinfo is None:
                        entry_time = entry_time.replace(tzinfo=timezone.utc)
                    duration_sec = (exit_time - entry_time).total_seconds()
                    if duration_sec < 30:  # –ú–∏–Ω–∏–º—É–º 30 —Å–µ–∫
                        logger.warning(f"‚ö†Ô∏è Too fast close: {symbol}, {duration_sec:.1f}s < 30s")
                        return None
```

**‚úÖ –°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û - —É–¥–∞–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç

---

## 3Ô∏è‚É£ position_manager.py (—Å—Ç—Ä–æ–∫–∞ ~1266: datetime.now() –±–µ–∑ timezone)

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ offset-naive –∏ offset-aware datetime

**–ë–´–õ–û (—Å—Ç—Ä–æ–∫–∞ 1266):**
```python
if isinstance(position_open_time, datetime):
    time_since_open = (
        datetime.now() - position_open_time  # ‚ùå –ë–µ–∑ timezone
    ).total_seconds()
```

**–°–¢–ê–õ–û:**
```python
if isinstance(position_open_time, datetime):
    # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º timezone.utc –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    if position_open_time.tzinfo is None:
        position_open_time = position_open_time.replace(tzinfo=timezone.utc)
    time_since_open = (
        datetime.now(timezone.utc) - position_open_time  # ‚úÖ –° timezone
    ).total_seconds()
```

**‚úÖ –°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û - –≤—Å–µ datetime.now() –∏—Å–ø–æ–ª—å–∑—É—é—Ç timezone.utc

---

## 4Ô∏è‚É£ orchestrator.py (—Å—Ç—Ä–æ–∫–∏ 405-419: ExitAnalyzer)

### –ü—Ä–æ–±–ª–µ–º–∞: ExitAnalyzer –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è

**–ë–´–õ–û:**
```python
self.exit_analyzer = ExitAnalyzer(...)
logger.info("‚úÖ ExitAnalyzer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ orchestrator")
# ‚ùå –ù–ï–¢ –≤—ã–∑–æ–≤–∞ set_exit_analyzer()!
```

**–°–¢–ê–õ–û:**
```python
self.exit_analyzer = ExitAnalyzer(
    position_registry=self.position_registry,
    data_registry=self.data_registry,
    exit_decision_logger=self.exit_decision_logger,
    orchestrator=self,
    config_manager=self.config_manager,
    signal_generator=self.signal_generator,
    signal_locks_ref=self.signal_locks,
)
logger.info("‚úÖ ExitAnalyzer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ orchestrator")

# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º ExitAnalyzer –≤ position_manager
if hasattr(self.position_manager, "set_exit_analyzer"):
    self.position_manager.set_exit_analyzer(self.exit_analyzer)
    logger.info("‚úÖ ExitAnalyzer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ FuturesPositionManager")
```

**‚úÖ –°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û - –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ set_exit_analyzer()

---

## 5Ô∏è‚É£ position_manager.py (—Å—Ç—Ä–æ–∫–∏ 116-119: set_exit_analyzer)

### –ù–æ–≤—ã–π –º–µ—Ç–æ–¥:

```python
def set_exit_analyzer(self, exit_analyzer):
    """‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ExitAnalyzer –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∑–∏—Ü–∏–π"""
    self.exit_analyzer = exit_analyzer
    logger.info("‚úÖ ExitAnalyzer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ FuturesPositionManager")
```

**‚úÖ –°—Ç–∞—Ç—É—Å:** –î–û–ë–ê–í–õ–ï–ù–û - –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ExitAnalyzer

---

## üìä –ê–Ω–∞–ª–∏–∑ PnL –ø–æ–∑–∏—Ü–∏–π

### –î–∞–Ω–Ω—ã–µ –∏–∑ trades_2025-12-23.csv:

**–í—Å–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π: 15**

#### ETH-USDT (10 –ø–æ–∑–∏—Ü–∏–π):
- –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞: ~2989 USD
- –†–∞–∑–º–µ—Ä: 0.082-0.083 ETH
- –í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è: 2025-12-22 21:18 - 2025-12-23 00:06

#### BTC-USDT (5 –ø–æ–∑–∏—Ü–∏–π):
- –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞: ~88200 USD
- –†–∞–∑–º–µ—Ä: 0.0027 BTC
- –í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è: 2025-12-22 21:35 - 2025-12-23 18:09

### ‚ö†Ô∏è –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ PnL –Ω—É–∂–Ω–æ:

1. **–¢–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã** (—á–µ—Ä–µ–∑ API OKX):
   - BTC-USDT-SWAP
   - ETH-USDT-SWAP

2. **–£—á–µ—Å—Ç—å:**
   - –ö–æ–º–∏—Å—Å–∏–∏ (0.05% –∑–∞ —Å–¥–µ–ª–∫—É)
   - Funding fees (–¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤)
   - –ú–∞—Ä–∂—É (PnL —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç –º–∞—Ä–∂–∏)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API OKX `GET /api/v5/account/positions` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è unrealized PnL

---

## ‚úÖ –ò—Ç–æ–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. ‚úÖ **–£–¥–∞–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç datetime** –≤ `close_position_manually()` (—Å—Ç—Ä–æ–∫–∞ 5798)
2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ 6 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `datetime.now()`** ‚Üí `datetime.now(timezone.utc)`
3. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è timezone** –¥–ª—è `position_open_time`
4. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `set_exit_analyzer()`** –≤ `FuturesPositionManager`
5. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `set_exit_analyzer()`** –≤ `orchestrator` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ExitAnalyzer

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "cannot access local variable 'datetime'"
- ‚úÖ –í—Å–µ datetime –æ–±—ä–µ–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç timezone.utc
- ‚úÖ ExitAnalyzer –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è
- ‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –Ω–∞—á–Ω—É—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞** —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ datetime
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π** —á–µ—Ä–µ–∑ ExitAnalyzer
4. **–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã** —á–µ—Ä–µ–∑ API –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL

---

**–î–∞—Ç–∞:** 2025-12-23  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é





