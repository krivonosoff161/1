# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–∫—Å–æ–≤ –ì—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è

## –î–∞—Ç–∞: 2025-12-21

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ –º–∏–Ω—É—Å –∏–∑-–∑–∞ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è: –ø–æ–∑–∏—Ü–∏–∏ –∏–¥—É—Ç –≤ –ø–ª—é—Å (peak ~0.5-1%), –Ω–æ –Ω–∞ –æ—Ç–∫–∞—Ç–µ/—à—É–º (0.2-0.5%) –±—å—é—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SL 0.8%, –∏ –Ω–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏—Ç —Ä–∞–Ω—å—à–µ.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–∫—Å—ã

### 1. ‚úÖ Dynamic SL/TP –ø–æ ATR (TOP PRIORITY)

#### SL: max(0.6%, 1.2*ATR_1m) –≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ 0.8%
- **–§–∞–π–ª**: `config/config_futures.yaml`
  - `sl_atr_multiplier`: 1.0 ‚Üí **1.2** (–¥–ª—è –º–µ–Ω—å—à–∏—Ö —à—É–º–æ–≤—ã—Ö —Ö–∏—Ç–æ–≤)
- **–§–∞–π–ª**: `src/strategies/scalping/futures/positions/exit_analyzer.py`
  - `_get_sl_percent`: –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ ATR-based SL —Å multiplier 1.2
  - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: "max(0.6%, 1.2*ATR_1m) –¥–ª—è –º–µ–Ω—å—à–∏—Ö —à—É–º–æ–≤—ã—Ö —Ö–∏—Ç–æ–≤"

#### TP: max(1.5%, 2.5*ATR_1m) –¥–ª—è ranging
- **–§–∞–π–ª**: `config/config_futures.yaml`
  - `tp_atr_based`: **true** (–≤–∫–ª—é—á–µ–Ω–æ)
  - `tp_atr_multiplier`: **2.5** (–¥–ª—è ranging)
  - `tp_min_percent`: 1.8 ‚Üí **1.5%** (–±—ã–ª–æ 1.8%)
- **–§–∞–π–ª**: `src/strategies/scalping/futures/positions/exit_analyzer.py`
  - `_get_tp_percent`: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ATR-based TP
  - –°–∏–≥–Ω–∞—Ç—É—Ä–∞: `_get_tp_percent(symbol, regime, current_price, market_data)`
  - –õ–æ–≥–∏–∫–∞: `max(1.5%, 2.5*ATR_1m)` –¥–ª—è ranging

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: SL —à–∏—Ä–µ –≤ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏, TP –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ. SL hits <60%, winrate +15%.

### 2. ‚úÖ Early Partial/PH —Å comm buffer

#### Partial TP: trigger 0.6% @40-50% (–±—ã–ª–æ 0.8%)
- **–§–∞–π–ª**: `config/config_futures.yaml`
  - `partial_tp.trigger_percent`: 0.8 ‚Üí **0.6%** (early partial)
  - `partial_tp.fraction`: 0.5 (50%)

#### PH: 0.8% margin + buffer 1.5x comm
- **–§–∞–π–ª**: `config/config_futures.yaml`
  - `ph_threshold_percent`: 1.2 ‚Üí **0.8%** (early PH)
  - `ph_comm_buffer_multiplier`: **1.5** (–Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä)
- **–§–∞–π–ª**: `src/strategies/scalping/futures/position_manager.py`
  - `_check_profit_harvesting`: –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç `comm_buffer = expected_comm * 1.5`
  - `ph_threshold_adjusted = max(ph_threshold_adjusted, ph_min_absolute_usd, comm_buffer)`

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: Partial –Ω–∞ 0.6-0.8% @40-50%, –¥–∞–∂–µ –µ—Å–ª–∏ gross small. PH —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–Ω—å—à–µ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è.

### 3. ‚úÖ TSL Aggressive –¥–ª—è strong signals

- **–§–∞–π–ª**: `src/strategies/scalping/futures/coordinators/trailing_sl_coordinator.py`
  - `initialize_trailing_stop`: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `signal_strength > 0.8`
  - –î–ª—è strong signals:
    - `initial_trail`: **0.4%** (–±—ã–ª–æ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
    - `loss_cut_percent`: **1.0%** (–±—ã–ª–æ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: `üöÄ TSL AGGRESSIVE –¥–ª—è {symbol}: strength={signal_strength:.2f} > 0.8`

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: TSL start –ø–æ—Å–ª–µ +0.6%, trail 0.4% ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ –æ—Ç–∫–∞—Ç–∞—Ö.

### 4. ‚úÖ Entry Filters Stricter

- **–§–∞–π–ª**: `config/config_futures.yaml`
  - `min_signal_strength_ranging`: **0.8** (–Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä, —Å—Ç—Ä–æ–∂–µ –¥–ª—è ranging)
  - `min_signal_strength`: 0.7 (–æ–±—â–∏–π)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `min_signal_strength_ranging` –≤ `filter_manager.py` –∏–ª–∏ `signal_generator.py` —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –º–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.

### 5. ‚ö†Ô∏è Market Close for Exits (—á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

- **–§–∞–π–ª**: `src/strategies/scalping/futures/position_manager.py`
  - `close_position_manually`: –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `order_type="market"` –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫—Ä—ã—Ç–∏–π
  - **–°—Ç–∞—Ç—É—Å**: Market close —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ market vs limit –Ω–∞ –æ—Å–Ω–æ–≤–µ PnL –∏ –≤—Ä–µ–º–µ–Ω–∏:
- Market –µ—Å–ª–∏ `pnl < -0.3%` –∏–ª–∏ `time > 20min`
- Limit –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –∫–æ–º–∏—Å—Å–∏–π)

### 6. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞: Gross vs Net PnL –¥–ª—è SL

- **–§–∞–π–ª**: `src/strategies/scalping/futures/positions/exit_analyzer.py`
  - `_generate_exit_for_ranging`: –†–∞–∑–¥–µ–ª–µ–Ω—ã `gross_pnl_percent` –∏ `net_pnl_percent`
  - **SL**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **Gross PnL** (–¥–≤–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã, –Ω–µ –∫–æ–º–∏—Å—Å–∏–∏)
  - **TP/Big Profit/Partial TP**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç **Net PnL** (—Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –ø–æ—Å–ª–µ –∫–æ–º–∏—Å—Å–∏–π)
  - **Max Holding**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **Net PnL** (—Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫)

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –º–∏–Ω—É—Å –∏–∑-–∑–∞ –∫–æ–º–∏—Å—Å–∏–π. SL —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω—ã.

## –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

| –§–∏–∫—Å | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª—ã | –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç |
|------|--------|-------|------------------|
| Dynamic SL –ø–æ ATR (1.2x) | ‚úÖ | config_futures.yaml, exit_analyzer.py | SL hits <60% |
| Dynamic TP –ø–æ ATR (2.5x) | ‚úÖ | config_futures.yaml, exit_analyzer.py | TP –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ |
| Early Partial TP (0.6%) | ‚úÖ | config_futures.yaml | Partial 30-40% |
| PH —Å comm buffer (1.5x) | ‚úÖ | config_futures.yaml, position_manager.py | PH —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–Ω—å—à–µ |
| TSL Aggressive (strength>0.8) | ‚úÖ | trailing_sl_coordinator.py | –§–∏–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ –æ—Ç–∫–∞—Ç–∞—Ö |
| Entry filters stricter (0.8) | ‚ö†Ô∏è | config_futures.yaml | –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∫–æ–¥–µ |
| Market close for exits | ‚ö†Ô∏è | position_manager.py | –£–∂–µ market –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| Gross vs Net PnL –¥–ª—è SL | ‚úÖ | exit_analyzer.py | –ù–µ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π |

## –û–∂–∏–¥–∞–µ–º—ã–π –æ–±—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç

- **SL hits**: <60% (–±—ã–ª–æ 70-81%)
- **Partial/PH/TSL**: 30-40% (–±—ã–ª–æ —Ä–µ–¥–∫–∏–µ)
- **Winrate**: 25-35% (–±—ã–ª–æ 15.6%)
- **RR**: 1:2.5+ (–±—ã–ª–æ —Ö—É–∂–µ)

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 50+ trades
2. ‚ö†Ô∏è –ï—Å–ª–∏ SL –≤—Å—ë –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å SL –∫ 0.7% fixed
3. ‚ö†Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `min_signal_strength_ranging` –≤ –∫–æ–¥–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
4. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ market vs limit –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ PnL/–≤—Ä–µ–º–µ–Ω–∏

