"""
–ê—É–¥–∏—Ç Slippage Guard —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞.

–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç:
1. –†–∞–±–æ—Ç—É Slippage Guard
2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è
3. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞—â–∏—Ç—ã
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
"""

import json
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Any, Optional
import statistics

from loguru import logger


class SlippageGuardAuditor:
    """–ê—É–¥–∏—Ç–æ—Ä Slippage Guard"""

    def __init__(self, positions_file: str):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏—Ç–æ—Ä–∞

        Args:
            positions_file: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏–π
        """
        self.positions_file = positions_file
        self.positions = []

    def load_positions(self) -> None:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π"""
        logger.info(f"üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–π –∏–∑ {self.positions_file}")
        try:
            with open(self.positions_file, "r", encoding="utf-8") as f:
                self.positions = json.load(f)
            logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.positions)} –ø–æ–∑–∏—Ü–∏–π")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∑–∏—Ü–∏–π: {e}")
            raise

    def analyze_slippage_from_positions(self) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è –∏–∑ –ø–æ–∑–∏—Ü–∏–π
        
        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í –¥–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–∏ –Ω–∞–ø—Ä—è–º—É—é.
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ—Å–≤–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É entry_price –∏ exit_price.
        """
        logger.info("üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è –∏–∑ –ø–æ–∑–∏—Ü–∏–π...")

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º entry_order_id (—á–∞—Å—Ç–∏—á–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è)
        # –ï—Å–ª–∏ entry_price != exit_price –¥–ª—è –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ - –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ
        
        price_differences = []
        for pos in self.positions:
            entry_price = float(pos.get("entry_price", 0))
            exit_price = float(pos.get("exit_price", 0))
            
            if entry_price > 0 and exit_price > 0:
                # –†–∞–∑–Ω–∏—Ü–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
                diff_pct = abs(exit_price - entry_price) / entry_price * 100
                price_differences.append(diff_pct)

        if not price_differences:
            return {"error": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"}

        # –§–∏–ª—å—Ç—Ä—É–µ–º –±–æ–ª—å—à–∏–µ —Ä–∞–∑–ª–∏—á–∏—è (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ, –∞ –¥–≤–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã)
        # –ü—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ < 0.5%
        slippage_candidates = [d for d in price_differences if d < 0.5]

        analysis = {
            "total_positions": len(price_differences),
            "avg_price_diff_pct": statistics.mean(price_differences) if price_differences else 0,
            "max_price_diff_pct": max(price_differences) if price_differences else 0,
            "slippage_candidates": len(slippage_candidates),
            "avg_slippage_candidate": statistics.mean(slippage_candidates) if slippage_candidates else 0,
        }

        return analysis

    def analyze_code_implementation(self) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Slippage Guard –≤ –∫–æ–¥–µ"""
        logger.info("üîç –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Slippage Guard...")

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        config_params = {
            "max_slippage_percent": 0.1,  # 0.1%
            "max_spread_percent": 0.05,  # 0.05%
            "order_timeout": 30.0,  # 30 —Å–µ–∫—É–Ω–¥
        }

        # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —Ä–µ–∂–∏–º–∞–º
        by_regime = {
            "trending": {
                "max_slippage_percent": 0.15,  # –ë–æ–ª—å—à–µ –≤ —Ç—Ä–µ–Ω–¥–µ
            },
            "ranging": {
                "max_slippage_percent": 0.1,  # –°—Ç–∞–Ω–¥–∞—Ä—Ç
            },
            "choppy": {
                "max_slippage_percent": 0.08,  # –ú–µ–Ω—å—à–µ –≤ —Ö–∞–æ—Å–µ
            },
        }

        # –ü—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ
        problems = []

        # 1. –õ–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –Ω–µ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è
        problems.append({
            "severity": "info",
            "issue": "–õ–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –Ω–µ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è SlippageGuard",
            "description": "SlippageGuard –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ª–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –æ—Ç–º–µ–Ω—ã)",
            "location": "slippage_guard.py:154",
        })

        # 2. _get_current_prices –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–≥–ª—É—à–∫—É
        problems.append({
            "severity": "warning",
            "issue": "_get_current_prices –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–≥–ª—É—à–∫—É",
            "description": "–ú–µ—Ç–æ–¥ _get_current_prices –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω",
            "location": "slippage_guard.py:195",
        })

        # 3. –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è
        problems.append({
            "severity": "medium",
            "issue": "–ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è",
            "description": "SlippageGuard –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞",
            "location": "slippage_guard.py",
        })

        analysis = {
            "config_params": config_params,
            "by_regime": by_regime,
            "problems": problems,
        }

        return analysis

    def generate_report(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞"""
        logger.info("üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞...")

        slippage_analysis = self.analyze_slippage_from_positions()
        code_analysis = self.analyze_code_implementation()

        report = f"""# üîç –ê–£–î–ò–¢ SLIPPAGE GUARD

**–î–∞—Ç–∞:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}  
**–ü–µ—Ä–∏–æ–¥:** 02-03.12.2025  
**–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:** {self.positions_file}

---

## üìä –ê–ù–ê–õ–ò–ó –ü–†–û–°–ö–ê–õ–¨–ó–´–í–ê–ù–ò–Ø

"""

        if "error" not in slippage_analysis:
            report += f"""
### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º:
- **–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π:** {slippage_analysis['total_positions']}
- **–°—Ä–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞ —Ü–µ–Ω:** {slippage_analysis['avg_price_diff_pct']:.4f}%
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞:** {slippage_analysis['max_price_diff_pct']:.4f}%
- **–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (<0.5%):** {slippage_analysis['slippage_candidates']}
- **–°—Ä–µ–¥–Ω–µ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (–∫–∞–Ω–¥–∏–¥–∞—Ç—ã):** {slippage_analysis['avg_slippage_candidate']:.4f}%

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Ä–∞–∑–Ω–∏—Ü–µ –º–µ–∂–¥—É entry_price –∏ exit_price. 
–†–µ–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –∏–∑-–∑–∞ –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã.
"""

        report += f"""
---

## üîç –ê–ù–ê–õ–ò–ó –ö–û–î–ê SLIPPAGE GUARD

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞:

**–ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- **max_slippage_percent:** {code_analysis['config_params']['max_slippage_percent']}% (0.1%)
- **max_spread_percent:** {code_analysis['config_params']['max_spread_percent']}% (0.05%)
- **order_timeout:** {code_analysis['config_params']['order_timeout']} —Å–µ–∫—É–Ω–¥

**–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —Ä–µ–∂–∏–º–∞–º:**
- **Trending:** max_slippage={code_analysis['by_regime']['trending']['max_slippage_percent']}%
- **Ranging:** max_slippage={code_analysis['by_regime']['ranging']['max_slippage_percent']}%
- **Choppy:** max_slippage={code_analysis['by_regime']['choppy']['max_slippage_percent']}%

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤:**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
   - ‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –∏ —Å–ø—Ä–µ–¥
   - ‚úÖ –û—Ç–º–µ–Ω—è–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º:**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ø—Ä–µ–¥ –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º –æ—Ä–¥–µ—Ä–∞
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –¥–ª—è –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤

3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
   - ‚úÖ –õ–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –ù–ï –æ—Ç–º–µ–Ω—è—é—Ç—Å—è (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
   - ‚ö†Ô∏è Market –æ—Ä–¥–µ—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å —É–∂–µ –∏—Å–ø–æ–ª–Ω–µ–Ω—ã

---

## ‚ö†Ô∏è –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

"""

        for i, problem in enumerate(code_analysis["problems"], 1):
            severity_emoji = {
                "info": "‚ÑπÔ∏è",
                "warning": "‚ö†Ô∏è",
                "medium": "üî∂",
                "high": "üî¥",
                "critical": "üö®",
            }.get(problem["severity"], "‚ùì")

            report += f"""
### {i}. {severity_emoji} {problem['issue']}

**–û–ø–∏—Å–∞–Ω–∏–µ:** {problem['description']}  
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** {problem['location']}  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** {problem['severity']}
"""

        report += f"""
---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å _get_current_prices (–ö–†–ò–¢–ò–ß–ù–û)
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω —á–µ—Ä–µ–∑ WebSocket –∏–ª–∏ REST API
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ order book
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ SlippageGuard

### 2. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—Ä–¥–µ—Ä–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è
- ‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞—â–∏—Ç—ã

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 3. –£–ª—É—á—à–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ª–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏–µ
- ‚úÖ –û—Ç–º–µ–Ω—è—Ç—å –æ—Ä–¥–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏—Å—è—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
- ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å —Ü–µ–Ω—É –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –£–ª—É—á—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤

### 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)
- ‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —Å–∏–º–≤–æ–ª–∞–º
- ‚úÖ –£—á–∏—Ç—ã–≤–∞—Ç—å –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å –æ—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è –Ω–∞ 20-30%

---

## üìä –û–¶–ï–ù–ö–ê –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- ‚ö†Ô∏è **–†–∞–±–æ—Ç–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ:** SlippageGuard —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, –Ω–æ _get_current_prices –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–≥–ª—É—à–∫—É
- ‚ö†Ô∏è **–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö:** –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è
- ‚úÖ **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —Ä–µ–∂–∏–º–∞–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —É–ª—É—á—à–µ–Ω–∏—è:
- **–°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å –æ—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è:** 20-30%
- **–£–ª—É—á—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤:** 10-15%
- **–°–Ω–∏–∂–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤:** 5-10%

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å _get_current_prices –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω
2. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
"""

        return report

    def save_report(self, report: str, output_file: str = "SLIPPAGE_GUARD_AUDIT_REPORT.md") -> None:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞"""
        logger.info(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ {output_file}")
        try:
            with open(output_file, "w", encoding="utf-8") as f:
                f.write(report)
            logger.info(f"‚úÖ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_file}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞: {e}")
            raise


async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    positions_file = "exchange_positions.json"
    
    if not Path(positions_file).exists():
        logger.error(f"‚ùå –§–∞–π–ª {positions_file} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return

    auditor = SlippageGuardAuditor(positions_file)
    
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        auditor.load_positions()
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        report = auditor.generate_report()
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
        auditor.save_report(report)
        
        logger.info("‚úÖ –ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –∞—É–¥–∏—Ç–∞: {e}")
        raise


if __name__ == "__main__":
    import asyncio
    asyncio.run(main())

