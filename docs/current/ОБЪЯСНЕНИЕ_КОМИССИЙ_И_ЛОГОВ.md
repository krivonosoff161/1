# Объяснение комиссий и логов

## 1. Логирование ✅ ИСПРАВЛЕНО

### Проблема:
- Часть логов в консоль (INFO), часть в файл (DEBUG)
- Нет архивации старых логов
- Сложно анализировать полную историю

### Решение:
- **Консоль**: Только INFO и выше (чтобы не засорять экран)
- **Файл**: ВСЕ уровни (DEBUG+) с ротацией и архивацией
- **Архивация**: Старые логи автоматически сжимаются в ZIP при ротации (каждые 10 MB)
- **Хранение**: 30 дней истории логов
- **Имя файла**: `futures_main_YYYY-MM-DD.log` (с датой)

### Где найти логи:
- Текущий день: `logs/futures/futures_main_2025-10-31.log`
- Старые логи: `logs/futures/futures_main_2025-10-31.log.zip`

---

## 2. Открытие позиций ✅ ИСПРАВЛЕНО

### Проблема:
Бот открывал только по 1 позиции для BTC и ETH при старте и больше не открывал, даже если сигналы позволяли.

### Причина:
1. **Тестовая логика**: Бот открывал позицию только при первом обновлении цены (`_price_update_count[symbol] == 1`)
2. **Проверка кэша**: Использовался только внутренний кэш `self.active_positions`, который мог быть не синхронизирован с биржей
3. **Отсутствие глобальной проверки**: Не проверялся лимит `max_open_positions` перед каждым открытием

### Решение:
1. ✅ **Проверка реальных позиций на бирже**: Перед открытием позиции бот проверяет актуальное состояние через `get_positions()`
2. ✅ **Глобальная проверка лимита**: Проверяется общее количество открытых позиций и сравнивается с `max_open_positions` из профиля баланса
3. ✅ **Синхронизация кэша**: Если позиция закрыта на бирже, кэш обновляется и бот может открыть новую

### Логика работы:
```
1. Получаем все позиции с биржи через get_positions()
2. Проверяем, есть ли уже открытая позиция по текущему символу
3. Если есть → пропускаем сигнал
4. Если нет → проверяем глобальный лимит max_open_positions
5. Если лимит не достигнут → открываем позицию
6. Если лимит достигнут → пропускаем сигнал
```

---

## 3. Комиссии на OKX ℹ️ ОБЪЯСНЕНИЕ

### Почему комиссии разные?

OKX взимает комиссию в зависимости от нескольких факторов:

#### 1. **Тип ордера (Maker vs Taker)**
- **Maker** (лимитный ордер, добавляет ликвидность): обычно **0.02% - 0.05%**
- **Taker** (рыночный ордер, забирает ликвидность): обычно **0.05% - 0.08%**

Наш бот использует **рыночные ордера (Taker)**, поэтому комиссия = **0.05%** на вход.

#### 2. **VIP уровень**
- **Regular (VIP 0)**: 0.08% taker
- **VIP 1**: 0.075% taker
- **VIP 2**: 0.07% taker
- **VIP 3+**: от 0.06% и ниже

#### 3. **Объем сделки**
Комиссия рассчитывается от **стоимости сделки (notional value)**:
- Для **BTC**: `комиссия = размер_в_BTC × цена × 0.0005`
- Для **ETH**: `комиссия = размер_в_ETH × цена × 0.0005`

#### 4. **Примеры расчета:**

**Пример 1: BTC позиция $180**
```
Размер: 0.001 BTC
Цена: $110,000
Стоимость сделки: 0.001 × $110,000 = $110
Комиссия (0.05%): $110 × 0.0005 = $0.055 (≈ 0.06 USD)
```

**Пример 2: ETH позиция $180**
```
Размер: 0.046 ETH
Цена: $3,900
Стоимость сделки: 0.046 × $3,900 = $179.4
Комиссия (0.05%): $179.4 × 0.0005 = $0.0897 (≈ 0.09 USD)
```

**Пример 3: BTC позиция $75**
```
Размер: 0.00068 BTC
Цена: $110,000
Стоимость сделки: 0.00068 × $110,000 = $74.8
Комиссия (0.05%): $74.8 × 0.0005 = $0.0374 (≈ 0.04 USD)
```

#### 5. **Почему "половина доллара"?**

Если комиссия ≈ $0.50, это означает:
- **BTC**: сделка на ~$1000 (0.009 BTC × $110k)
- **ETH**: сделка на ~$1000 (0.256 ETH × $3.9k)

Это **нормально** для позиций большего размера!

#### 6. **Комиссия "на круг" (Round Trip)**
- **Открытие**: 0.05% (taker)
- **Закрытие**: 0.05% (taker)
- **Итого**: **0.10%** (0.001) на полный цикл

Именно поэтому в TrailingStopLoss используется `trading_fee_rate = 0.001`.

### ✅ Что делает бот:
1. Учитывает комиссию 0.1% в расчетах TrailingStopLoss
2. Вычитает комиссию из прибыли при принятии решений о закрытии
3. Показывает и net (с комиссией) и gross (без комиссии) прибыль в логах

### ⚠️ Важно:
- **Реальная комиссия может отличаться** в зависимости от VIP уровня и объема
- OKX возвращает точную комиссию в ответе на ордер (поле `fee`)
- В будущем можно добавить логирование реальной комиссии из API

---

## Итог

✅ **Логи**: Теперь все логи идут в архивные файлы с ротацией  
✅ **Открытие позиций**: Бот проверяет реальные позиции на бирже и глобальный лимит  
ℹ️ **Комиссии**: Разные из-за размера сделки и VIP уровня, нормальное явление

