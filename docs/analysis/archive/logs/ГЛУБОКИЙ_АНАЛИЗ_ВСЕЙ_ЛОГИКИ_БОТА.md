# üîç –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó –í–°–ï–ô –õ–û–ì–ò–ö–ò –ë–û–¢–ê

**–î–∞—Ç–∞:** 2025-11-18  
**–°—Ç–∞—Ç—É—Å:** –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —à–∞–≥–æ–≤ –∏ –ø—Ä–æ–±–ª–µ–º

---

## üìä –ü–û–õ–ù–´–ô FLOW –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô

### **–®–ê–ì 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–∫–µ—Ä–∞ –∏–∑ WebSocket**

**–ú–µ—Ç–æ–¥:** `orchestrator._handle_ticker_data(symbol, price)`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –∏–∑ WebSocket
2. –í—ã–∑—ã–≤–∞–µ—Ç `await self._manage_positions()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏
3. –í—ã–∑—ã–≤–∞–µ—Ç `await self._update_trailing_stop_loss(symbol, price)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TSL –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Ä—ã

**–ö–æ–¥:** `orchestrator.py:731` (–≤ —Ü–∏–∫–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∏–∫–µ—Ä–æ–≤)

---

### **–®–ê–ì 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏**

**–ú–µ—Ç–æ–¥:** `orchestrator._manage_positions()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–∏
2. –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `await self.position_manager.manage_position(position)`

**–ö–æ–¥:** `orchestrator.py:2142`

---

### **–®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –≤ Position Manager**

**–ú–µ—Ç–æ–¥:** `position_manager.manage_position(position)`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∂–∏–º** –∏–∑ `active_positions` (—Å—Ç—Ä–æ–∫–∞ 131-144)
2. **–î–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∂–∏–º –≤ position** –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –º–µ—Ç–æ–¥—ã (—Å—Ç—Ä–æ–∫–∞ 151-155)
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: `await self._check_position_safety(position)`
4. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç Profit Harvest:** `await self._check_profit_harvesting(position)` - –ü–†–ò–û–†–ò–¢–ï–¢ #1
   - –ï—Å–ª–∏ `ph_should_close = True` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `await self._close_position_by_reason(position, "profit_harvest")` ‚Üí **RETURN** (–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–ª—å—à–µ)
5. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç TP:** `await self._check_tp_only(position)`
   - –ï—Å–ª–∏ TP –¥–æ—Å—Ç–∏–≥–Ω—É—Ç ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `await self._close_position_by_reason(position, "tp")`
6. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: `await self._update_position_stats(position)`

**–ö–æ–¥:** `position_manager.py:105-177`

---

### **–®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ TP (Take Profit)**

**–ú–µ—Ç–æ–¥:** `position_manager._check_tp_only(position)`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### 4.1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ (—Å—Ç—Ä–æ–∫–∞ 973-976):
```python
regime = position.get("regime") or self.active_positions.get(symbol, {}).get("regime")
```
‚úÖ –†–µ–∂–∏–º –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ –∏–ª–∏ –∏–∑ `active_positions`

#### 4.2. –ó–∞–≥—Ä—É–∑–∫–∞ TP –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (—Å—Ç—Ä–æ–∫–∞ 978-1062):

**–ü–†–ò–û–†–ò–¢–ï–¢ 1: Per-regime TP** (—Å—Ç—Ä–æ–∫–∞ 994-1035):
```python
if regime:
    regime_profile = symbol_dict.get(regime.lower(), {})
    regime_tp_percent = regime_profile.get("tp_percent")
    if regime_tp_percent is not None:
        tp_percent = float(regime_tp_percent)
        logger.debug(f"üìä Per-regime TP –¥–ª—è {symbol} ({regime}): {tp_percent}%")
```
‚úÖ –ö–æ–¥ –µ—Å—Ç—å, –Ω–æ –≤ –ª–æ–≥–∞—Ö –ù–ï –í–ò–î–ù–û "Per-regime TP" - —Ç–æ–ª—å–∫–æ "Per-symbol TP"

**–ü–†–ò–û–†–ò–¢–ï–¢ 2: Per-symbol TP** (—Å—Ç—Ä–æ–∫–∞ 1037-1062):
```python
if tp_percent == self.scalping_config.tp_percent:  # –ï—Å–ª–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è per-regime
    symbol_tp_percent = symbol_dict.get("tp_percent")
    if symbol_tp_percent is not None:
        tp_percent = float(symbol_tp_percent)
        logger.debug(f"üìä Per-symbol TP –¥–ª—è {symbol}: {tp_percent}%")
```
‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è (–≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö)

**–ü–†–ò–û–†–ò–¢–ï–¢ 3: –ì–ª–æ–±–∞–ª—å–Ω—ã–π TP** (—Å—Ç—Ä–æ–∫–∞ 971):
```python
tp_percent = self.scalping_config.tp_percent  # Fallback
```

#### 4.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ TP —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ (—Å—Ç—Ä–æ–∫–∞ 1160-1199):
```python
tp_percent_with_commission = tp_percent + commission_pct_from_margin + slippage_buffer_pct
if pnl_percent >= tp_percent_with_commission:
    net_pnl_percent = pnl_percent - commission_pct_from_margin
    if net_pnl_percent > 0:
        await self._close_position_by_reason(position, "tp")
        return
```

**–ü—Ä–æ–±–ª–µ–º–∞:** TP –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑-–∑–∞:
1. `min_holding_minutes` –±–ª–æ–∫–∏—Ä—É–µ—Ç (–Ω–æ —ç—Ç–æ –Ω–µ –≤ `_check_tp_only`, —ç—Ç–æ –≤ TSL!)
2. TP —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π (3.25% + –∫–æ–º–∏—Å—Å–∏—è ~1% = 4.25%)
3. PnL –Ω–µ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç TP

**–ö–æ–¥:** `position_manager.py:750-1250`

---

### **–®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ TSL (Trailing Stop Loss)**

**–ú–µ—Ç–æ–¥:** `orchestrator._update_trailing_stop_loss(symbol, current_price)`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### 5.1. –ü–æ–ª—É—á–µ–Ω–∏–µ TSL (—Å—Ç—Ä–æ–∫–∞ 4928):
```python
tsl = self.trailing_sl_by_symbol[symbol]
```

#### 5.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ TSL (—Å—Ç—Ä–æ–∫–∞ 4931):
```python
tsl.update(current_price)
```

#### 5.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ should_close_position (—Å—Ç—Ä–æ–∫–∞ 5010):
```python
should_close_by_sl = tsl.should_close_position(current_price, trend_strength=trend_strength, market_regime=market_regime)
```

#### 5.4. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ (—Å—Ç—Ä–æ–∫–∞ 5017-5160):
```python
if should_close_by_sl and profit_pct > 0:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º RSI, MACD, Bollinger –¥–ª—è –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    if reversal_detected:
        should_block_close = True
```

#### 5.5. –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ TSL (—Å—Ç—Ä–æ–∫–∞ 5174):
```python
if symbol in self.active_positions:
    await self._close_position(symbol, "trailing_stop")
```

**–ö–æ–¥:** `orchestrator.py:4904-5230`

---

### **–®–ê–ì 6: –õ–æ–≥–∏–∫–∞ TSL –≤ should_close_position**

**–ú–µ—Ç–æ–¥:** `trailing_stop_loss.should_close_position(current_price)`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### 6.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ min_holding_minutes (—Å—Ç—Ä–æ–∫–∞ 424-513):
```python
if effective_min_holding is not None and minutes_in_position < effective_min_holding:
    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º loss_cut –ø–æ—Å–ª–µ min_critical_hold_seconds
    if seconds_in_position >= min_critical_hold_seconds:
        if profit_pct <= -loss_cut_from_price:
            return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ loss_cut —Å—Ä–∞–∑—É
    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–±—ã—Ç–æ–∫ (2x loss_cut) –∑–∞–∫—Ä—ã–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û
    if profit_pct <= -critical_loss_cut_from_price:
        return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π loss_cut –ù–ï–ú–ï–î–õ–ï–ù–ù–û
    # –ò–Ω–∞—á–µ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º (min_holding –Ω–µ –ø—Ä–æ—à–µ–ª)
    return False
```
‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê:** `min_holding_minutes` –±–ª–æ–∫–∏—Ä—É–µ—Ç –í–°–ï –∑–∞–∫—Ä—ã—Ç–∏—è, –∫—Ä–æ–º–µ loss_cut –ø–æ—Å–ª–µ `min_critical_hold_seconds`

#### 6.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ loss_cut_percent (—Å—Ç—Ä–æ–∫–∞ 515-532):
```python
if profit_pct <= -loss_cut_from_price:
    return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ loss_cut
```
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ `min_holding_minutes` –ò–õ–ò `min_critical_hold_seconds`

#### 6.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ timeout_loss_percent (—Å—Ç—Ä–æ–∫–∞ 534-557):
```python
if minutes_in_position >= timeout_minutes and profit_pct <= -timeout_loss_from_price:
    return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ timeout
```

#### 6.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞ (—Å—Ç—Ä–æ–∫–∞ 559-598):
```python
if price_hit_sl:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º min_holding_minutes –ü–ï–†–ï–î –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É
    if minutes_in_position < effective_min_holding:
        return False  # –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É, –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—à–ª–æ min_holding
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º min_profit_to_close
    if profit_pct < min_profit_to_close:
        return False  # –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏—Ç –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ
    return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É
```

**–ü—Ä–æ–±–ª–µ–º–∞:** TSL –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑-–∑–∞:
1. `min_holding_minutes` –±–ª–æ–∫–∏—Ä—É–µ—Ç –í–°–ï –∑–∞–∫—Ä—ã—Ç–∏—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
2. `min_profit_to_close` –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É

**–ö–æ–¥:** `trailing_stop_loss.py:400-763`

---

### **–®–ê–ì 7: –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏**

**–ú–µ—Ç–æ–¥:** `orchestrator._close_position(symbol, reason)`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### 7.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∞ 5845-5852):
```python
if symbol in self._closing_positions:
    return  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —É–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
```

#### 7.2. –ó–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ position_manager (—Å—Ç—Ä–æ–∫–∞ 5871-5873):
```python
trade_result = await self.position_manager.close_position_manually(symbol, reason=reason)
```
‚úÖ **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:** `reason` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

#### 7.3. –ó–∞–ø–∏—Å—å –≤ CSV (—Å—Ç—Ä–æ–∫–∞ 5876-5881):
```python
if trade_result and hasattr(self, "performance_tracker"):
    self.performance_tracker.record_trade(trade_result)
```
‚úÖ TradeResult —Å–æ–¥–µ—Ä–∂–∏—Ç `reason`

#### 7.4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Å—Ç—Ä–æ–∫–∞ 5923-5928):
```python
if symbol in self.active_positions:
    del self.active_positions[symbol]
if symbol in self.trailing_sl_by_symbol:
    del self.trailing_sl_by_symbol[symbol]
```

**–ö–æ–¥:** `orchestrator.py:5840-5948`

---

### **–®–ê–ì 8: –°–æ–∑–¥–∞–Ω–∏–µ TradeResult**

**–ú–µ—Ç–æ–¥:** `position_manager.close_position_manually(symbol, reason)`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### 8.1. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–∏ (—Å—Ç—Ä–æ–∫–∞ 1747):
```python
actual_position = await self.client.get_position(symbol)
```

#### 8.2. –°–æ–∑–¥–∞–Ω–∏–µ TradeResult (—Å—Ç—Ä–æ–∫–∞ 1880-1890):
```python
trade_result = TradeResult(
    symbol=symbol,
    side=side,
    entry_price=entry_price,
    exit_price=exit_price,
    size=abs(size),
    gross_pnl=gross_pnl,
    net_pnl=net_pnl,
    commission=commission,
    duration_sec=duration_sec,
    reason=reason,  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π reason
    timestamp=datetime.now(),
)
```
‚úÖ `reason` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ö–æ–¥:** `position_manager.py:1733-1920`

---

## üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú

### **–ü–†–û–ë–õ–ï–ú–ê #1: Per-regime TP –ù–ï –ü–†–ò–ú–ï–ù–Ø–ï–¢–°–Ø**

**–ü–æ—á–µ–º—É:**
- –ö–æ–¥ –µ—Å—Ç—å –≤ `_check_tp_only` (—Å—Ç—Ä–æ–∫–∞ 994-1035)
- –ù–æ –≤ –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ "Per-symbol TP", –ù–ï "Per-regime TP"
- –ó–Ω–∞—á–∏—Ç `regime` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏–ª–∏ `regime_profile.get("tp_percent")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑ –ª–æ–≥–æ–≤:**
- `regime=ranging` –≤–∏–¥–Ω–æ –≤ TSL –ª–æ–≥–∞—Ö (—Å—Ç—Ä–æ–∫–∞ 2, 12, 37)
- –ù–æ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ TP —Ä–µ–∂–∏–º –º–æ–∂–µ—Ç –±—ã—Ç—å `None`

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. `position.get("regime")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (—Ä–µ–∂–∏–º –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–æ–∑–∏—Ü–∏–∏)
2. `self.active_positions[symbol].get("regime")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (—Ä–µ–∂–∏–º –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)
3. `regime_profile.get("tp_percent")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (–Ω–µ—Ç tp_percent –≤ –∫–æ–Ω—Ñ–∏–≥–µ –¥–ª—è —Ä–µ–∂–∏–º–∞)

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–∏ —Ä–µ–∂–∏–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –≤ `_execute_signal_from_price` (orchestrator)
- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ª–∏ —Ä–µ–∂–∏–º –≤ `manage_position` —á–µ—Ä–µ–∑ `position` —Å–ª–æ–≤–∞—Ä—å

---

### **–ü–†–û–ë–õ–ï–ú–ê #2: Per-regime TSL –ü–ê–†–ê–ú–ï–¢–†–´ –ü–†–ò–ú–ï–ù–Ø–Æ–¢–°–Ø**

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
- `_get_trailing_sl_params` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –ø–æ —Ä–µ–∂–∏–º—É (—Å—Ç—Ä–æ–∫–∞ 1054-1172)
- `_initialize_trailing_stop` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç TSL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (—Å—Ç—Ä–æ–∫–∞ 1372-1440)
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ `loss_cut=0.8%` –¥–ª—è `ranging` —Ä–µ–∂–∏–º–∞ (–≤ –∫–æ–Ω—Ñ–∏–≥–µ `loss_cut_percent: 0.8` –¥–ª—è ranging)

**–í—ã–≤–æ–¥:** ‚úÖ Per-regime TSL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

### **–ü–†–û–ë–õ–ï–ú–ê #3: safety_threshold –ù–ï –ó–ê–ì–†–£–ñ–ê–ï–¢–°–Ø**

**–ü–æ—á–µ–º—É:**
- –ö–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –µ—Å—Ç—å –≤ `margin_calculator.is_position_safe` (—Å—Ç—Ä–æ–∫–∞ 187-255)
- –ù–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback `1.5` (49+ —Å–ª—É—á–∞–µ–≤)
- –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback safety_threshold=1.5"

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. `margin_config` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø
2. `margin_config.by_regime` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `regime`
3. `regime_config.get("safety_threshold")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ª–∏ `margin_config` –≤ `orchestrator.__init__` (—Å—Ç—Ä–æ–∫–∞ 97-118)
- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ª–∏ `regime` –≤ `is_position_safe` (—Å—Ç—Ä–æ–∫–∞ 185)

---

### **–ü–†–û–ë–õ–ï–ú–ê #4: equity –ù–ï –ù–ê–ô–î–ï–ù**

**–ü–æ—á–µ–º—É:**
- `get_margin_info()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –∏–ª–∏ `equity = 0`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –Ω–∞ –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å (~847 USDT)

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. API OKX –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `equity` –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–∞—Ä–∂–∏
2. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ API –∏–∑–º–µ–Ω–∏–ª—Å—è
3. –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å `equity` –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ `/api/v5/account/positions`

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ `get_margin_info()` –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–∞—Ä–∂–∏
- –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª–µ `eq` –∏–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å `margin + upl`

---

### **–ü–†–û–ë–õ–ï–ú–ê #5: "–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º"**

**–ê–Ω–∞–ª–∏–∑:**
- –ò–∑ –∞–Ω–∞–ª–∏–∑–∞ 31 –∞—Ä—Ö–∏–≤–∞: 2,210 –∑–∞–∫—Ä—ã—Ç–∏–π –ø–æ "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º" (93.6%)
- –ù–æ –∏–∑ –∫–æ–¥–∞ –≤–∏–¥–Ω–æ, —á—Ç–æ –≤—Å–µ –∑–∞–∫—Ä—ã—Ç–∏—è –∏–¥—É—Ç —á–µ—Ä–µ–∑ `_close_position` —Å `reason`

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. `reason` –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ CSV (–Ω–æ –∫–æ–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è)
2. `reason` –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö
3. –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket (Private WS) –±–µ–∑ reason

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑ –ª–æ–≥–æ–≤:**
- `üõë –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ SOL-USDT: trailing_stop` (—Å—Ç—Ä–æ–∫–∞ 983)
- `üõë –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ETH-USDT: trailing_stop` (—Å—Ç—Ä–æ–∫–∞ 3043)
- `üìä Private WS: –ü–æ–∑–∏—Ü–∏—è {symbol} –∑–∞–∫—Ä—ã—Ç–∞ (—Ä–∞–∑–º–µ—Ä=0)` (—Å—Ç—Ä–æ–∫–∞ 5333)

**–í—ã–≤–æ–¥:** –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º (`trailing_stop`, `tp`, `profit_harvest`), –Ω–æ –≤ –∞–Ω–∞–ª–∏–∑–µ –ª–æ–≥–æ–≤ –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–≤–æ–∑–º–æ–∂–Ω–æ, CSV –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç reason –∏–ª–∏ reason –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è)

---

## üìã –ò–¢–û–ì–û–í–´–ï –í–´–í–û–î–´

### **1. Per-regime TP:**
- ‚ùå **–ù–ï –ü–†–ò–ú–ï–ù–Ø–ï–¢–°–Ø** - –≤ –ª–æ–≥–∞—Ö –Ω–µ –≤–∏–¥–Ω–æ "Per-regime TP"
- **–ü—Ä–∏—á–∏–Ω–∞:** `regime` –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `_check_tp_only` –∏–ª–∏ `regime_profile.get("tp_percent")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –∏ –ø–µ—Ä–µ–¥–∞—á—É –≤ `manage_position`

### **2. Per-regime TSL:**
- ‚úÖ **–ü–†–ò–ú–ï–ù–Ø–ï–¢–°–Ø** - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –ø–æ —Ä–µ–∂–∏–º—É
- **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:** `loss_cut_percent` –¥–ª—è `ranging` = 0.8% (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)

### **3. Per-regime safety_threshold:**
- ‚ùå **–ù–ï –ó–ê–ì–†–£–ñ–ê–ï–¢–°–Ø** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback `1.5` –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
- **–ü—Ä–∏—á–∏–Ω–∞:** `margin_config` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `by_regime` –∏–ª–∏ `regime` –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É `margin_config` –∏ –ø–µ—Ä–µ–¥–∞—á—É `regime` –≤ `is_position_safe`

### **4. TP/TSL –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç:**
- ‚ùå **TP:** 3,351 –ø—Ä–æ–≤–µ—Ä–æ–∫ ‚Üí 4 –∑–∞–∫—Ä—ã—Ç–∏—è (0.12%) - –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è `min_holding_minutes` –∏–ª–∏ TP —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π
- ‚ùå **TSL:** 398 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π ‚Üí 0 –∑–∞–∫—Ä—ã—Ç–∏–π (0%) - –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è `min_holding_minutes` –∏ `min_profit_to_close`
- **–ü—Ä–∏—á–∏–Ω–∞:** `min_holding_minutes` –±–ª–æ–∫–∏—Ä—É–µ—Ç –í–°–ï –∑–∞–∫—Ä—ã—Ç–∏—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
- **–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É `min_holding_minutes` –¥–ª—è TP –∏ loss_cut –ø–æ—Å–ª–µ `min_critical_hold_seconds`

### **5. "–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º":**
- ‚úÖ **–ü—Ä–∏—á–∏–Ω—ã –µ—Å—Ç—å** - –≤—Å–µ –∑–∞–∫—Ä—ã—Ç–∏—è –∏–¥—É—Ç —á–µ—Ä–µ–∑ `_close_position` —Å `reason`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í –∞–Ω–∞–ª–∏–∑–µ –ª–æ–≥–æ–≤ reason –º–æ–∂–µ—Ç –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (CSV –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç reason –∏–ª–∏ –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è)
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å—å `reason` –≤ CSV –∏ –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï:**
1. **–£–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É `min_holding_minutes` –¥–ª—è TP** - TP –¥–æ–ª–∂–µ–Ω –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –°–†–ê–ó–£ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏
2. **–£–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É `min_holding_minutes` –¥–ª—è loss_cut –ø–æ—Å–ª–µ `min_critical_hold_seconds`** - —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É `safety_threshold`** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `margin_config` –∏ –ø–µ—Ä–µ–¥–∞—á—É `regime`
4. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ per-regime TP** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–¥–∞—á—É `regime`

### **–í–ê–ñ–ù–´–ï:**
5. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ `equity`** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ API –∏ –¥–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏
6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å—å `reason` –≤ CSV** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `reason` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-18  
**–°—Ç–∞—Ç—É—Å:** –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω






