# üìä –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –¢–û–†–ì–û–í–û–ì–û –ë–û–¢–ê (–ø–æ –∑–∞–ø—Ä–æ—Å—É Grok)

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-12-21  
**–ë–∏—Ä–∂–∞:** OKX Futures  
**–†–µ–∂–∏–º:** Scalping  
**–ë–∞–ª–∞–Ω—Å:** ~50 USDT (micro profile)

---

## 1. –ü–ê–†–ê–ú–ï–¢–†–´ –ò –†–ï–ñ–ò–ú–´

### 1.1. –¢–∞–±–ª–∏—Ü–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ —Ä–µ–∂–∏–º–∞–º

| –ü–∞—Ä–∞–º–µ—Ç—Ä | TRENDING | RANGING | CHOPPY | –ò—Å—Ç–æ—á–Ω–∏–∫ |
|----------|----------|---------|--------|----------|
| **TP%** | 2.5% | 2.0% | 1.8% | `config_futures.yaml:236,299,363` |
| **SL%** | 0.8% | 0.8% | 1.0% | `config_futures.yaml:237,300,364` |
| **Max Holding (–º–∏–Ω)** | 40 | 25 | 14 | `config_futures.yaml:238,301,365` |
| **Max Holding Hard Stop** | ‚ùå | ‚úÖ | ‚ùå | `config_futures.yaml:302` |
| **Timeout Loss %** | - | 1.5% | - | `config_futures.yaml:303` |
| **Leverage (x)** | 3-30 (adaptive) | 3-30 (adaptive) | 3-30 (adaptive) | `adaptive_leverage.py:33-38` |
| **Margin Safety Threshold** | 1.3 | 1.5 | 1.1 | `config_futures.yaml:1719,1725` |
| **Risk per Trade %** | 1.0% | 1.5% | 2.0% | `config_futures.yaml:1213,1236,1259` |
| **Profit Drawdown %** | 3.0% | 3.0% | 3.0% | `config_futures.yaml:1718` |
| **Partial TP Trigger %** | 0.6% | 0.6% | 0.6% | `config_futures.yaml:1861` |
| **Partial TP Fraction** | 60% | 60% | 60% | `config_futures.yaml:1862` |
| **PH Threshold Type** | margin_percent | margin_percent | margin_percent | `config_futures.yaml:246,311,373` |
| **PH Threshold %** | 2.5% | 1.5% | 1.0% | `config_futures.yaml:247,312,374` |
| **PH Time Limit (—Å–µ–∫)** | 600 | 1200 | 60 | `config_futures.yaml:249,314,376` |
| **Min Signal Strength** | 0.8 | 0.7 | 0.6 | `config_futures.yaml:1851,1857,1863` |
| **ADX Threshold** | 18.0 | 20.0 | 12.0 | `config_futures.yaml:287,351,412` |
| **Position Size Multiplier** | 1.3 | 1.2 | 1.0 | `config_futures.yaml:233,296,360` |

### 1.2. –§–æ—Ä–º—É–ª—ã –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

#### Profit Harvesting (PH) - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥

```python
# –§–æ—Ä–º—É–ª–∞ –∏–∑ position_manager.py:1650-1651
if ph_threshold_type == "margin_percent" and ph_threshold_percent > 0:
    ph_threshold = margin_used * (ph_threshold_percent / 100.0)
```

**–ü—Ä–∏–º–µ—Ä –¥–ª—è RANGING:**
- `margin_used = $12.47`
- `ph_threshold_percent = 1.5%`
- `ph_threshold = $12.47 * 0.015 = $0.187`

#### Profit Drawdown (PD) - –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è

```python
# –§–æ—Ä–º—É–ª–∞ –∏–∑ position_manager.py:1780-1785
if min_profit_to_activate_type == "margin_percent":
    min_profit_to_activate_usd = margin_used * (min_profit_to_activate_percent / 100.0)
```

**–ü—Ä–∏–º–µ—Ä –¥–ª—è RANGING:**
- `margin_used = $12.47`
- `min_profit_to_activate_percent = 3.0%`
- `min_profit_to_activate_usd = $12.47 * 0.03 = $0.374`

#### Adaptive Leverage

```python
# –§–æ—Ä–º—É–ª–∞ –∏–∑ adaptive_leverage.py:88-93
adjusted_strength = signal_strength * regime_multiplier * volatility_multiplier
# regime_multiplier: trending=1.2, ranging=1.0, choppy=0.8
# volatility_multiplier: high_vol(>5%)=0.7, low_vol(<1%)=1.3
```

**–ü—Ä–∏–º–µ—Ä:**
- `signal_strength = 0.86`
- `regime = ranging` ‚Üí `regime_multiplier = 1.0`
- `volatility = 0.059` ‚Üí `volatility_multiplier = 1.0`
- `adjusted_strength = 0.86 * 1.0 * 1.0 = 0.86`
- `category = "strong"` ‚Üí `leverage = 20x`

### 1.3. –î–µ—Ç–µ–∫—Ü–∏—è —Ä–µ–∂–∏–º–∞ (ARM)

**–ê–ª–≥–æ—Ä–∏—Ç–º –∏–∑ `regime_manager.py:244-294`:**

```python
# 1. –†–∞—Å—á–µ—Ç ADX —á–µ—Ä–µ–∑ FastADX
adx_value = self.fast_adx.get_adx_value()
di_plus = self.fast_adx.get_di_plus()
di_minus = self.fast_adx.get_di_minus()

# 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
if adx_value >= trending_adx_threshold:  # 20.0
    regime = RegimeType.TRENDING
elif adx_value <= ranging_adx_threshold:  # 20.0
    regime = RegimeType.RANGING
else:
    regime = RegimeType.CHOPPY

# 3. Confidence calculation
confidence = min(1.0, adx_value / 25.0)  # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ—Ç–µ–∫—Ü–∏–∏:**
- `trending_adx_threshold: 20.0`
- `ranging_adx_threshold: 20.0`
- `high_volatility_threshold: 0.03` (3%)
- `lookback_candles: 50`
- `adx_period: 9`

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ä–µ–∂–∏–º–∞:**
- `ADX`, `+DI`, `-DI`
- `volatility` (ATR-based)
- `volume_ratio`
- `reversals` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤)

---

## 2. –õ–û–ì–ò–ö–ê –í–•–û–î–ê –í –ü–û–ó–ò–¶–ò–Æ

### 2.1. –¶–µ–ø–æ—á–∫–∞ –≤—Ö–æ–¥–∞

```
Signal Generator ‚Üí Filters ‚Üí Order Placement ‚Üí Position Open
```

**1. Signal Generation** (`signal_generator.py`)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (MA, MACD, BB, RSI)
- –†–∞—Å—á–µ—Ç `signal_strength` (0.0-1.0)

**2. Filters** (`signal_coordinator.py`)
- **ADX Filter**: `adx >= adx_threshold` (20.0 –¥–ª—è ranging)
- **MTF Filter**: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ 5m/15m —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ
- **Correlation Filter**: `correlation >= 0.7`
- **Pivot Points**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–∏–∑–æ—Å—Ç–∏ –∫ —É—Ä–æ–≤–Ω—è–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
- **Volume Profile**: –ü—Ä–æ–≤–µ—Ä–∫–∞ VA/POC
- **Order Flow**: –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤
- **Liquidity**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
- **Funding Rate**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–Ω–¥–∏–Ω–≥–∞

**3. Order Placement** (`entry_manager.py:186-418`)
- –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ `PositionSizer`
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ limit –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –±–∏—Ä–∂–µ
- –û–∂–∏–¥–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (retry –¥–æ 3 —Ä–∞–∑)

**4. Position Open** (`entry_manager.py:418-500`)
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `PositionRegistry`
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `TrailingStopLoss`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (`entry_time`, `regime`, `leverage`, `signal_strength`)

### 2.2. –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏

**–§–æ—Ä–º—É–ª–∞ –∏–∑ `position_sizer.py:47-115`:**

```python
# 1. –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä (–ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –±–∞–ª–∞–Ω—Å–∞)
risk_per_trade = get_risk_per_trade(regime)  # 1.5% –¥–ª—è ranging
base_size_usd = balance * risk_per_trade

# 2. –†–µ–∂–∏–º–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å
regime_multiplier = get_regime_multiplier(regime)  # 1.2 –¥–ª—è ranging
adjusted_size_usd = base_size_usd * regime_multiplier

# 3. Balance profile boost
size_boost = get_balance_boost(balance_profile)  # 1.0 –¥–ª—è micro
adjusted_size_usd = adjusted_size_usd * size_boost

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
max_size = margin_calculator.calculate_max_position_size(
    equity=balance, current_price=price, leverage=leverage
)
adjusted_size_usd = min(adjusted_size_usd, max_size * price)

# 5. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –º–æ–Ω–µ—Ç—ã
position_size_coins = adjusted_size_usd / price
```

**–ü—Ä–∏–º–µ—Ä –¥–ª—è DOGE-USDT (RANGING):**
- `balance = $50`
- `risk_per_trade = 1.5%` ‚Üí `base_size_usd = $0.75`
- `regime_multiplier = 1.2` ‚Üí `adjusted_size_usd = $0.90`
- `leverage = 20x` ‚Üí `max_size = $50 * 20 = $1000`
- `price = $0.13195` ‚Üí `position_size_coins = $0.90 / $0.13195 = 6.82 DOGE`
- **–ù–û:** –° —É—á–µ—Ç–æ–º `ctVal = 100.0` ‚Üí `size = 6.82 / 100 = 0.0682 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤`
- **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏:** `size = 1890 DOGE` (–∏–∑ –ª–æ–≥–æ–≤) = `18.9 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤` = `$249 notional`

### 2.3. –ü—Ä–∏–º–µ—Ä—ã –∏–∑ signals.csv

**–ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤**

–ò–∑ `signals_2025-12-21.csv`:
- **–í—Å–µ–≥–æ —Å–∏–≥–Ω–∞–ª–æ–≤:** 197
- **–ò—Å–ø–æ–ª–Ω–µ–Ω–æ:** 29 (14.7%)
- **–ü—Ä–∏—á–∏–Ω–∞:** `position_limit = 5` (–±–æ—Ç –Ω–µ –≤—Ö–æ–¥–∏—Ç –µ—Å–ª–∏ 5 –ø–æ–∑–∏—Ü–∏–π –æ—Ç–∫—Ä—ã—Ç–æ)

**–ü—Ä–∏–º–µ—Ä —Å–∏–≥–Ω–∞–ª–∞ —Å –Ω–∏–∑–∫–æ–π —Å–∏–ª–æ–π:**
```
timestamp: 2025-12-21T11:12:06.667307
symbol: DOGE-USDT
side: sell
strength: 1.0000  # ‚úÖ –í—ã—Å–æ–∫–∞—è —Å–∏–ª–∞
regime: ranging
filters_passed: ADX,MTF,Correlation,PivotPoints,VolumeProfile,Liquidity,OrderFlow,FundingRate
executed: 0  # ‚ùå –ù–ï –∏—Å–ø–æ–ª–Ω–µ–Ω (position limit?)
```

**–ü—Ä–∏–º–µ—Ä —Å–∏–≥–Ω–∞–ª–∞ —Å –Ω–∏–∑–∫–æ–π —Å–∏–ª–æ–π:**
```
timestamp: 2025-12-21T11:12:06.668305
symbol: XRP-USDT
side: sell
strength: 0.7846  # ‚ö†Ô∏è –°—Ä–µ–¥–Ω—è—è —Å–∏–ª–∞ (–Ω–æ > 0.7 –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
regime: ranging
filters_passed: ADX,MTF,Correlation,PivotPoints,VolumeProfile,Liquidity,OrderFlow,FundingRate
executed: 0  # ‚ùå –ù–ï –∏—Å–ø–æ–ª–Ω–µ–Ω
```

---

## 3. –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–ö–†–´–¢–û–ô –ü–û–ó–ò–¶–ò–ï–ô

### 3.1. –ü–æ—á–µ–º—É –¥–µ—Ä–∂–∏—Ç –¥–æ–ª–≥–æ?

**–ü—Ä–∏—á–∏–Ω—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–¥–µ—Ä–∂–∞–Ω–∏—è:**

1. **Max Holding - Soft Stop** (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
   - –ü–æ–∑–∏—Ü–∏—è –≤ —É–±—ã—Ç–∫–µ ‚Üí –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ max_holding
   - –õ–æ–≥–∏–∫–∞: `if pnl_percent < 0: return {"action": "hold"}`

2. **profit_too_low_vs_peak** (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
   - –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã—Ö–æ–¥ –µ—Å–ª–∏ `pnl_percent < peak_profit_pct * 0.7`
   - –ü—Ä–æ–±–ª–µ–º–∞: –ë–ª–æ–∫–∏—Ä–æ–≤–∞–ª –¥–∞–∂–µ –º–∏–∫—Ä–æ–ø—Ä–∏–±—ã–ª–∏ (< 0.5%)
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–±—ã–ª–µ–π > 0.5%

3. **TSL (Trailing Stop Loss)**
   - –ó–∞—â–∏—â–∞–µ—Ç –ø—Ä–∏–±—ã–ª—å, –Ω–æ –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –¥–æ–ª–≥–æ
   - `trail_percent = 2.0%`, `losscut_percent = 4.0%`

4. **LiquidationGuard**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `margin_ratio >= safety_threshold` (1.5 –¥–ª—è ranging)
   - –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –µ—Å–ª–∏ `margin_ratio` –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∑–∫–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫)

### 3.2. –†–∞—Å—á–µ—Ç –º–∞—Ä–∂–∏

**–§–æ—Ä–º—É–ª–∞ –∏–∑ `margin_calculator.py:127-153`:**

```python
# 1. Margin used
margin_used = position_value / leverage

# 2. Available margin
available_margin = equity - margin_used + pnl

# 3. Margin ratio
margin_ratio = available_margin / margin_used
```

**–ü—Ä–æ–±–ª–µ–º–∞: –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É position equity –∏ profile equity**

–ò–∑ `margin_calculator.py:771-806`:
- –î–ª—è **–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–∞—Ä–∂–∏** OKX: `equity = margin + unrealizedPnl`
- –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç `equity` —á–µ—Ä–µ–∑ `get_margin_info(symbol)` - —ç—Ç–æ equity **–ø–æ–∑–∏—Ü–∏–∏**, –Ω–µ –ø—Ä–æ—Ñ–∏–ª—è
- –ï—Å–ª–∏ `equity` –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí fallback –Ω–∞ –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–æ–≤:**
```
margin_ratio: 0.10  # ‚ùå –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∑–∫–∏–π
equity: $25.00
margin_used: $12.47
pnl: -$0.50
available_margin: $12.03
margin_ratio = $12.03 / $12.47 = 0.96  # –ù–æ –≤ –ª–æ–≥–∞—Ö 0.10?
```

**–ü—Ä–∏—á–∏–Ω–∞:** –í–æ–∑–º–æ–∂–Ω–∞ –æ—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –º–∞–ª—ã—Ö –ø–æ–∑–∏—Ü–∏–π —Å –±–æ–ª—å—à–∏–º `ctVal` (XRP —Å `ctVal=100.0`)

### 3.3. Risk Checks

**is_position_safe** (`margin_calculator.py:155-527`):

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
is_safe = margin_ratio >= safety_threshold  # 1.5 –¥–ª—è ranging

# –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
if margin_ratio < 0 and equity > 0:
    pnl_percent = abs(pnl) / equity
    if pnl_percent < 0.15:  # PnL < 15% –æ—Ç –±–∞–ª–∞–Ω—Å–∞
        # –í–µ—Ä–æ—è—Ç–Ω–∞ –æ—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞
        margin_ratio = equity / margin_used  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
```

**handle_risk_level** (`liquidation_guard.py:247-356`):

```python
# –£—Ä–æ–≤–Ω–∏ —Ä–∏—Å–∫–∞
if margin_ratio >= 2.5: risk_level = "safe"
elif margin_ratio >= 1.8: risk_level = "good"
elif margin_ratio >= 1.3: risk_level = "warning"
elif margin_ratio >= 1.1: risk_level = "danger"
else: risk_level = "critical"  # –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π:**
- –ï—Å–ª–∏ `margin_ratio <= 1.5` –∏ `abs(pnl) < 10` ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ
- –ï—Å–ª–∏ `available_margin < -1000` –∏ `abs(pnl) < 100` ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ
- –ï—Å–ª–∏ `margin_ratio <= 0.5` –∏ `equity > 0` ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ

### 3.4. –ü—Ä–∏–º–µ—Ä—ã –¥–ª–∏–Ω–Ω—ã—Ö holds –∏–∑ trades.csv

**–ü—Ä–æ–±–ª–µ–º–∞: –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤ –ø–æ–∑–∏—Ü–∏–∏**

–ò–∑ `trades_2025-12-21.csv`:
```
symbol: BTC-USDT
duration_sec: -10751.756575  # ‚ùå –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è!
reason: sl_reached
```

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ —Ä–∞—Å—á–µ—Ç–µ `entry_time` (timezone mismatch)
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `timezone.utc` –≤ `exit_analyzer.py:508-520`

**–ü—Ä–æ–±–ª–µ–º–∞: –î–æ–ª–≥–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ**

–ò–∑ `trades_2025-12-21.csv`:
```
symbol: BTC-USDT
duration_sec: 18091.569292  # 5 —á–∞—Å–æ–≤!
reason: sl_reached
net_pnl: -$1.1350
```

**–ü—Ä–∏—á–∏–Ω–∞:** Max holding soft stop –Ω–µ –∑–∞–∫—Ä—ã–ª —É–±—ã—Ç–æ—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω `max_holding_hard_stop: true` –∏ `timeout_loss_percent: 1.5%`

---

## 4. –õ–û–ì–ò–ö–ê –í–´–•–û–î–ê

### 4.1. ExitAnalyzer - –£—Å–ª–æ–≤–∏—è –≤—ã—Ö–æ–¥–∞

**–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è RANGING** (`exit_analyzer.py:1630-2076`):

1. **profit_too_low_vs_peak** (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–±—ã–ª–µ–π > 0.5%)
   ```python
   if pnl_percent > 0.5 and pnl_percent < peak_profit_pct * 0.7:
       return {"action": "hold", "reason": "profit_too_low_vs_peak"}
   ```

2. **SL (Stop Loss)**
   ```python
   sl_threshold = -sl_percent - spread_buffer  # -0.8% - 0.05% = -0.85%
   if pnl_percent <= sl_threshold:
       return {"action": "close", "reason": "sl_reached"}
   ```

3. **TP (Take Profit)**
   ```python
   if pnl_percent >= tp_percent:  # >= 2.0%
       return {"action": "close", "reason": "tp_reached"}
   ```

4. **Big Profit Exit**
   ```python
   if pnl_percent >= big_profit_exit_percent:  # >= 1.5%
       return {"action": "close", "reason": "big_profit_exit"}
   ```

5. **Partial TP**
   ```python
   if pnl_percent >= trigger_percent:  # >= 0.6%
       # –ó–∞–∫—Ä—ã–≤–∞–µ–º 60% –ø–æ–∑–∏—Ü–∏–∏
       return {"action": "partial_close", "reason": "partial_tp"}
   ```

6. **Max Holding**
   ```python
   if max_holding_hard_stop:
       if abs(pnl_percent) >= timeout_loss_percent:  # >= 1.5%
           return {"action": "close", "reason": "max_holding_hard_stop_timeout_loss"}
   ```

### 4.2. Profit Harvesting (PH)

**–§–æ—Ä–º—É–ª–∞ –∏–∑ `position_manager.py:1510-1850`:**

```python
# 1. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥
ph_threshold = margin_used * (ph_threshold_percent / 100.0)  # 1.5% –¥–ª—è ranging

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
time_since_open = current_timestamp - entry_timestamp
if time_since_open > ph_time_limit:  # 1200 —Å–µ–∫ –¥–ª—è ranging
    return False

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–±—ã–ª–∏
pnl_usd = size_in_coins * (entry_price - current_price)  # –¥–ª—è short
commission = position_value * trading_fee_rate * 2 * leverage
net_pnl_usd = pnl_usd - commission

if net_pnl_usd >= ph_threshold:
    return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ PH
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–æ–≤:**
```
symbol: SOL-USDT
margin_used: $12.47
ph_threshold_percent: 1.5%
ph_threshold: $12.47 * 0.015 = $0.187
net_pnl_usd: $2.64
time_since_open: 267 —Å–µ–∫ (< 1200 —Å–µ–∫)
‚Üí PH —Å—Ä–∞–±–æ—Ç–∞–ª ‚úÖ
```

### 4.3. Profit Drawdown (PD)

**–§–æ—Ä–º—É–ª–∞ –∏–∑ `position_manager.py:1780-1850`:**

```python
# 1. –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è
min_profit_to_activate_usd = margin_used * (min_profit_to_activate_percent / 100.0)  # 3.0%

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ peak profit
if peak_profit_usd >= min_profit_to_activate_usd:
    # PD –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
    drawdown = peak_profit_usd - current_profit_usd
    drawdown_percent = (drawdown / peak_profit_usd) * 100
    
    if drawdown_percent >= drawdown_threshold:  # 30%
        return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ PD
```

**–ü—Ä–∏–º–µ—Ä:**
```
margin_used: $12.47
min_profit_to_activate_usd: $12.47 * 0.03 = $0.374
peak_profit_usd: $0.43
current_profit_usd: $0.15
drawdown: $0.43 - $0.15 = $0.28
drawdown_percent: ($0.28 / $0.43) * 100 = 65% > 30%
‚Üí PD —Å—Ä–∞–±–æ—Ç–∞–ª ‚úÖ
```

### 4.4. –ü–æ—á–µ–º—É –º–µ–ª–∫–∏–µ –ø—Ä–æ—Ñ–∏—Ç—ã vs –±–æ–ª—å—à–∏–µ —É–±—ã—Ç–∫–∏?

**–ü—Ä–æ–±–ª–µ–º–∞ –∏–∑ trades.csv:**

| –°–¥–µ–ª–∫–∞ | Gross PnL | Commission | Net PnL | –ü—Ä–æ–±–ª–µ–º–∞ |
|--------|-----------|------------|---------|----------|
| DOGE | +$0.0524 | -$0.0640 | -$0.0116 | ‚ùå –ö–æ–º–∏—Å—Å–∏—è > Profit |
| ETH | +$0.0350 | -$0.0755 | -$0.0405 | ‚ùå –ö–æ–º–∏—Å—Å–∏—è > Profit |
| SOL | +$2.93 | -$0.29 | +$2.64 | ‚úÖ OK |

**–ü—Ä–∏—á–∏–Ω–∞:**

1. **–ö–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**
   - –§–æ—Ä–º—É–ª–∞: `commission = position_value * trading_fee_rate * 2 * leverage`
   - –î–ª—è `leverage = 20x`: `commission = $249 * 0.0002 * 2 * 20 = $1.992`
   - **–ù–û:** –ö–æ–º–∏—Å—Å–∏—è –Ω–∞ –±–∏—Ä–∂–µ = `$0.25` (0.05% taker x2)
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö

2. **PnL% —Ä–∞—Å—á–µ—Ç –æ—Ç –º–∞—Ä–∂–∏, –∞ –Ω–µ –æ—Ç —Ü–µ–Ω—ã**
   ```python
   # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç (–æ—Ç –º–∞—Ä–∂–∏)
   pnl_percent = (unrealized_pnl / margin_used) * 100
   
   # –ö–æ–º–∏—Å—Å–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
   commission_pct = (trading_fee_rate * 2) * leverage * 100
   # = 0.0002 * 2 * 20 * 100 = 0.8%
   
   # Net PnL%
   net_pnl_pct = gross_pnl_pct - commission_pct
   ```

3. **–ú–∏–∫—Ä–æ–ø—Ä–∏–±—ã–ª–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è profit_too_low_vs_peak**
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–±—ã–ª–µ–π > 0.5%

### 4.5. –ü—Ä–∏–º–µ—Ä—ã bad exits –∏–∑ trades.csv

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏–π:**
- **SL reached:** 81% (26 –∏–∑ 32 —Å–¥–µ–ª–æ–∫)
- **TP reached:** 12.5% (4 —Å–¥–µ–ª–∫–∏)
- **Profit Harvest:** 3.1% (1 —Å–¥–µ–ª–∫–∞)
- **Max Holding:** 3.1% (1 —Å–¥–µ–ª–∫–∞)

**–ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç SL**

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ù–∏–∑–∫–∏–π `min_signal_strength` (–±—ã–ª–æ 0.25, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ 0.7)
2. –°–ª–∞–±—ã–µ —Å–∏–≥–Ω–∞–ª—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —Ñ–∏–ª—å—Ç—Ä—ã
3. SL —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ (0.8% –¥–ª—è ranging)
4. –ö–æ–º–∏—Å—Å–∏—è —Å—ä–µ–¥–∞–µ—Ç –º–∏–∫—Ä–æ–ø—Ä–∏–±—ã–ª–∏

---

## 5. –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê –ò –ú–ï–¢–ê–î–ê–ù–ù–´–ï

### 5.1. –§–æ—Ä–º—É–ª—ã PnL

**Gross PnL% (–æ—Ç –º–∞—Ä–∂–∏):**
```python
# –ò–∑ exit_analyzer.py:414
gross_pnl_pct = (unrealized_pnl / margin_used) * 100
```

**Net PnL% (—Å –∫–æ–º–∏—Å—Å–∏–µ–π):**
```python
# –ò–∑ exit_analyzer.py:479-482
commission_pct = (trading_fee_rate * 2) * leverage * 100
net_pnl_pct = gross_pnl_pct - commission_pct
```

**–ü—Ä–∏–º–µ—Ä:**
```
unrealized_pnl: $0.40
margin_used: $12.47
gross_pnl_pct: ($0.40 / $12.47) * 100 = 3.21%
commission_pct: 0.0002 * 2 * 20 * 100 = 0.8%
net_pnl_pct: 3.21% - 0.8% = 2.41%
```

**Gross PnL% (–æ—Ç —Ü–µ–Ω—ã) - Fallback:**
```python
# –ò–∑ exit_analyzer.py:498-501
if position_side == "long":
    gross_profit_pct = (current_price - entry_price) / entry_price * 100
else:  # short
    gross_profit_pct = (entry_price - current_price) / entry_price * 100
```

### 5.2. –õ–∏–∫–≤–∏–¥–∞—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–Ω–∞

**–§–æ—Ä–º—É–ª–∞ –∏–∑ `margin_calculator.py:79-125`:**

```python
# –î–ª—è LONG
liquidation_price = entry_price * (1 - (1 / leverage) + maintenance_margin_ratio)
# = entry_price * (1 - (1/20) + 0.01) = entry_price * 0.96

# –î–ª—è SHORT
liquidation_price = entry_price * (1 + (1 / leverage) - maintenance_margin_ratio)
# = entry_price * (1 + (1/20) - 0.01) = entry_price * 1.04
```

**–ü—Ä–∏–º–µ—Ä –¥–ª—è DOGE-USDT:**
```
entry_price: $0.13195
leverage: 20x
maintenance_margin_ratio: 0.01
liquidation_price (SHORT): $0.13195 * 1.04 = $0.13723
distance_to_liquidation: (($0.13723 - $0.13195) / $0.13195) * 100 = 4.0%
```

### 5.3. Drawdown (peak-current)

**–§–æ—Ä–º—É–ª–∞:**
```python
drawdown = peak_profit_usd - current_profit_usd
drawdown_percent = (drawdown / peak_profit_usd) * 100
```

**–ü—Ä–∏–º–µ—Ä:**
```
peak_profit_usd: $0.43
current_profit_usd: $0.15
drawdown: $0.43 - $0.15 = $0.28
drawdown_percent: ($0.28 / $0.43) * 100 = 65%
```

### 5.4. Regime Confidence

**–§–æ—Ä–º—É–ª–∞ –∏–∑ `regime_manager.py:292-294`:**

```python
confidence = min(1.0, adx_value / 25.0)
```

**–ü—Ä–∏–º–µ—Ä:**
```
adx_value: 22.0
confidence: min(1.0, 22.0 / 25.0) = 0.88 (88%)
```

### 5.5. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ - Timezone

**–ü—Ä–æ–±–ª–µ–º–∞: –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤ –ø–æ–∑–∏—Ü–∏–∏**

**–ü—Ä–∏—á–∏–Ω–∞:** Timezone mismatch –º–µ–∂–¥—É `entry_time` –∏ `current_time`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `exit_analyzer.py:508-520`:**

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ entry_time –≤ UTC
if isinstance(entry_time, datetime):
    if entry_time.tzinfo is None:
        entry_time = entry_time.replace(tzinfo=timezone.utc)
    elif entry_time.tzinfo != timezone.utc:
        entry_time = entry_time.astimezone(timezone.utc)
    
seconds_since_open = (datetime.now(timezone.utc) - entry_time).total_seconds()
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `trading_control_center.py`:**

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º timezone-aware datetime
from datetime import datetime as dt, timezone

entry_time = dt.now(timezone.utc)  # –í–º–µ—Å—Ç–æ datetime.now()
```

### 5.6. Duration Calculation

**–§–æ—Ä–º—É–ª–∞:**
```python
duration_sec = (exit_time - entry_time).total_seconds()
duration_min = duration_sec / 60.0
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑-–∑–∞ timezone mismatch
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `timezone.utc` –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è (`time_since_open < 0` –∏–ª–∏ `> 7 days`)

---

## 6. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

### 6.1. –ß—Ç–æ –Ω–µ –¥–æ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è?

**1. LiquidationGuard - –ù–µ–ø–æ–ª–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏**

–ò–∑ `liquidation_guard.py:275-290`:
```python
message = f"‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: {symbol} {side} - –Ω–∏–∑–∫–∞—è –º–∞—Ä–∂–∞ {margin_ratio:.1f}%"
logger.warning(message)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–Ω–æ–≥–¥–∞ –ª–æ–≥–∏ –æ–±—Ä—ã–≤–∞—é—Ç—Å—è –Ω–∞ `"?,"` –∏–ª–∏ `"."`
- **–ü—Ä–∏—á–∏–Ω–∞:** –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**2. PRE_CLOSE - –ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**

–ò–∑ `orchestrator.py:_close_position`:
```python
logger.info(
    f"üìä [PRE_CLOSE] {symbol} | "
    f"Unrealized PnL: ${unrealized_pnl:.4f} | "
    f"Margin used: ${margin_used:.4f} | "
    f"Regime: {regime} | "
    f"Leverage: {leverage}x | "
    f"Signal strength: {signal_strength:.2f}"
)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–Ω–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `0.0000` –∏–ª–∏ `unknown`
- **–ü—Ä–∏—á–∏–Ω–∞:** –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ `position_registry.metadata`

### 6.2. –ü—Ä–∏–º–µ—Ä—ã –∏–∑ –ª–æ–≥–æ–≤

**1. datetime ERROR (TCC)**

–ò–∑ `errors_2025-12-21.log`:
```
‚ùå TCC: –û—à–∏–±–∫–∞ –≤ —Ç–æ—Ä–≥–æ–≤–æ–º —Ü–∏–∫–ª–µ: cannot access local variable 'datetime' where it is not associated with a value
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–µ–Ω `datetime` (–º–æ–¥—É–ª—å vs –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è)
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** `from datetime import datetime as dt, timezone`

**2. Margin Ratio Discrepancy**

–ò–∑ –ª–æ–≥–æ–≤:
```
margin_ratio: 0.10  # ‚ùå –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∑–∫–∏–π
equity: $25.00
margin_used: $12.47
```

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –º–∞–ª—ã—Ö –ø–æ–∑–∏—Ü–∏–π —Å –±–æ–ª—å—à–∏–º `ctVal`
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –≤ `margin_calculator.py:407-435`

**3. Exchange-side Closure Detection**

–ò–∑ `orchestrator.py:2112-2128`:
```
üö® –û–ë–ù–ê–†–£–ñ–ï–ù–û –ó–ê–ö–†–´–¢–ò–ï –ù–ê –ë–ò–†–ñ–ï: BTC-USDT
‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ, –Ω–æ –ù–ï —á–µ—Ä–µ–∑ –±–æ—Ç–∞!
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## 7. –ö–õ–Æ–ß–ï–í–´–ï –ü–†–û–ë–õ–ï–ú–´

### 7.1. –ü–æ—á–µ–º—É long holds?

1. **Max Holding Soft Stop** (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
   - –£–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∏—Å—å –ø–æ max_holding
   - **–†–µ—à–µ–Ω–∏–µ:** `max_holding_hard_stop: true` + `timeout_loss_percent: 1.5%`

2. **profit_too_low_vs_peak** (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤—ã—Ö–æ–¥ –¥–ª—è –º–∏–∫—Ä–æ–ø—Ä–∏–±—ã–ª–µ–π
   - **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω absolute threshold 0.5%

3. **TSL Protection**
   - –ó–∞—â–∏—â–∞–µ—Ç –ø—Ä–∏–±—ã–ª—å, –Ω–æ –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –¥–æ–ª–≥–æ
   - **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∑–∞–¥—É–º–∞–Ω–æ

### 7.2. –ü–æ—á–µ–º—É losses > profits?

1. **–ù–∏–∑–∫–∏–π Win Rate (15.62%)**
   - **–ü—Ä–∏—á–∏–Ω–∞:** –ù–∏–∑–∫–∏–π `min_signal_strength` (–±—ã–ª–æ 0.25)
   - **–†–µ—à–µ–Ω–∏–µ:** –ü–æ–¥–Ω—è—Ç–æ –¥–æ 0.7 –¥–ª—è ranging

2. **SL —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ (0.8%)**
   - **–°—Ç–∞—Ç—É—Å:** –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º Grok (0.6-0.8%)

3. **–ö–æ–º–∏—Å—Å–∏—è —Å—ä–µ–¥–∞–µ—Ç –º–∏–∫—Ä–æ–ø—Ä–∏–±—ã–ª–∏**
   - **–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö
   - **–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

### 7.3. –ü–æ—á–µ–º—É –º–µ–ª–∫–∏–µ –ø—Ä–æ—Ñ–∏—Ç—ã?

1. **PH —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–Ω–æ**
   - **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥ –æ—Ç –º–∞—Ä–∂–∏)

2. **Partial TP –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**
   - **–ü—Ä–∏—á–∏–Ω–∞:** `min_partial_tp_value_usd: 10.0` —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ
   - **–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç —Å–Ω–∏–∂–µ–Ω–∏—è –¥–æ 3.0

3. **–ö–æ–º–∏—Å—Å–∏—è > Profit**
   - **–ü—Ä–∏—á–∏–Ω–∞:** –ú–∏–∫—Ä–æ–ø—Ä–∏–±—ã–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –¥–æ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–º–∏—Å—Å–∏–∏
   - **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `min_profit_after_commission` –≤ partial TP

---

## 8. JSON SUMMARY

```json
{
  "regimes": {
    "trending": {
      "tp_percent": 2.5,
      "sl_percent": 0.8,
      "max_holding_minutes": 40,
      "leverage_range": [3, 30],
      "margin_safety": 1.3,
      "risk_per_trade": 1.0,
      "ph_threshold_percent": 2.5,
      "min_signal_strength": 0.8
    },
    "ranging": {
      "tp_percent": 2.0,
      "sl_percent": 0.8,
      "max_holding_minutes": 25,
      "max_holding_hard_stop": true,
      "timeout_loss_percent": 1.5,
      "leverage_range": [3, 30],
      "margin_safety": 1.5,
      "risk_per_trade": 1.5,
      "ph_threshold_percent": 1.5,
      "min_signal_strength": 0.7
    },
    "choppy": {
      "tp_percent": 1.8,
      "sl_percent": 1.0,
      "max_holding_minutes": 14,
      "leverage_range": [3, 30],
      "margin_safety": 1.1,
      "risk_per_trade": 2.0,
      "ph_threshold_percent": 1.0,
      "min_signal_strength": 0.6
    }
  },
  "params": {
    "adaptive_ph": true,
    "adaptive_pd": true,
    "adaptive_leverage": true,
    "regime_detection": "ARM",
    "adx_threshold_trending": 20.0,
    "adx_threshold_ranging": 20.0,
    "adx_threshold_choppy": 12.0
  },
  "bugs": [
    {
      "id": "datetime_error_tcc",
      "status": "fixed",
      "description": "cannot access local variable 'datetime'",
      "fix": "from datetime import datetime as dt, timezone"
    },
    {
      "id": "negative_time",
      "status": "fixed",
      "description": "Negative duration_sec in trades.csv",
      "fix": "Added timezone.utc validation"
    },
    {
      "id": "str_vs_int_comparison",
      "status": "fixed",
      "description": "'>' not supported between instances of 'str' and 'int'",
      "fix": "Added float() conversions in exit_analyzer.py"
    },
    {
      "id": "margin_ratio_discrepancy",
      "status": "partial",
      "description": "margin_ratio 0.10 vs expected 0.96",
      "fix": "Added protection for small positions with large ctVal"
    },
    {
      "id": "commission_overestimation",
      "status": "needs_verification",
      "description": "Bot overestimates commission in calculations",
      "impact": "Microprofits blocked by commission check"
    }
  ],
  "examples": [
    {
      "type": "signal",
      "file": "signals_2025-12-21.csv",
      "total": 197,
      "executed": 29,
      "conversion_rate": 0.147
    },
    {
      "type": "trade",
      "file": "trades_2025-12-21.csv",
      "total": 32,
      "win_rate": 0.1562,
      "net_pnl": -9.92,
      "sl_reached": 26,
      "tp_reached": 4
    },
    {
      "type": "long_hold",
      "symbol": "BTC-USDT",
      "duration_sec": 18091,
      "reason": "sl_reached",
      "net_pnl": -1.1350
    },
    {
      "type": "microprofit",
      "symbol": "DOGE-USDT",
      "gross_pnl": 0.0524,
      "commission": 0.0640,
      "net_pnl": -0.0116
    }
  ]
}
```

---

## 9. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 9.1. –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

1. ‚úÖ –ü–æ–¥–Ω—è—Ç—å `min_signal_strength` –¥–æ 0.7-0.9
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å `max_holding_hard_stop` + `timeout_loss_percent`
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `profit_too_low_vs_peak` (absolute threshold 0.5%)
4. ‚úÖ –ü–æ–¥–Ω—è—Ç—å ADX threshold –¥–æ 20.0 –¥–ª—è ranging
5. ‚úÖ –ü–æ–¥–Ω—è—Ç—å margin safety –¥–æ 1.5 –¥–ª—è ranging
6. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å datetime error –≤ TCC
7. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å negative time bug

### 9.2. –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (—Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)

1. ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ (–≤–æ–∑–º–æ–∂–Ω–∞ –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞)
2. ‚ö†Ô∏è –°–Ω–∏–∑–∏—Ç—å `min_partial_tp_value_usd` —Å 10.0 –¥–æ 3.0
3. ‚ö†Ô∏è –£–ª—É—á—à–∏—Ç—å margin ratio —Ä–∞—Å—á–µ—Ç –¥–ª—è –º–∞–ª—ã—Ö –ø–æ–∑–∏—Ü–∏–π
4. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä: –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –µ—Å–ª–∏ `PnL < commission`

### 9.3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. üìä –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—É–±—Ä–∞—Ç—å —Å–ø–∞–º, –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏)
2. üìä –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å TCC cycle time (27-28 —Å–µ–∫ ‚Üí < 20 —Å–µ–∫)
3. üìä –£–ª—É—á—à–∏—Ç—å signal conversion rate (14.7% ‚Üí > 30%)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-21  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω  
**–ì–æ—Ç–æ–≤–æ –¥–ª—è:** –ü–µ—Ä–µ–¥–∞—á–∏ Grok –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–±–æ—Ä–∞




