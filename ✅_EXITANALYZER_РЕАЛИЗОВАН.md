# ‚úÖ EXITANALYZER –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù!

## üéâ –í–´–ü–û–õ–ù–ï–ù–û

### 1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω ExitAnalyzer –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤:

**TRENDING —Ä–µ–∂–∏–º:**
- ‚úÖ –ê–Ω–∞–ª–∏–∑ PnL —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ TP (Take Profit) —Å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–¥–µ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ big_profit_exit
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ partial_tp
- ‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–∏–ª—ã —Ç—Ä–µ–Ω–¥–∞ —á–µ—Ä–µ–∑ ADX
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ —á–µ—Ä–µ–∑ Order Flow –∏ MTF
- ‚úÖ –ü—Ä–æ–¥–ª–µ–Ω–∏–µ TP –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–¥–µ (ADX >= 25, strength >= 0.7)

**RANGING —Ä–µ–∂–∏–º:**
- ‚úÖ –ê–Ω–∞–ª–∏–∑ PnL —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ TP (Take Profit) - –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ä–∞–∑—É (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ big_profit_exit
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ partial_tp
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç–µ —Å –ø—Ä–∏–±—ã–ª—å—é > 0.3%
- ‚úÖ –ù–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç TP - –±–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥

**CHOPPY —Ä–µ–∂–∏–º:**
- ‚úÖ –ê–Ω–∞–ª–∏–∑ PnL —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ TP (Take Profit) - –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ä–∞–∑—É (–º–µ–Ω—å—à–∏–π TP)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ big_profit_exit
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ partial_tp - –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç 70% –ø–æ–∑–∏—Ü–∏–∏)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ - –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ä–∞–∑—É
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–∫—Ä—ã—Ç–∏—è - –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç TP

---

### 2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

- ‚úÖ `_calculate_pnl_percent()` - —Ä–∞—Å—á–µ—Ç PnL% —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏
- ‚úÖ `_get_tp_percent()` - –ø–æ–ª—É—á–µ–Ω–∏–µ TP% –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –ø–æ —Å–∏–º–≤–æ–ª—É –∏ —Ä–µ–∂–∏–º—É
- ‚úÖ `_get_big_profit_exit_percent()` - –ø–æ–ª—É—á–µ–Ω–∏–µ big_profit_exit% –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
- ‚úÖ `_get_partial_tp_params()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ partial_tp –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
- ‚úÖ `_analyze_trend_strength()` - –∞–Ω–∞–ª–∏–∑ —Å–∏–ª—ã —Ç—Ä–µ–Ω–¥–∞ —á–µ—Ä–µ–∑ ADX
- ‚úÖ `_check_reversal_signals()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ (Order Flow, MTF)

---

### 3. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ trailing_sl_coordinator:

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `exit_analyzer` –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ `__init__`
- ‚úÖ –í—ã–∑–æ–≤ `ExitAnalyzer.analyze_position()` –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π TSL
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—à–µ–Ω–∏–π ExitAnalyzer:
  - `action: "close"` ‚Üí –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏
  - `action: "partial_close"` ‚Üí —á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å)
  - `action: "extend_tp"` ‚Üí –ø—Ä–æ–¥–ª–µ–Ω–∏–µ TP (TSL –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è)

---

### 4. ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ orchestrator:

- ‚úÖ –ò–º–ø–æ—Ä—Ç ExitAnalyzer
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ ExitAnalyzer –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è fast_adx –∏ order_flow
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ orchestrator, config_manager, signal_generator
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ ExitAnalyzer –≤ trailing_sl_coordinator

---

## üìä –õ–û–ì–ò–ö–ê –ó–ê–ö–†–´–¢–ò–Ø

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫:

1. **TP (Take Profit)** - –∑–∞–∫—Ä—ã—Ç–∏–µ/–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP
2. **Big Profit Exit** - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫—Ä—É–ø–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏
3. **Partial TP** - —á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞
4. **–†–∞–∑–≤–æ—Ä–æ—Ç** - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ (Order Flow, MTF)
5. **–ü—Ä–æ–¥–ª–µ–Ω–∏–µ TP** - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ TP –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–¥–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è trending —Ä–µ–∂–∏–º–∞)

### –†–µ—à–µ–Ω–∏—è ExitAnalyzer:

```python
{
    "action": "close" | "partial_close" | "extend_tp",
    "reason": "tp_reached" | "big_profit_exit" | "partial_tp" | "reversal_detected" | "strong_trend_extend_tp",
    "pnl_pct": float,
    "tp_percent": float,  # –¥–ª—è tp_reached
    "big_profit_exit_percent": float,  # –¥–ª—è big_profit_exit
    "trigger_percent": float,  # –¥–ª—è partial_tp
    "fraction": float,  # –¥–ª—è partial_close (0.0-1.0)
    "new_tp": float,  # –¥–ª—è extend_tp
    "trend_strength": float,  # –¥–ª—è extend_tp (0-1)
}
```

---

## ‚úÖ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –†–ï–°–£–†–°–û–í –ë–û–¢–ê

ExitAnalyzer –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –±–æ—Ç–∞:

1. ‚úÖ **ADX (FastADX)** - –∞–Ω–∞–ª–∏–∑ —Å–∏–ª—ã —Ç—Ä–µ–Ω–¥–∞
2. ‚úÖ **Order Flow** - –∞–Ω–∞–ª–∏–∑ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ —á–µ—Ä–µ–∑ delta
3. ‚úÖ **MTF (Multi-Timeframe)** - –∞–Ω–∞–ª–∏–∑ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ –Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–º —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ
4. ‚úÖ **ConfigManager** - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ TP, big_profit_exit, partial_tp
5. ‚úÖ **PositionRegistry** - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–∏ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
6. ‚úÖ **DataRegistry** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–∂–∏–º–∞

---

## üîß –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø

### –í trailing_sl_coordinator.update_trailing_stop_loss():

```python
# ‚úÖ –ù–û–í–û–ï: –í—ã–∑—ã–≤–∞–µ–º ExitAnalyzer –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π TSL
exit_decision = await self.exit_analyzer.analyze_position(symbol)
if exit_decision:
    action = exit_decision.get("action")
    if action == "close":
        await self.close_position_callback(symbol, exit_decision.get("reason"))
        return  # –ó–∞–∫—Ä—ã–ª–∏ —á–µ—Ä–µ–∑ ExitAnalyzer
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ partial_close –∏ extend_tp
```

---

## ‚ö†Ô∏è –û–°–¢–ê–õ–û–°–¨ –†–ï–ê–õ–ò–ó–û–í–ê–¢–¨

1. **Partial Close (—á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ)** - TODO –≤ trailing_sl_coordinator
2. **Extend TP (–ø—Ä–æ–¥–ª–µ–Ω–∏–µ TP)** - –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è TP (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è TP –≤ position_manager)
3. **ExitDecisionLogger** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π ExitAnalyzer (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üìã –ü–†–û–í–ï–†–ö–ê

### –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. ‚úÖ ExitAnalyzer —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ orchestrator
2. ‚úÖ ExitAnalyzer –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ trailing_sl_coordinator
3. ‚úÖ ExitAnalyzer –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
4. ‚úÖ ExitAnalyzer –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ADX, Order Flow, MTF
5. ‚úÖ ExitAnalyzer –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TP, big_profit_exit, partial_tp
6. ‚úÖ ExitAnalyzer —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤ (trending, ranging, choppy)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** ‚ö†Ô∏è –î–∞
**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:** ‚úÖ –î–∞



