# üìä –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤

## üîç –ü—Ä–æ–±–ª–µ–º–∞
–ë–æ—Ç —Å—Ç–∞–≤–∏—Ç –ª–∏–º–∏—Ç-–æ—Ä–¥–µ—Ä —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç —Ü–µ–Ω—ã, –∂–¥—ë—Ç ‚Üí –æ—Ç–º–µ–Ω—è–µ—Ç ‚Üí –º–∞—Ä–∫–µ—Ç, –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –ø–æ—Å—Ç–∞–≤–∏—Ç—å –±–ª–∏–∂–µ –∫ —Å–ø—Ä–µ–¥—É –∏ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –∫–æ–º–∏—Å—Å–∏–∏.

---

## üìÅ –§–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### 1. –ö–æ–Ω—Ñ–∏–≥ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤
**–§–∞–π–ª:** `config/config_futures.yaml` (—Å—Ç—Ä–æ–∫–∏ 1067-1138)

```yaml
order_executor:
  limit_order:
    limit_offset_percent: 0.02  # –ì–ª–æ–±–∞–ª—å–Ω—ã–π offset 0.02%
    max_wait_seconds: 60  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ (60 —Å–µ–∫)
    auto_cancel_enabled: true  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
    auto_replace_enabled: true  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞ –æ—Ä–¥–µ—Ä–∞ —Å –Ω–æ–≤–æ–π —Ü–µ–Ω–æ–π
    replace_with_market: true  # –ó–∞–º–µ–Ω—è—Ç—å –Ω–∞ —Ä—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
    post_only: true  # Maker fee 0.02% –≤–º–µ—Å—Ç–æ taker 0.05%
    
    by_regime:
      trending:
        limit_offset_percent: 0.02  # 0.02% –æ—Ç —Ü–µ–Ω—ã
        max_wait_seconds: 45
      ranging:
        limit_offset_percent: 0.03  # 0.03% –æ—Ç —Ü–µ–Ω—ã
        max_wait_seconds: 45
      choppy:
        limit_offset_percent: 0.02
        max_wait_seconds: 30
    
    by_symbol:
      "DOGE-USDT":
        limit_offset_percent: 0.08  # 0.08% –æ—Ç —Ü–µ–Ω—ã
        by_regime:
          ranging:
            limit_offset_percent: 0.15  # ‚ùå –ü–†–û–ë–õ–ï–ú–ê: 0.15% = —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ!
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è DOGE-USDT –≤ —Ä–µ–∂–∏–º–µ `ranging` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è offset **0.15%**, —á—Ç–æ —Å—Ç–∞–≤–∏—Ç –æ—Ä–¥–µ—Ä –¥–∞–ª–µ–∫–æ –æ—Ç —Ä—ã–Ω–∫–∞.

---

### 2. –ú–æ–¥—É–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤
**–§–∞–π–ª:** `src/strategies/scalping/futures/order_executor.py`

#### 2.1. –†–∞—Å—á–µ—Ç –ª–∏–º–∏—Ç–Ω–æ–π —Ü–µ–Ω—ã (`_calculate_limit_price`, —Å—Ç—Ä–æ–∫–∏ 260-810)

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è BUY:**
```python
# –°—Ç—Ä–æ–∫–∞ 669: –î–ª—è BUY –∏—Å–ø–æ–ª—å–∑—É–µ–º best_ask + offset
limit_price = best_ask * (1 + offset_percent / 100.0)

# –ü—Ä–∏–º–µ—Ä –¥–ª—è DOGE-USDT (ranging):
# best_ask = 0.14
# offset = 0.15%
# limit_price = 0.14 * (1 + 0.15/100) = 0.14 * 1.0015 = 0.14021
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Offset —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç `best_ask`, –Ω–æ –µ—Å–ª–∏ `best_ask` —É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ —Ä–∞–≤–µ–Ω `best_bid` (—É–∑–∫–∏–π —Å–ø—Ä–µ–¥), –æ—Ä–¥–µ—Ä —Å—Ç–∞–≤–∏—Ç—Å—è –¥–∞–ª–µ–∫–æ.
- –î–ª—è DOGE-USDT —Å —Ü–µ–Ω–æ–π 0.14 –∏ offset 0.15% ‚Üí —Ä–∞–∑–Ω–∏—Ü–∞ –≤—Å–µ–≥–æ 0.00021, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –ø—Ä–∏ —É–∑–∫–æ–º —Å–ø—Ä–µ–¥–µ.

#### 2.2. –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ (`_place_limit_order`, —Å—Ç—Ä–æ–∫–∏ 964-1445)

**–õ–æ–≥–∏–∫–∞:**
1. –†–∞–∑–º–µ—â–∞–µ—Ç –ª–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä —Å `post_only=True` (maker fee 0.02%)
2. –ï—Å–ª–∏ –æ—Ä–¥–µ—Ä –æ—Ç–∫–ª–æ–Ω–µ–Ω (–æ—à–∏–±–∫–∞ 51006 - price limit), –ø—Ä–æ–±—É–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É
3. –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å - fallback –Ω–∞ —Ä—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø—Ä–µ–¥–∞ –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º - –æ—Ä–¥–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ.

---

### 3. –õ–æ–≥ –æ–¥–Ω–æ–π —Å–¥–µ–ª–∫–∏ (DOGE-USDT, 22:53:11-22:53:13)

```
2025-12-07 22:53:11.698 | DEBUG | üí∞ Per-symbol+regime offset –¥–ª—è DOGE-USDT (ranging): 0.15%
2025-12-07 22:53:12.545 | DEBUG | üí∞ –õ–∏–º–∏—Ç—ã —Ü–µ–Ω—ã –¥–ª—è DOGE-USDT: best_bid=0.14, best_ask=0.14, current=0.14
2025-12-07 22:53:12.545 | DEBUG | ‚úÖ best_ask –∞–∫—Ç—É–∞–ª–µ–Ω –¥–ª—è DOGE-USDT BUY: best_ask=0.14, current=0.14, spread=0.007%
2025-12-07 22:53:12.545 | WARNING | ‚ö†Ô∏è –õ–∏–º–∏—Ç–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è DOGE-USDT BUY (0.14) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –±–∏—Ä–∂–∏ (0.14), –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –¥–æ 0.14
2025-12-07 22:53:12.545 | INFO | üí∞ –õ–∏–º–∏—Ç–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è DOGE-USDT buy: 0.14 (best_bid=0.14, best_ask=0.14, current_price=0.14, offset=0.150%, —Ä–µ–∂–∏–º=ranging, —Ä–∞–∑–Ω–∏—Ü–∞=0.11%, –ª–∏–º–∏—Ç—ã: max_buy=0.14, min_sell=0.14)
2025-12-07 22:53:13.403 | INFO | üìä –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞: DOGE-USDT buy 490.000000 @ 0.14 (post_only=True)
```

**–ê–Ω–∞–ª–∏–∑:**
- **–°–ø—Ä–µ–¥:** `best_ask - best_bid = 0.14 - 0.14 = 0` (–Ω—É–ª–µ–≤–æ–π —Å–ø—Ä–µ–¥!)
- **Offset:** 0.15% –æ—Ç `best_ask = 0.14`
- **–õ–∏–º–∏—Ç–Ω–∞—è —Ü–µ–Ω–∞:** 0.14 (—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ –ª–∏–º–∏—Ç–∞ –±–∏—Ä–∂–∏)
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω—É–ª–µ–≤–æ–º —Å–ø—Ä–µ–¥–µ –æ—Ä–¥–µ—Ä —Å—Ç–∞–≤–∏—Ç—Å—è —Ç–æ—á–Ω–æ –ø–æ `best_ask`, –Ω–æ –µ—Å–ª–∏ —Å–ø—Ä–µ–¥ —É–∑–∫–∏–π (0.007%), –æ—Ä–¥–µ—Ä –º–æ–∂–µ—Ç –Ω–µ –∏—Å–ø–æ–ª–Ω–∏—Ç—å—Å—è –±—ã—Å—Ç—Ä–æ.

---

### 4. –ö–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞

**–§–∞–π–ª:** `src/strategies/scalping/futures/order_executor.py`, –º–µ—Ç–æ–¥ `_calculate_limit_price` (—Å—Ç—Ä–æ–∫–∏ 260-810)

**–¢–µ–∫—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è BUY:**
```python
# –°—Ç—Ä–æ–∫–∞ 669
limit_price = best_ask * (1 + offset_percent / 100.0)
```

**–¢–µ–∫—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è SELL:**
```python
# –°—Ç—Ä–æ–∫–∞ 732
limit_price = best_bid * (1 - offset_percent / 100.0)
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. ‚ùå Offset —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç `best_ask/best_bid`, –∞ –Ω–µ –æ—Ç —Å–ø—Ä–µ–¥–∞
2. ‚ùå –ü—Ä–∏ —É–∑–∫–æ–º —Å–ø—Ä–µ–¥–µ (0.007%) offset 0.15% —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
3. ‚ùå –ù–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ offset –ø–æ–¥ —à–∏—Ä–∏–Ω—É —Å–ø—Ä–µ–¥–∞

---

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–º–µ–Ω–∞ –æ—Ä–¥–µ—Ä–æ–≤

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/order_coordinator.py`, –º–µ—Ç–æ–¥ `monitor_limit_orders` (—Å—Ç—Ä–æ–∫–∏ 51-227)

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ª–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
2. –ï—Å–ª–∏ –æ—Ä–¥–µ—Ä –≤–∏—Å–∏—Ç –¥–æ–ª—å—à–µ `max_wait_seconds` (45 —Å–µ–∫ –¥–ª—è ranging):
   - –û—Ç–º–µ–Ω—è–µ—Ç –æ—Ä–¥–µ—Ä (`auto_cancel_enabled = true`)
   - –ó–∞–º–µ–Ω—è–µ—Ç –Ω–∞ —Ä—ã–Ω–æ—á–Ω—ã–π (`replace_with_market = true`)

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ä–¥–µ—Ä –∂–¥—ë—Ç 45 —Å–µ–∫—É–Ω–¥, –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∑–∞—Ç–µ–º –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –∏ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –º–∞—Ä–∫–µ—Ç ‚Üí —Ç–µ—Ä—è–µ–º maker fee (0.02% ‚Üí 0.05%).

---

## üéØ –í—ã–≤–æ–¥—ã

### ‚ùå –ß—Ç–æ –Ω–µ —Ç–∞–∫:

1. **Offset —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è —É–∑–∫–æ–≥–æ —Å–ø—Ä–µ–¥–∞:**
   - DOGE-USDT: offset 0.15% –ø—Ä–∏ —Å–ø—Ä–µ–¥–µ 0.007% = –æ—Ä–¥–µ—Ä –≤ 21 —Ä–∞–∑ –¥–∞–ª—å—à–µ —Å–ø—Ä–µ–¥–∞
   - BTC-USDT: offset 0.08% –ø—Ä–∏ —Å–ø—Ä–µ–¥–µ 0.0001% = –æ—Ä–¥–µ—Ä –≤ 800 —Ä–∞–∑ –¥–∞–ª—å—à–µ —Å–ø—Ä–µ–¥–∞

2. **Offset —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç —Ü–µ–Ω—ã, –∞ –Ω–µ –æ—Ç —Å–ø—Ä–µ–¥–∞:**
   - `limit_price = best_ask * (1 + 0.15%)` ‚Üí —Å—Ç–∞–≤–∏—Ç –æ—Ä–¥–µ—Ä –Ω–∞ 0.15% –≤—ã—à–µ best_ask
   - –ü—Ä–∏ —É–∑–∫–æ–º —Å–ø—Ä–µ–¥–µ —ç—Ç–æ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ

3. **–ù–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ–¥ —à–∏—Ä–∏–Ω—É —Å–ø—Ä–µ–¥–∞:**
   - –£–∑–∫–∏–π —Å–ø—Ä–µ–¥ (0.01%) ‚Üí –Ω—É–∂–µ–Ω –º–∞–ª–µ–Ω—å–∫–∏–π offset (0.01-0.02%)
   - –®–∏—Ä–æ–∫–∏–π —Å–ø—Ä–µ–¥ (0.1%) ‚Üí –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ offset (0.05-0.1%)

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ª–∏–º–∏—Ç–Ω–æ–π —Ü–µ–Ω—ã:

```python
# –î–ª—è BUY:
spread = best_ask - best_bid
spread_pct = spread / best_ask * 100  # –ü—Ä–æ—Ü–µ–Ω—Ç —Å–ø—Ä–µ–¥–∞

# –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π offset: –º–∏–Ω–∏–º—É–º 20% —Å–ø—Ä–µ–¥–∞, –º–∞–∫—Å–∏–º—É–º 0.05% –æ—Ç —Ü–µ–Ω—ã
adaptive_offset_pct = max(spread_pct * 0.2, min(0.05, spread_pct * 2.0))
limit_price = best_ask * (1 + adaptive_offset_pct / 100.0)

# –î–ª—è SELL:
adaptive_offset_pct = max(spread_pct * 0.2, min(0.05, spread_pct * 2.0))
limit_price = best_bid * (1 - adaptive_offset_pct / 100.0)
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- **DOGE-USDT:** spread = 0.007%, adaptive_offset = 0.014% (20% —Å–ø—Ä–µ–¥–∞) ‚Üí `limit_price = 0.14 * 1.00014 = 0.1400196`
- **BTC-USDT:** spread = 0.0001%, adaptive_offset = 0.0002% (20% —Å–ø—Ä–µ–¥–∞) ‚Üí `limit_price = best_ask * 1.000002`

---

## üìã –¢–ó –¥–ª—è Cursor

1. **–ò–∑–º–µ–Ω–∏—Ç—å `_calculate_limit_price` –≤ `order_executor.py`:**
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å `spread = best_ask - best_bid`
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å `spread_pct = spread / best_ask * 100`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π offset: `max(spread_pct * 0.2, min(0.05, spread_pct * 2.0))`
   - –î–ª—è BUY: `limit_price = best_ask * (1 + adaptive_offset_pct / 100.0)`
   - –î–ª—è SELL: `limit_price = best_bid * (1 - adaptive_offset_pct / 100.0)`

2. **–û—Å—Ç–∞–≤–∏—Ç—å fallback –Ω–∞ –∫–æ–Ω—Ñ–∏–≥:**
   - –ï—Å–ª–∏ `best_ask` –∏–ª–∏ `best_bid` –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `offset_percent` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
   - –ï—Å–ª–∏ —Å–ø—Ä–µ–¥ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (>1%) ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `offset_percent` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å `spread`, `spread_pct`, `adaptive_offset_pct`, `limit_price`
   - –ü—Ä–∏–º–µ—Ä: `üí∞ –õ–∏–º–∏—Ç–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è DOGE-USDT buy: 0.14002 (spread=0.007%, adaptive_offset=0.014%, best_ask=0.14)`

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- DOGE-USDT: `limit_price = 0.14 * 1.0015 = 0.14021` (–¥–∞–ª–µ–∫–æ, –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è)
- –ñ–¥—ë—Ç 45 —Å–µ–∫ ‚Üí –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è ‚Üí –º–∞—Ä–∫–µ—Ç (0.05% –∫–æ–º–∏—Å—Å–∏—è)

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- DOGE-USDT: `limit_price = 0.14 * 1.00014 = 0.1400196` (–±–ª–∏–∑–∫–æ –∫ —Å–ø—Ä–µ–¥—É)
- –ò—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ ‚Üí maker fee (0.02% –∫–æ–º–∏—Å—Å–∏—è)
- –≠–∫–æ–Ω–æ–º–∏—è: 0.03% –Ω–∞ –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–µ

