# –ê–ù–ê–õ–ò–ó –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò –î–û–ü–û–õ–ù–ï–ù–ò–ô (29.12.2025)

**–î–∞—Ç–∞:** 29.12.2025  
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–π

---

## üìã –ê–ù–ê–õ–ò–ó –î–û–ü–û–õ–ù–ï–ù–ò–ô

### 1. –¢–µ—Å—Ç PnL (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5): –õ–æ–≥ –≤ trailing_stop_loss.py

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ê–ö–¢–£–ê–õ–ï–ù –ò –ö–†–ò–¢–ò–ß–ï–ù**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í `trailing_stop_loss.py:get_profit_pct()` (—Å—Ç—Ä–æ–∫–∏ 445-452, 483-488) leverage –ù–ï —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–º–∏—Å—Å–∏—è—Ö!
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: `trading_fee_rate * 100` –±–µ–∑ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ leverage
- –í `exit_analyzer.py:653-655` leverage —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ: `(trading_fee_rate * 2) * leverage * 100`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (trailing_stop_loss.py:449-451):**
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: leverage –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è!
net_pnl_pct_from_margin = gross_pnl_pct_from_margin - (
    trading_fee_rate * 100
)
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ (–∫–∞–∫ –≤ exit_analyzer.py):**
```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: leverage —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
net_pnl_pct_from_margin = gross_pnl_pct_from_margin - (
    (trading_fee_rate * 2) * self.leverage * 100
)
```

**–í—ã–≤–æ–¥:** ‚úÖ **–ê–ö–¢–£–ê–õ–ï–ù** - –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —É—á–µ—Ç leverage –≤ –∫–æ–º–∏—Å—Å–∏—è—Ö

---

### 2. –õ–æ–≥ Per-Symbol Params –≤ exit_analyzer.py

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ê–ö–¢–£–ê–õ–ï–ù –ò –ü–û–õ–ï–ó–ï–ù**

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- –í `exit_analyzer.py:1001-1005` —É–∂–µ –µ—Å—Ç—å –ª–æ–≥, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è SL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ù–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è: `tp_atr_multiplier`, `max_holding_minutes`, `min_holding_minutes`
- –ù–µ –≤–∏–¥–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ per-symbol –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
logger.debug(
    f"‚úÖ ExitAnalyzer: SL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è {symbol} ({regime}) "
    f"–ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ ParameterProvider: sl_percent={sl_percent:.2f}%, "
    f"sl_atr_multiplier={sl_atr_multiplier:.2f}, sl_min_percent={sl_min_percent:.2f}%"
)
```

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
```python
logger.info(
    f"üìä Exit params for {symbol}/{regime}: "
    f"sl_atr={exit_params.get('sl_atr_multiplier')}, "
    f"tp_atr={exit_params.get('tp_atr_multiplier')}, "
    f"max_holding={exit_params.get('max_holding_minutes')}, "
    f"min_holding={exit_params.get('min_holding_minutes')}"
)
```

**–í—ã–≤–æ–¥:** ‚úÖ **–ê–ö–¢–£–ê–õ–ï–ù** - –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ per-symbol –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

### 3. Backtest: –°–∏–º—É–ª—è—Ü–∏—è –≤ code_execution

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ê–ö–¢–£–ê–õ–ï–ù –ò –ü–û–õ–ï–ó–ï–ù**

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `sl_atr_multiplier=3.0` –¥–ª—è ETH –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- Mock position ETH-USDT –≤ RANGING —Ä–µ–∂–∏–º–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `get_exit_params("ETH-USDT", "ranging")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `sl_atr_multiplier=3.0`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç SL —Ü–µ–Ω—ã —Å —ç—Ç–∏–º multiplier

**–í—ã–≤–æ–¥:** ‚úÖ **–ê–ö–¢–£–ê–õ–ï–ù** - –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## ‚úÖ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò

| –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------------|--------|-----------|-------------|
| –¢–µ—Å—Ç PnL (leverage –≤ fees) | ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ | üî¥ –í—ã—Å–æ–∫–∏–π | Leverage –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ trailing_stop_loss.py |
| –õ–æ–≥ Per-Symbol Params | ‚úÖ –ü–æ–ª–µ–∑–Ω–æ | üü° –°—Ä–µ–¥–Ω–∏–π | –£–ª—É—á—à–∏—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É |
| Backtest —Å–∏–º—É–ª—è—Ü–∏—è | ‚úÖ –ü–æ–ª–µ–∑–Ω–æ | üü¢ –ù–∏–∑–∫–∏–π | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ |

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –°—Ä–æ—á–Ω–æ (–∫—Ä–∏—Ç–∏—á–Ω–æ):
1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —É—á–µ—Ç leverage –≤ –∫–æ–º–∏—Å—Å–∏—è—Ö** –≤ `trailing_stop_loss.py:get_profit_pct()`
   - –ó–∞–º–µ–Ω–∏—Ç—å `trading_fee_rate * 100` –Ω–∞ `(trading_fee_rate * 2) * self.leverage * 100`
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥: `logger.debug(f"PnL calc: leverage={self.leverage}, fees_adj={(trading_fee_rate * 2) * self.leverage * 100:.4f}%")`

### –í–∞–∂–Ω–æ (—É–ª—É—á—à–∏—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É):
2. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –ª–æ–≥ exit_params** –≤ `exit_analyzer.py` –ø–æ—Å–ª–µ `get_exit_params()`
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `sl_atr_multiplier`, `tp_atr_multiplier`, `max_holding_minutes`, `min_holding_minutes`
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ (by_symbol –∏–ª–∏ exit_params.{regime})

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞):
3. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å backtest —Å–∏–º—É–ª—è—Ü–∏—é** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è per-symbol –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## üìù –ì–û–¢–û–í–´–ï –ü–ê–¢–ß–ò

### –ü–∞—Ç—á 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É—á–µ—Ç leverage –≤ trailing_stop_loss.py

**–§–∞–π–ª:** `src/strategies/scalping/futures/indicators/trailing_stop_loss.py`  
**–ú–µ—Ç–æ–¥:** `get_profit_pct()` (—Å—Ç—Ä–æ–∫–∏ 445-452 –∏ 483-488)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1 (—Å—Ç—Ä–æ–∫–∞ 449-451):**
```python
# –ë—ã–ª–æ:
net_pnl_pct_from_margin = gross_pnl_pct_from_margin - (
    trading_fee_rate * 100
)

# –°—Ç–∞–ª–æ:
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (29.12.2025): –£—á–∏—Ç—ã–≤–∞–µ–º leverage –≤ –∫–æ–º–∏—Å—Å–∏—è—Ö
# –ö–æ–º–∏—Å—Å–∏—è: 0.02% –Ω–∞ –≤—Ö–æ–¥ + 0.02% –Ω–∞ –≤—ã—Ö–æ–¥, —É–º–Ω–æ–∂–µ–Ω–Ω–∞—è –Ω–∞ leverage
commission_pct = (trading_fee_rate * 2) * self.leverage * 100
net_pnl_pct_from_margin = gross_pnl_pct_from_margin - commission_pct
logger.debug(
    f"üí∞ TrailingStopLoss: PnL calc: leverage={self.leverage}, "
    f"fees_adj={commission_pct:.4f}%, "
    f"gross={gross_pnl_pct_from_margin:.4f}%, net={net_pnl_pct_from_margin:.4f}%"
)
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2 (—Å—Ç—Ä–æ–∫–∞ 483-488):**
```python
# –ë—ã–ª–æ:
net_pnl_pct_from_margin = gross_pnl_pct_from_margin - (
    trading_fee_rate * 100
)

# –°—Ç–∞–ª–æ:
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (29.12.2025): –£—á–∏—Ç—ã–≤–∞–µ–º leverage –≤ –∫–æ–º–∏—Å—Å–∏—è—Ö
commission_pct = (trading_fee_rate * 2) * self.leverage * 100
net_pnl_pct_from_margin = gross_pnl_pct_from_margin - commission_pct
logger.debug(
    f"üí∞ TrailingStopLoss: PnL calc (fallback): leverage={self.leverage}, "
    f"fees_adj={commission_pct:.4f}%, "
    f"gross={gross_pnl_pct_from_margin:.4f}%, net={net_pnl_pct_from_margin:.4f}%"
)
```

---

### –ü–∞—Ç—á 2: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –ª–æ–≥ exit_params

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/exit_analyzer.py`  
**–ú–µ—Ç–æ–¥:** `_get_sl_percent()` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 1005)

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 1005:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (29.12.2025): –ü–æ–ª–Ω—ã–π –ª–æ–≥ exit_params –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
logger.info(
    f"üìä Exit params for {symbol}/{regime}: "
    f"sl_atr_multiplier={exit_params.get('sl_atr_multiplier', 'N/A')}, "
    f"tp_atr_multiplier={exit_params.get('tp_atr_multiplier', 'N/A')}, "
    f"max_holding_minutes={exit_params.get('max_holding_minutes', 'N/A')}, "
    f"min_holding_minutes={exit_params.get('min_holding_minutes', 'N/A')}, "
    f"sl_percent={exit_params.get('sl_percent', 'N/A')}, "
    f"tp_percent={exit_params.get('tp_percent', 'N/A')}"
)
```

**–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ `_get_tp_percent()` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 850):**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (29.12.2025): –ü–æ–ª–Ω—ã–π –ª–æ–≥ exit_params –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
logger.info(
    f"üìä Exit params for {symbol}/{regime}: "
    f"tp_atr_multiplier={exit_params.get('tp_atr_multiplier', 'N/A')}, "
    f"tp_percent={exit_params.get('tp_percent', 'N/A')}"
)
```

---

### –ü–∞—Ç—á 3: Backtest —Å–∏–º—É–ª—è—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `tests/test_per_symbol_params.py`

```python
"""
–¢–µ—Å—Ç per-symbol –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.
"""
import pytest
from src.strategies.scalping.futures.config.parameter_provider import ParameterProvider
from src.strategies.scalping.futures.config.config_manager import ConfigManager

def test_eth_ranging_sl_atr_multiplier():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ ETH-USDT –≤ RANGING –∏—Å–ø–æ–ª—å–∑—É–µ—Ç sl_atr_multiplier=3.0"""
    # Mock config_manager
    config_manager = ConfigManager(...)
    parameter_provider = ParameterProvider(config_manager)
    
    # –ü–æ–ª—É—á–∞–µ–º exit_params –¥–ª—è ETH-USDT –≤ RANGING
    exit_params = parameter_provider.get_exit_params("ETH-USDT", "ranging")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è per-symbol –ø–∞—Ä–∞–º–µ—Ç—Ä
    assert exit_params.get("sl_atr_multiplier") == 3.0, \
        f"Expected sl_atr_multiplier=3.0 for ETH-USDT, got {exit_params.get('sl_atr_multiplier')}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—á–µ—Ç SL —Ü–µ–Ω—ã
    entry_price = 2965.0
    atr = 20.61
    sl_atr_multiplier = exit_params.get("sl_atr_multiplier", 2.0)
    sl_distance = atr * sl_atr_multiplier
    sl_price = entry_price - sl_distance
    
    expected_sl_price = 2965.0 - (20.61 * 3.0)  # 2903.17
    assert abs(sl_price - expected_sl_price) < 0.01, \
        f"Expected SL price={expected_sl_price}, got {sl_price}"
    
    print(f"‚úÖ ETH-USDT RANGING: sl_atr_multiplier=3.0, SL price={sl_price:.2f}")
```

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –í–´–í–û–î

**–í—Å–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ê–ö–¢–£–ê–õ–¨–ù–´:**

1. ‚úÖ **–¢–µ—Å—Ç PnL (leverage)** - –ö–†–ò–¢–ò–ß–ù–û: leverage –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ trailing_stop_loss.py
2. ‚úÖ **–õ–æ–≥ Per-Symbol Params** - –ü–û–õ–ï–ó–ù–û: —É–ª—É—á—à–∏—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
3. ‚úÖ **Backtest —Å–∏–º—É–ª—è—Ü–∏—è** - –ü–û–õ–ï–ó–ù–û: –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ —Ç—Ä–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ leverage –≤ trailing_stop_loss.py

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 29.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é



