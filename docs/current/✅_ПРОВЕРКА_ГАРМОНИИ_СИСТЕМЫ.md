# –ü–†–û–í–ï–†–ö–ê –ì–ê–†–ú–û–ù–ò–ò –°–ò–°–¢–ï–ú–´

**–î–∞—Ç–∞:** 23 –Ω–æ—è–±—Ä—è 2025  
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–∞—Ä –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø `_calculate_limit_price`

### –ú–µ—Å—Ç–∞ –≤—ã–∑–æ–≤–∞:

1. **`_execute_order` (—Å—Ç—Ä–æ–∫–∞ ~160):**
   ```python
   price = await self._calculate_limit_price(symbol, side, regime=regime)
   ```
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
   - ‚úÖ –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è `symbol`, `side`, `regime`
   - ‚úÖ –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞

2. **`_place_limit_order` (—Å—Ç—Ä–æ–∫–∞ ~498):**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç `_calculate_limit_price`
   - ‚úÖ –ù–µ –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ offset
   - ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `_calculate_limit_price`

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –õ–û–ì–ò–ö–ò –ü–†–ò–û–†–ò–¢–ï–¢–û–í

### –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:

1. **Per-symbol + Per-regime** (–µ—Å–ª–∏ –µ—Å—Ç—å)
   ```python
   if symbol and limit_order_config.get("by_symbol"):
       symbol_config = limit_order_config.get("by_symbol", {}).get(symbol, {})
       if regime and symbol_config.get("by_regime"):
           regime_config = symbol_config.get("by_regime", {}).get(regime, {})
           symbol_regime_offset = regime_config.get("limit_offset_percent")
   ```

2. **Per-symbol** (–µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∂–∏–º–∞)
   ```python
   symbol_offset = symbol_config.get("limit_offset_percent")
   ```

3. **Per-regime** (–µ—Å–ª–∏ per-symbol –Ω–µ –Ω–∞–π–¥–µ–Ω)
   ```python
   if offset_percent == default_offset and regime and limit_order_config.get("by_regime"):
       regime_config = limit_order_config.get("by_regime", {}).get(regime, {})
   ```

4. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π** (fallback)
   ```python
   default_offset = limit_order_config.get("limit_offset_percent", 0.0)
   ```

**–í—ã–≤–æ–¥:** ‚úÖ –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê FALLBACK –ó–ù–ê–ß–ï–ù–ò–ô

### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ fallback:

1. **–ï—Å–ª–∏ `by_symbol` –Ω–µ –Ω–∞–π–¥–µ–Ω:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `per-regime` –∏–ª–∏ `global` offset
   - ‚úÖ –ù–µ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–æ–∫

2. **–ï—Å–ª–∏ `regime` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `per-symbol` –∏–ª–∏ `global` offset
   - ‚úÖ –ù–µ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–æ–∫

3. **–ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `default_offset = 0.0`
   - ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π offset 0.01% –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–í—ã–≤–æ–¥:** ‚úÖ Fallback –∑–Ω–∞—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –° –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú –ö–û–î–û–ú

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ offset –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö:

1. **`_calculate_limit_price`:**
   - ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ —Ä–∞—Å—á–µ—Ç–∞ offset
   - ‚úÖ –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—É—é
   - ‚úÖ –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã

2. **`_place_limit_order`:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç `_calculate_limit_price`
   - ‚úÖ –ù–µ –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ offset
   - ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º

3. **`_place_market_order`:**
   - ‚úÖ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç offset (—Ä—ã–Ω–æ—á–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞)
   - ‚úÖ –ù–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

**–í—ã–≤–æ–¥:** ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ê–°–ß–ï–¢–ê –¶–ï–ù–´

### –î–ª—è BUY (LONG):

**–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
limit_price = best_ask * (1 + offset_percent / 100.0)
# –ü—Ä–æ–±–ª–µ–º–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è best_bid * 1.001
```

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
limit_price = best_ask * (1 + offset_percent / 100.0)
# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è best_ask
# ‚úÖ offset_percent —Ç–µ–ø–µ—Ä—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π (per-symbol+regime)
```

**–í—ã–≤–æ–¥:** ‚úÖ –†–∞—Å—á–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–π

### –î–ª—è SELL (SHORT):

**–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
limit_price = best_bid * (1 - offset_percent / 100.0)
# ‚úÖ –£–∂–µ –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
```

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
limit_price = best_bid * (1 - offset_percent / 100.0)
# ‚úÖ –û—Å—Ç–∞–ª–æ—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ
# ‚úÖ offset_percent —Ç–µ–ø–µ—Ä—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π (per-symbol+regime)
```

**–í—ã–≤–æ–¥:** ‚úÖ –†–∞—Å—á–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–π

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø

### –ù–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```python
logger.debug(f"üí∞ Per-symbol+regime offset –¥–ª—è {symbol} ({regime}): {offset_percent}%")
logger.debug(f"üí∞ Per-symbol offset –¥–ª—è {symbol}: {offset_percent}%")
logger.debug(f"üí∞ Per-regime offset –¥–ª—è {regime}: {offset_percent}%")
```

**–í—ã–≤–æ–¥:** ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π offset

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥–∞:

```yaml
order_executor:
  limit_order:
    limit_offset_percent: 0.05  # –ì–ª–æ–±–∞–ª—å–Ω—ã–π fallback
    by_regime:
      trending: 0.08
      ranging: 0.12
      choppy: 0.10
    by_symbol:  # ‚úÖ –ù–û–í–û–ï
      "BTC-USDT":
        limit_offset_percent: 0.03
        by_regime:
          trending: 0.05
          ranging: 0.08
          choppy: 0.06
```

**–í—ã–≤–æ–¥:** ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç

---

## ‚úÖ –ò–¢–û–ì–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:

1. ‚úÖ **–õ–æ–≥–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
2. ‚úÖ **Fallback –∑–Ω–∞—á–µ–Ω–∏—è:** –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
3. ‚úÖ **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:** –ù–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
4. ‚úÖ **–†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã:** –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–π
5. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—ã–±–æ—Ä offset
6. ‚úÖ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

1. ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –°—Ç–∞—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (`by_regime`) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
2. ‚úÖ **–ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (`by_symbol`):**
   - ‚úÖ **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó –Ω–∏—Ö (fallback –Ω–∞ `by_regime`)
   - ‚úÖ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´:** –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –ù–£–ñ–ù–û –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `by_symbol` –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä
   - ‚úÖ **–ë–µ–∑ –Ω–∏—Ö:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ (–≤—Å–µ –ø–∞—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π offset)
   - ‚úÖ **–° –Ω–∏–º–∏:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ (–∫–∞–∂–¥–∞—è –ø–∞—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π offset)
3. ‚úÖ **–û—à–∏–±–∫–∏:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ fallback –∑–Ω–∞—á–µ–Ω–∏—è

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°–ò–°–¢–ï–ú–ê –ì–ê–†–ú–û–ù–ò–ß–ù–ê –ò –ù–ï –ö–û–ù–§–õ–ò–ö–¢–£–ï–¢

