# –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ü–ê–¢–ß–ï–ô (29.12.2025)

**–î–∞—Ç–∞:** 29.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –ø–∞—Ç—á–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö–æ–º–∏—Å—Å–∏—è –ø—Ä–∏ Partial Close ‚úÖ

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`  
**–°—Ç—Ä–æ–∫–∏:** 6664-6689

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ–º–∏—Å—Å–∏—è —É–º–Ω–æ–∂–∞–ª–∞—Å—å –Ω–∞ 2 (–≤—Ö–æ–¥ + –≤—ã—Ö–æ–¥)
- –ù–æ –∫–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—Ö–æ–¥ —É–∂–µ –±—ã–ª–∞ —É–ø–ª–∞—á–µ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤—Å–µ–π –ø–æ–∑–∏—Ü–∏–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (29.12.2025): –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏
total_size_coins = abs(current_size) * ct_val  # –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ –º–æ–Ω–µ—Ç–∞—Ö

if total_size_coins > 0:
    # –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—Ö–æ–¥ –¥–ª—è –∑–∞–∫—Ä—ã–≤–∞–µ–º–æ–π —á–∞—Å—Ç–∏
    entry_commission_proportional = (
        (close_size_coins / total_size_coins) * 
        total_size_coins * entry_price * commission_rate
    )
    
    # –ö–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—ã—Ö–æ–¥ –¥–ª—è –∑–∞–∫—Ä—ã–≤–∞–µ–º–æ–π —á–∞—Å—Ç–∏
    exit_commission = close_size_coins * current_price * commission_rate
    
    # –ò—Ç–æ–≥–æ –∫–æ–º–∏—Å—Å–∏—è –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
    partial_commission = entry_commission_proportional + exit_commission
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–æ–º–∏—Å—Å–∏—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ: –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞ –≤—Ö–æ–¥ + –∫–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—ã—Ö–æ–¥
- Net PnL –±—É–¥–µ—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: SHORT –°–∏–≥–Ω–∞–ª—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ ADX Bearish ‚úÖ

**–§–∞–π–ª:** `src/strategies/scalping/futures/signal_generator.py`  
**–°—Ç—Ä–æ–∫–∏:** 2245-2287

**–ü—Ä–æ–±–ª–µ–º–∞:**
- SHORT —Å–∏–≥–Ω–∞–ª—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ RSI overbought (>85)
- –ü—Ä–∏ bearish —Ç—Ä–µ–Ω–¥–µ (ADX bearish) –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å SHORT —Å–∏–≥–Ω–∞–ª—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (29.12.2025): –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SHORT —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ ADX bearish —Ç—Ä–µ–Ω–¥–∞
if adx_trend == "bearish" and adx_value >= adx_threshold:
    # –ü–æ–ª—É—á–∞–µ–º DI –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ strength
    adx_plus_di = indicators.get("di_plus", 0)
    adx_minus_di = indicators.get("di_minus", 0)
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º strength –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–ª—ã bearish —Ç—Ä–µ–Ω–¥–∞
    if adx_minus_di > 0 and adx_plus_di > 0:
        bearish_strength = min(1.0, (adx_minus_di / (adx_minus_di + adx_plus_di)) * 2)
        adx_boost = min(0.3, (adx_value - adx_threshold) / 50.0)
        final_strength = min(1.0, bearish_strength + adx_boost)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SHORT —Å–∏–≥–Ω–∞–ª
        signals.append({
            "symbol": symbol,
            "side": "sell",
            "type": "adx_bearish",
            "strength": final_strength,
            ...
        })
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü—Ä–∏ bearish —Ç—Ä–µ–Ω–¥–µ (ADX bearish, -DI > +DI) –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è SHORT —Å–∏–≥–Ω–∞–ª—ã
- Strength —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–ª—ã bearish —Ç—Ä–µ–Ω–¥–∞
- –ë–æ—Ç —Å–º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å SHORT –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –Ω–∏—Å—Ö–æ–¥—è—â–µ–º —Ç—Ä–µ–Ω–¥–µ

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: markPx vs –°—Ç–∞–∫–∞–Ω –≤ PnL ‚úÖ

**–§–∞–π–ª 1:** `src/strategies/scalping/futures/core/data_registry.py`  
**–°—Ç—Ä–æ–∫–∏:** 111-132

**–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ get_mark_price:**
```python
async def get_mark_price(self, symbol: str) -> Optional[float]:
    """
    ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (29.12.2025): –ü–æ–ª—É—á–∏—Ç—å markPx –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤.
    
    MarkPx –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏—Ä–∂–µ–π –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL –∏ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏.
    –ï—Å–ª–∏ markPx –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –Ω–∞ –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É.
    """
    async with self._lock:
        market_data = self._market_data.get(symbol, {})
        # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å markPx –∏–∑ market_data (–ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ WebSocket)
        mark_px = market_data.get("markPx") or market_data.get("mark_px")
        if mark_px and isinstance(mark_px, (int, float)) and mark_px > 0:
            return float(mark_px)
        
        # Fallback –Ω–∞ –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É
        return market_data.get("price") or market_data.get("last_price")
```

**–§–∞–π–ª 2:** `src/strategies/scalping/futures/position_manager.py`  
**–°—Ç—Ä–æ–∫–∏:** 6560-6575

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ get_mark_price:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (29.12.2025): –ò—Å–ø–æ–ª—å–∑—É–µ–º markPx –∏–∑ DataRegistry –∏–ª–∏ –ø–æ–∑–∏—Ü–∏–∏
mark_px_from_pos = float(pos_data.get("markPx", "0"))
if mark_px_from_pos > 0:
    current_price = mark_px_from_pos
elif hasattr(self, "data_registry") and self.data_registry:
    # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å markPx –∏–∑ DataRegistry
    mark_px_from_registry = await self.data_registry.get_mark_price(symbol)
    if mark_px_from_registry and mark_px_from_registry > 0:
        current_price = mark_px_from_registry
    else:
        current_price = entry_price
else:
    current_price = entry_price
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è markPx –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL (–∫–∞–∫ –Ω–∞ –±–∏—Ä–∂–µ)
- Fallback –Ω–∞ –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É –µ—Å–ª–∏ markPx –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç PnL –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: ATR Fallback ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `src/indicators/talib_wrapper.py`

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- `TALibATR.calculate()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `_fallback_simple_atr()` –µ—Å–ª–∏ TA-Lib –≤–µ—Ä–Ω—É–ª 0.0 –∏–ª–∏ NaN
- Fallback —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–π ATR –∫–∞–∫ —Å—Ä–µ–¥–Ω–µ–µ True Range –∑–∞ –ø–µ—Ä–∏–æ–¥
- ATR —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ DataRegistry –¥–∞–∂–µ –µ—Å–ª–∏ = 0.0 (–¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ATR –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- Fallback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å TA-Lib

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –°—Ç–∞—Ç—É—Å |
|-----------|-------------|------|--------|--------|
| 1 | –ö–æ–º–∏—Å—Å–∏—è –ø—Ä–∏ Partial Close | `position_manager.py` | 6664-6689 | ‚úÖ |
| 2 | SHORT —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ ADX bearish | `signal_generator.py` | 2245-2287 | ‚úÖ |
| 3 | markPx vs –°—Ç–∞–∫–∞–Ω | `data_registry.py` | 111-132 | ‚úÖ |
| 3 | markPx vs –°—Ç–∞–∫–∞–Ω | `position_manager.py` | 6560-6575 | ‚úÖ |
| 4 | ATR Fallback | `talib_wrapper.py` | –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω | ‚úÖ |

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –ö–æ–º–∏—Å—Å–∏—è –ø—Ä–∏ Partial Close

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ü–æ–∑–∏—Ü–∏—è: BTC-USDT LONG, —Ä–∞–∑–º–µ—Ä=0.28 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
- –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ: 50% (0.14 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤)
- Entry price: 88964.30 USDT
- Current price: 89083.20 USDT
- Commission rate: 0.001 (0.1%)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Gross PnL: $0.16
- –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—Ö–æ–¥: $0.12 (50% –æ—Ç $0.24)
- –ö–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—ã—Ö–æ–¥: $0.12
- –ò—Ç–æ–≥–æ –∫–æ–º–∏—Å—Å–∏—è: $0.24
- Net PnL: $0.16 - $0.24 = -$0.08 (—É–±—ã—Ç–æ–∫, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç!)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–∏ –±–æ–ª—å—à–µ–π –ø—Ä–∏–±—ã–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, $1.00) Net PnL –±—É–¥–µ—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º.

---

### –¢–µ—Å—Ç 2: SHORT —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ ADX Bearish

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- BTC-USDT: ADX=98.1, -DI=98.9, +DI=1.1 (bearish —Ç—Ä–µ–Ω–¥)
- ADX threshold: 20.0

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è SHORT —Å–∏–≥–Ω–∞–ª —Ç–∏–ø–∞ "adx_bearish"
- Strength —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è: (98.9 / (98.9 + 1.1)) * 2 = ~1.98 ‚Üí 1.0 (max)
- ADX boost: (98.1 - 20.0) / 50.0 = 1.56 ‚Üí 0.3 (max)
- Final strength: min(1.0, 1.0 + 0.3) = 1.0
- Confidence: 0.7

---

### –¢–µ—Å—Ç 3: markPx –≤ PnL

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ü–æ–∑–∏—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç markPx: 2961.54 USDT
- DataRegistry —Å–æ–¥–µ—Ä–∂–∏—Ç markPx: 2961.50 USDT

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è markPx –∏–∑ –ø–æ–∑–∏—Ü–∏–∏: 2961.54 USDT
- –ï—Å–ª–∏ markPx –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è markPx –∏–∑ DataRegistry
- Fallback –Ω–∞ –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É –µ—Å–ª–∏ markPx –Ω–µ –Ω–∞–π–¥–µ–Ω

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê

**–õ–∏–Ω—Ç–µ—Ä:** ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `src/strategies/scalping/futures/position_manager.py` ‚úÖ
- `src/strategies/scalping/futures/signal_generator.py` ‚úÖ
- `src/strategies/scalping/futures/core/data_registry.py` ‚úÖ

---

## üöÄ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

**–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:**

1. ‚úÖ –ö–æ–º–∏—Å—Å–∏—è –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. ‚úÖ SHORT —Å–∏–≥–Ω–∞–ª—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ ADX bearish —Ç—Ä–µ–Ω–¥–∞
3. ‚úÖ markPx –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL (–∫–∞–∫ –Ω–∞ –±–∏—Ä–∂–µ)
4. ‚úÖ ATR fallback —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ SHORT —Å–∏–≥–Ω–∞–ª–æ–≤ –ø—Ä–∏ bearish —Ç—Ä–µ–Ω–¥–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ markPx –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö PnL

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 29.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –ø–∞—Ç—á–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é



