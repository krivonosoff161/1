# üìä –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó –ö–û–î–ê –ò –ê–†–•–ò–¢–ï–ö–¢–£–†–´ –ë–û–¢–ê

## –¶–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞

–ü—Ä–æ–≤–µ—Å—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –±–æ—Ç–∞, –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π –º–æ–¥—É–ª–µ–π –∏ –≤—ã—è–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º:
1. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ `critical_loss_cut_2x` —Å –Ω—É–ª–µ–≤—ã–º `duration_sec`
2. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ PnL –≤ –ª–æ–≥–∞—Ö (–±–∞–ª–∞–Ω—Å –≤—ã—Ä–æ—Å, –Ω–æ CSV –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–±—ã—Ç–∫–∏)
3. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π

---

## üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–•–û–î–ö–ê

### ‚ùå –ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –†–∞–∑–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ `active_positions`!

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:**
1. **`orchestrator.active_positions`** - –≥–ª–∞–≤–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –ø–æ–∑–∏—Ü–∏–π
2. **`signal_coordinator.active_positions_ref`** - reference –Ω–∞ `orchestrator.active_positions` ‚úÖ
3. **`position_manager.active_positions`** - **–°–û–ë–°–¢–í–ï–ù–ù–´–ô —Å–ª–æ–≤–∞—Ä—å** ‚ùå **–ü–†–û–ë–õ–ï–ú–ê!**

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**
- –ö–æ–≥–¥–∞ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, `entry_time` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `orchestrator.active_positions` (—á–µ—Ä–µ–∑ `signal_coordinator.active_positions_ref`)
- –ö–æ–≥–¥–∞ –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è, `position_manager._close_position_by_reason()` –∏—â–µ—Ç `entry_time` –≤ **–°–û–ë–°–¢–í–ï–ù–ù–û–ú** `self.active_positions`, –∞ –Ω–µ –≤ `orchestrator.active_positions`!
- –ü–æ—ç—Ç–æ–º—É `entry_time` –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback `datetime.now()`, –∏ `duration_sec = 0`!

---

## üîç –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –ê–ù–ê–õ–ò–ó–ê

### 1. –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö `entry_time`

**–¶–µ–ª—å:** –ü–æ–Ω—è—Ç—å, –∫–∞–∫ `entry_time` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö.

#### –¢–æ—á–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `entry_time`:

1. **`signal_coordinator.py:1754`** - –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏:
   ```python
   entry_time = datetime.now()
   ```
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è **–ø–æ—Å–ª–µ** —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `active_positions_ref[symbol]["entry_time"]`

2. **`orchestrator.py:1283-1284`** - –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –±–∏—Ä–∂–µ–π:
   ```python
   if "entry_time" not in active_position:
       active_position["entry_time"] = timestamp
   ```
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è **–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–∑–∏—Ü–∏–π —Å –±–∏—Ä–∂–∏
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `datetime.now()` –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ

3. **`websocket_coordinator.py:265-266`** - –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ WebSocket:
   ```python
   if "entry_time" not in self.active_positions_ref[symbol]:
       update_data["entry_time"] = datetime.now()
   ```
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è **–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏** –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ WebSocket
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `datetime.now()` –∫–∞–∫ fallback

#### –¢–æ—á–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `entry_time`:

1. **`trailing_stop_loss.py:420-430`** - –†–∞—Å—á–µ—Ç `minutes_in_position`:
   ```python
   entry_time = position.get("entry_time")
   if isinstance(entry_time, datetime):
       minutes_in_position = (datetime.now() - entry_time).total_seconds() / 60.0
   elif tsl.entry_timestamp > 0:
       minutes_in_position = (time.time() - tsl.entry_timestamp) / 60.0
   else:
       minutes_in_position = 0.0
   ```
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `min_holding_minutes`
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `entry_time` –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `tsl.entry_timestamp`
   - –ù–æ `tsl.entry_timestamp` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `initialize()`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –ø–æ–∑–∂–µ!

2. **`position_manager.py:2283-2301`** - –†–∞—Å—á–µ—Ç `duration_sec` –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:
   ```python
   entry_time = None
   if symbol in self.active_positions:
       stored_position = self.active_positions[symbol]
       if isinstance(stored_position, dict):
           entry_time = stored_position.get("entry_time")
           # ... –ø–∞—Ä—Å–∏–Ω–≥ ...
   
   # –ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ active_positions, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∫–∞–∫ fallback
   if entry_time is None:
       entry_time = datetime.now()  # ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –≠—Ç–æ –¥–∞–µ—Ç duration_sec = 0!
   ```
   - **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** Fallback –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `datetime.now()`, —á—Ç–æ –¥–∞–µ—Ç `duration_sec = 0`!

3. **`trailing_sl_coordinator.py:831-839`** - –†–∞—Å—á–µ—Ç `minutes_in_position` –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º:
   ```python
   entry_time = position.get("entry_time")
   if isinstance(entry_time, datetime):
       minutes_in_position = (datetime.now() - entry_time).total_seconds() / 60.0
   elif tsl.entry_timestamp > 0:
       minutes_in_position = (time.time() - tsl.entry_timestamp) / 60.0
   else:
       minutes_in_position = 0.0
   ```
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º

---

## üêõ –ö–û–†–ù–ï–í–´–ï –ü–†–ò–ß–ò–ù–´ –ü–†–û–ë–õ–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –ì–æ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π —Å `entry_time`

**–°—Ü–µ–Ω–∞—Ä–∏–π –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è:**

1. –ü–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ `signal_coordinator.execute_signal_from_price()`
2. `entry_time = datetime.now()` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è **–ª–æ–∫–∞–ª—å–Ω–æ** –≤ `signal_coordinator` (—Å—Ç—Ä–æ–∫–∞ 1754)
3. `entry_time` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `self.active_positions_ref[symbol]["entry_time"]` (—Å—Ç—Ä–æ–∫–∞ 1806+)
4. **–ù–û:** `active_positions_ref` –≤ `signal_coordinator` - —ç—Ç–æ **reference** –Ω–∞ `orchestrator.active_positions`
5. –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —É—Ö–æ–¥–∏—Ç –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–±—ã—Ç–æ–∫ (`critical_loss_cut_2x`):
   - `TrailingStopLoss.should_close_position()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True, "critical_loss_cut_2x"` **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ**
   - `trailing_sl_coordinator` –≤—ã–∑—ã–≤–∞–µ—Ç `close_position_callback()`
   - `position_manager._close_position_by_reason()` –∏—â–µ—Ç `entry_time` –≤ `self.active_positions`
   - **–ü–†–û–ë–õ–ï–ú–ê:** `entry_time` –º–æ–∂–µ—Ç –µ—â–µ –Ω–µ –±—ã—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –º–µ–∂–¥—É `signal_coordinator.active_positions_ref` –∏ `position_manager.active_positions`!

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**

- **–†–∞–∑–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Å–ª–æ–≤–∞—Ä–µ–π:** `signal_coordinator.active_positions_ref` –∏ `position_manager.active_positions` - —ç—Ç–æ **—Ä–∞–∑–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã**, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ reference –Ω–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–ª–æ–≤–∞—Ä—å `orchestrator.active_positions`
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `entry_time` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –∞ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- **Fallback –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `datetime.now()` –∫–∞–∫ fallback –¥–∞–µ—Ç `duration_sec = 0`

### –ü—Ä–æ–±–ª–µ–º–∞ #2: `critical_loss_cut_2x` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

**–ö–æ–¥ –≤ `trailing_stop_loss.py:480-501`:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–±—ã—Ç–æ–∫ (2x loss_cut) –∑–∞–∫—Ä—ã–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û
if profit_pct <= -critical_loss_cut_from_price:
    # ... –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ...
    return (True, "critical_loss_cut_2x")  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π loss_cut –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é **–º–∏–Ω—É—è** –ø—Ä–æ–≤–µ—Ä–∫—É `min_holding_minutes`
- –≠—Ç–æ **–ø—Ä–∞–≤–∏–ª—å–Ω–æ** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã, –Ω–æ –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–∫—Ä—ã–ª–∞—Å—å:
  - `entry_time` –º–æ–∂–µ—Ç –µ—â–µ –Ω–µ –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω
  - `duration_sec` –±—É–¥–µ—Ç = 0

**–í–æ–ø—Ä–æ—Å:** –î–æ–ª–∂–µ–Ω –ª–∏ `critical_loss_cut_2x` —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–ª—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π?

**–ê–Ω–∞–ª–∏–∑:**
- –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–ª–∞—Å—å –∏ —Å—Ä–∞–∑—É —É—à–ª–∞ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–±—ã—Ç–æ–∫ (2x loss_cut), —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å:
  1. **–ü–ª–æ—Ö–æ–π –≤—Ö–æ–¥** (—Å–∏–≥–Ω–∞–ª –±—ã–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
  2. **–†–µ–∑–∫–∏–π —Ä–∞–∑–≤–æ—Ä–æ—Ç —Ä—ã–Ω–∫–∞** (–Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ)
  3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞—Å—á–µ—Ç–æ–º PnL** (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç profit_pct)

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ `entry_time`

**–í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è 3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞:**

1. **`position.get("entry_time")`** - –∏–∑ `active_positions` —Å–ª–æ–≤–∞—Ä—è
2. **`tsl.entry_timestamp`** - –∏–∑ `TrailingStopLoss` –æ–±—ä–µ–∫—Ç–∞
3. **`datetime.now()`** - –∫–∞–∫ fallback (–¥–∞–µ—Ç `duration_sec = 0`)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã –¥–ª—è `entry_time`
- –†–∞–∑–Ω—ã–µ –º–æ–¥—É–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- `tsl.entry_timestamp` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ `initialize()`, –Ω–æ `initialize()` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –ø–æ–∑–∂–µ, —á–µ–º –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–ª–∞—Å—å

---

## üîß –†–ï–®–ï–ù–ò–Ø

### –†–µ—à–µ–Ω–∏–µ #0: **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï** - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `orchestrator.active_positions` –≤–º–µ—Å—Ç–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `position_manager.active_positions` - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å, –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å `orchestrator.active_positions`
- `entry_time` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `orchestrator.active_positions`, –Ω–æ –∏—â–µ—Ç—Å—è –≤ `position_manager.active_positions`

**–†–µ—à–µ–Ω–∏–µ:**
–ò–∑–º–µ–Ω–∏—Ç—å `position_manager._close_position_by_reason()` —á—Ç–æ–±—ã –æ–Ω —á–∏—Ç–∞–ª –∏–∑ `orchestrator.active_positions`:

```python
# –í position_manager.py:2283-2301
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ duration
entry_time = None

# –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ß–∏—Ç–∞–µ–º –∏–∑ orchestrator.active_positions (–≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
if hasattr(self, "orchestrator") and self.orchestrator:
    orchestrator_positions = getattr(self.orchestrator, "active_positions", {})
    if symbol in orchestrator_positions:
        stored_position = orchestrator_positions[symbol]
        if isinstance(stored_position, dict):
            entry_time = stored_position.get("entry_time")
            if isinstance(entry_time, str):
                try:
                    entry_time = datetime.fromisoformat(
                        entry_time.replace("Z", "+00:00")
                    )
                except:
                    entry_time = None
            elif not isinstance(entry_time, datetime):
                entry_time = None

# –ü–†–ò–û–†–ò–¢–ï–¢ 2: Fallback –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π active_positions (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
if entry_time is None and symbol in self.active_positions:
    stored_position = self.active_positions[symbol]
    if isinstance(stored_position, dict):
        entry_time = stored_position.get("entry_time")
        # ... –ø–∞—Ä—Å–∏–Ω–≥ ...

# –ü–†–ò–û–†–ò–¢–ï–¢ 3: Fallback –Ω–∞ TSL entry_timestamp
if entry_time is None:
    if hasattr(self, "orchestrator") and self.orchestrator:
        if hasattr(self.orchestrator, "trailing_sl_by_symbol"):
            tsl = self.orchestrator.trailing_sl_by_symbol.get(symbol)
            if tsl and hasattr(tsl, "entry_timestamp") and tsl.entry_timestamp > 0:
                entry_time = datetime.fromtimestamp(tsl.entry_timestamp)
                logger.warning(
                    f"‚ö†Ô∏è entry_time –¥–ª—è {symbol} –ø–æ–ª—É—á–µ–Ω –∏–∑ TSL: {entry_time.isoformat()}"
                )

# –ü–†–ò–û–†–ò–¢–ï–¢ 4: –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞–∑–∞–¥)
if entry_time is None:
    entry_time = datetime.now() - timedelta(seconds=1)
    logger.error(
        f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: entry_time –¥–ª—è {symbol} –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏–≥–¥–µ! "
        f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback (1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞–∑–∞–¥): {entry_time.isoformat()}"
    )
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** **–í–´–°–û–ö–ò–ô** - —ç—Ç–æ –∫–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã!

### –†–µ—à–µ–Ω–∏–µ #1: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `entry_time` –°–ò–ù–•–†–û–ù–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** `entry_time` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –≥–æ–Ω–∫–µ —É—Å–ª–æ–≤–∏–π.

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `entry_time` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `active_positions` **–¥–æ** –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ `execute_signal_from_price()`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `active_positions_ref` –≤ `signal_coordinator` - —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ reference –Ω–∞ —Ç–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç, —á—Ç–æ –∏ `orchestrator.active_positions`

**–ö–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```python
# –í signal_coordinator.py –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ entry_time:
assert self.active_positions_ref is self.orchestrator.active_positions, \
    "active_positions_ref –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å reference –Ω–∞ orchestrator.active_positions!"
assert symbol in self.orchestrator.active_positions, \
    f"–ü–æ–∑–∏—Ü–∏—è {symbol} –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ orchestrator.active_positions!"
assert "entry_time" in self.orchestrator.active_positions[symbol], \
    f"entry_time –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è {symbol}!"
```

### –†–µ—à–µ–Ω–∏–µ #2: –£–ª—É—á—à–∏—Ç—å fallback –¥–ª—è `entry_time`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (–ü–†–û–ë–õ–ï–ú–ê):**
```python
if entry_time is None:
    entry_time = datetime.now()  # ‚ùå –≠—Ç–æ –¥–∞–µ—Ç duration_sec = 0!
```

**–£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–¥:**
```python
if entry_time is None:
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ TSL –æ–±—ä–µ–∫—Ç–∞
    if symbol in self.tsl_instances:
        tsl = self.tsl_instances[symbol]
        if hasattr(tsl, "entry_timestamp") and tsl.entry_timestamp > 0:
            entry_time = datetime.fromtimestamp(tsl.entry_timestamp)
            logger.warning(
                f"‚ö†Ô∏è entry_time –¥–ª—è {symbol} –ø–æ–ª—É—á–µ–Ω –∏–∑ TSL: {entry_time.isoformat()}"
            )
    
    # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ None, –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞–∑–∞–¥)
    if entry_time is None:
        entry_time = datetime.now() - timedelta(seconds=1)
        logger.error(
            f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: entry_time –¥–ª—è {symbol} –Ω–µ –Ω–∞–π–¥–µ–Ω, "
            f"–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback (1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞–∑–∞–¥): {entry_time.isoformat()}"
        )
```

**–ù–æ –ª—É—á—à–µ:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `entry_time` –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

### –†–µ—à–µ–Ω–∏–µ #3: –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å `entry_time` –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏ –∑–∞–∫—Ä—ã—Ç–∏–∏

**–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ (signal_coordinator.py):
logger.info(
    f"‚úÖ –ü–æ–∑–∏—Ü–∏—è {symbol} –æ—Ç–∫—Ä—ã—Ç–∞: entry_time={entry_time.isoformat()}, "
    f"—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ active_positions: {symbol in self.active_positions_ref}"
)

# –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ (position_manager.py):
entry_time_before_fallback = entry_time
if entry_time is None:
    logger.error(
        f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: entry_time –¥–ª—è {symbol} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ active_positions! "
        f"active_positions.keys()={list(self.active_positions.keys())}"
    )
```

### –†–µ—à–µ–Ω–∏–µ #4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è `entry_time`

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**
1. –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å `entry_time` –≤ `orchestrator.active_positions[symbol]["entry_time"]`
2. –í—Å–µ –º–æ–¥—É–ª–∏ –¥–æ–ª–∂–Ω—ã —á–∏—Ç–∞—Ç—å –∏–∑ —ç—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
3. `TrailingStopLoss.entry_timestamp` –¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –∏–∑ `active_positions["entry_time"]` –ø—Ä–∏ `initialize()`

**–ö–æ–¥:**
```python
# –í TrailingStopLoss.initialize():
if position and isinstance(position.get("entry_time"), datetime):
    self.entry_timestamp = position["entry_time"].timestamp()
elif position and isinstance(position.get("entry_time"), str):
    try:
        entry_time = datetime.fromisoformat(position["entry_time"].replace("Z", "+00:00"))
        self.entry_timestamp = entry_time.timestamp()
    except:
        self.entry_timestamp = time.time()  # Fallback
else:
    self.entry_timestamp = time.time()  # Fallback
```

---

## üìä –ê–ù–ê–õ–ò–ó –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø –ú–û–î–£–õ–ï–ô

### –ü–æ—Ç–æ–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏:

```
1. signal_coordinator.execute_signal_from_price()
   ‚Üì
2. position_manager.open_position_manually()
   ‚Üì
3. client.place_order() ‚Üí –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ
   ‚Üì
4. signal_coordinator: entry_time = datetime.now()
   ‚Üì
5. signal_coordinator: active_positions_ref[symbol]["entry_time"] = entry_time
   ‚Üì
6. orchestrator.active_positions[symbol]["entry_time"] = entry_time (–µ—Å–ª–∏ reference –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –®–∞–≥ 6 –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –µ—Å–ª–∏ `active_positions_ref` –Ω–µ —è–≤–ª—è–µ—Ç—Å—è reference!

### –ü–æ—Ç–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ `critical_loss_cut_2x`:

```
1. orchestrator._manage_positions() ‚Üí –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
   ‚Üì
2. trailing_sl_coordinator.check_position() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ TSL
   ‚Üì
3. trailing_stop_loss.should_close_position() ‚Üí profit_pct <= -critical_loss_cut_from_price
   ‚Üì
4. trailing_sl_coordinator: close_position_callback(symbol, "critical_loss_cut_2x")
   ‚Üì
5. position_manager._close_position_by_reason()
   ‚Üì
6. position_manager: entry_time = active_positions[symbol].get("entry_time") ‚Üí –ú–û–ñ–ï–¢ –ë–´–¢–¨ None!
   ‚Üì
7. position_manager: if entry_time is None: entry_time = datetime.now() ‚Üí duration_sec = 0!
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞ —à–∞–≥–µ 6 `entry_time` –º–æ–∂–µ—Ç –±—ã—Ç—å `None`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ `duration_sec = 0`!

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ `active_positions_ref` –≤ `signal_coordinator` reference –Ω–∞ `orchestrator.active_positions`?**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∫–æ–¥–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `signal_coordinator`
   - –î–æ–±–∞–≤–∏—Ç—å assert –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

2. **–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `TrailingStopLoss.initialize()`?**
   - –î–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è **–ø–æ—Å–ª–µ** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è `entry_time` –≤ `active_positions`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –≤—ã–∑–æ–≤–æ–≤

3. **–ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≥–æ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π?**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ missing `entry_time`
   - –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ —Å `duration_sec = 0`

4. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `profit_pct` –¥–ª—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π?**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ `profit_pct` –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
   - –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å `entry_price` vs `current_price`

---

## üìù –í–´–í–û–î–´

1. **–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ì–æ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º `entry_time` –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏
2. **–í—Ç–æ—Ä–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback –¥–ª—è `entry_time` (–¥–∞–µ—Ç `duration_sec = 0`)
3. **–¢—Ä–µ—Ç–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã –¥–ª—è `entry_time`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô:** –ò–∑–º–µ–Ω–∏—Ç—å `position_manager._close_position_by_reason()` —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å `entry_time` –∏–∑ `orchestrator.active_positions` –≤–º–µ—Å—Ç–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è
2. **–í–´–°–û–ö–ò–ô:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `entry_time` –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ `orchestrator.active_positions`
3. **–°–†–ï–î–ù–ò–ô:** –£–ª—É—á—à–∏—Ç—å fallback –¥–ª—è `entry_time` (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TSL –∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)
4. **–ù–ò–ó–ö–ò–ô:** –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `entry_time` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üîÑ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å `position_manager._close_position_by_reason()` —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å `entry_time` –∏–∑ `orchestrator.active_positions`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –≤ `position_manager`, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `self.active_positions` –≤–º–µ—Å—Ç–æ `orchestrator.active_positions`
3. –£–ª—É—á—à–∏—Ç—å fallback –¥–ª—è `entry_time` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º TSL –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
4. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `entry_time` –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
5. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ missing `entry_time`
6. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–∞ –æ—Ç `position_manager.active_positions` –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ `orchestrator.active_positions`

---

## ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

**–ö–æ–¥ –≤ `position_manager.py:61`:**
```python
self.active_positions = {}  # ‚ùå –°–û–ë–°–¢–í–ï–ù–ù–´–ô —Å–ª–æ–≤–∞—Ä—å!
```

**–ö–æ–¥ –≤ `orchestrator.py:526`:**
```python
active_positions_ref=self.active_positions,  # ‚úÖ –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è reference
```

**–ö–æ–¥ –≤ `position_manager.py:2283-2301`:**
```python
if symbol in self.active_positions:  # ‚ùå –ò—â–µ—Ç –≤ –°–û–ë–°–¢–í–ï–ù–ù–û–ú —Å–ª–æ–≤–∞—Ä–µ!
    stored_position = self.active_positions[symbol]
```

**–í—ã–≤–æ–¥:** `entry_time` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `orchestrator.active_positions`, –Ω–æ –∏—â–µ—Ç—Å—è –≤ `position_manager.active_positions` - —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏!

