# –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: –¶–ï–ù–ê –î–õ–Ø –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô

**–î–∞—Ç–∞:** 2025-12-18  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´

---

## ‚úÖ –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `_check_sl()` ‚úÖ

**–§–∞–π–ª:** `position_manager.py:1183`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ —á–µ—Ä–µ–∑ `get_price_limits()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `markPx` —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ª–æ–≥–∏–∫–µ `_check_tp_only()`

**–ö–æ–¥:**
```python
# ‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞, markPx —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback
current_price = float(position.get("markPx", "0"))  # Fallback
try:
    price_limits = await self.client.get_price_limits(symbol)
    if price_limits:
        actual_price = price_limits.get("current_price", 0)
        if actual_price > 0:
            current_price = actual_price
            logger.debug(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è SL –ø—Ä–æ–≤–µ—Ä–∫–∏ {symbol}: {current_price:.2f}")
except Exception as e:
    logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è {symbol}, –∏—Å–ø–æ–ª—å–∑—É–µ–º markPx: {e}")
```

---

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω ExitAnalyzer ‚úÖ

**–§–∞–π–ª:** `exit_analyzer.py:248`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ —á–µ—Ä–µ–∑ `client.get_price_limits()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `data_registry.get_price()` —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–∫—Ä—ã—Ç–∏—è

**–ö–æ–¥:**
```python
# ‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–∫—Ä—ã—Ç–∏—è, data_registry —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback
current_price = None
if self.client and hasattr(self.client, "get_price_limits"):
    try:
        price_limits = await self.client.get_price_limits(symbol)
        if price_limits:
            current_price = price_limits.get("current_price", 0)
            if current_price > 0:
                logger.debug(f"‚úÖ ExitAnalyzer: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è {symbol}: {current_price:.2f}")
    except Exception as e:
        logger.debug(f"‚ö†Ô∏è ExitAnalyzer: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è {symbol}: {e}")

# Fallback –Ω–∞ data_registry –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
if current_price is None or current_price <= 0:
    current_price = await self.data_registry.get_price(symbol)
    if current_price and current_price > 0:
        logger.debug(f"‚úÖ ExitAnalyzer: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –∏–∑ data_registry –¥–ª—è {symbol}: {current_price:.2f}")
```

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –í–°–ï–• –ú–û–î–£–õ–ï–ô –ó–ê–ö–†–´–¢–ò–Ø

### ‚úÖ –£–ñ–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢ –ê–ö–¢–£–ê–õ–¨–ù–£–Æ –¶–ï–ù–£:

1. **`_check_tp_only()`** ‚úÖ
   - –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `markPx` —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback

2. **`_close_position_by_reason()`** ‚úÖ
   - –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `best_bid` –¥–ª—è LONG –∏ `best_ask` –¥–ª—è SHORT

3. **TrailingSL** ‚úÖ
   - –ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –∏–∑ WebSocket —Ç–∏–∫–µ—Ä–∞ (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### ‚úÖ –¢–ï–ü–ï–†–¨ –ò–°–ü–û–õ–¨–ó–£–ï–¢ –ê–ö–¢–£–ê–õ–¨–ù–£–Æ –¶–ï–ù–£:

4. **`_check_sl()`** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `markPx` —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback

5. **ExitAnalyzer** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `data_registry.get_price()` —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

**–¢–µ–ø–µ—Ä—å –≤—Å–µ –º–æ–¥—É–ª–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞!**

- ‚úÖ TP –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
- ‚úÖ SL –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
- ‚úÖ ExitAnalyzer - –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
- ‚úÖ TrailingSL - –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–∏–∑ WebSocket)
- ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ - –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û

**–î–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞!**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ü–µ–Ω–∞ ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç PnL
- –£—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ü–µ–Ω–∞ ‚Üí –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–ª–∏ –∑–∞–ø–æ–∑–¥–∞–ª–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
- –î–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞ —Ä–∞–∑–Ω–∏—Ü–∞ –¥–∞–∂–µ 0.1% –º–æ–∂–µ—Ç –±—ã—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–∞

**–¢–µ–ø–µ—Ä—å –≤—Å–µ –º–æ–¥—É–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º —Ä—ã–Ω–∫–æ–º!** ‚úÖ

---

**–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** ‚úÖ
