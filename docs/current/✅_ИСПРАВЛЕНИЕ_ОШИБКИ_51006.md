# ИСПРАВЛЕНИЕ ОШИБКИ 51006

**Дата:** 23 ноября 2025  
**Проблема:** Ошибка 51006 не обрабатывалась правильно

---

## ⚠️ ПРОБЛЕМА

Ошибка 51006 возникала, но не обрабатывалась правильно:
- Лимиты парсились из ошибки
- Но цена не корректировалась или корректировалась неправильно
- Ордер не размещался с исправленной ценой

---

## ✅ ИСПРАВЛЕНИЯ

### 1. Улучшена проверка ошибки 51006:
- Проверка `error_code == "51006"` или `"51006" in str(error_code)`
- Проверка `"price limit" in error_msg.lower()`
- Проверка `"price is not within" in error_msg.lower()`

### 2. Улучшена корректировка цены:
- Для SELL: `corrected_price = min_sell_from_error * 1.001` (0.1% выше лимита)
- Для BUY: `corrected_price = max_buy_from_error * 0.999` (0.1% ниже лимита)
- Всегда пробуем скорректированную цену, даже если она отличается от исходной

### 3. Улучшена обработка повторной попытки:
- Если скорректированная цена не прошла, логируем ошибку
- Fallback на рыночный ордер если лимитный не прошел

### 4. Добавлена проверка `corrected_price is not None`:
- Проверяем, что цена была скорректирована перед повторной попыткой
- Если не удалось скорректировать, сразу пробуем рыночный ордер

---

## ✅ РЕЗУЛЬТАТ

Теперь ошибка 51006 обрабатывается правильно:
1. ✅ Лимиты парсятся из ошибки
2. ✅ Цена корректируется с offset 0.1%
3. ✅ Повторная попытка размещения ордера с исправленной ценой
4. ✅ Fallback на рыночный ордер если лимитный не прошел

---

**Статус:** ✅ ИСПРАВЛЕНО

