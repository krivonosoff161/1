# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º entry_price –≤ ExitAnalyzer

**–î–∞—Ç–∞:** 26.11.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üö® –ü–†–û–ë–õ–ï–ú–ê

ExitAnalyzer –Ω–µ –º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å `entry_price` –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–∞–º:
```
‚ö†Ô∏è ExitAnalyzer: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å entry_price –¥–ª—è ETH-USDT
‚ö†Ô∏è ExitAnalyzer: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å entry_price –¥–ª—è BTC-USDT
```

---

## üîç –ü–†–ò–ß–ò–ù–´

1. **–í `_update_state()` –ø–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –ë–ï–ó –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:**
   - –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —É–¥–∞–ª—è–ª–∏—Å—å –∏–∑ PositionRegistry
   - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –∑–∞–Ω–æ–≤–æ —Å `metadata=None`
   - `entry_price` –∏ `regime` —Ç–µ—Ä—è–ª–∏—Å—å

2. **ExitAnalyzer –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å entry_price —Ç–æ–ª—å–∫–æ –∏–∑ metadata:**
   - –ï—Å–ª–∏ metadata –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –∏–ª–∏ entry_price –±—ã–ª None, –æ—à–∏–±–∫–∞
   - –ù–µ –±—ã–ª–æ fallback –Ω–∞ –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### **1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ `_update_state()` (orchestrator.py):**

**–î–æ:**
- –£–¥–∞–ª—è–ª–∏—Å—å –í–°–ï –ø–æ–∑–∏—Ü–∏–∏
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –∑–∞–Ω–æ–≤–æ —Å `metadata=None`

**–ü–æ—Å–ª–µ:**
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–∏, –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã—Ö –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è `entry_price`, `regime`, `entry_time` –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ï—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∏—Ä–∂–∏

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
all_metadata = await self.position_registry.get_all_metadata()

# –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
if existing_metadata:
    # –û–±–Ω–æ–≤–ª—è–µ–º entry_price –µ—Å–ª–∏ –æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    if not existing_metadata.entry_price:
        existing_metadata.entry_price = entry_price_from_api
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    await self.position_registry.register_position(
        symbol=symbol,
        position=position,
        metadata=existing_metadata,  # ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ!
    )
```

---

### **2. –°–æ–∑–¥–∞–Ω –æ–±—â–∏–π –º–µ—Ç–æ–¥ `_get_entry_price_and_side()` (exit_analyzer.py):**

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏:**

1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** `metadata.entry_price`
2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** `position.avgPx` (–¥–∞–Ω–Ω—ã–µ —Å –±–∏—Ä–∂–∏)
3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3:** `PositionRegistry.get_metadata()` (–Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ—Ö —Ç—Ä–µ—Ö –º–µ—Ç–æ–¥–∞—Ö:**
- ‚úÖ `_generate_exit_for_trending()`
- ‚úÖ `_generate_exit_for_ranging()`
- ‚úÖ `_generate_exit_for_choppy()`

**–ö–æ–¥:**
```python
async def _get_entry_price_and_side(
    self, symbol: str, position: Any, metadata: Any
) -> tuple[Optional[float], Optional[str]]:
    """
    ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–µ–Ω–∏–µ entry_price –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
    
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
    1. metadata.entry_price
    2. position.avgPx (–¥–∞–Ω–Ω—ã–µ —Å –±–∏—Ä–∂–∏)
    3. PositionRegistry metadata
    """
    # ... —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç—Ä–µ–º—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ ...
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

1. ‚úÖ `entry_price` –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è ExitAnalyzer
2. ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–π
3. ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è entry_price
4. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ ExitAnalyzer –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∞—Ç—å entry_price –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å entry_price" –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–π

---

**‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ò–°–ü–†–ê–í–õ–ï–ù–ê!**






