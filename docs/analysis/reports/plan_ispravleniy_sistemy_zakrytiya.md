# üîß –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º—ã –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π

**–î–∞—Ç–∞:** 29.11.2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∑–∏—Ü–∏–∏ –≤–∏—Å—è—Ç 6+ —á–∞—Å–æ–≤, —É–ø—É—â–µ–Ω–∞ –ø—Ä–∏–±—ã–ª—å 6+ USDT

---

## üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –£–ø—É—â–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å
- **DOGE-USDT:** –ú–∞–∫—Å–∏–º—É–º 3.35 USDT ‚Üí –¢–µ–∫—É—â–∏–π 0.23 USDT (**-3.12 USDT**)
- **BTC-USDT:** –ú–∞–∫—Å–∏–º—É–º 2.40 USDT ‚Üí –¢–µ–∫—É—â–∏–π 0.68 USDT (**-1.72 USDT**)
- **XRP-USDT:** –ú–∞–∫—Å–∏–º—É–º 1.05 USDT ‚Üí –¢–µ–∫—É—â–∏–π -0.14 USDT (**-1.19 USDT**)

### 2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
1. ‚ùå –ù–ï–¢ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏
2. ‚ùå –ù–ï–¢ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
3. ‚ùå MIN_HOLDING = 35 –º–∏–Ω—É—Ç (hardcoded) - —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –¥–ª—è —Å–∫–∞–ª—å–ø–∞
4. ‚ùå –ù–ï–¢ MAX_HOLDING –ø—Ä–æ–≤–µ—Ä–∫–∏
5. ‚ùå –ü—Ä–æ–¥–ª–µ–Ω–∏–µ TP –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ
6. ‚ùå Timeout —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —É–±—ã—Ç–∫–æ–≤

---

## ‚úÖ –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏
**–§–∞–π–ª:** `src/strategies/scalping/futures/core/position_registry.py`

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å:**
```python
@dataclass
class PositionMetadata:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    peak_profit_usd: float = 0.0  # ‚úÖ –ù–û–í–û–ï: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å
    peak_profit_time: Optional[datetime] = None  # ‚úÖ –ù–û–í–û–ï: –í—Ä–µ–º—è –º–∞–∫—Å–∏–º—É–º–∞
    peak_profit_price: Optional[float] = None  # ‚úÖ –ù–û–í–û–ï: –¶–µ–Ω–∞ –ø—Ä–∏ –º–∞–∫—Å–∏–º—É–º–µ
```

**–ì–¥–µ –æ–±–Ω–æ–≤–ª—è—Ç—å:**
- –í `position_manager.py` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ PnL
- –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π PnL —Å `peak_profit_usd`
- –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π > peak ‚Üí –æ–±–Ω–æ–≤–ª—è—Ç—å peak

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2: –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥:** `_check_profit_drawdown()`

**–õ–æ–≥–∏–∫–∞:**
```python
async def _check_profit_drawdown(self, position: Dict[str, Any]) -> bool:
    """
    –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏.
    
    –ï—Å–ª–∏ –ø—Ä–∏–±—ã–ª—å —É–ø–∞–ª–∞ –Ω–∞ X% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞ ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º.
    """
    # –ü–æ–ª—É—á–∞–µ–º peak_profit –∏–∑ metadata
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π PnL
    # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π < peak * (1 - drawdown_threshold) ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º
    
    drawdown_threshold = 0.3  # 30% –æ—Ç–∫–∞—Ç –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
    if current_pnl < peak_profit * (1 - drawdown_threshold):
        return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞:**
- **Trending:** 40% –æ—Ç–∫–∞—Ç (—Ç—Ä–µ–Ω–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è)
- **Ranging:** 30% –æ—Ç–∫–∞—Ç (–±–æ–∫–æ–≤–∏–∫)
- **Choppy:** 20% –æ—Ç–∫–∞—Ç (–±—ã—Å—Ç—Ä–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ—Å–ª–µ PH, –ø–µ—Ä–µ–¥ TP)

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å MIN_HOLDING –¥–ª—è PH
**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
min_holding_minutes = 35.0  # Default - –°–õ–ò–®–ö–û–ú –î–û–õ–ì–û!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ü–æ–ª—É—á–∞–µ–º min_holding –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ —Ä–µ–∂–∏–º—É)
min_holding_minutes = await self._get_min_holding_minutes(symbol, regime)
# Trending: 5 –º–∏–Ω—É—Ç
# Ranging: 3 –º–∏–Ω—É—Ç—ã  
# Choppy: 1 –º–∏–Ω—É—Ç–∞
```

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #4: –î–æ–±–∞–≤–∏—Ç—å MAX_HOLDING –ø—Ä–æ–≤–µ—Ä–∫—É
**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥:** `_check_max_holding()`

**–õ–æ–≥–∏–∫–∞:**
```python
async def _check_max_holding(self, position: Dict[str, Any]) -> bool:
    """
    –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è.
    """
    max_holding_minutes = await self._get_max_holding_minutes(symbol, regime)
    # Trending: 60 –º–∏–Ω—É—Ç
    # Ranging: 120 –º–∏–Ω—É—Ç (2 —á–∞—Å–∞)
    # Choppy: 30 –º–∏–Ω—É—Ç
    
    if minutes_in_position >= max_holding_minutes:
        logger.warning(f"‚è∞ MAX HOLDING EXCEEDED: {symbol}")
        return True  # –ó–∞–∫—Ä—ã–≤–∞–µ–º
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ—Å–ª–µ TP/SL)

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #5: –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ TP
**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
# –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º TP –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
new_tp = min(current_tp + extension_step, max_tp)
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–ª–µ–Ω–∏–π
tp_extension_count = metadata.get("tp_extension_count", 0)
max_tp_extensions = 3  # –ú–∞–∫—Å–∏–º—É–º 3 –ø—Ä–æ–¥–ª–µ–Ω–∏—è

if tp_extension_count >= max_tp_extensions:
    # –ü–æ—Å–ª–µ 3 –ø—Ä–æ–¥–ª–µ–Ω–∏–π - –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ TP
    logger.info(f"üìà TP –ø—Ä–æ–¥–ª–µ–≤–∞–ª—Å—è {tp_extension_count} —Ä–∞–∑, –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏")
    # –ù–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º, –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP
else:
    # –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ
    tp_extension_count += 1
    metadata["tp_extension_count"] = tp_extension_count
```

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #6: Timeout –¥–ª—è –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
**–§–∞–π–ª:** `src/strategies/scalping/futures/indicators/trailing_stop_loss.py`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
# Timeout —Ç–æ–ª—å–∫–æ –¥–ª—è —É–±—ã—Ç–∫–æ–≤
if profit_pct <= -timeout_loss_from_price:
    return True, "timeout"
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# Timeout –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
if minutes_in_position >= self.timeout_minutes:
    # –î–ª—è –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π - –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –ø—Ä–∏–±—ã–ª—å < –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π
    min_profit_threshold = 0.5  # 0.5% –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å
    if profit_pct > 0 and profit_pct < min_profit_threshold:
        return True, "timeout_low_profit"
    # –î–ª—è —É–±—ã—Ç–æ—á–Ω—ã—Ö - –∫–∞–∫ —Ä–∞–Ω—å—à–µ
    elif profit_pct <= -timeout_loss_from_price:
        return True, "timeout"
```

---

## üìã –ù–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è

```
1. _check_position_safety()      ‚Üí Emergency close (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Ä–∂–∞)
2. _check_profit_harvesting()    ‚Üí PH (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π min_holding: 1-5 –º–∏–Ω)
3. _check_profit_drawdown()      ‚Üí ‚úÖ –ù–û–í–û–ï: –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
4. _check_tp_only()              ‚Üí TP (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø—Ä–æ–¥–ª–µ–Ω–∏–π)
5. _check_sl()                    ‚Üí SL
6. _check_max_holding()          ‚Üí ‚úÖ –ù–û–í–û–ï: MAX_HOLDING (30-120 –º–∏–Ω)
7. TrailingStopLoss               ‚Üí TSL + timeout (–¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π)
8. ExitAnalyzer                   ‚Üí –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
```

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
1. ‚úÖ –ë–æ—Ç –±—É–¥–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å
2. ‚úÖ –ë–æ—Ç –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ 20-40% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
3. ‚úÖ MIN_HOLDING –±—É–¥–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º (1-5 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ 35)
4. ‚úÖ MAX_HOLDING –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (30-120 –º–∏–Ω—É—Ç)
5. ‚úÖ –ü—Ä–æ–¥–ª–µ–Ω–∏–µ TP –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ (–º–∞–∫—Å–∏–º—É–º 3 —Ä–∞–∑–∞)
6. ‚úÖ Timeout –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –±—É–¥—É—Ç –≤–∏—Å–µ—Ç—å —á–∞—Å–∞–º–∏, –ø—Ä–∏–±—ã–ª—å –±—É–¥–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤–æ–≤—Ä–µ–º—è.

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

