# ИСПРАВЛЕНИЕ ЛИМИТНОЙ ЦЕНЫ

**Дата:** 23 ноября 2025  
**Проблема:** Лимитный ордер размещается далеко от текущей цены

---

## ⚠️ ПРОБЛЕМА

### Данные из логов:
- **Сигнал:** ETH-USDT LONG @ $2840.27
- **Лимитная цена:** 2809.91
- **best_bid:** 2809.90
- **best_ask:** 2809.91
- **Разница:** 2840.27 - 2809.91 = 30.36 USDT (около 1.07%)

### Причина:
1. ❌ Для BUY использовался `best_bid * 1.001` вместо `best_ask`
2. ❌ В `get_price_limits` использовался `max_buy_price = best_ask - spread * 0.2`
3. ❌ Это ставило ордер далеко от рынка (на уровне best_bid, а не best_ask)

---

## ✅ ИСПРАВЛЕНИЕ

### 1. Исправление логики для BUY в `order_executor.py` ✅

**До исправления:**
```python
safe_buy_price = best_bid * 1.001  # ❌ ПРОБЛЕМА: Используется best_bid
limit_price = min(limit_price, safe_buy_price, max_buy_price)
```

**После исправления:**
```python
# ✅ Для BUY используем best_ask (или немного выше для гарантии исполнения)
if offset_percent == 0.0:
    min_offset = 0.01  # Минимальный offset 0.01% для гарантии исполнения
    limit_price = best_ask * (1 + min_offset / 100.0)
else:
    limit_price = best_ask * (1 + offset_percent / 100.0)

# ✅ Проверяем только лимит биржи max_buy_price
# НЕ используем best_bid * 1.001 - это ставит ордер далеко от рынка!
if limit_price > max_buy_price:
    limit_price = max_buy_price
```

---

### 2. Исправление логики `max_buy_price` в `futures_client.py` ✅

**До исправления:**
```python
max_buy_price = best_ask - (spread * 0.2)  # ❌ ПРОБЛЕМА: На 20% ниже best_ask
```

**После исправления:**
```python
# ✅ Для BUY используем best_ask (или немного выше для гарантии исполнения)
max_buy_price = best_ask * 1.0005  # 0.05% выше best_ask для гарантии исполнения
```

---

## ✅ РЕЗУЛЬТАТ

### Правильная логика:

**Для BUY (покупка):**
- ✅ Используется `best_ask` (лучшая цена продажи)
- ✅ Добавляется минимальный offset 0.01% для гарантии исполнения
- ✅ Проверяется только `max_buy_price` от биржи
- ✅ НЕ используется `best_bid * 1.001` - это ставит ордер далеко от рынка

**Для SELL (продажа):**
- ✅ Используется `best_bid` (лучшая цена покупки) ✅ (уже правильно)
- ✅ Вычитается минимальный offset 0.01% для гарантии исполнения
- ✅ Проверяется только `min_sell_price` от биржи

---

## ✅ ОЖИДАЕМЫЙ РЕЗУЛЬТАТ

### После исправления:

**Для BUY:**
- Лимитная цена будет близко к `best_ask` (например, `best_ask * 1.0001`)
- Быстрое исполнение ордера
- Не слишком далеко от рынка

**Для SELL:**
- Лимитная цена будет близко к `best_bid` (например, `best_bid * 0.9999`)
- Быстрое исполнение ордера
- Не слишком далеко от рынка

---

**Статус:** ✅ ИСПРАВЛЕНО

