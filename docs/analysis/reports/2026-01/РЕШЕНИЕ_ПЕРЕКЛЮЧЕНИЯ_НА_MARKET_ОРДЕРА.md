# ✅ РЕШЕНИЕ: ПЕРЕКЛЮЧЕНИЕ НА MARKET ОРДЕРА

**Дата:** 03 января 2026  
**Цель:** Простое переключение на market ордера без переписывания модулей

---

## ПРОБЛЕМА

Текущая система использует limit ордера с сложной логикой:
- Расчет цены через `_calculate_limit_price()`
- Мониторинг ордеров через `OrderCoordinator.monitor_limit_orders()`
- Fallback на market при неисполнении

**Проблемы:**
- Потеря времени (5-30 секунд)
- Ошибки в расчетах
- Несоответствие анализа и входа

---

## РЕШЕНИЕ

### Вариант 1: Простое изменение (РЕКОМЕНДУЕТСЯ)

**Изменить одну строку в `order_executor.py`:**

```python
def _determine_order_type(self, signal: Dict[str, Any]) -> str:
    """Определение типа ордера на основе сигнала"""
    # ✅ ИЗМЕНЕНО (03.01.2026): Переключение на market ордера для мгновенного исполнения
    # Market ордера дают актуальный вход без потери времени
    signal_type = signal.get("type", "market")  # ✅ ИЗМЕНЕНО: "market" вместо "limit"
    
    # Если signal_type это тип ордера (market, limit, oco) - используем его
    if signal_type in ["market", "limit", "oco"]:
        return signal_type
    
    # ✅ ИЗМЕНЕНО: Используем market по умолчанию для мгновенного исполнения
    return "market"  # ✅ ИЗМЕНЕНО: "market" вместо "limit"
```

**Преимущества:**
- ✅ Минимальное изменение (1 строка)
- ✅ Не нужно переписывать модули
- ✅ Не нужно исправлять вызовы
- ✅ Можно легко вернуться к limit ордерам

**Недостатки:**
- ⚠️ Логика `_calculate_limit_price()` останется (но не будет использоваться)
- ⚠️ Логика `monitor_limit_orders()` останется (но не будет использоваться)

---

### Вариант 2: Через конфиг (АЛЬТЕРНАТИВА)

**Добавить в конфиг:**
```yaml
scalping:
  prefer_market_orders: true  # ✅ НОВОЕ: Предпочитать market ордера
```

**Изменить `_determine_order_type()`:**
```python
def _determine_order_type(self, signal: Dict[str, Any]) -> str:
    """Определение типа ордера на основе сигнала"""
    # ✅ НОВОЕ: Проверка prefer_market_orders из конфига
    prefer_market = getattr(self.scalping_config, "prefer_market_orders", False)
    default_type = "market" if prefer_market else "limit"
    
    signal_type = signal.get("type", default_type)
    
    if signal_type in ["market", "limit", "oco"]:
        return signal_type
    
    return default_type
```

**Преимущества:**
- ✅ Гибкость (можно переключать через конфиг)
- ✅ Можно тестировать оба варианта

**Недостатки:**
- ⚠️ Нужно добавить параметр в конфиг
- ⚠️ Немного больше кода

---

## РЕКОМЕНДАЦИЯ

**✅ ВАРИАНТ 1 (простое изменение)**

**Причины:**
1. Минимальное изменение кода
2. Не нужно менять конфиг
3. Можно легко вернуться к limit ордерам
4. Соответствует запросу пользователя ("не нужно ковырять кучу модулей")

**Изменение:**
- Файл: `src/strategies/scalping/futures/order_executor.py`
- Строка: 266 и 275
- Изменить: `"limit"` → `"market"`

---

## ВЛИЯНИЕ НА РАБОТУ БОТА

### Что изменится:

1. **Тип ордера:**
   - Было: limit (POST_ONLY)
   - Станет: market (taker)

2. **Комиссия:**
   - Было: 0.02% (maker)
   - Станет: 0.05% (taker)
   - Разница: +0.03% на сделку

3. **Время исполнения:**
   - Было: 5-30 секунд (мониторинг limit ордеров)
   - Станет: < 1 секунды (мгновенное исполнение)

4. **Цена входа:**
   - Было: рассчитанная limit цена (может отличаться от текущей)
   - Станет: текущая рыночная цена (актуальная)

5. **Проскальзывание:**
   - Было: минимальное (limit ордер)
   - Станет: возможное (market ордер, обычно 0.01-0.1%)

### Что НЕ изменится:

1. **Логика генерации сигналов** → останется без изменений
2. **Логика фильтрации** → останется без изменений
3. **Логика выхода** → останется без изменений
4. **Логика управления рисками** → останется без изменений

---

## ОЖИДАЕМЫЕ РЕЗУЛЬТАТЫ

### Плюсы:

1. **Мгновенное исполнение** → нет потери времени
2. **Актуальный вход** → цена входа = текущая рыночная цена
3. **Простота** → меньше сложной логики
4. **Надежность** → market ордер всегда исполняется

### Минусы:

1. **Комиссия выше** → +0.03% на сделку
2. **Возможное проскальзывание** → обычно 0.01-0.1%

### Финансовый анализ:

**Текущая ситуация:**
- Средний профит: $1.39 USDT
- Средний убыток: -$0.77 USDT
- Win Rate: 28.3%

**После переключения на market:**
- Комиссия увеличится на $0.03 на сделку (для $100 сделки)
- Но вход будет актуальнее → может увеличить Win Rate
- Нет потери времени → лучшее исполнение сигналов

**Вывод:** Комиссия не критична при профите $4-7, а улучшение входа может компенсировать увеличение комиссии.

---

## ПЛАН ВНЕДРЕНИЯ

1. **Изменить `_determine_order_type()`** → переключить на market
2. **Запустить бота** → собрать статистику
3. **Сравнить с текущими логами** → проанализировать результаты
4. **Принять решение** → оставить market или вернуться к limit

---

**Дата:** 03 января 2026  
**Статус:** Готово к внедрению

