# 🚀 ИНСТРУКЦИЯ ПО ЗАПУСКУ НОВОЙ МОДУЛЬНОЙ АРХИТЕКТУРЫ

> **Дата**: 18 октября 2025  
> **Версия**: Modular v2.0  
> **Статус**: ✅ ГОТОВО К ТЕСТИРОВАНИЮ

---

## 📦 ЧТО ИЗМЕНИЛОСЬ

### БЫЛО (Monolith):
```
src/strategies/scalping.py - 3,624 строки
└── class ScalpingStrategy - всё в одном файле
```

### СТАЛО (Modular):
```
src/strategies/scalping/          # 🆕 НОВАЯ ПАПКА
├── orchestrator.py                # 300+ строк - координатор
├── signal_generator.py            # 350+ строк - генерация сигналов
├── order_executor.py              # 300+ строк - исполнение ордеров
├── position_manager.py            # 250+ строк - управление позициями
├── risk_controller.py             # 200+ строк - риск-менеджмент
└── performance_tracker.py         # 200+ строк - статистика + CSV

ИТОГО: 6 модулей, ~1,600 строк (было 3,624)
```

### НОВЫЕ ФИЧИ:

1. **✨ Profit Harvesting** (из Perplexity AI)
   - Досрочный выход если профит $3+ за 30 секунд
   - Не ждем TP $25 - хватаем микро-прибыль!

2. **✨ Telegram Alerts** (из Perplexity AI)
   - Уведомления о критичных событиях
   - Max consecutive losses
   - Daily loss limit
   - OCO failed

3. **📊 trades.csv Export**
   - Автоматический экспорт всех сделок в CSV
   - Удобно для анализа в Excel/Python

4. **📝 Единый полный лог**
   - DEBUG уровень для полной отладки
   - Ротация по 10 MB
   - Хранение 7 дней

### КРИТИЧНЫЕ ФИКСЫ:

1. **🔥 Множественные позиции** - ИСПРАВЛЕНО
   - Блокировка открытия если позиция уже есть

2. **🔥 OCO обработка ошибок** - ИСПРАВЛЕНО
   - Детальное логирование ошибок OCO
   - Продолжение работы если OCO failed

---

## 🎯 ЗАПУСК

### ШАГ 1: Проверка структуры

Убедись что создана новая структура:

```bash
ls src/strategies/scalping/

# Должно быть:
# __init__.py
# orchestrator.py
# signal_generator.py
# order_executor.py
# position_manager.py
# risk_controller.py
# performance_tracker.py
```

### ШАГ 2: Проверка старого файла

Старый файл переименован в backup:

```bash
ls src/strategies/scalping_old.py

# Должен существовать (на случай отката)
```

### ШАГ 3: Очистка кэша

```bash
# PowerShell:
Remove-Item data\cache\* -Recurse -Force

# Или вручную удалить папку data/cache/
```

### ШАГ 4: Проверка config.yaml

Убедись что добавлены новые параметры:

```yaml
scalping:
  # ✨ NEW: Profit Harvesting
  profit_harvesting_enabled: true
  quick_profit_threshold: 3.0
  quick_profit_time_limit: 30
  
  # ✨ NEW: Telegram
  telegram_enabled: false  # true после настройки
```

### ШАГ 5: Настройка Telegram (опционально)

Если хочешь получать уведомления:

1. **Создать бота:**
   - Открой Telegram
   - Напиши @BotFather
   - Отправь `/newbot`
   - Следуй инструкциям
   - Получишь TOKEN

2. **Получить Chat ID:**
   - Напиши @userinfobot
   - Получишь свой ID

3. **Добавить в .env:**
```bash
# .env
TELEGRAM_BOT_TOKEN=1234567890:ABCDEF...
TELEGRAM_CHAT_ID=987654321
```

4. **Включить в config.yaml:**
```yaml
telegram_enabled: true
```

5. **Установить aiohttp:**
```bash
pip install aiohttp
```

### ШАГ 6: ЗАПУСК!

```bash
# Через батник:
start_bot.bat

# Или вручную:
python run_bot.py --config config.yaml
```

---

## 📊 ЧТО ОЖИДАТЬ В ЛОГАХ

### ✅ ХОРОШИЕ ПРИЗНАКИ:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 LOGGING CONFIGURED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   Console: INFO+ (colored)
   File: DEBUG+ (full log)
   Rotation: 10 MB
   Retention: 7 days

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 SCALPING ORCHESTRATOR INITIALIZATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ Indicators initialized
✅ Multi-Timeframe Filter enabled
✅ Correlation Filter enabled
✅ Pivot Points Filter enabled
✅ Volume Profile Filter enabled
✅ Balance Checker enabled
✅ Time Filter disabled
✅ Adaptive Regime Manager enabled
✅ SignalGenerator initialized
✅ OrderExecutor initialized
✅ PositionManager initialized | Profit Harvesting: ON ($3.0 in 30s)
✅ RiskController initialized | Telegram: OFF
✅ PerformanceTracker initialized
📊 Created new trades CSV: logs/trades_2025-10-18.csv

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ SCALPING ORCHESTRATOR READY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚀 SCALPING ORCHESTRATOR STARTED
```

### ⚠️ ПЛОХИЕ ПРИЗНАКИ (ОШИБКИ):

```
❌ ModuleNotFoundError: No module named 'src.strategies.scalping'
   → Запустил из неправильной папки

❌ ImportError: cannot import name 'ScalpingOrchestrator'
   → Структура не создана правильно

❌ FileNotFoundError: [Errno 2] No such file or directory: 'logs/trades_...'
   → Папка logs не создана
```

---

## 🐛 TROUBLESHOOTING

### Проблема: ModuleNotFoundError

**Решение:**
```bash
# Убедись что в правильной папке:
cd "C:\Users\krivo\simple trading bot okx"

# Проверь что есть:
ls src\strategies\scalping\__init__.py
```

### Проблема: Telegram не работает

**Решение:**
```bash
# 1. Установи aiohttp:
pip install aiohttp

# 2. Проверь .env:
cat .env | findstr TELEGRAM

# 3. Проверь config.yaml:
# telegram_enabled: true (должно быть true)
```

### Проблема: trades.csv не создается

**Решение:**
```bash
# Создай папку logs:
mkdir logs

# Права доступа (если Linux):
chmod 755 logs
```

---

## 📈 МОНИТОРИНГ РЕЗУЛЬТАТОВ

### Проверка Profit Harvesting:

Смотри в логах:
```
💰 PROFIT HARVESTING: BTC-USDT | Quick profit $3.45 in 12.3s
```

Если видишь это - значит работает! 🎉

### Проверка trades.csv:

```bash
# Открой CSV:
type logs\trades_2025-10-18.csv

# Или в Excel
```

Формат:
```
timestamp,symbol,side,entry_price,exit_price,size,gross_pnl,commission,net_pnl,duration_sec,reason,win_rate
2025-10-18 12:00:00,BTC-USDT,long,65432.10,65467.85,0.00107,38.33,-1.31,37.02,45,profit_harvesting,66.7
```

### Проверка Telegram:

Если включен - получишь сообщение при запуске:
```
🚨 BOT STARTED

Balance: $1015.23
Symbols: BTC-USDT, ETH-USDT
Mode: Scalping (Modular v2)
```

---

## 🔄 ОТКАТ НА СТАРУЮ ВЕРСИЮ

Если что-то пошло не так:

### Вариант A: Быстрый откат

```python
# src/main.py - закомментируй строку:
# from src.strategies.scalping import ScalpingOrchestrator

# Раскомментируй:
from src.strategies.scalping_old import ScalpingStrategy as ScalpingOrchestrator
```

### Вариант B: Полный откат

```bash
# Переименуй обратно:
mv src\strategies\scalping_old.py src\strategies\scalping.py

# Удали новую папку:
rmdir /s src\strategies\scalping

# Откати config.yaml через git:
git checkout config.yaml
```

---

## 📊 СЛЕДУЮЩИЕ ШАГИ

После успешного запуска:

### ДЕНЬ 10-11: A/B тест параметров TP/SL

Тестируем 3 варианта (по 8 часов каждый):

**Вариант A (текущий):**
```yaml
ranging:
  tp_atr_multiplier: 1.25
  sl_atr_multiplier: 1.0
  max_holding_minutes: 10
```

**Вариант B (ближе):**
```yaml
ranging:
  tp_atr_multiplier: 0.8
  sl_atr_multiplier: 0.9
  max_holding_minutes: 8
```

**Вариант C (скальп):**
```yaml
ranging:
  tp_atr_multiplier: 0.5
  sl_atr_multiplier: 0.6
  max_holding_minutes: 5
```

Сравниваем results из `trades.csv`!

### ДЕНЬ 12-13: Настройка Profit Harvesting

Тестируем разные пороги:

```yaml
# Вариант 1:
quick_profit_threshold: 2.0   # $2
quick_profit_time_limit: 20   # 20 сек

# Вариант 2 (текущий):
quick_profit_threshold: 3.0   # $3
quick_profit_time_limit: 30   # 30 сек

# Вариант 3:
quick_profit_threshold: 5.0   # $5
quick_profit_time_limit: 45   # 45 сек
```

Смотрим сколько сделок закрылось через `profit_harvesting` в CSV!

### ДЕНЬ 14: Финальная проверка

- ✅ 24 часа непрерывной работы
- ✅ Анализ trades.csv
- ✅ Win Rate > 50%?
- ✅ Daily PnL > $10?

**ЕСЛИ ДА → PRODUCTION READY!** 🎉

---

## 📁 СТРУКТУРА ПРОЕКТА (ФИНАЛЬНАЯ)

```
simple trading bot okx/
├── src/
│   ├── strategies/
│   │   ├── scalping/              # 🆕 НОВАЯ МОДУЛЬНАЯ СТРУКТУРА
│   │   │   ├── __init__.py
│   │   │   ├── orchestrator.py
│   │   │   ├── signal_generator.py
│   │   │   ├── order_executor.py
│   │   │   ├── position_manager.py
│   │   │   ├── risk_controller.py
│   │   │   └── performance_tracker.py
│   │   ├── scalping_old.py        # 🔄 BACKUP старой версии
│   │   └── modules/               # Phase 1 модули (без изменений)
│   │       ├── adaptive_regime_manager.py
│   │       ├── balance_checker.py
│   │       ├── correlation_filter.py
│   │       ├── multi_timeframe.py
│   │       ├── pivot_points.py
│   │       └── volume_profile_filter.py
│   ├── utils/
│   │   ├── telegram_notifier.py   # 🆕 Telegram alerts
│   │   └── logging_setup.py       # 🆕 Единый лог
│   ├── main.py                    # ✅ Обновлен
│   ├── config.py
│   ├── okx_client.py
│   ├── models.py
│   └── indicators.py
├── logs/
│   ├── trading_bot_2025-10-18.log # 📝 Полный лог (DEBUG+)
│   └── trades_2025-10-18.csv      # 📊 CSV экспорт сделок
├── config.yaml                    # ✅ Обновлен (новые параметры)
├── .env.example                   # ✅ Обновлен (Telegram)
├── run_bot.py                     # Без изменений
└── start_bot.bat                  # Без изменений
```

---

## ✅ КРИТЕРИИ УСПЕХА

### После первого запуска (10 минут):

- ✅ Бот запустился без ошибок
- ✅ Видны сообщения "ORCHESTRATOR READY"
- ✅ Модули инициализированы
- ✅ trades.csv создан

### После 24 часов:

- ✅ Win Rate: 50-60%
- ✅ Daily PnL: $10-30
- ✅ Profit Harvesting работает (есть в reason в CSV)
- ✅ Trades: 50-100 сделок
- ✅ Нет критичных ошибок

### Если результаты ОК:

- ✅ Переходим к A/B тесту параметров (День 10-11)
- ✅ Настраиваем Profit Harvesting (День 12-13)
- ✅ Production запуск (День 14)

---

## 🎯 ПРЕИМУЩЕСТВА НОВОЙ АРХИТЕКТУРЫ

### 1. Читаемость:
- ❌ БЫЛО: 3,624 строк - невозможно читать
- ✅ СТАЛО: 6 файлов по 200-350 строк - легко!

### 2. Поддержка:
- ❌ БЫЛО: Баги прячутся в монстре
- ✅ СТАЛО: Каждый модуль изолирован

### 3. Тестирование:
- ❌ БЫЛО: Тестировать монолит невозможно
- ✅ СТАЛО: Каждый модуль = отдельный unit test

### 4. Расширение:
- ❌ БЫЛО: Добавить фичу = риск всё сломать
- ✅ СТАЛО: Добавляем модуль - остальное не трогаем

### 5. Новые фичи:
- ✅ Profit Harvesting - больше сделок с микро-прибылью
- ✅ Telegram - знаешь о проблемах сразу
- ✅ CSV export - легко анализировать
- ✅ Полный лог - отладка простая

---

## 🚀 ЧТО ДАЛЬШЕ

### После успешного запуска:

**НЕДЕЛЯ 2: Оптимизация (День 10-14)**
- A/B тест TP/SL
- Настройка Profit Harvesting
- Финальная проверка

**ФАЗА 2: Настоящий скальпинг (2-3 недели)**
- Polling: 5 сек → 1 сек
- TP/SL: микро-уровни ($5-10)
- TIME_LIMIT: 30 сек - 2 минуты
- Цель: 1500-2000 сделок/день

**ФАЗА 3: Новые проекты**
- Grid Trading Engine
- Опционы
- Генерация сигналов

---

## 📝 ЛОГИ ДЕМОНСТРАЦИЯ

### Пример успешной сделки:

```
📊 BTC-USDT SCORING DETAILS:
  LONG: 8/12
    SMA: +1
    EMA: +2
    RSI: +3
    BB: +2
    Vol: +0
    MACD: +0

🎯 SIGNAL GENERATED: BTC-USDT LONG | Score: 8/12 | Price: $65,432.10

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ POSITION OPENED: BTC-USDT LONG
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   Entry: $65,432.10
   Take Profit: $65,587.35
   Stop Loss: $65,232.64
✅ OCO order placed: ID=12345 | TP @ $65,587.35, SL @ $65,232.64

(45 секунд спустя...)

💰 PROFIT HARVESTING: BTC-USDT | Quick profit $3.45 in 45.2s

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💰 TRADE CLOSED: BTC-USDT LONG
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   Gross PnL: $4.76
   Commission: -$1.31
   NET PnL: $3.45
   Reason: profit_harvesting

📊 TRADE RECORDED | Total: 15 | Win Rate: 66.7% | Daily PnL: $45.23
```

**ЭТО УСПЕХ!** ✅

---

## 🎯 КОНТАКТ И ПОДДЕРЖКА

Если возникли проблемы:

1. Проверь логи: `logs/trading_bot_2025-10-18.log`
2. Проверь структуру: все файлы на месте?
3. Проверь config: новые параметры добавлены?
4. Откат на старую версию (если нужно)

---

📂 **Файл**: `docs/current/ИНСТРУКЦИЯ_НОВАЯ_АРХИТЕКТУРА.md`  
📊 **Статус**: Готово к использованию  
🎯 **Цель**: Плавный переход на модульную архитектуру

**УДАЧНОГО ЗАПУСКА! 🚀**

