# –ê–ù–ê–õ–ò–ó: –¶–ï–ù–ê –î–õ–Ø –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô

**–î–∞—Ç–∞:** 2025-12-18  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

### ‚úÖ –£–ñ–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢ –ê–ö–¢–£–ê–õ–¨–ù–£–Æ –¶–ï–ù–£:

1. **`_check_tp_only()`** ‚úÖ
   - –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ —á–µ—Ä–µ–∑ `get_price_limits()`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `markPx` —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback

2. **`_close_position_by_reason()`** ‚úÖ
   - –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `best_bid` –¥–ª—è LONG –∏ `best_ask` –¥–ª—è SHORT
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ü–µ–Ω

3. **TrailingSL** ‚úÖ
   - –ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –∏–∑ WebSocket —Ç–∏–∫–µ—Ä–∞ (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

---

### ‚ö†Ô∏è –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨:

1. **`_check_sl()`** ‚ùå
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ `markPx` (—Ü–µ–Ω–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏)
   - –ù–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
   - **–ù—É–∂–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã (–∫–∞–∫ –≤ `_check_tp_only`)

2. **ExitAnalyzer** ‚ö†Ô∏è
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `data_registry.get_price()` 
   - `data_registry.get_price()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—É –∏–∑ –∫—ç—à–∞ (`market_data.get("price")`)
   - –≠—Ç–∞ —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π
   - **–ù—É–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –≤–º–µ—Å—Ç–æ –∫—ç—à–∞

---

## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### 1. `data_registry.get_price()` - –ü–†–û–ë–õ–ï–ú–ê

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
async def get_price(self, symbol: str) -> Optional[float]:
    market_data = self._market_data.get(symbol, {})
    return market_data.get("price") or market_data.get("last_price")
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—É –∏–∑ –∫—ç—à–∞ (`_market_data`)
- –≠—Ç–∞ —Ü–µ–Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `update_market_data()`
- –ù–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –µ—Å–ª–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –Ω–µ–¥–∞–≤–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
- ExitAnalyzer –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `client.get_price_limits()` –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã
- –ò–ª–∏ `data_registry.get_price()` –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞

---

### 2. `_check_sl()` - –ü–†–û–ë–õ–ï–ú–ê

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```python
current_price = float(position.get("markPx", "0"))  # ‚ùå –¢–æ–ª—å–∫–æ markPx!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `markPx` –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞
- –ù–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (–∫–∞–∫ –≤ `_check_tp_only`)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `markPx` —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç #1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å `_check_sl()` ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –ë—ã–ª–æ:
current_price = float(position.get("markPx", "0"))

# –°—Ç–∞–ª–æ:
current_price = float(position.get("markPx", "0"))  # Fallback
try:
    price_limits = await self.client.get_price_limits(symbol)
    if price_limits:
        actual_price = price_limits.get("current_price", 0)
        if actual_price > 0:
            current_price = actual_price
            logger.debug(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è SL –ø—Ä–æ–≤–µ—Ä–∫–∏ {symbol}: {current_price:.2f}")
except Exception as e:
    logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è {symbol}, –∏—Å–ø–æ–ª—å–∑—É–µ–º markPx: {e}")
```

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç #2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å ExitAnalyzer ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –ë—ã–ª–æ:
current_price = await self.data_registry.get_price(symbol)

# –°—Ç–∞–ª–æ:
# –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
current_price = None
if self.orchestrator and hasattr(self.orchestrator, "client"):
    try:
        price_limits = await self.orchestrator.client.get_price_limits(symbol)
        if price_limits:
            current_price = price_limits.get("current_price", 0)
            if current_price > 0:
                logger.debug(f"‚úÖ ExitAnalyzer: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è {symbol}: {current_price:.2f}")
    except Exception as e:
        logger.debug(f"‚ö†Ô∏è ExitAnalyzer: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è {symbol}: {e}")

# Fallback –Ω–∞ data_registry –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
if current_price is None or current_price <= 0:
    current_price = await self.data_registry.get_price(symbol)
```

---

## üìã –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `_check_sl()` - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å ExitAnalyzer - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û

**–î–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞!**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ü–µ–Ω–∞ ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç PnL
- –£—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ü–µ–Ω–∞ ‚Üí –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–ª–∏ –∑–∞–ø–æ–∑–¥–∞–ª–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
- –î–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞ —Ä–∞–∑–Ω–∏—Ü–∞ –¥–∞–∂–µ 0.1% –º–æ–∂–µ—Ç –±—ã—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–∞

---

**–ì–æ—Ç–æ–≤ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è!** ‚úÖ
