# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ô: safety_threshold –∏ equity

**–î–∞—Ç–∞:** 2025-11-18  
**–ü—Ä–æ–±–ª–µ–º—ã:** Fallback –¥–ª—è `safety_threshold` –∏ `equity` –Ω–µ –Ω–∞–π–¥–µ–Ω

---

## üö® –ü–†–û–ë–õ–ï–ú–´

### 1. **`safety_threshold` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fallback**

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:**
```
‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback safety_threshold=1.5
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- `margin_config` –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–≤–∞—Ä–µ–º –∏–ª–∏ Pydantic –æ–±—ä–µ–∫—Ç–æ–º
- –ö–æ–¥ –Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª Pydantic –æ–±—ä–µ–∫—Ç—ã
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

### 2. **`equity` –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ `get_margin_info`**

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:**
```
‚ö†Ô∏è equity –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ get_margin_info –¥–ª—è ETH-USDT, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å: 848.39
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- `get_margin_info` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å `{}` –∏–ª–∏ `equity = 0`
- –ù–µ –±—ã–ª–æ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—É—á–∏—Ç—å `equity` –Ω–∞–ø—Ä—è–º—É—é –∏–∑ API –ø–æ–∑–∏—Ü–∏–∏
- –°—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –∫–∞–∫ fallback

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. **–£–ª—É—á—à–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ `safety_threshold` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞**

**–§–∞–π–ª:** `src/strategies/modules/margin_calculator.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –∏ –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Pydantic –æ–±—ä–µ–∫—Ç–æ–≤
- ‚úÖ –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å `by_regime` –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å –∏–ª–∏ –∞—Ç—Ä–∏–±—É—Ç
- ‚úÖ –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å `regime_config` –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å –∏–ª–∏ –∞—Ç—Ä–∏–±—É—Ç
- ‚úÖ –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å `safety_threshold` –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å –∏–ª–∏ –∞—Ç—Ä–∏–±—É—Ç
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è fallback

**–ö–æ–¥:**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Pydantic –æ–±—ä–µ–∫—Ç—ã –∏ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã
if isinstance(self.margin_config, dict):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–æ–≤–∞—Ä—è
    by_regime = self.margin_config.get("by_regime", {})
    if regime and by_regime:
        regime_config = by_regime.get(regime.lower(), {})
        safety_threshold = regime_config.get("safety_threshold")
else:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ Pydantic –æ–±—ä–µ–∫—Ç–æ–≤
    by_regime = getattr(self.margin_config, "by_regime", None)
    if by_regime and regime:
        # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç –∏–ª–∏ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
        if hasattr(by_regime, regime.lower()):
            regime_config = getattr(by_regime, regime.lower(), None)
        elif isinstance(by_regime, dict):
            regime_config = by_regime.get(regime.lower())
        
        if regime_config:
            if hasattr(regime_config, "safety_threshold"):
                safety_threshold = getattr(regime_config, "safety_threshold", None)
            elif isinstance(regime_config, dict):
                safety_threshold = regime_config.get("safety_threshold")
```

---

### 2. **–£–ª—É—á—à–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ `equity` –∏–∑ –ø–æ–∑–∏—Ü–∏–∏**

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å `equity` –Ω–∞–ø—Ä—è–º—É—é –∏–∑ API –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å `eq`, `margin + upl` –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ API
- ‚úÖ –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –∫–∞–∫ fallback
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–ª—É—á–µ–Ω–∏—è `equity`

**–ö–æ–¥:**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å equity –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ API
if equity == 0:
    try:
        positions_data = await self.client._make_request(
            "GET",
            "/api/v5/account/positions",
            params={"instType": "SWAP", "instId": f"{symbol}-SWAP"},
        )
        if positions_data and positions_data.get("data"):
            pos_data = positions_data["data"][0]
            
            # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å equity –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π
            if "eq" in pos_data and pos_data.get("eq"):
                equity = float(pos_data["eq"])
            elif "margin" in pos_data and "upl" in pos_data:
                margin = float(pos_data.get("margin", 0))
                upl = float(pos_data.get("upl", 0))
                equity = margin + upl
    except Exception as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è equity –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ API: {e}")
    
    # Fallback –Ω–∞ –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
    if equity == 0:
        equity = await self.client.get_balance()
        logger.warning(
            f"‚ö†Ô∏è equity –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ get_margin_info –∏ API –¥–ª—è {symbol}, "
            f"–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å: {equity:.2f}"
        )
```

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### 1. **`safety_threshold` –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞**

**–î–æ:**
```
‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback safety_threshold=1.5
```

**–ü–æ—Å–ª–µ:**
```
‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω safety_threshold=1.3 –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (regime=ranging)
```

**–ò–ª–∏ (–µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å):**
```
‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback safety_threshold=1.5 
(–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è regime=ranging)
margin_config type=<class 'dict'>, regime=ranging
üîç by_regime (dict): {...}
üîç regime_config –¥–ª—è ranging: {...}
```

---

### 2. **`equity` –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å—Å—è –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ API**

**–î–æ:**
```
‚ö†Ô∏è equity –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ get_margin_info –¥–ª—è ETH-USDT, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å: 848.39
```

**–ü–æ—Å–ª–µ:**
```
‚úÖ equity –ø–æ–ª—É—á–µ–Ω –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ API –¥–ª—è ETH-USDT: 52.07
```

**–ò–ª–∏ (–µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å):**
```
‚ö†Ô∏è equity –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ get_margin_info –∏ API –¥–ª—è ETH-USDT, 
–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å: 848.39
```

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:

1. **–î–ª—è `safety_threshold`:**
   - –¢–∏–ø `margin_config`
   - –ó–Ω–∞—á–µ–Ω–∏–µ `by_regime`
   - –ó–Ω–∞—á–µ–Ω–∏–µ `regime_config` –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
   - –ü—Ä–∏—á–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è fallback (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

2. **–î–ª—è `equity`:**
   - –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑ `get_margin_info`
   - –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ API
   - –ü—Ä–∏—á–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

1. **–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
   - `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω safety_threshold=X –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (regime=Y)` –≤–º–µ—Å—Ç–æ `‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback`
   - `‚úÖ equity –ø–æ–ª—É—á–µ–Ω –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ API –¥–ª—è SYMBOL: X` –≤–º–µ—Å—Ç–æ `‚ö†Ô∏è equity –Ω–µ –Ω–∞–π–¥–µ–Ω`

2. **–ï—Å–ª–∏ –≤—Å–µ –µ—â–µ fallback:**
   - –õ–æ–≥–∏ –ø–æ–∫–∞–∂—É—Ç –ø—Ä–∏—á–∏–Ω—É (—Ç–∏–ø—ã, –∑–Ω–∞—á–µ–Ω–∏—è, –æ—à–∏–±–∫–∏)
   - –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É

---

**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

