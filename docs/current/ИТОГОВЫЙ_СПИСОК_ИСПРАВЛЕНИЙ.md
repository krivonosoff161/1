# –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## ‚úÖ –í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´

### 1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ (–ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ max_usd_size)

**–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py`  
**–°—Ç—Ä–æ–∫–∞:** 838-841

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
base_usd_size *= strength_multiplier  # –ú–æ–≥–ª–æ –ø—Ä–µ–≤—ã—Å–∏—Ç—å max_usd_size!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
base_usd_size *= strength_multiplier
base_usd_size = min(base_usd_size, max_usd_size)  # ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç `max_usd_size`

---

### 2. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ (Maker) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py`  
**–°—Ç—Ä–æ–∫–∞:** 660-673

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
"type": "market",  # ‚ùå –í—Å–µ–≥–¥–∞ —Ä—ã–Ω–æ—á–Ω—ã–µ (Taker 0.05%)
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
order_type = "limit"  # ‚úÖ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–∏–º–∏—Ç–Ω—ã–µ (Maker 0.02%)
# –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–º–∏—Å—Å–∏—è —Å–Ω–∏–∂–µ–Ω–∞ —Å 0.10% –¥–æ 0.04% (—ç–∫–æ–Ω–æ–º–∏—è 60%)

---

### 3. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç margin_used —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py`  
**–°—Ç—Ä–æ–∫–∞:** 714-724

**–£–ª—É—á—à–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
leverage = getattr(self.scalping_config, "leverage", 3)
notional = position_size * price
margin_used = notional / leverage
logger.debug(f"üíº –û–±—â–∞—è –º–∞—Ä–∂–∞: ${self.total_margin_used:.2f} "
             f"(notional=${notional:.2f}, margin=${margin_used:.2f}, leverage={leverage}x)")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–Ω—è—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ margin_used

---

### 4. ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ WebSocket —Å–µ—Å—Å–∏–∏

**–§–∞–π–ª:** `src/strategies/scalping/futures/websocket_manager.py`  
**–°—Ç—Ä–æ–∫–∞:** 56, 85-86, 124-131

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
session = aiohttp.ClientSession()  # ‚ùå –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å
# –°–µ—Å—Å–∏—è –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∞—Å—å ‚Üí "Unclosed client session"
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
self.session = aiohttp.ClientSession()  # ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º
self.ws = await self.session.ws_connect(self.ws_url)

# –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:
if self.session and not self.session.closed:
    await self.session.close()
    await asyncio.sleep(0.1)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π "Unclosed client session"

---

### 5. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π margin_ratio –≤ PositionManager

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`  
**–°—Ç—Ä–æ–∫–∞:** 222-251

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
if margin_ratio < 1.2 and margin_ratio > 0:
    await self._emergency_close_position(position)  # ‚ùå –ó–∞–∫—Ä—ã–≤–∞–ª–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Ä–∞—Å—á–µ—Ç–∞
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–ª–µ–Ω—ã 3 –∑–∞—â–∏—Ç—ã –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π:
# 1. margin_ratio <= 1.5 –∏ abs(pnl) < 10 ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
# 2. margin_ratio <= 0.5 –∏ equity > 0 ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º  
# 3. available_margin < -1000 –∏ abs(pnl) < 100 ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ä–∞—Å—á–µ—Ç–∞

---

### 6. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π

**–§–∞–π–ª:** `src/clients/futures_client.py`  
**–°—Ç—Ä–æ–∫–∞:** 186-199

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –æ—Ä–¥–µ—Ä–∞
if method == "POST" and "/trade/order" in url:
    fee = order_data[0].get("fee", "N/A")
    fee_ccy = order_data[0].get("feeCcy", "N/A")
    logger.info(f"üí∞ –ö–æ–º–∏—Å—Å–∏—è –∑–∞ –æ—Ä–¥–µ—Ä: {fee} {fee_ccy}")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–∏–¥–Ω–æ —Ä–µ–∞–ª—å–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é –∏–∑ API

---

### 7. ‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∞—Ä—Ö–∏–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

**–§–∞–π–ª:** `src/main_futures.py`  
**–°—Ç—Ä–æ–∫–∞:** 105-115

**–£–ª—É—á—à–µ–Ω–∏–µ:**
```python
logger.add(
    str(log_dir / "futures_main_{time:YYYY-MM-DD}.log"),
    level="DEBUG",  # ‚úÖ –í–°–ï —É—Ä–æ–≤–Ω–∏
    rotation="10 MB",
    retention="30 days",
    compression="zip",  # ‚úÖ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è
    backtrace=True,
    diagnose=True,
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –ª–æ–≥–∏ –≤ –∞—Ä—Ö–∏–≤–µ, –ª–µ–≥—á–µ –∞–Ω–∞–ª–∏–∑

---

### 8. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –±–∏—Ä–∂–µ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º

**–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py`  
**–°—Ç—Ä–æ–∫–∞:** 539-584

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –±–∏—Ä–∂–µ
all_positions = await self.client.get_positions()
symbol_positions = [p for p in all_positions 
                    if p.get("instId", "").startswith(symbol) 
                    and float(p.get("pos", "0")) != 0]

if symbol_positions:
    return  # –ü–æ–∑–∏—Ü–∏—è —É–∂–µ –µ—Å—Ç—å

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ max_open_positions
active_positions_count = len([p for p in all_positions 
                              if float(p.get("pos", "0")) != 0])
if active_positions_count >= max_open:
    return  # –õ–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã, —Å–æ–±–ª—é–¥–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:

‚úÖ **8 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–∏–º–µ–Ω–µ–Ω—ã**  
‚úÖ **–í—Å–µ —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã**  
‚úÖ **–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**  
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–æ**  
‚úÖ **–ó–∞—â–∏—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã**

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

1. **–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–π:** –°–æ–±–ª—é–¥–∞—é—Ç—Å—è –ª–∏–º–∏—Ç—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
2. **–ö–æ–º–∏—Å—Å–∏–∏:** –°–Ω–∏–∂–µ–Ω—ã –Ω–∞ 60% (Maker –≤–º–µ—Å—Ç–æ Taker)
3. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ù–µ—Ç –ª–æ–∂–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π –ø–æ–∑–∏—Ü–∏–π
4. **–õ–æ–≥–∏:** –ü–æ–ª–Ω—ã–µ –∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
5. **–ó–∞–∫—Ä—ã—Ç–∏–µ:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–µ–∑ –æ—à–∏–±–æ–∫
6. **–û—Ç–∫—Ä—ã—Ç–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –±–∏—Ä–∂–µ

**–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!** üöÄ

