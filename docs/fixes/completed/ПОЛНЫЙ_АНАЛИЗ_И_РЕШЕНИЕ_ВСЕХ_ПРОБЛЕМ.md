# üî¨ –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –ò –†–ï–®–ï–ù–ò–ï –í–°–ï–• –ü–†–û–ë–õ–ï–ú

**–î–∞—Ç–∞:** 2025-11-28  
**–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞:** 06:36 - 18:52  
**–†–µ–∂–∏–º:** ranging (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏)

---

## üìä –†–ï–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –¢–û–†–ì–û–í–õ–ò

### –ü—Ä–∏–±—ã–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏ (–∑–∞–∫—Ä—ã—Ç—ã –ø–æ TP):
| –°–∏–º–≤–æ–ª | PnL | –ü—Ä–∏—á–∏–Ω–∞ | –í—Ä–µ–º—è |
|--------|-----|---------|-------|
| XRP-USDT | +1.59 USDT | tp | 6696 —Å–µ–∫ |
| BTC-USDT | +0.38 USDT | tp | - |
| ETH-USDT | +1.78 USDT | tp | - |
| SOL-USDT | +0.74 USDT | tp | - |
| BTC-USDT | +0.22 USDT | tp | - |
| BTC-USDT | +2.74 USDT | tp | - |
| DOGE-USDT | +1.37 USDT | tp | - |
| BTC-USDT | +2.87 USDT | tp | - |
| BTC-USDT | +0.93 USDT | tp | - |

**–í—Å–µ–≥–æ –ø—Ä–∏–±—ã–ª—å:** ~12 USDT

### –£–±—ã—Ç–æ—á–Ω—ã–µ —Å–¥–µ–ª–∫–∏ (–∑–∞–∫—Ä—ã—Ç—ã –≤—Ä—É—á–Ω—É—é):
| –°–∏–º–≤–æ–ª | PnL % | –í—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è | –î–æ–ª–∂–µ–Ω –±—ã–ª –∑–∞–∫—Ä—ã—Ç—å—Å—è |
|--------|-------|-----------------|---------------------|
| XRP-USDT | -6.17% | 9—á 57–º | –ü—Ä–∏ -4% (loss_cut) |
| ETH-USDT | -6.26% | 6—á 44–º | –ü—Ä–∏ -4% (loss_cut) |
| DOGE-USDT | **-17.83%** | 3—á 21–º | –ü—Ä–∏ -4% –∏–ª–∏ -8% (critical) |
| SOL-USDT | -7.73% | 3—á 54–º | –ü—Ä–∏ -4% (loss_cut) |
| BTC-USDT | -2.34% | 1—á 37–º | OK (–º–µ–Ω—å—à–µ loss_cut) |

**–í—Å–µ–≥–æ —É–±—ã—Ç–æ–∫:** ~15 USDT (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)

### –ü–æ–∑–∏—Ü–∏–∏, –∑–∞–∫—Ä—ã—Ç—ã–µ —Å—Ä–∞–∑—É (1-19 —Å–µ–∫—É–Ω–¥):
| –°–∏–º–≤–æ–ª | PnL % | –í—Ä–µ–º—è | –ü—Ä–æ–±–ª–µ–º–∞ |
|--------|-------|-------|----------|
| BTC-USDT | -0.51% | 1 —Å–µ–∫ | –ó–∞–∫—Ä—ã—Ç —Å—Ä–∞–∑—É |
| BTC-USDT | -0.51% | 3 —Å–µ–∫ | –ó–∞–∫—Ä—ã—Ç —Å—Ä–∞–∑—É |
| ETH-USDT | -0.72% | 2 —Å–µ–∫ | –ó–∞–∫—Ä—ã—Ç —Å—Ä–∞–∑—É |
| XRP-USDT | -0.99% | 10 —Å–µ–∫ | –ó–∞–∫—Ä—ã—Ç —Å—Ä–∞–∑—É |
| BTC-USDT | -0.74% | 19 —Å–µ–∫ | –ó–∞–∫—Ä—ã—Ç —Å—Ä–∞–∑—É |

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –º–∞–ª–µ–π—à–µ–º —É–±—ã—Ç–∫–µ (–Ω–µ loss_cut!)

---

## üîç –ü–û–õ–ù–ê–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –ü–†–û–í–ï–†–û–ö

### –®–ê–ì 1: WebSocket —Ç–∏–∫–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–§–∞–π–ª:** `websocket_coordinator.py:273-289`

```python
if (
    symbol in self.active_positions_ref
    and "entry_price" in self.active_positions_ref.get(symbol, {})  # ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê!
):
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ TP —á–µ—Ä–µ–∑ manage_position
    await self.position_manager.manage_position(...)
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ TSL (–µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –µ—â–µ –æ—Ç–∫—Ä—ã—Ç–∞)
    await self.trailing_sl_coordinator.update_trailing_stop_loss(...)
```

**–ü–†–û–ë–õ–ï–ú–ê #1:** –ï—Å–ª–∏ `entry_price` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí `update_trailing_stop_loss()` –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è!

---

### –®–ê–ì 2: manage_position() ‚Üí TP –ø—Ä–æ–≤–µ—Ä–∫–∞

**–§–∞–π–ª:** `position_manager.py:408-473`

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
1. `_check_position_safety()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å —Å—Ä–∞–∑—É!)
2. `_check_profit_harvesting()` - PH –ø—Ä–æ–≤–µ—Ä–∫–∞
3. `_check_tp_only()` - TP –ø—Ä–æ–≤–µ—Ä–∫–∞

**–ü–†–û–ë–õ–ï–ú–ê #2:** `_check_position_safety()` –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é —Å—Ä–∞–∑—É –ø—Ä–∏ `margin_ratio < 1.2`!

**–§–∞–π–ª:** `position_manager.py:897-901`
```python
if margin_ratio < 1.2 and margin_ratio > 0:
    await self._emergency_close_position(position)  # ‚ö†Ô∏è –ó–ê–ö–†–´–í–ê–ï–¢ –°–†–ê–ó–£!
```

---

### –®–ê–ì 3: _check_tp_only() ‚Üí TP –ø—Ä–æ–≤–µ—Ä–∫–∞

**–§–∞–π–ª:** `position_manager.py:1632-1908`

**–õ–æ–≥–∏–∫–∞:**
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç `pnl_percent` –æ—Ç entry_price
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å `tp_percent` (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
- –ï—Å–ª–∏ `pnl_percent >= tp_percent` ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ TP ‚úÖ

**–†–ê–ë–û–¢–ê–ï–¢:** –î–ª—è –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π TP —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç!

**–ù–û:** –î–ª—è —É–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π TP –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (–ª–æ–≥–∏—á–Ω–æ, –ø–æ–∑–∏—Ü–∏—è –≤ —É–±—ã—Ç–∫–µ)

---

### –®–ê–ì 4: update_trailing_stop_loss() ‚Üí TSL –∏ loss_cut

**–§–∞–π–ª:** `trailing_sl_coordinator.py:373-518`

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ `entry_price` –∏–∑ `avgPx` (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
2. –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TSL (–µ—Å–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
3. –í—ã–∑–æ–≤ `tsl.should_close_position()`

**–ü–†–û–ë–õ–ï–ú–ê #3:** –ï—Å–ª–∏ `entry_price == 0` –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –±–µ–∑ –≤—ã–∑–æ–≤–∞ `should_close_position()` (—Å—Ç—Ä–æ–∫–∞ 429)

---

### –®–ê–ì 5: should_close_position() ‚Üí loss_cut –ø—Ä–æ–≤–µ—Ä–∫–∞

**–§–∞–π–ª:** `trailing_stop_loss.py:446-908`

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–æ–∫:**

1. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π loss_cut (2x)** - —Å—Ç—Ä–æ–∫–∏ 501-566
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ü–ï–†–ï–î MIN_HOLDING
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 5 —Å–µ–∫—É–Ω–¥
   - –ü–æ—Ä–æ–≥: `loss_cut_percent * 2` (–¥–ª—è ranging = 4% * 2 = 8%)

2. **MIN_HOLDING –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** - —Å—Ç—Ä–æ–∫–∏ 568-607
   - –ï—Å–ª–∏ `minutes_in_position < min_holding_minutes` ‚Üí –±–ª–æ–∫–∏—Ä—É–µ—Ç loss_cut
   - –î–ª—è ranging: `min_holding_minutes = 35.0`
   - **–ü–†–û–ë–õ–ï–ú–ê #4:** –ë–ª–æ–∫–∏—Ä—É–µ—Ç loss_cut –¥–æ 35 –º–∏–Ω—É—Ç, –¥–∞–∂–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —É–±—ã—Ç–∫–æ–≤!

3. **–û–±—ã—á–Ω—ã–π loss_cut** - —Å—Ç—Ä–æ–∫–∏ 613-634
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ü–û–°–õ–ï MIN_HOLDING
   - –ü–æ—Ä–æ–≥: `loss_cut_percent` (–¥–ª—è ranging = 4%)
   - **–ù–û:** –ï—Å–ª–∏ MIN_HOLDING –Ω–µ –ø—Ä–æ–π–¥–µ–Ω, —ç—Ç–æ—Ç –∫–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è!

4. **Timeout loss_cut** - —Å—Ç—Ä–æ–∫–∏ 636-668
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
   - –ü–æ—Ä–æ–≥: `timeout_loss_percent` (–¥–ª—è ranging = 2%)

5. **Trailing stop** - —Å—Ç—Ä–æ–∫–∏ 670-855
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ü–µ–Ω–µ (price_hit_sl)

**–ü–†–û–ë–õ–ï–ú–ê #5:** Loss_cut –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è MIN_HOLDING –¥–ª—è —É–±—ã—Ç–∫–æ–≤ > loss_cut, –Ω–æ < critical (2x)

---

### –®–ê–ì 6: –ü–æ—Å–ª–µ should_close_position() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç True

**–§–∞–π–ª:** `trailing_sl_coordinator.py:1011-1055`

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ `should_block_close` - –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –¥–ª—è –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
2. –í—ã–∑–æ–≤ `close_position_callback()`

**–ü–†–û–ë–õ–ï–ú–ê #6:** `should_block_close` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è `profit_pct > 0`, –Ω–æ –¥–ª—è —É–±—ã—Ç–æ—á–Ω—ã—Ö –Ω–µ –¥–æ–ª–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å!

---

## üö® –í–°–ï –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü–†–û–ë–õ–ï–ú–ê #1: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø - `update_trailing_stop_loss()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ `entry_price`

**–§–∞–π–ª:** `websocket_coordinator.py:273-276`

**–ö–æ–¥:**
```python
if (
    symbol in self.active_positions_ref
    and "entry_price" in self.active_positions_ref.get(symbol, {})  # ‚ö†Ô∏è
):
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `entry_price` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ ‚Üí `update_trailing_stop_loss()` –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
- –í `update_trailing_stop_loss()` –µ—Å—Ç—å –ª–æ–≥–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è `entry_price`, –Ω–æ –æ–Ω–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è!
- –†–µ–∑—É–ª—å—Ç–∞—Ç: TSL –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Üí loss_cut –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

**–í–ª–∏—è–Ω–∏–µ:**
- –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –±–µ–∑ `entry_price` –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ loss_cut
- –ü–æ–∑–∏—Ü–∏–∏ –≤–∏—Å—è—Ç —á–∞—Å–∞–º–∏ –≤ —É–±—ã—Ç–∫–µ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### –ü–†–û–ë–õ–ï–ú–ê #2: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø - `_emergency_close_position()` –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ —Å—Ä–∞–∑—É

**–§–∞–π–ª:** `position_manager.py:897-901`

**–ö–æ–¥:**
```python
if margin_ratio < 1.2 and margin_ratio > 0:
    logger.warning(f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} –∏–º–µ–µ—Ç –Ω–∏–∑–∫—É—é –º–∞—Ä–∂—É: {margin_ratio:.2f}%. –ó–∞–∫—Ä—ã—Ç–∏–µ...")
    await self._emergency_close_position(position)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ `margin_ratio < 1.2` –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –°–†–ê–ó–£
- –î–ª—è –º–∞–ª—ã—Ö –ø–æ–∑–∏—Ü–∏–π —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è `margin_ratio` —á–∞—Å—Ç–æ –Ω–∏–∑–∫–∏–π –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Ä–∞—Å—á–µ—Ç–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ 1-19 —Å–µ–∫—É–Ω–¥ —Å —É–±—ã—Ç–∫–æ–º 0.5-1%

**–í–ª–∏—è–Ω–∏–µ:**
- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –¥–æ MIN_HOLDING
- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –º–∞–ª–µ–π—à–µ–º —É–±—ã—Ç–∫–µ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### –ü–†–û–ë–õ–ï–ú–ê #3: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø - MIN_HOLDING –±–ª–æ–∫–∏—Ä—É–µ—Ç loss_cut

**–§–∞–π–ª:** `trailing_stop_loss.py:568-607`

**–ö–æ–¥:**
```python
if (
    effective_min_holding is not None
    and minutes_in_position < effective_min_holding
):
    if self.loss_cut_percent is not None:
        if profit_pct <= -loss_cut_from_price:
            return False, None  # ‚ö†Ô∏è –ë–õ–û–ö–ò–†–£–ï–¢ loss_cut!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- MIN_HOLDING –±–ª–æ–∫–∏—Ä—É–µ—Ç loss_cut –¥–æ 35 –º–∏–Ω—É—Ç
- –î–∞–∂–µ –µ—Å–ª–∏ —É–±—ã—Ç–æ–∫ —É–∂–µ -6% (–±–æ–ª—å—à–µ loss_cut 4%), –ø–æ–∑–∏—Ü–∏—è –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–∑–∏—Ü–∏–∏ –≤–∏—Å—è—Ç —á–∞—Å–∞–º–∏ —Å –±–æ–ª—å—à–∏–º —É–±—ã—Ç–∫–æ–º

**–í–ª–∏—è–Ω–∏–µ:**
- XRP-USDT: -6.17% –≤–∏—Å–µ–ª 10 —á–∞—Å–æ–≤
- ETH-USDT: -6.26% –≤–∏—Å–µ–ª 7 —á–∞—Å–æ–≤
- DOGE-USDT: -17.83% –≤–∏—Å–µ–ª 3 —á–∞—Å–∞ (–¥–æ–ª–∂–µ–Ω –±—ã–ª –∑–∞–∫—Ä—ã—Ç—å—Å—è –ø—Ä–∏ -8%!)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### –ü–†–û–ë–õ–ï–ú–ê #4: –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–ê–Ø - Loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ TSL

**–ü—Ä–æ–±–ª–µ–º–∞:**
- TP –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ `position_manager._check_tp_only()` ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- Loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `trailing_stop_loss.should_close_position()` ‚Üí –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è MIN_HOLDING ‚ùå

**–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:**
- TP: –Ω–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç TSL, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è MIN_HOLDING
- Loss_cut: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç TSL, –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è MIN_HOLDING

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô

---

### –ü–†–û–ë–õ–ï–ú–ê #5: `update_trailing_stop_loss()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—Ä–∏ `entry_price == 0`

**–§–∞–π–ª:** `trailing_sl_coordinator.py:425-429`

**–ö–æ–¥:**
```python
if entry_price == 0:
    logger.debug(f"‚ö†Ô∏è Entry price = 0 –¥–ª—è {symbol}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ TSL")
    return  # ‚ö†Ô∏è –ù–ï –≤—ã–∑—ã–≤–∞–µ–º should_close_position()
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `entry_price == 0` –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è
- `should_close_position()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
- –†–µ–∑—É–ª—å—Ç–∞—Ç: loss_cut –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô

---

### –ü–†–û–ë–õ–ï–ú–ê #6: –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º

**–¢–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫:**
1. `_check_position_safety()` ‚Üí –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å —Å—Ä–∞–∑—É
2. `_check_profit_harvesting()` ‚Üí PH –ø—Ä–æ–≤–µ—Ä–∫–∞
3. `_check_tp_only()` ‚Üí TP –ø—Ä–æ–≤–µ—Ä–∫–∞
4. `update_trailing_stop_loss()` ‚Üí TSL –∏ loss_cut

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `_check_position_safety()` –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏ `margin_ratio < 1.2` –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–ï–î –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ TP/loss_cut, –Ω–æ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô

---

### –ü–†–û–ë–õ–ï–ú–ê #7: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ loss_cut –≤ `position_manager`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `_check_tp_only()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ TP (–¥–ª—è –ø—Ä–∏–±—ã–ª–∏)
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ loss_cut (–¥–ª—è —É–±—ã—Ç–∫–∞)
- Loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ TSL

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ï—Å–ª–∏ TSL –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Üí loss_cut –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
- –ï—Å–ª–∏ `update_trailing_stop_loss()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚Üí loss_cut –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô

---

## üìã TODO –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### TODO #1: üî¥ –ö–†–ò–¢–ò–ß–ù–û - –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `entry_price` –∏–∑ —É—Å–ª–æ–≤–∏—è –≤—ã–∑–æ–≤–∞

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/websocket_coordinator.py:273-276`

**–ë–´–õ–û:**
```python
if (
    symbol in self.active_positions_ref
    and "entry_price" in self.active_positions_ref.get(symbol, {})
):
```

**–î–û–õ–ñ–ù–û –ë–´–¢–¨:**
```python
if symbol in self.active_positions_ref:
    # entry_price –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ update_trailing_stop_loss()
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –õ–æ–≥–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è `entry_price` —É–∂–µ –µ—Å—Ç—å –≤ `update_trailing_stop_loss()`, –Ω–æ –æ–Ω–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.

---

### TODO #2: üî¥ –ö–†–ò–¢–ò–ß–ù–û - –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –≤ `_emergency_close_position()`

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py:897-901`

**–ë–´–õ–û:**
```python
if margin_ratio < 1.2 and margin_ratio > 0:
    await self._emergency_close_position(position)
```

**–î–û–õ–ñ–ù–û –ë–´–¢–¨:**
```python
if margin_ratio < 1.2 and margin_ratio > 0:
    # ‚úÖ –ó–ê–©–ò–¢–ê: –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏, –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω–µ–µ 30 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
    position_open_time = position.get("entry_time") or position.get("timestamp")
    if position_open_time:
        time_since_open = (datetime.now() - position_open_time).total_seconds()
        if time_since_open < 30.0:
            logger.debug(f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} –æ—Ç–∫—Ä—ã—Ç–∞ {time_since_open:.1f} —Å–µ–∫ –Ω–∞–∑–∞–¥, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º emergency close (–∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)")
            return
    
    # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–±—ã—Ç–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
    pnl = position.get("upl", 0)
    margin = position.get("margin", 0)
    if margin > 0:
        pnl_percent_from_margin = abs(pnl) / margin * 100
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–±—ã—Ç–æ–∫ > 2% –æ—Ç –º–∞—Ä–∂–∏
        if pnl_percent_from_margin < 2.0:
            logger.debug(f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} margin_ratio={margin_ratio:.2f}%, –Ω–æ —É–±—ã—Ç–æ–∫ —Ç–æ–ª—å–∫–æ {pnl_percent_from_margin:.2f}% –æ—Ç –º–∞—Ä–∂–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º emergency close")
            return
    
    logger.warning(f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} –∏–º–µ–µ—Ç –Ω–∏–∑–∫—É—é –º–∞—Ä–∂—É: {margin_ratio:.2f}%. –ó–∞–∫—Ä—ã—Ç–∏–µ...")
    await self._emergency_close_position(position)
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ —Ä–∞—Å—á–µ—Ç–∞ –º–∞—Ä–∂–∏.

---

### TODO #3: üî¥ –ö–†–ò–¢–ò–ß–ù–û - –°–¥–µ–ª–∞—Ç—å loss_cut –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ MIN_HOLDING –¥–ª—è –±–æ–ª—å—à–∏—Ö —É–±—ã—Ç–∫–æ–≤

**–§–∞–π–ª:** `src/strategies/scalping/futures/indicators/trailing_stop_loss.py:568-634`

**–ë–´–õ–û:**
```python
# –°—Ç—Ä–æ–∫–∏ 568-592: MIN_HOLDING –±–ª–æ–∫–∏—Ä—É–µ—Ç loss_cut
if (
    effective_min_holding is not None
    and minutes_in_position < effective_min_holding
):
    if self.loss_cut_percent is not None:
        if profit_pct <= -loss_cut_from_price:
            return False, None  # –ë–õ–û–ö–ò–†–£–ï–¢ loss_cut!
```

**–î–û–õ–ñ–ù–û –ë–´–¢–¨:**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º loss_cut –ü–ï–†–ï–î MIN_HOLDING –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
if self.loss_cut_percent is not None:
    loss_cut_from_price = self.loss_cut_percent / self.leverage
    
    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ï—Å–ª–∏ —É–±—ã—Ç–æ–∫ >= loss_cut, –∑–∞–∫—Ä—ã–≤–∞–µ–º –°–†–ê–ó–£, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç MIN_HOLDING
    if profit_pct <= -loss_cut_from_price:
        # ‚úÖ –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–±—ã—Ç–∫–æ–≤ (>= loss_cut) –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ (5 —Å–µ–∫)
        seconds_in_position = minutes_in_position * 60.0
        min_critical_hold_seconds = 5.0
        
        if seconds_in_position >= min_critical_hold_seconds:
            # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ loss_cut
            logger.warning(f"‚ö†Ô∏è Loss-cut: {profit_pct:.2%} <= -{loss_cut_from_price:.2%}, –∑–∞–∫—Ä—ã–≤–∞–µ–º (–≤—Ä–µ–º—è: {minutes_in_position:.2f} –º–∏–Ω)")
            return True, "loss_cut"
        else:
            # –ñ–¥–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            logger.debug(f"‚è±Ô∏è Loss-cut –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π: {seconds_in_position:.1f} —Å–µ–∫ < {min_critical_hold_seconds:.1f} —Å–µ–∫")
            return False, None

# ‚úÖ –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ–º MIN_HOLDING –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤
if (
    effective_min_holding is not None
    and minutes_in_position < effective_min_holding
):
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –¥—Ä—É–≥–∏–º –ø—Ä–∏—á–∏–Ω–∞–º (trailing stop, –Ω–æ –ù–ï loss_cut)
    logger.debug(f"‚è±Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è: {minutes_in_position:.2f} –º–∏–Ω < {effective_min_holding:.2f} –º–∏–Ω")
    return False, None

# ‚úÖ –û–±—ã—á–Ω—ã–π loss_cut (–µ—Å–ª–∏ MIN_HOLDING –ø—Ä–æ–π–¥–µ–Ω, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—à–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞)
if self.loss_cut_percent is not None:
    loss_cut_from_price = self.loss_cut_percent / self.leverage
    if profit_pct <= -loss_cut_from_price:
        logger.warning(f"‚ö†Ô∏è Loss-cut: {profit_pct:.2%} <= -{loss_cut_from_price:.2%}, –∑–∞–∫—Ä—ã–≤–∞–µ–º")
        return True, "loss_cut"
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** Loss_cut –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ MIN_HOLDING –¥–ª—è –±–æ–ª—å—à–∏—Ö —É–±—ã—Ç–∫–æ–≤. MIN_HOLDING –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–∞–ª—ã–µ —É–±—ã—Ç–∫–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç —à—É–º–∞).

---

### TODO #4: üü† –í–´–°–û–ö–û - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É loss_cut –≤ `position_manager._check_tp_only()`

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py:1632-1908`

**–î–û–ë–ê–í–ò–¢–¨:**
```python
async def _check_tp_only(self, position: Dict[str, Any]):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ TP –∏ loss_cut"""
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ TP ...
    
    # ‚úÖ –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ loss_cut –¥–ª—è —É–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    if pnl_percent < 0:
        # –ü–æ–ª—É—á–∞–µ–º loss_cut –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        loss_cut_percent = self._get_loss_cut_percent(symbol, regime)
        
        if loss_cut_percent:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ % –æ—Ç —Ü–µ–Ω—ã (–¥–µ–ª–∏–º –Ω–∞ leverage)
            leverage = getattr(self.scalping_config, "leverage", 5)
            loss_cut_from_price = loss_cut_percent / leverage
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º loss_cut (—Å —É—á–µ—Ç–æ–º MIN_HOLDING)
            time_since_open = self._get_time_since_open(position)
            min_holding_seconds = self._get_min_holding_seconds(symbol, regime)
            
            # ‚úÖ –î–ª—è –±–æ–ª—å—à–∏—Ö —É–±—ã—Ç–∫–æ–≤ (>= loss_cut) –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ (5 —Å–µ–∫)
            if abs(pnl_percent) >= loss_cut_from_price:
                if time_since_open >= 5.0:  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                    logger.warning(f"‚ö†Ô∏è Loss-cut: {symbol} PnL={pnl_percent:.2f}% <= -{loss_cut_from_price:.2f}%, –∑–∞–∫—Ä—ã–≤–∞–µ–º")
                    await self._close_position_by_reason(position, "loss_cut")
                    return
                else:
                    logger.debug(f"‚è±Ô∏è Loss-cut –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π: {time_since_open:.1f} —Å–µ–∫ < 5.0 —Å–µ–∫")
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É TP –∏ loss_cut –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ. Loss_cut –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç TSL.

---

### TODO #5: üü† –í–´–°–û–ö–û - –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∏–∑ `update_trailing_stop_loss()` –ø—Ä–∏ `entry_price == 0`

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/trailing_sl_coordinator.py:425-429`

**–ë–´–õ–û:**
```python
if entry_price == 0:
    logger.debug(f"‚ö†Ô∏è Entry price = 0 –¥–ª—è {symbol}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ TSL")
    return
```

**–î–û–õ–ñ–ù–û –ë–´–¢–¨:**
```python
if entry_price == 0:
    logger.warning(f"‚ö†Ô∏è Entry price = 0 –¥–ª—è {symbol}, –Ω–µ –º–æ–∂–µ–º –æ–±–Ω–æ–≤–∏—Ç—å TSL, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–∑–∏—Ü–∏–∏")
    # ‚úÖ –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤–æ–æ–±—â–µ
    if not self._has_position(symbol):
        return
    # ‚úÖ –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å entry_price –∏–∑ API –µ—â–µ —Ä–∞–∑ (–µ—Å–ª–∏ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ)
    # –ù–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    logger.debug(f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ entry_price=0, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ TSL")
    return
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ï—Å–ª–∏ `entry_price == 0`, TSL –Ω–µ –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ - –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, loss_cut –≤ position_manager) –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

---

### TODO #6: üü° –°–†–ï–î–ù–ò–ô - –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ loss_cut –ø—Ä–æ–≤–µ—Ä–æ–∫

**–§–∞–π–ª—ã:**
- `trailing_stop_loss.py:568-634`
- `position_manager.py` (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É loss_cut)

**–î–û–ë–ê–í–ò–¢–¨:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ loss_cut (–¥–∞–∂–µ –µ—Å–ª–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)
- –ó–Ω–∞—á–µ–Ω–∏—è: `profit_pct`, `loss_cut_from_price`, `minutes_in_position`, `will_close`
- –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è, –ø–æ—á–µ–º—É loss_cut –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.

---

## üîó –í–ó–ê–ò–ú–û–°–í–Ø–ó–ò –ü–†–û–ë–õ–ï–ú

### –°–≤—è–∑—å #1: –ü—Ä–æ–±–ª–µ–º–∞ #1 ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #3

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ï—Å–ª–∏ `update_trailing_stop_loss()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–ü—Ä–æ–±–ª–µ–º–∞ #1)
- –¢–æ `should_close_position()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
- –¢–æ loss_cut –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–æ–æ–±—â–µ
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–∑–∏—Ü–∏–∏ –≤–∏—Å—è—Ç —á–∞—Å–∞–º–∏ –≤ —É–±—ã—Ç–∫–µ

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±–µ –ø—Ä–æ–±–ª–µ–º—ã!

---

### –°–≤—è–∑—å #2: –ü—Ä–æ–±–ª–µ–º–∞ #2 ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #3

**–≠—Ñ—Ñ–µ–∫—Ç:**
- `_emergency_close_position()` –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ —Å—Ä–∞–∑—É (–ü—Ä–æ–±–ª–µ–º–∞ #2)
- –ù–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `margin_ratio < 1.2`
- –î–ª—è –ø–æ–∑–∏—Ü–∏–π —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º `margin_ratio` –ø—Ä–æ–±–ª–µ–º–∞ #3 –≤—Å–µ —Ä–∞–≤–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ!

---

### –°–≤—è–∑—å #3: –ü—Ä–æ–±–ª–µ–º–∞ #3 ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #4

**–≠—Ñ—Ñ–µ–∫—Ç:**
- Loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ TSL (–ü—Ä–æ–±–ª–µ–º–∞ #4)
- –ò –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è MIN_HOLDING (–ü—Ä–æ–±–ª–µ–º–∞ #3)
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - loss_cut –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É (TODO #4) –∏ —É–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (TODO #3)!

---

## üìä –ü–ê–†–ê–ú–ï–¢–†–´ –ò–ó –ö–û–ù–§–ò–ì–ê (ranging —Ä–µ–∂–∏–º)

### Trailing SL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
```yaml
ranging:
  loss_cut_percent: 4.0      # 4% –æ—Ç –º–∞—Ä–∂–∏
  timeout_loss_percent: 2.0   # 2% –æ—Ç –º–∞—Ä–∂–∏ –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞
  timeout_minutes: 120        # 120 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç
  min_holding_minutes: 35.0   # 35 –º–∏–Ω—É—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ
  min_critical_hold_seconds: 30.0  # 30 —Å–µ–∫ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–±—ã—Ç–∫–æ–≤
```

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- `min_holding_minutes: 35.0` - –±–ª–æ–∫–∏—Ä—É–µ—Ç loss_cut –¥–æ 35 –º–∏–Ω—É—Ç ‚ùå
- `loss_cut_percent: 4.0` - –¥–æ–ª–∂–µ–Ω –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ -4% –æ—Ç –º–∞—Ä–∂–∏
- `min_critical_hold_seconds: 30.0` - –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–±—ã—Ç–∫–æ–≤ (2x = 8%)

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
- –£–±—ã—Ç–æ–∫ >= 4% ‚Üí –∑–∞–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ 5 —Å–µ–∫—É–Ω–¥ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞)
- –£–±—ã—Ç–æ–∫ >= 8% ‚Üí –∑–∞–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ 5 —Å–µ–∫—É–Ω–¥ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
- –£–±—ã—Ç–æ–∫ < 4% ‚Üí –∂–¥–∞—Ç—å –¥–æ 35 –º–∏–Ω—É—Ç (–∑–∞—â–∏—Ç–∞ –æ—Ç —à—É–º–∞)

### –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
- –£–±—ã—Ç–æ–∫ >= 4% ‚Üí –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–æ 35 –º–∏–Ω—É—Ç ‚ùå
- –£–±—ã—Ç–æ–∫ >= 8% ‚Üí –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–æ 30 —Å–µ–∫—É–Ω–¥ ‚ùå

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û) - –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
1. ‚úÖ TODO #1: –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `entry_price` –∏–∑ —É—Å–ª–æ–≤–∏—è
2. ‚úÖ TODO #2: –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π emergency close
3. ‚úÖ TODO #3: –°–¥–µ–ª–∞—Ç—å loss_cut –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ MIN_HOLDING

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–´–°–û–ö–û) - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:
4. ‚úÖ TODO #4: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É loss_cut –≤ position_manager
5. ‚úÖ TODO #5: –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –ø—Ä–∏ entry_price == 0

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–°–†–ï–î–ù–ò–ô) - –£–ª—É—á—à–µ–Ω–∏—è:
6. ‚úÖ TODO #6: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. ‚úÖ –ü–æ–∑–∏—Ü–∏–∏ —Å —É–±—ã—Ç–∫–æ–º >= loss_cut –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ 5 —Å–µ–∫—É–Ω–¥ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç MIN_HOLDING)
2. ‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è (–∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)
3. ‚úÖ `update_trailing_stop_loss()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π (–¥–∞–∂–µ –±–µ–∑ `entry_price`)
4. ‚úÖ Loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç TSL (–≤ position_manager)

---

---

## üìù –î–ï–¢–ê–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### TODO #1: –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `entry_price` –∏–∑ —É—Å–ª–æ–≤–∏—è

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/websocket_coordinator.py`

**–°—Ç—Ä–æ–∫–∏:** 273-276

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
if (
    symbol in self.active_positions_ref
    and "entry_price" in self.active_positions_ref.get(symbol, {})
):
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º TP —á–µ—Ä–µ–∑ manage_position
    if self.position_manager:
        await self.position_manager.manage_position(
            self.active_positions_ref[symbol]
        )
    # TSL –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ TP (–µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –µ—â–µ –æ—Ç–∫—Ä—ã—Ç–∞)
    if symbol in self.active_positions_ref:
        if self.update_trailing_sl_callback:
            await self.update_trailing_sl_callback(symbol, price)
        elif self.trailing_sl_coordinator:
            await self.trailing_sl_coordinator.update_trailing_stop_loss(
                symbol, price
            )
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**
```python
if symbol in self.active_positions_ref:
    # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É entry_price - –æ–Ω –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ update_trailing_stop_loss()
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º TP —á–µ—Ä–µ–∑ manage_position
    if self.position_manager:
        await self.position_manager.manage_position(
            self.active_positions_ref[symbol]
        )
    # TSL –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ TP (–µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –µ—â–µ –æ—Ç–∫—Ä—ã—Ç–∞)
    if symbol in self.active_positions_ref:
        if self.update_trailing_sl_callback:
            await self.update_trailing_sl_callback(symbol, price)
        elif self.trailing_sl_coordinator:
            await self.trailing_sl_coordinator.update_trailing_stop_loss(
                symbol, price
            )
```

**–ü–æ—á–µ–º—É:** –õ–æ–≥–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è `entry_price` —É–∂–µ –µ—Å—Ç—å –≤ `update_trailing_stop_loss()` (—Å—Ç—Ä–æ–∫–∏ 387-429), –Ω–æ –æ–Ω–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.

---

### TODO #2: –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π emergency close

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

**–°—Ç—Ä–æ–∫–∏:** 895-906

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
if margin_ratio < 1.2 and margin_ratio > 0:
    logger.warning(
        f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} –∏–º–µ–µ—Ç –Ω–∏–∑–∫—É—é –º–∞—Ä–∂—É: {margin_ratio:.2f}%. –ó–∞–∫—Ä—ã—Ç–∏–µ..."
    )
    await self._emergency_close_position(position)
elif margin_ratio <= 0:
    logger.warning(
        f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} –∏–º–µ–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π margin_ratio: {margin_ratio:.2f}%. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ."
    )
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**
```python
if margin_ratio < 1.2 and margin_ratio > 0:
    # ‚úÖ –ó–ê–©–ò–¢–ê: –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏, –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω–µ–µ 30 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
    position_open_time = None
    try:
        # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–∑ –ø–æ–∑–∏—Ü–∏–∏
        if symbol in self.active_positions:
            pos_data = self.active_positions[symbol]
            if isinstance(pos_data, dict):
                position_open_time = pos_data.get("entry_time") or pos_data.get("timestamp") or pos_data.get("open_time")
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
        if not position_open_time:
            c_time = position.get("cTime")
            u_time = position.get("uTime")
            if c_time or u_time:
                entry_time_str = c_time or u_time
                try:
                    if isinstance(entry_time_str, str) and entry_time_str.isdigit():
                        entry_timestamp = int(entry_time_str) / 1000.0
                        position_open_time = datetime.fromtimestamp(entry_timestamp)
                    elif isinstance(entry_time_str, (int, float)):
                        entry_timestamp = float(entry_time_str) / 1000.0 if float(entry_time_str) > 1000000000000 else float(entry_time_str)
                        position_open_time = datetime.fromtimestamp(entry_timestamp)
                except (ValueError, TypeError):
                    pass
    except Exception as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–ª—è {symbol}: {e}")
    
    time_since_open = 0.0
    if position_open_time:
        if isinstance(position_open_time, datetime):
            time_since_open = (datetime.now() - position_open_time).total_seconds()
        else:
            try:
                time_since_open = (datetime.now() - datetime.fromtimestamp(float(position_open_time))).total_seconds()
            except (ValueError, TypeError):
                pass
    
    # ‚úÖ –ó–ê–©–ò–¢–ê #1: –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏, –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω–µ–µ 30 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
    if time_since_open < 30.0:
        logger.debug(
            f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} –æ—Ç–∫—Ä—ã—Ç–∞ {time_since_open:.1f} —Å–µ–∫ –Ω–∞–∑–∞–¥, "
            f"–ø—Ä–æ–ø—É—Å–∫–∞–µ–º emergency close (–∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π, margin_ratio={margin_ratio:.2f}%)"
        )
        return
    
    # ‚úÖ –ó–ê–©–ò–¢–ê #2: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–±—ã—Ç–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (> 2% –æ—Ç –º–∞—Ä–∂–∏)
    try:
        pnl = float(position.get("upl", "0") or 0)
        margin = float(position.get("margin", "0") or 0)
        if margin > 0:
            pnl_percent_from_margin = abs(pnl) / margin * 100
            # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–±—ã—Ç–æ–∫ > 2% –æ—Ç –º–∞—Ä–∂–∏
            if pnl_percent_from_margin < 2.0:
                logger.debug(
                    f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} margin_ratio={margin_ratio:.2f}%, –Ω–æ —É–±—ã—Ç–æ–∫ —Ç–æ–ª—å–∫–æ {pnl_percent_from_margin:.2f}% –æ—Ç –º–∞—Ä–∂–∏, "
                    f"–ø—Ä–æ–ø—É—Å–∫–∞–µ–º emergency close (–∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)"
                )
                return
    except (ValueError, TypeError) as e:
        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —É–±—ã—Ç–∫–∞ –¥–ª—è emergency close {symbol}: {e}")
    
    logger.warning(
        f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} –∏–º–µ–µ—Ç –Ω–∏–∑–∫—É—é –º–∞—Ä–∂—É: {margin_ratio:.2f}%. –ó–∞–∫—Ä—ã—Ç–∏–µ... "
        f"(–≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è: {time_since_open:.1f} —Å–µ–∫)"
    )
    await self._emergency_close_position(position)
elif margin_ratio <= 0:
    logger.warning(
        f"‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏—è {symbol} –∏–º–µ–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π margin_ratio: {margin_ratio:.2f}%. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ."
    )
```

**–ü–æ—á–µ–º—É:** –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ —Ä–∞—Å—á–µ—Ç–∞ –º–∞—Ä–∂–∏. –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é.

---

### TODO #3: –°–¥–µ–ª–∞—Ç—å loss_cut –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ MIN_HOLDING

**–§–∞–π–ª:** `src/strategies/scalping/futures/indicators/trailing_stop_loss.py`

**–°—Ç—Ä–æ–∫–∏:** 568-634

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
# ‚úÖ –ü–†–ê–í–ö–ê #2: –ü—Ä–æ–≤–µ—Ä–∫–∞ min_holding –ü–ï–†–ï–î –æ–±—ã—á–Ω—ã–º loss_cut
if (
    effective_min_holding is not None
    and minutes_in_position < effective_min_holding
):
    # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º loss_cut —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ min_holding (–∫—Ä–æ–º–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)
    if self.loss_cut_percent is not None:
        loss_cut_from_price = self.loss_cut_percent / self.leverage
        if profit_pct <= -loss_cut_from_price:
            # ... –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ ...
            return False, None  # –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º - min_holding –∑–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º loss_cut –ü–ï–†–ï–î MIN_HOLDING –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
# Loss_cut –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ MIN_HOLDING –¥–ª—è –±–æ–ª—å—à–∏—Ö —É–±—ã—Ç–∫–æ–≤
if self.loss_cut_percent is not None:
    loss_cut_from_price = self.loss_cut_percent / self.leverage
    
    # ‚úÖ –ï—Å–ª–∏ —É–±—ã—Ç–æ–∫ >= loss_cut, –∑–∞–∫—Ä—ã–≤–∞–µ–º –°–†–ê–ó–£ (–ø–æ—Å–ª–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ 5 —Å–µ–∫)
    if profit_pct <= -loss_cut_from_price:
        seconds_in_position = minutes_in_position * 60.0
        min_loss_cut_hold_seconds = 5.0  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è loss_cut
        
        if seconds_in_position >= min_loss_cut_hold_seconds:
            # ‚úÖ –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ loss_cut, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç MIN_HOLDING
            loss_from_margin = abs(profit_pct) * self.leverage
            logger.warning(
                f"‚ö†Ô∏è Loss-cut: –ø—Ä–∏–±—ã–ª—å {profit_pct:.2%} –æ—Ç —Ü–µ–Ω—ã "
                f"({loss_from_margin:.2%} –æ—Ç –º–∞—Ä–∂–∏) <= -{loss_cut_from_price:.2%} –æ—Ç —Ü–µ–Ω—ã "
                f"(-{self.loss_cut_percent:.2%} –æ—Ç –º–∞—Ä–∂–∏, leverage={self.leverage}x), "
                f"–∑–∞–∫—Ä—ã–≤–∞–µ–º –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç MIN_HOLDING "
                f"(time_in_position={minutes_in_position:.2f} –º–∏–Ω, entry_time={entry_iso}, branch=loss_cut_priority)"
            )
            if self.debug_logger:
                self.debug_logger.log_tsl_loss_cut_check(
                    symbol=getattr(self, "_symbol", "UNKNOWN"),
                    profit_pct=profit_pct,
                    loss_cut_from_price=loss_cut_from_price,
                    will_close=True,
                )
            return True, "loss_cut"
        else:
            # ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è loss_cut (5 —Å–µ–∫)
            logger.debug(
                f"‚è±Ô∏è Loss-cut –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π: "
                f"–ø—Ä–∏–±—ã–ª—å {profit_pct:.2%} <= -{loss_cut_from_price:.2%}, "
                f"–Ω–æ –ø–æ–∑–∏—Ü–∏—è –¥–µ—Ä–∂–∏—Ç—Å—è {seconds_in_position:.1f} —Å–µ–∫ < {min_loss_cut_hold_seconds:.1f} —Å–µ–∫, "
                f"–Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º (entry_time={entry_iso}, branch=loss_cut_min_delay)"
            )
            if self.debug_logger:
                self.debug_logger.log_tsl_loss_cut_check(
                    symbol=getattr(self, "_symbol", "UNKNOWN"),
                    profit_pct=profit_pct,
                    loss_cut_from_price=loss_cut_from_price,
                    will_close=False,  # –ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                )
            return False, None

# ‚úÖ –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ–º MIN_HOLDING –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤
# MIN_HOLDING –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –º–∞–ª—ã–µ —É–±—ã—Ç–∫–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç —à—É–º–∞), –Ω–æ –Ω–µ –±–æ–ª—å—à–∏–µ —É–±—ã—Ç–∫–∏ (loss_cut)
if (
    effective_min_holding is not None
    and minutes_in_position < effective_min_holding
):
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –¥—Ä—É–≥–∏–º –ø—Ä–∏—á–∏–Ω–∞–º (trailing stop), –Ω–æ –ù–ï loss_cut
    logger.debug(
        f"‚è±Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è: –ø–æ–∑–∏—Ü–∏—è –¥–µ—Ä–∂–∏—Ç—Å—è {minutes_in_position:.2f} –º–∏–Ω < {effective_min_holding:.2f} –º–∏–Ω, "
        f"–Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º (profit={profit_pct:.2%}, entry_time={entry_iso}, branch=min_holding)"
    )
    if self.debug_logger:
        self.debug_logger.log_tsl_min_holding_block(
            symbol=getattr(self, "_symbol", "UNKNOWN"),
            minutes_in_position=minutes_in_position,
            min_holding=effective_min_holding,
            profit_pct=profit_pct,
        )
    return False, None

# ‚úÖ –û–±—ã—á–Ω—ã–π loss_cut (–µ—Å–ª–∏ MIN_HOLDING –ø—Ä–æ–π–¥–µ–Ω, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—à–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞)
# –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ø–µ—Ä—å –∏–∑–±—ã—Ç–æ—á–Ω–∞, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
if self.loss_cut_percent is not None:
    loss_cut_from_price = self.loss_cut_percent / self.leverage
    if profit_pct <= -loss_cut_from_price:
        loss_from_margin = abs(profit_pct) * self.leverage
        logger.warning(
            f"‚ö†Ô∏è Loss-cut: –ø—Ä–∏–±—ã–ª—å {profit_pct:.2%} –æ—Ç —Ü–µ–Ω—ã "
            f"({loss_from_margin:.2%} –æ—Ç –º–∞—Ä–∂–∏) <= -{loss_cut_from_price:.2%} –æ—Ç —Ü–µ–Ω—ã "
            f"(-{self.loss_cut_percent:.2%} –æ—Ç –º–∞—Ä–∂–∏, leverage={self.leverage}x), "
            f"–∑–∞–∫—Ä—ã–≤–∞–µ–º (time_in_position={minutes_in_position:.2f} –º–∏–Ω, entry_time={entry_iso}, branch=loss_cut)"
        )
        if self.debug_logger:
            self.debug_logger.log_tsl_loss_cut_check(
                symbol=getattr(self, "_symbol", "UNKNOWN"),
                profit_pct=profit_pct,
                loss_cut_from_price=loss_cut_from_price,
                will_close=True,
            )
        return True, "loss_cut"
```

**–ü–æ—á–µ–º—É:** Loss_cut –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ MIN_HOLDING. MIN_HOLDING –¥–æ–ª–∂–µ–Ω –∑–∞—â–∏—â–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç —à—É–º–∞ (–º–∞–ª—ã–µ —É–±—ã—Ç–∫–∏), –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —É–±—ã—Ç–∫–∞—Ö.

---

### TODO #4: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É loss_cut –≤ position_manager

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

**–ú–µ—Å—Ç–æ:** –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 1339 (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ TSL)

**–î–æ–±–∞–≤–∏—Ç—å:**
```python
            # ‚úÖ –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ loss_cut –¥–ª—è –ø–æ–∑–∏—Ü–∏–π –ë–ï–ó TSL –∏–ª–∏ —Å –±–æ–ª—å—à–∏–º —É–±—ã—Ç–∫–æ–º
            # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ loss_cut –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ TSL –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            if not tsl or profit_pct < -0.01:  # –ï—Å–ª–∏ –Ω–µ—Ç TSL –∏–ª–∏ —É–±—ã—Ç–æ–∫ > 1%
                # –ü–æ–ª—É—á–∞–µ–º loss_cut –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
                loss_cut_percent = None
                try:
                    if hasattr(self.orchestrator, "trailing_sl_coordinator"):
                        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã TSL –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
                        tsl_params = self.orchestrator.trailing_sl_coordinator._get_trailing_sl_params(
                            symbol, market_regime
                        )
                        if tsl_params:
                            loss_cut_percent = tsl_params.get("loss_cut_percent")
                except Exception as e:
                    logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è loss_cut_percent –¥–ª—è {symbol}: {e}")
                
                if loss_cut_percent:
                    leverage = getattr(self.scalping_config, "leverage", 5)
                    loss_cut_from_price = loss_cut_percent / leverage
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º loss_cut (—Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π)
                    time_since_open = 0.0
                    try:
                        entry_time_str = position.get("cTime", position.get("openTime", ""))
                        if entry_time_str:
                            if isinstance(entry_time_str, str) and entry_time_str.isdigit():
                                entry_timestamp = int(entry_time_str) / 1000.0
                                current_timestamp = datetime.now().timestamp()
                                time_since_open = current_timestamp - entry_timestamp
                    except Exception:
                        pass
                    
                    # ‚úÖ –î–ª—è –±–æ–ª—å—à–∏—Ö —É–±—ã—Ç–∫–æ–≤ (>= loss_cut) –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ (5 —Å–µ–∫)
                    if profit_pct <= -loss_cut_from_price:
                        if time_since_open >= 5.0:  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                            logger.warning(
                                f"‚ö†Ô∏è Loss-cut (position_manager): {symbol} PnL={profit_pct:.2%} <= -{loss_cut_from_price:.2%}%, –∑–∞–∫—Ä—ã–≤–∞–µ–º"
                            )
                            await self._close_position_by_reason(position, "loss_cut")
                            return
```

**–ü–æ—á–µ–º—É:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É loss_cut –¥–∞–∂–µ –µ—Å–ª–∏ TSL –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è.

---

## üîÑ –ü–û–†–Ø–î–û–ö –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –≠—Ç–∞–ø 1 (–ö–†–ò–¢–ò–ß–ù–û):
1. TODO #1: –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É entry_price
2. TODO #3: –°–¥–µ–ª–∞—Ç—å loss_cut –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ MIN_HOLDING

### –≠—Ç–∞–ø 2 (–í–´–°–û–ö–û):
3. TODO #2: –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π emergency close
4. TODO #4: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É loss_cut –≤ position_manager

### –≠—Ç–∞–ø 3 (–£–ª—É—á—à–µ–Ω–∏—è):
5. TODO #5: –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –ø—Ä–∏ entry_price == 0
6. TODO #6: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

**–°–¢–ê–¢–£–°:** üìã TODO –ì–û–¢–û–í –ö –ü–†–ò–ú–ï–ù–ï–ù–ò–Æ

**–í–ù–ò–ú–ê–ù–ò–ï:** –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω—ã –∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –≤–º–µ—Å—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º!

**–ü–û–†–Ø–î–û–ö:** –ü—Ä–∏–º–µ–Ω—è—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º - —Å–Ω–∞—á–∞–ª–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (TODO #1, #3), –∑–∞—Ç–µ–º –≤—ã—Å–æ–∫–∏–µ (#2, #4)

