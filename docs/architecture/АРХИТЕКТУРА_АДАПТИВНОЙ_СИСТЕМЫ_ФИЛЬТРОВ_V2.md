# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ V2 (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)

## ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫—Ä–∏—Ç–∏–∫–∏ Sonnet

### –ü—Ä–æ–±–ª–µ–º—ã V1:
1. ‚ùå –°–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–µ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç)
2. ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏ (11 √ó 6 = 66 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π)
3. ‚ùå –†–∏—Å–∫ –ø–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ overfitting
4. ‚ùå –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

### –†–µ—à–µ–Ω–∏—è V2:
1. ‚úÖ **–í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤–º–µ—Å—Ç–æ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫
2. ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** (3-4 —Ñ–∞–∫—Ç–æ—Ä–∞ –≤–º–µ—Å—Ç–æ 6)
3. ‚úÖ **–ú–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
4. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## üìä –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏

### –ü—Ä–∏–Ω—Ü–∏–ø: –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–æ—Ä–º—É–ª–∞:**
```python
final_value = base * (1 + Œ£(weight_i * factor_i))
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –õ–∏–Ω–µ–π–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ)
- –õ–µ–≥—á–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å
- –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫ overfitting
- –ë—ã—Å—Ç—Ä–µ–µ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è

---

## üéØ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (3 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–∞)

### –§–∞–∫—Ç–æ—Ä 1: –†–µ–∂–∏–º —Ä—ã–Ω–∫–∞ (–≤–µ—Å: 0.5)
- **trending**: +20%
- **ranging**: 0%
- **choppy**: -20%

### –§–∞–∫—Ç–æ—Ä 2: –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (–≤–µ—Å: 0.3)
- **–í—ã—Å–æ–∫–∞—è** (>3%): +30%
- **–°—Ä–µ–¥–Ω—è—è** (1-3%): 0%
- **–ù–∏–∑–∫–∞—è** (<1%): -30%

### –§–∞–∫—Ç–æ—Ä 3: Win Rate (–≤–µ—Å: 0.2)
- **–í—ã—Å–æ–∫–∏–π** (>60%): -20%
- **–°—Ä–µ–¥–Ω–∏–π** (40-60%): 0%
- **–ù–∏–∑–∫–∏–π** (<40%): +20%

**–ò—Ç–æ–≥–æ:** `1 + 0.5*regime + 0.3*vol + 0.2*winrate`

---

## üìã –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### 1. V-–æ–±—Ä–∞–∑–Ω—ã–π —Ä–∞–∑–≤–æ—Ä–æ—Ç (reversal_threshold)

**–ë–∞–∑–∞:** 0.15% (0.0015)

**–§–æ—Ä–º—É–ª–∞:**
```python
reversal_threshold = 0.0015 * (1 + 0.5*regime_factor + 0.3*vol_factor + 0.2*winrate_factor)
```

**–§–∞–∫—Ç–æ—Ä—ã:**
- `regime_factor`: trending=+0.2, ranging=0.0, choppy=-0.2
- `vol_factor`: high=+0.3, medium=0.0, low=-0.3
- `winrate_factor`: high=-0.2, medium=0.0, low=+0.2

**–ü—Ä–∏–º–µ—Ä—ã:**
- Trending + High Vol + Low Win Rate:
  - `0.0015 * (1 + 0.5*0.2 + 0.3*0.3 + 0.2*0.2) = 0.0015 * 1.23 = 0.18%` ‚úÖ
- Ranging + Low Vol + High Win Rate:
  - `0.0015 * (1 + 0.5*0.0 + 0.3*(-0.3) + 0.2*(-0.2)) = 0.0015 * 0.91 = 0.14%` ‚úÖ

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** min=0.05%, max=0.5%

---

### 2. ADX Threshold

**–ë–∞–∑–∞:** 20.0

**–§–æ—Ä–º—É–ª–∞:**
```python
adx_threshold = 20.0 * (1 + 0.5*regime_factor + 0.3*vol_factor + 0.2*winrate_factor)
```

**–§–∞–∫—Ç–æ—Ä—ã:**
- `regime_factor`: trending=+0.15, ranging=-0.15, choppy=-0.25
- `vol_factor`: high=-0.2, medium=0.0, low=+0.2
- `winrate_factor`: high=-0.15, medium=0.0, low=+0.15

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** min=15.0, max=28.0

---

### 3. Correlation Threshold

**–ë–∞–∑–∞:** 0.7

**–§–æ—Ä–º—É–ª–∞:**
```python
correlation_threshold = 0.7 * (1 + 0.5*regime_factor + 0.3*vol_factor + 0.2*winrate_factor)
```

**–§–∞–∫—Ç–æ—Ä—ã:**
- `regime_factor`: trending=-0.1, ranging=-0.15, choppy=-0.2
- `vol_factor`: high=0.0, medium=0.0, low=0.0 (–Ω–µ –≤–ª–∏—è–µ—Ç)
- `winrate_factor`: high=-0.1, medium=0.0, low=+0.1

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** min=0.5, max=0.8

---

### 4. Min Signal Strength

**–ë–∞–∑–∞:** 0.7

**–§–æ—Ä–º—É–ª–∞:**
```python
min_signal_strength = 0.7 * (1 + 0.5*regime_factor + 0.3*vol_factor + 0.2*winrate_factor)
```

**–§–∞–∫—Ç–æ—Ä—ã:**
- `regime_factor`: trending=-0.1, ranging=0.0, choppy=+0.1
- `vol_factor`: high=0.0, medium=0.0, low=0.0 (–Ω–µ –≤–ª–∏—è–µ—Ç)
- `winrate_factor`: high=-0.15, medium=0.0, low=+0.15

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** min=0.5, max=0.85

---

### 5. MACD Strength Divisor

**–ë–∞–∑–∞:** 200.0

**–§–æ—Ä–º—É–ª–∞:**
```python
macd_divisor = 200.0 * (1 + 0.5*regime_factor + 0.3*vol_factor + 0.2*winrate_factor)
```

**–§–∞–∫—Ç–æ—Ä—ã:**
- `regime_factor`: trending=-0.15, ranging=+0.15, choppy=+0.25
- `vol_factor`: high=-0.25, medium=0.0, low=+0.25
- `winrate_factor`: high=0.0, medium=0.0, low=0.0 (–Ω–µ –≤–ª–∏—è–µ—Ç)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** min=150.0, max=280.0

---

### 6. Strength Multiplier

**–ë–∞–∑–∞:** 2000.0

**–§–æ—Ä–º—É–ª–∞:**
```python
strength_multiplier = 2000.0 * (1 + 0.5*regime_factor + 0.3*vol_factor)
```

**–§–∞–∫—Ç–æ—Ä—ã:**
- `regime_factor`: trending=+0.15, ranging=-0.1, choppy=-0.15
- `vol_factor`: high=+0.25, medium=0.0, low=-0.15

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** min=1500.0, max=2800.0

---

### 7-11. –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)

–í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—É –∂–µ —Ñ–æ—Ä–º—É–ª—É —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏ –∏ –≤–µ—Å–∞–º–∏.

---

## üèõÔ∏è –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–ª–∞—Å—Å: `AdaptiveFilterParametersV2`

```python
class AdaptiveFilterParametersV2:
    """
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤.
    –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–º–µ—Å—Ç–æ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫.
    """
    
    # –í–µ—Å–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
    WEIGHTS = {
        "regime": 0.5,      # 50% –≤–ª–∏—è–Ω–∏—è
        "volatility": 0.3,  # 30% –≤–ª–∏—è–Ω–∏—è
        "winrate": 0.2,     # 20% –≤–ª–∏—è–Ω–∏—è
    }
    
    # –§–∞–∫—Ç–æ—Ä—ã –ø–æ —Ä–µ–∂–∏–º–∞–º
    REGIME_FACTORS = {
        "reversal_threshold": {
            "trending": 0.2,
            "ranging": 0.0,
            "choppy": -0.2,
        },
        "adx_threshold": {
            "trending": 0.15,
            "ranging": -0.15,
            "choppy": -0.25,
        },
        # ... –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    }
    
    # –§–∞–∫—Ç–æ—Ä—ã –ø–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
    VOLATILITY_FACTORS = {
        "reversal_threshold": {
            "high": 0.3,    # >3%
            "medium": 0.0,  # 1-3%
            "low": -0.3,    # <1%
        },
        # ... –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    }
    
    # –§–∞–∫—Ç–æ—Ä—ã –ø–æ win rate
    WINRATE_FACTORS = {
        "reversal_threshold": {
            "high": -0.2,   # >60%
            "medium": 0.0,  # 40-60%
            "low": 0.2,     # <40%
        },
        # ... –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    }
    
    def __init__(
        self,
        regime_manager: AdaptiveRegimeManager,
        data_registry: DataRegistry,
        trading_statistics: TradingStatistics,
    ):
        self.regime_manager = regime_manager
        self.data_registry = data_registry
        self.trading_statistics = trading_statistics
        
        # –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (60 —Å–µ–∫—É–Ω–¥)
        self._cache: Dict[str, Tuple[float, float]] = {}  # {key: (value, timestamp)}
        self._cache_ttl = 60.0
        
        # –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        self.metrics = {
            "parameter_changes": [],  # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            "regime_switches": [],    # –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω —Ä–µ–∂–∏–º–æ–≤
            "correlations": {},      # –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å PnL
        }
    
    def get_reversal_threshold(
        self, symbol: str, regime: str = None
    ) -> float:
        """–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥ V-–æ–±—Ä–∞–∑–Ω–æ–≥–æ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞"""
        cache_key = f"reversal_threshold_{symbol}_{regime}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        if cache_key in self._cache:
            value, timestamp = self._cache[cache_key]
            if time.time() - timestamp < self._cache_ttl:
                return value
        
        # –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        base = 0.0015
        
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–∫—Ç–æ—Ä—ã
        regime_factor = self._get_regime_factor("reversal_threshold", regime, symbol)
        vol_factor = self._get_volatility_factor("reversal_threshold", symbol)
        winrate_factor = self._get_winrate_factor("reversal_threshold", symbol)
        
        # –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
        multiplier = 1.0 + (
            self.WEIGHTS["regime"] * regime_factor +
            self.WEIGHTS["volatility"] * vol_factor +
            self.WEIGHTS["winrate"] * winrate_factor
        )
        
        threshold = base * multiplier
        
        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        threshold = max(0.0005, min(0.005, threshold))
        
        # –ö—ç—à–∏—Ä—É–µ–º
        self._cache[cache_key] = (threshold, time.time())
        
        # –õ–æ–≥–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏
        self._log_parameter_change("reversal_threshold", symbol, base, threshold, {
            "regime_factor": regime_factor,
            "vol_factor": vol_factor,
            "winrate_factor": winrate_factor,
        })
        
        return threshold
    
    def _get_regime_factor(self, param_name: str, regime: str, symbol: str) -> float:
        """–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–∫—Ç–æ—Ä —Ä–µ–∂–∏–º–∞"""
        if not regime:
            regime = self.regime_manager.get_current_regime(symbol).value.lower()
        
        factors = self.REGIME_FACTORS.get(param_name, {})
        return factors.get(regime, 0.0)
    
    def _get_volatility_factor(self, param_name: str, symbol: str) -> float:
        """–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–∫—Ç–æ—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏"""
        # –ü–æ–ª—É—á–∞–µ–º ATR
        atr = self.data_registry.get_atr(symbol, period=14)
        current_price = self.data_registry.get_current_price(symbol)
        
        if not atr or not current_price:
            return 0.0
        
        volatility_pct = (atr / current_price) * 100
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
        if volatility_pct > 3.0:
            vol_level = "high"
        elif volatility_pct < 1.0:
            vol_level = "low"
        else:
            vol_level = "medium"
        
        factors = self.VOLATILITY_FACTORS.get(param_name, {})
        return factors.get(vol_level, 0.0)
    
    def _get_winrate_factor(self, param_name: str, symbol: str) -> float:
        """–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–∫—Ç–æ—Ä win rate"""
        stats = self.trading_statistics.get_symbol_stats(symbol, lookback_hours=24)
        win_rate = stats.get("win_rate", 0.5)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å win rate
        if win_rate > 0.6:
            wr_level = "high"
        elif win_rate < 0.4:
            wr_level = "low"
        else:
            wr_level = "medium"
        
        factors = self.WINRATE_FACTORS.get(param_name, {})
        return factors.get(wr_level, 0.0)
    
    def _log_parameter_change(
        self, param_name: str, symbol: str, base: float, final: float, factors: Dict
    ):
        """–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        change = {
            "timestamp": time.time(),
            "param_name": param_name,
            "symbol": symbol,
            "base": base,
            "final": final,
            "change_pct": ((final - base) / base) * 100,
            "factors": factors,
        }
        
        self.metrics["parameter_changes"].append(change)
        
        # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if len(self.metrics["parameter_changes"]) > 1000:
            self.metrics["parameter_changes"] = self.metrics["parameter_changes"][-1000:]
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (>10%)
        if abs(change["change_pct"]) > 10:
            logger.debug(
                f"üìä {param_name} –¥–ª—è {symbol}: {base:.4f} ‚Üí {final:.4f} "
                f"({change['change_pct']:+.1f}%) | "
                f"regime={factors.get('regime_factor', 0):.2f}, "
                f"vol={factors.get('vol_factor', 0):.2f}, "
                f"wr={factors.get('winrate_factor', 0):.2f}"
            )
```

---

## üìä –°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### –ú–µ—Ç—Ä–∏–∫–∞ 1: –ß–∞—Å—Ç–æ—Ç–∞ —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞

```python
def get_regime_stability(self, symbol: str, minutes: int = 60) -> float:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∂–∏–º–∞"""
    switches = [
        s for s in self.metrics["regime_switches"]
        if s["symbol"] == symbol and s["timestamp"] > time.time() - minutes * 60
    ]
    
    # –ï—Å–ª–∏ —Ä–µ–∂–∏–º –º–µ–Ω—è–µ—Ç—Å—è —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 15 –º–∏–Ω—É—Ç - —ç—Ç–æ —à—É–º
    if len(switches) > minutes / 15:
        logger.warning(
            f"‚ö†Ô∏è {symbol}: –†–µ–∂–∏–º –º–µ–Ω—è–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ ({len(switches)} —Ä–∞–∑ –∑–∞ {minutes} –º–∏–Ω) - –≤–æ–∑–º–æ–∂–µ–Ω —à—É–º"
        )
        return 0.0  # –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ
    
    return 1.0 - (len(switches) / (minutes / 15))  # 0.0 = –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ, 1.0 = —Å—Ç–∞–±–∏–ª—å–Ω–æ
```

### –ú–µ—Ç—Ä–∏–∫–∞ 2: –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å PnL

```python
def calculate_parameter_correlation(self, param_name: str, symbol: str):
    """–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –º–µ–∂–¥—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∏ PnL"""
    changes = [
        c for c in self.metrics["parameter_changes"]
        if c["param_name"] == param_name and c["symbol"] == symbol
    ]
    
    # –ü–æ–ª—É—á–∞–µ–º PnL –∑–∞ —Ç–µ –∂–µ –ø–µ—Ä–∏–æ–¥—ã
    pnl_changes = []
    for change in changes:
        stats = self.trading_statistics.get_symbol_stats(
            symbol, 
            start_time=change["timestamp"] - 300,  # 5 –º–∏–Ω—É—Ç –¥–æ
            end_time=change["timestamp"] + 300     # 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ
        )
        pnl_changes.append(stats.get("pnl", 0.0))
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é
    if len(changes) > 10:
        correlation = np.corrcoef(
            [c["change_pct"] for c in changes],
            pnl_changes
        )[0, 1]
        
        self.metrics["correlations"][f"{param_name}_{symbol}"] = correlation
        
        logger.info(
            f"üìà –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è {param_name} —Å PnL –¥–ª—è {symbol}: {correlation:.3f}"
        )
```

### –ú–µ—Ç—Ä–∏–∫–∞ 3: –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

```python
def get_parameter_stability(self, param_name: str, symbol: str) -> float:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞"""
    changes = [
        c for c in self.metrics["parameter_changes"]
        if c["param_name"] == param_name and c["symbol"] == symbol
        and c["timestamp"] > time.time() - 3600  # –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
    ]
    
    if len(changes) < 2:
        return 1.0  # –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    change_pcts = [c["change_pct"] for c in changes]
    std = np.std(change_pcts)
    
    # –ï—Å–ª–∏ std > 20% - –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω
    stability = max(0.0, 1.0 - (std / 20.0))
    
    return stability
```

---

## ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (60 —Å–µ–∫—É–Ω–¥)

```python
# –ö—ç—à –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
self._cache: Dict[str, Tuple[float, float]] = {}
self._cache_ttl = 60.0  # 60 —Å–µ–∫—É–Ω–¥
```

### 2. Batch –≤—ã—á–∏—Å–ª–µ–Ω–∏—è

```python
def get_all_parameters(self, symbol: str, regime: str = None) -> Dict[str, float]:
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)"""
    # –í—ã—á–∏—Å–ª—è–µ–º –≤—Å–µ —Ñ–∞–∫—Ç–æ—Ä—ã –æ–¥–∏–Ω —Ä–∞–∑
    regime_factors = self._get_all_regime_factors(regime, symbol)
    vol_factors = self._get_all_volatility_factors(symbol)
    winrate_factors = self._get_all_winrate_factors(symbol)
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
    params = {}
    for param_name in self.BASE_VALUES:
        base = self.BASE_VALUES[param_name]
        multiplier = 1.0 + (
            self.WEIGHTS["regime"] * regime_factors[param_name] +
            self.WEIGHTS["volatility"] * vol_factors[param_name] +
            self.WEIGHTS["winrate"] * winrate_factors[param_name]
        )
        params[param_name] = base * multiplier
    
    return params
```

### 3. –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

```python
# –í—ã—á–∏—Å–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
@lru_cache(maxsize=100)
def _get_volatility_level(self, symbol: str) -> str:
    """–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–≤–Ω—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏"""
    # ... –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ
```

---

## üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)

```yaml
adaptive_filters_v2:
  enabled: true
  
  # –í–µ—Å–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
  weights:
    regime: 0.5      # 50%
    volatility: 0.3  # 30%
    winrate: 0.2     # 20%
  
  # –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  base_values:
    reversal_threshold: 0.0015  # 0.15%
    adx_threshold: 20.0
    correlation_threshold: 0.7
    min_signal_strength: 0.7
    macd_divisor: 200.0
    strength_multiplier: 2000.0
  
  # –§–∞–∫—Ç–æ—Ä—ã –ø–æ —Ä–µ–∂–∏–º–∞–º
  regime_factors:
    reversal_threshold:
      trending: 0.2
      ranging: 0.0
      choppy: -0.2
    # ... –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  
  # –§–∞–∫—Ç–æ—Ä—ã –ø–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
  volatility_factors:
    reversal_threshold:
      high: 0.3
      medium: 0.0
      low: -0.3
    # ... –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  
  # –§–∞–∫—Ç–æ—Ä—ã –ø–æ win rate
  winrate_factors:
    reversal_threshold:
      high: -0.2
      medium: 0.0
      low: 0.2
    # ... –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  
  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
  limits:
    reversal_threshold:
      min: 0.0005
      max: 0.005
    # ... –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  
  # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
  cache_ttl_seconds: 60
  
  # –ú–µ—Ç—Ä–∏–∫–∏
  metrics:
    enabled: true
    log_threshold_pct: 10.0  # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è >10%
    correlation_window_hours: 24
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ V2

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–º–µ—Å—Ç–æ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫
2. **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å** - –ª–∏–Ω–µ–π–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
3. **–û—Ç–ª–∞–¥–∫–∞** - –º–µ–Ω—å—à–µ —Ñ–∞–∫—Ç–æ—Ä–æ–≤, –ø—Ä–æ—â–µ –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—É
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, batch –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
5. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
6. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - min/max –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

---

## üöÄ –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

1. **–≠—Ç–∞–ø 1:** –°–æ–∑–¥–∞—Ç—å `AdaptiveFilterParametersV2` —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∞–º–∏
2. **–≠—Ç–∞–ø 2:** –î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –º–µ—Ç—Ä–∏–∫
3. **–≠—Ç–∞–ø 3:** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `SignalGenerator`
4. **–≠—Ç–∞–ø 4:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
5. **–≠—Ç–∞–ø 5:** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –Ω–∞ –∂–∏–≤–æ–º —Ä—ã–Ω–∫–µ
6. **–≠—Ç–∞–ø 6:** –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫

---

**–î–∞—Ç–∞:** 2025-12-23  
**–°—Ç–∞—Ç—É—Å:** –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏





