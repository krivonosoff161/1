# ‚úÖ –ß–ï–ö–õ–ò–°–¢ –í–ê–õ–ò–î–ê–¶–ò–ò: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è TSL price=0

**–î–∞—Ç–∞:** 2026-01-10  
**–í–µ—Ä—Å–∏—è:** 1.0  

---

## üîç –ü–†–û–í–ï–†–ö–ê –°–ò–ù–¢–ê–ö–°–ò–°–ê

- ‚úÖ `trailing_sl_coordinator.py` - –°–∏–Ω—Ç–∞–∫—Å–∏—Å OK
- ‚úÖ `trailing_stop_loss.py` - –°–∏–Ω—Ç–∞–∫—Å–∏—Å OK

---

## üìù –ü–†–û–í–ï–†–ö–ê –õ–û–ì–ò–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### 1. Hierarchical Price Fallback

**–ü—Ä–æ–≤–µ—Ä—è–µ–º–∞—è —Ü–µ–ø–æ—á–∫–∞ –≤ `_get_current_price()`:**

```
1Ô∏è‚É£ WebSocket real-time (DataRegistry.current_tick)
   ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí Fallback –Ω–∞ 2Ô∏è‚É£

2Ô∏è‚É£ Last Candle (DataRegistry.ohlcv_data[-1].close)
   ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí Fallback –Ω–∞ 3Ô∏è‚É£

3Ô∏è‚É£ REST API callback (get_current_price_callback)
   ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí Fallback –Ω–∞ 4Ô∏è‚É£

4Ô∏è‚É£ REST API client (_fetch_price_via_client)
   ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí Fallback –Ω–∞ 5Ô∏è‚É£

5Ô∏è‚É£ Entry Price (position.entry_price)
   ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí –≤–µ—Ä–Ω—É—Ç—å None (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞!)
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –í—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤–∞–ª–∏–¥–Ω–∞—è —Ü–µ–Ω–∞ (> 0) –∏–ª–∏ None
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–µ—Ä–Ω–µ—Ç 0.0 –±–µ–∑ —è–≤–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã

---

### 2. PnL –ó–∞—â–∏—Ç–∞ –æ—Ç price=0

**–ü—Ä–æ–≤–µ—Ä—è–µ–º–∞—è –ª–æ–≥–∏–∫–∞ –≤ `get_profit_pct()`:**

```python
if current_price is None or current_price <= 0:
    logger.warning(f"‚ö†Ô∏è TSL: price={current_price}, –∏—Å–ø–æ–ª—å–∑—É–µ–º entry_price")
    current_price = self.entry_price
    # –¢–µ–ø–µ—Ä—å profit_pct –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ = 0%)
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ï—Å–ª–∏ `price <= 0`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `entry_price` ‚Üí PnL = 0%
- Loss_cut –ø—Ä–æ–≤–µ—Ä–∫–∞: `0% > -0.4%` ‚Üí –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
- –ù–æ –ø–æ—Ç–æ–º –≤ coordinatore –ø–µ—Ä–µ–ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ü–µ–Ω–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ 5-–π fallback
- –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤: `current_price = entry_price` ‚Üí PnL = 0% (–≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç)

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞—â–∏—Ç—É –æ—Ç false positives!

---

### 3. Current Price Validation

**–ü—Ä–æ–≤–µ—Ä—è–µ–º–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–¥ `should_close_position()`:**

```python
if current_price is None or current_price <= 0:
    logger.error(f"‚ùå current_price={current_price}, –∏—Å–ø–æ–ª—å–∑—É–µ–º entry_price")
    current_price = entry_price
    if current_price <= 0:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞–ª–∏–¥–Ω—É—é —Ü–µ–Ω—É, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É")
        return
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞—Å—Ç `price=0` –≤ `should_close_position()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `entry_price` –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–∂–µ entry_price –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

---

## üß™ –¢–ï–°–¢–û–í–´–ï –°–¶–ï–ù–ê–†–ò–ò

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (WebSocket –¥–æ—Å—Ç—É–ø–µ–Ω)

```
_get_current_price() –≤–µ—Ä–Ω–µ—Ç: ‚úÖ WebSocket price (< 100ms)
get_profit_pct() –ø–æ–ª—É—á–∏—Ç: ‚úÖ –†–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
Loss_cut —Å—Ä–∞–±–æ—Ç–∞–µ—Ç: ‚úÖ –î–∞, –µ—Å–ª–∏ profit < -0.4%
–û–∂–∏–¥–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –µ—Å–ª–∏ PnL < threshold
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (REST API –¥–æ—Å—Ç—É–ø–µ–Ω)

```
_get_current_price() –≤–µ—Ä–Ω–µ—Ç: ‚úÖ REST API callback price
get_profit_pct() –ø–æ–ª—É—á–∏—Ç: ‚úÖ –†–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
Loss_cut —Å—Ä–∞–±–æ—Ç–∞–µ—Ç: ‚úÖ –î–∞, –µ—Å–ª–∏ profit < -0.4%
–û–∂–∏–¥–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –µ—Å–ª–∏ PnL < threshold
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: REST API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (entry_price –¥–æ—Å—Ç—É–ø–µ–Ω)

```
_get_current_price() –≤–µ—Ä–Ω–µ—Ç: ‚úÖ entry_price (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK)
get_profit_pct() –ø–æ–ª—É—á–∏—Ç: ‚úÖ entry_price ‚Üí PnL = 0%
Loss_cut —Å—Ä–∞–±–æ—Ç–∞–µ—Ç: ‚ùå –ù–µ—Ç (0% > -0.4%)
–û–∂–∏–¥–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: –ù–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å (–∂–¥–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö)
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: üî¥ "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –í—Å–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (entry_price –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

```
_get_current_price() –≤–µ—Ä–Ω–µ—Ç: ‚ùå None
get_profit_pct() –ø–æ–ª—É—á–∏—Ç: ‚ùå None ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç entry_price ‚Üí PnL = 0%
Loss_cut —Å—Ä–∞–±–æ—Ç–∞–µ—Ç: ‚ùå –ù–µ—Ç
–û–∂–∏–¥–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: –ù–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: üî¥ "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê"
```

---

## üìä –ü–†–û–í–ï–†–ö–ê –õ–û–ì–û–í

### –ù–∞ —á—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:

```
‚úÖ –ù–û–†–ú–ê–õ–¨–ù–û:
"‚úÖ TSL: WebSocket real-time price for BTC-USDT: 91955.00000000"
"‚ö†Ô∏è TSL: Using last candle (DataRegistry) for ETH-USDT: 3130.00000000"
"‚ö†Ô∏è TSL: Using REST API callback for XRP-USDT: 2.09550000"

‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï (fallback –Ω–∞ REST API client):
"üî¥ TSL: Falling back to REST API client for SOL-USDT"

üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK (entry_price):
"üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK - –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price=135.73000000 –¥–ª—è SOL-USDT"
‚Üí –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ WebSocket, DataRegistry, REST API –≤—Å–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã!

‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:
"üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê - –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è BTC-USDT –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤!"
‚Üí –î–∞–∂–µ entry_price –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ø—Ä–æ–±–ª–µ–º–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞!
```

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ü–û–í–ï–î–ï–ù–ò–ò

### –†–∞–Ω—å—à–µ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):

```
2026-01-10 11:04:01 | üîç TSL_CHECK: XRP-USDT | profit=4.0000 | price=0.0000 | close=False
  ‚îî‚îÄ price=0 ‚Üí get_profit_pct –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fallback 4.0%
  ‚îî‚îÄ Loss_cut: 4.0% > -0.4% ‚Üí –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç ‚ùå
  ‚îî‚îÄ –†–ï–ê–õ–¨–ù–´–ô —É–±—ã—Ç–æ–∫ -1.39% ‚Üí –Ω–µ –≤–∏–¥–Ω–∞ ‚ùå

2026-01-10 11:04:01 | üîç TSL_CHECK: SOL-USDT | profit=4.0000 | price=0.0000 | close=False
  ‚îî‚îÄ price=0 ‚Üí get_profit_pct –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fallback 4.0%
  ‚îî‚îÄ Loss_cut: 4.0% > -0.4% ‚Üí –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç ‚ùå
  ‚îî‚îÄ –†–ï–ê–õ–¨–ù–´–ô —É–±—ã—Ç–æ–∫ -4.57% ‚Üí –Ω–µ –≤–∏–¥–Ω–∞ ‚ùå
```

### –ü–æ—Å–ª–µ (–ü–†–ê–í–ò–õ–¨–ù–û):

```
2026-01-10 11:04:01 | ‚ö†Ô∏è TSL: price=0.0000, –∏—Å–ø–æ–ª—å–∑—É–µ–º entry_price=2.0887
2026-01-10 11:04:01 | üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK - –∏—Å–ø–æ–ª—å–∑—É–µ–º entry_price=2.0887 –¥–ª—è XRP-USDT
2026-01-10 11:04:01 | üîç TSL_CHECK: XRP-USDT | profit=-1.3900 | price=2.0887 | close=True ‚úÖ
  ‚îî‚îÄ price –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è entry_price (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π fallback)
  ‚îî‚îÄ Profit —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ —É–±—ã—Ç–∫–∞ -1.39%
  ‚îî‚îÄ Loss_cut: -1.39% < -0.4% ‚Üí –ó–ê–ö–†–´–í–ê–ï–ú ‚úÖ

2026-01-10 11:04:01 | üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK - –∏—Å–ø–æ–ª—å–∑—É–µ–º entry_price=135.73 –¥–ª—è SOL-USDT
2026-01-10 11:04:01 | üîç TSL_CHECK: SOL-USDT | profit=-4.5700 | price=135.73 | close=True ‚úÖ
  ‚îî‚îÄ price –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è entry_price (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π fallback)
  ‚îî‚îÄ Loss_cut: -4.57% < -0.4% ‚Üí –ó–ê–ö–†–´–í–ê–ï–ú ‚úÖ
```

---

## üöÄ –ö–û–ì–î–ê –ù–£–ñ–ù–û –ó–ê–ü–£–°–¢–ò–¢–¨ –ë–û–¢–ê

### ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:

1. –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω ‚úÖ
2. –õ–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úÖ
3. Fallbacks –¥–æ–±–∞–≤–ª–µ–Ω—ã ‚úÖ
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úÖ

### üß™ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–µ—Å—Ç:

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ **demo mode** (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
2. –û—Ç–∫—Ä—ã—Ç—å —É–±—ã—Ç–æ—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é (–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ)
3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ loss_cut **–∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é**
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç fallback —Å–æ–æ–±—â–µ–Ω–∏–π

### üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞:

- ‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ loss_cut
- ‚úÖ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ `price=0.0000` –≤ –ª–æ–≥
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–π PnL —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–∞—Å—á–µ—Ç–Ω—ã–º
- ‚úÖ –í—Å–µ fallbacks –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é  
**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ trading mode

