# –ê–ù–ê–õ–ò–ó: –¶–ï–ù–ê –î–õ–Ø –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô

**–î–∞—Ç–∞:** 2025-12-18  
**–°—Ç–∞—Ç—É—Å:** üîç –ê–ù–ê–õ–ò–ó

---

## ü§î –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –∑–∞–∫—Ä—ã—Ç–∏—è? –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞? –ù—É–∂–Ω—ã –ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è?**

---

## üìä –¢–ï–ö–£–©–ê–Ø –õ–û–ì–ò–ö–ê –ó–ê–ö–†–´–¢–ò–Ø

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ TP (_check_tp_only) ‚úÖ –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù–û

**–§–∞–π–ª:** `position_manager.py:1822`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```python
# ‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞, markPx —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback
current_price = float(position.get("markPx", "0"))  # Fallback
try:
    price_limits = await self.client.get_price_limits(symbol)
    if price_limits:
        actual_price = price_limits.get("current_price", 0)
        if actual_price > 0:
            current_price = actual_price
            logger.debug(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è TP –ø—Ä–æ–≤–µ—Ä–∫–∏ {symbol}: {current_price:.2f}")
except Exception as e:
    logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è {symbol}, –∏—Å–ø–æ–ª—å–∑—É–µ–º markPx: {e}")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ñ–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢ –ê–ö–¢–£–ê–õ–¨–ù–£–Æ –¶–ï–ù–£ –ò–ó –°–¢–ê–ö–ê–ù–ê

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ SL (_check_sl) ‚ö†Ô∏è –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨

**–§–∞–π–ª:** `position_manager.py:1183`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```python
current_price = float(position.get("markPx", "0"))  # ‚ùå –¢–æ–ª—å–∫–æ markPx!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `markPx` (—Ü–µ–Ω–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏)
- `markPx` –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞
- –ù–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞

**–ù—É–∂–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (–∫–∞–∫ –≤ `_check_tp_only`)

---

### 3. –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (_close_position_by_reason) ‚úÖ –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù–û

**–§–∞–π–ª:** `position_manager.py:3356`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
exit_price = float(actual_position.get("markPx", "0"))  # Fallback –Ω–∞ markPx
try:
    price_limits = await self.client.get_price_limits(symbol)
    current_price_from_book = price_limits.get("current_price", 0.0)
    best_bid = price_limits.get("best_bid", 0.0)
    best_ask = price_limits.get("best_ask", 0.0)
    # ... –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ best_bid/best_ask –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ñ–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢ –ê–ö–¢–£–ê–õ–¨–ù–£–Æ –¶–ï–ù–£ –ò–ó –°–¢–ê–ö–ê–ù–ê

---

### 4. ExitAnalyzer ‚ö†Ô∏è –ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨

**–§–∞–π–ª:** `exit_analyzer.py`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```python
current_price = await self.data_registry.get_price(symbol)
```

**–í–æ–ø—Ä–æ—Å:** –ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `data_registry.get_price()`?
- –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞?
- –ò–ª–∏ —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏?

**–ù—É–∂–Ω–æ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `get_price()` –≤ `data_registry.py`

---

### 5. TrailingSL ‚ö†Ô∏è –ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨

**–§–∞–π–ª:** `trailing_sl_coordinator.py:447`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```python
async def update_trailing_stop_loss(self, symbol: str, current_price: float):
```

**–í–æ–ø—Ä–æ—Å:** –û—Ç–∫—É–¥–∞ –±–µ—Ä–µ—Ç—Å—è `current_price` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ?
- –ò–∑ —Å—Ç–∞–∫–∞–Ω–∞?
- –ò–ª–∏ –∏–∑ `markPx`?

**–ù—É–∂–Ω–æ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `update_trailing_stop_loss()` –∏ –∫–∞–∫–∞—è —Ü–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è

---

## üîç –ß–¢–û –ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨

### 1. `data_registry.get_price()`
- –ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç?
- –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ –∏–ª–∏ —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–≤–µ—á–∏?

### 2. `_check_sl()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ `markPx`
- –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞

### 3. TrailingSL
- –û—Ç–∫—É–¥–∞ –±–µ—Ä–µ—Ç—Å—è `current_price`?
- –ù—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã?

### 4. ExitAnalyzer
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `data_registry.get_price()`
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å `_check_sl()` ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ #1
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (–∫–∞–∫ –≤ `_check_tp_only`)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `markPx` —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `data_registry.get_price()` ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ #2
- –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—É –∑–∞–∫—Ä—ã—Ç–∏—è —Å–≤–µ—á–∏ ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã
- –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TrailingSL ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ #3
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û

**–î–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞!**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ü–µ–Ω–∞ ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç PnL
- –£—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ü–µ–Ω–∞ ‚Üí –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–ª–∏ –∑–∞–ø–æ–∑–¥–∞–ª–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
- –î–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞ —Ä–∞–∑–Ω–∏—Ü–∞ –¥–∞–∂–µ 0.1% –º–æ–∂–µ—Ç –±—ã—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–∞

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `data_registry.get_price()` –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å `_check_sl()`.
