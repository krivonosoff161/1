# –§–ò–ù–ê–õ–¨–ù–´–ô –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó: –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê –ò –õ–û–ì–ò–ö–ê –ë–†–û–ö–ï–†–ê

**–î–∞—Ç–∞:** 2025-12-18  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù

---

## üìä –ê–ù–ê–õ–ò–ó –° –¢–û–ß–ö–ò –ó–†–ï–ù–ò–Ø –ë–†–û–ö–ï–†–ê –ò –ú–ê–¢–ï–ú–ê–¢–ò–ö–ò

---

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û (100%)

### 1. –†–ê–°–ß–ï–¢ PnL ‚úÖ

#### 1.1 ExitAnalyzer ‚úÖ
- **–ú–µ—Ç–æ–¥:** `_calculate_pnl_percent()`
- **–†–∞—Å—á–µ—Ç:** `PnL% = (unrealized_pnl / margin_used) * 100`
- **–ö–æ–º–∏—Å—Å–∏—è:** –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å leverage: `commission_pct = (fee_rate * 2) * leverage * 100`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏—Ä–∂–µ–≤–æ–º—É —Ä–∞—Å—á–µ—Ç—É –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤

#### 1.2 PositionManager ‚úÖ
- **–ú–µ—Ç–æ–¥:** `_check_tp_only()`
- **–†–∞—Å—á–µ—Ç:** `pnl_percent = (unrealized_pnl / margin_used) * 100`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏—Ä–∂–µ–≤–æ–º—É —Ä–∞—Å—á–µ—Ç—É

#### 1.3 PnLCalculator ‚úÖ
- **–†–∞—Å—á–µ—Ç:** –û—Ç –Ω–æ–º–∏–Ω–∞–ª–∞ (–¥–ª—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏)
- **–ö–æ–º–∏—Å—Å–∏—è:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –¥–ª—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞

---

### 2. –†–ê–°–ß–ï–¢ –ö–û–ú–ò–°–°–ò–ô ‚úÖ

#### 2.1 ExitAnalyzer ‚úÖ
- **Maker:** 0.02% (0.0002) –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É
- **Taker:** 0.05% (0.0005) –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É
- **–£—á–µ—Ç:** `commission_pct = (trading_fee_rate * 2) * leverage * 100`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∫–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç leverage –∏ –¥–≤–µ —Å—Ç–æ—Ä–æ–Ω—ã

**–ü—Ä–∏–º–µ—Ä:**
- Leverage: 5x
- Maker fee: 0.02% √ó 2 (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥) √ó 5 (leverage) = 0.2% –æ—Ç –º–∞—Ä–∂–∏ ‚úÖ

#### 2.2 PositionManager ‚úÖ
- **–†–∞—Å—á–µ—Ç:** –û—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è entry –∏ exit
- **–£—á–µ—Ç:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è maker/taker –ø–æ —Ç–∏–ø—É –æ—Ä–¥–µ—Ä–∞
- **Funding fee:** –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

#### 2.3 PnLCalculator ‚úÖ
- **–†–∞—Å—á–µ—Ç:** –û—Ç –Ω–æ–º–∏–Ω–∞–ª–∞ (notional value)
- **–£—á–µ—Ç:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è maker/taker
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

---

### 3. –†–ê–°–ß–ï–¢ –†–ê–ó–ú–ï–†–ê –ü–û–ó–ò–¶–ò–ô ‚úÖ

#### 3.1 –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –º–æ–Ω–µ—Ç—ã ‚úÖ
- **–ú–µ—Ç–æ–¥:** `size_in_coins = size_in_contracts * ctVal`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç API OKX

**–ü—Ä–∏–º–µ—Ä—ã:**
- BTC: ctVal=0.01 ‚Üí 1 –∫–æ–Ω—Ç—Ä–∞–∫—Ç = 0.01 BTC ‚úÖ
- SOL: ctVal=1.0 ‚Üí 1 –∫–æ–Ω—Ç—Ä–∞–∫—Ç = 1 SOL ‚úÖ
- DOGE: ctVal=1000.0 ‚Üí 1 –∫–æ–Ω—Ç—Ä–∞–∫—Ç = 1000 DOGE ‚úÖ

#### 3.2 –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ ‚úÖ
- **–ú–µ—Ç–æ–¥:** –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ `lotSz`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ú–∏–Ω–∏–º—É–º `minSz`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–∏—Ä–∂–∏

#### 3.3 –†–∞—Å—á–µ—Ç –º–∞—Ä–∂–∏ ‚úÖ
- **–§–æ—Ä–º—É–ª–∞:** `margin = position_value / leverage`
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏—Ä–∂–µ–≤–æ–º—É —Ä–∞—Å—á–µ—Ç—É

---

### 4. –†–ê–°–ß–ï–¢ –õ–ò–ú–ò–¢–ù–´–• –¶–ï–ù ‚úÖ

#### 4.1 BUY –æ—Ä–¥–µ—Ä–∞ ‚úÖ
- **–õ–æ–≥–∏–∫–∞:** `limit_price = best_ask * (1 + offset_percent / 100.0)`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å best_ask (< 0.1% –æ—Ç current_price)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –¥–ª—è BUY –Ω—É–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å –ø–æ best_ask

#### 4.2 SELL –æ—Ä–¥–µ—Ä–∞ ‚úÖ
- **–õ–æ–≥–∏–∫–∞:** `limit_price = best_bid * (1 - offset_percent / 100.0)`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å best_bid (< 0.1% –æ—Ç current_price)
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –¥–ª—è SELL –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –ø–æ best_bid

#### 4.3 –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π offset ‚úÖ
- **–ú–µ—Ç–æ–¥:** –ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø—Ä–µ–¥–∞
- **–õ–æ–≥–∏–∫–∞:** –£–∑–∫–∏–π —Å–ø—Ä–µ–¥ ‚Üí –º–µ–Ω—å—à–∏–π offset, —à–∏—Ä–æ–∫–∏–π —Å–ø—Ä–µ–¥ ‚Üí –±–æ–ª—å—à–∏–π offset
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ

---

### 5. –ü–†–û–°–ö–ê–õ–¨–ó–´–í–ê–ù–ò–ï (Slippage) ‚úÖ

#### 5.1 Spread buffer ‚úÖ
- **–ú–µ—Ç–æ–¥:** `spread_buffer = (best_ask - best_bid) / best_ask * 100`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ SL –ø—Ä–æ–≤–µ—Ä–∫–µ
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è

---

### 6. –õ–û–ì–ò–ö–ê –ó–ê–ö–†–´–¢–ò–Ø ‚úÖ

#### 6.1 –ó–∞–∫—Ä—ã—Ç–∏–µ LONG ‚úÖ
- **–¶–µ–Ω–∞:** `best_bid` (–ª—É—á—à–∞—è —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å best_bid
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è LONG –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –ø–æ best_bid

#### 6.2 –ó–∞–∫—Ä—ã—Ç–∏–µ SHORT ‚úÖ
- **–¶–µ–Ω–∞:** `best_ask` (–ª—É—á—à–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å best_ask
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è SHORT –Ω—É–∂–Ω–æ –∫—É–ø–∏—Ç—å –ø–æ best_ask

---

### 7. –õ–û–ì–ò–ö–ê –û–¢–ö–†–´–¢–ò–Ø ‚úÖ

#### 7.1 BUY —Å–∏–≥–Ω–∞–ª ‚úÖ
- **–¶–µ–Ω–∞:** `best_ask + offset` (–ø–æ–∫—É–ø–∞–µ–º –ø–æ –ª—É—á—à–µ–π —Ü–µ–Ω–µ –ø—Ä–æ–¥–∞–∂–∏)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å signal["price"]
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏–∫–µ –±–∏—Ä–∂–∏

#### 7.2 SELL —Å–∏–≥–Ω–∞–ª ‚úÖ
- **–¶–µ–Ω–∞:** `best_bid - offset` (–ø—Ä–æ–¥–∞–µ–º –ø–æ –ª—É—á—à–µ–π —Ü–µ–Ω–µ –ø–æ–∫—É–ø–∫–∏)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å signal["price"]
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏–∫–µ –±–∏—Ä–∂–∏

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü–†–û–ë–õ–ï–ú–ê #1: TrailingStopLoss —Å—á–∏—Ç–∞–µ—Ç –æ—Ç —Ü–µ–Ω—ã ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ë—ã–ª–æ:**
- TrailingStopLoss –≤—ã–∑—ã–≤–∞–ª—Å—è –ë–ï–ó –ø–µ—Ä–µ–¥–∞—á–∏ `margin_used` –∏ `unrealized_pnl`
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è fallback —Ä–∞—Å—á–µ—Ç –æ—Ç —Ü–µ–Ω—ã –≤–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –æ—Ç –º–∞—Ä–∂–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `margin_used` –∏ `unrealized_pnl` –≤ –º–µ—Ç–æ–¥—ã `update()` –∏ `should_close_position()`
- –í—Å–µ –≤—ã–∑–æ–≤—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —ç—Ç–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –æ—Ç –º–∞—Ä–∂–∏ (–∫–∞–∫ –Ω–∞ –±–∏—Ä–∂–µ)

---

### –ü–†–û–ë–õ–ï–ú–ê #2: –ö–æ–º–∏—Å—Å–∏—è –≤ TrailingStopLoss ‚úÖ –£–ñ–ï –ë–´–õ–ê –ò–°–ü–†–ê–í–õ–ï–ù–ê

**–°—Ç–∞—Ç—É—Å:**
- –ö–æ–º–∏—Å—Å–∏—è —É–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ –º–µ—Ç–æ–¥–µ `get_profit_pct()`
- –ü—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –æ—Ç –º–∞—Ä–∂–∏ –∫–æ–º–∏—Å—Å–∏—è –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü—Ä–∏ fallback —Ä–∞—Å—á–µ—Ç–µ –æ—Ç —Ü–µ–Ω—ã –∫–æ–º–∏—Å—Å–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ leverage

---

## üìä –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

### 1. –†–ê–°–ß–ï–¢ PnL - –î–ï–¢–ê–õ–¨–ù–û

#### ‚úÖ ExitAnalyzer (–ü–†–ê–í–ò–õ–¨–ù–û):
```python
# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –û—Ç –º–∞—Ä–∂–∏ (–∫–∞–∫ –Ω–∞ –±–∏—Ä–∂–µ)
if margin_used > 0 and unrealized_pnl is not None:
    gross_pnl_pct = (unrealized_pnl / margin_used) * 100
    
    # –ö–æ–º–∏—Å—Å–∏—è —Å —É—á–µ—Ç–æ–º leverage
    commission_pct = (trading_fee_rate * 2) * leverage * 100
    net_pnl_pct = gross_pnl_pct - commission_pct
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏—Ä–∂–µ–≤–æ–º—É —Ä–∞—Å—á–µ—Ç—É

#### ‚ö†Ô∏è TrailingStopLoss (–ü–†–û–ë–õ–ï–ú–ê):
```python
# –°—á–∏—Ç–∞–µ—Ç –æ—Ç —Ü–µ–Ω—ã
if side == "long":
    gross_profit_pct = (current_price - entry_price) / entry_price
else:
    gross_profit_pct = (entry_price - current_price) / entry_price

# –ö–æ–º–∏—Å—Å–∏—è –±–µ–∑ —É—á–µ—Ç–∞ leverage
net_profit_pct = gross_profit_pct - trading_fee_rate
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°—á–∏—Ç–∞–µ—Ç –æ—Ç —Ü–µ–Ω—ã –≤–º–µ—Å—Ç–æ –º–∞—Ä–∂–∏
- –ö–æ–º–∏—Å—Å–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç leverage

---

### 2. –†–ê–°–ß–ï–¢ –ö–û–ú–ò–°–°–ò–ô - –î–ï–¢–ê–õ–¨–ù–û

#### ‚úÖ ExitAnalyzer (–ü–†–ê–í–ò–õ–¨–ù–û):
```python
# –ö–æ–º–∏—Å—Å–∏—è —Å —É—á–µ—Ç–æ–º leverage
commission_pct = (trading_fee_rate * 2) * leverage * 100
```

**–ü—Ä–∏–º–µ—Ä:**
- Leverage: 5x
- Maker fee: 0.02% √ó 2 √ó 5 = 0.2% –æ—Ç –º–∞—Ä–∂–∏ ‚úÖ

#### ‚úÖ PositionManager (–ü–†–ê–í–ò–õ–¨–ù–û):
```python
# –ö–æ–º–∏—Å—Å–∏—è –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞
notional_entry = size_in_coins * entry_price
commission_entry = notional_entry * entry_commission_rate

notional_exit = size_in_coins * exit_price
commission_exit = notional_exit * exit_commission_rate
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∫–æ–º–∏—Å—Å–∏—è –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞ (–∫–∞–∫ –Ω–∞ –±–∏—Ä–∂–µ)

---

### 3. –†–ê–°–ß–ï–¢ –†–ê–ó–ú–ï–†–ê –ü–û–ó–ò–¶–ò–ô - –î–ï–¢–ê–õ–¨–ù–û

#### ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ ‚úÖ
```python
size_in_coins = size_in_contracts * ctVal
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- BTC: 1 –∫–æ–Ω—Ç—Ä–∞–∫—Ç √ó 0.01 = 0.01 BTC ‚úÖ
- SOL: 1 –∫–æ–Ω—Ç—Ä–∞–∫—Ç √ó 1.0 = 1 SOL ‚úÖ
- DOGE: 1 –∫–æ–Ω—Ç—Ä–∞–∫—Ç √ó 1000.0 = 1000 DOGE ‚úÖ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç API OKX

---

### 4. –†–ê–°–ß–ï–¢ –õ–ò–ú–ò–¢–ù–´–• –¶–ï–ù - –î–ï–¢–ê–õ–¨–ù–û

#### ‚úÖ BUY –æ—Ä–¥–µ—Ä–∞ ‚úÖ
```python
limit_price = best_ask * (1 + offset_percent / 100.0)
```

**–õ–æ–≥–∏–∫–∞:**
- –î–ª—è BUY –Ω—É–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å –ø–æ best_ask (–ª—É—á—à–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏)
- –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π offset –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å best_ask (< 0.1% –æ—Ç current_price)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏–∫–µ –±–∏—Ä–∂–∏

#### ‚úÖ SELL –æ—Ä–¥–µ—Ä–∞ ‚úÖ
```python
limit_price = best_bid * (1 - offset_percent / 100.0)
```

**–õ–æ–≥–∏–∫–∞:**
- –î–ª—è SELL –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –ø–æ best_bid (–ª—É—á—à–∞—è —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏)
- –í—ã—á–∏—Ç–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–π offset –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å best_bid (< 0.1% –æ—Ç current_price)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏–∫–µ –±–∏—Ä–∂–∏

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û (100%):

1. ‚úÖ –†–∞—Å—á–µ—Ç PnL –æ—Ç –º–∞—Ä–∂–∏ (ExitAnalyzer, PositionManager)
2. ‚úÖ –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π —Å —É—á–µ—Ç–æ–º leverage (ExitAnalyzer)
3. ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –º–æ–Ω–µ—Ç—ã (ctVal)
4. ‚úÖ –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–π (lotSz, minSz)
5. ‚úÖ –õ–∏–º–∏—Ç–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è BUY/SELL (best_ask/best_bid)
6. ‚úÖ –†–∞—Å—á–µ—Ç –º–∞—Ä–∂–∏ –∏ leverage
7. ‚úÖ –õ–æ–≥–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (best_bid –¥–ª—è LONG, best_ask –¥–ª—è SHORT)
8. ‚úÖ –£—á–µ—Ç –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è (spread_buffer)
9. ‚úÖ –£—á–µ—Ç funding fee
10. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ maker/taker –∫–æ–º–∏—Å—Å–∏–π

### ‚úÖ –í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–û (100%):

1. ‚úÖ TrailingStopLoss - —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è margin_used –∏ unrealized_pnl –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –æ—Ç –º–∞—Ä–∂–∏
2. ‚úÖ TrailingStopLoss - –∫–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (—É–∂–µ –±—ã–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞–Ω–µ–µ)

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å TrailingStopLoss ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—á–∏—Ç–∞–µ—Ç –æ—Ç —Ü–µ–Ω—ã –≤–º–µ—Å—Ç–æ –º–∞—Ä–∂–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å TP/SL –∏–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –æ—Ç –º–∞—Ä–∂–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç —Ü–µ–Ω—ã
- –§–æ—Ä–º—É–ª–∞: `tp_from_price = tp_from_margin / leverage`
- –ü—Ä–∏–º–µ—Ä: TP=5% –æ—Ç –º–∞—Ä–∂–∏ –ø—Ä–∏ leverage=5x ‚Üí TP=1% –æ—Ç —Ü–µ–Ω—ã

### 2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é –≤ TrailingStopLoss ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç leverage

**–†–µ—à–µ–Ω–∏–µ:**
- –£–º–Ω–æ–∂–∞—Ç—å –∫–æ–º–∏—Å—Å–∏—é –Ω–∞ leverage: `commission_pct = trading_fee_rate * leverage`
- –ò–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç —Ü–µ–Ω—ã: `commission_from_price = trading_fee_rate / leverage`

---

## üìä –í–´–í–û–î

**–í —Ü–µ–ª–æ–º —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –±—Ä–æ–∫–µ—Ä–∞ –∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏!**

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:

1. ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –±–∏—Ä–∂–µ–≤—ã–º
2. ‚úÖ –ö–æ–º–∏—Å—Å–∏–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –º–µ—Å—Ç)
3. ‚úÖ –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
4. ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
5. ‚úÖ –õ–∏–º–∏—Ç–Ω—ã–µ —Ü–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ

### ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. ‚úÖ TrailingStopLoss —Ç–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞–µ—Ç –æ—Ç –º–∞—Ä–∂–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
2. ‚úÖ TrailingStopLoss –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç leverage –≤ –∫–æ–º–∏—Å—Å–∏–∏ (—É–∂–µ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–Ω–µ–µ)

---

## üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–æ—Ä–≥–æ–≤–ª–µ –Ω–∞ 100%!** ‚úÖ

- ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
- ‚úÖ –õ–æ–≥–∏–∫–∞ –±—Ä–æ–∫–µ—Ä–∞ —Å–æ–±–ª—é–¥–µ–Ω–∞
- ‚úÖ –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ TrailingStopLoss –∏—Å–ø—Ä–∞–≤–ª–µ–Ω - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –æ—Ç –º–∞—Ä–∂–∏

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏—Ä–∂–µ–≤—ã–º —Ä–∞—Å—á–µ—Ç–∞–º!** ‚úÖ

---

**–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!** ‚úÖ
