# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ü–†–û–ë–õ–ï–ú –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø

## üìã –°–¢–ê–¢–£–° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

**–î–∞—Ç–∞:** 2025-12-21  
**–ü—Ä–æ–±–ª–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã:** Grok –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±–ª–µ–º–∞ 1 - DRIFT_REMOVE (—É–∂–µ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û —Ä–∞–Ω–µ–µ

**–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py` (—Å—Ç—Ä–æ–∫–∏ 2086-2158)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ DRIFT_REMOVE —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ exchange-side closures
- ‚úÖ –£–∫–∞–∑–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω (TSL, Liquidation, ADL, Manual)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –≤—Å–µ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ –±–∏—Ä–∂–µ –±—É–¥—É—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏ –¥–µ—Ç–∞–ª—å–Ω–æ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω—ã!

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±–ª–µ–º–∞ 2 - Race condition –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ (size=0)

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**

### 1. –í `close_position_manually` (—Å—Ç—Ä–æ–∫–∏ 5667-5695):
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ size=0
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (—É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ active_positions –∏ PositionRegistry)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
‚ö†Ô∏è [RACE_CONDITION] XRP-USDT: –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é —Å size=0!
   –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è: sl_reached
   –°—Ç–∞—Ç—É—Å: –ü–æ–∑–∏—Ü–∏—è —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ
   –î–µ–π—Å—Ç–≤–∏–µ: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```

### 2. –í `_close_position_by_reason` (—Å—Ç—Ä–æ–∫–∏ 3698-3702):
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏—á–∏–Ω–µ –∏ —Å—Ç–∞—Ç—É—Å–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å race condition –±—É–¥–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±–ª–µ–º–∞ 3 - Leverage –ù–ï –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ

**–§–∞–π–ª:** `src/strategies/scalping/futures/risk/adaptive_leverage.py`

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**

### 1. –†–∞—Å—á–µ—Ç leverage (—Å—Ç—Ä–æ–∫–∏ 117-123):
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å DEBUG –Ω–∞ INFO –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª–∏: regime_multiplier, volatility_multiplier, adjusted_strength, category

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
üìä [ADAPTIVE_LEVERAGE] BTC-USDT: –†–∞—Å—á–µ—Ç leverage | 
   strength=0.85, regime=ranging, 
   volatility=0.0234, 
   regime_multiplier=1.00, 
   volatility_multiplier=1.30, 
   adjusted_strength=0.85, category=strong, 
   requested_leverage=20x (–¥–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è)
```

### 2. –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ leverage (—Å—Ç—Ä–æ–∫–∏ 133-143):
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è leverage –±–∏—Ä–∂–µ–π
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–ª–µ–Ω–Ω–æ–º –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º leverage

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
‚ö†Ô∏è [ADAPTIVE_LEVERAGE] BTC-USDT: –õ–µ–≤–µ—Ä–∏–¥–∂ –∏–∑–º–µ–Ω–µ–Ω –±–∏—Ä–∂–µ–π!
   –ó–∞—è–≤–ª–µ–Ω–Ω—ã–π: 30x
   –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π: 20x
   –ü—Ä–∏—á–∏–Ω–∞: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞ OKX
```

### 3. –§–∏–Ω–∞–ª—å–Ω—ã–π leverage (—Å—Ç—Ä–æ–∫–∏ 150-153):
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å DEBUG –Ω–∞ INFO
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª–∏: category, adjusted_strength

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
‚úÖ [ADAPTIVE_LEVERAGE] BTC-USDT: –§–ò–ù–ê–õ–¨–ù–´–ô leverage=20x | 
   category=strong, adjusted_strength=0.85
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å leverage –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö!

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±–ª–µ–º–∞ 4 - Margin ratio –ù–ï –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ

**–§–∞–π–ª:** `src/strategies/scalping/futures/calculations/margin_calculator.py` (—Å—Ç—Ä–æ–∫–∞ 518-523)

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ margin_ratio
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: available_margin, margin_used, equity, pnl, liquidation_price, distance_to_liquidation

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
üìä [MARGIN_RATIO] –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏: safe=False | 
   margin_ratio=0.50 (threshold=1.50) | 
   available_margin=$25.00, margin_used=$50.00 | 
   equity=$75.00, pnl=$-2.50 | 
   liq_price=$3568.84 (distance=12.34%)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å margin_ratio –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ–ª–Ω—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ —Ä–∞—Å—á–µ—Ç–∞!

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±–ª–µ–º–∞ 5 - Pre-close state logging

**–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py` (—Å—Ç—Ä–æ–∫–∏ 3921-3950)

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ü–ï–†–ï–î –∑–∞–∫—Ä—ã—Ç–∏–µ–º
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: PnL, margin_used, regime, leverage, signal_strength

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
üìä [PRE_CLOSE] XRP-USDT: –ü—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç—å
   –ü—Ä–∏—á–∏–Ω–∞: sl_reached
   Side: SHORT
   Size: 99 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
   Entry price: $1.942600
   –í—Ä–µ–º—è –≤ –ø–æ–∑–∏—Ü–∏–∏: 4.25 –º–∏–Ω
   Unrealized PnL: $-0.83 USDT
   Margin used: $38.50 USDT
   Regime: ranging
   Leverage: 5x
   Signal strength: 0.65
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ!

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ |
|----------|--------|------|--------|
| DRIFT_REMOVE –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –£–ñ–ï –ë–´–õ–û | orchestrator.py | 2086-2158 |
| Race condition (size=0) | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û | position_manager.py | 5667-5695, 3698-3702 |
| Leverage –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û | adaptive_leverage.py | 117-153 |
| Margin ratio –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û | margin_calculator.py | 518-523 |
| Pre-close state logging | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û | orchestrator.py | 3921-3950 |

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

–¢–µ–ø–µ—Ä—å –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

1. ‚úÖ **DRIFT_REMOVE** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ exchange-side closures
2. ‚úÖ **Race condition** - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ size=0
3. ‚úÖ **Leverage** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö
4. ‚úÖ **Margin ratio** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞
5. ‚úÖ **Pre-close state** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:** –î–∞, –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!








