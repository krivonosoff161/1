# 🏗️ ПОЛНАЯ АРХИТЕКТУРА ГИБРИДНОГО ПРОЕКТА

## 📁 СТРУКТУРА ПРОЕКТА (Корневая папка)

```
simple-trading-bot-okx/          # Корневая папка
│
├── 📂 src/                      # Исходный код (главная папка)
│   ├── 📄 __init__.py
│   ├── 📄 main.py              # 🎯 Точка входа (запуск бота)
│   ├── 📄 config.py            # ⚙️ Парсинг YAML конфигурации
│   ├── 📄 models.py            # 📦 Модели данных (Position, Signal, Tick)
│   ├── 📄 okx_client.py        # 🔌 OKX REST API клиент
│   │
│   ├── 📂 strategies/          # 🎯 ТОРГОВЫЕ СТРАТЕГИИ
│   │   ├── 📄 __init__.py
│   │   ├── 📄 base_strategy.py        # 🏛️ Базовый класс для всех стратегий
│   │   ├── 📄 scalping_engine.py      # 📈 Движок скальпинга (из текущего scalping.py)
│   │   ├── 📄 grid_engine.py          # 🌊 Движок Grid Trading (новый)
│   │   ├── 📄 hybrid_orchestrator.py  # 🎮 Оркестратор (переключает режимы)
│   │   │
│   │   └── 📂 modules/                # ✨ МОДУЛИ УЛУЧШЕНИЙ (Phase 1-2)
│   │       ├── 📄 __init__.py
│   │       ├── 📄 multi_timeframe.py      # ⏱️ Multi-timeframe подтверждение
│   │       ├── 📄 correlation_filter.py   # 🔗 Фильтр корреляции активов
│   │       ├── 📄 time_filter.py          # 🕐 Time-based фильтр (статистика по часам)
│   │       ├── 📄 pivot_points.py         # 📍 Pivot Points расчет и использование
│   │       ├── 📄 order_book_analyzer.py  # 📊 Анализ ордер бука (imbalance)
│   │       └── 📄 liquidity_zones.py      # 💧 Поиск зон ликвидности
│   │
│   ├── 📂 indicators/          # 📊 ТЕХНИЧЕСКИЕ ИНДИКАТОРЫ
│   │   ├── 📄 __init__.py
│   │   ├── 📄 base.py                 # 🏛️ Базовые индикаторы (текущие: RSI, SMA, EMA, BB, ATR, MACD, Volume)
│   │   │
│   │   └── 📂 advanced/               # ✨ ПРОДВИНУТЫЕ ИНДИКАТОРЫ
│   │       ├── 📄 __init__.py
│   │       ├── 📄 volume_profile.py       # 📊 Volume Profile анализ (VPOC, Value Area)
│   │       ├── 📄 pivot_calculator.py     # 📍 Расчет Pivot Points (Standard/Fibonacci/Camarilla)
│   │       └── 📄 adaptive_indicators.py  # 🔄 Адаптивные версии RSI/MACD (опционально)
│   │
│   ├── 📂 filters/              # 🛡️ ФИЛЬТРЫ И ДЕТЕКТОРЫ
│   │   ├── 📄 __init__.py
│   │   ├── 📄 regime_detector.py         # 🌊 Улучшенный детектор режимов (5 режимов)
│   │   ├── 📄 correlation_manager.py     # 🔗 Управление корреляцией между активами
│   │   ├── 📄 time_session_manager.py    # 🕐 Управление торговыми сессиями + статистика
│   │   └── 📄 spread_filter.py           # 💸 Фильтр спреда (уже есть в коде, выделяем)
│   │
│   ├── 📂 risk/                 # 🛡️ УПРАВЛЕНИЕ РИСКАМИ
│   │   ├── 📄 __init__.py
│   │   ├── 📄 position_sizer.py          # 💰 Расчет размера позиции (Fixed + Kelly)
│   │   ├── 📄 risk_calculator.py         # 📊 Расчет рисков (текущий + новый)
│   │   └── 📄 portfolio_monitor.py       # 👁️ Мониторинг портфеля (correlation, exposure)
│   │
│   ├── 📂 ml/                   # 🤖 МАШИННОЕ ОБУЧЕНИЕ (Phase 3, опционально)
│   │   ├── 📄 __init__.py
│   │   ├── 📄 rl_environment.py          # 🎮 Среда для RL агента
│   │   ├── 📄 rl_agent.py                # 🧠 Reinforcement Learning агент
│   │   └── 📄 model_trainer.py           # 🎓 Обучение моделей
│   │
│   ├── 📂 utils/                # 🔧 УТИЛИТЫ
│   │   ├── 📄 __init__.py
│   │   ├── 📄 feature_flags.py           # 🎚️ Feature Flags (включение/выключение модулей)
│   │   ├── 📄 helpers.py                 # 🛠️ Вспомогательные функции
│   │   └── 📄 validators.py              # ✅ Валидаторы данных
│   │
│   └── 📂 web/                  # 🌐 WEB ИНТЕРФЕЙС (опционально, Phase 4+)
│       ├── 📄 __init__.py
│       ├── 📄 app.py                     # 🚀 FastAPI приложение
│       ├── 📂 routes/
│       │   ├── 📄 health.py              # 💚 /health endpoint
│       │   ├── 📄 status.py              # 📊 /status endpoint
│       │   └── 📄 control.py             # 🎮 /start, /stop, /emergency
│       └── 📂 static/
│           └── 📄 dashboard.html         # 📺 Простой HTML dashboard
│
├── 📂 config/                   # ⚙️ КОНФИГУРАЦИЯ
│   ├── 📄 config.yaml                    # 🎛️ Основная конфигурация
│   ├── 📄 config.demo.yaml               # 🧪 Настройки для demo
│   ├── 📄 config.prod.yaml               # 🚀 Настройки для production
│   └── 📄 features.yaml                  # 🎚️ Feature Flags (какие модули включены)
│
├── 📂 data/                     # 💾 ДАННЫЕ
│   ├── 📂 historical/                    # 📜 Исторические данные для бэктеста
│   ├── 📂 cache/                         # 🗄️ Кэш (свечи, индикаторы)
│   └── 📄 trading_bot.db                 # 🗃️ SQLite база (сделки, статистика)
│
├── 📂 logs/                     # 📝 ЛОГИ
│   ├── 📄 trading_bot_YYYY-MM-DD.log     # 📊 Основной лог
│   ├── 📄 errors_YYYY-MM-DD.log          # ❌ Ошибки
│   └── 📄 trades_YYYY-MM-DD.log          # 💰 История сделок
│
├── 📂 backups/                  # 💾 РЕЗЕРВНЫЕ КОПИИ (опционально)
│   ├── 📄 state_YYYYMMDD_HHMMSS.json     # 📸 Снимки состояния
│   └── 📄 db_backup_YYYYMMDD.db          # 🗃️ Backup базы данных
│
├── 📂 tests/                    # 🧪 ТЕСТЫ (добавим позже)
│   ├── 📄 __init__.py
│   ├── 📂 unit/                          # 🔬 Unit тесты
│   │   ├── 📄 test_scalping_engine.py
│   │   ├── 📄 test_grid_engine.py
│   │   ├── 📄 test_multi_timeframe.py
│   │   └── 📄 test_indicators.py
│   ├── 📂 integration/                   # 🔗 Integration тесты
│   │   ├── 📄 test_okx_connection.py
│   │   └── 📄 test_hybrid_orchestrator.py
│   └── 📂 backtest/                      # 📈 Бэктестинг
│       └── 📄 test_historical_strategy.py
│
├── 📂 scripts/                  # 🔧 СКРИПТЫ УТИЛИТ
│   ├── 📄 collect_statistics.py          # 📊 Сбор статистики для Time Filter
│   ├── 📄 optimize_parameters.py         # 🎯 Оптимизация параметров
│   ├── 📄 backtest_runner.py             # 🔙 Запуск бэктеста
│   └── 📄 generate_report.py             # 📄 Генерация отчетов
│
├── 📂 docs/                     # 📚 ДОКУМЕНТАЦИЯ
│   ├── 📄 ГЛУБОКИЙ_АНАЛИЗ_СТРАТЕГИИ.md
│   ├── 📄 КОНЦЕПЦИЯ_ГИБРИДНОГО_БОТА.md
│   ├── 📄 ДЕТАЛЬНОЕ_ОПИСАНИЕ_МОДУЛЕЙ.md
│   ├── 📄 ПЛАН_МОДЕРНИЗАЦИИ_СТРАТЕГИИ.md
│   ├── 📄 СРАВНЕНИЕ_ДВУХ_ПРОЕКТОВ.md
│   └── 📄 АРХИТЕКТУРА_ГИБРИДНОГО_ПРОЕКТА.md  # ← Этот файл!
│
├── 📄 .env                      # 🔐 Переменные окружения (НЕ в Git!)
├── 📄 .env.example              # 📋 Пример .env
├── 📄 .gitignore                # 🚫 Исключения Git
├── 📄 requirements.txt          # 📦 Python зависимости
├── 📄 config.yaml               # ⚙️ Основная конфигурация (симлинк на config/config.yaml)
├── 📄 README.md                 # 📖 Основная документация
├── 📄 run_bot.py                # ▶️ Запуск бота (простой)
├── 📄 start_bot.bat             # 🪟 Запуск для Windows
└── 📄 stop_bot.bat              # ⛔ Остановка для Windows
```

---

## 📂 ДЕТАЛЬНОЕ ОПИСАНИЕ КАЖДОЙ ПАПКИ

### 📁 `src/` - Исходный код

Главная папка с кодом бота.

---

### 📁 `src/strategies/` - ТОРГОВЫЕ СТРАТЕГИИ

**Назначение**: Логика принятия торговых решений

#### 📄 `base_strategy.py`
**Что**: Абстрактный базовый класс для всех стратегий  
**Зачем**: Единый интерфейс, переиспользование кода  
**Размер**: ~200 строк

```python
from abc import ABC, abstractmethod

class BaseStrategy(ABC):
    """Базовый класс для всех стратегий"""
    
    @abstractmethod
    async def process_tick(self, tick):
        """Обработать новый tick"""
        pass
    
    @abstractmethod
    def can_trade(self, symbol) -> bool:
        """Проверка возможности торговли"""
        pass
    
    @abstractmethod
    def get_positions(self):
        """Получить открытые позиции"""
        pass
```

---

#### 📄 `scalping_engine.py`
**Что**: Движок скальпинга (из текущего `scalping.py`)  
**Зачем**: Торговля в TRENDING режиме  
**Размер**: ~1500 строк  
**Функции**:
- Генерация сигналов (Scoring система 0-12)
- Управление позициями
- Break-even, Trailing Stop
- Partial Take Profits
- Все текущие защиты

```python
class ScalpingEngine(BaseStrategy):
    """Движок скальпинга для TRENDING рынков"""
    
    def __init__(self, client, config, shared_modules):
        self.client = client
        self.config = config
        
        # Подключаем модули
        self.mtf_filter = shared_modules.mtf
        self.correlation = shared_modules.correlation
        # ...
    
    async def process_tick(self, tick):
        """Основной цикл скальпинга"""
        # Существующая логика!
```

---

#### 📄 `grid_engine.py`
**Что**: Движок Grid Trading (НОВЫЙ)  
**Зачем**: Торговля в RANGING режиме  
**Размер**: ~800 строк  
**Функции**:
- Расчет Grid уровней
- Размещение сетки ордеров
- Автоматическое переоткрытие
- Stop Loss для Grid
- Time Stop

```python
class GridTradingEngine(BaseStrategy):
    """Grid Trading для RANGING рынков"""
    
    def __init__(self, client, config, shared_modules):
        self.grid_levels = []
        self.active_grid_orders = {}
        
        # Используем общие модули
        self.correlation = shared_modules.correlation
        self.pivots = shared_modules.pivots
        self.vp_analyzer = shared_modules.volume_profile
    
    async def calculate_grid(self, symbol):
        """Расчет уровней сетки"""
        # Используем Pivot Points для границ
        pivots = self.pivots.get_pivots(symbol)
        grid_low = pivots['S2']
        grid_high = pivots['R2']
        
        # Используем VPOC для центра
        vpoc = self.vp_analyzer.get_vpoc(symbol)
        # ...
```

---

#### 📄 `hybrid_orchestrator.py`
**Что**: Главный оркестратор (переключатель режимов)  
**Зачем**: Управляет Scalping + Grid, переключает режимы  
**Размер**: ~500 строк  
**Функции**:
- Детекция режима рынка
- Переключение между движками
- Управление капиталом
- Координация позиций

```python
class HybridOrchestrator:
    """Управление гибридной стратегией"""
    
    def __init__(self, client, config):
        # Создаем общие модули
        self.shared_modules = self._init_shared_modules()
        
        # Инициализируем движки
        self.scalping = ScalpingEngine(client, config, self.shared_modules)
        self.grid = GridTradingEngine(client, config, self.shared_modules)
        
        # Текущий режим
        self.current_mode = "RANGING"
        self.mode_confirmations = {}
    
    async def run(self):
        """Главный цикл"""
        while self.active:
            # 1. Определяем режим
            regime = await self._detect_regime()
            
            # 2. Переключаем если нужно
            if await self._should_switch(regime):
                await self._switch_mode(regime)
            
            # 3. Запускаем активный движок
            if self.current_mode == "RANGING":
                await self.grid.process_tick(tick)
            elif self.current_mode == "TRENDING":
                await self.scalping.process_tick(tick)
```

---

### 📁 `src/strategies/modules/` - МОДУЛИ УЛУЧШЕНИЙ

**Назначение**: Отдельные модули для каждой фичи (Phase 1-2)

#### 📄 `multi_timeframe.py`
**Что**: Проверка старшего таймфрейма (5m)  
**Зачем**: Фильтр против тренда, +2 балла в scoring  
**Размер**: ~300 строк  
**Использует**: OKX Client для получения 5m свечей

```python
class MultiTimeframeFilter:
    """Multi-timeframe confirmation"""
    
    def __init__(self, client, config):
        self.client = client
        self.timeframe = config.confirmation_timeframe  # "5m"
        self.score_bonus = config.score_bonus  # 2
    
    async def check_confirmation(self, symbol, direction):
        """Проверить подтверждение на старшем TF"""
        # Получить 5m свечи
        candles_5m = await self.client.get_candles(symbol, "5m", 100)
        
        # Рассчитать EMA8/21 на 5m
        ema8 = calculate_ema(candles_5m, 8)
        ema21 = calculate_ema(candles_5m, 21)
        
        # Проверка
        if direction == "LONG":
            confirmed = ema8 > ema21  # Бычий тренд на 5m
        else:
            confirmed = ema8 < ema21  # Медвежий тренд на 5m
        
        return MTFResult(
            confirmed=confirmed,
            blocked=not confirmed if self.block_against else False,
            bonus=self.score_bonus if confirmed else 0
        )
```

---

#### 📄 `correlation_filter.py`
**Что**: Проверка корреляции BTC-ETH-SOL  
**Зачем**: Не открывать 3 одинаковых позиции  
**Размер**: ~250 строк

```python
class CorrelationFilter:
    """Фильтр корреляции активов"""
    
    def __init__(self, config):
        self.threshold = config.correlation_threshold  # 0.75
        self.max_correlated = config.max_correlated_positions  # 2
        self.correlation_matrix = {}
    
    async def update_correlations(self, price_data):
        """Обновить корреляционную матрицу (каждый час)"""
        # Pearson correlation на доходностях
        for pair in combinations(symbols, 2):
            corr = np.corrcoef(returns_A, returns_B)[0,1]
            self.correlation_matrix[pair] = corr
    
    def can_open_position(self, symbol, direction, existing_positions):
        """Проверить можно ли открыть позицию"""
        correlated_count = 0
        
        for pos_symbol, position in existing_positions.items():
            corr = self._get_correlation(symbol, pos_symbol)
            
            if corr > self.threshold and position.direction == direction:
                correlated_count += 1
        
        return correlated_count < self.max_correlated
```

---

#### 📄 `time_filter.py`
**Что**: Статистика по часам, блокировка убыточных  
**Зачем**: Не торговать в плохие часы, усиливать в хорошие  
**Размер**: ~400 строк  
**Использует**: SQLite для статистики

```python
class TimeSessionManager:
    """Управление временными фильтрами"""
    
    def __init__(self, config, db):
        self.db = db  # SQLite для статистики
        self.blacklist_threshold = config.blacklist_threshold  # 35%
        self.whitelist_threshold = config.whitelist_threshold  # 65%
        self.hour_stats = {}
    
    async def update_statistics(self):
        """Обновить статистику по часам (каждый день)"""
        # SQL запрос
        query = """
        SELECT hour_utc, 
               COUNT(*) as total,
               SUM(CASE WHEN win=1 THEN 1 ELSE 0 END)*100.0/COUNT(*) as win_rate
        FROM trades
        WHERE timestamp > datetime('now', '-30 days')
        GROUP BY hour_utc
        """
        results = await self.db.execute(query)
        
        for row in results:
            self.hour_stats[row['hour_utc']] = {
                'win_rate': row['win_rate'],
                'status': self._classify_hour(row['win_rate'])
            }
    
    def get_hour_status(self, hour):
        """Получить статус часа (blacklist/whitelist/neutral)"""
        stats = self.hour_stats.get(hour, {})
        return stats.get('status', 'neutral')
```

---

#### 📄 `pivot_points.py`
**Что**: Расчет Pivot Points (3 метода)  
**Зачем**: Уровни для TP/SL, +2 балла при касании  
**Размер**: ~350 строк

```python
class PivotCalculator:
    """Расчет Pivot Points"""
    
    def __init__(self, method="standard"):
        self.method = method  # standard, fibonacci, camarilla
        self.daily_pivots = {}
    
    async def calculate_pivots(self, symbol, candle_data):
        """Рассчитать пивоты на основе вчерашнего дня"""
        yesterday = candle_data[-1]  # Последняя дневная свеча
        
        H, L, C = yesterday.high, yesterday.low, yesterday.close
        
        if self.method == "standard":
            PP = (H + L + C) / 3
            R1 = (2 * PP) - L
            S1 = (2 * PP) - H
            # ...
            
        elif self.method == "fibonacci":
            PP = (H + L + C) / 3
            R1 = PP + 0.382 * (H - L)
            # ...
            
        elif self.method == "camarilla":
            PP = C
            R1 = C + (H - L) * 1.1 / 12
            # ...
        
        self.daily_pivots[symbol] = {
            'PP': PP, 'R1': R1, 'R2': R2, 'S1': S1, 'S2': S2
        }
        
        return self.daily_pivots[symbol]
```

---

#### 📄 `order_book_analyzer.py`
**Что**: Анализ ордер бука (bid/ask imbalance)  
**Зачем**: +1 балл при имбалансе, фильтр спреда  
**Размер**: ~300 строк  
**Использует**: OKX API для Order Book

```python
class OrderBookAnalyzer:
    """Анализ Order Book"""
    
    def __init__(self, client, config):
        self.client = client
        self.depth_levels = config.depth_levels  # 10
        self.imbalance_threshold = config.imbalance_threshold  # 0.2
    
    async def analyze_order_book(self, symbol):
        """Анализировать ордер бук"""
        # Получить Order Book
        order_book = await self.client.get_order_book(symbol, depth=self.depth_levels)
        
        # Расчет imbalance
        total_bids = sum([level['size'] for level in order_book['bids'][:10]])
        total_asks = sum([level['size'] for level in order_book['asks'][:10]])
        
        imbalance = (total_bids - total_asks) / (total_bids + total_asks)
        
        # Расчет спреда
        best_bid = order_book['bids'][0]['price']
        best_ask = order_book['asks'][0]['price']
        spread_percent = (best_ask - best_bid) / best_bid * 100
        
        return {
            'imbalance': imbalance,
            'spread': spread_percent,
            'depth_ratio': total_bids / total_asks
        }
```

---

#### 📄 `liquidity_zones.py`
**Что**: Поиск кластеров ликвидности  
**Зачем**: +2 балла около кластера, TP перед кластером  
**Размер**: ~400 строк

```python
class LiquidityZoneDetector:
    """Детектор зон ликвидности"""
    
    def find_clusters(self, order_book):
        """Найти кластеры ордеров"""
        clusters = []
        
        # Группируем близкие уровни (в пределах 0.5%)
        for level in order_book['bids'] + order_book['asks']:
            # Логика кластеризации
            # ...
        
        # Находим значимые (>3x среднего)
        significant = [c for c in clusters if c.size > avg_size * 3]
        
        return significant
```

---

### 📁 `src/indicators/` - ИНДИКАТОРЫ

#### 📄 `base.py`
**Что**: Все текущие индикаторы (RSI, SMA, EMA, BB, ATR, MACD, Volume)  
**Зачем**: Базовые расчеты  
**Размер**: ~400 строк (текущий `indicators.py`)

---

### 📁 `src/indicators/advanced/` - ПРОДВИНУТЫЕ

#### 📄 `volume_profile.py`
**Что**: Volume Profile анализ  
**Зачем**: Найти VPOC, Value Area, HVA/LVA  
**Размер**: ~500 строк

```python
class VolumeProfileAnalyzer:
    """Анализ Volume Profile"""
    
    def calculate_profile(self, candles, num_bins=50):
        """Построить профиль объема"""
        # Делим диапазон на bins
        # Суммируем объемы
        # Находим VPOC
        # Находим Value Area (70%)
        # ...
        
        return {
            'vpoc': vpoc_price,
            'value_area_high': va_high,
            'value_area_low': va_low,
            'profile': bins
        }
```

---

#### 📄 `pivot_calculator.py`
**Что**: Расчет Pivot Points  
**Зачем**: Уровни для торговли  
**Размер**: ~300 строк (описан выше)

---

### 📁 `src/filters/` - ФИЛЬТРЫ

#### 📄 `regime_detector.py`
**Что**: Улучшенный детектор режимов (5 режимов)  
**Зачем**: RANGING/TRENDING/HIGH_VOL/LOW_VOL/EXTREME_VOL  
**Размер**: ~300 строк

```python
class EnhancedRegimeDetector:
    """Детектор режимов рынка (5 типов)"""
    
    def detect_regime(self, symbol):
        """Определить режим"""
        volatility = self._calc_volatility()
        trend_strength = self._calc_trend()
        
        if volatility > 0.04:
            return "EXTREME_VOL"  # Не торгуем!
        elif volatility > 0.02:
            return "HIGH_VOL"
        elif trend_strength > 0.05:
            return "TRENDING"
        elif volatility < 0.01:
            return "LOW_VOL"
        else:
            return "RANGING"
    
    def get_regime_params(self, regime):
        """Получить параметры для режима"""
        return self.config.volatility_modes.modes[regime]
```

---

#### 📄 `correlation_manager.py`
**Что**: Управление корреляцией  
**Зачем**: Проверка перед входом  
**Размер**: ~250 строк (описан выше)

---

#### 📄 `time_session_manager.py`
**Что**: Time-based фильтр  
**Зачем**: Статистика по часам  
**Размер**: ~400 строк (описан выше)

---

### 📁 `src/risk/` - УПРАВЛЕНИЕ РИСКАМИ

#### 📄 `position_sizer.py`
**Что**: Расчет размера позиции  
**Зачем**: Fixed Risk или Kelly Criterion  
**Размер**: ~300 строк

```python
class PositionSizer:
    """Расчет оптимального размера позиции"""
    
    def __init__(self, method="fixed"):
        self.method = method  # "fixed" или "kelly"
        self.kelly_calc = KellyCalculator() if method == "kelly" else None
    
    def calculate(self, balance, sl_distance, symbol):
        """Рассчитать размер"""
        if self.method == "fixed":
            risk_amount = balance * 0.01  # 1%
            
        elif self.method == "kelly":
            kelly = self.kelly_calc.calculate(symbol)
            safe_kelly = kelly * 0.25  # Консервативно
            risk_amount = balance * safe_kelly
        
        return risk_amount / sl_distance
```

---

#### 📄 `risk_calculator.py`
**Что**: Расчет рисков (выделено из `scalping.py`)  
**Зачем**: Централизованный расчет  
**Размер**: ~200 строк

---

#### 📄 `portfolio_monitor.py`
**Что**: Мониторинг портфеля  
**Зачем**: Exposure, correlation риск  
**Размер**: ~250 строк

```python
class PortfolioMonitor:
    """Мониторинг состояния портфеля"""
    
    def calculate_exposure(self, positions):
        """Рассчитать exposure по активам"""
        total_exposure = {}
        
        for symbol, position in positions.items():
            base_asset = symbol.split('-')[0]  # BTC, ETH, SOL
            exposure = position.quantity * position.current_price
            total_exposure[base_asset] = exposure
        
        return total_exposure
    
    def check_risk_limits(self):
        """Проверить все лимиты риска"""
        # Max positions
        # Max correlation
        # Max exposure per asset
        # Daily loss
        # ...
```

---

### 📁 `src/ml/` - МАШИННОЕ ОБУЧЕНИЕ (Phase 3)

**Назначение**: RL Agent (опционально, в будущем)

#### 📄 `rl_agent.py`
**Размер**: ~600 строк  
**Функции**: PPO агент для торговли

---

### 📁 `src/utils/` - УТИЛИТЫ

#### 📄 `feature_flags.py`
**Что**: Управление Feature Flags  
**Зачем**: Включение/выключение модулей  
**Размер**: ~150 строк

```python
class FeatureFlags:
    """Управление включением/выключением модулей"""
    
    def __init__(self, config):
        self.flags = config.features
    
    def is_enabled(self, feature_name):
        """Проверить включен ли модуль"""
        return self.flags.get(f"{feature_name}_enabled", False)
    
    # Использование:
    if feature_flags.is_enabled("multi_timeframe"):
        mtf_result = await self.mtf_filter.check(...)
```

---

### 📁 `config/` - КОНФИГУРАЦИЯ

#### 📄 `config.yaml`
**Что**: Главная конфигурация  
**Размер**: ~300 строк (расширенная)

```yaml
# Базовые настройки (как сейчас)
api:
  okx: ...

trading:
  symbols: ...

risk:
  max_position_size_percent: ...

# ✨ НОВЫЕ СЕКЦИИ

# Feature Flags (управление модулями)
features:
  multi_timeframe_enabled: true
  correlation_filter_enabled: true
  time_based_filter_enabled: true
  volatility_modes_enabled: true
  pivot_points_enabled: true
  volume_profile_enabled: true
  order_book_enabled: false       # Пока выключен
  liquidity_zones_enabled: false  # Пока выключен
  kelly_criterion_enabled: false  # Пока выключен
  hybrid_mode_enabled: false      # Когда Grid готов
  rl_agent_enabled: false         # В будущем

# Multi-timeframe
multi_timeframe:
  confirmation_timeframe: "5m"
  score_bonus: 2
  block_against_trend: true

# Correlation
correlation_filter:
  threshold: 0.75
  max_correlated_positions: 2

# Time-based
time_based_filter:
  learning_period_days: 30
  blacklist_threshold: 35
  whitelist_threshold: 65

# Volatility Modes
volatility_modes:
  thresholds:
    extreme_vol: 0.04
    high_vol: 0.02
    low_vol: 0.01
  modes:
    high_vol:
      tp_multiplier: 2.0
      sl_multiplier: 3.5
      # ...

# Pivot Points
pivot_points:
  calculation_method: "standard"  # или "fibonacci", "camarilla"
  score_bonus: 2

# Volume Profile
volume_profile:
  lookback_period: 24
  price_bins: 50
  score_bonus: 2

# Grid Trading (когда добавим)
grid_trading:
  enabled: false
  num_levels: 5
  step_percent: 0.7
  # ...
```

---

### 📁 `logs/` - ЛОГИ

**Структура**:
```
logs/
├── trading_bot_2025-10-12.log    # Основной лог (всё)
├── errors_2025-10-12.log         # Только ошибки
├── trades_2025-10-12.log         # Только сделки
└── modules_2025-10-12.log        # Работа модулей (debug)
```

**Ротация**: Каждый день новый файл  
**Retention**: 30 дней

---

### 📁 `data/` - ДАННЫЕ

```
data/
├── historical/                   # Исторические свечи (для бэктеста)
│   ├── BTC-USDT_1m_2024.csv
│   ├── ETH-USDT_1m_2024.csv
│   └── SOL-USDT_1m_2024.csv
│
├── cache/                        # Кэш индикаторов
│   ├── indicators_cache.pkl
│   └── correlations_cache.pkl
│
└── trading_bot.db                # SQLite база
    Tables:
    - trades                      # История сделок
    - positions                   # Позиции
    - hour_statistics             # Статистика по часам
    - regime_history              # История режимов
    - performance_metrics         # Метрики
```

---

### 📁 `scripts/` - СКРИПТЫ

#### 📄 `collect_statistics.py`
**Что**: Сбор статистики для Time Filter  
**Использование**: Запускать раз в день

```python
# Пример использования
python scripts/collect_statistics.py --days 30
```

#### 📄 `backtest_runner.py`
**Что**: Бэктест стратегии на истории  
**Использование**: Перед изменениями параметров

```python
python scripts/backtest_runner.py --symbol SOL-USDT --days 90
```

---

## 🔄 КАК ВСЁ РАБОТАЕТ ВМЕСТЕ

### Последовательность работы:

```
1. ЗАПУСК (main.py)
   ↓
2. Загрузка config.yaml
   ↓
3. Проверка Feature Flags
   ↓
4. Инициализация модулей (если enabled):
   - Multi-timeframe Filter
   - Correlation Manager
   - Time Session Manager
   - Regime Detector
   - Pivot Calculator
   - Volume Profile Analyzer
   - Order Book Analyzer (если enabled)
   - Liquidity Zones (если enabled)
   ↓
5. Инициализация стратегий:
   - Scalping Engine (передаем модули)
   - Grid Engine (передаем модули)
   - Hybrid Orchestrator (управляет обоими)
   ↓
6. ГЛАВНЫЙ ЦИКЛ (каждую минуту):
   
   Hybrid Orchestrator:
     ├─> Детектирует режим (Regime Detector)
     ├─> Решает переключать ли (гистерезис 5 мин)
     ├─> Если RANGING → Grid Engine
     └─> Если TRENDING → Scalping Engine
   
   Scalping Engine (если активен):
     ├─> Получает tick
     ├─> Рассчитывает индикаторы (base.py + advanced/)
     ├─> Проверяет фильтры:
     │   ├─> Can trade? (текущая логика)
     │   ├─> Multi-timeframe OK?
     │   ├─> Correlation OK?
     │   ├─> Time Filter OK?
     │   └─> Order Book OK?
     ├─> Генерирует сигнал (Scoring 0-12):
     │   ├─> Базовый score (9 индикаторов)
     │   ├─> + MTF bonus (+2 если подтвердил)
     │   ├─> + Pivot bonus (+2 около уровня)
     │   ├─> + Volume Profile bonus (+2 около VPOC)
     │   ├─> + Order Book bonus (+1 при imbalance)
     │   └─> Итого: до 18 баллов возможно!
     ├─> Если score >= threshold → открываем
     ├─> Рассчитываем размер (Position Sizer: Fixed или Kelly)
     ├─> Корректируем TP/SL (Pivots, Volume Profile)
     └─> Размещаем ордер
   
   Grid Engine (если активен):
     ├─> Определяет диапазон (Pivots: S2-R2)
     ├─> Рассчитывает уровни (5-7 шт, VPOC в центре)
     ├─> Проверяет фильтры:
     │   ├─> Correlation OK?
     │   └─> Time Filter OK?
     ├─> Размещает сетку ордеров
     ├─> Мониторит исполнения
     └─> Переоткрывает уровни
   
7. Управление позициями:
   - Break-even (1 ATR)
   - Trailing Stop (1.5 ATR)
   - Partial TPs (3 уровня)
   - Time Stop (15 мин)
   ↓
8. Логирование и статистика
   ↓
9. Повторяем с шага 6
```

---

## 📊 РАЗМЕРЫ ФАЙЛОВ (Оценка)

| Файл | Строк | Сложность | Описание |
|------|-------|-----------|----------|
| **STRATEGIES** | | | |
| base_strategy.py | 200 | Низкая | Абстракция |
| scalping_engine.py | 1500 | Высокая | Текущая логика |
| grid_engine.py | 800 | Средняя | Grid логика |
| hybrid_orchestrator.py | 500 | Средняя | Оркестратор |
| **MODULES** | | | |
| multi_timeframe.py | 300 | Средняя | MTF проверка |
| correlation_filter.py | 250 | Низкая | Корреляция |
| time_filter.py | 400 | Средняя | Time статистика |
| pivot_points.py | 350 | Низкая | Pivots расчет |
| order_book_analyzer.py | 300 | Средняя | Order Book |
| liquidity_zones.py | 400 | Высокая | Кластеры |
| **INDICATORS** | | | |
| base.py | 400 | Средняя | Текущие |
| volume_profile.py | 500 | Высокая | VP анализ |
| pivot_calculator.py | 300 | Средняя | Pivots |
| **FILTERS** | | | |
| regime_detector.py | 300 | Средняя | 5 режимов |
| correlation_manager.py | 250 | Низкая | Корреляции |
| time_session_manager.py | 400 | Средняя | Время |
| **RISK** | | | |
| position_sizer.py | 300 | Средняя | Kelly + Fixed |
| risk_calculator.py | 200 | Низкая | Риски |
| portfolio_monitor.py | 250 | Средняя | Портфель |
| **CORE** | | | |
| main.py | 200 | Низкая | Запуск |
| config.py | 150 | Низкая | Конфиг |
| models.py | 300 | Низкая | Модели |
| okx_client.py | 600 | Средняя | OKX API |
| **ИТОГО** | **~8,700** | | **Весь проект** |

**Сравнение**:
- Текущий проект: ~3,000 строк
- Гибридный проект: ~8,700 строк
- Проект A (Enhanced): ~15,000+ строк (оценка)

**Вывод**: Гибрид - **средняя сложность**, управляемо!

---

## 🎯 DEPENDENCIES (Файлы конфигурации)

### 📄 `requirements.txt` (расширенный)

```python
# Текущие зависимости
aiohttp==3.9.1
loguru==0.7.2
pydantic==2.5.0
pyyaml==6.0.1
python-dotenv==1.0.0
numpy==1.26.0

# ✨ НОВЫЕ для Phase 1-2
pandas==2.1.0              # Для корреляций, статистики
scipy==1.11.0              # Для статистических расчетов
scikit-learn==1.3.0        # Для Volume Profile кластеризации

# ✨ НОВЫЕ для Phase 3 (ML, опционально)
torch==2.1.0               # Для RL Agent
stable-baselines3==2.1.0   # RL algorithms

# ✨ НОВЫЕ для Web (опционально)
fastapi==0.104.0           # Web framework
uvicorn==0.24.0            # ASGI server

# Тестирование
pytest==7.4.0
pytest-asyncio==0.21.0
```

---

## 🎚️ FEATURE FLAGS (config/features.yaml)

```yaml
# Управление модулями (включение/выключение)

# Phase 1: Базовые улучшения
multi_timeframe_enabled: false          # ← Включаем по одному!
correlation_filter_enabled: false
time_based_filter_enabled: false
volatility_modes_enabled: false
pivot_points_enabled: false
volume_profile_enabled: false

# Phase 2: Продвинутые
order_book_enabled: false
liquidity_zones_enabled: false

# Phase 3: ML (в будущем)
kelly_criterion_enabled: false
rl_agent_enabled: false

# Phase 4: Гибрид
hybrid_mode_enabled: false             # Когда Grid готов
grid_trading_enabled: false

# Опционально
web_dashboard_enabled: false
auto_backups_enabled: false
```

**Как используется**:
```python
# В scalping_engine.py

if self.config.features.multi_timeframe_enabled:
    from .modules.multi_timeframe import MultiTimeframeFilter
    self.mtf = MultiTimeframeFilter(...)
else:
    self.mtf = None  # Модуль выключен

# При генерации сигнала
if self.mtf:
    result = await self.mtf.check(...)  # Используем если включен
```

---

## 📊 ОБЩАЯ КАРТИНА (Visual)

```
📦 simple-trading-bot-okx/
│
├── 🎯 CORE (Ядро, 4 файла)
│   main.py, config.py, models.py, okx_client.py
│   └─> Запускает всё, общая логика
│
├── 🎮 STRATEGIES (Стратегии, 4 файла)
│   ├── base_strategy.py (абстракция)
│   ├── scalping_engine.py (TRENDING режим)
│   ├── grid_engine.py (RANGING режим)
│   └── hybrid_orchestrator.py (переключатель)
│
├── ✨ MODULES (Модули улучшений, 6 файлов, Phase 1)
│   ├── multi_timeframe.py
│   ├── correlation_filter.py
│   ├── time_filter.py
│   ├── pivot_points.py
│   ├── order_book_analyzer.py
│   └── liquidity_zones.py
│
├── 📊 INDICATORS (Индикаторы)
│   ├── base.py (текущие 9 индикаторов)
│   └── advanced/ (Volume Profile, Pivot Calc, Adaptive)
│
├── 🛡️ FILTERS (Фильтры)
│   ├── regime_detector.py (5 режимов)
│   ├── correlation_manager.py
│   └── time_session_manager.py
│
├── 💰 RISK (Риск-менеджмент)
│   ├── position_sizer.py (Kelly + Fixed)
│   ├── risk_calculator.py
│   └── portfolio_monitor.py
│
├── 🤖 ML (Машинное обучение, опционально)
│   └── rl_agent.py
│
├── 🔧 UTILS (Утилиты)
│   └── feature_flags.py
│
├── 🌐 WEB (Веб интерфейс, опционально)
│   └── app.py
│
├── ⚙️ CONFIG (Конфигурация)
│   ├── config.yaml
│   ├── config.demo.yaml
│   └── features.yaml
│
└── 🔧 SCRIPTS (Скрипты утилит)
    ├── collect_statistics.py
    ├── backtest_runner.py
    └── optimize_parameters.py
```

**Итого**:
- **Файлов Python**: ~30
- **Конфигураций**: ~4
- **Скриптов**: ~5
- **Всего**: ~40 файлов

**VS текущий проект**: ~15 файлов

**Управляемо?** ✅ **ДА!** (для solo-разработки)

---

## 🎯 МИГРАЦИЯ (Как переходим)

### Текущая структура → Гибридная:

```
ШАГ 1: Создаем новые папки
  src/strategies/modules/
  src/indicators/advanced/
  src/filters/
  src/risk/
  config/

ШАГ 2: Рефакторинг (переносим код)
  scalping.py → scalping_engine.py
  Выделяем base_strategy.py
  
ШАГ 3: Добавляем модули (по одному!)
  Week 1: multi_timeframe.py
  Week 2: correlation_filter.py
  Week 3: time_filter.py
  # ...

ШАГ 4: Grid Engine
  Создаем grid_engine.py
  Тестируем отдельно

ШАГ 5: Hybrid
  Создаем hybrid_orchestrator.py
  Интеграция
```

**Откат возможен** на ЛЮБОМ шаге!

---

📂 **Сохранено в**: `АРХИТЕКТУРА_ГИБРИДНОГО_ПРОЕКТА.md`

**Готов начинать миграцию когда дадите команду!** 🚀

