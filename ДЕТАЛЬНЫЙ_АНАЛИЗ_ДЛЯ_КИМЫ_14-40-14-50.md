# üìã –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –î–õ–Ø –ö–ò–ú–´: 14:40-14:50 UTC 07.12.2025

**–î–∞—Ç–∞:** 2025-12-07  
**–ü–µ—Ä–∏–æ–¥:** 14:40-14:50 UTC  
**–¶–µ–ª—å:** –ù–∞–π—Ç–∏ —Ç–æ—á–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –º–∞—Ä–∂–∏

---

## 1Ô∏è‚É£ –õ–û–ì–ò –ó–ê 14:40‚Äì14:50 UTC

### ‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
–í –ª–æ–≥–∞—Ö –≤—Ä–µ–º—è —É–∫–∞–∑–∞–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `19:26:XX` (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è), –Ω–æ –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å –≤ `14:44-14:57 UTC` (entry_time –∏–∑ CSV).

### –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ `info_2025-12-07.log`:

**SOL-USDT (–æ—Ç–∫—Ä—ã—Ç–∞ 14:46:08 UTC):**
```
2025-12-07 19:26:16.422 | INFO | exit_analyzer:_generate_exit_for_ranging | 
üîç ExitAnalyzer RANGING SOL-USDT: entry_price=137.54, current_price=132.46, side=long, 
Gross PnL%=-3.69%, Net PnL%=-19.34% (—Å –∫–æ–º–∏—Å—Å–∏–µ–π), entry_time=2025-12-07 14:46:08.513439+00:00

üîç ExitAnalyzer RANGING SOL-USDT: TP=3.50%, PnL%=-19.34%, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç=False
üìä ExitAnalyzer: –†–µ—à–µ–Ω–∏–µ –¥–ª—è SOL-USDT (—Ä–µ–∂–∏–º=ranging): action=hold, reason=max_holding_exceeded_but_loss, PnL=-19.34%
```

**BTC-USDT (–æ—Ç–∫—Ä—ã—Ç–∞ 14:46:33 UTC):**
```
2025-12-07 19:26:16.422 | INFO | exit_analyzer:_generate_exit_for_ranging | 
üîç ExitAnalyzer RANGING BTC-USDT: entry_price=87941.80, current_price=89360.00, side=short, 
Gross PnL%=-1.61%, Net PnL%=-6.82% (—Å –∫–æ–º–∏—Å—Å–∏–µ–π), entry_time=2025-12-07 14:46:33.342544+00:00

üîç ExitAnalyzer RANGING BTC-USDT: TP=5.00%, PnL%=-6.82%, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç=False
üìä ExitAnalyzer: –†–µ—à–µ–Ω–∏–µ –¥–ª—è BTC-USDT (—Ä–µ–∂–∏–º=ranging): action=hold, reason=max_holding_exceeded_but_loss, PnL=-6.82%
```

**XRP-USDT (–æ—Ç–∫—Ä—ã—Ç–∞ 14:44:36 UTC, –∑–∞—Ç–µ–º 14:52:34 UTC):**
```
2025-12-07 19:26:16.422 | INFO | exit_analyzer:_generate_exit_for_ranging | 
üîç ExitAnalyzer RANGING XRP-USDT: entry_price=1.99, current_price=2.03, side=short, 
Gross PnL%=-1.72%, Net PnL%=-11.46% (—Å –∫–æ–º–∏—Å—Å–∏–µ–π), entry_time=2025-12-07 14:53:29.807428+00:00

üîç ExitAnalyzer RANGING XRP-USDT: TP=3.00%, PnL%=-11.46%, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç=False
üìä ExitAnalyzer: –†–µ—à–µ–Ω–∏–µ –¥–ª—è XRP-USDT (—Ä–µ–∂–∏–º=ranging): action=hold, reason=max_holding_exceeded_but_loss, PnL=-11.46%
```

**ETH-USDT (–æ—Ç–∫—Ä—ã—Ç–∞ 14:57:34 UTC):**
```
2025-12-07 19:26:16.438 | INFO | exit_analyzer:_generate_exit_for_ranging | 
üîç ExitAnalyzer RANGING ETH-USDT: entry_price=2946.57, current_price=2990.93, side=short, 
Gross PnL%=-1.51%, Net PnL%=-18.63% (—Å –∫–æ–º–∏—Å—Å–∏–µ–π), entry_time=2025-12-07 14:57:34.950000+00:00

üîç ExitAnalyzer RANGING ETH-USDT: TP=3.50%, PnL%=-18.63%, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç=False
üìä ExitAnalyzer: –†–µ—à–µ–Ω–∏–µ –¥–ª—è ETH-USDT (—Ä–µ–∂–∏–º=ranging): action=hold, reason=max_holding_exceeded_but_loss, PnL=-18.63%
```

### üîç –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –ª–æ–≥–∞—Ö:

**"blocked", "cooldown", "margin", "insufficient", "rejected", "skipped", "limit reached", "position limit", "risk":**
- **–ù–µ –Ω–∞–π–¥–µ–Ω–æ** –≤ –ø–µ—Ä–∏–æ–¥ 14:40-14:50 UTC (–ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–∏—Ü–∏–π –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è)

**"sl_percent", "tp_percent", "pnl_percent":**
- –ù–∞–π–¥–µ–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ `exit_analyzer` –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
- –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `pnl_percent` –æ—Ç –º–∞—Ä–∂–∏ (–Ω–µ –æ—Ç —Ü–µ–Ω—ã)

---

## 2Ô∏è‚É£ –î–ê–ú–ü –ü–û–ó–ò–¶–ò–ô –ù–ê 14:50 UTC

### –ò–∑ `positions_open_2025-12-07.csv`:

| symbol | side | entry_price | size | regime | order_id | timestamp |
|--------|------|-------------|------|--------|----------|-----------|
| XRP-USDT | short | 2.00291957 | 46.00000000 | ranging | 3107686514660282368 | 2025-12-07T14:44:36.823096 |
| DOGE-USDT | short | 0.13535000 | 510.00000000 | ranging | 3107686972376289280 | 2025-12-07T14:44:50.484778 |
| SOL-USDT | long | 128.52840000 | 0.73000000 | ranging | 3107687598200000512 | 2025-12-07T14:45:09.966982 |
| BTC-USDT | short | 88165.31128000 | 0.00070000 | ranging | 3107688552018284544 | 2025-12-07T14:45:38.862644 |

### –ò–∑ –ª–æ–≥–æ–≤ (–Ω–∞ –º–æ–º–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞ ~19:26 UTC):

**SOL-USDT:**
- `entry_price`: 137.54 (–≤ CSV: 128.53 - –≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–∑–∏—Ü–∏—è –±—ã–ª–∞ –¥–æ–ø–æ–ª–Ω–µ–Ω–∞)
- `current_price`: 132.46
- `pnl_percent`: -19.34% (–æ—Ç –º–∞—Ä–∂–∏)
- `sl_percent`: 2.0% (–¥–ª—è ranging)
- `tp_percent`: 3.5% (per-regime –¥–ª—è SOL-USDT –≤ ranging)
- `regime`: ranging
- `timestamp –≤—Ö–æ–¥–∞`: 2025-12-07 14:46:08.513439+00:00
- `reason –∑–∞–∫—Ä—ã—Ç–∏—è`: –ù–µ—Ç (–ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞)

**BTC-USDT:**
- `entry_price`: 87941.80 (–≤ CSV: 88165.31 - –≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–∑–∏—Ü–∏—è –±—ã–ª–∞ –¥–æ–ø–æ–ª–Ω–µ–Ω–∞)
- `current_price`: 89360.00
- `pnl_percent`: -6.82% (–æ—Ç –º–∞—Ä–∂–∏)
- `sl_percent`: 2.0% (–¥–ª—è ranging)
- `tp_percent`: 5.0% (per-regime –¥–ª—è BTC-USDT –≤ ranging)
- `regime`: ranging
- `timestamp –≤—Ö–æ–¥–∞`: 2025-12-07 14:46:33.342544+00:00
- `reason –∑–∞–∫—Ä—ã—Ç–∏—è`: –ù–µ—Ç (–ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞)

**XRP-USDT:**
- `entry_price`: 1.99 (–≤ CSV: 2.00 - –≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–∑–∏—Ü–∏—è –±—ã–ª–∞ –¥–æ–ø–æ–ª–Ω–µ–Ω–∞)
- `current_price`: 2.03
- `pnl_percent`: -11.46% (–æ—Ç –º–∞—Ä–∂–∏)
- `sl_percent`: 2.0% (–¥–ª—è ranging)
- `tp_percent`: 3.0% (per-regime –¥–ª—è XRP-USDT –≤ ranging)
- `regime`: ranging
- `timestamp –≤—Ö–æ–¥–∞`: 2025-12-07 14:53:29.807428+00:00
- `reason –∑–∞–∫—Ä—ã—Ç–∏—è`: –ù–µ—Ç (–ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞)

**ETH-USDT:**
- `entry_price`: 2946.57
- `current_price`: 2990.93
- `pnl_percent`: -18.63% (–æ—Ç –º–∞—Ä–∂–∏)
- `sl_percent`: 2.0% (–¥–ª—è ranging)
- `tp_percent`: 3.5% (per-regime –¥–ª—è ETH-USDT –≤ ranging)
- `regime`: ranging
- `timestamp –≤—Ö–æ–¥–∞`: 2025-12-07 14:57:34.950000+00:00
- `reason –∑–∞–∫—Ä—ã—Ç–∏—è`: –ù–µ—Ç (–ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞)

### –ó–∞–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–∏–∑ `trades_2025-12-07.csv`):

**DOGE-USDT:**
- `entry_price`: 0.1353
- `exit_price`: 0.1350
- `net_pnl`: +0.0058 USDT
- `reason`: profit_drawdown
- `duration_sec`: 769.59 (‚âà12.8 –º–∏–Ω—É—Ç)

---

## 3Ô∏è‚É£ –ö–û–î –†–ê–°–ß–ï–¢–ê –ú–ê–†–ñ–ò –î–õ–Ø –ü–û–ó–ò–¶–ò–ò

### –§–∞–π–ª: `src/strategies/scalping/futures/risk_manager.py`

### –§—É–Ω–∫—Ü–∏—è: `calculate_position_size` (—Å—Ç—Ä–æ–∫–∏ 867-1014):

```python
# 1. –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä (notional –≤ USD)
base_usd_size = balance_profile["base_position_usd"]  # –ù–∞–ø—Ä–∏–º–µ—Ä, 50.0 –¥–ª—è micro
# –ü—Ä–∏–º–µ–Ω—è–µ–º strength_multiplier –∏ –¥—Ä—É–≥–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏
base_usd_size *= strength_multiplier  # –ü–æ —Å–∏–ª–µ —Å–∏–≥–Ω–∞–ª–∞
base_usd_size = min(base_usd_size, max_usd_size)  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º—É–º–æ–º

# 2. –†–∞—Å—á–µ—Ç –º–∞—Ä–∂–∏
margin_required_initial = base_usd_size / leverage  # –¢—Ä–µ–±—É–µ–º–∞—è –º–∞—Ä–∂–∞ (–≤ USD)
margin_required = margin_required_initial

# 3. –ü–æ–ª—É—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—É—é –º–∞—Ä–∂—É —Å –±–∏—Ä–∂–∏
used_margin = await self._get_used_margin()

# 4. –ü–æ–ª—É—á–∞–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∏—Å–∫–∞
adaptive_risk_params = self.config_manager.get_adaptive_risk_params(
    balance, symbol_regime, symbol, signal_generator=signal_generator
)
max_margin_percent = adaptive_risk_params.get("max_margin_percent", 80.0) / 100.0
max_loss_per_trade_percent = adaptive_risk_params.get("max_loss_per_trade_percent", 2.0) / 100.0
max_margin_safety_percent = adaptive_risk_params.get("max_margin_safety_percent", 90.0) / 100.0

# 5. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: Max Margin Used (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
max_margin_allowed = balance * max_margin_percent  # –ù–∞–ø—Ä–∏–º–µ—Ä, 80% –æ—Ç –±–∞–ª–∞–Ω—Å–∞
available_margin = balance - used_margin

if used_margin + margin_required > max_margin_allowed:
    margin_required = max(0, max_margin_allowed - used_margin)

# 6. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: Available Margin
if margin_required > available_margin:
    margin_required = max(0, available_margin)

# 7. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: Max Loss per Trade
max_loss_usd = balance * max_loss_per_trade_percent  # –ù–∞–ø—Ä–∏–º–µ—Ä, 2% –æ—Ç –±–∞–ª–∞–Ω—Å–∞
sl_percent = getattr(self.scalping_config, "sl_percent", 0.2)
if sl_percent > 1:
    sl_percent_decimal = sl_percent / 100
else:
    sl_percent_decimal = sl_percent

max_safe_margin = max_loss_usd / sl_percent_decimal  # –ù–∞–ø—Ä–∏–º–µ—Ä, 2% / 2.0% = 1.0x –±–∞–ª–∞–Ω—Å–∞
if margin_required > max_safe_margin:
    margin_required = max_safe_margin

# 8. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: Max Margin Safety (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
max_margin_safety = balance * max_margin_safety_percent  # –ù–∞–ø—Ä–∏–º–µ—Ä, 90% –æ—Ç –±–∞–ª–∞–Ω—Å–∞
if margin_required > max_margin_safety:
    margin_required = max_margin_safety

# 9. –§–∏–Ω–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã
margin_usd = max(min_margin_usd, min(margin_required, max_margin_usd))

# 10. –ü–µ—Ä–µ–≤–æ–¥–∏–º –ú–ê–†–ñ–£ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç
position_size = (margin_usd * leverage) / price
```

### ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ leverage?
**–î–ê** - `margin_required = base_usd_size / leverage` (—Å—Ç—Ä–æ–∫–∞ 868)

### ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —Ä–µ–∂–∏–º (ranging/trending/choppy)?
**–î–ê** - —á–µ—Ä–µ–∑ `adaptive_risk_params` (—Å—Ç—Ä–æ–∫–∞ 682-684), –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —Ä–µ–∂–∏–º—É

### ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ –±–∞–ª–∞–Ω—Å –∏ —Ä–∏—Å–∫-–ø—Ä–æ—Ü–µ–Ω—Ç?
**–î–ê** - —á–µ—Ä–µ–∑ `balance_profile` –∏ `max_loss_per_trade_percent` (—Å—Ç—Ä–æ–∫–∏ 952-953)

---

## 4Ô∏è‚É£ –ö–û–î –†–ê–°–ß–ï–¢–ê pnl_percent

### –§–∞–π–ª: `src/strategies/scalping/futures/positions/exit_analyzer.py`

### –§—É–Ω–∫—Ü–∏—è: `_calculate_pnl_percent` (—Å—Ç—Ä–æ–∫–∏ 279-457):

```python
def _calculate_pnl_percent(
    self,
    entry_price: float,
    current_price: float,
    position_side: str,
    include_fees: bool = True,
    entry_time: Optional[datetime] = None,
    position: Optional[Any] = None,
    metadata: Optional[Any] = None,
) -> float:
    """
    ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤ —Å—á–∏—Ç–∞–µ–º PnL% –æ—Ç –ú–ê–†–ñ–ò, –∞ –Ω–µ –æ—Ç —Ü–µ–Ω—ã!
    –ë–∏—Ä–∂–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç PnL% –æ—Ç –º–∞—Ä–∂–∏ (—Å —É—á–µ—Ç–æ–º –ø–ª–µ—á–∞), –ø–æ—ç—Ç–æ–º—É –Ω–∞—à —Ä–∞—Å—á–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å.
    """
    
    # ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å PnL% –æ—Ç –º–∞—Ä–∂–∏ (–∫–∞–∫ –Ω–∞ –±–∏—Ä–∂–µ)
    margin_used = None
    unrealized_pnl = None
    
    # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ position
    if position and isinstance(position, dict):
        margin_used = float(position.get("margin") or position.get("imr") or "0")
        unrealized_pnl = float(position.get("upl") or position.get("unrealizedPnl") or "0")
    
    # –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ margin –∏ unrealizedPnl - —Å—á–∏—Ç–∞–µ–º –æ—Ç –º–∞—Ä–∂–∏ (–∫–∞–∫ –Ω–∞ –±–∏—Ä–∂–µ)
    if margin_used and margin_used > 0 and unrealized_pnl is not None:
        gross_pnl_pct = (unrealized_pnl / margin_used) * 100  # –í –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
        
        # –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if include_fees and seconds_since_open >= 10.0:
            trading_fee_rate = 0.0010  # 0.1% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            commission_pct = trading_fee_rate * 100  # 0.1% = 0.1
            net_pnl_pct = gross_pnl_pct - commission_pct
            return net_pnl_pct
        else:
            return gross_pnl_pct
    
    # ‚úÖ FALLBACK: –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ margin, —Å—á–∏—Ç–∞–µ–º –æ—Ç —Ü–µ–Ω—ã (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥)
    if position_side.lower() == "long":
        gross_profit_pct = (current_price - entry_price) / entry_price * 100
    else:  # short
        gross_profit_pct = (entry_price - current_price) / entry_price * 100
    
    # –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if include_fees and seconds_since_open >= 10.0:
        commission_pct = trading_fee_rate * 100
        net_profit_pct = gross_profit_pct - commission_pct
        return net_profit_pct
    else:
        return gross_profit_pct
```

### ‚úÖ –ö–∞–∫ –∏–º–µ–Ω–Ω–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è pnl_percent?
**–û—Ç –º–∞—Ä–∂–∏:** `pnl_percent = (unrealized_pnl / margin_used) * 100` (—Å—Ç—Ä–æ–∫–∞ 344)

### ‚úÖ –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ entry_price –∏–ª–∏ margin?
**–û—Ç –º–∞—Ä–∂–∏** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1), fallback –Ω–∞ `entry_price` –µ—Å–ª–∏ –º–∞—Ä–∂–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

### ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ leverage?
**–î–ê** - –∫–æ—Å–≤–µ–Ω–Ω–æ, —á–µ—Ä–µ–∑ `margin_used` (–∫–æ—Ç–æ—Ä–∞—è —É–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç leverage: `margin = notional / leverage`)

---

## 5Ô∏è‚É£ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ú–ê–†–ñ–ò –ò –†–ò–°–ö–ê

### –ò–∑ `config/config_futures.yaml`:

**–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `scalping_config.margin_percent`: **–ù–µ—Ç** (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `max_margin_percent` –∏–∑ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
- `scalping_config.risk_per_trade`: **–ù–µ—Ç** (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `max_loss_per_trade_percent` –∏–∑ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
- `scalping_config.max_positions`: **5** (—Å—Ç—Ä–æ–∫–∞ 200)

**Balance Profiles (–¥–ª—è –±–∞–ª–∞–Ω—Å–∞ 500 USDT = "small"):**
```yaml
small:  # $500 - $1500
  threshold: 1500.0
  min_balance: 500.0
  size_at_min: 50.0
  size_at_max: 200.0
  base_position_usd: 100.0
  min_position_usd: 50.0
  max_position_usd: 250.0
  max_open_positions: 5
  max_position_percent: 25.0
```

**Adaptive Regime - Ranging:**
```yaml
ranging:
  tp_percent: 2.0
  sl_percent: 2.0
  max_holding_minutes: 20
```

**Symbol Profiles (per-symbol –ø–∞—Ä–∞–º–µ—Ç—Ä—ã):**
```yaml
symbol_profiles:
  BTC-USDT:
    ranging:
      tp_percent: 5.0
      sl_percent: 2.0
  SOL-USDT:
    ranging:
      tp_percent: 3.5  # (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ, –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
  ETH-USDT:
    ranging:
      tp_percent: 3.5  # (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ, –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
  XRP-USDT:
    ranging:
      tp_percent: 3.0  # (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ, –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
```

**–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∏—Å–∫–∞ (–∏–∑ –∫–æ–¥–∞):**
- `max_margin_percent`: 80.0% (–∏–∑ `adaptive_risk_params`)
- `max_loss_per_trade_percent`: 2.0% (–∏–∑ `adaptive_risk_params`)
- `max_margin_safety_percent`: 90.0% (–∏–∑ `adaptive_risk_params`)

---

## 6Ô∏è‚É£ –ü–†–ò–ú–ï–† –†–ê–°–ß–ï–¢–ê –ú–ê–†–ñ–ò –í RANGING-–†–ï–ñ–ò–ú–ï

### –î–æ–ø—É—Å—Ç–∏–º:
- **–ë–∞–ª–∞–Ω—Å:** 500 USDT
- **Leverage:** 5x (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
- **Price:** 136.8 USDT (SOL-USDT)
- **Risk:** 2% (max_loss_per_trade_percent)
- **Balance Profile:** small
- **Regime:** ranging

### –†–∞—Å—á–µ—Ç:

**1. –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä (notional):**
```
base_position_usd = 100.0 USDT (–∏–∑ small profile)
```

**2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ strength_multiplier (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º strength=1.0 ‚Üí multiplier=1.0):**
```
base_usd_size = 100.0 * 1.0 = 100.0 USDT
```

**3. –†–∞—Å—á–µ—Ç –º–∞—Ä–∂–∏:**
```
margin_required_initial = 100.0 / 5 = 20.0 USDT
```

**4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
```
max_margin_allowed = 500 * 0.8 = 400.0 USDT
available_margin = 500 - used_margin (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º 0) = 500.0 USDT
max_loss_usd = 500 * 0.02 = 10.0 USDT
sl_percent = 2.0% = 0.02
max_safe_margin = 10.0 / 0.02 = 500.0 USDT
max_margin_safety = 500 * 0.9 = 450.0 USDT
```

**5. –§–∏–Ω–∞–ª—å–Ω–∞—è –º–∞—Ä–∂–∞:**
```
margin_usd = max(50.0/5, min(20.0, 250.0/5)) = max(10.0, min(20.0, 50.0)) = 20.0 USDT
```

**6. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç:**
```
position_size = (20.0 * 5) / 136.8 = 100.0 / 136.8 = 0.730 SOL
```

**7. –ö–∞–∫–æ–π % –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –¥–∞—Å—Ç +2% –∫ –º–∞—Ä–∂–µ (TP)?**
```
TP = 2.0% –æ—Ç –º–∞—Ä–∂–∏
–î–ª—è LONG: price_change = entry_price * (TP / leverage) = 136.8 * (0.02 / 5) = 136.8 * 0.004 = 0.5472 USDT
price_change_percent = 0.5472 / 136.8 * 100 = 0.4% –æ—Ç —Ü–µ–Ω—ã
```

**–û—Ç–≤–µ—Ç:** –î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è TP=2.0% –æ—Ç –º–∞—Ä–∂–∏ –ø—Ä–∏ leverage=5x –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –Ω–∞ **0.4%** (–¥–ª—è LONG: —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã—Ä–∞—Å—Ç–∏ –Ω–∞ 0.4%).

---

## 7Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –†–ï–ñ–ò–ú–ê –í –ú–û–ú–ï–ù–¢ –°–ò–ì–ù–ê–õ–ê

### ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö –∑–∞ 14:40-14:50 UTC

–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–∏—Ü–∏–π –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è, –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –¥–µ—Ç–∞–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –≤ –º–æ–º–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤.

### –ò–∑ –∫–æ–¥–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ (`regime_manager.py`):

**RANGING –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –µ—Å–ª–∏:**
- `range_width < 3.0` (—É–∑–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω)
- `trend_dev < trend_strength_percent` (—Å–ª–∞–±—ã–π —Ç—Ä–µ–Ω–¥)
- `adx < 15.0` (ADX < ranging_adx_threshold)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è ranging:**
- `ranging_adx_threshold`: 15.0
- `trend_strength_percent`: (–Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)

---

## 8Ô∏è‚É£ –ë–´–õ–ò –õ–ò –°–ò–ì–ù–ê–õ–´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´ –ü–û–°–õ–ï –ü–†–û–•–û–ñ–î–ï–ù–ò–Ø –§–ò–õ–¨–¢–†–û–í?

### –ò–∑ `signals_2025-12-07.csv`:

**–ò—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã (executed=1) –≤ 14:40-14:50:**
- XRP-USDT, sell, 14:44:19, strength=1.0, filters_passed=–ø–æ–ª–Ω—ã–µ ‚Üí **executed=1**
- DOGE-USDT, sell, 14:44:26, strength=1.0, filters_passed=–ø–æ–ª–Ω—ã–µ ‚Üí **executed=1**
- SOL-USDT, buy, 14:44:56, strength=1.0, filters_passed=–ø–æ–ª–Ω—ã–µ ‚Üí **executed=1**
- BTC-USDT, sell, 14:45:30, strength=1.0, filters_passed=–ø–æ–ª–Ω—ã–µ ‚Üí **executed=1**

**–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã (executed=0) –≤ 14:40-14:50:**
- SOL-USDT, buy, 14:45:13-14:45:30 (–º–Ω–æ–∂–µ—Å—Ç–≤–æ), strength=1.0, filters_passed=–ø–æ–ª–Ω—ã–µ ‚Üí **executed=0**
- ETH-USDT, buy, 14:45:24-14:45:44 (–º–Ω–æ–∂–µ—Å—Ç–≤–æ), strength=1.0, filters_passed=–ø–æ–ª–Ω—ã–µ ‚Üí **executed=0**
- XRP-USDT, sell, 14:44:42-14:44:49 (–º–Ω–æ–∂–µ—Å—Ç–≤–æ), strength=1.0, filters_passed=–ø–æ–ª–Ω—ã–µ ‚Üí **executed=0**

### üîç –ü–æ—á–µ–º—É executed=0?

**–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–æ–π–¥–µ–Ω—ã** (`filters_passed` —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã), –Ω–æ —Å–∏–≥–Ω–∞–ª—ã –Ω–µ –∏—Å–ø–æ–ª–Ω–µ–Ω—ã. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–ü–û–°–õ–ï —Ñ–∏–ª—å—Ç—Ä–æ–≤**, –≤–æ–∑–º–æ–∂–Ω–æ –≤:
1. **Risk Manager** - –ª–∏–º–∏—Ç –ø–æ–∑–∏—Ü–∏–π (max_open_positions=5)
2. **Signal Coordinator** - cooldown (signal_cooldown_seconds=60.0)
3. **Order Executor** - —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∞—Ä–∂–∏, –ª–∏–º–∏—Ç—ã)

### ‚ö†Ô∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª:
**–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ª–æ–≥–∞—Ö** - –Ω—É–∂–Ω—ã –ª–æ–≥–∏ `risk_manager.log`, `signal_coordinator.log`, `order_executor.log` –∑–∞ –ø–µ—Ä–∏–æ–¥ 14:40-14:50 UTC, –Ω–æ –æ–Ω–∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤–µ.

---

## üìä –í–´–í–û–î–´

### ‚úÖ –ß—Ç–æ –Ω–∞–π–¥–µ–Ω–æ:

1. **PnL% —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - –æ—Ç –º–∞—Ä–∂–∏ (–Ω–µ –æ—Ç —Ü–µ–Ω—ã)
2. **–ú–∞—Ä–∂–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - —Å —É—á–µ—Ç–æ–º leverage, —Ä–µ–∂–∏–º–∞, –±–∞–ª–∞–Ω—Å–∞
3. **SL/TP –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - per-regime –∏ per-symbol –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

### ‚ùå –ü—Ä–æ–±–ª–µ–º—ã:

1. **SL –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª** - –ø–æ–∑–∏—Ü–∏–∏ —É–∂–µ –≥–ª—É–±–∂–µ —É—Ä–æ–≤–Ω—è SL (2.0%):
   - SOL-USDT: -19.34% (SL=2.0%)
   - BTC-USDT: -6.82% (SL=2.0%)
   - XRP-USDT: -11.46% (SL=2.0%)
   - ETH-USDT: -18.63% (SL=2.0%)

2. **–ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è** - –∫–æ–¥ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–µ—Ä–∂–∏—Ç —É–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (`action=hold, reason=max_holding_exceeded_but_loss`)

3. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤** - –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–æ–π–¥–µ–Ω—ã, –Ω–æ `executed=0` - –Ω—É–∂–Ω—ã –ª–æ–≥–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã

### üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —É–±—ã—Ç–∫–µ** (–∫–∞–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –ö–∏–º–µ —Ä–∞–Ω–µ–µ)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `risk_manager.log`, `signal_coordinator.log`, `order_executor.log`** –∑–∞ –ø–µ—Ä–∏–æ–¥ 14:40-14:50 UTC –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ—á–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø–æ–∑–∏—Ü–∏–π** - –≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–∑–∏—Ü–∏–∏ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–∞ –±–∏—Ä–∂–µ, –Ω–æ –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –±–æ—Ç–æ–º

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-12-07  
**–î–ª—è:** –ö–∏–º—ã  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã



