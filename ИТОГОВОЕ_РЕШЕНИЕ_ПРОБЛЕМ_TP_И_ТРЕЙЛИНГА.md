# ‚úÖ –ò–¢–û–ì–û–í–û–ï –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú TP –ò –¢–†–ï–ô–õ–ò–ù–ì –°–¢–û–ü-–õ–û–°–°

## üìã –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è entry price –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** Entry price –≤ trailing stop loss —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (—Ü–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞), –∞ —Ä–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞ –Ω–∞ –±–∏—Ä–∂–µ (avgPx) –æ—Ç–ª–∏—á–∞–ª–∞—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ (avgPx) —Å –±–∏—Ä–∂–∏
- –û–±–Ω–æ–≤–ª—è–µ–º entry_price –≤ active_positions
- –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º trailing stop loss —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π

**–ö–æ–¥:**
```python
# –í _execute_signal_from_price –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
# –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —Å –±–∏—Ä–∂–∏
positions = await self.client.get_positions()
for pos in positions:
    if pos.get("instId") == inst_id and abs(float(pos.get("pos", "0"))) > 0:
        real_entry_price = float(pos.get("avgPx", "0"))
        if real_entry_price > 0:
            # –û–±–Ω–æ–≤–ª—è–µ–º entry price
            self.active_positions[symbol]["entry_price"] = real_entry_price
            # –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º trailing stop loss
            tsl.initialize(real_entry_price, side)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Entry price —Ç–µ–ø–µ—Ä—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –±–∏—Ä–∂–µ–π

---

### 2. ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –Ω–∞–¥ TP

**–ü—Ä–æ–±–ª–µ–º–∞:** TP —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª —Ä–∞–Ω—å—à–µ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å, –Ω–µ –¥–∞–≤–∞—è —Ç—Ä–µ–π–ª–∏–Ω–≥—É —Å—Ä–∞–±–æ—Ç–∞—Ç—å.

**–†–µ—à–µ–Ω–∏–µ:**
- –ï—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω (–ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–∏–±—ã–ª–∏ –∏ –¥–æ—Å—Ç–∏–≥ min_profit_to_close), —Ç–æ TP –æ—Ç–∫–ª—é—á–µ–Ω
- –¢—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
- TP —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –ü–ï–†–ï–î TP
2. –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–∏–±—ã–ª–∏ –∏ –¥–æ—Å—Ç–∏–≥ min_profit_to_close ‚Üí —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω ‚Üí TP –æ—Ç–∫–ª—é—á–µ–Ω
3. –ï—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º TP

**–ö–æ–¥:**
```python
# –í _check_tp_only
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –ü–ï–†–ï–î TP
if symbol in self.orchestrator.trailing_sl_by_symbol:
    tsl = self.orchestrator.trailing_sl_by_symbol[symbol]
    profit_pct_net = tsl.get_profit_pct(current_price, include_fees=True)
    min_profit_to_close = tsl.min_profit_to_close
    
    # –ï—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω - TP –æ—Ç–∫–ª—é—á–µ–Ω
    if profit_pct_net > 0 and min_profit_to_close and profit_pct_net >= min_profit_to_close:
        logger.debug(f"üìä {symbol} —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω, TP –æ—Ç–∫–ª—é—á–µ–Ω")
        return  # –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º TP
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –¢—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ TP

---

### 3. ‚úÖ TP –≤—ã—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å

**–ü—Ä–æ–±–ª–µ–º–∞:** TP –±—ã–ª –Ω–∏–∂–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç.

**–†–µ—à–µ–Ω–∏–µ:**
- TP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—à–µ min_profit_to_close + –∫–æ–º–∏—Å—Å–∏—è + buffer (0.1%)
- –ï—Å–ª–∏ TP —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π, –ø–æ–¥–Ω–∏–º–∞–µ–º –µ–≥–æ –¥–æ –º–∏–Ω–∏–º—É–º–∞

**–§–æ—Ä–º—É–ª–∞:**
```
TP_min = min_profit_to_close + commission_rate + buffer (0.1%)
TP = max(TP_config, TP_min)
```

**–ü—Ä–∏–º–µ—Ä:**
- min_profit_to_close = 0.1% (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ ranging)
- commission_rate = 0.09% (–Ω–∞ –∫—Ä—É–≥)
- buffer = 0.1% (–∑–∞–ø–∞—Å)
- TP_min = 0.1% + 0.09% + 0.1% = 0.29%
- TP_config = 1.0% (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
- TP = max(1.0%, 0.29%) = 1.0% ‚úÖ

**–ö–æ–¥:**
```python
# –í _check_tp_only
if not trailing_sl_active and min_profit_to_close is not None and pnl_percent > 0:
    min_profit_to_close_pct = min_profit_to_close * 100
    commission_pct = commission_rate * 100
    buffer_pct = 0.1
    min_tp_percent = min_profit_to_close_pct + commission_pct + buffer_pct
    
    if tp_percent < min_tp_percent:
        tp_percent = min_tp_percent  # –ü–æ–¥–Ω–∏–º–∞–µ–º TP –¥–æ –º–∏–Ω–∏–º—É–º–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ TP —Ç–µ–ø–µ—Ä—å –≤—ã—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å

---

### 4. ‚úÖ –£—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –≤ TP

**–ü—Ä–æ–±–ª–µ–º–∞:** TP —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª—Å—è –±–µ–∑ —É—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —É–±—ã—Ç–∫–∞–º –Ω–∞ –±–∏—Ä–∂–µ.

**–†–µ—à–µ–Ω–∏–µ:**
- –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ TP (0.09% –Ω–∞ –∫—Ä—É–≥)
- TP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã—Å–æ–∫–∏–º, —á—Ç–æ–±—ã –ø–æ–∫—Ä—ã—Ç—å –∫–æ–º–∏—Å—Å–∏—é –∏ –¥–∞—Ç—å –ø—Ä–∏–±—ã–ª—å
- –ü—Ä–æ–≤–µ—Ä—è–µ–º net PnL (–ø–æ—Å–ª–µ –∫–æ–º–∏—Å—Å–∏–∏) –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ TP

**–ö–æ–¥:**
```python
# –í _check_tp_only
commission_rate = 0.0009  # 0.09% –Ω–∞ –∫—Ä—É–≥
tp_percent_with_commission = tp_percent + (commission_rate * 100)

if pnl_percent >= tp_percent_with_commission:
    net_pnl_percent = pnl_percent - (commission_rate * 100)
    if net_pnl_percent > 0:
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ TP —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ net –ø—Ä–∏–±—ã–ª—å > 0
        await self._close_position_by_reason(position, "tp")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ö–æ–º–∏—Å—Å–∏—è —Ç–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ TP

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´

### –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–¢—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π)**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ `_update_trailing_stop_loss`
   - –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–∏–±—ã–ª–∏ –∏ –¥–æ—Å—Ç–∏–≥ min_profit_to_close ‚Üí —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω
   - –ï—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å —Å—Ä–∞–±–æ—Ç–∞–ª ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å

2. **TP (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω)**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ `_check_tp_only`
   - –ï—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω ‚Üí TP –æ—Ç–∫–ª—é—á–µ–Ω (return)
   - –ï—Å–ª–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º TP
   - TP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—à–µ min_profit_to_close + –∫–æ–º–∏—Å—Å–∏—è + buffer
   - –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ TP

3. **Loss cut (–¥–ª—è —É–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π)**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å
   - –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤ —É–±—ã—Ç–∫–µ ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ–º loss cut

### –§–æ—Ä–º—É–ª—ã:

**TP_min:**
```
TP_min = min_profit_to_close + commission_rate + buffer
TP_min = 0.1% + 0.09% + 0.1% = 0.29%
```

**TP_final:**
```
TP_final = max(TP_config, TP_min)
TP_final = max(1.0%, 0.29%) = 1.0%
```

**TP_with_commission:**
```
TP_with_commission = TP_final + commission_rate
TP_with_commission = 1.0% + 0.09% = 1.09%
```

**Net PnL:**
```
Net PnL = Gross PnL - commission_rate
Net PnL = 1.03% - 0.09% = 0.94%
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚ùå Entry price –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Ü–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞ –≤–º–µ—Å—Ç–æ avgPx)
- ‚ùå TP —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª —Ä–∞–Ω—å—à–µ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å
- ‚ùå TP –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª –∫–æ–º–∏—Å—Å–∏—é
- ‚ùå –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞–ª–∏—Å—å —Å —É–±—ã—Ç–∫–æ–º –Ω–∞ –±–∏—Ä–∂–µ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ Entry price —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –±–∏—Ä–∂–µ–π (avgPx)
- ‚úÖ –¢—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ TP
- ‚úÖ TP –≤—ã—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å
- ‚úÖ –ö–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ TP
- ‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —Å –ø—Ä–∏–±—ã–ª—å—é –Ω–∞ –±–∏—Ä–∂–µ

---

## üìã –ü–ê–†–ê–ú–ï–¢–†–´ –ò–ó –ö–û–ù–§–ò–ì–ê

### Trailing Stop Loss (ranging —Ä–µ–∂–∏–º):
- `min_profit_to_close: 0.001` (0.1% net)
- `min_holding_minutes: 0.5` (30 —Å–µ–∫—É–Ω–¥)
- `initial_trail: 0.005` (0.5%)

### TP (ranging —Ä–µ–∂–∏–º):
- `tp_percent: 1.0%` (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
- `TP_min: 0.29%` (min_profit + commission + buffer)
- `TP_final: 1.0%` (max(1.0%, 0.29%))
- `TP_with_commission: 1.09%` (TP + commission)

### –ö–æ–º–∏—Å—Å–∏—è:
- `commission_rate: 0.0009` (0.09% –Ω–∞ –∫—Ä—É–≥)

---

## üéØ –ò–¢–û–ì

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã! ‚úÖ**

1. ‚úÖ Entry price —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –±–∏—Ä–∂–µ–π
2. ‚úÖ –¢—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ TP
3. ‚úÖ TP –≤—ã—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å
4. ‚úÖ –ö–æ–º–∏—Å—Å–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ TP
5. ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –º–µ–∂–¥—É TP –∏ —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø-–ª–æ—Å—Å

**–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é! üöÄ**

