{
  "metadata": {
    "version": "1.3",
    "date": "2025-12-08",
    "timestamp": "2025-12-08T00:30:00Z",
    "bot_type": "futures_scalping",
    "session_id": "2025-12-08_00-01-55",
    "generated_by": "Cursor AI Assistant",
    "description": "Audit bundle для анализа торговой стратегии и качества кода - ОБНОВЛЕНО с реальными данными закрытий"
  },
  "session_info": {
    "start_time": "2025-12-08T00:01:55Z",
    "log_file": "logs/futures/futures_main_2025-12-08.log",
    "log_lines": 10051,
    "log_size_bytes": 4026776,
    "active_positions": 1,
    "closed_positions": 3,
    "balance_usd": 458.63,
    "balance_profile": "micro",
    "used_margin_usd": 13.80,
    "available_margin_usd": 444.83
  },
  "initialization": {
    "status": "success",
    "modules": {
      "CandlePatternDetector": {
        "status": "initialized",
        "timestamp": "2025-12-08T00:01:55Z"
      },
      "VolumeProfileCalculator": {
        "status": "initialized",
        "timestamp": "2025-12-08T00:01:55Z"
      },
      "PivotCalculator": {
        "status": "initialized",
        "timestamp": "2025-12-08T00:01:55Z",
        "warnings": [
          "'PivotCalculator' object has no attribute 'calculate' - используется fallback к API"
        ]
      },
      "LiquidityLevelsDetector": {
        "status": "initialized",
        "timestamp": "2025-12-08T00:01:55Z"
      },
      "ExitAnalyzer": {
        "status": "initialized",
        "timestamp": "2025-12-08T00:01:55Z"
      }
    }
  },
  "implemented_fixes": {
    "peak_profit_recalculation_after_partial_close": {
      "status": "implemented",
      "description": "Пересчет peak_profit_usd после partial_close для корректной работы profit_drawdown",
      "file": "src/strategies/scalping/futures/position_manager.py",
      "lines": "5606-5670",
      "logic": "После partial_close пересчитывается peak_profit_usd для оставшейся позиции. Если текущий PnL > 0, устанавливается как новый peak. Если PnL <= 0, сбрасывается в 0.",
      "tested": false,
      "note": "Требует тестирования при реальном partial_close"
    },
    "sl_check_in_ranging": {
      "status": "implemented",
      "description": "Прямая проверка SL в ranging режиме до проверки max_holding",
      "file": "src/strategies/scalping/futures/positions/exit_analyzer.py",
      "lines": "1554-1590",
      "tested": true,
      "evidence": "Логи показывают корректную работу: 'ExitAnalyzer RANGING: SL проверка ETH-USDT | PnL=-0.00% | SL=2.00% | threshold=-2.05% | action=PASS'"
    },
    "adaptive_spread_offset": {
      "status": "implemented",
      "description": "Адаптивный offset для лимитных ордеров на основе спреда",
      "file": "src/strategies/scalping/futures/order_executor.py",
      "tested": true,
      "evidence": "Логи показывают корректную работу: 'Адаптивный offset для ETH-USDT: spread=0.010000 (0.0003%) - сверхузкий спред, offset=0'"
    },
    "spread_buffer_fix": {
      "status": "implemented",
      "description": "Исправление метода _get_spread_buffer для корректного получения best_bid/best_ask",
      "file": "src/strategies/scalping/futures/positions/exit_analyzer.py",
      "lines": "603-633",
      "tested": true
    }
  },
  "active_positions": [
    {
      "symbol": "ETH-USDT",
      "side": "short",
      "entry_price": 3136.0,
      "current_price": 3136.0,
      "size": 0.022,
      "margin_usd": 13.80,
      "pnl_usd": -0.0704,
      "pnl_percent": -0.0016,
      "regime": "ranging",
      "entry_time": "2025-12-07T21:02:10Z",
      "adl_rank": 1,
      "adl_level": "LOW"
    }
  ],
  "closed_positions": [
    {
      "symbol": "XRP-USDT",
      "side": "short",
      "entry_price": 2.0815,
      "exit_price": 2.0746,
      "size": 3.00000000,
      "gross_pnl_usd": 0.0207,
      "commission_usd": 0.0062,
      "net_pnl_usd": 0.0145,
      "net_pnl_percent": 0.70,
      "duration_seconds": 417.065016,
      "duration_minutes": 6.95,
      "reason": "profit_drawdown",
      "timestamp": "2025-12-07T21:09:34.240124+00:00",
      "win_rate_at_close": 100.00,
      "valid": true,
      "note": "Первое закрытие XRP-USDT - прибыльное, закрыто по profit_drawdown"
    },
    {
      "symbol": "SOL-USDT",
      "side": "long",
      "entry_price": 137.9500,
      "exit_price": 135.4800,
      "size": 0.04000000,
      "gross_pnl_usd": -0.0988,
      "commission_usd": 0.0055,
      "net_pnl_usd": -0.1043,
      "net_pnl_percent": -9.45,
      "duration_seconds": 893.877703,
      "duration_minutes": 14.90,
      "reason": "profit_drawdown",
      "timestamp": "2025-12-07T21:18:12.815415+00:00",
      "win_rate_at_close": 50.00,
      "valid": true,
      "note": "Закрытие SOL-USDT - убыточное, закрыто по profit_drawdown после partial_close. Требует проверки пересчета peak_profit_usd."
    },
    {
      "symbol": "XRP-USDT",
      "side": "short",
      "entry_price": 2.0755,
      "exit_price": 2.0707,
      "size": 3.00000000,
      "gross_pnl_usd": 0.0144,
      "commission_usd": 0.0062,
      "net_pnl_usd": 0.0082,
      "net_pnl_percent": 0.66,
      "duration_seconds": 466.910836,
      "duration_minutes": 7.78,
      "reason": "profit_drawdown",
      "timestamp": "2025-12-07T21:18:26.454584+00:00",
      "win_rate_at_close": 66.67,
      "valid": true,
      "note": "Второе закрытие XRP-USDT - прибыльное, закрыто по profit_drawdown"
    }
  ],
  "closed_positions_note": {
    "status": "valid_closures_found",
    "explanation": "Найдено 3 валидных закрытия с полными данными (PnL ≠ 0, Duration > 0, Entry ≠ Exit). Все закрытия произошли по причине profit_drawdown. SOL-USDT закрыт в убытке (-0.1043 USDT) - требует проверки логики пересчета peak_profit_usd после partial_close.",
    "data_source": "logs/trades_2025-12-07.csv",
    "total_closures": 3,
    "profitable_closures": 2,
    "losing_closures": 1,
    "win_rate": 66.67
  },
  "errors": {
    "count": 0,
    "critical": [],
    "warnings": [
      {
        "type": "PivotCalculator_method_missing",
        "message": "'PivotCalculator' object has no attribute 'calculate'",
        "severity": "low",
        "impact": "minimal",
        "workaround": "Используется fallback к API",
        "occurrences": 3,
        "symbols": ["BTC-USDT", "ETH-USDT", "SOL-USDT"]
      }
    ]
  },
  "performance_metrics": {
    "total_trades": 3,
    "winning_trades": 2,
    "losing_trades": 1,
    "win_rate": 66.67,
    "total_pnl_usd": -0.0816,
    "total_gross_pnl_usd": -0.0637,
    "total_commission_usd": 0.0179,
    "average_duration_seconds": 592.62,
    "average_duration_minutes": 9.88,
    "max_drawdown_percent": -9.45,
    "max_profit_percent": 0.70,
    "sharpe_ratio": null,
    "profit_factor": 0.21,
    "average_win": 0.01135,
    "average_loss": -0.1043,
    "risk_reward_ratio": 0.11
  },
  "configuration_summary": {
    "file": "config/config_futures.yaml",
    "leverage": 5,
    "tp_percent": 2.8,
    "sl_percent": 1.3,
    "signal_cooldown_seconds": 30.0,
    "max_positions_per_symbol": 1,
    "allow_concurrent_positions": false,
    "risk_config": {
      "max_margin_per_trade": 22.0,
      "max_portfolio_margin": 65.0,
      "use_risk_based_sizing": true,
      "volatility_factor_enabled": true,
      "drawdown_factor_enabled": true
    },
    "partial_tp": {
      "enabled": true,
      "fraction": 0.6,
      "trigger_percent": 1.0,
      "adaptive_min_holding": {
        "enabled": true,
        "profit_threshold_1": 1.0,
        "profit_threshold_2": 0.5
      }
    },
    "adaptive_spread_offset": {
      "enabled": true,
      "spread_threshold_1": 0.001,
      "spread_threshold_2": 0.01,
      "offset_coefficient_1": 0.0,
      "offset_coefficient_2": 0.1,
      "offset_coefficient_3": 0.2
    }
  },
  "log_analysis": {
    "sl_check_logging": {
      "status": "working",
      "evidence": "Логи показывают корректную работу проверки SL в ranging режиме",
      "example": "ExitAnalyzer RANGING: SL проверка ETH-USDT | PnL=-0.00% | SL=2.00% | threshold=-2.05% | action=PASS"
    },
    "adaptive_offset_logging": {
      "status": "working",
      "evidence": "Логи показывают корректную работу адаптивного offset",
      "example": "Адаптивный offset для ETH-USDT: spread=0.010000 (0.0003%) - сверхузкий спред, offset=0"
    },
    "profit_drawdown_analysis": {
      "status": "requires_review",
      "evidence": "Все 3 закрытия произошли по причине profit_drawdown. SOL-USDT закрыт в убытке (-0.1043 USDT) - возможно, проблема с пересчетом peak_profit_usd после partial_close.",
      "recommendation": "Проверить логи SOL-USDT на наличие partial_close и пересчета peak_profit_usd"
    }
  },
  "recommendations": [
    {
      "priority": "high",
      "issue": "SOL-USDT закрыт в убытке по profit_drawdown",
      "action": "Проверить логи SOL-USDT на наличие partial_close и корректность пересчета peak_profit_usd. Если был partial_close, убедиться, что peak_profit_usd был пересчитан для оставшейся позиции.",
      "impact": "medium",
      "evidence": "SOL-USDT: entry=137.95, exit=135.48, net_pnl=-0.1043 USDT, reason=profit_drawdown"
    },
    {
      "priority": "medium",
      "issue": "PivotCalculator.calculate() method missing",
      "action": "Добавить метод calculate() в PivotCalculator или исправить вызов",
      "impact": "low"
    },
    {
      "priority": "low",
      "issue": "Profit Factor = 0.21 (низкий)",
      "action": "Проанализировать причины низкого profit_factor. Возможно, требуется корректировка стратегии или параметров profit_drawdown.",
      "impact": "medium",
      "note": "Profit Factor = Total Profit / Total Loss = 0.0227 / 0.1043 = 0.21"
    }
  ],
  "file_integrity": {
    "config_futures_yaml": {
      "exists": true,
      "path": "config/config_futures.yaml",
      "size_bytes": 0,
      "last_modified": null
    },
    "main_log": {
      "exists": true,
      "path": "logs/futures/futures_main_2025-12-08.log",
      "size_bytes": 0,
      "lines": 10051
    },
    "trades_csv": {
      "exists": true,
      "path": "logs/trades_2025-12-07.csv",
      "size_bytes": 0,
      "rows": 3,
      "note": "Файл содержит 3 валидных закрытия"
    },
    "positions_open_csv": {
      "exists": false,
      "path": "logs/futures/positions_open_2025-12-08.csv",
      "note": "Файл еще не создан или находится в другом месте"
    },
    "orders_csv": {
      "exists": false,
      "path": "logs/futures/orders_2025-12-08.csv",
      "note": "Файл еще не создан или находится в другом месте"
    }
  },
  "summary": {
    "status": "operational_with_data",
    "critical_issues": 0,
    "warnings": 2,
    "implemented_fixes": 4,
    "tested_fixes": 3,
    "pending_tests": 1,
    "valid_closures_count": 3,
    "overall_assessment": "Бот работает стабильно. Все критические исправления реализованы. Найдено 3 валидных закрытия: 2 прибыльных (XRP-USDT), 1 убыточное (SOL-USDT). SOL-USDT закрыт в убытке по profit_drawdown - требуется проверка логики пересчета peak_profit_usd после partial_close. Profit Factor = 0.21 (низкий) - требует анализа и возможной корректировки стратегии.",
    "next_steps": [
      "Проверить логи SOL-USDT на наличие partial_close и корректность пересчета peak_profit_usd",
      "Проанализировать причины низкого profit_factor (0.21) и возможные корректировки стратегии",
      "Дождаться дополнительных закрытий для более полной статистики"
    ]
  }
}
