# üîç –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

## 1. trading_control_center.py (—Å—Ç—Ä–æ–∫–∞ ~258)

```python
# src/strategies/scalping/futures/core/trading_control_center.py

# –°—Ç—Ä–æ–∫–∏ 15-20: –ò–º–ø–æ—Ä—Ç—ã
import asyncio
import os
import time
from datetime import datetime as dt  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ dt
from datetime import timezone
from typing import Any, Dict, Optional

# –°—Ç—Ä–æ–∫–∏ 250-265: run_main_loop - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
async def run_main_loop(self):
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª"""
    while self.is_running:
        try:
            # ... –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ...
            await asyncio.sleep(self.scalping_config.check_interval)
        
        except asyncio.CancelledError:
            logger.info("üõë TCC: –¢–æ—Ä–≥–æ–≤—ã–π —Ü–∏–∫–ª –æ—Ç–º–µ–Ω–µ–Ω")
            break
        except Exception as e:
            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–ª–Ω—ã–º traceback
            logger.error(
                f"‚ùå TCC: –û—à–∏–±–∫–∞ –≤ —Ç–æ—Ä–≥–æ–≤–æ–º —Ü–∏–∫–ª–µ: {e}",
                exc_info=True,  # –ü–æ–ª–Ω—ã–π traceback –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            )
            if self.is_running:
                await asyncio.sleep(5)  # –ü–∞—É–∑–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            else:
                break
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í —ç—Ç–æ–º —Ñ–∞–π–ª–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `dt` –≤–º–µ—Å—Ç–æ `datetime`, –ø–æ—ç—Ç–æ–º—É –æ—à–∏–±–æ–∫ datetime –∑–¥–µ—Å—å –Ω–µ—Ç.

---

## 2. position_manager.py (—Å—Ç—Ä–æ–∫–∞ ~5797: close_position_manually)

```python
# src/strategies/scalping/futures/position_manager.py

# –°—Ç—Ä–æ–∫–∏ 15-16: –ò–º–ø–æ—Ä—Ç—ã
from datetime import datetime, timezone

# –°—Ç—Ä–æ–∫–∏ 5761-5808: close_position_manually
async def close_position_manually(
    self, symbol: str, reason: str = "manual"
) -> Optional[TradeResult]:
    """‚úÖ –†–£–ß–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –ü–û–ó–ò–¶–ò–ò (–¥–ª—è TrailingSL)"""
    
    async with self._close_lock:
        try:
            # ... –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ...
            
            entry_time = None
            if position:
                if hasattr(position, "entry_time"):
                    entry_time = position.entry_time
                elif isinstance(position, dict):
                    entry_time = position.get("entry_time")
                elif hasattr(position, "metadata"):
                    metadata = position.metadata
                    if hasattr(metadata, "entry_time"):
                        entry_time = metadata.entry_time
            
            if entry_time:
                # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç datetime, –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–π
                exit_time = datetime.now(timezone.utc)  # ‚úÖ –ë–´–õ–û: from datetime import datetime, timezone
                if isinstance(entry_time, str):
                    entry_time = datetime.fromisoformat(entry_time.replace("Z", "+00:00"))
                if isinstance(entry_time, datetime):
                    if entry_time.tzinfo is None:
                        entry_time = entry_time.replace(tzinfo=timezone.utc)
                    duration_sec = (exit_time - entry_time).total_seconds()
                    if duration_sec < 30:  # –ú–∏–Ω–∏–º—É–º 30 —Å–µ–∫
                        logger.warning(f"‚ö†Ô∏è Too fast close: {symbol}, {duration_sec:.1f}s < 30s")
                        return None
```

**‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:** –£–¥–∞–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç `from datetime import datetime, timezone` –Ω–∞ —Å—Ç—Ä–æ–∫–µ 5795 (—Ç–µ–ø–µ—Ä—å 5798)

---

## 3. position_manager.py (—Å—Ç—Ä–æ–∫–∞ ~1266: datetime.now() –±–µ–∑ timezone)

```python
# src/strategies/scalping/futures/position_manager.py

# –°—Ç—Ä–æ–∫–∏ 1262-1276: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ datetime.now()
time_since_open = 0.0
if position_open_time:
    if isinstance(position_open_time, datetime):
        # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º timezone.utc –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
        if position_open_time.tzinfo is None:
            position_open_time = position_open_time.replace(tzinfo=timezone.utc)
        time_since_open = (
            datetime.now(timezone.utc) - position_open_time  # ‚úÖ –ë–´–õ–û: datetime.now()
        ).total_seconds()
    else:
        try:
            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º timezone.utc
            time_since_open = (
                datetime.now(timezone.utc)
                - datetime.fromtimestamp(
                    float(position_open_time), tz=timezone.utc
                )
            ).total_seconds()
```

**‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:** –í—Å–µ `datetime.now()` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `datetime.now(timezone.utc)`

---

## 4. orchestrator.py (—Å—Ç—Ä–æ–∫–∏ 405-419: ExitAnalyzer)

```python
# src/strategies/scalping/futures/orchestrator.py

# –°—Ç—Ä–æ–∫–∏ 405-414: –°–æ–∑–¥–∞–Ω–∏–µ ExitAnalyzer
self.exit_analyzer = ExitAnalyzer(
    position_registry=self.position_registry,
    data_registry=self.data_registry,
    exit_decision_logger=self.exit_decision_logger,
    orchestrator=self,
    config_manager=self.config_manager,
    signal_generator=self.signal_generator,
    signal_locks_ref=self.signal_locks,
)
logger.info("‚úÖ ExitAnalyzer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ orchestrator")

# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º ExitAnalyzer –≤ position_manager
if hasattr(self.position_manager, "set_exit_analyzer"):
    self.position_manager.set_exit_analyzer(self.exit_analyzer)
    logger.info("‚úÖ ExitAnalyzer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ FuturesPositionManager")
```

**‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:** –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `set_exit_analyzer()` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ExitAnalyzer

---

## 5. position_manager.py (—Å—Ç—Ä–æ–∫–∏ 116-119: set_exit_analyzer)

```python
# src/strategies/scalping/futures/position_manager.py

def set_exit_analyzer(self, exit_analyzer):
    """‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ExitAnalyzer –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∑–∏—Ü–∏–π"""
    self.exit_analyzer = exit_analyzer
    logger.info("‚úÖ ExitAnalyzer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ FuturesPositionManager")
```

**‚úÖ –î–û–ë–ê–í–õ–ï–ù–û:** –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ExitAnalyzer

---

## üìä –ò—Ç–æ–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. **–£–¥–∞–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç datetime** –≤ `close_position_manually()` (—Å—Ç—Ä–æ–∫–∞ 5798)
2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ 6 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `datetime.now()`** ‚Üí `datetime.now(timezone.utc)`
3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è timezone** –¥–ª—è `position_open_time`
4. **–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `set_exit_analyzer()`** –≤ `FuturesPositionManager`
5. **–î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `set_exit_analyzer()`** –≤ `orchestrator` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ExitAnalyzer

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ù–µ—Ç –æ—à–∏–±–æ–∫ "cannot access local variable 'datetime'"
- –í—Å–µ datetime –æ–±—ä–µ–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç timezone.utc
- ExitAnalyzer –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è

---

**–î–∞—Ç–∞:** 2025-12-23  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã





