# 🏗️ СХЕМА АРХИТЕКТУРНЫХ ИЗМЕНЕНИЙ - 26.12.2025

## 📊 ТЕКУЩАЯ АРХИТЕКТУРА (ПРОБЛЕМЫ)

```
orchestrator.py (4848 строк) - МОНСТР
├── Координация всего
├── Управление позициями
├── Генерация сигналов
└── Закрытие позиций

exit_analyzer.py (3641 строк) - МОНСТР
├── Анализ закрытия для TRENDING
├── Анализ закрытия для RANGING
├── Анализ закрытия для CHOPPY
├── Получение параметров (ConfigManager.get() ❌)
└── Получение ATR (async/sync конфликт ❌)

signal_generator.py (5193 строк) - МОНСТР
├── Генерация сигналов
├── Фильтрация
├── Конфликтные сигналы (снижение strength ❌)
└── Определение направления (нет единой системы ❌)

position_manager.py (7320 строк) - МОНСТР
├── Управление позициями
├── Emergency close
└── Синхронизация
```

---

## 🎯 НОВАЯ АРХИТЕКТУРА (РЕШЕНИЕ)

### 1. КООРДИНАЦИЯ ЗАКРЫТИЯ

**БЫЛО:**
```
ExitAnalyzer ──┐
SmartExit ─────┤──> Конфликты! ❌
TrailingSL ────┤
Emergency ─────┘
```

**СТАНЕТ:**
```
ExitDecisionCoordinator (НОВЫЙ)
├── ExitAnalyzer
├── SmartExitCoordinator
├── TrailingSLCoordinator
└── PriorityResolver (НОВЫЙ)
    └── Единая матрица приоритетов
```

**Файлы:**
- ✅ Создать: `coordinators/exit_decision_coordinator.py`
- ✅ Создать: `coordinators/priority_resolver.py`
- ✅ Изменить: `orchestrator.py` - использовать координатор

---

### 2. ОПРЕДЕЛЕНИЕ НАПРАВЛЕНИЯ

**БЫЛО:**
```
signal_generator.py
├── ADX показывает тренд
├── RSI показывает сигнал
├── MACD показывает сигнал
└── Конфликт! ❌ (снижение strength на 50%)
```

**СТАНЕТ:**
```
DirectionAnalyzer (НОВЫЙ)
├── Взвешенная система:
│   ├── ADX: 40% (приоритет)
│   ├── Trend Deviation: 20%
│   ├── RSI: 15%
│   ├── MACD: 15%
│   └── MA: 10%
└── Блокировка сигналов против направления

signal_generator.py
└── Использует DirectionAnalyzer
```

**Файлы:**
- ✅ Создать: `analysis/direction_analyzer.py`
- ✅ Изменить: `signal_generator.py` - использовать DirectionAnalyzer

---

### 3. ПАРАМЕТРЫ

**БЫЛО:**
```
Каждый модуль получает параметры по-своему:
├── ConfigManager.get() ❌ (не работает)
├── config.scalping.adaptive_regime
├── config.scalping.symbol_profiles
└── Конфликты приоритетов! ❌
```

**СТАНЕТ:**
```
ParameterProvider (НОВЫЙ)
├── Единая точка получения параметров
├── Приоритет: symbol+regime → symbol → regime → global
└── Методы:
    ├── get_parameters(symbol, regime)
    ├── get_sl_percent(symbol, regime)
    ├── get_tp_percent(symbol, regime)
    └── get_filter_params(symbol, regime)

Все модули используют ParameterProvider
```

**Файлы:**
- ✅ Создать: `config/parameter_provider.py`
- ✅ Изменить: все модули - использовать ParameterProvider

---

### 4. ИНДИКАТОРЫ

**БЫЛО:**
```
Разные периоды для разных модулей:
├── regime_manager: 20-50 свечей
├── signal_generator: 200 свечей
└── Конфликты! ❌
```

**СТАНЕТ:**
```
IndicatorCalculator (НОВЫЙ)
├── Стандартные периоды для всех
├── Кэширование результатов
└── Единая точка получения

ATRProvider (НОВЫЙ)
├── Синхронный доступ к ATR
└── Решает async/sync конфликт
```

**Файлы:**
- ✅ Создать: `indicators/indicator_calculator.py`
- ✅ Создать: `indicators/atr_provider.py`
- ✅ Изменить: `regime_manager.py`, `signal_generator.py` - использовать стандартные периоды

---

### 5. МЕТРИКИ

**БЫЛО:**
```
Нет метрик:
├── Неизвестно сколько сигналов блокируется
├── Неизвестно почему сигналы блокируются
└── Нет мониторинга показателей
```

**СТАНЕТ:**
```
metrics/
├── conversion_metrics.py (НОВЫЙ)
│   └── Сигналы → Позиции → TP/SL
├── holding_time_metrics.py (НОВЫЙ)
│   └── Время удержания
└── alert_manager.py (НОВЫЙ)
    └── Алерты на критические события
```

**Файлы:**
- ✅ Создать: `metrics/conversion_metrics.py`
- ✅ Создать: `metrics/holding_time_metrics.py`
- ✅ Создать: `metrics/alert_manager.py`

---

## 🔄 ПЕРЕНОС КОДА ИЗ БОЛЬШИХ ФАЙЛОВ

### Из exit_analyzer.py:

**Что перенести:**
- ❌ НЕ переносить (файл уже структурирован по режимам)
- ✅ Только исправить ошибки (ConfigManager.get(), ATR)

**Изменения:**
- Исправить строку 1222: ConfigManager.get()
- Исправить строки 730-772: ATR (использовать ATRProvider)

---

### Из signal_generator.py:

**Что перенести:**
- ✅ Логику определения направления → `DirectionAnalyzer`
- ✅ Логику блокировки конфликтных сигналов → `DirectionAnalyzer`

**Изменения:**
- Убрать строки 2351, 2473: снижение strength для конфликтов
- Использовать DirectionAnalyzer для проверки направления

---

### Из orchestrator.py:

**Что перенести:**
- ❌ НЕ переносить (координация - его ответственность)
- ✅ Только исправить datetime ошибку

**Изменения:**
- Исправить строку 2226: убрать локальный импорт datetime
- Интегрировать ExitDecisionCoordinator

---

## 📁 НОВАЯ СТРУКТУРА ПАПОК

```
src/strategies/scalping/futures/
├── analysis/                    # 🆕 НОВАЯ ПАПКА
│   └── direction_analyzer.py   # 🆕 Определение направления
│
├── coordinators/
│   ├── exit_decision_coordinator.py  # 🆕 Координация закрытия
│   ├── priority_resolver.py          # 🆕 Разрешение конфликтов
│   └── ... (существующие)
│
├── indicators/
│   ├── atr_provider.py         # 🆕 Синхронный доступ к ATR
│   ├── indicator_calculator.py # 🆕 Стандартизация индикаторов
│   └── ... (существующие)
│
├── config/
│   ├── parameter_provider.py   # 🆕 Единая точка параметров
│   └── ... (существующие)
│
└── metrics/                    # 🆕 НОВАЯ ПАПКА
    ├── conversion_metrics.py
    ├── holding_time_metrics.py
    └── alert_manager.py
```

---

## 🔗 ЗАВИСИМОСТИ МЕЖДУ МОДУЛЯМИ

```
ExitDecisionCoordinator
├── ExitAnalyzer
│   ├── ParameterProvider (для SL/TP)
│   ├── ATRProvider (для ATR-based расчетов)
│   └── ConfigManager (исправленный доступ)
│
├── SmartExitCoordinator
│   └── DataRegistry (индикаторы)
│
├── TrailingSLCoordinator
│   └── PositionRegistry
│
└── PriorityResolver
    └── Единая матрица приоритетов

SignalGenerator
├── DirectionAnalyzer
│   ├── DataRegistry (ADX, индикаторы)
│   └── IndicatorCalculator (стандартные периоды)
│
├── ParameterProvider (параметры фильтров)
└── FilterManager

RegimeManager
├── IndicatorCalculator (стандартные периоды)
└── DataRegistry
```

---

## ✅ ПРИНЦИПЫ РЕАЛИЗАЦИИ

1. **Минимальные изменения в существующих файлах**
   - Только исправление ошибок
   - Интеграция новых модулей
   - Не рефакторинг всего кода

2. **Новые модули в отдельных файлах**
   - Каждый модуль = один файл
   - Четкая ответственность
   - Легко тестировать

3. **Использование существующей структуры**
   - `coordinators/` - для координаторов
   - `indicators/` - для индикаторов
   - `config/` - для конфигурации
   - `positions/` - для управления позициями

4. **Постепенная интеграция**
   - Сначала создать новые модули
   - Потом интегрировать в существующие
   - Не ломать существующий код

---

## 📋 ПОРЯДОК РЕАЛИЗАЦИИ

### Фаза 1: Критические исправления (30-60 мин)
1. Исправить datetime в orchestrator.py
2. Исправить ConfigManager.get() в exit_analyzer.py
3. Создать ATRProvider для exit_analyzer.py
4. Добавить логирование блокировки сигналов

### Фаза 2: Emergency Loss Protection (1-2 часа)
1. Увеличить пороги
2. Добавить минимальное время удержания
3. Учитывать спред и комиссии

### Фаза 3: Координация закрытия (2-3 часа)
1. Создать PriorityResolver
2. Создать ExitDecisionCoordinator
3. Интегрировать в orchestrator

### Фаза 4: Определение режима и направления (4-6 часов)
1. Улучшить скоринг режимов
2. Создать DirectionAnalyzer
3. Интегрировать в signal_generator

### Фаза 5: Стандартизация (4-6 часов)
1. Создать IndicatorCalculator
2. Создать ParameterProvider
3. Интегрировать везде

### Фаза 6: Метрики (1-2 часа)
1. Создать метрики
2. Интегрировать мониторинг

---

**Дата создания:** 26.12.2025  
**Статус:** ⏳ ОЖИДАЕТ ПОДТВЕРЖДЕНИЯ



