# –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞

## üîç –¶–µ–ø–æ—á–∫–∞ —Ä–∞—Å—á–µ—Ç–æ–≤:

### 1. –†–ê–°–ß–ï–¢ –†–ê–ó–ú–ï–†–ê –ü–û–ó–ò–¶–ò–ò (`_calculate_position_size`)

#### –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –±–∞–ª–∞–Ω—Å–∞
```
–ë–∞–ª–∞–Ω—Å: $1000 ‚Üí Profile: small
  - base_position_usd: $150
  - min_position_usd: $120
  - max_position_usd: $200
```

#### –®–∞–≥ 2: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–µ–∂–∏–º —Ä—ã–Ω–∫–∞ (ARM)
```
–ï—Å–ª–∏ —Ä–µ–∂–∏–º = "trending":
  - position_size_multiplier = 1.2
  - base_usd_size = 150 √ó 1.2 = $180
```

#### –®–∞–≥ 3: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Å–∏–ª—É —Å–∏–≥–Ω–∞–ª–∞
```
–ï—Å–ª–∏ strength = 0.8 (—Å–∏–ª—å–Ω—ã–π):
  - strength_multiplier = 1.5
  - base_usd_size = 180 √ó 1.5 = $270
  - ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ü—Ä–µ–≤—ã—à–∞–µ—Ç max_usd_size = $200!
  - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: base_usd_size = min(270, 200) = $200
```

#### –®–∞–≥ 4: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ leverage
```
leverage = 3x
margin_required = $200 (–º–∞—Ä–∂–∞)
notional = $200 √ó 3 = $600 (–Ω–æ–º–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å)
```

#### –®–∞–≥ 5: –ó–∞—â–∏—Ç—ã
```
1. Max Margin Used (80%): –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ 80% –±–∞–ª–∞–Ω—Å–∞
2. Max Loss per Trade (2%): –ø—Ä–æ–≤–µ—Ä—è–µ–º max_loss / sl_percent
3. 90% –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ –±–æ–ª—å—à–µ 90% –±–∞–ª–∞–Ω—Å–∞
4. –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: margin_usd = max(min, min(required, max))
```

#### –®–∞–≥ 6: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –º–æ–Ω–µ—Ç—ã
```
position_size = (margin_usd * leverage) / price
–ü—Ä–∏–º–µ—Ä: ($200 √ó 3) / $110,000 = 0.0054545 BTC
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û**: `position_size` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ **–ú–û–ù–ï–¢–ê–•** (BTC/ETH)

---

### 2. –û–¢–ö–†–´–¢–ò–ï –ü–û–ó–ò–¶–ò–ò (`place_futures_order`)

#### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
```
–î–ª—è BTC-USDT:
  - ctVal = 0.01 (1 –∫–æ–Ω—Ç—Ä–∞–∫—Ç = 0.01 BTC)
  - lotSz = 0.01 (—à–∞–≥ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è)
  - minSz = 0.01 (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä)
```

#### –®–∞–≥ 2: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–æ–Ω–µ—Ç ‚Üí –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
```
size (–º–æ–Ω–µ—Ç—ã) = 0.0054545 BTC
size_in_contracts = 0.0054545 / 0.01 = 0.54545 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
```

#### –®–∞–≥ 3: –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ lotSz
```
rounded_size = round_to_step(0.54545, 0.01) = 0.54 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
```

#### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º—É–º–∞
```
if rounded_size < minSz (0.01):
  rounded_size = minSz
```

#### –®–∞–≥ 5: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
```
formatted_size = "0.54" (—Å—Ç—Ä–æ–∫–∞ –¥–ª—è API)
API –ø–æ–ª—É—á–∞–µ—Ç: sz = "0.54" –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑–º–µ—Ä –≤ **–ö–û–ù–¢–†–ê–ö–¢–ê–•**

---

### 3. –†–ê–°–ß–ï–¢ MARGIN_USED (–≤ orchestrator –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è)

#### ‚ö†Ô∏è –û–®–ò–ë–ö–ê –í –°–¢–†–û–ö–ï 712:
```python
# –ë–´–õ–û:
margin_used = position_size * price / 3  # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!

# –ü–†–û–ë–õ–ï–ú–ê:
# position_size = 0.0054545 BTC (–≤ –º–æ–Ω–µ—Ç–∞—Ö)
# position_size * price = 0.0054545 √ó $110,000 = $600 (notional)
# margin_used = $600 / 3 = $200 ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!

# –ù–û! –ú—ã —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–ª–∏ margin_usd = $200 –≤ _calculate_position_size!
# –î—É–±–ª–∏—Ä—É–µ–º —Ä–∞—Å—á–µ—Ç, –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∏–∑-–∑–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è!
```

#### ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:
```python
# –ù–£–ñ–ù–û –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ margin_usd –Ω–∞–ø—Ä—è–º—É—é –∏–∑ _calculate_position_size!
# –ò–ª–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
margin_used = (position_size * price) / leverage
# –ù–æ –ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å margin_usd –∫–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞
```

---

### 4. –†–ê–°–ß–ï–¢ PnL (`_update_position_stats`)

#### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
```
size = 0.54 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (–∏–∑ API)
entry_price = $110,500
current_price = $110,600
side = "long"
```

#### –®–∞–≥ 2: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã ‚Üí –º–æ–Ω–µ—Ç—ã
```
ctVal = 0.01
size_in_coins = 0.54 √ó 0.01 = 0.0054 BTC
```

#### –®–∞–≥ 3: –†–∞—Å—á–µ—Ç PnL
```
–î–ª—è LONG:
pnl = (current_price - entry_price) √ó size_in_coins
pnl = ($110,600 - $110,500) √ó 0.0054 = $100 √ó 0.0054 = $0.54
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û**: PnL —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –º–æ–Ω–µ—Ç—ã

---

### 5. –ó–ê–ö–†–´–¢–ò–ï –ü–û–ó–ò–¶–ò–ò (`close_position_manually`)

#### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–∏
```
positions = await client.get_positions(symbol)
position = positions[0]  # –¥–ª—è BTC
size = 0.54 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (–∏–∑ API)
```

#### –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–≥–æ –æ—Ä–¥–µ—Ä–∞
```
place_futures_order(
  symbol="BTC-USDT",
  side="sell",  # –∑–∞–∫—Ä—ã–≤–∞–µ–º long
  size=0.54,  # –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
  size_in_contracts=True,  # ‚úÖ –£–ñ–ï –í –ö–û–ù–¢–†–ê–ö–¢–ê–•!
  reduceOnly=True
)
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û**: –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `size_in_contracts=True`

---

## üêõ –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:

### 1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ margin_used (–°—Ç—Ä–æ–∫–∞ 712)**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
margin_used = position_size * price / 3  # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ, —á—Ç–æ —É–∂–µ –∑–Ω–∞–µ–º
```

**–ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞:**
- –ú—ã —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–ª–∏ `margin_usd` –≤ `_calculate_position_size`
- –ò–∑-–∑–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç ‚Üí –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã ‚Üí –º–æ–Ω–µ—Ç—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ
- –ù–∞–ø—Ä–∏–º–µ—Ä:
  - –†–∞—Å—Å—á–∏—Ç–∞–ª–∏: `margin_usd = $200`, `position_size = 0.0054545 BTC`
  - –û–∫—Ä—É–≥–ª–∏–ª–∏: `0.54 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ = 0.0054 BTC`
  - –ü–µ—Ä–µ—Å—á–∏—Ç–∞–ª–∏: `0.0054 √ó $110,000 / 3 = $198` ‚ùå (—Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ $2!)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –°–æ—Ö—Ä–∞–Ω—è—Ç—å margin_usd –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é
margin_usd = await self._calculate_position_size(balance, price, signal, return_margin=True)
# –ò–ª–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
margin_used = (position_size * price) / leverage
```

### 2. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: position_size –≤ –º–æ–Ω–µ—Ç–∞—Ö, –Ω–æ margin_used –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `_calculate_position_size` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –≤ **–º–æ–Ω–µ—Ç–∞—Ö**
- –ù–æ –∑–∞—Ç–µ–º –º—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º margin –∏–∑ —Ä–∞–∑–º–µ—Ä–∞ –≤ –º–æ–Ω–µ—Ç–∞—Ö
- –≠—Ç–æ –º–æ–∂–µ—Ç –¥–∞—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∏–∑-–∑–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
- –õ–∏–±–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `(position_size, margin_usd)` –∫–æ—Ä—Ç–µ–∂
- –õ–∏–±–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ: `margin = (size_in_coins √ó price) / leverage`

### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏**

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –û—Ç–∫—Ä—ã—Ç–∏–µ:
position_size = 0.0054545 BTC (–º–æ–Ω–µ—Ç—ã)
‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: 0.0054545 / 0.01 = 0.54545 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
‚Üí –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ: 0.54 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞: sz = "0.54"

# –ó–∞–∫—Ä—ã—Ç–∏–µ:
size = 0.54 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (–∏–∑ API)
‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞: sz = "0.54", size_in_contracts=True
```

**‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ**: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ `base_usd_size` –ø–æ—Å–ª–µ multiplier
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ (Maker)
3. ‚ö†Ô∏è –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨: —Ä–∞—Å—á–µ—Ç `margin_used` –≤ orchestrator (—Å—Ç—Ä–æ–∫–∞ 712)

---

## üìä –ü–†–ò–ú–ï–† –ü–û–õ–ù–û–ì–û –†–ê–°–ß–ï–¢–ê:

### –£—Å–ª–æ–≤–∏—è:
- –ë–∞–ª–∞–Ω—Å: $1000
- Profile: small (min=$120, base=$150, max=$200)
- –†–µ–∂–∏–º: trending (multiplier=1.2)
- –°–∏–≥–Ω–∞–ª: strength=0.8 (multiplier=1.5)
- –¶–µ–Ω–∞ BTC: $110,000
- Leverage: 3x

### –†–∞—Å—á–µ—Ç:
```
1. base_usd_size = $150
2. √ó regime_multiplier (1.2) = $180
3. √ó strength_multiplier (1.5) = $270
4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ max: min($270, $200) = $200 ‚úÖ
5. margin_usd = $200
6. notional = $200 √ó 3 = $600
7. position_size = ($200 √ó 3) / $110,000 = 0.0054545 BTC
8. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: 0.0054545 / 0.01 = 0.54545 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
9. –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ: 0.54 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
10. –û—Ç–ø—Ä–∞–≤–∫–∞: sz = "0.54"
```

### –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è:
```
margin_used = 0.0054545 √ó $110,000 / 3 = $200 ‚úÖ
// –ù–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π margin_usd = $200
```

### PnL –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –Ω–∞ $110,600:
```
size_in_coins = 0.54 √ó 0.01 = 0.0054 BTC
pnl = ($110,600 - $110,500) √ó 0.0054 = $0.54
```

### –ö–æ–º–∏—Å—Å–∏—è (Maker 0.04%):
```
notional = 0.0054 √ó $110,500 = $596.7
commission = $596.7 √ó 0.0004 = $0.24
–ß–∏—Å—Ç—ã–π PnL = $0.54 - $0.24 = $0.30 ‚úÖ
```

---

## üéØ –ò–¢–û–ì:

1. ‚úÖ –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
2. ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–æ–Ω–µ—Ç—ã ‚Üí –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
3. ‚úÖ –†–∞—Å—á–µ—Ç PnL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å —É—á–µ—Ç–æ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏)
4. ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ (size_in_contracts=True)
5. ‚ö†Ô∏è –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨: margin_used –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è

