# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º –∏–∑ –ª–æ–≥–æ–≤ 2026-01-04 14:37-47

## –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 2026-01-04

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå MarginMonitor: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å

**–û—à–∏–±–∫–∞:**
```
2026-01-04 14:34:49.446 | ERROR | MarginMonitor:check_safety:135 | ‚ùå MarginMonitor: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å, –ø–æ–∑–∏—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–π
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–í `MarginMonitor.check_safety()` –∫–æ–¥ –∏—Å–∫–∞–ª –±–∞–ª–∞–Ω—Å –ø–æ –∫–ª—é—á–∞–º `"equity"` –∏–ª–∏ `"total"`, –Ω–æ `DataRegistry.get_balance()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–æ–º `"balance"`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë–´–õ–û:
current_balance = balance_data.get("equity", balance_data.get("total", 0.0))

# –°–¢–ê–õ–û:
current_balance = balance_data.get("balance", 0.0)
```

**–§–∞–π–ª:** `src/strategies/scalping/futures/risk/margin_monitor.py:121`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

### 2. ‚ùå OrderCoordinator: cannot access local variable 'is_post_only'

**–û—à–∏–±–∫–∞:**
```
2026-01-04 14:34:42.666 | DEBUG | OrderCoordinator:monitor_limit_orders:586 | –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ä–¥–µ—Ä–æ–≤ –¥–ª—è BTC-USDT: cannot access local variable 'is_post_only' where it is not associated with a value
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–í `OrderCoordinator.monitor_limit_orders()` –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `is_post_only` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤ —Å—Ç—Ä–æ–∫–µ 195, –Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ —Å—Ç—Ä–æ–∫–µ 267. –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –∫–æ–¥–∞ –¥–æ —Å—Ç—Ä–æ–∫–∏ 195 —Ä–∞–Ω—å—à–µ, —á–µ–º –¥–æ —Å—Ç—Ä–æ–∫–∏ 267, –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `is_post_only` –ü–ï–†–ï–î –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º (–ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π timeout).

**–§–∞–π–ª:** `src/strategies/scalping/futures/coordinators/order_coordinator.py:262-269`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

### 3. ‚ö†Ô∏è SOL-USDT: –û—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω –ø–æ —Ä—ã–Ω–∫—É –≤–º–µ—Å—Ç–æ –ª–∏–º–∏—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –û—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω: **134.36** (POST_ONLY, limit)
- –ü–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞: **134.66** (avgPx —Å –±–∏—Ä–∂–∏)
- –†–∞–∑–Ω–∏—Ü–∞: **+0.30** (0.22% slippage)

**–õ–æ–≥–∏:**
```
2026-01-04 14:34:52.794 | INFO | order_executor:_place_limit_order:1447 | ‚úÖ –õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω: 3188479454944497664
2026-01-04 14:34:52.805 | DEBUG | websocket_coordinator:handle_private_ws_orders:758 | üìä Private WS: –û—Ä–¥–µ—Ä 3188479454944497664 –¥–ª—è SOL-USDT - filled
2026-01-04 14:34:54.105 | INFO | entry_manager:open_position_with_size:632 | üìà Position opened: SOL-USDT SHORT @ 134.66
```

**–ê–Ω–∞–ª–∏–∑:**
1. –û—Ä–¥–µ—Ä –±—ã–ª —Ä–∞–∑–º–µ—â–µ–Ω —Å `POST_ONLY=True` –Ω–∞ —Ü–µ–Ω—É 134.36
2. –ë–∏—Ä–∂–∞ –∏—Å–ø–æ–ª–Ω–∏–ª–∞ –æ—Ä–¥–µ—Ä –ø–æ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω–µ 134.66 (avgPx)
3. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ—Ä–¥–µ—Ä –±—ã–ª –∏—Å–ø–æ–ª–Ω–µ–Ω –∫–∞–∫ **taker** (market), –∞ –Ω–µ –∫–∞–∫ **maker** (limit)

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. **POST_ONLY –æ—Ä–¥–µ—Ä –±—ã–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω –±–∏—Ä–∂–µ–π** –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –º–µ–∂–¥—É —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º
2. **–ë–∏—Ä–∂–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω–∏–ª–∞ POST_ONLY –Ω–∞ market** –µ—Å–ª–∏ —Ü–µ–Ω–∞ —É—à–ª–∞ –æ—Ç –ª–∏–º–∏—Ç–∞
3. **–û—Ä–¥–µ—Ä –±—ã–ª —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª–Ω–µ–Ω** –ø–æ —Ä–∞–∑–Ω—ã–º —Ü–µ–Ω–∞–º (—Å—Ä–µ–¥–Ω—è—è 134.66)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –±–∏—Ä–∂–∏ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ POST_ONLY –æ—Ä–¥–µ—Ä–æ–≤
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å `avgPx` –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å —Ü–µ–Ω–æ–π –æ—Ä–¥–µ—Ä–∞
3. ‚úÖ –ï—Å–ª–∏ slippage > 0.1%, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
4. ‚úÖ –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ POST_ONLY –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢–°–Ø –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï

---

### 4. ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –û—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω –¥–∞–ª–µ–∫–æ –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
BTC-USDT: –°–∏–≥–Ω–∞–ª –Ω–∞ 92728.20, –æ—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ 91377.40
–†–∞–∑–Ω–∏—Ü–∞: -1351 (-1.46%) - –æ—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω –ù–ê 1.46% –ù–ò–ñ–ï —Å–∏–≥–Ω–∞–ª–∞!
```

**–ê–Ω–∞–ª–∏–∑:**
- –°–∏–≥–Ω–∞–ª BTC: **92728.20** (11:33:03)
- –û—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω: **91377.40** (11:33:31)
- –†–∞–∑–Ω–∏—Ü–∞: **-1351** (-1.46%)
- –û—Ä–¥–µ—Ä –≤–∏—Å–∏—Ç **81 —Å–µ–∫—É–Ω–¥—É** (–ª–∏–º–∏—Ç: 30 —Å–µ–∫)

**–ü—Ä–∏—á–∏–Ω–∞:**
–í `_calculate_limit_price()` –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —É—Å—Ç–∞—Ä–µ–≤—à–∏–π `signal_price` (92728.20) –∫–∞–∫ `base_price` –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ª–∏–º–∏—Ç–Ω–æ–π —Ü–µ–Ω—ã, –≤–º–µ—Å—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞. –≠—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é –æ—Ä–¥–µ—Ä–∞ –Ω–∞ 1.46% –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω—ã.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë–´–õ–û:
if price_diff_pct < 0.1:
    base_price = signal_price  # ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–π signal_price!

# –°–¢–ê–õ–û:
base_price = current_price  # ‚úÖ –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞
# signal_price –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –ù–ï –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞!
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ —Ü–µ–Ω—ã: 0.5 —Å–µ–∫ (–≤–º–µ—Å—Ç–æ 1 —Å–µ–∫) –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–Ω–∏—Ü—ã –æ—Ç reference_price (best_ask/best_bid), –∞ –Ω–µ base_price
3. ‚úÖ –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ > 0.2%, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –¥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è

**–§–∞–π–ª:** `src/strategies/scalping/futures/order_executor.py:667-698, 1020-1042`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (3 –ø—Ä–æ–±–ª–µ–º—ã):
1. MarginMonitor: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏–∑ DataRegistry
2. OrderCoordinator: –æ—à–∏–±–∫–∞ `cannot access local variable 'is_post_only'`
3. **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï**: –†–∞—Å—á–µ—Ç –ª–∏–º–∏—Ç–Ω–æ–π —Ü–µ–Ω—ã - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ signal_price –≤–º–µ—Å—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (1 –ø—Ä–æ–±–ª–µ–º–∞):
1. SOL-USDT: –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω –ø–æ —Ä—ã–Ω–∫—É –≤–º–µ—Å—Ç–æ –ª–∏–º–∏—Ç–∞ (POST_ONLY –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
   - –û—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ 134.36, –∏—Å–ø–æ–ª–Ω–µ–Ω –ø–æ 134.66
   - –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: POST_ONLY –æ—Ç–∫–ª–æ–Ω–µ–Ω –±–∏—Ä–∂–µ–π, —Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –∏–ª–∏ –±–∏—Ä–∂–∞ –∑–∞–º–µ–Ω–∏–ª–∞ –Ω–∞ market

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –û—Ç–≤–µ—Ç –±–∏—Ä–∂–∏ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ POST_ONLY –æ—Ä–¥–µ—Ä–æ–≤
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞ –∏ avgPx –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
   - –ü—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è POST_ONLY –æ—Ä–¥–µ—Ä–æ–≤

2. **–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –º–∞—Ä–∂–∏:**
   - –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ orchestrator.get_balance() –µ—Å–ª–∏ DataRegistry –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤:**
   - ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: –¢–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (best_ask/best_bid), –ù–ï signal_price
   - ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ —Ü–µ–Ω—ã: 0.5 —Å–µ–∫ (–≤–º–µ—Å—Ç–æ 1 —Å–µ–∫) –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞
   - ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–Ω–∏—Ü—ã –æ—Ç reference_price (best_ask/best_bid), –µ—Å–ª–∏ > 0.2% - –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º
   - ‚ö†Ô∏è –û—Ç–∫–ª—é—á–∞—Ç—å POST_ONLY –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (—Ç—Ä–µ–±—É–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
