# üîç –°–í–û–î–ö–ê –ê–£–î–ò–¢–ê: –ß–¢–û –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –ß–¢–û –û–°–¢–ê–õ–û–°–¨

**–î–∞—Ç–∞:** 04.12.2025

---

## ‚úÖ –ß–¢–û –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. **loss_cut** - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `trailing_stop_loss.py` (—Å—Ç—Ä–æ–∫–∞ 505)
```python
loss_cut_from_price = self.loss_cut_percent / self.leverage  # ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ % –º–∞—Ä–∂–∏ –≤ % —Ü–µ–Ω—ã
if profit_pct <= -loss_cut_from_price:  # profit_pct –æ—Ç —Ü–µ–Ω—ã, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ—Ä–æ–≥–æ–º
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### 2. **timeout_loss** - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `trailing_stop_loss.py` (—Å—Ç—Ä–æ–∫–∞ 652)
```python
timeout_loss_from_price = self.timeout_loss_percent / self.leverage  # ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ % –º–∞—Ä–∂–∏ –≤ % —Ü–µ–Ω—ã
if profit_pct <= -timeout_loss_from_price:  # profit_pct –æ—Ç —Ü–µ–Ω—ã, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ—Ä–æ–≥–æ–º
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### 3. **PositionManager._check_tp_only()** - ‚úÖ –ß–ê–°–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `position_manager.py` (—Å—Ç—Ä–æ–∫–∞ 2279)
```python
if margin_used > 0:
    pnl_percent = (unrealized_pnl / margin_used) * 100  # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –æ—Ç –º–∞—Ä–∂–∏
else:
    # Fallback: —Å—á–∏—Ç–∞–µ—Ç –æ—Ç —Ü–µ–Ω—ã
    pnl_percent = (current_price - entry_price) / entry_price * 100  # ‚ö†Ô∏è Fallback
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª margin (–Ω–æ –µ—Å—Ç—å fallback)

---

## üî¥ –ß–¢–û –ù–ï –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. **get_profit_pct()** - ‚ùå –í–°–ï –ï–©–ï –°–ß–ò–¢–ê–ï–¢ –û–¢ –¶–ï–ù–´
**–§–∞–π–ª:** `trailing_stop_loss.py` (—Å—Ç—Ä–æ–∫–∏ 404-407)
```python
# ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –°—á–∏—Ç–∞–µ—Ç –æ—Ç –¶–ï–ù–´, –∞ –Ω–µ –æ—Ç –ú–ê–†–ñ–ò!
if self.side == "long":
    gross_profit_pct = (current_price - self.entry_price) / self.entry_price
else:
    gross_profit_pct = (self.entry_price - current_price) / self.entry_price
```
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Ü–µ–Ω—ã (0.27% = 0.27% –æ—Ç —Ü–µ–Ω—ã)
- –ü—Ä–∏ leverage 3x: 0.27% –æ—Ç —Ü–µ–Ω—ã = 0.81% –æ—Ç –º–∞—Ä–∂–∏
- –ù–æ –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0.27% (–æ—Ç —Ü–µ–Ω—ã), –∞ –Ω–µ 0.81% (–æ—Ç –º–∞—Ä–∂–∏)

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –î–ª—è loss_cut –∏ timeout —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Ä–æ–≥–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è
- –ù–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (min_profit_to_close, high_profit) - –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!

---

### 2. **min_profit_to_close** - ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ï –°–†–ê–í–ù–ï–ù–ò–ï
**–§–∞–π–ª:** `trailing_stop_loss.py` (—Å—Ç—Ä–æ–∫–∞ 715)
```python
if profit_pct < self.min_profit_to_close:  # ‚ùå –ü–†–û–ë–õ–ï–ú–ê!
    # profit_pct –æ—Ç –¶–ï–ù–´ (0.27%)
    # min_profit_to_close –æ—Ç –ú–ê–†–ñ–ò? (0.025 = 2.5%)
    # –ü—Ä–∏ leverage 3x: 2.5% –æ—Ç –º–∞—Ä–∂–∏ = 0.833% –æ—Ç —Ü–µ–Ω—ã
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: 0.27% < 0.833% ‚Üí –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç (–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ —Å–ª—É—á–∞–π–Ω–æ!)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `min_profit_to_close` –≤ –∫–æ–Ω—Ñ–∏–≥–µ —É–∫–∞–∑–∞–Ω –∫–∞–∫ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –º–∞—Ä–∂–∏ (0.025 = 2.5% –æ—Ç –º–∞—Ä–∂–∏)
- –ù–æ `profit_pct` - —ç—Ç–æ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Ü–µ–Ω—ã
- –ü—Ä–∏ leverage 3x: 2.5% –æ—Ç –º–∞—Ä–∂–∏ = 0.833% –æ—Ç —Ü–µ–Ω—ã
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: 0.27% (–æ—Ç —Ü–µ–Ω—ã) < 0.025 (–æ—Ç –º–∞—Ä–∂–∏?) ‚Üí **–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!**

**–ü—Ä–∏–º–µ—Ä:**
- Entry: $90,000, Current: $90,240
- profit_pct = 0.27% (–æ—Ç —Ü–µ–Ω—ã)
- min_profit_to_close = 0.025 (2.5% –æ—Ç –º–∞—Ä–∂–∏ = 0.833% –æ—Ç —Ü–µ–Ω—ã –ø—Ä–∏ leverage 3x)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: 0.27% < 0.833% ‚Üí –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ —Å–ª—É—á–∞–π–Ω–æ!)
- –ï—Å–ª–∏ min_profit_to_close = 0.01 (1% –æ—Ç –º–∞—Ä–∂–∏ = 0.333% –æ—Ç —Ü–µ–Ω—ã)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: 0.27% < 0.333% ‚Üí –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –ù–æ –µ—Å–ª–∏ profit_pct = 0.5% (–æ—Ç —Ü–µ–Ω—ã) = 1.5% –æ—Ç –º–∞—Ä–∂–∏
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: 0.5% < 0.01 ‚Üí –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç ‚ùå (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –î–æ–ª–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å, —Ç.–∫. 1.5% > 1%)

---

### 3. **TrailingSLCoordinator** - ‚ùå –ù–ï –ü–ï–†–ï–î–ê–ï–¢ margin/unrealizedPnl
**–§–∞–π–ª:** `trailing_sl_coordinator.py` (—Å—Ç—Ä–æ–∫–∞ 581)
```python
profit_pct = tsl.get_profit_pct(current_price, include_fees=True)  # ‚ùå –ù–ï –ø–µ—Ä–µ–¥–∞–µ—Ç margin/unrealizedPnl
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `get_profit_pct()` –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç margin –∏ unrealizedPnl
- –í—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ—Ç –æ—Ç —Ü–µ–Ω—ã (fallback)
- –ù–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –±–∏—Ä–∂–∏

---

## üìä –í–´–í–û–î

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. ‚úÖ **loss_cut** - –ø–æ—Ä–æ–≥ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ % –º–∞—Ä–∂–∏ –≤ % —Ü–µ–Ω—ã
2. ‚úÖ **timeout_loss** - –ø–æ—Ä–æ–≥ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ % –º–∞—Ä–∂–∏ –≤ % —Ü–µ–Ω—ã
3. ‚úÖ **PositionManager TP** - —Å—á–∏—Ç–∞–µ—Ç –æ—Ç –º–∞—Ä–∂–∏ (–µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª margin)

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. ‚ùå **get_profit_pct()** - —Å—á–∏—Ç–∞–µ—Ç –æ—Ç —Ü–µ–Ω—ã, –∞ –Ω–µ –æ—Ç –º–∞—Ä–∂–∏
2. ‚ùå **min_profit_to_close** - —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Ü–µ–Ω—ã vs –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –º–∞—Ä–∂–∏)
3. ‚ùå **high_profit** - –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç profit_pct)

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:
- **–î–ª—è loss_cut –∏ timeout** - —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Ä–æ–≥–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è
- **–î–ª—è min_profit_to_close** - –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Ä–æ–≥ –ù–ï –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
- **–î–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫** - –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å min_profit_to_close (–ü–†–û–©–ï)
**–§–∞–π–ª:** `trailing_stop_loss.py` (—Å—Ç—Ä–æ–∫–∞ 715)
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º min_profit_to_close –∏–∑ % –º–∞—Ä–∂–∏ –≤ % —Ü–µ–Ω—ã
if profit_pct > 0 and self.min_profit_to_close is not None:
    min_profit_from_price = self.min_profit_to_close / self.leverage  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
    if profit_pct < min_profit_from_price:  # –¢–µ–ø–µ—Ä—å –æ–±–∞ –æ—Ç —Ü–µ–Ω—ã
        logger.debug(...)
        return False, None
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å get_profit_pct() (–ü–†–ê–í–ò–õ–¨–ù–ï–ï)
**–§–∞–π–ª:** `trailing_stop_loss.py` (–º–µ—Ç–æ–¥ get_profit_pct)
```python
def get_profit_pct(self, current_price: float, include_fees: bool = True,
                   margin_used: Optional[float] = None,
                   unrealized_pnl: Optional[float] = None) -> float:
    # ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ï—Å–ª–∏ –µ—Å—Ç—å margin –∏ unrealizedPnl - —Å—á–∏—Ç–∞–µ–º –æ—Ç –º–∞—Ä–∂–∏
    if margin_used and margin_used > 0 and unrealized_pnl is not None:
        gross_pnl_pct = (unrealized_pnl / margin_used) * 100  # –û—Ç –º–∞—Ä–∂–∏!
        # ... —É—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é ...
        return net_pnl_pct
    
    # ‚úÖ FALLBACK: –ï—Å–ª–∏ –Ω–µ—Ç margin - —Å—á–∏—Ç–∞–µ–º –æ—Ç —Ü–µ–Ω—ã –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
    if self.side == "long":
        gross_profit_pct_from_price = (current_price - self.entry_price) / self.entry_price
    else:
        gross_profit_pct_from_price = (self.entry_price - current_price) / self.entry_price
    
    # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Ü–µ–Ω—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –º–∞—Ä–∂–∏
    gross_profit_pct_from_margin = gross_profit_pct_from_price * self.leverage
    # ... —É—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é ...
    return net_pnl_pct_from_margin
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç 2 –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ. –í–∞—Ä–∏–∞–Ω—Ç 1 –ø—Ä–æ—â–µ –∏ –Ω–µ —Å–ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É.

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢

1. **–í–´–°–û–ö–ò–ô:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å min_profit_to_close (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä–æ–≥)
2. **–í–´–°–û–ö–ò–ô:** –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å margin/unrealizedPnl –≤ get_profit_pct()
3. **–°–†–ï–î–ù–ò–ô:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å get_profit_pct() –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Ç –º–∞—Ä–∂–∏ (–ø–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

---

**–í—ã–≤–æ–¥:** –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (loss_cut, timeout), –Ω–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å (get_profit_pct —Å—á–∏—Ç–∞–µ—Ç –æ—Ç —Ü–µ–Ω—ã, min_profit_to_close –Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è).

