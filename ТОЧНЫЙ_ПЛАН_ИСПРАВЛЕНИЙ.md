# üìã –¢–û–ß–ù–´–ô –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô: 28 –ü–†–ê–í–û–ö –° –ö–û–ù–ö–†–ï–¢–ù–´–ú–ò –°–¢–†–û–ö–ê–ú–ò

**–î–∞—Ç–∞:** 2025-12-22  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é  
**–û—Å–Ω–æ–≤–∞:** –û—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

---

## üî¥ –ü–†–ê–í–ö–ê #1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å regime: null –≤ EXIT_DECISIONS

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/exit_analyzer.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:** `regime` –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ decision dict, –ø–æ—ç—Ç–æ–º—É –≤ JSON –ø–æ–ª—É—á–∞–µ—Ç—Å—è `null`

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

**–°—Ç—Ä–æ–∫–∏ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å):**
- **–°—Ç—Ä–æ–∫–∞ 1598:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1632:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1646:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1664:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1681:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1711:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1742:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1757:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1793:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1808:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 1954:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 2101:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 2206:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 2228:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 2345:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 2363:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`
- **–°—Ç—Ä–æ–∫–∞ 2379:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ (4 –ø—Ä–æ–±–µ–ª–∞ –ø–µ—Ä–µ–¥ `"regime": regime,`)

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å `"regime": regime` –≤–æ –í–°–ï –æ—Å—Ç–∞–≤—à–∏–µ—Å—è decision dict

**–ú–µ—Å—Ç–∞ –≥–¥–µ –ù–ï–¢ regime (–¥–æ–±–∞–≤–∏—Ç—å):**

**–í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_trending`:**
- **–°—Ç—Ä–æ–∫–∞ 1734-1743:** `smart_forced_close_trending` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 1750-1758:** `max_holding_exceeded_but_loss_trending` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 1786-1794:** `max_holding_low_profit` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 1801-1809:** `max_holding_no_signals` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)

**–í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_ranging`:**
- **–°—Ç—Ä–æ–∫–∞ 1947-1955:** `profit_too_low_vs_peak` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 2020-2027:** `sl_reached` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- **–°—Ç—Ä–æ–∫–∞ 2059-2066:** `tp_reached` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- **–°—Ç—Ä–æ–∫–∞ 2094-2102:** `big_profit_exit` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 2183-2191:** `partial_close` (partial_tp) - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2200-2207:** `partial_tp_min_holding_wait` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 2221-2229:** `reversal_detected` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 2336-2346:** `max_holding_hard_stop_timeout_loss` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 2354-2364:** `max_holding_exceeded_but_loss_small` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 2372-2380:** `max_holding_hard_stop_profit` - ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø)
- **–°—Ç—Ä–æ–∫–∞ 2408-2416:** `smart_forced_close_ranging` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2425-2433:** `max_holding_exceeded_but_loss` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2450-2458:** `max_holding_low_profit` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2465-2473:** `max_holding_exceeded` - ‚ùå –ù–ï–¢ regime

**–í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_choppy`:**
- **–°—Ç—Ä–æ–∫–∞ 2608-2616:** `profit_too_low_vs_peak` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2628-2636:** `tp_reached` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2648-2656:** `big_profit_exit` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2680-2688:** `partial_close` (partial_tp) - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2698-2706:** `partial_tp_min_holding_wait` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2718-2726:** `reversal_detected` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2750-2758:** `smart_forced_close_choppy` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2767-2775:** `max_holding_exceeded_but_loss_choppy` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2795-2803:** `max_holding_low_profit` - ‚ùå –ù–ï–¢ regime
- **–°—Ç—Ä–æ–∫–∞ 2810-2818:** `max_holding_exceeded_choppy` - ‚ùå –ù–ï–¢ regime

**–ò—Ç–æ–≥–æ:** ~15 –º–µ—Å—Ç –≥–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å regime + ~17 –º–µ—Å—Ç –≥–¥–µ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø—ã

---

## üî¥ –ü–†–ê–í–ö–ê #2: –°–¥–µ–ª–∞—Ç—å max_holding_minutes –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –æ—Ç —Ä–µ–∂–∏–º–∞

**–§–∞–π–ª:** `config/config_futures.yaml` + `exit_analyzer.py:1043`  
**–ü—Ä–æ–±–ª–µ–º–∞:** `_get_max_holding_minutes()` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `exit_params.regime.max_holding_minutes`

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥

**–§–∞–π–ª:** `config/config_futures.yaml`  
**–ú–µ—Å—Ç–æ:** –ü–æ—Å–ª–µ —Å–µ–∫—Ü–∏–∏ `exit_params:` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 850)

```yaml
exit_params:
  ranging:
    max_holding_minutes: 15  # –î–ª—è ranging
    sl_percent: 0.8
    tp_percent: 2.5
    spread_buffer: 0.15
  trending:
    max_holding_minutes: 45  # –î–ª—è trending
    sl_percent: 2.0
    tp_percent: 8.0
    spread_buffer: 0.05
  choppy:
    max_holding_minutes: 10  # –î–ª—è choppy
    sl_percent: 1.5
    tp_percent: 3.0
    spread_buffer: 0.10
```

### –®–∞–≥ 2: –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É —Ñ—É–Ω–∫—Ü–∏–∏

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/exit_analyzer.py`  
**–°—Ç—Ä–æ–∫–∞:** 1043-1085

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
def _get_max_holding_minutes(self, regime: str) -> float:
    max_holding_minutes = 120.0  # Default 2 —á–∞—Å–∞
    if self.scalping_config:
        try:
            adaptive_regime = getattr(self.scalping_config, "adaptive_regime", {})
            # ... –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ adaptive_regime ...
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
def _get_max_holding_minutes(self, regime: str) -> float:
    max_holding_minutes = 120.0  # Default 2 —á–∞—Å–∞
    
    # ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 1: exit_params.regime.max_holding_minutes
    if self.config_manager:
        try:
            exit_params = self.config_manager.get("exit_params", {})
            if isinstance(exit_params, dict) and regime in exit_params:
                regime_config = exit_params.get(regime, {})
                if isinstance(regime_config, dict) and "max_holding_minutes" in regime_config:
                    return float(regime_config["max_holding_minutes"])
        except Exception as e:
            logger.debug(f"‚ö†Ô∏è ExitAnalyzer: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è exit_params.max_holding_minutes: {e}")
    
    # ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 2: adaptive_regime.regime.max_holding_minutes (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
    if self.scalping_config:
        try:
            adaptive_regime = getattr(self.scalping_config, "adaptive_regime", {})
            # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
```

---

## üî¥ –ü–†–ê–í–ö–ê #3: –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è race condition

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`  
**–°—Ç—Ä–æ–∫–∞:** ~5780 (–≤ `close_position_manually`)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
if position.size <= 0:
    logger.warning(f"Zero size position: {symbol}")
    return None
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
# –í __init__ –¥–æ–±–∞–≤–∏—Ç—å:
self._close_lock = asyncio.Lock()

# –í close_position_manually –¥–æ–±–∞–≤–∏—Ç—å:
async with self._close_lock:
    position = self.position_registry.get_position(symbol)
    if not position or position.size <= 0:
        logger.warning(f"Zero size position: {symbol}")
        return None
    # ... –∫–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è ...
```

---

## üî¥ –ü–†–ê–í–ö–ê #4: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/exit_analyzer.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:** `sl_percent`, `tp_percent`, `big_profit_exit_percent` –º–æ–≥—É—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞–º–∏

### –ú–µ—Å—Ç–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**–í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_trending` (—Å—Ç—Ä–æ–∫–∞ ~1500):**
```python
# –í –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
sl_percent = float(sl_percent) if sl_percent is not None else 2.0
tp_percent = float(tp_percent) if tp_percent is not None else 2.4
big_profit_exit_percent = float(big_profit_exit_percent) if big_profit_exit_percent is not None else 1.5
pnl_percent = float(pnl_percent)
```

**–í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_ranging` (—Å—Ç—Ä–æ–∫–∞ ~1900):**
```python
# –í –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
sl_percent = float(sl_percent) if sl_percent is not None else 2.0
tp_percent = float(tp_percent) if tp_percent is not None else 2.4
big_profit_exit_percent = float(big_profit_exit_percent) if big_profit_exit_percent is not None else 1.5
gross_pnl_percent = float(gross_pnl_percent)
net_pnl_percent = float(net_pnl_percent)
```

**–í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_choppy` (—Å—Ç—Ä–æ–∫–∞ ~2550):**
```python
# –í –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
sl_percent = float(sl_percent) if sl_percent is not None else 2.0
tp_percent = float(tp_percent) if tp_percent is not None else 2.4
big_profit_exit_percent = float(big_profit_exit_percent) if big_profit_exit_percent is not None else 1.5
pnl_percent = float(pnl_percent)
```

---

## üî¥ –ü–†–ê–í–ö–ê #5: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É duration_sec < 30

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`  
**–°—Ç—Ä–æ–∫–∞:** ~6016 (—Ä–∞—Å—á–µ—Ç duration_sec) –∏ ~5780 (close_position_manually)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
duration_sec = (exit_time - entry_time).total_seconds()
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
def close_position_manually(self, symbol):
    position = self.position_registry.get_position(symbol)
    if not position or not position.entry_time:
        logger.error(f"No entry_time for position: {symbol}")
        return None
    
    duration_sec = (exit_time - position.entry_time).total_seconds()
    if duration_sec < 30:  # –ú–∏–Ω–∏–º—É–º 30 —Å–µ–∫
        logger.warning(f"Too fast close: {symbol}, {duration_sec}s")
        return None
    # ... –∫–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è ...
```

---

## üî¥ –ü–†–ê–í–ö–ê #6: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π (avgPx –≤–º–µ—Å—Ç–æ markPx)

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `markPx` –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ `position_value`, –Ω–æ –Ω—É–∂–Ω–æ `avgPx`

### –ú–µ—Å—Ç–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**–°—Ç—Ä–æ–∫–∞ ~6065 (–æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ—Å—Ç–æ —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏):**
```python
# –ù–∞–π—Ç–∏ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è markPx –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ position_value
# –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:
position_value = size * float(position.get("avgPx", position.get("entry_price", "0")))
```

**–ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –í–°–ï –º–µ—Å—Ç–∞ –≥–¥–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `markPx` –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `position_value` –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:**
```bash
grep -n "markPx\|position_value\|commission" position_manager.py | grep -E "6065|6088|6112"
```

---

## üî¥ –ü–†–ê–í–ö–ê #7: –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∞—Å 5% –¥–ª—è position size cap

**–§–∞–π–ª:** `src/strategies/scalping/futures/risk_manager.py`  
**–°—Ç—Ä–æ–∫–∞:** ~992-996

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
if calculated_position_size > max_position_size:
    position_size = max_position_size
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
if calculated_position_size > max_position_size:
    position_size = max_position_size * 0.95  # 5% –∑–∞–ø–∞—Å
    logger.warning(f"Position capped: {calculated_position_size} -> {position_size}")
```

---

## üî¥ –ü–†–ê–í–ö–ê #8: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∞

**–§–∞–π–ª:** `src/strategies/scalping/futures/risk/adaptive_leverage.py`  
**–°—Ç—Ä–æ–∫–∞:** ~128-135

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
leverage = await client.round_leverage_to_available(symbol, leverage)
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
# –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∏
available = await client.get_available_leverages(symbol)
logger.info(f"Available leverages for {symbol}: {available}")

# –ù–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π
max_available = max(available) if available else 20
desired = min(leverage, max_available)
leverage = await client.round_leverage_to_available(symbol, desired)
```

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: –ß–¢–û –ò –ì–î–ï –ò–°–ü–†–ê–í–õ–Ø–¢–¨

| # | –ü—Ä–∞–≤–∫–∞ | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –î–µ–π—Å—Ç–≤–∏–µ |
|---|--------|------|--------|----------|
| 1 | regime: null | exit_analyzer.py | 1598, 1632, 1646, 1664, 1681, 1711, 1742, 1757, 1793, 1808, 1954, 2101, 2206, 2228, 2345, 2363, 2379 | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø—ã |
| 1 | regime: null | exit_analyzer.py | 2183, 2408, 2425, 2450, 2465, 2608, 2628, 2648, 2680, 2698, 2718, 2750, 2767, 2795, 2810 | –î–æ–±–∞–≤–∏—Ç—å regime |
| 2 | max_holding_minutes | config_futures.yaml | ~850 | –î–æ–±–∞–≤–∏—Ç—å exit_params |
| 2 | max_holding_minutes | exit_analyzer.py | 1043-1085 | –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É |
| 3 | Race condition | position_manager.py | ~5780 | –î–æ–±–∞–≤–∏—Ç—å lock |
| 4 | str vs int | exit_analyzer.py | ~1500, ~1900, ~2550 | –î–æ–±–∞–≤–∏—Ç—å float() |
| 5 | Duration check | position_manager.py | ~6016, ~5780 | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É |
| 6 | –ö–æ–º–∏—Å—Å–∏—è | position_manager.py | ~6065, ~6088, ~6112 | –ó–∞–º–µ–Ω–∏—Ç—å markPx –Ω–∞ avgPx |
| 7 | Position size cap | risk_manager.py | ~992-996 | –î–æ–±–∞–≤–∏—Ç—å * 0.95 |
| 8 | Leverage rounding | adaptive_leverage.py | ~128-135 | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É max_available |

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ü–ï–†–ï–î –ó–ê–ü–£–°–ö–û–ú

- [ ] –í—Å–µ decision dict –∏–º–µ—é—Ç `"regime": regime` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏
- [ ] `_get_max_holding_minutes()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `exit_params.regime.max_holding_minutes`
- [ ] –î–æ–±–∞–≤–ª–µ–Ω `asyncio.Lock` –¥–ª—è race condition
- [ ] –í—Å–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è `pnl_percent` –∏—Å–ø–æ–ª—å–∑—É—é—Ç `float()`
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ `duration_sec < 30` –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [ ] –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `avgPx`
- [ ] Position size cap –∏–º–µ–µ—Ç –∑–∞–ø–∞—Å 5%
- [ ] Leverage –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `max_available`
- [ ] –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ regime —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å —Ç–æ—á–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏!** üöÄ


