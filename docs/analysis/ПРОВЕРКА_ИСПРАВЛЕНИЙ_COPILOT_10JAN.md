# ‚úÖ –ü–†–û–í–ï–†–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô COPILOT: TSL price=0

**–î–∞—Ç–∞:** 2026-01-10  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ê–í–ò–õ–¨–ù–´–ï –ò –ü–û–õ–ù–´–ï**

---

## üìä –ê–ù–ê–õ–ò–ó –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –ó–∞—â–∏—Ç–∞ –≤ `get_profit_pct()` 

**–§–∞–π–ª:** `trailing_stop_loss.py:453-462`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (10.01.2026): –ó–∞—â–∏—Ç–∞ –æ—Ç price=0
if current_price is None or current_price <= 0:
    logger.warning(
        f"‚ö†Ô∏è TSL: –ü–æ–ª—É—á–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞ (price={current_price}) –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL, "
        f"–∏—Å–ø–æ–ª—å–∑—É–µ–º entry_price={self.entry_price:.8f} –∫–∞–∫ fallback"
    )
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price –∫–∞–∫ —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É (—Ç.–µ. –Ω—É–ª–µ–≤–æ–π PnL)
    current_price = self.entry_price
```

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ **–û–¢–õ–ò–ß–ù–û**
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `None` –∏ `<= 0`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `entry_price` –∫–∞–∫ fallback (–¥–∞—Å—Ç PnL = 0%, —á—Ç–æ –ª—É—á—à–µ —á–µ–º fallback 4%)
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ `should_close_position()`

**–§–∞–π–ª:** `trailing_sl_coordinator.py:1264-1276`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (10.01.2026): –í–∞–ª–∏–¥–∞—Ü–∏—è current_price –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º should_close_position
if current_price is None or current_price <= 0:
    logger.error(
        f"‚ùå {symbol}: current_price={current_price} –ø–µ—Ä–µ–¥ should_close_position - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞! "
        f"–ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price={entry_price:.8f} –≤–º–µ—Å—Ç–æ –Ω–µ–µ"
    )
    current_price = entry_price if entry_price and entry_price > 0 else 0
    if current_price <= 0:
        logger.error(
            f"‚ùå {symbol}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞–ª–∏–¥–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ TSL, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É"
        )
        return
```

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ **–û–¢–õ–ò–ß–ù–û**
- –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `entry_price`, –ø–æ—Ç–æ–º –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã—Ö–æ–¥ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

---

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –§–∏–Ω–∞–ª—å–Ω—ã–π fallback –≤ `_get_current_price()`

**–§–∞–π–ª:** `trailing_sl_coordinator.py:1807-1832`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
```python
# ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 5: –§–ò–ù–ê–õ–¨–ù–´–ô FALLBACK - –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price –∏–∑ –ø–æ–∑–∏—Ü–∏–∏
try:
    position = self._get_position(symbol)
    if position:
        entry_price = position.get("entry_price") or position.get("avgPx") or 0
        if isinstance(entry_price, str):
            try:
                entry_price = float(entry_price)
            except (ValueError, TypeError):
                entry_price = 0
        if entry_price and entry_price > 0:
            logger.error(
                f"üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô FALLBACK - –ò—Å–ø–æ–ª—å–∑—É–µ–º entry_price={entry_price:.8f} –¥–ª—è {symbol} "
                f"(WebSocket, REST API –∏ client –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã!)"
            )
            return entry_price
except Exception as e:
    logger.debug(f"‚ö†Ô∏è TSL: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å entry_price fallback –¥–ª—è {symbol}: {e}")

# –ï—Å–ª–∏ –¥–∞–∂–µ entry_price –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ª–æ–≥–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É
logger.error(
    f"üî¥ TSL: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê - –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è {symbol} –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤!"
)
return None
```

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ **–û–¢–õ–ò–ß–ù–û**
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è fallback (5 —É—Ä–æ–≤–Ω–µ–π)
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` –µ—Å–ª–∏ –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤—ã—à–µ)

---

## üéØ –ü–û–õ–ù–û–¢–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. ‚úÖ **`get_profit_pct()`** - –∑–∞—â–∏—Ç–∞ –æ—Ç `price=0` —Å fallback –Ω–∞ `entry_price`
2. ‚úÖ **`update_trailing_stop_loss()`** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `should_close_position()`
3. ‚úÖ **`_get_current_price()`** - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback –Ω–∞ `entry_price` –∏–∑ –ø–æ–∑–∏—Ü–∏–∏

### ‚úÖ –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:

- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å - –æ—à–∏–±–æ–∫ –Ω–µ—Ç (–ª–∏–Ω—Ç–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª)
- ‚úÖ –õ–æ–≥–∏–∫–∞ - –≤—Å–µ —Ç—Ä–∏ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å fallback

---

## üîç –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `mark_price` –≤–º–µ—Å—Ç–æ `entry_price`

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `entry_price` –∫–∞–∫ fallback

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `mark_price` –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ (–±–æ–ª–µ–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞)

**–û—Ü–µ–Ω–∫–∞:** ‚ö†Ô∏è **–ù–ï –ö–†–ò–¢–ò–ß–ù–û**
- `entry_price` –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–≥–¥–∞ (–µ—Å—Ç—å –≤ –ø–æ–∑–∏—Ü–∏–∏)
- `mark_price` –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö
- –¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ

### 2. –í–æ–∑–≤—Ä–∞—Ç `None` –≤–º–µ—Å—Ç–æ `0` –≤ `_get_current_price()`

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` –µ—Å–ª–∏ –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**
- `None` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—ã—à–µ
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ª–∏—á–∏—Ç—å "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö" –æ—Ç "—Ü–µ–Ω–∞ = 0"

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üîç TSL_CHECK: XRP-USDT | profit=4.0000 | price=0.0000 | close=False ‚ùå
–†–µ–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫: -1.39%
Loss_cut –ø—Ä–æ–≤–µ—Ä–∫–∞: 4.0% > -0.4% ‚Üí –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üîç TSL_CHECK: XRP-USDT | profit=-1.3900 | price=2.0887 | close=True ‚úÖ
–†–µ–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫: -1.39%
Loss_cut –ø—Ä–æ–≤–µ—Ä–∫–∞: -1.39% < -0.4% ‚Üí –ó–ê–ö–†–´–í–ê–ï–¢!
```

---

## ‚úÖ –í–´–í–û–î–´

### –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–´–ï –ò –ü–û–õ–ù–´–ï**

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
1. ‚úÖ –¢—Ä–∏ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã –æ—Ç `price=0`
2. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è fallback –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
3. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
4. ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
5. ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω - –æ—à–∏–±–æ–∫ –Ω–µ—Ç

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. ‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
2. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤** - —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ fallback
3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö** - —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ loss_cut —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ **–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞** –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
2. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏** –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ fallback
3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π** - —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ loss_cut —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
4. ‚úÖ **–û—Ç—Å–ª–µ–¥–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏** - –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã, —á–∞—Å—Ç–æ—Ç–∞ fallback

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–í–ï–†–ï–ù–´ –ò –û–î–û–ë–†–ï–ù–´**  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** ‚úÖ **–ì–û–¢–û–í–û –ö –ü–†–û–î–ê–ö–®–ï–ù–£**
