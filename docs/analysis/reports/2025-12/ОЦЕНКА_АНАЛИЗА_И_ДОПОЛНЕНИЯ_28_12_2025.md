# ‚úÖ –û–¶–ï–ù–ö–ê –ê–ù–ê–õ–ò–ó–ê –ò –î–û–ü–û–õ–ù–ï–ù–ò–Ø

**–î–∞—Ç–∞:** 28.12.2025  
**–û—Ü–µ–Ω–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5) - –û—Ç–ª–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –≤—ã–≤–æ–¥–∞–º–∏

---

## üìä –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê

–í–∞—à –∞–Ω–∞–ª–∏–∑ **–æ—á–µ–Ω—å —Ç–æ—á–Ω—ã–π –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π**. –í—Å–µ 6 –ø—Ä–æ–±–ª–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–∞—Ç—á–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω—ã. –ù–∏–∂–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞.

---

## ‚úÖ –ü–†–û–ë–õ–ï–ú–ê #1: –û—à–∏–±–∫–∞ –°—Ä–∞–≤–Ω–µ–Ω–∏—è –¢–∏–ø–æ–≤ –≤ ExitAnalyzer

### –í–∞—à –∞–Ω–∞–ª–∏–∑: ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
- –ú–µ—Ç–æ–¥ `_to_float()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Å—Ç—Ä–æ–∫–∏ 35-59 –≤ `exit_analyzer.py`)
- –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `_get_max_holding_minutes()` (—Å—Ç—Ä–æ–∫–∏ 1447-1550) **–£–ñ–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç** `_to_float()` –Ω–∞ —Å—Ç—Ä–æ–∫–µ 1475
- –ù–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ **–¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ** - –≤ —Å—Ç—Ä–æ–∫–µ 3291, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `max_holding_minutes_float`, –Ω–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `actual_max_holding_float` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –±–ª–æ–∫–µ `elif`

### üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:

**–ü—Ä–æ–±–ª–µ–º–∞ –≥–ª—É–±–∂–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è:**

1. **–í —Å—Ç—Ä–æ–∫–µ 1475** `_to_float()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `exit_params` –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ `ParameterProvider`
2. **–í —Å—Ç—Ä–æ–∫–µ 1513** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `float()` –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ `_to_float()` - –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É
3. **–í —Å—Ç—Ä–æ–∫–µ 1538-1543** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `float()` –Ω–∞–ø—Ä—è–º—É—é - –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É

**–í–∞—à –ø–∞—Ç—á –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π**, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –µ–≥–æ **–≤–µ–∑–¥–µ**, –≥–¥–µ —á–∏—Ç–∞–µ—Ç—Å—è `max_holding_minutes`:

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–ê–¢–ß (–ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö —á—Ç–µ–Ω–∏—è):
# –í —Å—Ç—Ä–æ–∫–µ 1513:
if isinstance(regime_config, dict) and "max_holding_minutes" in regime_config:
    max_holding_minutes_raw = regime_config["max_holding_minutes"]
    max_holding_minutes = self._to_float(max_holding_minutes_raw, "max_holding_minutes", 120.0)
    return max_holding_minutes  # –¢–µ–ø–µ—Ä—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ float

# –í —Å—Ç—Ä–æ–∫–µ 1538-1543:
if isinstance(regime_config, dict):
    max_holding_minutes_raw = regime_config.get("max_holding_minutes", 120.0)
    max_holding_minutes = self._to_float(max_holding_minutes_raw, "max_holding_minutes", 120.0)
else:
    max_holding_minutes_raw = getattr(regime_config, "max_holding_minutes", 120.0)
    max_holding_minutes = self._to_float(max_holding_minutes_raw, "max_holding_minutes", 120.0)
```

### ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:

–ü—Ä–∏–º–µ–Ω–∏—Ç—å `_to_float()` **–≤–µ–∑–¥–µ**, –≥–¥–µ —á–∏—Ç–∞–µ—Ç—Å—è `max_holding_minutes` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞, –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.

---

## ‚úÖ –ü–†–û–ë–õ–ï–ú–ê #2: MarginMonitor –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ú–µ—Ç–æ–¥ check_safety

### –í–∞—à –∞–Ω–∞–ª–∏–∑: ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
- –ú–µ—Ç–æ–¥ `check_safety()` –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã: `check_margin_available()`, `get_margin_ratio()`

### üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:

**–î–æ—Å—Ç—É–ø –∫ –±–∞–ª–∞–Ω—Å—É –∏ –º–∞—Ä–∂–µ:**

–í `RiskManager.__init__` (—Å—Ç—Ä–æ–∫–∞ 44) –µ—Å—Ç—å `data_registry`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ –º–∞—Ä–∂—É. –¢–∞–∫–∂–µ –µ—Å—Ç—å `orchestrator` (—Å—Ç—Ä–æ–∫–∞ 65), —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –º–µ—Ç–æ–¥ `_get_used_margin()` (—Å—Ç—Ä–æ–∫–∏ 3430-3510).

### ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ç—á:

```python
# –§–∞–π–ª: src/strategies/scalping/futures/risk/margin_monitor.py

async def check_safety(
    self, 
    position_size_usd: float, 
    current_positions: Dict[str, Any],
    orchestrator: Optional[Any] = None,  # ‚úÖ –ù–û–í–û–ï: –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–ª–∞–Ω—Å—É
    data_registry: Optional[Any] = None,  # ‚úÖ –ù–û–í–û–ï: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –º–∞—Ä–∂–∏ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏.
    
    Args:
        position_size_usd: –†–∞–∑–º–µ—Ä –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ –≤ USD
        current_positions: –¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–π –º–∞—Ä–∂–∏)
        orchestrator: Orchestrator –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–ª–∞–Ω—Å—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        data_registry: DataRegistry –¥–ª—è —á—Ç–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    
    Returns:
        bool: True –µ—Å–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ
    """
    try:
        # ‚úÖ –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ –º–∞—Ä–∂—É –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        current_balance = 0.0
        used_margin = 0.0
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: Orchestrator
        if orchestrator:
            try:
                current_balance = await orchestrator.client.get_balance() or 0.0
                used_margin = await orchestrator._get_used_margin() or 0.0
            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏–∑ orchestrator: {e}")
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: DataRegistry
        if (current_balance == 0.0 or used_margin == 0.0) and data_registry:
            try:
                margin_data = await data_registry.get_margin()
                balance_data = await data_registry.get_balance()
                if margin_data:
                    used_margin = margin_data.get("used", 0.0)
                if balance_data:
                    current_balance = balance_data.get("equity", balance_data.get("total", 0.0))
            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏–∑ data_registry: {e}")
        
        # Fallback: –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ
        if current_balance == 0.0:
            logger.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback 1000.0")
            current_balance = 1000.0  # Fallback
        
        # ‚úÖ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç—Ä–µ–±—É–µ–º—É—é –º–∞—Ä–∂—É (—Å —É—á–µ—Ç–æ–º leverage)
        leverage = self.config.get("leverage", 5)  # –ò–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ fallback
        required_margin = position_size_usd / leverage
        
        # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∞—Ä–∂–∏
        available, reason = self.check_margin_available(required_margin, current_balance, used_margin)
        
        # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∞—Ä–∂–∏
        margin_ratio = self.get_margin_ratio(current_balance, used_margin + required_margin)
        max_margin_ratio = self.config.get("max_margin_ratio", 0.8)  # –ò–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ 80%
        
        if not available:
            logger.warning(f"‚ùå Margin unsafe: {reason}")
            return False
        
        if margin_ratio > max_margin_ratio:
            logger.warning(
                f"‚ùå Margin ratio too high: {margin_ratio:.2%} > {max_margin_ratio:.2%} "
                f"(balance=${current_balance:.2f}, used=${used_margin:.2f}, required=${required_margin:.2f})"
            )
            return False
        
        logger.debug(
            f"‚úÖ Margin safe: ratio={margin_ratio:.2%} <= {max_margin_ratio:.2%}, "
            f"available=${current_balance - used_margin:.2f} >= required=${required_margin:.2f}"
        )
        return True
        
    except Exception as e:
        logger.error(f"‚ùå Error in check_safety: {e}", exc_info=True)
        return False  # –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
```

**–í `risk_manager.py` –∏–∑–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤:**

```python
# –°—Ç—Ä–æ–∫–∞ 1724
return await self.margin_monitor.check_safety(
    position_size_usd, 
    current_positions,
    orchestrator=self.orchestrator,  # ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º orchestrator
    data_registry=self.data_registry  # ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º data_registry
)
```

---

## ‚úÖ –ü–†–û–ë–õ–ï–ú–ê #3: –ü–æ–∑–∏—Ü–∏–∏ –ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –Ω–∞ –ë–∏—Ä–∂–µ –ë–µ–∑ –£—á–∞—Å—Ç–∏—è –ë–æ—Ç–∞

### –í–∞—à –∞–Ω–∞–ª–∏–∑: ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
- –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ–∞–ª—å–Ω–∞ (3 —Å–ª—É—á–∞—è SOL-USDT –≤ –ª–æ–≥–∞—Ö)
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 5-7 —Å–µ–∫—É–Ω–¥ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞

### üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:

**–í –∫–æ–Ω—Ñ–∏–≥–µ —É–∂–µ –µ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**

```yaml
# config_futures.yaml —Å—Ç—Ä–æ–∫–∏ 147-169
positions_sync:
  base_interval_min: 5.0  # ‚úÖ –£–∂–µ 5 —Å–µ–∫—É–Ω–¥
  by_regime:
    ranging:
      interval_multiplier: 1.2  # = –∫–∞–∂–¥—ã–µ 6 —Å–µ–∫—É–Ω–¥
```

**–í –∫–æ–¥–µ –µ—Å—Ç—å `PrivateWebSocketManager`** (—Å—Ç—Ä–æ–∫–∞ 62 –≤ `orchestrator.py`), –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π.

### ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ç—á:

**1. –£–º–µ–Ω—å—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ:**

```yaml
# config_futures.yaml
positions_sync:
  base_interval_min: 1.0  # ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ —Å 5.0 –¥–æ 1.0 —Å–µ–∫—É–Ω–¥—ã
  by_regime:
    ranging:
      interval_multiplier: 1.0  # ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ —Å 1.2 –¥–æ 1.0 (= –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
```

**2. –î–æ–±–∞–≤–∏—Ç—å WebSocket –ø–æ–¥–ø–∏—Å–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å `PrivateWebSocketManager`):**

```python
# –í orchestrator.py, –º–µ—Ç–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket
if self.private_ws_manager:
    # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
    await self.private_ws_manager.subscribe(
        channel="positions",
        callback=self._on_position_update
    )

async def _on_position_update(self, message: Dict[str, Any]):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ WebSocket —Å–æ–±—ã—Ç–∏–π –ø–æ–∑–∏—Ü–∏–π"""
    try:
        if message.get("event") == "position" and message.get("action") == "close":
            symbol = message.get("instId", "").replace("-SWAP", "")
            logger.warning(
                f"üö® WebSocket: –ü–æ–∑–∏—Ü–∏—è {symbol} –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ! "
                f"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ..."
            )
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
            await self._sync_positions_with_exchange()
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ WebSocket —Å–æ–±—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏: {e}")
```

---

## ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê #4: –°–ª–∏—à–∫–æ–º –ë—ã—Å—Ç—Ä–æ–µ –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Stop Loss

### –í–∞—à –∞–Ω–∞–ª–∏–∑: ‚ö†Ô∏è **–ß–ê–°–¢–ò–ß–ù–û –ü–†–ê–í–ò–õ–¨–ù–û**

**–í–∞–∂–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ:**

–í –∫–æ–Ω—Ñ–∏–≥–µ **–£–ñ–ï –ï–°–¢–¨** ATR-based SL –¥–ª—è ranging —Ä–µ–∂–∏–º–∞:

```yaml
# config_futures.yaml —Å—Ç—Ä–æ–∫–∏ 315-318
ranging:
  sl_atr_based: true  # ‚úÖ –£–ñ–ï –í–ö–õ–Æ–ß–ï–ù–û!
  sl_atr_multiplier: 1.5  # ‚úÖ –£–ñ–ï –ù–ê–°–¢–†–û–ï–ù–û!
  sl_min_percent: 0.6  # ‚úÖ –£–ñ–ï –ï–°–¢–¨!
  sl_max_percent: 1.2  # ‚úÖ –£–ñ–ï –ï–°–¢–¨!
```

**–ù–û:** –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `min_holding_minutes: 0.5` (—Å—Ç—Ä–æ–∫–∞ 334) **—Å–ª–∏—à–∫–æ–º –º–∞–ª–æ** (30 —Å–µ–∫—É–Ω–¥).

### üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:

**–í `trailing_stop_loss.py` –µ—Å—Ç—å –∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è:**

- –°—Ç—Ä–æ–∫–∏ 676-692: `min_holding_minutes` –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ TSL
- **–ù–û:** –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è **–ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö** –ø–æ–∑–∏—Ü–∏–π (—Å—Ç—Ä–æ–∫–∞ 680: "–Ω–æ –ù–ï loss_cut")
- –î–ª—è **—É–±—ã—Ç–æ—á–Ω—ã—Ö** –ø–æ–∑–∏—Ü–∏–π –∑–∞—â–∏—Ç–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

### ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ç—á:

**1. –£–≤–µ–ª–∏—á–∏—Ç—å `min_holding_minutes` –≤ –∫–æ–Ω—Ñ–∏–≥–µ:**

```yaml
# config_futures.yaml —Å—Ç—Ä–æ–∫–∞ 334
ranging:
  min_holding_minutes: 1.0  # ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 0.5 –¥–æ 1.0 (60 —Å–µ–∫—É–Ω–¥)
```

**2. –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç —Ä–∞–Ω–Ω–µ–≥–æ SL –≤ `exit_analyzer.py`:**

```python
# –í –º–µ—Ç–æ–¥–µ _generate_exit_for_ranging, –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π SL
# –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 2923:

# ‚úÖ –ó–ê–©–ò–¢–ê –û–¢ –†–ê–ù–ù–ï–ì–û –ó–ê–ö–†–´–¢–ò–Ø –ü–û SL
min_holding_minutes = self.parameter_provider.get_exit_params(
    symbol or "", regime
).get("min_holding_minutes", 1.0)  # –ò–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ 1.0 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

if minutes_in_position is not None and minutes_in_position < min_holding_minutes:
    logger.debug(
        f"‚è±Ô∏è ExitAnalyzer RANGING: –ü–æ–∑–∏—Ü–∏—è {symbol} –¥–µ—Ä–∂–∏—Ç—Å—è "
        f"{minutes_in_position:.1f} –º–∏–Ω < {min_holding_minutes:.1f} –º–∏–Ω - "
        f"–∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞–Ω–Ω–µ–≥–æ SL –∞–∫—Ç–∏–≤–Ω–∞"
    )
    # –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ SL —Ä–∞–Ω—å—à–µ min_holding_minutes
    return {
        "action": "hold",
        "reason": "min_holding_protection",
        "minutes_in_position": minutes_in_position,
        "min_holding_minutes": min_holding_minutes,
        "regime": regime,
    }
```

**3. –£–≤–µ–ª–∏—á–∏—Ç—å `sl_atr_multiplier` –¥–ª—è ranging:**

```yaml
# config_futures.yaml —Å—Ç—Ä–æ–∫–∞ 316
ranging:
  sl_atr_multiplier: 2.0  # ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 1.5 –¥–æ 2.0 –¥–ª—è –±–æ–ª—å—à–µ–π –∑–∞—â–∏—Ç—ã
```

---

## ‚úÖ –ü–†–û–ë–õ–ï–ú–ê #5: –ù–∏–∑–∫–∞—è –ö–æ–Ω–≤–µ—Ä—Å–∏—è –°–∏–≥–Ω–∞–ª–æ–≤ –≤ –°–¥–µ–ª–∫–∏

### –í–∞—à –∞–Ω–∞–ª–∏–∑: ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∑–∫–∞—è (~3.1%)
- –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ - –æ—à–∏–±–∫–∞ `MarginMonitor.check_safety()` (#2)

### üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:

**–í –∫–æ–Ω—Ñ–∏–≥–µ —É–∂–µ –µ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

```yaml
# config_futures.yaml —Å—Ç—Ä–æ–∫–∏ 34-36
min_signal_strength: 0.7  # ‚úÖ –£–∂–µ –µ—Å—Ç—å
min_signal_strength_ranging: 0.7  # ‚úÖ –£–∂–µ –µ—Å—Ç—å
min_adx: 18.0  # ‚úÖ –£–∂–µ –µ—Å—Ç—å
```

**–ù–æ `cooldown_after_loss_minutes` –≤ ranging:**

```yaml
# config_futures.yaml —Å—Ç—Ä–æ–∫–∞ 325
ranging:
  cooldown_after_loss_minutes: 0.5  # ‚úÖ –£–ñ–ï –£–ú–ï–ù–¨–®–ï–ù–û –¥–æ 0.5 –º–∏–Ω!
```

### ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

**1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å #2 (MarginMonitor) - —ç—Ç–æ –≥–ª–∞–≤–Ω–æ–µ**

**2. –°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥–∏ (–Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ):**

```yaml
# config_futures.yaml
scalping:
  min_signal_strength: 0.65  # ‚úÖ –°–Ω–∏–∂–µ–Ω–æ —Å 0.7 –¥–æ 0.65 (–Ω–æ –Ω–µ –Ω–∏–∂–µ!)
  min_signal_strength_ranging: 0.65  # ‚úÖ –°–Ω–∏–∂–µ–Ω–æ —Å 0.7 –¥–æ 0.65
  min_adx: 16.0  # ‚úÖ –°–Ω–∏–∂–µ–Ω–æ —Å 18.0 –¥–æ 16.0 (–Ω–æ –Ω–µ –Ω–∏–∂–µ 15!)
```

**3. –£–≤–µ–ª–∏—á–∏—Ç—å `max_open_positions` –¥–ª—è small –±–∞–ª–∞–Ω—Å–∞:**

```yaml
# config_futures.yaml —Å—Ç—Ä–æ–∫–∞ 192
balance_profiles:
  small:
    max_open_positions: 8  # ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 6 –¥–æ 8
```

---

## ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê #6: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –°–∏–≥–Ω–∞–ª–∞

### –í–∞—à –∞–Ω–∞–ª–∏–∑: ‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û**

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
- ADX –≤–µ—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ 0.40 (—Å—Ç—Ä–æ–∫–∞ 31 –≤ `direction_analyzer.py`)
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç—Ä-—Ç—Ä–µ–Ω–¥–∞ –≤ trending –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–¥–µ—è

### üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:

**–í –∫–æ–Ω—Ñ–∏–≥–µ —É–∂–µ –µ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞:**

```yaml
# config_futures.yaml —Å—Ç—Ä–æ–∫–∏ 232-233
trending:
  block_counter_trend: true  # ‚úÖ –£–ñ–ï –í–ö–õ–Æ–ß–ï–ù–û!
  conflict_multiplier: 0.0   # ‚úÖ –£–ñ–ï –ù–ê–°–¢–†–û–ï–ù–û (–ø–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)!
```

**–ù–û:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ `SignalGenerator`, –∞ –Ω–µ `DirectionAnalyzer`.

### ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ç—á:

**1. –£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Å ADX –≤ `direction_analyzer.py`:**

```python
# –°—Ç—Ä–æ–∫–∞ 30-36
INDICATOR_WEIGHTS = {
    "adx": 0.50,  # ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 0.40 –¥–æ 0.50
    "ema": 0.25,  # –û—Å—Ç–∞–µ—Ç—Å—è
    "sma": 0.15,  # –û—Å—Ç–∞–µ—Ç—Å—è
    "price_action": 0.05,  # ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ —Å 0.10 –¥–æ 0.05
    "volume": 0.05,  # ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–æ —Å 0.10 –¥–æ 0.05
}
```

**2. –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∫–æ–Ω—Ç—Ä-—Ç—Ä–µ–Ω–¥–∞ –≤ `direction_analyzer.py`:**

```python
# –í –º–µ—Ç–æ–¥–µ analyze_direction, –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 184, –ø–µ—Ä–µ–¥ return:

# ‚úÖ –ë–õ–û–ö–ò–†–û–í–ö–ê –ö–û–ù–¢–†-–¢–†–ï–ù–î–ê –í TRENDING –†–ï–ñ–ò–ú–ï
if regime == "trending" and adx_value >= self.ADX_STRONG_THRESHOLD:
    # –ï—Å–ª–∏ ADX –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    if adx_direction == "bullish" and direction == "bearish":
        logger.debug(
            f"üö´ DirectionAnalyzer: –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä-—Ç—Ä–µ–Ω–¥ —Å–∏–≥–Ω–∞–ª –¥–ª—è {symbol} "
            f"(ADX={adx_value:.1f} bullish, –Ω–æ —Å–∏–≥–Ω–∞–ª bearish)"
        )
        return {
            "direction": "neutral",
            "confidence": 0.0,
            "reason": "Blocked counter-trend in trending regime",
            "adx_value": adx_value,
            "adx_direction": adx_direction,
            "blocked": True,
        }
    elif adx_direction == "bearish" and direction == "bullish":
        logger.debug(
            f"üö´ DirectionAnalyzer: –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä-—Ç—Ä–µ–Ω–¥ —Å–∏–≥–Ω–∞–ª –¥–ª—è {symbol} "
            f"(ADX={adx_value:.1f} bearish, –Ω–æ —Å–∏–≥–Ω–∞–ª bullish)"
        )
        return {
            "direction": "neutral",
            "confidence": 0.0,
            "reason": "Blocked counter-trend in trending regime",
            "adx_value": adx_value,
            "adx_direction": adx_direction,
            "blocked": True,
        }
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ù—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å `regime` –≤ –º–µ—Ç–æ–¥ `analyze_direction()`:

```python
def analyze_direction(
    self,
    candles: List[OHLCV],
    current_price: float,
    indicators: Optional[Dict[str, Any]] = None,
    regime: Optional[str] = None,  # ‚úÖ –ù–û–í–û–ï: –î–æ–±–∞–≤–∏—Ç—å regime
) -> Dict[str, Any]:
```

---

## üìã –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

| –ü—Ä–æ–±–ª–µ–º–∞ | –í–∞—à –∞–Ω–∞–ª–∏–∑ | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –î–æ–ø–æ–ª–Ω–µ–Ω–∏—è |
|----------|------------|--------|-----------|------------|
| #1: –¢–∏–ø—ã –≤ ExitAnalyzer | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ | –ö—Ä–∏—Ç–∏—á–Ω–æ | 1 | –ü—Ä–∏–º–µ–Ω–∏—Ç—å `_to_float()` –≤–µ–∑–¥–µ |
| #2: MarginMonitor.check_safety | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ | –ö—Ä–∏—Ç–∏—á–Ω–æ | 1 | –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–∞–ª–∞–Ω—Å—É —á–µ—Ä–µ–∑ orchestrator/data_registry |
| #3: –ó–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ –±–∏—Ä–∂–µ | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ | –í–∞–∂–Ω–æ | 2 | –£–º–µ–Ω—å—à–∏—Ç—å sync interval, –¥–æ–±–∞–≤–∏—Ç—å WebSocket |
| #4: –ë—ã—Å—Ç—Ä—ã–π SL | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –í–∞–∂–Ω–æ | 2 | ATR-based SL —É–∂–µ –µ—Å—Ç—å, —É–≤–µ–ª–∏—á–∏—Ç—å min_holding_minutes |
| #5: –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ | –í–∞–∂–Ω–æ | 2 | –ò—Å–ø—Ä–∞–≤–∏—Ç—å #2 –≥–ª–∞–≤–Ω–æ–µ, —Å–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥–∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ |
| #6: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ | –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | 3 | –£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Å ADX, –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤ DirectionAnalyzer |

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É):
1. ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ #1:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å `_to_float()` –≤–µ–∑–¥–µ –≤ `_get_max_holding_minutes()`
2. ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ #2:** –î–æ–±–∞–≤–∏—Ç—å `check_safety()` –≤ `MarginMonitor` —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –±–∞–ª–∞–Ω—Å—É

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ - –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã):
3. ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ #4:** –£–≤–µ–ª–∏—á–∏—Ç—å `min_holding_minutes` –¥–æ 1.0, —É–≤–µ–ª–∏—á–∏—Ç—å `sl_atr_multiplier` –¥–æ 2.0
4. ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ #3:** –£–º–µ–Ω—å—à–∏—Ç—å sync interval –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã, –¥–æ–±–∞–≤–∏—Ç—å WebSocket –ø–æ–¥–ø–∏—Å–∫—É
5. ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ #5:** –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è #2, —Å–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥–∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ - —É–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ):
6. ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ #6:** –£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Å ADX –¥–æ 0.50, –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∫–æ–Ω—Ç—Ä-—Ç—Ä–µ–Ω–¥–∞

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–í–∞—à –∞–Ω–∞–ª–∏–∑ –æ—Ç–ª–∏—á–Ω—ã–π!** –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–∞—Ç—á–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã. –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è:

1. **–ü—Ä–æ–±–ª–µ–º–∞ #1:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å `_to_float()` –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –∞ –≤–µ–∑–¥–µ –≥–¥–µ —á–∏—Ç–∞–µ—Ç—Å—è `max_holding_minutes`
2. **–ü—Ä–æ–±–ª–µ–º–∞ #2:** –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–∞–ª–∞–Ω—Å—É —á–µ—Ä–µ–∑ `orchestrator` –∏–ª–∏ `data_registry`
3. **–ü—Ä–æ–±–ª–µ–º–∞ #4:** ATR-based SL —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ, –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏—Ç—å `min_holding_minutes` –∏ `sl_atr_multiplier`
4. **–ü—Ä–æ–±–ª–µ–º–∞ #6:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç—Ä-—Ç—Ä–µ–Ω–¥–∞ —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ, –Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ `DirectionAnalyzer` –¥–ª—è –¥–≤–æ–π–Ω–æ–π –∑–∞—â–∏—Ç—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ 1, –∑–∞—Ç–µ–º –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2, –∑–∞—Ç–µ–º –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3.

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 28.12.2025  
**–ê–≤—Ç–æ—Ä –æ—Ü–µ–Ω–∫–∏:** AI Assistant (DeepSeek)




