# ИТОГОВЫЙ СПИСОК ЗАДАЧ

**Дата:** 2025-12-21  
**Статус:** Готов к реализации

---

## ПРИОРИТЕТ 1: КРИТИЧНЫЕ ИСПРАВЛЕНИЯ

### 1.1. Исправить ошибку форматирования в AdaptiveLeverage
**Файл:** `src/strategies/scalping/futures/risk/adaptive_leverage.py`  
**Проблема:** Строка 109 - ошибка в f-string с тернарным оператором  
**Исправление:**
```python
# БЫЛО:
f"volatility={volatility:.4f if volatility else 'N/A'}, "

# ДОЛЖНО БЫТЬ:
volatility_str = f"{volatility:.4f}" if volatility is not None else "N/A"
f"volatility={volatility_str}, "
```
**Время:** 10 минут

---

### 1.2. Исправить чтение leverage с биржи
**Файл:** `src/strategies/scalping/futures/position_manager.py` (строка 724)  
**Проблема:** Поле `lever` может быть "0" или отсутствовать  
**Исправление:** Проверять разные поля, использовать fallback значения  
**Время:** 20 минут

---

### 1.3. Исправить расчет position_value
**Файл:** `src/strategies/scalping/futures/position_manager.py` (строка 910)  
**Проблема:** Может быть разница в 100 раз из-за неправильного учета ctVal  
**Исправление:** Добавить проверки и логирование, валидацию результата  
**Время:** 30 минут

---

### 1.4. Исправить race conditions в DRIFT_ADD/REMOVE
**Файл:** `src/strategies/scalping/futures/orchestrator.py`  
**Проблема:** Гонки при синхронизации позиций  
**Исправление:** Добавить блокировки на символ в PositionRegistry  
**Время:** 30 минут

---

### 1.5. Добавить минимальную стоимость для Partial TP
**Файл:** `src/strategies/scalping/futures/position_manager.py` (метод `close_partial_position`)  
**Проблема:** Частичное закрытие на малых позициях ($1) - комиссии съедают прибыль  
**Исправление:** 
- Добавить проверку минимальной стоимости ($3/$5/$10 адаптивно)
- Адаптивно по балансу: small=$3, medium=$5, large=$10
- Если меньше минимума → не закрывать частично
**Время:** 30 минут

---

## ПРИОРИТЕТ 2: LEVERAGE ВАЛИДАЦИЯ И ОКРУГЛЕНИЕ

### 2.1. Добавить получение доступных leverage с биржи
**Файл:** `src/clients/futures_client.py`  
**Новый метод:** `get_instrument_leverage_info(symbol)`  
**Функционал:**
- Получает `maxLever` из `/api/v5/public/instruments`
- Генерирует список доступных leverage: [1, 2, 3, 5, 10, 20, 50, 75, 100, 125] до максимума
- Кэширует результат
**Время:** 40 минут

---

### 2.2. Добавить округление leverage до ближайшего доступного
**Файл:** `src/clients/futures_client.py`  
**Новый метод:** `round_leverage_to_available(symbol, desired_leverage)`  
**Функционал:**
- Округляет leverage до ближайшего доступного для символа
- Если превышает максимум → ограничивает до максимума
- Детальное логирование процесса
**Время:** 30 минут

---

### 2.3. Обновить get_instrument_details для включения leverage info
**Файл:** `src/clients/futures_client.py`  
**Изменение:** Добавить `max_leverage` и `available_leverages` в возвращаемый dict  
**Время:** 20 минут

---

### 2.4. Интегрировать округление leverage в AdaptiveLeverage
**Файл:** `src/strategies/scalping/futures/risk/adaptive_leverage.py`  
**Изменение:**
- Добавить параметр `client` в `calculate_leverage()`
- После расчета leverage → округлить до доступного
- Детальное логирование всех этапов
**Время:** 30 минут

---

### 2.5. Интегрировать округление leverage в SignalCoordinator
**Файл:** `src/strategies/scalping/futures/coordinators/signal_coordinator.py`  
**Изменение:**
- Передать `client` в `calculate_leverage()`
- Дополнительная проверка leverage перед установкой
- Логирование финального leverage
**Время:** 20 минут

---

## ПРИОРИТЕТ 3: POSITIONSCALINGMANAGER (ЛЕСТНИЧНОЕ ДОБАВЛЕНИЕ)

### 3.1. Создать модуль PositionScalingManager
**Новый файл:** `src/strategies/scalping/futures/positions/position_scaling_manager.py`  
**Функционал:**
- Расчет размера добавления по лестнице (7 уровней: [1.0, 0.8, 0.6, 0.4, 0.3, 0.2, 0.15])
- Адаптация по балансу и режиму
- Хранение истории добавлений
- Детальное логирование всех операций
**Время:** 2-3 часа

---

### 3.2. Реализовать проверки для добавления к позиции
**Файл:** `src/strategies/scalping/futures/positions/position_scaling_manager.py`  
**Метод:** `can_add_to_position()`  
**Проверки:**
1. Количество добавлений (максимум 7)
2. Интервал (минимум 30 секунд)
3. Убыток (не больше -3%)
4. Доступная маржа
5. Максимальный размер позиции
6. Максимальная маржа на позицию
7. Общий лимит позиций
8. **Использование leverage существующей позиции** (критично!)
**Время:** 1-2 часа

---

### 3.3. Реализовать расчет размера добавления с учетом leverage позиции
**Файл:** `src/strategies/scalping/futures/positions/position_scaling_manager.py`  
**Метод:** `calculate_next_addition_size()`  
**Логика:**
- Получает leverage существующей позиции
- Переопределяет leverage в сигнале на leverage позиции
- Рассчитывает размер по лестнице с учетом leverage позиции
- Проверяет все лимиты
**Время:** 1 час

---

### 3.4. Интегрировать PositionScalingManager в SignalCoordinator
**Файл:** `src/strategies/scalping/futures/coordinators/signal_coordinator.py`  
**Изменение:**
- Вместо блокировки нового сигнала в том же направлении → проверка возможности добавления
- Если можно добавить → вызов `PositionScalingManager.calculate_next_addition_size()`
- Размещение ордера с рассчитанным размером
**Время:** 1 час

---

### 3.5. Добавить параметры в конфиг
**Файл:** `config/config_futures.yaml`  
**Новая секция:** `position_scaling`  
**Параметры:**
- `max_additions`: 7
- `min_interval_seconds`: 30
- `max_loss_for_addition`: -3.0%
- `ladder`: [1.0, 0.8, 0.6, 0.4, 0.3, 0.2, 0.15]
- Адаптивность по балансу и режиму
**Время:** 30 минут

---

### 3.6. Обновить PositionRegistry для хранения истории добавлений
**Файл:** `src/strategies/scalping/futures/core/position_registry.py`  
**Изменение:**
- Добавить поле `scaling_history` в метаданные
- Метод `add_scaling_entry()` для записи добавления
**Время:** 30 минут

---

### 3.7. Обновить RiskManager для расчета max_margin_per_position
**Файл:** `src/strategies/scalping/futures/risk_manager.py`  
**Новый метод:** `calculate_max_margin_per_position()`  
**Логика:**
- По балансу: small=15%, medium=20%, large=25%
- Корректировка по режиму: trending=+5%, choppy=-5%
**Время:** 30 минут

---

### 3.8. Обновить MarginCalculator для проверки возможности добавления маржи
**Файл:** `src/strategies/scalping/futures/calculations/margin_calculator.py`  
**Новый метод:** `can_add_margin()`  
**Время:** 30 минут

---

## ПРИОРИТЕТ 4: АВТОНОМНЫЕ РЕШЕНИЯ

### 4.1. Автономная оптимизация размера позиции на основе дневного PnL
**Файл:** `src/strategies/scalping/futures/risk_manager.py` (или новый модуль)  
**Функционал:**
- Анализ последних сделок
- Если дневной PnL отрицательный → уменьшить базовый размер на 20%
- Если дневной PnL положительный → можно увеличить на 10%
- Контроль границ (не меньше 50%, не больше 150% от базового)
**Время:** 2-3 часа

---

### 4.2. Автономная коррекция TP/SL на основе волатильности
**Файл:** `src/strategies/scalping/futures/positions/exit_analyzer.py` или новый модуль  
**Функционал:**
- Если волатильность увеличилась → расширить SL, поднять TP
- Если волатильность уменьшилась → сузить SL, снизить TP
- Только для прибыльных позиций
- Максимальная коррекция ±20% от исходных TP/SL
- Не чаще чем раз в 5 минут
**Время:** 2-3 часа

---

## ПРИОРИТЕТ 5: ДЕТАЛЬНОЕ ЛОГИРОВАНИЕ

### 5.1. Добавить детальное логирование в AdaptiveLeverage
**Файл:** `src/strategies/scalping/futures/risk/adaptive_leverage.py`  
**Логи:**
- Расчет leverage (strength → category → leverage)
- Корректировки (regime, volatility)
- Округление (желаемый → округленный)
**Префикс:** `[ADAPTIVE_LEVERAGE]`  
**Время:** 20 минут

---

### 5.2. Добавить детальное логирование в PositionScalingManager
**Файл:** `src/strategies/scalping/futures/positions/position_scaling_manager.py`  
**Логи:**
- Начало проверки добавления
- Расчет размера (лестница, коэффициенты)
- Расчет маржи (с leverage)
- Проверка лимитов
- Использование leverage позиции
- Финальное решение (разрешено/заблокировано)
**Префикс:** `[POSITION_SCALING]`  
**Время:** 30 минут (входит в создание модуля)

---

### 5.3. Добавить детальное логирование leverage операций
**Файлы:** 
- `src/clients/futures_client.py` - префикс `[LEVERAGE_INFO]`, `[LEVERAGE_ROUND]`, `[SET_LEVERAGE]`
- `src/strategies/scalping/futures/coordinators/signal_coordinator.py` - префикс `[LEVERAGE_FINAL]`
**Время:** 20 минут (входит в предыдущие задачи)

---

## ИТОГО: ОЦЕНКА ВРЕМЕНИ

### Приоритет 1 (Критичные исправления): ~2 часа
- 1.1: 10 мин
- 1.2: 20 мин
- 1.3: 30 мин
- 1.4: 30 мин
- 1.5: 30 мин

### Приоритет 2 (Leverage валидация): ~2.5 часа
- 2.1: 40 мин
- 2.2: 30 мин
- 2.3: 20 мин
- 2.4: 30 мин
- 2.5: 20 мин

### Приоритет 3 (PositionScalingManager): ~6-8 часов
- 3.1: 2-3 часа
- 3.2: 1-2 часа
- 3.3: 1 час
- 3.4: 1 час
- 3.5: 30 мин
- 3.6: 30 мин
- 3.7: 30 мин
- 3.8: 30 мин

### Приоритет 4 (Автономные решения): ~4-6 часов
- 4.1: 2-3 часа
- 4.2: 2-3 часа

### Приоритет 5 (Логирование): входит в предыдущие задачи

---

## ОБЩЕЕ ВРЕМЯ: ~14-18 часов работы

---

## ПОРЯДОК ВЫПОЛНЕНИЯ

### Этап 1: Критичные исправления (2 часа)
1. Исправить все 5 критичных ошибок
2. Протестировать каждое исправление

### Этап 2: Leverage валидация (2.5 часа)
1. Добавить методы в OKXFuturesClient
2. Интегрировать в AdaptiveLeverage
3. Интегрировать в SignalCoordinator
4. Протестировать на разных символах

### Этап 3: PositionScalingManager (6-8 часов)
1. Создать модуль
2. Реализовать все методы
3. Интегрировать в SignalCoordinator
4. Добавить параметры в конфиг
5. Обновить связанные модули
6. Протестировать лестничное добавление

### Этап 4: Автономные решения (4-6 часов, опционально)
1. Реализовать оптимизацию размера позиции
2. Реализовать коррекцию TP/SL
3. Протестировать

---

## ЧЕКЛИСТ ПЕРЕД НАЧАЛОМ

- [ ] Все задачи понятны
- [ ] Параметры согласованы (7 добавлений, 30 сек, -3%, лестница)
- [ ] Leverage валидация понятна
- [ ] Логирование понятно
- [ ] Математика понятна
- [ ] Готов начать с Приоритета 1

---

## ВАЖНЫЕ МОМЕНТЫ

1. **Leverage позиции:** При добавлении всегда использовать leverage существующей позиции
2. **Округление leverage:** Округлять до ближайшего доступного на бирже
3. **Минимальная стоимость Partial TP:** Адаптивно по балансу ($3/$5/$10)
4. **Лестница:** [1.0, 0.8, 0.6, 0.4, 0.3, 0.2, 0.15] для 7 уровней
5. **Логирование:** Все операции с префиксами для поиска

