# ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê

**–î–∞—Ç–∞:** 30.11.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìä **–ß–¢–û –î–û–ë–ê–í–õ–ï–ù–û**

### 1. **Memory Usage –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚úÖ

**–§–∞–π–ª:** `src/strategies/scalping/futures/core/trading_control_center.py`

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (MB)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π –≤ `PositionRegistry`
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ `asyncio`

**–ß–∞—Å—Ç–æ—Ç–∞:** –†–∞–∑ –≤ 10 –º–∏–Ω—É—Ç

**–£—Ä–æ–≤–µ–Ω—å:** `INFO`

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
üíæ Memory Usage: 125.3 MB, Positions: 3, Metadata: 3, Tasks: 15
```

**–ö–æ–¥:**
```python
async def _log_memory_usage(self) -> None:
    """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ memory leak."""
    process = psutil.Process(os.getpid())
    memory_mb = process.memory_info().rss / 1024 / 1024
    positions_count = len(await self.position_registry.get_all_positions())
    tasks_count = len(asyncio.all_tasks())
    metadata_count = len(self.position_registry._metadata)
    
    logger.info(
        f"üíæ Memory Usage: {memory_mb:.1f} MB, "
        f"Positions: {positions_count}, "
        f"Metadata: {metadata_count}, "
        f"Tasks: {tasks_count}"
    )
```

---

### 2. **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** ‚úÖ

**–§–∞–π–ª:** `src/strategies/scalping/futures/core/trading_control_center.py`

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–∏–∫–ª–∞ TCC (–º—Å)
- –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (–º—Å)
- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (–º—Å)
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (–º—Å)
- –í—Ä–µ–º—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏—è–º–∏ (–º—Å)
- –í—Ä–µ–º—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ä–¥–µ—Ä–æ–≤ (–º—Å)

**–ß–∞—Å—Ç–æ—Ç–∞:** –ö–∞–∂–¥—ã–π —Ü–∏–∫–ª

**–£—Ä–æ–≤–µ–Ω—å:** `DEBUG`

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
‚è±Ô∏è TCC Performance: cycle=245.3ms, state=12.1ms, signals=180.5ms, process=15.2ms, manage=28.7ms, monitor=8.8ms
```

**–ö–æ–¥:**
```python
cycle_start_time = time.perf_counter()
# ... –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–≥–æ–≤ ...
cycle_time = (time.perf_counter() - cycle_start_time) * 1000

logger.debug(
    f"‚è±Ô∏è TCC Performance: cycle={cycle_time:.1f}ms, "
    f"state={state_time:.1f}ms, signals={signals_time:.1f}ms, "
    f"process={process_time:.1f}ms, manage={manage_time:.1f}ms, "
    f"monitor={monitor_time:.1f}ms"
)
```

---

### 3. **–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å** ‚úÖ

**–§–∞–π–ª:** `src/strategies/scalping/futures/order_executor.py`

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- –î–µ—Ç–µ–∫—Ü–∏—è –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (>5% –∑–∞ –ø–µ—Ä–∏–æ–¥)
- ATR –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
- –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞
- –ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ATR

**–ß–∞—Å—Ç–æ—Ç–∞:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–∞—Å—á—ë—Ç–µ TP/SL, –µ—Å–ª–∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å >5%

**–£—Ä–æ–≤–µ–Ω—å:** `WARNING`

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –¥–ª—è BTC-USDT: ATR=6.23%, entry_price=110000.00, ATR_abs=6853.00
```

**–ö–æ–¥:**
```python
atr_percent = (atr / entry_price) * 100 if entry_price > 0 else 0
if atr_percent > 5.0:  # > 5% –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
    logger.warning(
        f"‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –¥–ª—è {symbol}: "
        f"ATR={atr_percent:.2f}%, entry_price={entry_price:.2f}, "
        f"ATR_abs={atr:.2f}"
    )
```

---

## üì¶ **–ó–ê–í–ò–°–ò–ú–û–°–¢–ò**

### –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `requirements.txt`:

```txt
psutil==5.9.6  # ‚úÖ –ù–û–í–û–ï: –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è memory usage
```

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
pip install psutil==5.9.6
```

---

## üîç **–ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨**

### 1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ Memory Leak**

**–ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:**
- –†–æ—Å—Ç `Memory Usage` —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
- –†–æ—Å—Ç `Positions` –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è
- –†–æ—Å—Ç `Metadata` –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è
- –†–æ—Å—Ç `Tasks` –±–µ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
```bash
grep "üíæ Memory Usage" logs/futures/futures_main_*.log
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- Memory Usage —Å—Ç–∞–±–∏–ª—å–Ω–∞ (¬±10-20 MB)
- Positions –Ω–µ —Ä–∞—Å—Ç—É—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- Tasks –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è

---

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

**–ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:**
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–∏–∫–ª–∞ (`cycle`)
- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (`signals`)
- –í—Ä–µ–º—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏—è–º–∏ (`manage`)

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
```bash
grep "‚è±Ô∏è TCC Performance" logs/futures/futures_main_*.log | tail -20
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- `cycle` < 1000ms (1 —Å–µ–∫—É–Ω–¥–∞)
- `signals` < 500ms
- `manage` < 200ms

---

### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏**

**–ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:**
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
- –†–µ–∞–∫—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –≤—ã—Å–æ–∫—É—é –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
```bash
grep "‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å" logs/futures/futures_main_*.log
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
- Fallback –Ω–∞ `sl_percent` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ExitAnalyzer –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏

---

## ‚úÖ **–ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê**

| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | –§–∞–π–ª | –£—Ä–æ–≤–µ–Ω—å | –ß–∞—Å—Ç–æ—Ç–∞ | –°—Ç–∞—Ç—É—Å |
|-------------|------|---------|---------|--------|
| **Memory Usage** | `trading_control_center.py` | `INFO` | –†–∞–∑ –≤ 10 –º–∏–Ω | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | `trading_control_center.py` | `DEBUG` | –ö–∞–∂–¥—ã–π —Ü–∏–∫–ª | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ |
| **–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å** | `order_executor.py` | `WARNING` | –ü—Ä–∏ >5% | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ |

---

## üéØ **–ü–û–ö–†–´–¢–ò–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø**

### ‚úÖ **–¢–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**

1. ‚úÖ Memory usage (MB, –ø–æ–∑–∏—Ü–∏–∏, –∑–∞–¥–∞—á–∏)
2. ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤—Ä–µ–º—è —Ü–∏–∫–ª–æ–≤)
3. ‚úÖ –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (>5%)
4. ‚úÖ ExitAnalyzer —Ä–µ—à–µ–Ω–∏—è (action, reason, PnL)
5. ‚úÖ TrailingSL –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ç—Ä–µ–π–ª, –ø—Ä–æ—Ñ–∏—Ç)
6. ‚úÖ PositionRegistry –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ)
7. ‚úÖ OrderExecutor –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ (—Å–∏–≥–Ω–∞–ª—ã, –æ—Ä–¥–µ—Ä–∞)
8. ‚úÖ TP/SL —Ä–∞—Å—á—ë—Ç—ã (–≤–∫–ª—é—á–∞—è fallback)

---

## üìã **–ß–ï–ö–õ–ò–°–¢ –ü–†–û–í–ï–†–ö–ò**

### –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å:

- [ ] Memory usage –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∂–¥—ã–π —Ü–∏–∫–ª
- [ ] –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ >5%
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞ `psutil`
- [ ] –õ–æ–≥–∏ —á–∏—Ç–∞–µ–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 30.11.2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ



