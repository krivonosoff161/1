# üîß –ü–õ–ê–ù –£–õ–£–ß–®–ï–ù–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- ‚úÖ XRP-USDT: –õ–æ–≥–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞–π–¥–µ–Ω—ã –≤ `futures_main_2025-12-21.log`
- ‚ùå SOL-USDT: –õ–æ–≥–∏ –∑–∞–∫—Ä—ã—Ç–∏—è **–ù–ï –Ω–∞–π–¥–µ–Ω—ã** –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–æ–≥-—Ñ–∞–π–ª–µ
- ‚úÖ –î–∞–Ω–Ω—ã–µ –≤ `trades_2025-12-21.csv` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è –æ–±–µ–∏—Ö –ø–æ–∑–∏—Ü–∏–π

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω –∑–∞–∫—Ä—ã—Ç–∏—è SOL
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ (PH, PD, Partial TP)
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏ –º–æ–≥—É—Ç –Ω–µ –ø–æ–ø–∞–¥–∞—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –∏–∑-–∑–∞:
- –†–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
- –û—à–∏–±–æ–∫ –∑–∞–ø–∏—Å–∏
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å **–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ª–æ–≥–æ–≤** –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç:

```python
# –í close_position_manually (position_manager.py:5917)
logger.info("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
logger.info(f"üí∞ –ü–û–ó–ò–¶–ò–Ø –ó–ê–ö–†–´–¢–ê: {symbol} {side.upper()}")
logger.info("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")

# ‚úÖ –ù–û–í–û–ï: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –∑–∞–∫—Ä—ã—Ç–∏–π
logger_closures = logging.getLogger("position_closures")
logger_closures.info(f"[CLOSURE] {symbol} {side.upper()} | {reason} | {close_time}")
```

---

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ JSON

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ —Å–ª–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–∫—Ä—ã—Ç–∏–π:

```python
# –í close_position_manually
closure_data = {
    "timestamp": close_time.isoformat(),
    "symbol": symbol,
    "side": side.upper(),
    "reason": reason,
    "entry_price": entry_price,
    "exit_price": exit_price,
    "gross_pnl": gross_pnl,
    "net_pnl": net_pnl,
    "commission": commission,
    "margin_used": margin_used,
    "duration_sec": duration_sec,
    "regime": regime,
    "leverage": position.get("leverage", "unknown"),
    "signal_strength": position.get("signal_strength", 0.0),
}

# –ó–∞–ø–∏—Å—å –≤ JSON —Ñ–∞–π–ª
closures_file = f"logs/futures/structured/position_closures_{datetime.now().strftime('%Y-%m-%d')}.jsonl"
with open(closures_file, "a") as f:
    f.write(json.dumps(closure_data) + "\n")
```

---

### 3. –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ orchestrator._close_position

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `orchestrator._close_position` (—Å—Ç—Ä–æ–∫–∞ 3852) –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

```python
# –í orchestrator._close_position (—Å—Ç—Ä–æ–∫–∞ 3852)
logger.info(
    f"üõë –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ {symbol}: {reason} "
    f"(side={side}, size={size}, entry={entry_price}, time={minutes_in_position:.2f} –º–∏–Ω)"
)

# ‚úÖ –ù–û–í–û–ï: –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
logger.info(
    f"üìä [PRE_CLOSE] {symbol}: "
    f"PnL={final_pnl:.2f} USDT, "
    f"margin={margin_used:.2f} USDT, "
    f"regime={regime}, "
    f"leverage={leverage}x, "
    f"signal_strength={signal_strength:.2f}"
)
```

---

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—É—Ç–µ–π –∑–∞–∫—Ä—ã—Ç–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∑–∏—Ü–∏–∏ –º–æ–≥—É—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:
- `close_position_manually` (Trailing SL, Max Holding)
- `_close_position_by_reason` (PH, PD, TP, SL)
- –ü—Ä—è–º–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –Ω–∞ –±–∏—Ä–∂–µ (—Ä–µ–¥–∫–æ)

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
# –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ _log_position_closure –≤ position_manager.py
async def _log_position_closure(
    self,
    symbol: str,
    reason: str,
    entry_price: float,
    exit_price: float,
    gross_pnl: float,
    net_pnl: float,
    commission: float,
    margin_used: float,
    duration_sec: float,
    regime: str = "unknown",
    **kwargs
):
    """–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∑–∞–∫—Ä—ã—Ç–∏–π –ø–æ–∑–∏—Ü–∏–π"""
    
    # 1. –û—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥ (—É–∂–µ –µ—Å—Ç—å)
    logger.info("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    logger.info(f"üí∞ –ü–û–ó–ò–¶–ò–Ø –ó–ê–ö–†–´–¢–ê: {symbol} {side.upper()}")
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
    
    # 2. JSON –ª–æ–≥ (–Ω–æ–≤–æ–µ)
    closure_data = {
        "timestamp": datetime.now(timezone.utc).isoformat(),
        "symbol": symbol,
        "reason": reason,
        "entry_price": entry_price,
        "exit_price": exit_price,
        "gross_pnl": gross_pnl,
        "net_pnl": net_pnl,
        "commission": commission,
        "margin_used": margin_used,
        "duration_sec": duration_sec,
        "regime": regime,
        **kwargs
    }
    
    # –ó–∞–ø–∏—Å—å –≤ JSONL —Ñ–∞–π–ª
    closures_file = f"logs/futures/structured/position_closures_{datetime.now().strftime('%Y-%m-%d')}.jsonl"
    try:
        with open(closures_file, "a", encoding="utf-8") as f:
            f.write(json.dumps(closure_data, ensure_ascii=False) + "\n")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ JSON –ª–æ–≥–∞ –∑–∞–∫—Ä—ã—Ç–∏—è: {e}")
    
    # 3. CSV –ª–æ–≥ (—É–∂–µ –µ—Å—Ç—å —á–µ—Ä–µ–∑ performance_tracker)
    # –ù–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π CSV –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏–π
```

---

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏ –º–æ–≥—É—Ç –Ω–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏ fallback:

```python
# –í close_position_manually, –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
try:
    # –û—Å–Ω–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logger.info("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    logger.info(f"üí∞ –ü–û–ó–ò–¶–ò–Ø –ó–ê–ö–†–´–¢–ê: {symbol} {side.upper()}")
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
    
    # ‚úÖ –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ª–æ–≥–∏ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å
    if not logger.handlers:
        # Fallback: –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é
        with open(f"logs/futures/emergency_closures_{datetime.now().strftime('%Y-%m-%d')}.log", "a") as f:
            f.write(f"[{datetime.now()}] –ü–û–ó–ò–¶–ò–Ø –ó–ê–ö–†–´–¢–ê: {symbol} {side.upper()}\n")
            
except Exception as e:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è - –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ emergency —Ñ–∞–π–ª
    try:
        with open(f"logs/futures/emergency_closures_{datetime.now().strftime('%Y-%m-%d')}.log", "a") as f:
            f.write(f"[{datetime.now()}] –û–®–ò–ë–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø: {symbol} - {e}\n")
    except:
        pass  # –ï—Å–ª–∏ –¥–∞–∂–µ emergency —Ñ–∞–π–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
```

---

## üìä –ü–†–ò–û–†–ò–¢–ï–¢–´ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò (–û–ë–ù–û–í–õ–ï–ù–û –° –£–ß–ï–¢–û–ú –ê–ù–ê–õ–ò–ó–ê –ì–†–û–ö–ê)

### üî¥ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û - —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –°–ï–ô–ß–ê–°, 1-2 —á–∞—Å–∞):

1. **–î–æ–±–∞–≤–∏—Ç—å JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏–π** (30 –º–∏–Ω) ‚úÖ –û—Ç –ö—É—Ä—Å–æ—Ä–∞
   - –°–æ–∑–¥–∞—Ç—å `logs/futures/structured/position_closures_YYYY-MM-DD.jsonl`
   - –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
   - –õ–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

2. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ orchestrator._close_position** (15 –º–∏–Ω) ‚úÖ –û—Ç –ö—É—Ä—Å–æ—Ä–∞
   - –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º (PnL, margin, regime, leverage)
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ª–æ–≥–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª

3. **üî¥ –ö–†–ò–¢–ò–ß–ù–û: Exchange-side closure detection** (30 –º–∏–Ω) ‚ùå –û—Ç –ì—Ä–æ–∫–∞
   - Polling –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –±–∏—Ä–∂–µ (TSL, Liquidation, Manual, ADL)
   - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –ø—Ä–æ—à–ª–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–∫–∏—Ö –∑–∞–∫—Ä—ã—Ç–∏–π —Å –ø–æ–º–µ—Ç–∫–æ–π "EXCHANGE_SIDE"
   - **–≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç —Å–ª—É—á–∞–π SOL!**

4. **üî¥ –ö–†–ò–¢–ò–ß–ù–û: Partial TP logging** (15 –º–∏–Ω) ‚ùå –û—Ç –ì—Ä–æ–∫–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ Partial TP (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è)
   - JSON-–ª–æ–≥–∏ –¥–ª—è Partial TP –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
   - Tracking –æ—Å—Ç–∞—Ç–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ Partial TP

### üü† –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–ê–ñ–ù–û - —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è-–∑–∞–≤—Ç—Ä–∞, 2-3 —á–∞—Å–∞):

5. **–°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** (1 —á–∞—Å) ‚úÖ –û—Ç –ö—É—Ä—Å–æ—Ä–∞
   - –ú–µ—Ç–æ–¥ `_log_position_closure` –≤ `position_manager.py`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –∑–∞–∫—Ä—ã—Ç–∏—è

6. **–î–æ–±–∞–≤–∏—Ç—å emergency fallback –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** (30 –º–∏–Ω) ‚úÖ –û—Ç –ö—É—Ä—Å–æ—Ä–∞
   - –ó–∞–ø–∏—Å—å –≤ emergency —Ñ–∞–π–ª –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

7. **Consistency check** (30 –º–∏–Ω) ‚ùå –û—Ç –ì—Ä–æ–∫–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ –í–û –í–°–ï–• –º–µ—Å—Ç–∞—Ö (main_log, json_log, csv_log)
   - Alert –ø—Ä–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –ª–æ–≥–∞—Ö

8. **Pre-close state logging** (15 –º–∏–Ω) ‚ùå –û—Ç –ì—Ä–æ–∫–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ü–ï–†–ï–î –∑–∞–∫—Ä—ã—Ç–∏–µ–º (unrealized PnL, thresholds, exit analyzer state)
   - –ü–æ–º–æ–≥–∞–µ—Ç –≤ debugging –∏ –∞–Ω–∞–ª–∏–∑–µ

### üü° –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û):

9. **–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π logger –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏–π** (30 –º–∏–Ω) ‚úÖ –û—Ç –ö—É—Ä—Å–æ—Ä–∞
   - `logger_closures = logging.getLogger("position_closures")`
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏–π

10. **Telegram alerts** (1 —á–∞—Å) ‚ùå –û—Ç –ì—Ä–æ–∫–∞
    - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

11. **Web dashboard** (4-8 —á–∞—Å–æ–≤) ‚ùå –û—Ç –ì—Ä–æ–∫–∞
    - Real-time –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. ‚úÖ **–í—Å–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è** –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª
2. ‚úÖ **JSON-–ª–æ–≥–∏** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
3. ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
4. ‚úÖ **Emergency fallback** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
5. ‚úÖ **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** –¥–ª—è –≤—Å–µ—Ö –ø—É—Ç–µ–π –∑–∞–∫—Ä—ã—Ç–∏—è

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
# –ê–Ω–∞–ª–∏–∑ –∑–∞–∫—Ä—ã—Ç–∏–π –∏–∑ JSON
import json

closures = []
with open("logs/futures/structured/position_closures_2025-12-21.jsonl") as f:
    for line in f:
        closures.append(json.loads(line))

# –§–∏–ª—å—Ç—Ä –ø–æ —Å–∏–º–≤–æ–ª—É
sol_closures = [c for c in closures if c["symbol"] == "SOL-USDT"]
print(f"SOL –∑–∞–∫—Ä—ã—Ç–∏–π: {len(sol_closures)}")
for closure in sol_closures:
    print(f"  {closure['timestamp']}: {closure['reason']}, PnL={closure['net_pnl']:.2f}")
```

---

## üìù –§–ê–ô–õ–´ –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø

1. `src/strategies/scalping/futures/position_manager.py`
   - –ú–µ—Ç–æ–¥ `close_position_manually` (—Å—Ç—Ä–æ–∫–∞ 5638)
   - –î–æ–±–∞–≤–∏—Ç—å JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `_log_position_closure`

2. `src/strategies/scalping/futures/orchestrator.py`
   - –ú–µ—Ç–æ–¥ `_close_position` (—Å—Ç—Ä–æ–∫–∞ 3800)
   - –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º

3. `src/strategies/scalping/futures/position_manager.py`
   - –ú–µ—Ç–æ–¥ `_close_position_by_reason` (—Å—Ç—Ä–æ–∫–∞ 3671)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

---

---

## üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –î–û–ü–û–õ–ù–ï–ù–ò–Ø –û–¢ –ì–†–û–ö–ê

### 1. Exchange-side closure detection (–ö–†–ò–¢–ò–ß–ù–û!)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∑–∏—Ü–∏–∏ –º–æ–≥—É—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è –Ω–∞ –±–∏—Ä–∂–µ (TSL, Liquidation, Manual, ADL), –Ω–æ –±–æ—Ç –æ–± —ç—Ç–æ–º –Ω–µ –∑–Ω–∞–µ—Ç!

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í orchestrator.py, –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥
async def _check_exchange_closures(self):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –±–∏—Ä–∂–µ (–Ω–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞)"""
    
    # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–∏
    exchange_positions = await self.futures_client.get_positions()
    exchange_symbols = {pos["instId"].replace("-SWAP", "") for pos in exchange_positions if float(pos.get("pos", "0")) != 0}
    
    # –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏
    local_symbols = set(self.active_positions.keys())
    closed_on_exchange = local_symbols - exchange_symbols
    
    for symbol in closed_on_exchange:
        # –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –±–∏—Ä–∂–µ, –Ω–æ –ù–ï —á–µ—Ä–µ–∑ –±–æ—Ç–∞!
        logger.critical("="*80)
        logger.critical(f"üö® –û–ë–ù–ê–†–£–ñ–ï–ù–û –ó–ê–ö–†–´–¢–ò–ï –ù–ê –ë–ò–†–ñ–ï: {symbol}")
        logger.critical(f"   –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è: {self.active_positions[symbol]}")
        logger.critical(f"   –°—Ç–∞—Ç—É—Å –Ω–∞ –±–∏—Ä–∂–µ: –ó–ê–ö–†–´–¢–ê (–Ω–µ –Ω–∞–π–¥–µ–Ω–∞)")
        logger.critical(f"   –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: TSL, Liquidation, Manual, ADL")
        logger.critical("="*80)
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        await self._sync_position_with_exchange(symbol)
```

**–ì–¥–µ –¥–æ–±–∞–≤–∏—Ç—å:** –í orchestrator.py, –≤—ã–∑—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ

### 2. Partial TP logging (–ö–†–ò–¢–ò–ß–ù–û!)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ Partial TP —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí –Ω–µ—Ç –ª–æ–≥–æ–≤!

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í exit_analyzer.py –∏–ª–∏ position_manager.py, –ø–æ—Å–ª–µ Partial TP
logger.info("="*80)
logger.info(f"üìä PARTIAL TP: {symbol}")
logger.info(f"   –ó–∞–∫—Ä—ã—Ç–æ: {partial_amount} –º–æ–Ω–µ—Ç ({partial_pct:.1f}%)")
logger.info(f"   –û—Å—Ç–∞–ª–æ—Å—å: {remaining_amount} –º–æ–Ω–µ—Ç ({remaining_pct:.1f}%)")
logger.info(f"   PnL –∑–∞–∫—Ä—ã—Ç–æ–π —á–∞—Å—Ç–∏: ${partial_pnl:.4f}")
logger.info(f"   Entry: ${entry_price} ‚Üí Exit: ${exit_price}")
logger.info("="*80)

# JSON –ª–æ–≥ –¥–ª—è Partial TP
partial_tp_data = {
    "timestamp": datetime.now(timezone.utc).isoformat(),
    "event": "partial_tp",
    "symbol": symbol,
    "partial_amount": partial_amount,
    "remaining_amount": remaining_amount,
    "partial_pnl": partial_pnl,
    "exit_price": exit_price
}

# –ó–∞–ø–∏—Å—å –≤ JSONL
with open(f"logs/futures/structured/partial_tp_{datetime.now().strftime('%Y-%m-%d')}.jsonl", "a") as f:
    f.write(json.dumps(partial_tp_data) + "\n")
```

### 3. Consistency check (–í–ê–ñ–ù–û!)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞, –Ω–æ –ù–ï –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∞ ‚Üí –∫–∞–∫ —É–∑–Ω–∞—Ç—å?

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
async def _verify_closure_logged(self, symbol, timestamp):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ –í–û –í–°–ï–• –º–µ—Å—Ç–∞—Ö"""
    
    checks = {
        "main_log": False,
        "json_log": False,
        "csv_log": False,
    }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ main_log (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ JSON
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ CSV
    
    missing = [k for k, v in checks.items() if not v]
    if missing:
        logger.error(f"‚ùå –ó–ê–ö–†–´–¢–ò–ï {symbol} –ù–ï –ó–ê–õ–û–ì–ò–†–û–í–ê–ù–û! –ü—Ä–æ–ø—É—â–µ–Ω–æ: {missing}")
```

### 4. Pre-close state logging (–í–ê–ñ–ù–û!)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö—É—Ä—Å–æ—Ä –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–∫—Ä—ã—Ç–∏—è, –Ω–æ –Ω–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥!

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í exit_analyzer.py, –ü–ï–†–ï–î –∑–∞–∫—Ä—ã—Ç–∏–µ–º
logger.info("="*80)
logger.info(f"üìä [EXIT_DECISION] {symbol}: –ü—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç—å")
logger.info(f"   Unrealized PnL: ${unrealized_pnl:.4f} ({unrealized_pnl_pct:.2f}%)")
logger.info(f"   Current price: ${current_price}")
logger.info(f"   Adaptive PH: {adaptive_ph_threshold:.2f}%")
logger.info(f"   Adaptive PD: {adaptive_pd_threshold:.2f}%")
logger.info(f"   SL threshold: {sl_threshold:.2f}%")
logger.info(f"   TP threshold: {tp_threshold:.2f}%")
logger.info(f"   Trigger reason: {reason}")
logger.info("="*80)
```

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-21
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-12-21 (–¥–æ–±–∞–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç Grok)
**–°—Ç–∞—Ç—É—Å:** üî¥ –¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–ª–∞–Ω —Å –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏)

