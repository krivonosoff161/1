# üìã –û–¢–ß–ï–¢: –≠–¢–ê–ü 2 - –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ PositionManager

**–î–∞—Ç–∞:** 21 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## üéØ –¶–µ–ª—å —ç—Ç–∞–ø–∞

–í—ã–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏ –∏–∑ `orchestrator.py` –≤ `PositionManager`, —á—Ç–æ–±—ã:
- –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä orchestrator
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –ø–æ–∑–∏—Ü–∏—è–º–∏
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ PositionManager

**–§–∞–π–ª:** `src/strategies/scalping/spot/position_manager.py`

#### –î–æ–±–∞–≤–ª–µ–Ω–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–∑–∏—Ü–∏–π:
```python
self.positions: Dict[str, Position] = {}
```

#### –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏—è–º–∏:

1. **`add_position(symbol, position)`** - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ç—Ä–µ–∫–∏–Ω–≥
   - –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –≤ —Å–ª–æ–≤–∞—Ä—å
   - –õ–æ–≥–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏

2. **`remove_position(symbol)`** - –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ç—Ä–µ–∫–∏–Ω–≥–∞
   - –£–¥–∞–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –∏–∑ —Å–ª–æ–≤–∞—Ä—è
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
   - –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

3. **`get_position(symbol)`** - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Å–∏–º–≤–æ–ª—É
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Position –∏–ª–∏ None

4. **`has_position(symbol)`** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–∑–∏—Ü–∏–∏
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True/False

5. **`get_all_positions()`** - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ø–∏—é —Å–ª–æ–≤–∞—Ä—è –ø–æ–∑–∏—Ü–∏–π

6. **`get_positions_count()`** - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç int

7. **`close_position_by_symbol(symbol, current_price, reason, ...)`** - –ó–∞–∫—Ä—ã—Ç–∏–µ —Å –ø–æ–ª–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
   - –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ `close_position()`
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `performance_tracker`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `risk_controller`
   - –£–¥–∞–ª—è–µ—Ç –∏–∑ —Ç—Ä–µ–∫–∏–Ω–≥–∞
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True/False

8. **`emergency_close_all(performance_tracker, risk_controller)`** - –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö
   - –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
   - –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Dict —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

#### –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `monitor_positions`:
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã `positions` –∏ `current_prices` —Ç–µ–ø–µ—Ä—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ `self.positions` –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ

---

### 2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Orchestrator

**–§–∞–π–ª:** `src/strategies/scalping/spot/orchestrator.py`

#### –£–¥–∞–ª–µ–Ω–æ:
```python
# –ë—ã–ª–æ:
self.positions: Dict[str, Position] = {}
```

#### –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ `self.positions`:

**–ë—ã–ª–æ:**
```python
if symbol in self.positions:
    ...
self.positions[symbol] = position
position = self.positions.get(symbol)
del self.positions[symbol]
```

**–°—Ç–∞–ª–æ:**
```python
if self.position_manager.has_position(symbol):
    ...
self.position_manager.add_position(symbol, position)
position = self.position_manager.get_position(symbol)
self.position_manager.remove_position(symbol)
```

#### –£–ø—Ä–æ—â–µ–Ω—ã –º–µ—Ç–æ–¥—ã:

**1. `_close_position()` - —Å 33 —Å—Ç—Ä–æ–∫ –¥–æ 10 —Å—Ç—Ä–æ–∫:**
```python
# –ë—ã–ª–æ: 33 —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∏–∫–∏
async def _close_position(self, symbol: str, current_price: float, reason: str):
    position = self.positions.get(symbol)
    if not position:
        return
    trade_result = await self.position_manager.close_position(...)
    if trade_result:
        self.performance_tracker.record_trade(trade_result)
        self.risk_controller.record_trade_closed(trade_result.net_pnl)
        del self.positions[symbol]
        logger.info(...)
    else:
        del self.positions[symbol]
        logger.warning(...)

# –°—Ç–∞–ª–æ: 10 —Å—Ç—Ä–æ–∫
async def _close_position(self, symbol: str, current_price: float, reason: str):
    await self.position_manager.close_position_by_symbol(
        symbol,
        current_price,
        reason,
        self.performance_tracker,
        self.risk_controller,
    )
```

**2. `emergency_close_all()` - —Å 49 —Å—Ç—Ä–æ–∫ –¥–æ 6 —Å—Ç—Ä–æ–∫:**
```python
# –ë—ã–ª–æ: 49 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏
async def emergency_close_all(self):
    logger.error("üö® EMERGENCY CLOSE ALL INITIATED!")
    try:
        positions_to_close = list(self.positions.items())
        if not positions_to_close:
            logger.info("‚ö™ No open positions to close")
            return
        logger.info(f"üìä Closing {len(positions_to_close)} positions...")
        for symbol, position in positions_to_close:
            try:
                ticker = await self.client.get_ticker(symbol)
                current_price = float(ticker.get("last", position.current_price))
                trade_result = await self.position_manager.close_position(...)
                if trade_result:
                    self.performance_tracker.record_trade(trade_result)
                    logger.info(...)
                if symbol in self.positions:
                    del self.positions[symbol]
            except Exception as e:
                logger.error(...)
        logger.info("üö® Emergency close completed!")
    except Exception as e:
        logger.critical(...)

# –°—Ç–∞–ª–æ: 6 —Å—Ç—Ä–æ–∫
async def emergency_close_all(self):
    await self.position_manager.emergency_close_all(
        self.performance_tracker,
        self.risk_controller,
    )
```

#### –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã –≤ `_process_symbol()`:

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–∑–∏—Ü–∏–∏:**
```python
# –ë—ã–ª–æ:
if symbol in self.positions:

# –°—Ç–∞–ª–æ:
if self.position_manager.has_position(symbol):
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∑–∏—Ü–∏–π:**
```python
# –ë—ã–ª–æ:
to_close = await self.position_manager.monitor_positions(
    {symbol: self.positions[symbol]}, current_prices
)
await self._close_position(close_symbol, current_price, reason)
if close_symbol in self.positions:
    del self.positions[close_symbol]

# –°—Ç–∞–ª–æ:
to_close = await self.position_manager.monitor_positions(
    {symbol: self.position_manager.get_position(symbol)}, current_prices
)
await self.position_manager.close_position_by_symbol(
    close_symbol, current_price, reason,
    self.performance_tracker, self.risk_controller
)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏:**
```python
# –ë—ã–ª–æ:
can_trade, reason = self.risk_controller.can_trade(
    symbol, self.positions, stats
)

# –°—Ç–∞–ª–æ:
can_trade, reason = self.risk_controller.can_trade(
    symbol, self.position_manager.get_all_positions(), stats
)
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞:**
```python
# –ë—ã–ª–æ:
signal = await self.signal_generator.generate_signal(
    symbol, indicators, tick, self.positions, market_data
)

# –°—Ç–∞–ª–æ:
signal = await self.signal_generator.generate_signal(
    symbol, indicators, tick,
    self.position_manager.get_all_positions(), market_data
)
```

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏:**
```python
# –ë—ã–ª–æ:
self.positions[symbol] = position

# –°—Ç–∞–ª–æ:
self.position_manager.add_position(symbol, position)
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ orchestrator:
- **–ë—ã–ª–æ:** ~1070 —Å—Ç—Ä–æ–∫
- **–°—Ç–∞–ª–æ:** ~1000 —Å—Ç—Ä–æ–∫ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
- **–£–¥–∞–ª–µ–Ω–æ:** ~70 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä—É—é—â–µ–π –ª–æ–≥–∏–∫–∏

### –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ PositionManager:
- **–ë—ã–ª–æ:** 716 —Å—Ç—Ä–æ–∫
- **–°—Ç–∞–ª–æ:** ~900 —Å—Ç—Ä–æ–∫
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** ~184 —Å—Ç—Ä–æ–∫–∏ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤

### –£–ª—É—á—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏—è–º–∏
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π orchestrator
- ‚úÖ –õ—É—á—à–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ –ú–µ–Ω—å—à–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å:
```bash
python -m py_compile src/strategies/scalping/spot/position_manager.py  # ‚úÖ OK
python -m py_compile src/strategies/scalping/spot/orchestrator.py      # ‚úÖ OK
```

### –õ–∏–Ω—Ç–µ—Ä:
```bash
# –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞ ‚úÖ
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã

- [x] **–≠–¢–ê–ü 1:** –°–æ–∑–¥–∞—Ç—å ConfigManager –∏ –≤—ã–Ω–µ—Å—Ç–∏ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ñ–∏–≥–æ–º
- [x] **–≠–¢–ê–ü 2:** –†–∞—Å—à–∏—Ä–∏—Ç—å PositionManager - –≤—ã–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏
- [ ] **–≠–¢–ê–ü 3:** –°–æ–∑–¥–∞—Ç—å TSLManager - –≤—ã–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TSL
- [ ] **–≠–¢–ê–ü 4:** –†–∞—Å—à–∏—Ä–∏—Ç—å OrderExecutor - –≤—ã–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞–º–∏
- [ ] **–≠–¢–ê–ü 5:** –°–æ–∑–¥–∞—Ç—å RiskManager - –≤—ã–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏
- [ ] **–≠–¢–ê–ü 6:** –£–ø—Ä–æ—Å—Ç–∏—Ç—å orchestrator - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

---

## üìù –ó–∞–º–µ—Ç–∫–∏

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ú–µ—Ç–æ–¥ `monitor_positions()` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ —Å—Ç–∞—Ä—ã–π API (—Å –ø–µ—Ä–µ–¥–∞—á–µ–π –ø–æ–∑–∏—Ü–∏–π), —Ç–∞–∫ –∏ –Ω–æ–≤—ã–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

2. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏:** –í—Å—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ —Ç–µ–ø–µ—Ä—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ - `PositionManager`

3. **–£–ø—Ä–æ—â–µ–Ω–∏–µ orchestrator:** Orchestrator —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –º–æ–¥—É–ª–∏, –Ω–µ —É–ø—Ä–∞–≤–ª—è—è –ø–æ–∑–∏—Ü–∏—è–º–∏ –Ω–∞–ø—Ä—è–º—É—é

4. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ PositionManager

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠–¢–ê–ü 2 –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û

