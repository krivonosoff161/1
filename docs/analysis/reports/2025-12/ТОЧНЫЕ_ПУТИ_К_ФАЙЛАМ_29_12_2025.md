# –¢–û–ß–ù–´–ï –ü–£–¢–ò –ö –§–ê–ô–õ–ê–ú –î–õ–Ø –ü–ê–¢–ß–ï–ô (29.12.2025)

**–î–∞—Ç–∞:** 29.12.2025  
**–°—Ç–∞—Ç—É—Å:** –°–ø—Ä–∞–≤–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

---

## üìÅ –§–ê–ô–õ–´ –î–õ–Ø –ü–ê–¢–ß–ï–ô

### 1. **position_manager.py** - Partial Close PnL/Commission

**–ü–æ–ª–Ω—ã–π –ø—É—Ç—å:**
```
src/strategies/scalping/futures/position_manager.py
```

**–ú–µ—Ç–æ–¥ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è:**
- **–ú–µ—Ç–æ–¥:** `async def _check_partial_tp(...)`
- **–ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **~6390** (–ø—Ä–∏–º–µ—Ä–Ω–æ)
- **–†–∞—Å—á–µ—Ç PnL:** —Å—Ç—Ä–æ–∫–∏ **6630-6634**
- **–†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏:** —Å—Ç—Ä–æ–∫–∏ **6651-6654** ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê –ó–î–ï–°–¨!**

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—á–∞—Å—Ç–æ–∫ –∫–æ–¥–∞ (—Å—Ç—Ä–æ–∫–∏ 6651-6654):**

```python
# –ö–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—Ö–æ–¥ + –≤—ã—Ö–æ–¥ –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
partial_commission = (
    close_size_coins * current_price * commission_rate * 2
)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ–º–∏—Å—Å–∏—è —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ **2** (–≤—Ö–æ–¥ + –≤—ã—Ö–æ–¥)
- –ù–æ –∫–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—Ö–æ–¥ —É–∂–µ –±—ã–ª–∞ —É–ø–ª–∞—á–µ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤—Å–µ–π –ø–æ–∑–∏—Ü–∏–∏
- –ù—É–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é –∑–∞ –≤—Ö–æ–¥ + –∫–æ–º–∏—Å—Å–∏—é –∑–∞ –≤—ã—Ö–æ–¥

**–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ—Ç–æ–¥–∞:**
- –°—Ç—Ä–æ–∫–∏ **6390-6800** (–ø—Ä–∏–º–µ—Ä–Ω–æ) - –≤–µ—Å—å –º–µ—Ç–æ–¥ `_check_partial_tp`
- –°—Ç—Ä–æ–∫–∏ **6630-6673** - —Ä–∞—Å—á–µ—Ç PnL –∏ –∫–æ–º–∏—Å—Å–∏–∏

---

### 2. **signal_generator.py** - Generate Signals –¥–ª—è SHORT

**–ü–æ–ª–Ω—ã–π –ø—É—Ç—å:**
```
src/strategies/scalping/futures/signal_generator.py
```

**–ú–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤:**
- **–ú–µ—Ç–æ–¥:** `async def generate_signals(...)`
- **–ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **1404**
- **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥:** `async def _generate_symbol_signals(...)`
- **–ù–∞—á–∞–ª–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **1565**

**–ú–µ—Ç–æ–¥—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SHORT —Å–∏–≥–Ω–∞–ª–æ–≤:**

1. **RSI —Å–∏–≥–Ω–∞–ª—ã:**
   - **–ú–µ—Ç–æ–¥:** `async def _generate_rsi_signals(...)`
   - **–ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **2967**
   - **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SHORT (RSI overbought):** —Å—Ç—Ä–æ–∫–∏ **3201-3284**
   - **–£—Å–ª–æ–≤–∏–µ:** `elif rsi > rsi_overbought:` (—Å—Ç—Ä–æ–∫–∞ **3201**)

2. **MACD —Å–∏–≥–Ω–∞–ª—ã:**
   - **–ú–µ—Ç–æ–¥:** `async def _generate_macd_signals(...)`
   - **–ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **3291**
   - **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SHORT (MACD bearish):** —Å—Ç—Ä–æ–∫–∏ **235-326** (–≤ —Ñ–∞–π–ª–µ `macd_signal_generator.py`)
   - **–§–∞–π–ª:** `src/strategies/scalping/futures/signals/macd_signal_generator.py`
   - **–£—Å–ª–æ–≤–∏–µ:** `elif macd_line < signal_line and histogram < 0:` (—Å—Ç—Ä–æ–∫–∞ **235**)

3. **Bollinger Bands —Å–∏–≥–Ω–∞–ª—ã:**
   - **–ú–µ—Ç–æ–¥:** `async def _generate_bollinger_signals(...)`
   - **–ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **~3700** (–ø—Ä–∏–º–µ—Ä–Ω–æ)
   - **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SHORT:** –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ –∫–∞—Å–∞–µ—Ç—Å—è –≤–µ—Ä—Ö–Ω–µ–π –ø–æ–ª–æ—Å—ã

4. **MA —Å–∏–≥–Ω–∞–ª—ã:**
   - **–ú–µ—Ç–æ–¥:** `async def _generate_ma_signals(...)`
   - **–ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **4001**
   - **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SHORT:** –∫–æ–≥–¥–∞ EMA –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç bearish —Ç—Ä–µ–Ω–¥

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤:**
- **–ú–µ—Ç–æ–¥:** `async def _filter_and_rank_signals(...)`
- **–ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **6086**
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ strength:** —Å—Ç—Ä–æ–∫–∏ **6191-6193**
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π strength:** —Å—Ç—Ä–æ–∫–∏ **6157-6183**

**ADX —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
- **–ö–æ–¥:** —Å—Ç—Ä–æ–∫–∏ **2340-2454**
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ SHORT –ø—Ä–æ—Ç–∏–≤ bullish:** —Å—Ç—Ä–æ–∫–∏ **2362-2371**
- **–ù–ï–¢ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ SHORT –ø—Ä–∏ bearish** (—ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!)

---

### 3. **data_registry.py** - Get Price (markPx vs —Å—Ç–∞–∫–∞–Ω)

**–ü–æ–ª–Ω—ã–π –ø—É—Ç—å:**
```
src/strategies/scalping/futures/core/data_registry.py
```

**–ú–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã:**
- **–ú–µ—Ç–æ–¥:** `async def get_price(self, symbol: str) -> Optional[float]`
- **–ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **97**
- **–ö–æ–Ω–µ—Ü –º–µ—Ç–æ–¥–∞:** —Å—Ç—Ä–æ–∫–∞ **109**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 97-109):**

```python
async def get_price(self, symbol: str) -> Optional[float]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É —Å–∏–º–≤–æ–ª–∞.

    Args:
        symbol: –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–º–≤–æ–ª

    Returns:
        –¶–µ–Ω–∞ –∏–ª–∏ None
    """
    async with self._lock:
        market_data = self._market_data.get(symbol, {})
        return market_data.get("price") or market_data.get("last_price")
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `markPx` –∏–∑ WebSocket (—á–µ—Ä–µ–∑ `market_data.get("price")`)
- `markPx` –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã —Å—Ç–∞–∫–∞–Ω–∞
- –î–ª—è —Ç–æ—á–Ω–æ–≥–æ PnL –Ω—É–∂–Ω–∞ —Ü–µ–Ω–∞ –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (best bid/ask)

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è markPx:**
- `position_manager.py:6562` - `current_price = float(pos_data.get("markPx", entry_price))`
- –≠—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (best bid –¥–ª—è LONG, best ask –¥–ª—è SHORT)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—É —Å—Ç–∞–∫–∞–Ω–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL –≤–º–µ—Å—Ç–æ markPx

---

## üìä –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê

| –§–∞–π–ª | –ú–µ—Ç–æ–¥ | –°—Ç—Ä–æ–∫–∏ | –ü—Ä–æ–±–ª–µ–º–∞ |
|------|-------|--------|----------|
| `position_manager.py` | `_check_partial_tp` | 6651-6654 | –ö–æ–º–∏—Å—Å–∏—è —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ 2 –≤–º–µ—Å—Ç–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ |
| `signal_generator.py` | `_generate_rsi_signals` | 3201-3284 | RSI –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SHORT –ø—Ä–∏ RSI < 85 |
| `signal_generator.py` | `_generate_macd_signals` | 235-326 | MACD BEARISH strength —Å–Ω–∏–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ —Å EMA |
| `signal_generator.py` | `_filter_and_rank_signals` | 6191-6193 | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ strength –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ—Ç —Å–ª–∞–±—ã–µ —Å–∏–≥–Ω–∞–ª—ã |
| `data_registry.py` | `get_price` | 97-109 | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç markPx –≤–º–µ—Å—Ç–æ —Ü–µ–Ω—ã —Å—Ç–∞–∫–∞–Ω–∞ |

---

## üîç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–ê–ô–õ–´

### MACD Signal Generator

**–ü–æ–ª–Ω—ã–π –ø—É—Ç—å:**
```
src/strategies/scalping/futures/signals/macd_signal_generator.py
```

**–ú–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ MACD BEARISH:**
- **–ú–µ—Ç–æ–¥:** `async def generate_signals(...)`
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SHORT:** —Å—Ç—Ä–æ–∫–∏ **235-326**
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å EMA:** —Å—Ç—Ä–æ–∫–∏ **267-306**
- **–°–Ω–∏–∂–µ–Ω–∏–µ strength:** —Å—Ç—Ä–æ–∫–∞ **301**

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ (position_manager.py:6651-6654):

```python
# –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—Ö–æ–¥ –¥–ª—è –∑–∞–∫—Ä—ã–≤–∞–µ–º–æ–π —á–∞—Å—Ç–∏
entry_commission_proportional = (
    (close_size_coins / total_size_coins) * 
    total_size_coins * entry_price * commission_rate
)

# –ö–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—ã—Ö–æ–¥ –¥–ª—è –∑–∞–∫—Ä—ã–≤–∞–µ–º–æ–π —á–∞—Å—Ç–∏
exit_commission = close_size_coins * current_price * commission_rate

# –ò—Ç–æ–≥–æ
partial_commission = entry_commission_proportional + exit_commission
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é SHORT —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ ADX bearish (signal_generator.py):

```python
# –í –º–µ—Ç–æ–¥–µ _generate_base_signals –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥—Ä—É–≥–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
if adx_trend == "bearish" and adx_value > adx_threshold:
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SHORT —Å–∏–≥–Ω–∞–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ bearish —Ç—Ä–µ–Ω–¥–∞
    signals.append({
        "symbol": symbol,
        "side": "sell",
        "type": "adx_bearish",
        "strength": calculate_strength_from_adx(adx_value, -di, +di),
        ...
    })
```

### 3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ markPx (data_registry.py:97-109):

```python
async def get_price(self, symbol: str, use_orderbook: bool = False) -> Optional[float]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É —Å–∏–º–≤–æ–ª–∞.
    
    Args:
        symbol: –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–º–≤–æ–ª
        use_orderbook: –ï—Å–ª–∏ True, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—É —Å—Ç–∞–∫–∞–Ω–∞ –≤–º–µ—Å—Ç–æ markPx
    
    Returns:
        –¶–µ–Ω–∞ –∏–ª–∏ None
    """
    if use_orderbook:
        # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (best bid –¥–ª—è LONG, best ask –¥–ª—è SHORT)
        orderbook = await self.client.get_orderbook(symbol)
        if orderbook:
            return (orderbook.get("bids", [[0]])[0][0] + orderbook.get("asks", [[0]])[0][0]) / 2
    
    async with self._lock:
        market_data = self._market_data.get(symbol, {})
        return market_data.get("price") or market_data.get("last_price")
```

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 29.12.2025  
**–°—Ç–∞—Ç—É—Å:** –°–ø—Ä–∞–≤–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ç—á–µ–π


