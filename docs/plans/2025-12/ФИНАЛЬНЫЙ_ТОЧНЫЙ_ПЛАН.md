# üìã –§–ò–ù–ê–õ–¨–ù–´–ô –¢–û–ß–ù–´–ô –ü–õ–ê–ù: 28 –ü–†–ê–í–û–ö –° –ö–û–ù–ö–†–ï–¢–ù–´–ú–ò –°–¢–†–û–ö–ê–ú–ò

**–î–∞—Ç–∞:** 2025-12-22  
**–û—Å–Ω–æ–≤–∞:** –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ + –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üî¥ –ü–†–ê–í–ö–ê #1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å regime: null –≤ EXIT_DECISIONS

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/exit_analyzer.py`

### –ê. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (17 –º–µ—Å—Ç —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏):

| –°—Ç—Ä–æ–∫–∞ | –§—É–Ω–∫—Ü–∏—è | Reason | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|---------|--------|----------|
| 1598 | trending | big_profit_exit | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1632 | trending | partial_close | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1646 | trending | partial_tp_min_holding_wait | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1664 | trending | reversal_detected | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1681 | trending | strong_trend_profit | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1711 | trending | max_holding_strong_trend | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1742 | trending | smart_forced_close_trending | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1757 | trending | max_holding_exceeded_but_loss_trending | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1793 | trending | max_holding_low_profit | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1808 | trending | max_holding_no_signals | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 1954 | ranging | profit_too_low_vs_peak | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 2101 | ranging | big_profit_exit | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 2192 | ranging | partial_close | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 2206 | ranging | partial_tp_min_holding_wait | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 2228 | ranging | reversal_detected | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 2345 | ranging | max_holding_hard_stop_timeout_loss | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 2363 | ranging | max_holding_exceeded_but_loss_small | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 2379 | ranging | max_holding_hard_stop_profit | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ `"regime": regime,` |
| 2408-2416 | ranging | smart_forced_close_ranging | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2425-2433 | ranging | max_holding_exceeded_but_loss | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2450-2458 | ranging | max_holding_low_profit | ‚ùå –ù–ï–¢ regime |
| 2465-2473 | ranging | max_holding_exceeded | ‚ùå –ù–ï–¢ regime |
| 2650 | choppy | profit_too_low_vs_peak | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2669 | choppy | tp_reached | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2685 | choppy | big_profit_exit | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2727 | choppy | partial_close | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2740 | choppy | partial_tp_min_holding_wait | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2758 | choppy | reversal_detected | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2797 | choppy | smart_forced_close_choppy | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2812 | choppy | max_holding_exceeded_but_loss_choppy | ‚úÖ –£–ñ–ï –ï–°–¢–¨ (–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø) |
| 2795-2803 | choppy | max_holding_low_profit | ‚ùå –ù–ï–¢ regime |
| 2810-2818 | choppy | max_holding_exceeded_choppy | ‚ùå –ù–ï–¢ regime |

**–ò—Ç–æ–≥–æ:** 
- 17 –º–µ—Å—Ç —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å)
- 4 –º–µ—Å—Ç–∞ –≥–¥–µ –ù–ï–¢ regime (–¥–æ–±–∞–≤–∏—Ç—å)

### –ë. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

**–ü—Ä–∏–º–µ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å—Ç—Ä–æ–∫–∞ 1598):**
```python
                return {
                    "action": "close",
                    "reason": "big_profit_exit",
                    "pnl_pct": pnl_percent,
                    "big_profit_exit_percent": big_profit_exit_percent,
                
                        "regime": regime,  # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø
                    }
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
                return {
                    "action": "close",
                    "reason": "big_profit_exit",
                    "pnl_pct": pnl_percent,
                    "big_profit_exit_percent": big_profit_exit_percent,
                    "regime": regime,  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø (4 –ø—Ä–æ–±–µ–ª–∞)
                }
```

---

## üî¥ –ü–†–ê–í–ö–ê #2: –°–¥–µ–ª–∞—Ç—å max_holding_minutes –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –æ—Ç —Ä–µ–∂–∏–º–∞

**–§–∞–π–ª 1:** `config/config_futures.yaml`  
**–°—Ç—Ä–æ–∫–∞:** –ü–æ—Å–ª–µ `exit_params:` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 850)

**–î–æ–±–∞–≤–∏—Ç—å:**
```yaml
exit_params:
  ranging:
    max_holding_minutes: 15
    sl_percent: 0.8
    tp_percent: 2.5
    spread_buffer: 0.15
  trending:
    max_holding_minutes: 45
    sl_percent: 2.0
    tp_percent: 8.0
    spread_buffer: 0.05
  choppy:
    max_holding_minutes: 10
    sl_percent: 1.5
    tp_percent: 3.0
    spread_buffer: 0.10
```

**–§–∞–π–ª 2:** `src/strategies/scalping/futures/positions/exit_analyzer.py`  
**–°—Ç—Ä–æ–∫–∞:** 1043-1085

**–ó–∞–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_get_max_holding_minutes`:**
```python
def _get_max_holding_minutes(self, regime: str) -> float:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ max_holding_minutes –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –ø–æ —Ä–µ–∂–∏–º—É.
    
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
    1. exit_params.regime.max_holding_minutes
    2. adaptive_regime.regime.max_holding_minutes
    3. per-symbol max_holding_minutes
    4. 120.0 (default)
    """
    max_holding_minutes = 120.0  # Default 2 —á–∞—Å–∞
    
    # ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 1: exit_params.regime.max_holding_minutes
    if self.config_manager:
        try:
            exit_params = self.config_manager.get("exit_params", {})
            if isinstance(exit_params, dict) and regime in exit_params:
                regime_config = exit_params.get(regime, {})
                if isinstance(regime_config, dict) and "max_holding_minutes" in regime_config:
                    return float(regime_config["max_holding_minutes"])
        except Exception as e:
            logger.debug(f"‚ö†Ô∏è ExitAnalyzer: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è exit_params.max_holding_minutes: {e}")
    
    # ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 2: adaptive_regime.regime.max_holding_minutes (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
    if self.scalping_config:
        try:
            adaptive_regime = getattr(self.scalping_config, "adaptive_regime", {})
            regime_config = None

            if isinstance(adaptive_regime, dict):
                if regime and regime in adaptive_regime:
                    regime_config = adaptive_regime.get(regime, {})
                elif "ranging" in adaptive_regime:
                    regime_config = adaptive_regime.get("ranging", {})
            else:
                if regime and hasattr(adaptive_regime, regime):
                    regime_config = getattr(adaptive_regime, regime)
                elif hasattr(adaptive_regime, "ranging"):
                    regime_config = getattr(adaptive_regime, "ranging")

            if regime_config:
                if isinstance(regime_config, dict):
                    max_holding_minutes = float(
                        regime_config.get("max_holding_minutes", 120.0)
                    )
                else:
                    max_holding_minutes = float(
                        getattr(regime_config, "max_holding_minutes", 120.0)
                    )
        except Exception as e:
            logger.debug(
                f"‚ö†Ô∏è ExitAnalyzer: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è max_holding_minutes: {e}"
            )

    return max_holding_minutes
```

---

## üî¥ –ü–†–ê–í–ö–ê #3: –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è race condition

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`  
**–°—Ç—Ä–æ–∫–∞ 1:** –í `__init__` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 100-200)

**–î–æ–±–∞–≤–∏—Ç—å:**
```python
self._close_lock = asyncio.Lock()
```

**–°—Ç—Ä–æ–∫–∞ 2:** –í `close_position_manually` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 5775)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
for pos_data in positions:
    inst_id = pos_data.get("instId", "").replace("-SWAP", "")
    if inst_id != symbol:
        continue

    size = float(pos_data.get("pos", "0"))
    if size == 0:
        logger.warning(...)
        return None
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
async with self._close_lock:
    for pos_data in positions:
        inst_id = pos_data.get("instId", "").replace("-SWAP", "")
        if inst_id != symbol:
            continue

        size = float(pos_data.get("pos", "0"))
        if size == 0:
            logger.warning(...)
            return None
        # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è ...
```

---

## üî¥ –ü–†–ê–í–ö–ê #4: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π

**–§–∞–π–ª:** `src/strategies/scalping/futures/positions/exit_analyzer.py`

### –í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_trending` (—Å—Ç—Ä–æ–∫–∞ ~1500):

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ ~1520 (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è entry_price –∏ —Ä–∞—Å—á–µ—Ç–∞ pnl_percent):**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è str vs int –æ—à–∏–±–æ–∫
try:
    pnl_percent = float(pnl_percent)
    tp_percent = float(tp_percent) if tp_percent is not None else 2.4
    big_profit_exit_percent = float(big_profit_exit_percent) if big_profit_exit_percent is not None else 1.5
except (TypeError, ValueError) as e:
    logger.error(f"‚ùå ExitAnalyzer TRENDING: –û—à–∏–±–∫–∞ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –¥–ª—è {symbol}: {e}")
    return None
```

### –í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_ranging` (—Å—Ç—Ä–æ–∫–∞ ~1900):

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ ~1920 (–ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ gross_pnl_percent –∏ net_pnl_percent):**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è str vs int –æ—à–∏–±–æ–∫
try:
    gross_pnl_percent = float(gross_pnl_percent)
    net_pnl_percent = float(net_pnl_percent)
    sl_percent = float(sl_percent) if sl_percent is not None else 2.0
    tp_percent = float(tp_percent) if tp_percent is not None else 2.4
    big_profit_exit_percent = float(big_profit_exit_percent) if big_profit_exit_percent is not None else 1.5
except (TypeError, ValueError) as e:
    logger.error(f"‚ùå ExitAnalyzer RANGING: –û—à–∏–±–∫–∞ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –¥–ª—è {symbol}: {e}")
    return None
```

### –í —Ñ—É–Ω–∫—Ü–∏–∏ `_generate_exit_for_choppy` (—Å—Ç—Ä–æ–∫–∞ ~2550):

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ ~2610 (–ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ pnl_percent):**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è str vs int –æ—à–∏–±–æ–∫
try:
    pnl_percent = float(pnl_percent)
    tp_percent = float(tp_percent) if tp_percent is not None else 2.4
    big_profit_exit_percent = float(big_profit_exit_percent) if big_profit_exit_percent is not None else 1.5
except (TypeError, ValueError) as e:
    logger.error(f"‚ùå ExitAnalyzer CHOPPY: –û—à–∏–±–∫–∞ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –¥–ª—è {symbol}: {e}")
    return None
```

---

## üî¥ –ü–†–ê–í–ö–ê #5: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É duration_sec < 30

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`  
**–°—Ç—Ä–æ–∫–∞:** ~5775 (–≤ –Ω–∞—á–∞–ª–µ `close_position_manually`)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
async def close_position_manually(self, symbol, reason="manual"):
    # ... –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ...
    for pos_data in positions:
        size = float(pos_data.get("pos", "0"))
        if size == 0:
            return None
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
async def close_position_manually(self, symbol, reason="manual"):
    # ... –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ...
    
    # ‚úÖ –ü–†–ê–í–ö–ê #5: –ü—Ä–æ–≤–µ—Ä–∫–∞ entry_time –∏ duration_sec
    position = self.position_registry.get_position(symbol)
    if not position:
        logger.error(f"No position found for {symbol}")
        return None
    
    entry_time = None
    if hasattr(position, "entry_time"):
        entry_time = position.entry_time
    elif isinstance(position, dict):
        entry_time = position.get("entry_time")
    
    if not entry_time:
        logger.error(f"No entry_time for position: {symbol}")
        return None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º duration –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
    from datetime import datetime, timezone
    exit_time = datetime.now(timezone.utc)
    if isinstance(entry_time, str):
        entry_time = datetime.fromisoformat(entry_time.replace("Z", "+00:00"))
    if entry_time.tzinfo is None:
        entry_time = entry_time.replace(tzinfo=timezone.utc)
    
    duration_sec = (exit_time - entry_time).total_seconds()
    if duration_sec < 30:  # –ú–∏–Ω–∏–º—É–º 30 —Å–µ–∫
        logger.warning(f"Too fast close: {symbol}, {duration_sec}s")
        return None
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è ...
```

---

## üî¥ –ü–†–ê–í–ö–ê #6: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–π (avgPx –≤–º–µ—Å—Ç–æ markPx)

**–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`

### –ù–∞–π—Ç–∏ –í–°–ï –º–µ—Å—Ç–∞ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è markPx –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏:

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:**
```bash
grep -n "markPx\|position_value\|commission" position_manager.py | grep -E "6065|6088|6112|6150"
```

**–°—Ç—Ä–æ–∫–∞ ~6065 (–æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ—Å—Ç–æ):**
```python
# –ù–∞–π—Ç–∏ –≥–¥–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è position_value –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏
# –ó–∞–º–µ–Ω–∏—Ç—å markPx –Ω–∞ avgPx:
position_value = size * float(position.get("avgPx", position.get("entry_price", "0")))
commission = position_value * commission_rate * 2  # *2 –∑–∞ –≤—Ö–æ–¥ –∏ –≤—ã—Ö–æ–¥
```

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–∫–∂–µ:**
- –°—Ç—Ä–æ–∫–∞ ~6088 (–¥–ª—è partial close)
- –°—Ç—Ä–æ–∫–∞ ~6112 (–¥–ª—è exchange side closure)
- –î—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `position_value` –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏

---

## üî¥ –ü–†–ê–í–ö–ê #7: –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∞—Å 5% –¥–ª—è position size cap

**–§–∞–π–ª:** `src/strategies/scalping/futures/risk_manager.py`  
**–°—Ç—Ä–æ–∫–∞:** 994-999

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
if base_usd_size > max_usd_size:
    logger.warning(
        f"‚ö†Ô∏è –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ ${base_usd_size:.2f} –ø—Ä–µ–≤—ã—à–∞–µ—Ç max_position_size ${max_usd_size:.2f} –¥–ª—è {symbol}! "
        f"–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ ${max_usd_size:.2f} (—Å–∏–≥–Ω–∞–ª –±—ã–ª —Å–∏–ª—å–Ω—ã–π: strength_multiplier={strength_multiplier:.2f}x)"
    )
    base_usd_size = max_usd_size
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
if base_usd_size > max_usd_size:
    base_usd_size = max_usd_size * 0.95  # 5% –∑–∞–ø–∞—Å
    logger.warning(
        f"‚ö†Ô∏è –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ ${base_usd_size_before_cap:.2f} –ø—Ä–µ–≤—ã—à–∞–µ—Ç max_position_size ${max_usd_size:.2f} –¥–ª—è {symbol}! "
        f"–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ ${base_usd_size:.2f} (5% –∑–∞–ø–∞—Å, —Å–∏–≥–Ω–∞–ª –±—ã–ª —Å–∏–ª—å–Ω—ã–π: strength_multiplier={strength_multiplier:.2f}x)"
    )
```

---

## üî¥ –ü–†–ê–í–ö–ê #8: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∞

**–§–∞–π–ª:** `src/strategies/scalping/futures/risk/adaptive_leverage.py`  
**–°—Ç—Ä–æ–∫–∞:** ~128-135

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –û–∫—Ä—É–≥–ª—è–µ–º leverage –¥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞ –±–∏—Ä–∂–µ
if client and symbol != "N/A":
    try:
        original_leverage = leverage
        leverage = await client.round_leverage_to_available(
            symbol, leverage
        )
```

**–ù–æ–≤—ã–π –∫–æ–¥:**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –û–∫—Ä—É–≥–ª—è–µ–º leverage –¥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞ –±–∏—Ä–∂–µ
if client and symbol != "N/A":
    try:
        original_leverage = leverage
        
        # ‚úÖ –ü–†–ê–í–ö–ê #8: –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ª–µ–≤–µ—Ä–∏–¥–∂–∏ –∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π
        available = await client.get_available_leverages(symbol)
        logger.info(f"Available leverages for {symbol}: {available}")
        
        if available:
            max_available = max(available)
            leverage = min(leverage, max_available)  # –ù–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π
        
        leverage = await client.round_leverage_to_available(
            symbol, leverage
        )
```

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: –í–°–ï –ú–ï–°–¢–ê –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

| # | –ü—Ä–∞–≤–∫–∞ | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –î–µ–π—Å—Ç–≤–∏–µ |
|---|--------|------|--------|----------|
| 1 | regime —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | exit_analyzer.py | 1598, 1632, 1646, 1664, 1681, 1711, 1742, 1757, 1793, 1808, 1954, 2101, 2192, 2206, 2228, 2345, 2363, 2379, 2408-2416, 2425-2433, 2650, 2669, 2685, 2727, 2740, 2758, 2797, 2812 | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø—ã (28 –º–µ—Å—Ç) |
| 1 | regime –¥–æ–±–∞–≤–∏—Ç—å | exit_analyzer.py | 2450-2458, 2465-2473, 2795-2803, 2810-2818 | –î–æ–±–∞–≤–∏—Ç—å regime (4 –º–µ—Å—Ç–∞) |
| 2 | max_holding config | config_futures.yaml | ~850 | –î–æ–±–∞–≤–∏—Ç—å exit_params |
| 2 | max_holding –ª–æ–≥–∏–∫–∞ | exit_analyzer.py | 1043-1085 | –ò–∑–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é |
| 3 | Race condition | position_manager.py | ~100-200 (__init__), ~5775 | –î–æ–±–∞–≤–∏—Ç—å lock |
| 4 | str vs int | exit_analyzer.py | ~1520, ~1920, ~2610 | –î–æ–±–∞–≤–∏—Ç—å float() |
| 5 | Duration check | position_manager.py | ~5775 | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É |
| 6 | –ö–æ–º–∏—Å—Å–∏—è | position_manager.py | ~6065, ~6088, ~6112 | –ó–∞–º–µ–Ω–∏—Ç—å markPx –Ω–∞ avgPx |
| 7 | Position size cap | risk_manager.py | 994-999 | –î–æ–±–∞–≤–∏—Ç—å * 0.95 |
| 8 | Leverage rounding | adaptive_leverage.py | ~128-135 | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É max_available |

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ü–ï–†–ï–î –ó–ê–ü–£–°–ö–û–ú

- [ ] –í—Å–µ 28 –º–µ—Å—Ç —Å regime –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã (–æ—Ç—Å—Ç—É–ø—ã + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
- [ ] `_get_max_holding_minutes()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `exit_params.regime.max_holding_minutes`
- [ ] –î–æ–±–∞–≤–ª–µ–Ω `asyncio.Lock` –≤ `__init__` –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ `close_position_manually`
- [ ] –í—Å–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è `pnl_percent` –∏—Å–ø–æ–ª—å–∑—É—é—Ç `float()` –≤ 3 —Ñ—É–Ω–∫—Ü–∏—è—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ `duration_sec < 30` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `close_position_manually`
- [ ] –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `avgPx` (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å 3+ –º–µ—Å—Ç–∞)
- [ ] Position size cap –∏–º–µ–µ—Ç –∑–∞–ø–∞—Å 5%
- [ ] Leverage –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `max_available` –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- [ ] –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ regime —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ!** üöÄ






