# üìä –î–ê–ù–ù–´–ï –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –ö–ò–ú–´

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–õ–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞ –∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞](#1-–ª–æ–≥–∏-–∑–∞–ø—É—Å–∫–∞-–∏-—Ä–∞–±–æ—Ç—ã-–±–æ—Ç–∞)
2. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã](#2-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ-—Ñ–∞–π–ª—ã)
3. [–§–∞–π–ª—ã –ø–æ–∑–∏—Ü–∏–π](#3-—Ñ–∞–π–ª—ã-–ø–æ–∑–∏—Ü–∏–π)
4. [–ö–æ–¥ ExitAnalyzer](#4-–∫–æ–¥-exitanalyzer)
5. [–ö–æ–¥ PositionSizer (RiskManager)](#5-–∫–æ–¥-positionsizer-riskmanager)
6. [–ö–æ–¥ TrailingStopLoss](#6-–∫–æ–¥-trailingstoploss)

---

## 1. –õ–û–ì–ò –ó–ê–ü–£–°–ö–ê –ò –†–ê–ë–û–¢–´ –ë–û–¢–ê

### 1.1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π

```
2025-12-07 22:02:08.480 | INFO | FundingRateMonitor –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ orchestrator
2025-12-07 22:02:08.480 | INFO | ExitAnalyzer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
2025-12-07 22:02:08.480 | INFO | PositionMonitor –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (check_interval=5.0 —Å–µ–∫)
2025-12-07 22:02:36.484 | INFO | TrailingStopLoss –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: entry=0.14215, side=short, trail=2.00%
2025-12-07 22:02:36.488 | INFO | TrailingStopLoss –¥–ª—è DOGE-USDT –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: trail=2.000%, fee=0.100%, loss_cut=4.00% –æ—Ç –º–∞—Ä–∂–∏, min_holding=35.0 –º–∏–Ω, regime=ranging
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –õ–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `CandlePatternDetector`, `LiquidityLevelsDetector`, `VolumeProfileCalculator`, `PivotCalculator` –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `ExitAnalyzer.__init__`.

### 1.2. –õ–æ–≥–∏ ExitAnalyzer –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–æ–∑–∏—Ü–∏–π

```
2025-12-07 22:02:39.306 | INFO | ExitAnalyzer DOGE-USDT: —Ä–µ–∂–∏–º=ranging, –∏—Å—Ç–æ—á–Ω–∏–∫=signal_generator.regime_managers, metadata.regime=ranging
2025-12-07 22:02:39.306 | INFO | ExitAnalyzer RANGING DOGE-USDT: entry_price=0.14, current_price=0.14, side=short, Gross PnL%=-0.0703%, Net PnL%=-0.0703% (—Å –∫–æ–º–∏—Å—Å–∏–µ–π)
2025-12-07 22:02:39.306 | INFO | ExitAnalyzer RANGING DOGE-USDT: TP=4.00%, PnL%=-0.0703%, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç=False
2025-12-07 22:02:39.306 | INFO | ExitAnalyzer RANGING DOGE-USDT: big_profit_exit=3.00%, PnL%=-0.0703%, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç=False
2025-12-07 22:02:39.306 | INFO | ExitAnalyzer RANGING DOGE-USDT: partial_tp enabled=True, trigger_percent=1.00%
2025-12-07 22:02:39.306 | INFO | ExitAnalyzer RANGING DOGE-USDT: –ù–µ—Ç –ø—Ä–∏—á–∏–Ω—ã –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è - TP=4.00% (–Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç), big_profit=3.00% (–Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç), partial_tp=1.00% (–Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç), —Ç–µ–∫—É—â–∏–π PnL%=-0.07%, –≤—Ä–µ–º—è: 0.1 –º–∏–Ω / 20.0 –º–∏–Ω
```

### 1.3. –õ–æ–≥–∏ TrailingStopLoss

```
2025-12-07 22:02:36.484 | INFO | TrailingStopLoss –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: entry=0.14215, side=short, trail=2.00%, entry_time=2025-12-07T22:02:33.277000
2025-12-07 22:02:36.488 | INFO | TrailingStopLoss –¥–ª—è DOGE-USDT –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: trail=2.000%, fee=0.100%, loss_cut=4.00% –æ—Ç –º–∞—Ä–∂–∏, min_holding=35.0 –º–∏–Ω, regime=ranging
```

### 1.4. –õ–æ–≥–∏ PositionMonitor

```
2025-12-07 22:02:29.279 | INFO | PositionMonitor: –ó–∞–ø—É—â–µ–Ω
2025-12-07 22:02:29.279 | INFO | PositionMonitor –∑–∞–ø—É—â–µ–Ω (—Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞)
```

### 1.5. –õ–æ–≥–∏ DRIFT_ADD / DRIFT_REMOVE

```
2025-12-07 22:02:57.677 | CRITICAL | DRIFT_ADD ETH-USDT found on exchange but not in registry
2025-12-07 22:02:57.677 | WARNING | DRIFT_ADD_SYNCED ETH-USDT force-registered in PositionRegistry
2025-12-07 22:02:57.694 | WARNING | DRIFT_ADD_TSL_CREATED ETH-USDT TSL initialized (entry=3125.7000, side=short, regime=ranging)
```

### 1.6. –õ–æ–≥–∏ smart_close / sl_close / tp_close

**–°—Ç–∞—Ç—É—Å**: –ù–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç, —Ç–∞–∫ –∫–∞–∫ —É–±—ã—Ç–∫–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–µ (< -3.0% –¥–ª—è smart_close).

### 1.7. –û—à–∏–±–∫–∏

```
2025-12-07 22:02:51.218 | ERROR | –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ $85.17 –ø—Ä–µ–≤—ã—à–∞–µ—Ç max_position_size $70.00 –¥–ª—è ETH-USDT! –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ $70.00
2025-12-07 22:02:51.221 | ERROR | –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ $91.00 –ø—Ä–µ–≤—ã—à–∞–µ—Ç max_position_size $70.00 –¥–ª—è ETH-USDT! –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ $70.00
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –¥–æ max_position_size.

---

## 2. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–û–ù–ù–´–ï –§–ê–ô–õ–´

### 2.1. Micro –ø—Ä–æ—Ñ–∏–ª—å (config_futures.yaml)

```yaml
micro:  # $100 - $500 - –ù–û–í–´–ô –ü–†–û–§–ò–õ–¨ –î–õ–Ø –ú–ê–õ–´–• –ë–ê–õ–ê–ù–°–û–í
  threshold: 500.0
  min_balance: 100.0
  size_at_min: 30.0
  size_at_max: 50.0
  base_position_usd: 50.0  # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  min_position_usd: 30.0
  max_position_usd: 70.0
  max_open_positions: 5
  max_position_percent: 25.0
  progressive: true  # ‚úÖ –í–ê–†–ò–ê–ù–¢ B: –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è
```

### 2.2. Position Sizing (config_futures.yaml)

```yaml
scalping_config:
  leverage: 5
  sl_percent: 2.0
  tp_percent: 4.0
  risk_per_trade: 1.2  # % –æ—Ç –±–∞–ª–∞–Ω—Å–∞
  volatility_adjustment:
    enabled: true
    base_atr_percent: 2.0
    multiplier_range: [0.5, 1.5]
  adaptive_risk:
    enabled: true
    strength_multipliers:
      weak: 0.5
      medium: 1.0
      strong: 1.3
```

### 2.3. Exit Conditions (config_futures.yaml)

```yaml
adaptive_regime:
  ranging:
    sl_percent: 2.0
    tp_percent: 4.0
    max_holding_minutes: 20.0
    big_profit_exit_percent: 3.0
    partial_tp:
      enabled: true
      trigger_percent: 1.0
      close_percent: 50.0
```

---

## 3. –§–ê–ô–õ–´ –ü–û–ó–ò–¶–ò–ô

### 3.1. positions_open_2025-12-07.csv

```csv
timestamp,symbol,side,entry_price,size,regime,order_id,order_type
2025-12-07T19:02:36.107851,DOGE-USDT,short,0.14215000,490.00000000,ranging,3108205866300018688,limit
2025-12-07T19:02:58.407716,ETH-USDT,short,3125.70000000,0.02200000,ranging,3108206590404661248,limit
2025-12-07T19:03:20.843250,BTC-USDT,short,91268.72656000,0.00070000,ranging,3108207340983750656,limit
```

### 3.2. Registry (PositionRegistry)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: `PositionRegistry` —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ JSON —Ñ–∞–π–ª. –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥—ã:
- `get_all_positions()` - –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏
- `get_all_metadata()` - –≤—Å–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

---

## 4. –ö–û–î EXITANALYZER

### 4.1. __init__ (–≥–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)

```python
def __init__(
    self,
    position_registry: PositionRegistry,
    data_registry: DataRegistry,
    exit_decision_logger=None,
    orchestrator=None,
    config_manager=None,
    signal_generator=None,
    signal_locks_ref: Optional[Dict[str, asyncio.Lock]] = None,
):
    # ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...
    
    # ‚úÖ –ù–û–í–û–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π –¥–ª—è —É–º–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
    self.candle_pattern_detector = CandlePatternDetector()
    self.volume_profile_calculator = VolumeProfileCalculator()
    self.pivot_calculator = PivotCalculator()
    self.liquidity_levels_detector = LiquidityLevelsDetector(client=self.client)
    
    logger.info("‚úÖ ExitAnalyzer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
```

### 4.2. analyze_position(...)

```python
async def analyze_position(self, symbol: str) -> Optional[Dict[str, Any]]:
    """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ."""
    analysis_start = time.perf_counter()
    
    # ‚úÖ FIX: –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º lock –¥–ª—è —Å–∏–º–≤–æ–ª–∞
    if symbol not in self._signal_locks_ref:
        self._signal_locks_ref[symbol] = asyncio.Lock()
    
    async with self._signal_locks_ref[symbol]:
        return await self._analyze_position_impl(symbol, analysis_start)
```

### 4.3. _should_force_close_by_smart_analysis (smart_close)

```python
async def _should_force_close_by_smart_analysis(
    self,
    symbol: str,
    position_side: str,
    pnl_pct: float,
    sl_pct: float,
) -> bool:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏:
      - —É–±—ã—Ç–æ–∫ —É–∂–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π (>= 1.5 * SL)
      - –Ω–∏ –æ–¥–∏–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –Ω–∞—à—É –ø–æ–ª—å–∑—É
      - —Ç—Ä–µ–Ω–¥ —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å
    """
    tasks = [
        self._check_reversal_signals_score(symbol, position_side),
        self._check_funding_bias(symbol, position_side),
        self._check_correlation_bias(symbol, position_side),
        self._check_liquidity_sweep(symbol, position_side),
        self._check_reversal_candles(symbol, position_side),
        self._check_volume_profile_support(symbol, position_side),
        self._check_pivot_support(symbol, position_side),
    ]
    
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    reversal_score = 0
    for res in results:
        if isinstance(res, Exception):
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ smart_analysis –∑–∞–¥–∞—á–µ: {res}")
        else:
            reversal_score += res
    
    # –°–∏–ª–∞ —Ç—Ä–µ–Ω–¥–∞ –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å
    trend_data = await self._analyze_trend_strength(symbol)
    trend_against = 0.0
    if trend_data:
        ts = trend_data.get("trend_strength", 0.0)
        direction = trend_data.get("trend_direction", "neutral")
        if (position_side == "long" and direction == "bearish") or (
            position_side == "short" and direction == "bullish"
        ):
            trend_against = ts
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ:
    # 1. –Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ (score ‚â§ 2)
    # 2. —Ç—Ä–µ–Ω–¥ –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è (‚â• 0.7)
    decision = reversal_score <= 2 and trend_against >= 0.7
    return decision
```

### 4.4. _generate_exit_for_ranging (sl_close / tp_close)

```python
async def _generate_exit_for_ranging(
    self,
    symbol: str,
    position: Dict[str, Any],
    metadata: PositionMetadata,
    current_price: float,
    pnl_percent: float,
    minutes_in_position: float,
) -> Optional[Dict[str, Any]]:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è –¥–ª—è ranging —Ä–µ–∂–∏–º–∞."""
    
    # ---------- –£–ú–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –£–ë–´–¢–û–ß–ù–û–ô –ü–û–ó–ò–¶–ò–ò ----------
    if pnl_percent <= -sl_percent * 1.5:
        smart_close = await self._should_force_close_by_smart_analysis(
            symbol, position_side, pnl_percent, sl_percent
        )
        if smart_close:
            return {
                "action": "close",
                "reason": "smart_forced_close_ranging",
                "pnl_pct": pnl_percent,
            }
    # ---------- –ö–û–ù–ï–¶ –£–ú–ù–û–ì–û –ó–ê–ö–†–´–¢–ò–Ø ----------
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ TP
    if pnl_percent >= tp_percent:
        return {
            "action": "close",
            "reason": "tp_reached_ranging",
            "pnl_pct": pnl_percent,
        }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ SL
    if pnl_percent <= -sl_percent:
        return {
            "action": "close",
            "reason": "sl_reached_ranging",
            "pnl_pct": pnl_percent,
        }
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
```

---

## 5. –ö–û–î POSITIONSIZER (RISKMANAGER)

### 5.1. calculate_position_size(...)

```python
async def calculate_position_size(
    self,
    balance: Optional[float] = None,
    price: float = 0.0,
    signal: Optional[Dict[str, Any]] = None,
    signal_generator=None,
) -> float:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º Balance Profiles –∏ —Ä–µ–∂–∏–º–∞ —Ä—ã–Ω–∫–∞."""
    
    # 1. –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å
    if balance is None:
        balance = await self._get_balance_from_registry_or_api()
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ max_daily_loss
    if not await self._check_max_daily_loss(balance):
        return 0.0
    
    # 3. –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
    balance_profile = self.config_manager.get_balance_profile(balance)
    
    # 4. ‚úÖ –ü–†–û–ì–†–ï–°–°–ò–í–ù–´–ô –†–ê–°–ß–ï–¢
    is_progressive = balance_profile.get("progressive", False)
    if is_progressive:
        size_at_min = balance_profile.get("size_at_min", 30.0)
        size_at_max = balance_profile.get("size_at_max", 50.0)
        min_balance = balance_profile.get("min_balance", 100.0)
        max_balance = balance_profile.get("threshold", 500.0)
        
        # –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
        if max_balance > min_balance:
            balance_range = max_balance - min_balance
            size_range = size_at_max - size_at_min
            clamped_balance = max(min_balance, min(balance, max_balance))
            interpolated_size = size_at_min + (
                size_range * (clamped_balance - min_balance) / balance_range
            )
            base_usd_size = interpolated_size
    
    # 5. –ü—Ä–∏–º–µ–Ω—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª–∏
    # - Per-symbol multiplier
    # - Regime multiplier
    # - Signal strength multiplier
    # - Volatility multiplier
    
    # 6. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ max_position_usd
    margin_required = base_usd_size / leverage
    margin_usd = max(min_margin_usd, min(margin_required, max_margin_usd))
    
    # 7. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ–Ω–µ—Ç—ã
    position_size = (margin_usd * leverage) / price
    
    return position_size
```

### 5.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ volatility_multiplier, strength_multiplier, progressive sizing

```python
# Volatility multiplier
if volatility_adjustment_enabled:
    current_atr_percent = (atr / price) * 100
    base_atr_percent = volatility_config.get("base_atr_percent", 2.0)
    volatility_multiplier = base_atr_percent / max(current_atr_percent, 0.01)
    volatility_multiplier = max(0.5, min(1.5, volatility_multiplier))
    base_usd_size *= volatility_multiplier

# Strength multiplier
signal_strength = signal.get("strength", 1.0)
strength_multipliers = adaptive_risk_config.get("strength_multipliers", {})
if signal_strength >= 0.8:
    strength_mult = strength_multipliers.get("strong", 1.3)
elif signal_strength >= 0.5:
    strength_mult = strength_multipliers.get("medium", 1.0)
else:
    strength_mult = strength_multipliers.get("weak", 0.5)
base_usd_size *= strength_mult
```

---

## 6. –ö–û–î TRAILINGSTOPLOSS

### 6.1. update(...)

```python
def update(
    self,
    current_price: float,
    current_time: Optional[float] = None,
    order_flow_delta: Optional[float] = None,
    trend_strength: Optional[float] = None,
    trend_direction: Optional[str] = None,
) -> Tuple[Optional[float], Optional[str], Optional[Dict[str, Any]]]:
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏.
    
    Returns:
        (stop_price, reason, metadata) –∏–ª–∏ (None, None, None) –µ—Å–ª–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å
    """
    if current_time is None:
        current_time = time.time()
    
    # 1. –û–±–Ω–æ–≤–ª—è–µ–º highest_price / lowest_price
    if self.side == "long":
        if current_price > self.highest_price:
            self.highest_price = current_price
    else:  # short
        if current_price < self.lowest_price:
            self.lowest_price = current_price
    
    # 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–π–ª–∏–Ω–≥
    pnl_percent = self._calculate_pnl_percent(current_price)
    
    # 3. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–π–ª–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–±—ã–ª–∏
    if pnl_percent < 0.005:  # < 0.5%
        trail_mult = self.trail_growth_low_multiplier
    elif pnl_percent < 0.015:  # 0.5-1.5%
        trail_mult = self.trail_growth_medium_multiplier
    else:  # > 1.5%
        trail_mult = self.trail_growth_high_multiplier
    
    current_trail = self.initial_trail * trail_mult
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ loss_cut
    if self.loss_cut_percent and pnl_percent <= -self.loss_cut_percent:
        stop_price = self._calculate_stop_price(current_price)
        return stop_price, "loss_cut", {"pnl_percent": pnl_percent}
    
    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ timeout
    if self.timeout_minutes:
        minutes_held = (current_time - self.entry_timestamp) / 60.0
        if minutes_held >= self.timeout_minutes:
            if pnl_percent < 0:
                # –í —É–±—ã—Ç–∫–µ - –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ —Ç–∞–π–º–∞—É—Ç—É
                return None, None, None
            stop_price = self._calculate_stop_price(current_price)
            return stop_price, "timeout", {"minutes_held": minutes_held}
    
    # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ min_holding
    if self.min_holding_minutes:
        minutes_held = (current_time - self.entry_timestamp) / 60.0
        if minutes_held < self.min_holding_minutes:
            return None, None, None
    
    # 7. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º stop_price
    stop_price = self._calculate_stop_price(current_price)
    
    return stop_price, None, None
```

### 6.2. –õ–æ–≥–∏–∫–∞ trailing_distance, activation_threshold

```python
def _calculate_stop_price(self, current_price: float) -> float:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É —Å—Ç–æ–ø-–ª–æ—Å—Å–∞."""
    if self.side == "long":
        # –î–ª—è –ª–æ–Ω–≥–∞: stop = highest_price * (1 - current_trail)
        stop_price = self.highest_price * (1 - self.current_trail)
    else:  # short
        # –î–ª—è —à–æ—Ä—Ç–∞: stop = lowest_price * (1 + current_trail)
        stop_price = self.lowest_price * (1 + self.current_trail)
    
    return stop_price
```

---

## üìå –ò–¢–û–ì–û–í–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç:
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
2. –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π
3. –ê–Ω–∞–ª–∏–∑ –ø–æ–∑–∏—Ü–∏–π (ExitAnalyzer)
4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–π
5. Trailing Stop Loss
6. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π (DRIFT_ADD –æ–±—Ä–∞–±–æ—Ç–∞–Ω)

### ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ):
1. –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ max_position_size (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è)
2. DRIFT_ADD (–ø–æ–∑–∏—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞)

### ‚ùå –ù–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–æ–∂–∏–¥–∞–µ–º–æ):
1. –£–º–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (—É–±—ã—Ç–∫–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–µ < -3.0%)
2. SL/TP –∑–∞–∫—Ä—ã—Ç–∏–µ (—É–±—ã—Ç–∫–∏/–ø—Ä–∏–±—ã–ª—å –Ω–µ –¥–æ—Å—Ç–∏–≥–ª–∏ –ø–æ—Ä–æ–≥–æ–≤)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-12-07
**–í–µ—Ä—Å–∏—è**: 1.0

