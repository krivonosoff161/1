# ‚úÖ –ü–†–û–í–ï–†–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô –ü–û–°–õ–ï –ü–û–°–õ–ï–î–ù–ò–• –ö–û–ú–ú–ò–¢–û–í

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-11-19  
**–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:** 08ee37d (19 –Ω–æ—è–±—Ä—è 00:16:56)  
**–ö–æ–º–º–∏—Ç:** "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: entry_price –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, safety_threshold, TSL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–π, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π Partial TP"

---

## üìä –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ü–û–°–õ–ï–î–ù–ï–ú –ö–û–ú–ú–ò–¢–ï

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `src/strategies/scalping/futures/orchestrator.py` - **751 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
- `src/strategies/scalping/futures/position_manager.py` - **383 —Å—Ç—Ä–æ–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
- `src/strategies/modules/margin_calculator.py` - **108 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
- `src/strategies/scalping/futures/indicators/trailing_stop_loss.py` - **79 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
- `src/strategies/scalping/futures/signal_generator.py` - **324 —Å—Ç—Ä–æ–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π**

---

## ‚úÖ –ß–¢–û –ë–´–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. ‚úÖ Safety Threshold
- **–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û
- **–§–∞–π–ª:** `src/strategies/modules/margin_calculator.py`
- **–î–µ—Ç–∞–ª–∏:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ `safety_threshold` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –ø–æ —Ä–µ–∂–∏–º—É

### 2. ‚úÖ TSL –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
- **–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û
- **–§–∞–π–ª:** `src/strategies/scalping/futures/indicators/trailing_stop_loss.py`
- **–î–µ—Ç–∞–ª–∏:** –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ trailing stop loss

### 3. ‚úÖ Entry Price –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- **–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û
- **–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py`
- **–î–µ—Ç–∞–ª–∏:** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ entry_price –∏–∑ –±–∏—Ä–∂–∏

### 4. ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –†–∞–∑–º–µ—Ä –ü–æ–∑–∏—Ü–∏–π
- **–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û
- **–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py`
- **–î–µ—Ç–∞–ª–∏:** –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–π

### 5. ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π Partial TP
- **–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û
- **–§–∞–π–ª:** `src/strategies/scalping/futures/position_manager.py`
- **–î–µ—Ç–∞–ª–∏:** –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ Take Profit

---

## ‚ùå –ß–¢–û –ù–ï –ò–°–ü–†–ê–í–õ–ï–ù–û (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´)

### 1. ‚ùå –ó–ê–ö–†–´–¢–ò–ï –£–ë–´–¢–û–ß–ù–´–• –ü–û–ó–ò–¶–ò–ô –ü–û –í–†–ï–ú–ï–ù–ò

**–°—Ç–∞—Ç—É—Å:** ‚ùå **–ù–ï –ò–°–ü–†–ê–í–õ–ï–ù–û**

**–§–∞–π–ª:** `src/strategies/scalping/futures/orchestrator.py`  
**–°—Ç—Ä–æ–∫–∏:** 6281-6287

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
# –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ –∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –≤ –ø—Ä–∏–±—ã–ª–∏ > min_profit_to_close - –∑–∞–∫—Ä—ã–≤–∞–µ–º
logger.info(
    f"‚è∞ –ü–æ–∑–∏—Ü–∏—è {symbol} —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è {time_held:.1f} –º–∏–Ω—É—Ç "
    f"(–ª–∏–º–∏—Ç: {actual_max_holding:.1f} –º–∏–Ω—É—Ç), "
    f"–ø—Ä–∏–±—ã–ª—å: {profit_pct:.2%}, –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏"
)
await self._close_position(symbol, "max_holding_time")
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ–¥ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, **–í–ö–õ–Æ–ß–ê–Ø –£–ë–´–¢–û–ß–ù–´–ï** (profit_pct < 0)
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —É–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –£–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ trailing stop –∏–ª–∏ loss cut

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º —É–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
if profit_pct <= 0:
    logger.info(
        f"‚è∞ –ü–æ–∑–∏—Ü–∏—è {symbol} —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è {time_held:.1f} –º–∏–Ω—É—Ç "
        f"(–ª–∏–º–∏—Ç: {actual_max_holding:.1f} –º–∏–Ω—É—Ç), "
        f"–Ω–æ –ø—Ä–∏–±—ã–ª—å {profit_pct:.2%} <= 0%, "
        f"–ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ trailing stop –∏ loss cut)"
    )
    return  # –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —É–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –°–†–û–ß–ù–û

---

### 2. ‚ùå –û–ë–†–ê–ë–û–¢–ö–ê –¢–ê–ô–ú–ê–£–¢–û–í API (WinError 121)

**–°—Ç–∞—Ç—É—Å:** ‚ùå **–ù–ï –ò–°–ü–†–ê–í–õ–ï–ù–û**

**–§–∞–π–ª:** `src/clients/futures_client.py`  
**–ú–µ—Ç–æ–¥:** `_make_request()` (—Å—Ç—Ä–æ–∫–∏ 77-212)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ `[WinError 121] –ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç —Å–µ–º–∞—Ñ–æ—Ä–∞`
- –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏ –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤
- –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OKX ({method} {url}): {e}")
    raise  # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
```

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
```python
except asyncio.TimeoutError:
    logger.warning(f"‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OKX: {method} {url}")
    # Retry –ª–æ–≥–∏–∫–∞
    raise
except OSError as e:
    if "121" in str(e) or "—Å–µ–º–∞—Ñ–æ—Ä" in str(e).lower():
        logger.warning(f"‚è±Ô∏è –¢–∞–π–º–∞—É—Ç —Å–µ–º–∞—Ñ–æ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OKX: {method} {url}")
        # Retry –ª–æ–≥–∏–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        raise
    raise
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚ö° –í–ê–ñ–ù–û

---

### 3. ‚ùå –ü–†–û–ë–õ–ï–ú–´ –° –†–ê–°–ß–ï–¢–û–ú –ú–ê–†–ñ–ò XRP-USDT

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ß–ê–°–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û**

**–§–∞–π–ª:** `src/strategies/modules/margin_calculator.py`  
**–°—Ç—Ä–æ–∫–∏:** 350-378

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ `safety_threshold` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
- –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ `margin_ratio`

**–ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å:**
- –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `margin_ratio` –¥–ª—è XRP-USDT –≤—Å–µ –µ—â–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è
- –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞—Å—á–µ—Ç–æ–º `available_margin` –¥–ª—è –º–∞–ª—ã—Ö –ø–æ–∑–∏—Ü–∏–π
- –ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è edge cases

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚ö° –í–ê–ñ–ù–û

---

## üìã –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 5 –ø—Ä–æ–±–ª–µ–º
1. ‚úÖ Safety Threshold
2. ‚úÖ TSL –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
3. ‚úÖ Entry Price –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
4. ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –†–∞–∑–º–µ—Ä –ü–æ–∑–∏—Ü–∏–π
5. ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π Partial TP

### ‚ùå –ù–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º—ã
1. ‚ùå **–ó–∞–∫—Ä—ã—Ç–∏–µ —É–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏** (üî¥ –ö–†–ò–¢–ò–ß–ù–û)
2. ‚ùå **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ API** (üü° –í–ê–ñ–ù–û)
3. ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞—Å—á–µ—Ç–æ–º –º–∞—Ä–∂–∏ XRP-USDT** (üü° –í–ê–ñ–ù–û, —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –°–†–û–ß–ù–û –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

1. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —É–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏**
   - –§–∞–π–ª: `src/strategies/scalping/futures/orchestrator.py`
   - –°—Ç—Ä–æ–∫–∏: 6281-6287
   - –î–æ–±–∞–≤–∏—Ç—å: `if profit_pct <= 0: return`

2. **–î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤ API**
   - –§–∞–π–ª: `src/clients/futures_client.py`
   - –ú–µ—Ç–æ–¥: `_make_request()`
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `WinError 121` –∏ `asyncio.TimeoutError`

### –í–ê–ñ–ù–û –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

3. **–£–ª—É—á—à–∏—Ç—å —Ä–∞—Å—á–µ—Ç –º–∞—Ä–∂–∏ –¥–ª—è –º–∞–ª—ã—Ö –ø–æ–∑–∏—Ü–∏–π**
   - –§–∞–π–ª: `src/strategies/modules/margin_calculator.py`
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è edge cases

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

**–í—Å–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–º–º–∏—Ç–µ 08ee37d:**
- 152 —Ñ–∞–π–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–æ
- 7,566 —Å—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- 390 —Å—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `orchestrator.py`: +751 —Å—Ç—Ä–æ–∫
- `position_manager.py`: +383 —Å—Ç—Ä–æ–∫–∏
- `signal_generator.py`: +324 —Å—Ç—Ä–æ–∫–∏
- `margin_calculator.py`: +108 —Å—Ç—Ä–æ–∫
- `trailing_stop_loss.py`: +79 —Å—Ç—Ä–æ–∫

---

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-11-19  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - –æ—Å—Ç–∞–ª–∏—Å—å 2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º—ã

