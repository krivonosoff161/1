# –ü–û–õ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –†–ê–°–ß–ï–¢–û–í –ò –ü–û–î–°–ß–ï–¢–ê –ü–û–ó–ò–¶–ò–ô

**–î–∞—Ç–∞:** 23 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–û–í–ï–†–ï–ù–û

---

## üìä –ü–†–û–í–ï–†–ö–ê –†–ê–°–ß–ï–¢–û–í PnL

### 1. PositionManager (`_check_tp_only`) ‚úÖ

```python
# –°—Ç—Ä–æ–∫–∞ 1048
pnl_percent = (unrealized_pnl / margin_used) * 100
# PnL% = (–ü—Ä–∏–±—ã–ª—å –≤ USD / –ú–∞—Ä–∂–∞ –≤ USD) √ó 100
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –ü—Ä–æ—Ü–µ–Ω—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è **–æ—Ç –º–∞—Ä–∂–∏**

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å TP:**
- TP –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞: **% –æ—Ç –º–∞—Ä–∂–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5.0%)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: `pnl_percent >= tp_percent` ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**

---

### 2. TrailingStopLoss (`get_profit_pct`) ‚úÖ

```python
# –°—Ç—Ä–æ–∫–∞ 389-392
if self.side == "long":
    gross_profit_pct = (current_price - self.entry_price) / self.entry_price
else:
    gross_profit_pct = (self.entry_price - current_price) / self.entry_price
# –í—ã—á–∏—Ç–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é
net_profit_pct = gross_profit_pct - self.trading_fee_rate
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –ü—Ä–æ—Ü–µ–Ω—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è **–æ—Ç —Ü–µ–Ω—ã**

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å loss_cut:**
- Loss_cut –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞: **% –æ—Ç –º–∞—Ä–∂–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.5%)
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: `loss_cut_from_price = loss_cut_percent / leverage` ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: `profit_pct <= -loss_cut_from_price` ‚úÖ **–ö–û–†–†–ï–ö–¢–ù–û**

**–ü—Ä–∏–º–µ—Ä:**
- Loss_cut = 1.5% –æ—Ç –º–∞—Ä–∂–∏
- Leverage = 5x
- Loss_cut_from_price = 1.5% / 5 = 0.3% –æ—Ç —Ü–µ–Ω—ã ‚úÖ

---

### 3. TrailingSLCoordinator (`update_trailing_stop_loss`) ‚úÖ

```python
# –°—Ç—Ä–æ–∫–∞ 493
profit_pct = tsl.get_profit_pct(current_price, include_fees=True)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç TrailingStopLoss.get_profit_pct - –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¶–ï–ù–´
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Ü–µ–Ω—ã, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ TrailingStopLoss

---

## ‚úÖ –í–´–í–û–î: –†–ê–°–ß–ï–¢–´ –ö–û–†–†–ï–ö–¢–ù–´

### –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ:

1. **PositionManager:**
   - PnL% —Å—á–∏—Ç–∞–µ—Ç—Å—è **–æ—Ç –º–∞—Ä–∂–∏** ‚úÖ
   - TP —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å PnL% **–æ—Ç –º–∞—Ä–∂–∏** ‚úÖ

2. **TrailingStopLoss:**
   - PnL% —Å—á–∏—Ç–∞–µ—Ç—Å—è **–æ—Ç —Ü–µ–Ω—ã** ‚úÖ
   - Loss_cut –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ **% –æ—Ç –º–∞—Ä–∂–∏** –≤ **% –æ—Ç —Ü–µ–Ω—ã** ‚úÖ
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ

3. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:**
   - Loss_cut: `loss_cut_from_price = loss_cut_percent / leverage` ‚úÖ
   - Timeout_loss: `timeout_loss_from_price = timeout_loss_percent / leverage` ‚úÖ

---

## üìä –ü–†–û–í–ï–†–ö–ê –†–ê–°–ß–ï–¢–ê –†–ê–ó–ú–ï–†–ê –ü–û–ó–ò–¶–ò–ô

### RiskManager (`calculate_position_size`) ‚úÖ

#### –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä:
```python
# –°—Ç—Ä–æ–∫–∞ 170
base_usd_size = balance_profile.get("base_position_usd", 30.0)
# –ü—Ä–∏–º–µ–Ω—è–µ–º multiplier –¥–ª—è —Å–∏–º–≤–æ–ª–∞
symbol_multiplier = symbol_profile.get("position_multiplier", 1.0)
base_usd_size *= symbol_multiplier
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ multiplier

#### –ú–∞—Ä–∂–∞:
```python
# –°—Ç—Ä–æ–∫–∞ 527-529
margin_required = base_usd_size / leverage
# –ú–∞—Ä–∂–∞ = –ù–æ–º–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å / Leverage
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –†–∞—Å—á–µ—Ç –º–∞—Ä–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω

#### –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ —Ä–µ–∂–∏–º—É:
```python
# –°—Ç—Ä–æ–∫–∞ 364-366
multiplier = regime_params.get("position_size_multiplier")
if multiplier:
    base_usd_size *= multiplier
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ —Ä–µ–∂–∏–º—É

#### –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏:
```python
# –°—Ç—Ä–æ–∫–∞ 500-515
volatility_multiplier = 1.0 + (current_atr_percent - base_atr_percent) * volatility_sensitivity
base_usd_size *= volatility_multiplier
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏

---

## üìä –ü–†–û–í–ï–†–ö–ê –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–û–í

### TP –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚úÖ

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏:
1. **Per-regime TP** (–µ—Å–ª–∏ —Ä–µ–∂–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω) ‚úÖ
2. **Per-symbol TP** (fallback) ‚úÖ
3. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π TP** (fallback) ‚úÖ

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, —Ä–µ–∂–∏–º —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–æ–∑–∏—Ü–∏—é

### TSL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚úÖ

#### Loss_cut:
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: `loss_cut_from_price = loss_cut_percent / leverage` ‚úÖ
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: `profit_pct <= -loss_cut_from_price` ‚úÖ

#### Timeout_loss:
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: `timeout_loss_from_price = timeout_loss_percent / leverage` ‚úÖ
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: `profit_pct <= -timeout_loss_from_price` ‚úÖ

---

## üîç –ü–†–û–í–ï–†–ö–ê –î–õ–Ø –†–ê–ó–ù–´–• –ü–ê–† –ò –†–ï–ñ–ò–ú–û–í

### BTC-USDT ‚úÖ
- **Ranging:** TP=5.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 1.0% –æ—Ç —Ü–µ–Ω—ã –ø—Ä–∏ leverage 5x)
- **Trending:** TP=5.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 1.0% –æ—Ç —Ü–µ–Ω—ã)
- **Choppy:** TP=4.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.8% –æ—Ç —Ü–µ–Ω—ã)
- **Loss_cut:** 1.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.3% –æ—Ç —Ü–µ–Ω—ã)

### ETH-USDT ‚úÖ
- **Ranging:** TP=3.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.7% –æ—Ç —Ü–µ–Ω—ã)
- **Trending:** TP=5.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 1.0% –æ—Ç —Ü–µ–Ω—ã)
- **Choppy:** TP=4.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.8% –æ—Ç —Ü–µ–Ω—ã)
- **Loss_cut:** 1.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.3% –æ—Ç —Ü–µ–Ω—ã)

### SOL-USDT ‚úÖ
- **Ranging:** TP=3.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.7% –æ—Ç —Ü–µ–Ω—ã)
- **Trending:** TP=5.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 1.0% –æ—Ç —Ü–µ–Ω—ã)
- **Choppy:** TP=4.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.8% –æ—Ç —Ü–µ–Ω—ã)
- **Loss_cut:** 1.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.3% –æ—Ç —Ü–µ–Ω—ã)

### DOGE-USDT ‚úÖ
- **Ranging:** TP=4.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.8% –æ—Ç —Ü–µ–Ω—ã)
- **Trending:** TP=4.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.9% –æ—Ç —Ü–µ–Ω—ã)
- **Choppy:** TP=4.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.8% –æ—Ç —Ü–µ–Ω—ã)
- **Loss_cut:** 1.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.3% –æ—Ç —Ü–µ–Ω—ã)

### XRP-USDT ‚úÖ
- **Ranging:** TP=4.0% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.8% –æ—Ç —Ü–µ–Ω—ã)
- **Trending:** TP=4.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.9% –æ—Ç —Ü–µ–Ω—ã)
- **Loss_cut:** 1.5% –æ—Ç –º–∞—Ä–∂–∏ (‚âà 0.3% –æ—Ç —Ü–µ–Ω—ã)

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:** –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä –∏ —Ä–µ–∂–∏–º–æ–≤

---

## ‚úÖ –ò–¢–û–ì–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê

### –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ:

1. ‚úÖ **PnL% –æ—Ç –º–∞—Ä–∂–∏** –≤ PositionManager
2. ‚úÖ **PnL% –æ—Ç —Ü–µ–Ω—ã** –≤ TrailingStopLoss
3. ‚úÖ **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è loss_cut** –∏–∑ % –æ—Ç –º–∞—Ä–∂–∏ –≤ % –æ—Ç —Ü–µ–Ω—ã
4. ‚úÖ **–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–π** —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
5. ‚úÖ **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è** –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä –∏ —Ä–µ–∂–∏–º–æ–≤

### –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö:

- ‚úÖ –ù–µ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –º–µ–∂–¥—É —Ä–∞—Å—á–µ—Ç–∞–º–∏
- ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üéØ –í–´–í–û–î–´

### –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –∏ –ø–æ–¥—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ:

1. ‚úÖ **PnL —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** (–æ—Ç –º–∞—Ä–∂–∏ –≤ PositionManager, –æ—Ç —Ü–µ–Ω—ã –≤ TrailingStopLoss)
2. ‚úÖ **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** (loss_cut –∏ timeout_loss –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∏–∑ % –æ—Ç –º–∞—Ä–∂–∏ –≤ % –æ—Ç —Ü–µ–Ω—ã)
3. ‚úÖ **–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** (—Å —É—á–µ—Ç–æ–º multiplier, —Ä–µ–∂–∏–º–∞, –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏)
4. ‚úÖ **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä –∏ —Ä–µ–∂–∏–º–æ–≤)

### –ù–µ—Ç –æ—à–∏–±–æ–∫:

- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ä
- ‚úÖ –ù–µ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –†–ê–°–ß–ï–¢–´ –ü–†–ê–í–ò–õ–¨–ù–´–ï - –ì–û–¢–û–í–û –ö –ó–ê–ü–£–°–ö–£

